</body>
<script>
// Auto-ajustement de la hauteur des textarea à l'ouverture de la page
window.addEventListener('DOMContentLoaded', function() {
    // INFORMATION HEBDOMADAIRE
    var weekNotes = document.getElementById('sheet-week-notes');
    if (weekNotes) {
        weekNotes.style.height = 'auto';
        weekNotes.style.height = (weekNotes.scrollHeight) + 'px';
    }
    // Rubriques personnalisées
    var rubriques = document.querySelectorAll('.rubric-content');
    rubriques.forEach(function(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    });

    // Affichage du nombre total de RDV annuels dans le sidebar élèves
    if (typeof getAnnualRDVCountByStudent === 'function') {
        setTimeout(function() {
            try {
                var rdvCounts = getAnnualRDVCountByStudent();
                var totalRdv = 0;
                if (rdvCounts && typeof rdvCounts === 'object') {
                    for (var k in rdvCounts) {
                        if (Object.prototype.hasOwnProperty.call(rdvCounts, k)) {
                            totalRdv += rdvCounts[k];
                        }
                    }
                }
                var rdvDisplay = document.getElementById('rdvCountDisplay');
                if (rdvDisplay) {
                    rdvDisplay.textContent = 'nbr rdv: ' + totalRdv;
                }
            } catch (e) {}
        }, 500);
    }
});
</script>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>logiciel 34 - VERSION DÉMO (30 min)</title>
    <!-- Bibliothèque SheetJS pour import Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- VERSION DÉMO - Timer 30 minutes -->
    <script>
        // Configuration VERSION DÉMO
        const DEMO_MODE = true;
        const DEMO_TIME_LIMIT = 1800; // 1800 secondes = 30 minutes
        let demoStartTime = Date.now();
        let demoTimerInterval = null;
        let demoTimeRemaining = DEMO_TIME_LIMIT;
        
        // Démarrer le timer de démo au chargement
        window.addEventListener('DOMContentLoaded', function() {
            if (DEMO_MODE) {
                startDemoTimer();
                disableDemoRestrictedButtons();
                showDemoWarning();
            }
        });
        
        function startDemoTimer() {
            // Afficher le compteur
            createDemoTimerDisplay();
            
            // Mettre à jour chaque seconde
            demoTimerInterval = setInterval(function() {
                const elapsed = Math.floor((Date.now() - demoStartTime) / 1000);
                demoTimeRemaining = DEMO_TIME_LIMIT - elapsed;
                
                if (demoTimeRemaining <= 0) {
                    // Temps écoulé - bloquer le logiciel
                    endDemoSession();
                } else {
                    // Mettre à jour l'affichage
                    updateDemoTimerDisplay();
                    
                    // Alerte à 5 minutes
                    if (demoTimeRemaining === 300) {
                        alert('⏰ VERSION DÉMO\n\nIl vous reste 5 minutes d\'utilisation.\n\nContactez-nous pour obtenir la version complète sans limitation.');
                    }
                }
            }, 1000);
        }
        
        function createDemoTimerDisplay() {
            const timerDiv = document.createElement('div');
            timerDiv.id = 'demoTimerDisplay';
            timerDiv.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: linear-gradient(135deg, #FF6B6B, #FF8E53);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: bold;
                font-size: 14px;
                z-index: 100000;
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
                border: 2px solid rgba(255, 255, 255, 0.3);
                font-family: 'Segoe UI', Arial, sans-serif;
            `;
            timerDiv.innerHTML = '⏰ DÉMO: 30:00';
            document.body.appendChild(timerDiv);
        }
        
        function updateDemoTimerDisplay() {
            const timerDiv = document.getElementById('demoTimerDisplay');
            if (timerDiv) {
                const minutes = Math.floor(demoTimeRemaining / 60);
                const seconds = demoTimeRemaining % 60;
                const timeStr = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                timerDiv.innerHTML = '⏰ DÉMO: ' + timeStr;
                
                // Changer la couleur quand il reste moins de 5 minutes
                if (demoTimeRemaining <= 300) {
                    timerDiv.style.background = 'linear-gradient(135deg, #FF0000, #FF4444)';
                    timerDiv.style.animation = 'pulse 1s infinite';
                }
            }
        }
        
        function showDemoWarning() {
            // Afficher un bandeau d'avertissement
            const warningDiv = document.createElement('div');
            warningDiv.id = 'demoWarning';
            warningDiv.style.cssText = `
                position: fixed;
                top: 50px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255, 152, 0, 0.95);
                color: black;
                padding: 15px 30px;
                border-radius: 8px;
                font-weight: bold;
                font-size: 14px;
                z-index: 99999;
                box-shadow: 0 4px 15px rgba(255, 152, 0, 0.5);
                text-align: center;
                max-width: 600px;
            `;
            warningDiv.innerHTML = `
                🎯 <strong>VERSION DÉMO</strong> - Durée limitée à 30 minutes<br>
                <small>Certaines fonctionnalités de sauvegarde sont désactivées</small>
            `;
            document.body.appendChild(warningDiv);
            
            // Masquer le bandeau après 10 secondes
            setTimeout(function() {
                warningDiv.style.opacity = '0';
                warningDiv.style.transition = 'opacity 1s';
                setTimeout(function() {
                    if (warningDiv.parentNode) {
                        warningDiv.parentNode.removeChild(warningDiv);
                    }
                }, 1000);
            }, 10000);
        }
        
        function endDemoSession() {
            // Arrêter le timer
            if (demoTimerInterval) {
                clearInterval(demoTimerInterval);
            }
            
            // Bloquer toute l'interface
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 999999;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            `;
            
            overlay.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 50px;
                    border-radius: 20px;
                    text-align: center;
                    max-width: 600px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                    color: white;
                ">
                    <div style="font-size: 80px; margin-bottom: 20px;">⏰</div>
                    <h1 style="font-size: 36px; margin: 20px 0; color: white;">Session de démonstration terminée</h1>
                    <p style="font-size: 18px; margin: 20px 0; line-height: 1.6; color: #f0f0f0;">
                        Vous avez utilisé la version de démonstration pendant 30 minutes.<br>
                        Pour continuer à utiliser LOGECPE sans limitation de temps<br>
                        et avec toutes les fonctionnalités, contactez-nous.
                    </p>
                    <div style="margin-top: 30px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                        <p style="font-size: 16px; margin: 10px 0; color: #ffffff;">📧 Email: contact@logecpe.fr</p>
                        <p style="font-size: 16px; margin: 10px 0; color: #ffffff;">🌐 Web: www.logecpe.fr</p>
                    </div>
                    <button onclick="window.location.reload()" style="
                        margin-top: 30px;
                        padding: 15px 40px;
                        font-size: 18px;
                        background: white;
                        color: #667eea;
                        border: none;
                        border-radius: 50px;
                        cursor: pointer;
                        font-weight: bold;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        🔄 Redémarrer la démo (30 min)
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Désactiver tous les événements
            document.body.style.pointerEvents = 'none';
            overlay.style.pointerEvents = 'all';
        }
        
        function disableDemoRestrictedButtons() {
            // Fonction appelée après le chargement du DOM pour désactiver les boutons
            setTimeout(function() {
                // Liste des boutons à désactiver
                const restrictedButtons = [
                    { text: 'Sauvegarder le LOGICIEL (HTML)', func: 'saveSoftwareState' },
                    { text: 'Sauvegarde Clé USB/Cloud', func: 'saveStandaloneHTML' },
                    { text: 'Charger', func: 'openLoadModal' },
                    { text: 'Utilitaires', func: 'toggleUtilityTools' },
                    { text: 'Paramètres', func: 'openSettingsModal' },
                    { text: 'Importer CSV/XLSX', func: 'importFromCSVFile' },
                    { text: 'RPP', func: 'importFromClipboardRPP' }
                    // Fermer RDV - désactivé uniquement par fonction, pas par texte
                ];
                
                // Désactiver les boutons par leur onclick
                const allButtons = document.querySelectorAll('button');
                allButtons.forEach(function(btn) {
                    const onclick = btn.getAttribute('onclick');
                    const text = btn.textContent.trim();
                    
                    // Ne pas désactiver le bouton "Charger dans LOGECPE" (importExportAndLoadToLOGECPE)
                    if (onclick && onclick.includes('importExportAndLoadToLOGECPE')) {
                        return; // Ignorer ce bouton
                    }
                    
                    // Ne pas désactiver le bouton Fermer du module import
                    if (onclick && onclick.includes("import-module")) {
                        return; // Ignorer ce bouton
                    }
                    
                    // Désactiver closeRdvView uniquement par fonction (pas par texte "Fermer")
                    if (onclick && onclick.includes('closeRdvView')) {
                        disableButton(btn, 'Fermer la vue RDV');
                        return;
                    }
                    
                    restrictedButtons.forEach(function(restricted) {
                        if (onclick && onclick.includes(restricted.func)) {
                            disableButton(btn, restricted.text);
                        } else if (text.includes(restricted.text) && restricted.text !== 'Fermer') {
                            disableButton(btn, restricted.text);
                        }
                    });
                });
            }, 500);
        }
        
        function disableButton(btn, name) {
            btn.disabled = true;
            btn.style.opacity = '0.4';
            btn.style.cursor = 'not-allowed';
            btn.style.filter = 'grayscale(100%)';
            // NE PAS mettre pointer-events: none pour permettre le survol et l'assistance
            // btn.style.pointerEvents = 'none'; // SUPPRIMÉ
            
            // Ajouter un titre pour expliquer
            btn.title = '🔒 Fonction désactivée en version DÉMO - Survolez pour plus d\'infos';
            
            // Ajouter une classe pour identifier les boutons désactivés
            btn.classList.add('demo-disabled-btn');
            
            // Remplacer l'événement onclick pour bloquer le clic mais pas le survol
            btn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                alert('🔒 VERSION DÉMO\n\nCette fonction est désactivée dans la version de démonstration.\n\n"' + name + '" nécessite la version complète.\n\nContactez-nous pour plus d\'informations.');
                return false;
            };
        }
    </script>
    
    <!-- SYSTÈME DE TUTORIEL DE BIENVENUE -->
    <script>
        // Variable pour stocker l'état du tutoriel
        let tutorialStep = 0;
        const tutorialSteps = [
            {
                title: "🎉 Bienvenue dans LOGECPE !",
                icon: "🎯",
                content: `
                    <p style="font-size:1.1rem; line-height:1.8; margin-bottom:20px;">
                        <strong>LOGECPE</strong> est votre assistant complet pour la gestion de vos élèves et le suivi éducatif.
                    </p>
                    <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin:15px 0;">
                        <p style="margin:0; color:#FFD700;">✨ Cette version de démonstration vous permet de tester <strong>toutes les fonctionnalités</strong> pendant 30 minutes.</p>
                    </div>
                    <p>Ce tutoriel va vous guider pas à pas pour découvrir les principales fonctions.</p>
                `,
                highlight: null
            },
            {
                title: "📥 Importer vos élèves",
                icon: "1️⃣",
                content: `
                    <p style="font-size:1.05rem; line-height:1.7;">La première étape est d'<strong>importer votre base élèves</strong>.</p>
                    <div style="background:rgba(0,100,0,0.2); padding:15px; border-radius:10px; margin:15px 0; border-left:4px solid #4CAF50;">
                        <p style="margin:0;"><strong>➡️ Cliquez sur le bouton vert "Import Établissement"</strong></p>
                    </div>
                    <p>Dans ce module, vous pouvez :</p>
                    <ul style="line-height:2; padding-left:20px;">
                        <li>📂 <strong>Importer un fichier CSV/Excel</strong> depuis PRONOTE, SIECLE, etc.</li>
                        <li>📋 <strong>RPP (Presse-Papier)</strong> ⚡ <span style="color:#4CAF50; font-weight:bold;">MODE LE PLUS RAPIDE !</span> Copiez depuis Excel/PRONOTE et collez directement</li>
                        <li>➕ <strong>Ajouter manuellement</strong> un élève</li>
                        <li>🎲 <strong>Générer des données test</strong> (1500 élèves) pour essayer</li>
                    </ul>
                    <div style="background:rgba(255,100,0,0.15); padding:12px; border-radius:8px; margin-top:15px; border:1px dashed #FF9800;">
                        <p style="margin:0;"><strong>⚠️ IMPORTANT :</strong> Après import, cliquez sur <strong style="color:#4CAF50;">"💾 Charger dans LOGECPE"</strong> pour transférer les élèves vers le logiciel principal !</p>
                    </div>
                `,
                highlight: "Import Etablissement"
            },
            {
                title: "📚 Naviguer dans les classes",
                icon: "2️⃣",
                content: `
                    <p style="font-size:1.05rem; line-height:1.7;">Une fois vos élèves chargés, utilisez la <strong>barre latérale gauche</strong> pour naviguer.</p>
                    
                    <div style="background:rgba(255,0,0,0.1); padding:20px; border-radius:12px; margin:20px 0; border:2px solid #f44336;">
                        <p style="margin:0 0 15px 0; font-size:1.1rem; color:#f44336; font-weight:bold;">🎯 PROCÉDURE OBLIGATOIRE EN 3 ÉTAPES :</p>
                        
                        <div style="display:flex; align-items:center; gap:15px; margin-bottom:12px; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                            <span style="background:#f44336; color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">1</span>
                            <div>
                                <strong style="color:#fff;">Cliquez sur une CLASSE</strong> dans la liste (ex: "2GT1", "1ES2"...)
                                <br><small style="color:#aaa;">→ La classe se met en surbrillance</small>
                            </div>
                        </div>
                        
                        <div style="display:flex; align-items:center; gap:15px; margin-bottom:12px; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                            <span style="background:#FF9800; color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">2</span>
                            <div>
                                <strong style="color:#fff;">Cliquez sur l'onglet "ÉLÈVES"</strong> dans la barre d'onglets
                                <br><small style="color:#aaa;">→ La liste des élèves de cette classe apparaît</small>
                            </div>
                        </div>
                        
                        <div style="display:flex; align-items:center; gap:15px; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                            <span style="background:#4CAF50; color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">3</span>
                            <div>
                                <strong style="color:#fff;">DOUBLE-CLIQUEZ sur un élève</strong> pour ouvrir sa fiche
                                <br><small style="color:#aaa;">→ Ou glissez-le vers une table du logiciel</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(33,150,243,0.15); padding:12px; border-radius:8px; margin-top:15px;">
                        <p style="margin:0;">💡 <strong>Astuce :</strong> Sans avoir sélectionné une classe, aucun élève ne s'affiche ! Pensez toujours à cliquer d'abord sur la classe.</p>
                    </div>
                `,
                highlight: "sidebar"
            },
            {
                title: "👤 La fiche élève",
                icon: "3️⃣",
                content: `
                    <p style="font-size:1.05rem; line-height:1.7;">La <strong>fiche élève</strong> est le cœur de LOGECPE. Elle contient :</p>
                    <ul style="line-height:2; padding-left:20px;">
                        <li>📝 <strong>Notes hebdomadaires</strong> : observations, comportement, incidents</li>
                        <li>🎚️ <strong>Statut visuel</strong> : curseur de rouge (difficultés) à vert (excellent)</li>
                        <li>📅 <strong>Historique des RDV</strong> : tous les entretiens, convocations, rencontres</li>
                        <li>🏥 <strong>Projets & Allergies</strong> : PAP, PAI, PPRE, PPS, AESH</li>
                        <li>🎯 <strong>Engagements</strong> : délégué, éco-délégué, CVL, MDL, AS</li>
                        <li>📑 <strong>Rubriques personnalisées</strong> : créez vos propres sections sur mesure</li>
                    </ul>
                    <div style="background:rgba(255,200,0,0.15); padding:12px; border-radius:8px; margin-top:15px;">
                        <p style="margin:0;">💾 <em>Sauvegarde automatique toutes les 2 secondes ! Aucune perte de données.</em></p>
                    </div>
                    <div style="background:rgba(100,0,200,0.15); padding:12px; border-radius:8px; margin-top:10px;">
                        <p style="margin:0;">📆 <em>Utilisez le calendrier des semaines en bas pour voir l'historique de l'élève sur toute l'année.</em></p>
                    </div>
                `,
                highlight: "fiche"
            },
            {
                title: "📅 L'Agenda des RDV",
                icon: "4️⃣",
                content: `
                    <p style="font-size:1.05rem; line-height:1.7;">Gérez tous vos <strong>rendez-vous élèves</strong> avec l'agenda intégré.</p>
                    <div style="background:rgba(255,152,0,0.2); padding:15px; border-radius:10px; margin:15px 0; border-left:4px solid #FF9800;">
                        <p style="margin:0;"><strong>➡️ Cliquez sur "Agenda des saisies" (bouton orange)</strong></p>
                    </div>
                    <p>Fonctionnalités de l'agenda :</p>
                    <ul style="line-height:2; padding-left:20px;">
                        <li>📆 <strong>3 vues disponibles :</strong> Jour / Semaine / Mois</li>
                        <li>🖱️ <strong>Cliquez sur un créneau</strong> pour créer un RDV rapidement</li>
                        <li>👥 <strong>RDV individuels ou groupés</strong></li>
                        <li>🔗 <strong>Lien automatique</strong> avec la fiche élève</li>
                    </ul>
                `,
                highlight: "Agenda"
            },
            {
                title: "📊 Statistiques & Synthèse",
                icon: "5️⃣",
                content: `
                    <p style="font-size:1.05rem; line-height:1.7;">Analysez votre suivi avec les <strong>outils statistiques</strong>.</p>
                    <ul style="line-height:2; padding-left:20px;">
                        <li>📈 <strong>Statistiques</strong> : graphiques, répartitions, tendances</li>
                        <li>📑 <strong>Synthèse Annuelle</strong> : bilan par élève ou par classe</li>
                        <li>🖨️ <strong>Impression</strong> : rapports formatés pour conseils de classe</li>
                    </ul>
                    <div style="background:rgba(100,0,100,0.2); padding:15px; border-radius:10px; margin:15px 0; border-left:4px solid #9C27B0;">
                        <p style="margin:0;"><strong>💡 Astuce :</strong> Utilisez les filtres par période pour cibler vos analyses.</p>
                    </div>
                `,
                highlight: "stats"
            },
            {
                title: "❓ Fiches d'assistance",
                icon: "6️⃣",
                content: `
                    <p style="font-size:1.05rem; line-height:1.7;">Passez la souris sur <strong>n'importe quel bouton</strong> pour voir son aide détaillée.</p>
                    <div style="background:rgba(102,126,234,0.2); padding:15px; border-radius:10px; margin:15px 0; border-left:4px solid #667eea;">
                        <p style="margin:0;"><strong>🎯 Chaque élément a sa fiche d'assistance :</strong></p>
                        <ul style="margin:10px 0 0 20px; line-height:1.8;">
                            <li>Description complète de la fonction</li>
                            <li>Étapes d'utilisation</li>
                            <li>Astuces et conseils</li>
                            <li>Indication si désactivé en démo</li>
                        </ul>
                    </div>
                    <p>🔒 Les boutons grisés sont désactivés en version démo, mais vous pouvez voir leur description.</p>
                `,
                highlight: null
            },
            {
                title: "🎓 Vous êtes prêt !",
                icon: "✅",
                content: `
                    <p style="font-size:1.1rem; line-height:1.8; margin-bottom:20px;">
                        Vous connaissez maintenant les <strong>bases de LOGECPE</strong> !
                    </p>
                    <div style="background:rgba(0,200,100,0.2); padding:20px; border-radius:10px; margin:15px 0; text-align:center;">
                        <p style="margin:0 0 10px 0; font-size:1.2rem;">🚀 <strong>Commencez par :</strong></p>
                        <p style="margin:0; font-size:1.1rem; color:#4CAF50;">Cliquer sur <strong>"Import Établissement"</strong> puis <strong>"🎲 Exemple de données"</strong></p>
                    </div>
                    <p style="margin-top:20px;">💡 <strong>Rappel :</strong> Cliquez sur le bouton <strong style="color:#FFD700;">📖 Tutoriel</strong> en bas à droite à tout moment pour revoir ce guide.</p>
                    <div style="margin-top:20px; padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; text-align:center;">
                        <p style="margin:0; color:#aaa;">Version démo limitée à 30 minutes</p>
                        <p style="margin:5px 0 0 0; color:#fff;">📧 contact@logecpe.fr | 🌐 www.logecpe.fr</p>
                    </div>
                `,
                highlight: null
            }
        ];
        
        // Fonction pour afficher le tutoriel
        function showTutorial(step = 0) {
            tutorialStep = step;
            const currentStep = tutorialSteps[step];
            
            // Supprimer l'ancien overlay s'il existe
            const existingOverlay = document.getElementById('tutorialOverlay');
            if (existingOverlay) existingOverlay.remove();
            
            // Créer l'overlay du tutoriel
            const overlay = document.createElement('div');
            overlay.id = 'tutorialOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 200000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeInTutorial 0.3s ease;
            `;
            
            overlay.innerHTML = `
                <style>
                    @keyframes fadeInTutorial {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUpTutorial {
                        from { transform: translateY(30px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .tutorial-card {
                        animation: slideUpTutorial 0.4s ease;
                    }
                    .tutorial-btn {
                        padding: 12px 30px;
                        border: none;
                        border-radius: 25px;
                        cursor: pointer;
                        font-weight: bold;
                        font-size: 1rem;
                        transition: all 0.2s;
                    }
                    .tutorial-btn:hover {
                        transform: scale(1.05);
                    }
                    .tutorial-btn-primary {
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    }
                    .tutorial-btn-secondary {
                        background: #333;
                        color: #aaa;
                    }
                    .tutorial-btn-skip {
                        background: transparent;
                        color: #666;
                        border: 1px solid #444;
                    }
                    .tutorial-progress {
                        display: flex;
                        gap: 8px;
                        justify-content: center;
                        margin-top: 25px;
                    }
                    .tutorial-dot {
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        background: #444;
                        transition: all 0.3s;
                    }
                    .tutorial-dot.active {
                        background: #667eea;
                        box-shadow: 0 0 10px #667eea;
                        transform: scale(1.2);
                    }
                    .tutorial-dot.completed {
                        background: #4CAF50;
                    }
                </style>
                <div class="tutorial-card" style="
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                    border: 2px solid #667eea;
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 700px;
                    width: 90%;
                    max-height: 85vh;
                    overflow-y: auto;
                    color: white;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(102, 126, 234, 0.2);
                ">
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px; border-bottom:2px solid rgba(255,255,255,0.1); padding-bottom:20px;">
                        <div style="font-size:3rem;">${currentStep.icon}</div>
                        <div>
                            <div style="font-size:0.9rem; color:#667eea; text-transform:uppercase; letter-spacing:2px;">Étape ${step + 1} sur ${tutorialSteps.length}</div>
                            <h2 style="margin:5px 0 0 0; font-size:1.6rem; color:white;">${currentStep.title}</h2>
                        </div>
                    </div>
                    
                    <div style="color:#ddd; font-size:1rem;">
                        ${currentStep.content}
                    </div>
                    
                    <div class="tutorial-progress">
                        ${tutorialSteps.map((_, i) => `
                            <div class="tutorial-dot ${i === step ? 'active' : ''} ${i < step ? 'completed' : ''}"></div>
                        `).join('')}
                    </div>
                    
                    <div style="display:flex; gap:15px; justify-content:center; margin-top:30px; flex-wrap:wrap;">
                        ${step > 0 ? `
                            <button class="tutorial-btn tutorial-btn-secondary" onclick="showTutorial(${step - 1})">
                                ◀ Précédent
                            </button>
                        ` : ''}
                        
                        ${step < tutorialSteps.length - 1 ? `
                            <button class="tutorial-btn tutorial-btn-primary" onclick="showTutorial(${step + 1})">
                                Suivant ▶
                            </button>
                        ` : `
                            <button class="tutorial-btn tutorial-btn-primary" onclick="closeTutorial()" style="background: linear-gradient(135deg, #4CAF50, #45a049);">
                                🚀 Commencer !
                            </button>
                        `}
                        
                        <button class="tutorial-btn tutorial-btn-skip" onclick="closeTutorial()">
                            Passer le tutoriel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        // Fermer le tutoriel
        function closeTutorial() {
            const overlay = document.getElementById('tutorialOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s';
                setTimeout(() => overlay.remove(), 300);
            }
            // Marquer comme vu dans localStorage
            localStorage.setItem('logecpe_tutorial_seen', 'true');
        }
        
        // Variable globale pour l'état de l'assistance
        let assistanceEnabled = true;
        
        // Fonction pour activer/désactiver l'assistance
        function toggleAssistance() {
            assistanceEnabled = !assistanceEnabled;
            const btn = document.getElementById('assistanceFloatingBtn');
            const assistant = document.getElementById('demoAssistant');
            
            if (assistanceEnabled) {
                btn.innerHTML = '💡 Aide ON';
                btn.style.background = 'linear-gradient(135deg, #4CAF50, #2E7D32)';
                btn.style.boxShadow = '0 3px 12px rgba(76, 175, 80, 0.4)';
            } else {
                btn.innerHTML = '💡 Aide OFF';
                btn.style.background = 'linear-gradient(135deg, #9E9E9E, #616161)';
                btn.style.boxShadow = '0 3px 12px rgba(158, 158, 158, 0.4)';
                // Masquer l'assistant si affiché
                if (assistant) {
                    assistant.classList.remove('show');
                }
            }
            
            // Sauvegarder la préférence
            localStorage.setItem('logecpe_assistance_enabled', assistanceEnabled ? 'true' : 'false');
        }
        
        // Créer le bouton flottant Assistance
        function createAssistanceButton() {
            const btn = document.createElement('button');
            btn.id = 'assistanceFloatingBtn';
            
            // Charger la préférence sauvegardée
            const savedPref = localStorage.getItem('logecpe_assistance_enabled');
            assistanceEnabled = savedPref !== 'false'; // Par défaut activé
            
            btn.innerHTML = assistanceEnabled ? '💡 Aide ON' : '💡 Aide OFF';
            btn.style.cssText = `
                position: fixed;
                bottom: 15px;
                left: 50%;
                transform: translateX(-120px);
                padding: 10px 18px;
                background: ${assistanceEnabled ? 'linear-gradient(135deg, #4CAF50, #2E7D32)' : 'linear-gradient(135deg, #9E9E9E, #616161)'};
                color: white;
                border: none;
                border-radius: 20px;
                cursor: pointer;
                font-weight: bold;
                font-size: 13px;
                z-index: 99998;
                box-shadow: ${assistanceEnabled ? '0 3px 12px rgba(76, 175, 80, 0.4)' : '0 3px 12px rgba(158, 158, 158, 0.4)'};
                transition: all 0.3s;
                opacity: 0.5;
            `;
            btn.onmouseover = () => {
                btn.style.transform = 'translateX(-120px) scale(1.1)';
                btn.style.opacity = '1';
            };
            btn.onmouseout = () => {
                btn.style.transform = 'translateX(-120px) scale(1)';
                btn.style.opacity = '0.5';
            };
            btn.onclick = toggleAssistance;
            document.body.appendChild(btn);
        }
        
        // Créer le bouton flottant pour rappeler le tutoriel
        function createTutorialButton() {
            const btn = document.createElement('button');
            btn.id = 'tutorialFloatingBtn';
            btn.innerHTML = '📖 Tutoriel';
            btn.style.cssText = `
                position: fixed;
                bottom: 15px;
                left: 50%;
                transform: translateX(10px);
                padding: 10px 18px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border: none;
                border-radius: 20px;
                cursor: pointer;
                font-weight: bold;
                font-size: 13px;
                z-index: 99998;
                box-shadow: 0 3px 12px rgba(102, 126, 234, 0.4);
                transition: all 0.3s;
                opacity: 0.5;
            `;
            btn.onmouseover = () => {
                btn.style.transform = 'translateX(10px) scale(1.1)';
                btn.style.opacity = '1';
                btn.style.boxShadow = '0 5px 18px rgba(102, 126, 234, 0.6)';
            };
            btn.onmouseout = () => {
                btn.style.transform = 'translateX(10px) scale(1)';
                btn.style.opacity = '0.5';
                btn.style.boxShadow = '0 3px 12px rgba(102, 126, 234, 0.4)';
            };
            btn.onclick = () => showTutorial(0);
            document.body.appendChild(btn);
        }
        
        // Lancer le tutoriel au démarrage de la démo
        window.addEventListener('DOMContentLoaded', function() {
            if (DEMO_MODE) {
                // Créer les boutons flottants toujours
                setTimeout(createTutorialButton, 1000);
                setTimeout(createAssistanceButton, 1000);
                
                // Afficher le tutoriel à chaque lancement de la démo
                setTimeout(() => showTutorial(0), 1500);
            }
        });
    </script>
    
    <!-- Animation pour le timer -->
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Assistant d'utilisation avancé */
        #demoAssistant {
            position: fixed;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            border-radius: 12px;
            font-size: 13px;
            z-index: 100001;
            pointer-events: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            max-width: 400px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-10px);
            border: 3px solid rgba(255, 255, 255, 0.4);
            overflow: hidden;
        }
        
        #demoAssistant.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        #demoAssistant .assistant-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        #demoAssistant .assistant-icon {
            font-size: 24px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        #demoAssistant .assistant-title {
            font-weight: bold;
            font-size: 14px;
            flex: 1;
        }
        
        #demoAssistant .assistant-content {
            padding: 15px;
            line-height: 1.6;
        }
        
        #demoAssistant .action-title {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #FFD700;
        }
        
        #demoAssistant .action-description {
            margin-bottom: 12px;
            color: #E8E8E8;
        }
        
        #demoAssistant .steps-list {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        #demoAssistant .steps-list-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #FFD700;
            font-size: 13px;
        }
        
        #demoAssistant .step-item {
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
            color: #FFF;
        }
        
        #demoAssistant .step-item::before {
            content: "▸";
            position: absolute;
            left: 5px;
            color: #FFD700;
        }
        
        #demoAssistant .tip-box {
            background: rgba(255, 215, 0, 0.15);
            border-left: 3px solid #FFD700;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        #demoAssistant .tip-box strong {
            color: #FFD700;
        }
        
        #demoAssistant .examples {
            margin-top: 10px;
            font-size: 12px;
            font-style: italic;
            color: #DDD;
        }
        
        #demoAssistant .locked-badge {
            display: inline-block;
            background: #F44336;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        #demoAssistant .shortcut {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            color: #FFD700;
        }
    </style>
    
    <!-- Système d'assistant interactif pour la démo -->
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            if (DEMO_MODE) {
                initDemoAssistant();
            }
        });
        
        function initDemoAssistant() {
            // Créer l'élément assistant
            const assistant = document.createElement('div');
            assistant.id = 'demoAssistant';
            assistant.innerHTML = `
                <div class="assistant-header">
                    <div class="assistant-icon">🎯</div>
                    <div class="assistant-title">Assistant LOGECPE</div>
                </div>
                <div class="assistant-content" id="assistantContent"></div>
            `;
            document.body.appendChild(assistant);
            
            // Base de connaissances détaillée EXHAUSTIVE
            const detailedHelp = {
                // Boutons désactivés en démo
                'saveSoftwareState': {
                    title: '💾 Sauvegarder le LOGICIEL (HTML)',
                    locked: true,
                    description: 'Enregistre l\'intégralité du logiciel avec toutes vos données dans un fichier HTML unique.',
                    steps: [
                        'Toutes les données sont incluses : élèves, plans, RDV, notes',
                        'Le fichier HTML généré est autonome et portable',
                        'Vous pouvez le copier, le partager ou le déplacer',
                        'Double-cliquez sur le fichier pour relancer le logiciel avec vos données'
                    ],
                    tip: 'Cette sauvegarde crée une copie complète du logiciel. Idéal pour faire des sauvegardes de sécurité ou travailler sur différents ordinateurs.'
                },
                
                'saveStandaloneHTML': {
                    title: '💾 Sauvegarde Clé USB/Cloud (JSON)',
                    locked: true,
                    description: 'Exporte uniquement vos données (sans le logiciel) dans un fichier JSON léger.',
                    steps: [
                        'Génère un fichier JSON avec toutes vos données',
                        'Parfait pour sauvegarder sur clé USB ou cloud',
                        'Fichier léger (quelques Ko seulement)',
                        'Importable dans n\'importe quelle version du logiciel'
                    ],
                    tip: 'Utilisez cette option pour des sauvegardes régulières rapides. Le fichier JSON est compatible avec Nextcloud, Google Drive, Dropbox, etc.'
                },
                
                'openLoadModal': {
                    title: '📂 Charger',
                    locked: true,
                    description: 'Importe une sauvegarde précédente (JSON) pour restaurer vos données.',
                    steps: [
                        'Cliquez pour ouvrir le sélecteur de fichiers',
                        'Choisissez un fichier JSON de sauvegarde',
                        'Vos données actuelles seront remplacées',
                        'Confirmation demandée avant l\'import'
                    ],
                    tip: 'Toujours faire une sauvegarde avant de charger un ancien fichier. Vous pouvez ainsi revenir en arrière si nécessaire.'
                },
                
                'toggleUtilityTools': {
                    title: '🛠️ Utilitaires',
                    locked: true,
                    description: 'Accède aux outils avancés pour la gestion du calendrier et des configurations.',
                    steps: [
                        'Création de calendriers personnalisés',
                        'Gestion des vacances scolaires par zone',
                        'Import de calendriers académiques',
                        'Paramètres avancés de synchronisation'
                    ],
                    tip: 'Ces outils sont destinés aux utilisateurs avancés qui souhaitent personnaliser entièrement leur calendrier scolaire.'
                },
                
                'openSettingsModal': {
                    title: '⚙️ Paramètres',
                    locked: true,
                    description: 'Configure les préférences du logiciel selon vos besoins.',
                    steps: [
                        'Nom de la base de données',
                        'Sauvegarde automatique (intervalle)',
                        'Protection par mot de passe',
                        'Date limite d\'utilisation (anti-oubli)'
                    ],
                    tip: 'Activez la sauvegarde automatique pour ne jamais perdre vos données. Recommandé : 5-10 minutes.'
                },
                
                'importFromCSVFile': {
                    title: '📂 Importer CSV/XLSX',
                    locked: true,
                    description: 'Importe une liste d\'élèves depuis un fichier Excel ou CSV.',
                    steps: [
                        'Préparez un fichier Excel avec : Nom, Prénom, Classe, Sexe, Date naissance',
                        'Cliquez sur le bouton pour sélectionner le fichier',
                        'Le logiciel détecte automatiquement les colonnes',
                        'Prévisualisez avant d\'importer définitivement'
                    ],
                    examples: 'Formats supportés : .xlsx, .xls, .csv. Compatible avec exports PRONOTE, ONDE, Charlemagne.',
                    tip: 'Vous pouvez importer plusieurs fois. Les doublons sont détectés automatiquement.'
                },
                
                'importFromClipboardRPP': {
                    title: '📋 RPP (Récupération Presse-Papier)',
                    locked: true,
                    description: 'Importe des données copiées depuis un tableau (Excel, PRONOTE, etc.).',
                    steps: [
                        'Copiez des données depuis Excel ou PRONOTE (Ctrl+C)',
                        'Cliquez sur RPP',
                        'Le logiciel analyse automatiquement le format',
                        'Validation puis import des élèves'
                    ],
                    tip: 'Méthode la plus rapide ! Sélectionnez simplement les lignes dans Excel et copiez-les.'
                },
                
                'closeRdvView': {
                    title: '❌ Fermer',
                    locked: true,
                    description: 'Ferme l\'agenda RDV pour revenir à la vue principale.',
                    steps: [
                        'Sauvegarde automatique de tous les RDV en cours',
                        'Retour à la vue logiciel',
                        'Les RDV restent accessibles dans les fiches élèves'
                    ],
                    tip: 'Désactivé en démo pour vous permettre d\'explorer l\'interface complète.'
                },
                
                // Boutons actifs
                'importExportAndLoadToLOGECPE': {
                    title: '💾 Charger dans LOGECPE',
                    description: 'Transfère tous les élèves du module Import vers le logiciel principal.',
                    steps: [
                        'Vérifie que vous avez des élèves dans le tableau Import',
                        'Cliquez sur ce bouton',
                        'Les élèves sont organisés automatiquement par classe',
                        'Vous pouvez ensuite les placer dans les plans de classe'
                    ],
                    tip: 'C\'est l\'étape finale après avoir importé ou créé vos élèves. Une fois chargés, ils sont disponibles partout dans le logiciel.'
                },
                
                'importOpenAddStudentModal': {
                    title: '➕ Ajouter un élève',
                    description: 'Ouvre le formulaire pour créer manuellement une fiche élève.',
                    steps: [
                        'Remplissez le nom, prénom, classe',
                        'Ajoutez la date de naissance et le sexe',
                        'Optionnel : groupes, options, projets, allergies',
                        'Cliquez sur Enregistrer'
                    ],
                    tip: 'Utilisez ce formulaire pour ajouter un élève qui arrive en cours d\'année, ou pour créer rapidement quelques profils.'
                },
                
                'importGenerateSample': {
                    title: '🎲 Exemple de données',
                    description: 'Génère automatiquement 1500 profils d\'élèves réalistes pour tester.',
                    steps: [
                        'Cliquez sur le bouton',
                        '1500 élèves sont créés instantanément',
                        'Répartis sur 50 classes (2nde à BTS2)',
                        'Avec noms diversifiés, spécialités, options réalistes'
                    ],
                    tip: 'Parfait pour découvrir le logiciel sans avoir à créer des données. Les profils incluent toutes les informations : allergies, projets, engagements, etc.'
                },
                
                'importClearAllData': {
                    title: '🗑️ Tout effacer',
                    description: 'Supprime TOUS les élèves du module Import (avec confirmation).',
                    steps: [
                        'Cliquez sur le bouton',
                        'Une confirmation vous sera demandée',
                        'Toutes les données Import sont supprimées',
                        'Le logiciel principal n\'est pas affecté'
                    ],
                    tip: '⚠️ Attention : cette action est irréversible ! Utilisez-la pour repartir de zéro dans le module Import.'
                },
                
                'openPrintModal': {
                    title: '🖨 Imprimer',
                    description: 'Imprime le logiciel actuel avec mise en page professionnelle.',
                    steps: [
                        'Ouvre les options d\'impression',
                        'Choisissez le format (A4, A3, paysage...)',
                        'Sélectionnez les informations à afficher',
                        'Prévisualisez puis imprimez ou exportez en PDF'
                    ],
                    tip: 'Vous pouvez imprimer avec ou sans les noms, avec les statuts de couleur, pour afficher en classe ou garder dans votre bureau.'
                },
                
                'openAnnualSummaryModal': {
                    title: '📊 Synthèse Annuelle',
                    description: 'Affiche un récapitulatif complet de tous les élèves sur l\'année.',
                    steps: [
                        'Vue d\'ensemble de tous les élèves de toutes les classes',
                        'Nombre de RDV par élève',
                        'Observations cumulées',
                        'Filtres par classe, période, type'
                    ],
                    tip: 'Idéal pour préparer les conseils de classe ou faire un bilan en fin d\'année.'
                },
                
                'openStatisticsModal': {
                    title: '📈 Statistiques',
                    description: 'Consulte des statistiques détaillées sur vos données.',
                    steps: [
                        'Nombre d\'élèves par classe, par sexe',
                        'Répartition des options et spécialités',
                        'Statistiques de RDV (total, moyenne, répartition)',
                        'Graphiques et tableaux récapitulatifs'
                    ],
                    tip: 'Utile pour avoir une vision globale de votre suivi et identifier les élèves nécessitant plus d\'attention.'
                },
                
                'resetPlan': {
                    title: '🔄 Réinitialiser',
                    description: 'Remet à zéro le logiciel de la semaine actuelle.',
                    steps: [
                        'Supprime uniquement le placement des élèves',
                        'Les fiches élèves sont conservées',
                        'Les RDV et observations ne sont pas affectés',
                        'Vous pouvez replacer les élèves autrement'
                    ],
                    tip: 'Utilisez cette fonction si vous voulez refaire complètement le placement sans perdre vos données.'
                },
                
                'toggleAssistanceTools': {
                    title: '❓ Assistance',
                    description: 'Accède aux guides, tutoriels et documentation du logiciel.',
                    steps: [
                        'Guides visuels interactifs (diaporamas)',
                        'Documentation complète en HTML',
                        'Tutoriels pas à pas pour chaque fonction',
                        'Références des boutons et raccourcis'
                    ],
                    tip: 'Consultez l\'assistance si vous êtes bloqué. Tous les guides sont intégrés au logiciel, pas besoin d\'internet.'
                },
                
                'showImportPanel': {
                    title: '📥 Import Établissement',
                    description: 'Module d\'importation et gestion de la base élèves.',
                    steps: [
                        'Importez vos élèves (CSV, Excel, copier-coller)',
                        'Créez manuellement des profils',
                        'Modifiez les informations',
                        'Chargez les élèves dans le logiciel principal'
                    ],
                    tip: 'C\'est le point de départ ! Importez d\'abord vos élèves ici avant de pouvoir les placer dans les plans de classe.'
                },
                
                'showAgendaPanel': {
                    title: '📅 Agenda des saisies',
                    description: 'Calendrier mensuel de suivi des observations et notes hebdomadaires.',
                    steps: [
                        'Vue mensuelle de toutes vos saisies',
                        'Cliquez sur un jour pour voir les observations',
                        'Codes couleurs : rouge=urgent, vert=positif',
                        'Export possible vers Excel ou PDF'
                    ],
                    tip: 'L\'agenda vous permet de retrouver rapidement quand vous avez noté quelque chose sur un élève.'
                },
                
                'showRecherchePanel': {
                    title: '🔍 Recherche Élève',
                    description: 'Recherche rapide d\'un élève par nom, prénom ou classe.',
                    steps: [
                        'Tapez quelques lettres du nom ou prénom',
                        'La recherche est instantanée',
                        'Cliquez sur un résultat pour ouvrir la fiche',
                        'Fonctionne sur toutes les classes'
                    ],
                    tip: 'Le moyen le plus rapide pour retrouver un élève quand vous avez beaucoup de classes.'
                },
                
                'toggleRdvView': {
                    title: '📅 Agenda RDV',
                    description: 'Gestion complète des rendez-vous élèves avec vue jour/semaine/mois.',
                    steps: [
                        'Créez des RDV individuels ou par groupe',
                        'Choisissez le créneau horaire',
                        'Ajoutez une description et le lieu',
                        'Les RDV s\'affichent dans les fiches élèves'
                    ],
                    tip: 'Créez un RDV en cliquant sur un créneau horaire dans la vue semaine ! Le logiciel propose automatiquement l\'heure et la durée.'
                },
                
                // Éléments de calendrier RDV
                'rdv-timeslot': {
                    title: '🕐 Créneaux horaires - Agenda RDV',
                    description: 'Cliquez sur n\'importe quel créneau pour créer rapidement un rendez-vous.',
                    steps: [
                        'Passez en vue "Semaine" dans l\'Agenda RDV',
                        'Cliquez sur n\'importe quelle cellule horaire',
                        'L\'heure est pré-remplie automatiquement',
                        'Choisissez l\'élève et complétez les détails'
                    ],
                    tip: '💡 Astuce Pro : Cliquez sur 14h00 → Le RDV sera créé automatiquement pour 14h00-15h00. Vous ajustez ensuite la durée si besoin.'
                },
                
                'rdv-day-cell': {
                    title: '📅 Cellule journalière - Agenda RDV',
                    description: 'En vue "Mois", cliquez sur un jour pour créer un RDV ce jour-là.',
                    steps: [
                        'Passez en vue "Mois"',
                        'Cliquez sur n\'importe quel jour',
                        'Un formulaire s\'ouvre avec la date pré-remplie',
                        'Choisissez l\'heure et l\'élève'
                    ],
                    tip: 'Parfait pour planifier plusieurs RDV dans la même journée.'
                },
                
                'switchWeek': {
                    title: '📆 Sélecteur de semaine',
                    description: 'Change la semaine de travail pour accéder à vos plans passés ou futurs.',
                    steps: [
                        'Cliquez sur le sélecteur de semaine',
                        'Choisissez une semaine dans la liste',
                        'Le logiciel de cette semaine s\'affiche',
                        'Chaque semaine a sa propre configuration'
                    ],
                    tip: 'Le logiciel sauvegarde automatiquement chaque semaine. Vous pouvez revenir en arrière à tout moment.'
                },
                
                'switchClass': {
                    title: '🎓 Sélecteur de classe',
                    description: 'Bascule entre vos différentes classes.',
                    steps: [
                        'Cliquez sur le sélecteur de classe',
                        'Choisissez une classe dans la liste',
                        'Le plan et les élèves de cette classe s\'affichent',
                        'Chaque classe a ses propres données'
                    ],
                    tip: 'Vous pouvez gérer autant de classes que vous voulez. Le logiciel garde tout en mémoire.'
                },
                
                // Éléments du logiciel
                'table': {
                    title: '🪑 Table de travail',
                    description: 'Placement et organisation des élèves dans la classe.',
                    steps: [
                        'Cliquez sur une table vide pour y placer un élève',
                        'Une liste de vos élèves disponibles s\'affiche',
                        'Sélectionnez un élève',
                        'L\'élève est placé à cette table'
                    ],
                    tip: 'Vous pouvez aussi faire glisser un élève d\'une table à une autre en drag & drop.'
                },
                
                'student': {
                    title: '👤 Fiche élève',
                    description: 'Accès complet aux informations et au suivi de l\'élève.',
                    steps: [
                        'Clic simple : ouvre la fiche complète',
                        'Glisser-déposer : déplace vers une autre table',
                        'Clic droit : options rapides (enlever, échanger)',
                        'La fiche contient : infos, notes, RDV, allergies, projets'
                    ],
                    tip: 'La fiche élève est le cœur du logiciel. Vous pouvez y noter tout ce qui concerne l\'élève.'
                },
                
                // Boutons navigation RDV
                'setRdvViewMode': {
                    title: '📅 Modes d\'affichage RDV',
                    description: 'Bascule entre la vue Jour, Semaine ou Mois de l\'agenda RDV.',
                    steps: [
                        '📅 Jour : Voir tous les RDV d\'une journée heure par heure',
                        '📅 Semaine : Vue sur 7 jours avec créneaux horaires cliquables',
                        '📅 Mois : Vue mensuelle complète, 1 mois en un coup d\'œil'
                    ],
                    tip: 'Vue Semaine recommandée pour créer des RDV rapidement en cliquant sur les créneaux.'
                },
                
                'changeRdvDate': {
                    title: '◀️ ▶️ Navigation temporelle',
                    description: 'Navigue entre les jours, semaines ou mois selon le mode d\'affichage.',
                    steps: [
                        '◀️ : Période précédente',
                        '▶️ : Période suivante',
                        'La date affichée au centre se met à jour',
                        'Les RDV de la période s\'affichent automatiquement'
                    ],
                    tip: 'Utilisez les flèches pour consulter vos anciens RDV ou planifier les prochains.'
                },
                
                'openRdvTypeSelection': {
                    title: '➕ Nouveau RDV',
                    description: 'Crée un rendez-vous élève avec toutes les informations nécessaires.',
                    steps: [
                        'Choisissez le type : élève seul ou groupe',
                        'Sélectionnez l\'élève ou les élèves',
                        'Définissez date, heure, durée',
                        'Ajoutez lieu, description, motif'
                    ],
                    tip: 'Alternative : cliquez directement sur un créneau horaire dans la vue Semaine pour créer plus rapidement.'
                },
                
                'toggleRdvFullScreen': {
                    title: '⛶ Plein écran',
                    description: 'Affiche l\'agenda RDV en mode plein écran pour plus de confort.',
                    steps: [
                        'Cliquez pour agrandir au maximum',
                        'Tous les détails deviennent plus lisibles',
                        'Recliquez pour revenir à la vue normale'
                    ],
                    tip: 'Pratique quand vous avez beaucoup de RDV dans la semaine.'
                },
                
                // Éléments génériques
                // Boutons supplémentaires de la barre d'outils
                'closePrintModal': {
                    title: '✖ Fermer impression',
                    description: 'Ferme la fenêtre d\'options d\'impression sans imprimer.',
                    steps: ['Annule l\'opération', 'Retour à la vue normale'],
                    tip: 'Aucune modification n\'est effectuée.'
                },
                
                'confirmPrint': {
                    title: '🖨 Lancer l\'impression',
                    description: 'Valide vos choix et lance l\'impression du logiciel.',
                    steps: [
                        'Ouvre la fenêtre d\'aperçu avant impression du navigateur',
                        'Vous pouvez choisir l\'imprimante ou sauvegarder en PDF',
                        'Ajustez les marges et l\'orientation si nécessaire'
                    ],
                    tip: 'Astuce : Choisissez "Enregistrer au format PDF" pour créer un document partageable.'
                },
                
                'printAnnualSummary': {
                    title: '🖨 Imprimer synthèse annuelle',
                    description: 'Imprime le récapitulatif annuel complet de tous les élèves.',
                    steps: [
                        'Compile toutes les observations de l\'année',
                        'Formate le document pour impression',
                        'Ouvre l\'aperçu avant impression'
                    ],
                    tip: 'Document parfait pour les conseils de classe de fin d\'année.'
                },
                
                'showSummaryClassSelection': {
                    title: '🎓 Synthèse par classe',
                    description: 'Génère une synthèse uniquement pour une classe spécifique.',
                    steps: [
                        'Affiche la liste de toutes vos classes',
                        'Sélectionnez la classe souhaitée',
                        'La synthèse ne contiendra que les élèves de cette classe'
                    ],
                    tip: 'Idéal pour préparer un conseil de classe spécifique.'
                },
                
                'showSummaryStudentSearch': {
                    title: '👤 Synthèse élève individuel',
                    description: 'Crée une synthèse détaillée pour un seul élève.',
                    steps: [
                        'Recherchez l\'élève par nom',
                        'Sélectionnez-le dans les résultats',
                        'Obtenez son bilan annuel complet'
                    ],
                    tip: 'Parfait pour préparer un entretien individuel avec l\'élève ou ses parents.'
                },
                
                'printStats': {
                    title: '🖨 Imprimer statistiques',
                    description: 'Imprime les graphiques et tableaux statistiques.',
                    steps: [
                        'Tous les graphiques sont inclus',
                        'Format optimisé pour l\'impression',
                        'Idéal pour les rapports de direction'
                    ]
                },
                
                'toggleStatsFullScreen': {
                    title: '⛶ Plein écran statistiques',
                    description: 'Affiche les statistiques en mode plein écran.',
                    steps: [
                        'Agrandit la fenêtre au maximum',
                        'Les graphiques sont plus lisibles',
                        'Recliquez pour revenir'
                    ]
                },
                
                'setStatsRange': {
                    title: '📅 Filtrer par période',
                    description: 'Affiche les statistiques sur une période spécifique.',
                    steps: [
                        'Aujourd\'hui : uniquement les données du jour',
                        'Semaine : 7 derniers jours',
                        'Mois : 30 derniers jours',
                        'Année : 365 derniers jours ou année scolaire'
                    ],
                    tip: 'Utilisez différentes périodes pour analyser vos tendances de suivi.'
                },
                
                'printMotifList': {
                    title: '🖨 Imprimer liste motifs',
                    description: 'Imprime la liste des observations avec leurs motifs.',
                    steps: [
                        'Toutes les observations sont listées',
                        'Groupées par motif',
                        'Avec date et élève concerné'
                    ]
                },
                
                'toggleMotifSelection': {
                    title: '☑️ Sélection multiple',
                    description: 'Active/désactive la sélection de plusieurs observations.',
                    steps: [
                        'Cochez plusieurs observations',
                        'Appliquez une action groupée',
                        'Modifiez ou supprimez en masse'
                    ]
                },
                
                'editMotifForSelected': {
                    title: '✏️ Modifier motifs sélectionnés',
                    description: 'Change le motif de toutes les observations sélectionnées.',
                    steps: [
                        'Sélectionnez d\'abord plusieurs observations',
                        'Cliquez sur ce bouton',
                        'Choisissez le nouveau motif',
                        'Toutes les observations sont mises à jour'
                    ]
                },
                
                'printPopulationList': {
                    title: '🖨 Imprimer liste population',
                    description: 'Imprime la liste complète des élèves avec leurs informations.',
                    steps: [
                        'Tableau complet : Nom, Prénom, Classe, Statuts',
                        'Toutes les options et spécialités',
                        'Format A4 optimisé'
                    ]
                },
                
                'closePopulationListModal': {
                    title: '❌ Fermer liste population',
                    description: 'Ferme la fenêtre de liste des élèves.',
                    steps: ['Retour à la vue précédente']
                },
                
                'saveSettings': {
                    title: '💾 Sauvegarder paramètres',
                    description: 'Enregistre tous les paramètres que vous avez modifiés.',
                    steps: [
                        'Sauvegarde dans le navigateur',
                        'Paramètres conservés après fermeture',
                        'Appliqués immédiatement'
                    ],
                    tip: 'Les paramètres sont stockés localement. Si vous changez d\'ordinateur, il faudra les reconfigurer.'
                },
                
                'pickAutoSaveLocation': {
                    title: '📁 Choisir dossier auto-sauvegarde',
                    locked: true,
                    description: 'Définit où seront enregistrées les sauvegardes automatiques.',
                    steps: [
                        'Naviguez vers le dossier souhaité',
                        'Confirmez le choix',
                        'Les sauvegardes auto iront dans ce dossier'
                    ],
                    tip: 'Choisissez un dossier synchronisé (Nextcloud, OneDrive) pour sauvegardes cloud automatiques.'
                },
                
                'openLockSettingsModal': {
                    title: '🔒 Paramètres de verrouillage',
                    locked: true,
                    description: 'Configure la protection par mot de passe et date limite.',
                    steps: [
                        'Définissez un mot de passe',
                        'Fixez une date limite d\'utilisation',
                        'Le logiciel se verrouille automatiquement après cette date'
                    ],
                    tip: 'Utile pour limiter l\'usage du logiciel à une année scolaire ou pour protéger vos données.'
                },
                
                'resetSummaryModal': {
                    title: '🔄 Réinitialiser filtres',
                    description: 'Remet les filtres de synthèse à leur état initial.',
                    steps: [
                        'Efface tous les filtres actifs',
                        'Retour à la vue "Tous les élèves"'
                    ]
                },
                
                'confirmSummaryClass': {
                    title: '✓ Confirmer classe',
                    description: 'Valide le choix de classe pour la synthèse.',
                    steps: [
                        'Génère la synthèse uniquement pour cette classe',
                        'Affiche les résultats'
                    ]
                },
                
                'openPrintOptions': {
                    title: '🖨 Options d\'impression',
                    description: 'Ouvre le menu d\'options d\'impression pour l\'agenda RDV.',
                    steps: [
                        'Choisissez ce que vous voulez imprimer',
                        'Jour, semaine ou mois',
                        'Avec ou sans détails',
                        'Format et orientation'
                    ]
                },
                
                'toggleCalendarTools': {
                    title: '📅 Outils calendrier',
                    description: 'Affiche les outils de gestion du calendrier scolaire.',
                    steps: [
                        'Import de vacances scolaires par zone',
                        'Édition manuelle des jours fériés',
                        'Import de calendriers JSON personnalisés'
                    ]
                },
                
                'openCalendarCreatorModal': {
                    title: '📅 Créateur de calendrier',
                    description: 'Outil pour créer un calendrier scolaire personnalisé.',
                    steps: [
                        'Définissez les périodes de vacances',
                        'Ajoutez les jours fériés',
                        'Exportez votre calendrier',
                        'Partagez-le avec d\'autres utilisateurs'
                    ],
                    tip: 'Créez un calendrier pour votre établissement et partagez-le avec vos collègues.'
                },
                
                'importEditStudent': {
                    title: '✏️ Modifier élève',
                    description: 'Ouvre le formulaire pour modifier les informations d\'un élève.',
                    steps: [
                        'Modifiez nom, prénom, classe, date de naissance',
                        'Ajustez groupes, options, spécialités',
                        'Mettez à jour projets et allergies',
                        'Enregistrez les changements'
                    ],
                    tip: 'Toutes les modifications sont répercutées partout dans le logiciel.'
                },
                
                'importDeleteStudent': {
                    title: '🗑️ Supprimer élève',
                    description: 'Supprime définitivement un élève du module Import.',
                    steps: [
                        'Confirmation demandée',
                        'L\'élève est retiré de la liste',
                        'Cette action est irréversible dans le module Import',
                        'L\'élève reste dans LOGECPE principal si déjà chargé'
                    ],
                    tip: '⚠️ Cette suppression n\'affecte que le module Import, pas le logiciel principal.'
                },
                
                'importSaveStudent': {
                    title: '💾 Enregistrer élève',
                    description: 'Sauvegarde la fiche élève que vous venez de créer ou modifier.',
                    steps: [
                        'Valide toutes les informations',
                        'Ajoute l\'élève au tableau Import',
                        'Ferme le formulaire'
                    ]
                },
                
                'openStudentSheet': {
                    title: '📋 Ouvrir fiche élève',
                    description: 'Affiche la fiche complète d\'un élève avec toutes ses informations.',
                    steps: [
                        'Informations personnelles et statuts',
                        'Historique des observations hebdomadaires',
                        'Liste de tous les RDV',
                        'Notes, projets, allergies, engagements'
                    ],
                    tip: 'C\'est le cœur du logiciel. Vous pouvez y ajouter des observations chaque semaine.'
                },
                
                'closeStudentSheet': {
                    title: '✖ Fermer fiche élève',
                    description: 'Ferme la fiche élève et retourne à la vue logiciel.',
                    steps: [
                        'Sauvegarde automatique de tous les changements',
                        'Retour au logiciel'
                    ]
                },
                
                'saveStudentSheet': {
                    title: '💾 Sauvegarder fiche',
                    description: 'Enregistre manuellement toutes les modifications de la fiche.',
                    steps: [
                        'Sauvegarde les observations',
                        'Enregistre les notes hebdomadaires',
                        'Met à jour tous les statuts'
                    ],
                    tip: 'La sauvegarde est normalement automatique, mais ce bouton force l\'enregistrement immédiat.'
                },
                
                'addRubric': {
                    title: '➕ Ajouter rubrique personnalisée',
                    description: 'Crée une nouvelle section personnalisée dans la fiche élève.',
                    steps: [
                        'Donnez un titre à votre rubrique',
                        'Ajoutez le contenu',
                        'La rubrique apparaît dans la fiche',
                        'Visible uniquement pour cet élève'
                    ],
                    tip: 'Créez des rubriques sur mesure : "Objectifs", "Points forts", "Axes de progrès", etc.'
                },
                
                'deleteRubric': {
                    title: '🗑️ Supprimer rubrique',
                    description: 'Supprime une rubrique personnalisée de la fiche.',
                    steps: [
                        'Confirmation demandée',
                        'La rubrique et son contenu sont effacés'
                    ]
                },
                
                'addStudentRdv': {
                    title: '➕ Ajouter RDV depuis fiche',
                    description: 'Crée un nouveau rendez-vous directement depuis la fiche élève.',
                    steps: [
                        'L\'élève est déjà pré-sélectionné',
                        'Choisissez date et heure',
                        'Ajoutez motif et lieu',
                        'Le RDV apparaît dans l\'agenda'
                    ],
                    tip: 'Plus rapide que passer par l\'Agenda RDV quand vous êtes déjà sur la fiche.'
                },
                
                'deleteRdvFromSheet': {
                    title: '🗑️ Supprimer RDV',
                    description: 'Supprime un rendez-vous depuis la liste des RDV de l\'élève.',
                    steps: [
                        'Confirmation demandée',
                        'Le RDV est retiré de l\'agenda',
                        'Disparaît aussi de l\'Agenda RDV'
                    ]
                },
                
                'changeStudentColor': {
                    title: '🎨 Changer couleur élève',
                    description: 'Modifie la couleur de la vignette élève dans le logiciel.',
                    steps: [
                        'Choisissez parmi 8 couleurs',
                        'Rouge, orange, jaune, vert clair, cyan, bleu, violet, rose',
                        'Utilisez les couleurs pour catégoriser vos élèves'
                    ],
                    tip: 'Exemple : rouge=difficulté, vert=bon niveau, bleu=dys, violet=PAI, etc.'
                },
                
                'moveStudentToTable': {
                    title: '🪑 Déplacer élève',
                    description: 'Change la place d\'un élève dans le logiciel.',
                    steps: [
                        'Cliquez sur une table vide',
                        'Ou glissez-déposez l\'élève',
                        'Le placement est sauvegardé automatiquement'
                    ],
                    tip: 'Organisez vos élèves selon vos critères : niveau, comportement, groupes...'
                },
                
                'removeStudentFromPlan': {
                    title: '❌ Retirer du plan',
                    description: 'Enlève un élève du logiciel sans le supprimer.',
                    steps: [
                        'L\'élève retourne dans la liste latérale',
                        'Vous pouvez le replacer plus tard',
                        'Ses données ne sont pas perdues'
                    ]
                },
                
                'swapStudents': {
                    title: '🔄 Échanger places',
                    description: 'Échange la position de deux élèves.',
                    steps: [
                        'Sélectionnez un premier élève',
                        'Cliquez sur "Échanger avec..."',
                        'Cliquez sur le second élève',
                        'Les deux positions sont inversées'
                    ]
                },
                
                // Éléments de la sidebar
                'sidebarStudent': {
                    title: '👤 Élève dans la liste',
                    description: 'Élève disponible pour placement dans le logiciel.',
                    steps: [
                        'Clic simple : ouvre la fiche complète',
                        'Glisser-déposer : place sur une table vide',
                        'Double-clic : place automatiquement sur première table disponible'
                    ],
                    tip: 'Les élèves colorés sont ceux déjà placés dans d\'autres semaines. Les gris sont jamais placés.'
                },
                
                'sidebarClass': {
                    title: '📚 Classe dans la sidebar',
                    description: 'Liste des classes disponibles. Navigation en 3 étapes pour accéder aux fiches élèves.',
                    steps: [
                        '1️⃣ ÉTAPE 1 : Cliquez d\'abord sur une CLASSE dans la liste (ex: "2GT1")',
                        '2️⃣ ÉTAPE 2 : La liste des ÉLÈVES de cette classe apparaît en dessous',
                        '3️⃣ ÉTAPE 3 : Double-cliquez sur un ÉLÈVE pour ouvrir sa fiche complète',
                        '',
                        '📋 Alternative : Clic simple sur un élève puis glisser-déposer vers une table'
                    ],
                    tip: '💡 Navigation : CLASSE → ÉLÈVES → FICHE. Pensez à bien cliquer sur la classe avant de chercher un élève !'
                },
                
                'classListItem': {
                    title: '🎓 Sélection de classe',
                    description: 'Cliquez sur cette classe pour afficher ses élèves dans la liste.',
                    steps: [
                        'Clic unique sur le nom de la classe',
                        'La liste des élèves de cette classe s\'affiche en dessous',
                        'Vous pouvez ensuite double-cliquer sur un élève pour sa fiche',
                        'Ou glisser un élève vers le logiciel'
                    ],
                    tip: '💡 Important : Vous DEVEZ d\'abord cliquer sur une classe pour voir ses élèves. Sans cette étape, aucun élève n\'est affiché.'
                },
                
                'studentListItemSidebar': {
                    title: '👤 Élève de la classe sélectionnée',
                    description: 'Élève appartenant à la classe que vous avez cliquée.',
                    steps: [
                        '🖱️ Clic simple : sélectionne l\'élève',
                        '🖱️🖱️ Double-clic : OUVRE SA FICHE COMPLÈTE avec toutes les informations',
                        '↔️ Glisser-déposer : le place directement sur une table du plan',
                        '👁️ La fiche contient : notes, RDV, observations, projets, allergies'
                    ],
                    tip: '💡 Double-cliquez pour ouvrir la fiche ! C\'est l\'accès le plus rapide aux détails de l\'élève.'
                },
                
                // === ÉLÉMENTS DE LA FICHE ÉLÈVE (COMPLET) ===
                
                // En-tête de la fiche
                'sheetHeaderName': {
                    title: '👤 Nom de l\'élève (En-tête)',
                    description: 'Affiche le nom complet de l\'élève. Zone cliquable et glissable.',
                    steps: [
                        '🖱️ Cliquez : Copie le nom dans le presse-papier',
                        '↔️ Glissez : Glisser-déposer vers une autre application',
                        'Utile pour coller le nom dans un email ou document'
                    ],
                    tip: '💡 Cliquez sur le nom pour le copier instantanément !'
                },
                
                'sheetSearchButton': {
                    title: '🔍 Recherche rapide',
                    description: 'Ouvre le hub de recherche pour trouver un autre élève rapidement.',
                    steps: [
                        'Ferme la fiche actuelle',
                        'Ouvre la barre de recherche globale',
                        'Tapez le nom d\'un autre élève',
                        'Cliquez sur le résultat pour ouvrir sa fiche'
                    ],
                    tip: 'Le moyen le plus rapide pour passer d\'un élève à un autre sans naviguer dans les listes.'
                },
                
                'sheetSynthesisButton': {
                    title: '📄 Synthèse Annuelle',
                    description: 'Génère un rapport complet de cet élève sur toute l\'année.',
                    steps: [
                        'Compile toutes les notes hebdomadaires',
                        'Liste tous les RDV de l\'année',
                        'Affiche l\'évolution des statuts',
                        'Format prêt à imprimer'
                    ],
                    tip: 'Parfait pour préparer un conseil de classe ou un entretien avec les parents.'
                },
                
                'sheetColorButton': {
                    title: '🎨 Couleur de l\'élève',
                    description: 'Change la couleur de la vignette de cet élève dans le logiciel.',
                    steps: [
                        'Cliquez sur ce bouton coloré',
                        'Choisissez parmi 8 couleurs',
                        'La couleur s\'applique immédiatement',
                        'Visible dans le logiciel'
                    ],
                    examples: '🔴 Rouge=difficulté, 🟢 Vert=bon niveau, 🔵 Bleu=dys, 🟣 Violet=PAI',
                    tip: 'Créez votre propre code couleur pour repérer rapidement vos élèves à besoins spécifiques.'
                },
                
                'sheetCloseX': {
                    title: '✖ Fermer la fiche',
                    description: 'Ferme la fiche élève et retourne au logiciel.',
                    steps: [
                        'Sauvegarde automatique avant fermeture',
                        'Retour à la vue précédente'
                    ],
                    tip: 'Toutes vos modifications sont sauvegardées automatiquement.'
                },
                
                // Section Informations de base
                'sheetNomField': {
                    title: '📝 Champ NOM',
                    description: 'Nom de famille de l\'élève.',
                    steps: [
                        'Modifiable directement',
                        'Sauvegarde automatique',
                        'Met à jour l\'affichage en en-tête'
                    ],
                    tip: 'Attention : modifier le nom peut affecter les liens avec d\'autres données.'
                },
                
                'sheetPrenomField': {
                    title: '📝 Champ PRÉNOM',
                    description: 'Prénom de l\'élève.',
                    steps: [
                        'Modifiable directement',
                        'Sauvegarde automatique'
                    ]
                },
                
                'sheetDobField': {
                    title: '📅 Date de naissance',
                    description: 'Date de naissance au format JJ/MM/AAAA.',
                    steps: [
                        'Saisissez la date manuellement',
                        'Format : 15/03/2008',
                        'Permet de calculer l\'âge et la majorité'
                    ],
                    tip: 'Un élève majeur a des droits différents (responsable légal de lui-même).'
                },
                
                'sheetSexeField': {
                    title: '⚧ Sexe',
                    description: 'Sexe de l\'élève (M ou F).',
                    steps: [
                        'Sélectionnez M (Masculin) ou F (Féminin)',
                        'Utilisé pour les statistiques'
                    ]
                },
                
                'sheetClasseField': {
                    title: '🎓 Classe de rattachement',
                    description: 'Classe principale de l\'élève.',
                    steps: [
                        'Indiquez la classe (ex: 2GT1, 1ES2, TG3)',
                        'Détermine où l\'élève apparaît dans la sidebar',
                        'Modifiable si changement de classe'
                    ],
                    tip: '⚠️ Changer la classe déplace l\'élève dans une nouvelle liste.'
                },
                
                'sheetGroupesField': {
                    title: '👥 Groupes',
                    description: 'Groupes de l\'élève (langues, sciences, options...).',
                    steps: [
                        'Listez les groupes séparés par des virgules',
                        'Ex: Anglais LVA, Allemand LVB, SVT Groupe 2',
                        'Utile pour organiser les plans de classe'
                    ],
                    tip: 'Les groupes permettent de filtrer les élèves dans certaines vues.'
                },
                
                'sheetOptionsField': {
                    title: '🏆 Options',
                    description: 'Options et spécialités de l\'élève.',
                    steps: [
                        'Listez toutes les options',
                        'Ex: Latin, Théâtre, Section Euro',
                        'Spécialités de 1ère/Terminale'
                    ],
                    tip: 'Important pour le suivi d\'orientation.'
                },
                
                'sheetProjetField': {
                    title: '📌 Projet d\'accompagnement',
                    description: 'Dispositifs et projets d\'accompagnement de l\'élève.',
                    steps: [
                        'PAP : Plan d\'Accompagnement Personnalisé',
                        'PPRE : Programme Personnalisé de Réussite Éducative',
                        'PPS : Projet Personnalisé de Scolarisation',
                        'Notez les aménagements spécifiques'
                    ],
                    tip: '⚠️ Informations importantes pour tous les enseignants !'
                },
                
                'sheetAllergiesField': {
                    title: '⚠️ Allergies / PAI',
                    description: 'Allergies et Projet d\'Accueil Individualisé.',
                    steps: [
                        'Listez TOUTES les allergies connues',
                        'Mentionnez le protocole PAI si existant',
                        'Ex: Arachides, Lactose, Piqûres d\'abeilles'
                    ],
                    tip: '🚨 SÉCURITÉ : Ces informations sont VITALES pour la sécurité de l\'élève !'
                },
                
                'sheetEngagementField': {
                    title: '🤝 Engagement',
                    description: 'Responsabilités et engagements de l\'élève.',
                    steps: [
                        'Délégué de classe',
                        'Éco-délégué',
                        'CVL, MDL, AS',
                        'Tout engagement citoyen'
                    ],
                    tip: 'À valoriser dans les appréciations et bulletins !'
                },
                
                'sheetRedoublantField': {
                    title: '🔄 Redoublant',
                    description: 'Indique si l\'élève redouble cette année.',
                    steps: [
                        'Oui ou Non',
                        'Peut indiquer l\'année précédente'
                    ],
                    tip: 'Information utile pour adapter le suivi pédagogique.'
                },
                
                'sheetMajeurField': {
                    title: '🎓 Majeur',
                    description: 'Indique si l\'élève est majeur (18 ans ou plus).',
                    steps: [
                        'Oui ou Non',
                        'Calculable depuis la date de naissance'
                    ],
                    tip: 'Un élève majeur peut signer lui-même certains documents.'
                },
                
                // Section RDV
                'sheetRdvSection': {
                    title: '📅 Section Rendez-Vous',
                    description: 'Liste complète de tous les rendez-vous avec cet élève.',
                    steps: [
                        'Affiche l\'historique des RDV passés',
                        'Montre les RDV futurs prévus',
                        'Chaque RDV affiche : date, motif, lieu',
                        'Cliquez sur un RDV pour le modifier'
                    ],
                    tip: 'Gardez une trace de tous vos entretiens pour un suivi complet.'
                },
                
                // Section Semaines
                'sheetWeeksSection': {
                    title: '📅 Section Semaines & Suivi',
                    description: 'Suivi pédagogique semaine par semaine.',
                    steps: [
                        'Calendrier des semaines de l\'année',
                        'Cliquez sur une semaine pour voir/éditer les notes',
                        'Les semaines colorées contiennent des données',
                        'Statut et notes hebdomadaires'
                    ],
                    tip: 'Le cœur du suivi ! Notez vos observations chaque semaine pour un historique complet.'
                },
                
                'sheetWeekButton': {
                    title: '📆 Bouton semaine',
                    description: 'Cliquez pour afficher les données de cette semaine.',
                    steps: [
                        'Semaine colorée = contient des notes',
                        'Semaine grise = pas encore de données',
                        'Les données s\'affichent en dessous'
                    ],
                    tip: 'Naviguez dans le temps pour voir l\'évolution de l\'élève.'
                },
                
                'sheetWeekStatusSelect': {
                    title: '👤 Statut de la semaine',
                    description: 'État de l\'élève pour cette semaine.',
                    steps: [
                        '✓ Présent : Tout va bien',
                        '⚠ Absent prévu : Absence connue à l\'avance',
                        '✗ Absent : Absence non prévue',
                        '? Autre : Situation particulière'
                    ],
                    tip: 'Le statut influence les statistiques et les couleurs du calendrier.'
                },
                
                'sheetWeekColorRadio': {
                    title: '🎨 Couleur hebdomadaire',
                    description: 'Code couleur pour qualifier la semaine de l\'élève.',
                    steps: [
                        '🔴 Rouge : Difficultés importantes, incidents',
                        '🟠 Orange : Quelques soucis à surveiller',
                        '🟡 Jaune : Passable, à améliorer',
                        '🟢 Vert : Bonne semaine, comportement positif'
                    ],
                    tip: 'Ces couleurs apparaissent dans le calendrier des semaines et les statistiques.'
                },
                
                'sheetFrequentWords': {
                    title: '📋 Mots fréquents',
                    description: 'Insertion rapide de termes courants dans les notes.',
                    steps: [
                        'Sélectionnez un mot dans la liste',
                        'Il s\'insère automatiquement dans les notes',
                        'Gain de temps pour les observations récurrentes'
                    ],
                    examples: 'Bavardages, Agitation, Retard, Matériel oublié, Participation...',
                    tip: 'Utilisez cette liste pour standardiser vos observations.'
                },
                
                'sheetFontSelect': {
                    title: '🔤 Style de caractère',
                    description: 'Change la police de caractères des notes.',
                    steps: [
                        'Choisissez parmi plusieurs polices',
                        'Monospace, Arial, Times New Roman...',
                        'Préférence personnelle'
                    ]
                },
                
                'sheetFormatButton': {
                    title: '⚙️ Bouton Format',
                    description: 'Affiche les options de formatage du texte.',
                    steps: [
                        'Gras, Italique, Souligné',
                        'Surlignage',
                        'Taille de police'
                    ],
                    tip: 'Mettez en valeur les informations importantes !'
                },
                
                'sheetSyncButton': {
                    title: '🔄 Synchro',
                    description: 'Synchronise les données avec le tableau de bord statistiques.',
                    steps: [
                        'Envoie toutes les données vers les stats',
                        'Met à jour les graphiques',
                        'Confirmation visuelle'
                    ],
                    tip: 'Utilisez après avoir fait beaucoup de modifications pour mettre à jour les stats.'
                },
                
                'sheetWeekNotes': {
                    title: '📝 Notes de la semaine',
                    description: 'Zone principale pour écrire vos observations hebdomadaires.',
                    steps: [
                        'Cliquez dans la zone pour commencer à taper',
                        'Écrivez vos observations, remarques, comportements',
                        'Sauvegarde automatique toutes les 2 secondes',
                        'Ces notes sont liées à la semaine sélectionnée'
                    ],
                    tip: '💡 Ces notes sont privées et visibles uniquement par vous. Soyez précis : comportement, travail, participation, incidents...'
                },
                
                'sheetWeekStatus': {
                    title: '🎚️ Statut de la semaine',
                    description: 'Curseur pour évaluer rapidement l\'élève cette semaine.',
                    steps: [
                        'Faites glisser le curseur de gauche (rouge) à droite (vert)',
                        'Rouge = Difficultés importantes',
                        'Orange = Quelques soucis',
                        'Jaune = Passable',
                        'Vert clair = Bien',
                        'Vert foncé = Excellent'
                    ],
                    tip: '💡 Ce statut visuel permet un suivi rapide. Il apparaît dans les statistiques et synthèses annuelles.'
                },
                
                'sheetStudentInfo': {
                    title: 'ℹ️ Informations élève',
                    description: 'Données personnelles et administratives de l\'élève.',
                    steps: [
                        'Nom, Prénom, Date de naissance',
                        'Classe, Sexe',
                        'Statuts : Majeur, Redoublant',
                        'Groupes, Options, Spécialités'
                    ],
                    tip: 'Ces informations sont définies lors de l\'import ou de la création de l\'élève.'
                },
                
                'sheetProjectsAllergies': {
                    title: '🏥 Projets & Allergies',
                    description: 'Informations médicales et projets d\'accompagnement.',
                    steps: [
                        'PAP : Plan d\'Accompagnement Personnalisé',
                        'PAI : Projet d\'Accueil Individualisé (allergies)',
                        'PPRE : Programme Personnalisé de Réussite Éducative',
                        'PPS : Projet Personnalisé de Scolarisation',
                        'AESH : Accompagnant des Élèves en Situation de Handicap'
                    ],
                    tip: '⚠️ Informations sensibles. Allergies alimentaires particulièrement importantes pour la sécurité.'
                },
                
                'sheetEngagements': {
                    title: '🎯 Engagements',
                    description: 'Responsabilités et implication de l\'élève dans l\'établissement.',
                    steps: [
                        'Délégué de classe',
                        'CVL (Conseil de Vie Lycéenne)',
                        'Éco-délégué',
                        'Bureau des élèves',
                        'Maison des lycéens',
                        'Association sportive'
                    ],
                    tip: 'Ces engagements valorisent l\'élève. À mentionner dans les appréciations !'
                },
                
                'sheetRdvList': {
                    title: '📅 Liste des RDV',
                    description: 'Historique complet de tous les rendez-vous avec cet élève.',
                    steps: [
                        'Date et heure de chaque RDV',
                        'Motif et lieu',
                        'Description détaillée',
                        'Cliquez sur un RDV pour le modifier ou supprimer'
                    ],
                    tip: '💡 Gardez une trace de tous vos entretiens. Utile pour les suivis et les bilans.'
                },
                
                'sheetAddRdv': {
                    title: '➕ Ajouter un RDV',
                    description: 'Crée un nouveau rendez-vous avec cet élève.',
                    steps: [
                        'L\'élève est déjà pré-sélectionné',
                        'Choisissez date et heure',
                        'Indiquez le motif (orientation, discipline, travail...)',
                        'Ajoutez le lieu (bureau CPE, vie scolaire...)',
                        'Enregistrez'
                    ],
                    tip: 'Le RDV apparaîtra aussi dans l\'Agenda RDV. Vous pouvez le retrouver facilement.'
                },
                
                'sheetDeleteRdv': {
                    title: '🗑️ Supprimer RDV',
                    description: 'Supprime définitivement ce rendez-vous.',
                    steps: [
                        'Confirmation demandée avant suppression',
                        'Le RDV disparaît de la fiche',
                        'Il est aussi retiré de l\'Agenda RDV'
                    ],
                    tip: '⚠️ Action irréversible ! Vérifiez bien avant de supprimer.'
                },
                
                'sheetWeeksCalendar': {
                    title: '📅 Calendrier des semaines',
                    description: 'Navigation rapide entre les différentes semaines pour voir l\'évolution.',
                    steps: [
                        'Chaque bouton représente une semaine de l\'année',
                        'Cliquez sur une semaine pour voir vos notes et statut',
                        'Les semaines avec notes sont colorées',
                        'Navigation chronologique de septembre à juin'
                    ],
                    tip: '💡 Visualisez l\'évolution de l\'élève sur toute l\'année. Pratique pour préparer un bilan !'
                },
                
                'sheetCustomRubric': {
                    title: '📑 Rubrique personnalisée',
                    description: 'Section créée sur mesure pour cet élève.',
                    steps: [
                        'Titre personnalisé par vos soins',
                        'Contenu libre (texte multiligne)',
                        'Visible uniquement dans cette fiche',
                        'Modifiable ou supprimable à tout moment'
                    ],
                    tip: 'Créez des rubriques comme "Objectifs trimestriels", "Points forts", "Axes d\'amélioration", "Suivi spécifique"...'
                },
                
                'sheetAddRubric': {
                    title: '➕ Ajouter rubrique',
                    description: 'Crée une nouvelle section personnalisée dans la fiche.',
                    steps: [
                        'Cliquez sur le bouton',
                        'Donnez un titre à votre rubrique',
                        'Remplissez le contenu',
                        'La rubrique s\'ajoute à la fiche'
                    ],
                    tip: '💡 Adaptez la fiche à vos besoins ! Créez autant de rubriques que nécessaire.'
                },
                
                'sheetDeleteRubric': {
                    title: '🗑️ Supprimer rubrique',
                    description: 'Supprime cette rubrique personnalisée.',
                    steps: [
                        'Confirmation demandée',
                        'La rubrique et son contenu sont effacés'
                    ],
                    tip: '⚠️ Le contenu sera perdu définitivement.'
                },
                
                'sheetSaveButton': {
                    title: '💾 Sauvegarder fiche',
                    description: 'Enregistre manuellement toutes les modifications de la fiche élève.',
                    steps: [
                        'Force la sauvegarde immédiate',
                        'Enregistre notes, statuts, rubriques',
                        'Confirmation visuelle'
                    ],
                    tip: 'Normalement la sauvegarde est automatique, mais ce bouton assure un enregistrement immédiat.'
                },
                
                'sheetCloseButton': {
                    title: '✖ Fermer fiche',
                    description: 'Ferme la fiche élève et retourne au logiciel.',
                    steps: [
                        'Sauvegarde automatique avant fermeture',
                        'Retour à la vue logiciel',
                        'Les modifications sont conservées'
                    ],
                    tip: 'Toutes vos notes sont sauvegardées. Vous pouvez rouvrir la fiche à tout moment.'
                },
                
                'sheetColorPicker': {
                    title: '🎨 Changer couleur',
                    description: 'Modifie la couleur de la vignette élève dans le plan.',
                    steps: [
                        'Choisissez parmi 8 couleurs disponibles',
                        'La couleur s\'applique à toutes les semaines',
                        'Utilisez un code couleur personnel :'
                    ],
                    examples: 'Rouge=difficulté, Vert=bon niveau, Bleu=dys, Violet=PAI, Orange=redoublant, etc.',
                    tip: '💡 Créez votre propre système de couleurs pour identifier rapidement les élèves à besoins spécifiques.'
                },
                
                'sheetHistoryWeek': {
                    title: '📆 Semaine historique',
                    description: 'Affiche les notes et statut d\'une semaine passée.',
                    steps: [
                        'Cliquez sur un numéro de semaine',
                        'Les notes de cette semaine s\'affichent',
                        'Le statut est visible',
                        'Vous pouvez modifier les notes passées'
                    ],
                    tip: 'Pratique pour consulter l\'historique ou corriger une observation.'
                },
                
                'sheetPrintButton': {
                    title: '🖨️ Imprimer fiche',
                    description: 'Imprime la fiche élève complète ou partielle.',
                    steps: [
                        'Choisissez les sections à imprimer',
                        'Format A4 ou A5',
                        'Avec ou sans notes confidentielles',
                        'Aperçu avant impression'
                    ],
                    tip: 'Utile pour les entretiens parents ou pour archiver en format papier.'
                },
                
                // BOUTONS DU PIED DE PAGE FICHE ÉLÈVE
                'addNewRubricToSheet': {
                    title: '📑 Rubrique(s)',
                    description: 'Ajoute une nouvelle rubrique personnalisée à la fiche élève.',
                    steps: [
                        'Cliquez pour créer une nouvelle section',
                        'Donnez un titre (ex: "Objectifs", "Points forts")',
                        'Remplissez le contenu',
                        'Sauvegarde automatique'
                    ],
                    tip: '💡 Créez des rubriques sur mesure pour organiser vos informations comme vous le souhaitez.'
                },
                
                'printStudentWeekFromModal': {
                    title: '🖨️ Imprimer semaine',
                    description: 'Imprime uniquement les données de la semaine sélectionnée.',
                    steps: [
                        'Sélectionnez d\'abord une semaine',
                        'Cliquez sur ce bouton',
                        'Génère un PDF/Impression de la semaine',
                        'Contient : statut, notes, observations'
                    ],
                    tip: 'Pratique pour garder une trace papier d\'une semaine particulière.'
                },
                
                'printStudentReportFromModal': {
                    title: '🖨️ Imprimer récap',
                    description: 'Imprime un récapitulatif complet de l\'élève.',
                    steps: [
                        'Compile toutes les informations',
                        'Inclut : infos, projets, allergies, notes',
                        'Format professionnel pour archivage',
                        'Prêt pour les dossiers'
                    ],
                    tip: 'Document idéal pour les conseils de classe ou les entretiens parents.'
                },
                
                'deleteStudentFromClass': {
                    title: '🗑️ SUPPRIMER',
                    description: 'Supprime définitivement cet élève du logiciel.',
                    steps: [
                        '⚠️ Confirmation demandée',
                        'L\'élève est retiré de la classe',
                        'Toutes ses données sont effacées',
                        'Action IRRÉVERSIBLE'
                    ],
                    tip: '🚨 ATTENTION : Cette action supprime DÉFINITIVEMENT l\'élève et toutes ses données !'
                },
                
                'openRdvForStudent': {
                    title: '📅 CRÉER RDV',
                    description: 'Crée un nouveau rendez-vous pour cet élève.',
                    steps: [
                        'L\'élève est pré-sélectionné',
                        'Choisissez date et heure',
                        'Indiquez le motif',
                        'Ajoutez lieu et description',
                        'Le RDV apparaît dans l\'agenda'
                    ],
                    tip: 'Méthode la plus rapide pour créer un RDV depuis la fiche élève.'
                },
                
                'readAllStudentInfo': {
                    title: '📖 TOUT LIRE',
                    description: 'Lit toutes les informations de l\'élève à voix haute.',
                    steps: [
                        'Utilise la synthèse vocale du navigateur',
                        'Lit : nom, classe, projets, allergies',
                        'Lit les notes de la semaine',
                        'Pratique pour l\'accessibilité'
                    ],
                    tip: 'Fonction d\'accessibilité. Vérifiez que le son est activé.'
                },
                
                'closeStudentSheetModal': {
                    title: '✖ FERMER',
                    description: 'Ferme la fiche élève et retourne au logiciel.',
                    steps: [
                        'Sauvegarde automatique de toutes les modifications',
                        'Retour à la vue précédente',
                        'Aucune donnée n\'est perdue'
                    ],
                    tip: 'Toutes vos notes sont sauvegardées automatiquement avant fermeture.'
                },
                
                'saveStudentSheetAndBackup': {
                    title: '💾 ENREGISTRER',
                    description: 'Force la sauvegarde immédiate de toutes les données.',
                    locked: true,
                    steps: [
                        'Sauvegarde toutes les modifications',
                        'Crée une copie de secours',
                        'Confirmation visuelle'
                    ],
                    tip: 'Normalement automatique. Ce bouton force l\'enregistrement immédiat.'
                },
                
                'studentInPlan': {
                    title: '👤 Élève placé',
                    description: 'Élève actuellement sur une table dans le logiciel.',
                    steps: [
                        'Clic simple : ouvre sa fiche',
                        'Glisser-déposer : déplace vers autre table',
                        'Clic droit : menu contextuel (enlever, échanger, couleur)'
                    ],
                    tip: 'La couleur de fond indique son statut ou catégorie personnalisée.'
                },
                
                // Éléments génériques
                'select': {
                    title: '📋 Sélecteur',
                    description: 'Menu déroulant pour choisir parmi plusieurs options.',
                    steps: [
                        'Cliquez pour ouvrir la liste',
                        'Sélectionnez l\'option souhaitée',
                        'Le logiciel s\'adapte automatiquement'
                    ]
                },
                
                'input': {
                    title: '✏️ Champ de saisie',
                    description: 'Zone de texte pour entrer des informations.',
                    steps: [
                        'Cliquez dans le champ',
                        'Tapez votre texte',
                        'Les changements sont sauvegardés automatiquement'
                    ]
                },
                
                'textarea': {
                    title: '📝 Zone de texte',
                    description: 'Zone pour saisir des observations ou notes détaillées.',
                    steps: [
                        'Cliquez pour activer',
                        'Tapez votre texte (multiligne)',
                        'Auto-save toutes les 2 secondes'
                    ],
                    tip: 'Pas de limite de caractères. Vous pouvez écrire autant que nécessaire.'
                },
                
                'checkbox': {
                    title: '☑️ Case à cocher',
                    description: 'Active ou désactive une option.',
                    steps: [
                        'Cliquez pour cocher/décocher',
                        'État sauvegardé automatiquement'
                    ]
                },
                
                'closeModal': {
                    title: '✖ Fermer',
                    description: 'Ferme la fenêtre modale actuelle.',
                    steps: [
                        'Retour à la vue précédente',
                        'Les modifications non sauvegardées peuvent être perdues'
                    ]
                },
                
                'weekSelector': {
                    title: '📅 Changement de semaine',
                    description: 'Navigue entre les différentes semaines de l\'année scolaire.',
                    steps: [
                        'Chaque semaine a son propre logiciel',
                        'Les données sont sauvegardées indépendamment',
                        'Vous pouvez consulter n\'importe quelle semaine passée ou future'
                    ],
                    tip: 'Utilisez les flèches ◀️ ▶️ pour navigation rapide semaine par semaine.'
                },
                
                'classSelector': {
                    title: '🎓 Changement de classe',
                    description: 'Bascule entre vos différentes classes.',
                    steps: [
                        'Toutes vos classes sont listées',
                        'Chaque classe a ses propres élèves et plans',
                        'Les RDV et observations sont liés à la classe'
                    ],
                    tip: 'Gérez autant de classes que vous voulez. Pas de limite !'
                },
                
                'searchInput': {
                    title: '🔍 Recherche',
                    description: 'Recherche instantanée dans vos données.',
                    steps: [
                        'Tapez nom, prénom ou début',
                        'Résultats en temps réel',
                        'Cliquez sur un résultat pour accéder à sa fiche'
                    ],
                    tip: 'La recherche est insensible aux majuscules et accents.'
                },
                
                'generic-button': {
                    title: '🔘 Bouton interactif',
                    description: 'Élément cliquable pour déclencher une action.',
                    steps: [
                        'Cliquez pour activer la fonction',
                        'Attendez le retour visuel',
                        'Certaines actions demandent confirmation'
                    ]
                }
            };
            
            // Fonction pour afficher l'assistant
            function showAssistant(element, helpKey) {
                const content = document.getElementById('assistantContent');
                const help = detailedHelp[helpKey];
                
                if (!help) return;
                
                let html = `
                    <div class="action-title">
                        ${help.title}
                        ${help.locked ? '<span class="locked-badge">🔒 DÉSACTIVÉ EN DÉMO</span>' : ''}
                    </div>
                    <div class="action-description">${help.description}</div>
                `;
                
                if (help.steps && help.steps.length > 0) {
                    html += '<div class="steps-list">';
                    html += '<div class="steps-list-title">📋 Comment l\'utiliser :</div>';
                    help.steps.forEach(step => {
                        html += `<div class="step-item">${step}</div>`;
                    });
                    html += '</div>';
                }
                
                if (help.examples) {
                    html += `<div class="examples">📌 ${help.examples}</div>`;
                }
                
                if (help.tip) {
                    html += `<div class="tip-box"><strong>💡 Astuce :</strong> ${help.tip}</div>`;
                }
                
                content.innerHTML = html;
                assistant.classList.add('show');
                positionAssistant(element);
            }
            
            function hideAssistant() {
                assistant.classList.remove('show');
            }
            
            function positionAssistant(element) {
                const rect = element.getBoundingClientRect();
                const padding = 15;
                
                let left = rect.right + padding;
                let top = rect.top;
                
                // Si déborde à droite, placer à gauche
                if (left + 400 > window.innerWidth) {
                    left = rect.left - 400 - padding;
                }
                
                // Si déborde à gauche, centrer en haut
                if (left < 0) {
                    left = window.innerWidth / 2 - 200;
                    top = rect.bottom + padding;
                }
                
                // Si déborde en bas, remonter
                if (top + assistant.offsetHeight > window.innerHeight) {
                    top = window.innerHeight - assistant.offsetHeight - padding;
                }
                
                // Si déborde en haut
                if (top < 0) {
                    top = padding;
                }
                
                assistant.style.left = left + 'px';
                assistant.style.top = top + 'px';
            }
            
            // Fonction pour créer un helper depuis un élément
            function createHelperFromElement(elem) {
                const text = elem.textContent.trim().substring(0, 100);
                const tagName = elem.tagName.toLowerCase();
                let icon = '🎯';
                
                if (tagName === 'button') icon = '🔘';
                else if (tagName === 'a') icon = '🔗';
                else if (tagName === 'input') icon = '✏️';
                else if (tagName === 'select') icon = '📋';
                else if (tagName === 'textarea') icon = '📝';
                
                return {
                    title: icon + ' ' + (text || 'Élément interactif'),
                    description: text || 'Zone cliquable pour interagir avec l\'application',
                    steps: [
                        'Utilisez cet élément pour accéder à une fonction',
                        'En version complète, toutes les fonctionnalités sont accessibles'
                    ],
                    tip: 'Explorez LOGECPE pour découvrir toutes ses capacités.'
                };
            }
            
            // Fonction unifiée pour ajouter l'aide
            function addTooltipToElement(elem, helpData, assistant) {
                if (!elem || !helpData) return;
                
                elem.addEventListener('mouseenter', () => {
                    showAssistant(elem, helpData);
                });
                elem.addEventListener('mouseleave', hideAssistant);
            }
            
            // Fonction pour afficher l'assistant (modifiée)
            function showAssistant(element, helpDataOrKey) {
                // Vérifier si l'assistance est activée
                if (typeof assistanceEnabled !== 'undefined' && !assistanceEnabled) {
                    return; // Ne pas afficher si désactivée
                }
                
                const content = document.getElementById('assistantContent');
                let help;
                
                // Si c'est une string, chercher dans detailedHelp
                if (typeof helpDataOrKey === 'string') {
                    help = detailedHelp[helpDataOrKey];
                } else {
                    help = helpDataOrKey;
                }
                
                if (!help) return;
                
                let html = `
                    <div class="action-title">
                        ${help.title}
                        ${help.locked ? '<span class="locked-badge">🔒 DÉSACTIVÉ EN DÉMO</span>' : ''}
                    </div>
                    <div class="action-description">${help.description}</div>
                `;
                
                if (help.steps && help.steps.length > 0) {
                    html += '<div class="steps-list">';
                    html += '<div class="steps-list-title">📋 Comment l\'utiliser :</div>';
                    help.steps.forEach(step => {
                        html += `<div class="step-item">${step}</div>`;
                    });
                    html += '</div>';
                }
                
                if (help.examples) {
                    html += `<div class="examples">📌 ${help.examples}</div>`;
                }
                
                if (help.tip) {
                    html += `<div class="tip-box"><strong>💡 Astuce :</strong> ${help.tip}</div>`;
                }
                
                content.innerHTML = html;
                assistant.classList.add('show');
                positionAssistant(element);
            }
            
            // Attacher les événements après un délai
            setTimeout(function() {
                // ===== BOUTONS =====
                document.querySelectorAll('button').forEach(btn => {
                    if (btn.dataset.assistantAdded) return;
                    btn.dataset.assistantAdded = 'true';
                    
                    const onclick = btn.getAttribute('onclick');
                    const text = btn.textContent.trim();
                    let helpData = null;
                    
                    // Chercher dans detailedHelp
                    if (onclick) {
                        for (let key in detailedHelp) {
                            if (onclick.includes(key)) {
                                helpData = detailedHelp[key];
                                break;
                            }
                        }
                    }
                    
                    // Sinon créer une aide générique
                    if (!helpData) {
                        helpData = createHelperFromElement(btn);
                    }
                    
                    addTooltipToElement(btn, helpData, assistant);
                });
                
                // ===== SÉLECTEURS =====
                document.querySelectorAll('select').forEach(select => {
                    if (select.dataset.assistantAdded) return;
                    select.dataset.assistantAdded = 'true';
                    
                    const id = select.id || select.name || '';
                    let helpData = detailedHelp['select'];
                    
                    if (id.toLowerCase().includes('week')) {
                        helpData = detailedHelp['weekSelector'] || helpData;
                    } else if (id.toLowerCase().includes('class')) {
                        helpData = detailedHelp['classSelector'] || helpData;
                    }
                    
                    addTooltipToElement(select, helpData, assistant);
                });
                
                // ===== INPUTS DE RECHERCHE =====
                document.querySelectorAll('input[type="text"], input[type="search"]').forEach(input => {
                    if (input.dataset.assistantAdded) return;
                    input.dataset.assistantAdded = 'true';
                    
                    const placeholder = (input.placeholder || '').toLowerCase();
                    const id = (input.id || '').toLowerCase();
                    
                    let helpData = detailedHelp['input'];
                    if (placeholder.includes('recherch') || id.includes('search')) {
                        helpData = detailedHelp['searchInput'] || helpData;
                    }
                    
                    addTooltipToElement(input, helpData, assistant);
                });
                
                // ===== TEXTAREAS =====
                document.querySelectorAll('textarea').forEach(textarea => {
                    if (textarea.dataset.assistantAdded) return;
                    textarea.dataset.assistantAdded = 'true';
                    addTooltipToElement(textarea, detailedHelp['textarea'], assistant);
                });
                
                // ===== CHECKBOXES =====
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.dataset.assistantAdded) return;
                    checkbox.dataset.assistantAdded = 'true';
                    addTooltipToElement(checkbox, detailedHelp['checkbox'], assistant);
                });
                
                // ===== BOUTONS DE FERMETURE =====
                document.querySelectorAll('.close-modal, .close, [onclick*="close"], .close-modal').forEach(closeBtn => {
                    if (closeBtn.dataset.assistantAdded) return;
                    closeBtn.dataset.assistantAdded = 'true';
                    
                    const onclick = closeBtn.getAttribute('onclick') || '';
                    let helpData = null;
                    
                    for (let key in detailedHelp) {
                        if (onclick.includes(key)) {
                            helpData = detailedHelp[key];
                            break;
                        }
                    }
                    
                    if (!helpData) {
                        helpData = detailedHelp['closeModal'];
                    }
                    
                    addTooltipToElement(closeBtn, helpData, assistant);
                });
                
                // ===== LIENS =====
                document.querySelectorAll('a[href]').forEach(link => {
                    if (link.dataset.assistantAdded) return;
                    link.dataset.assistantAdded = 'true';
                    
                    const href = link.getAttribute('href');
                    const text = link.textContent.trim();
                    
                    if (href && !href.startsWith('#')) {
                        const linkHelp = {
                            title: '🔗 ' + (text || 'Lien'),
                            description: 'Lien hypertexte : ' + (text || href),
                            steps: ['Cliquez pour ouvrir dans un nouvel onglet ou fenêtre'],
                            tip: 'Ce lien vous emmène vers : ' + href
                        };
                        addTooltipToElement(link, linkHelp, assistant);
                    }
                });
                
                // ===== OBSERVER POUR ÉLÉMENTS DYNAMIQUES =====
                const observer = new MutationObserver(() => {
                    // Tables du logiciel
                    document.querySelectorAll('.table').forEach(table => {
                        if (!table.dataset.assistantAdded) {
                            table.dataset.assistantAdded = 'true';
                            addTooltipToElement(table, detailedHelp['table'], assistant);
                        }
                    });
                    
                    // Élèves dans le plan
                    document.querySelectorAll('.student').forEach(student => {
                        if (!student.dataset.assistantAdded) {
                            student.dataset.assistantAdded = 'true';
                            const isInPlan = student.closest('.table');
                            const helpKey = isInPlan ? 'studentInPlan' : 'student';
                            addTooltipToElement(student, detailedHelp[helpKey], assistant);
                        }
                    });
                    
                    // Élèves dans la sidebar
                    document.querySelectorAll('#student-list .student-item, .sidebar .student-item, .student-list-item').forEach(student => {
                        if (!student.dataset.assistantAdded) {
                            student.dataset.assistantAdded = 'true';
                            
                            const studentName = student.textContent.trim();
                            const sidebarHelp = {
                                title: '👤 ' + studentName,
                                description: 'Élève disponible dans la liste. Cliquez ou glissez pour le placer.',
                                steps: [
                                    'Clic simple : ouvre sa fiche complète avec historique',
                                    'Glisser-déposer : placez-le directement sur une table',
                                    'Double-clic : placement automatique sur première place libre'
                                ],
                                tip: '💡 La couleur indique son statut. Gris = jamais placé, Coloré = placé dans d\'autres semaines.'
                            };
                            addTooltipToElement(student, sidebarHelp, assistant);
                        }
                    });
                    
                    // TOUS les éléments avec onclick qui n'ont pas encore d'aide
                    document.querySelectorAll('[onclick]').forEach(elem => {
                        if (!elem.dataset.assistantAdded && elem.tagName !== 'BUTTON') {
                            elem.dataset.assistantAdded = 'true';
                            const onclick = elem.getAttribute('onclick');
                            let helpData = null;
                            
                            for (let key in detailedHelp) {
                                if (onclick.includes(key)) {
                                    helpData = detailedHelp[key];
                                    break;
                                }
                            }
                            
                            if (!helpData) {
                                helpData = createHelperFromElement(elem);
                            }
                            
                            addTooltipToElement(elem, helpData, assistant);
                        }
                    });
                });
                
                observer.observe(document.body, { childList: true, subtree: true });
                
                // ===== CRÉNEAUX HORAIRES RDV (vérification périodique) =====
                setInterval(() => {
                    // Vue semaine RDV - créneaux horaires
                    document.querySelectorAll('#rdvGrid td[onclick*="openRdvFormAtTime"], #rdvGrid td[onclick*="Time"]').forEach(cell => {
                        if (!cell.dataset.assistantAdded) {
                            cell.dataset.assistantAdded = 'true';
                            addTooltipToElement(cell, detailedHelp['rdv-timeslot'], assistant);
                        }
                    });
                    
                    // Vue mois RDV - cellules journalières
                    document.querySelectorAll('#rdvGrid td[onclick*="openRdvFormAtDate"], #rdvGrid td[onclick*="Date"]').forEach(cell => {
                        if (!cell.dataset.assistantAdded) {
                            cell.dataset.assistantAdded = 'true';
                            addTooltipToElement(cell, detailedHelp['rdv-day-cell'], assistant);
                        }
                    });
                    
                    // Tous les autres éléments cliquables dans RDV
                    document.querySelectorAll('#rdvArea [onclick], #rdvGrid [onclick]').forEach(elem => {
                        if (!elem.dataset.assistantAdded) {
                            elem.dataset.assistantAdded = 'true';
                            const onclick = elem.getAttribute('onclick');
                            let helpData = null;
                            
                            for (let key in detailedHelp) {
                                if (onclick.includes(key)) {
                                    helpData = detailedHelp[key];
                                    break;
                                }
                            }
                            
                            if (!helpData) {
                                helpData = createHelperFromElement(elem);
                            }
                            
                            addTooltipToElement(elem, helpData, assistant);
                        }
                    });
                    
                    // ===== FICHE ÉLÈVE - ASSISTANCE COMPLÈTE =====
                    const sheetModal = document.getElementById('studentSheetModal');
                    if (sheetModal && sheetModal.style.display !== 'none') {
                        
                        // En-tête - Nom cliquable
                        const headerName = sheetModal.querySelector('#sheet-header-name');
                        if (headerName && !headerName.dataset.assistantAdded) {
                            headerName.dataset.assistantAdded = 'true';
                            addTooltipToElement(headerName, detailedHelp['sheetHeaderName'], assistant);
                        }
                        
                        // Bouton couleur
                        const colorBtn = sheetModal.querySelector('#sheet-color-btn');
                        if (colorBtn && !colorBtn.dataset.assistantAdded) {
                            colorBtn.dataset.assistantAdded = 'true';
                            addTooltipToElement(colorBtn, detailedHelp['sheetColorButton'], assistant);
                        }
                        
                        // Champs de saisie avec aide spécifique
                        const fieldMappings = {
                            'sheet-nom': 'sheetNomField',
                            'sheet-prenom': 'sheetPrenomField',
                            'sheet-dob': 'sheetDobField',
                            'sheet-sexe': 'sheetSexeField',
                            'sheet-classe': 'sheetClasseField',
                            'sheet-groupes': 'sheetGroupesField',
                            'sheet-options': 'sheetOptionsField',
                            'sheet-projet': 'sheetProjetField',
                            'sheet-allergies': 'sheetAllergiesField',
                            'sheet-engagement': 'sheetEngagementField',
                            'sheet-redoublant': 'sheetRedoublantField',
                            'sheet-majeur': 'sheetMajeurField',
                            'sheet-week-status': 'sheetWeekStatusSelect',
                            'sheet-week-notes': 'sheetWeekNotes',
                            'sheet-week-font': 'sheetFontSelect'
                        };
                        
                        for (let fieldId in fieldMappings) {
                            const field = sheetModal.querySelector('#' + fieldId);
                            if (field && !field.dataset.assistantAdded) {
                                field.dataset.assistantAdded = 'true';
                                const helpKey = fieldMappings[fieldId];
                                if (detailedHelp[helpKey]) {
                                    addTooltipToElement(field, detailedHelp[helpKey], assistant);
                                }
                            }
                        }
                        
                        // Sections avec titres
                        sheetModal.querySelectorAll('.sheet-section').forEach(section => {
                            if (!section.dataset.assistantAdded) {
                                section.dataset.assistantAdded = 'true';
                                const h3 = section.querySelector('h3');
                                if (h3) {
                                    const title = h3.textContent.toLowerCase();
                                    let helpKey = null;
                                    if (title.includes('base') || title.includes('information')) helpKey = 'sheetStudentInfo';
                                    else if (title.includes('rdv') || title.includes('rendez')) helpKey = 'sheetRdvSection';
                                    else if (title.includes('semaine') || title.includes('suivi')) helpKey = 'sheetWeeksSection';
                                    
                                    if (helpKey && detailedHelp[helpKey]) {
                                        addTooltipToElement(h3, detailedHelp[helpKey], assistant);
                                    }
                                }
                            }
                        });
                        
                        // Calendrier des semaines
                        const weeksCalendar = sheetModal.querySelector('#sheet-weeks-calendar');
                        if (weeksCalendar) {
                            weeksCalendar.querySelectorAll('button').forEach(weekBtn => {
                                if (!weekBtn.dataset.assistantAdded) {
                                    weekBtn.dataset.assistantAdded = 'true';
                                    addTooltipToElement(weekBtn, detailedHelp['sheetWeekButton'], assistant);
                                }
                            });
                        }
                        
                        // Couleurs hebdomadaires (radios)
                        sheetModal.querySelectorAll('.sheet-week-color').forEach(radio => {
                            if (!radio.dataset.assistantAdded) {
                                radio.dataset.assistantAdded = 'true';
                                const label = radio.closest('label');
                                if (label) {
                                    addTooltipToElement(label, detailedHelp['sheetWeekColorRadio'], assistant);
                                }
                            }
                        });
                        
                        // Sélecteur mots fréquents
                        sheetModal.querySelectorAll('select[onchange*="insertFrequentWord"]').forEach(sel => {
                            if (!sel.dataset.assistantAdded) {
                                sel.dataset.assistantAdded = 'true';
                                addTooltipToElement(sel, detailedHelp['sheetFrequentWords'], assistant);
                            }
                        });
                        
                        // Bouton format
                        sheetModal.querySelectorAll('button[onclick*="toggleFormatOptions"]').forEach(btn => {
                            if (!btn.dataset.assistantAdded) {
                                btn.dataset.assistantAdded = 'true';
                                addTooltipToElement(btn, detailedHelp['sheetFormatButton'], assistant);
                            }
                        });
                        
                        // Bouton synchro
                        sheetModal.querySelectorAll('button[onclick*="synchronizeAllData"]').forEach(btn => {
                            if (!btn.dataset.assistantAdded) {
                                btn.dataset.assistantAdded = 'true';
                                addTooltipToElement(btn, detailedHelp['sheetSyncButton'], assistant);
                            }
                        });
                        
                        // Liste RDV
                        const rdvList = sheetModal.querySelector('#sheet-rdv-list');
                        if (rdvList && !rdvList.dataset.assistantAdded) {
                            rdvList.dataset.assistantAdded = 'true';
                            addTooltipToElement(rdvList, detailedHelp['sheetRdvList'], assistant);
                        }
                        
                        // Rubriques personnalisées
                        sheetModal.querySelectorAll('.rubric-name, .rubric-content').forEach(rubric => {
                            if (!rubric.dataset.assistantAdded) {
                                rubric.dataset.assistantAdded = 'true';
                                addTooltipToElement(rubric, detailedHelp['sheetCustomRubric'], assistant);
                            }
                        });
                        
                        // Boutons du pied de page
                        const footerButtonMappings = {
                            'addNewRubricToSheet': 'addNewRubricToSheet',
                            'printStudentWeekFromModal': 'printStudentWeekFromModal',
                            'printStudentReportFromModal': 'printStudentReportFromModal',
                            'deleteStudentFromClass': 'deleteStudentFromClass',
                            'openRdvForStudent': 'openRdvForStudent',
                            'readAllStudentInfo': 'readAllStudentInfo',
                            'closeStudentSheetModal': 'closeStudentSheetModal',
                            'saveStudentSheetAndBackup': 'saveStudentSheetAndBackup',
                            'printStudentAnnualSummaryFromSheet': 'sheetSynthesisButton',
                            'openSearchHub': 'sheetSearchButton'
                        };
                        
                        sheetModal.querySelectorAll('button[onclick]').forEach(btn => {
                            if (!btn.dataset.assistantAdded) {
                                btn.dataset.assistantAdded = 'true';
                                const onclick = btn.getAttribute('onclick') || '';
                                let helpData = null;
                                
                                for (let funcName in footerButtonMappings) {
                                    if (onclick.includes(funcName)) {
                                        helpData = detailedHelp[footerButtonMappings[funcName]];
                                        break;
                                    }
                                }
                                
                                if (!helpData) {
                                    // Chercher dans detailedHelp par nom de fonction
                                    for (let key in detailedHelp) {
                                        if (onclick.includes(key)) {
                                            helpData = detailedHelp[key];
                                            break;
                                        }
                                    }
                                }
                                
                                if (!helpData) {
                                    helpData = createHelperFromElement(btn);
                                }
                                
                                addTooltipToElement(btn, helpData, assistant);
                            }
                        });
                    }
                }, 2000);
                
            }, 1500);
        }
    </script>
    <style id="main-style">
        :root {
            --primary-color: #00f2ff;
            /* Neon Cyan */
            --primary-hover: #00c8d4;
            --accent-color: #ff0055;
            /* Neon Pink */
            --bg-color: #121212;
            /* Very Dark Grey */
            --grid-line: rgba(0, 242, 255, 0.15);
            --text-color: #e0e0e0;
            --panel-bg: rgba(30, 30, 30, 0.85);
            --panel-border: 1px solid rgba(0, 242, 255, 0.3);

            /* Table Colors */
            --table-color-1: #ffadad;
            --table-color-2: #ffd6a5;
            --table-color-3: #fdffb6;
            --table-color-4: #caffbf;
            --table-color-5: #9bf6ff;
            --table-color-6: #a0c4ff;
            --table-color-7: #bdb2ff;
            --table-color-8: #ffc6ff;

            --student-bg: #ffffff;
            --student-text: #000000;
            --shadow: 0 4px 15px rgba(0, 242, 255, 0.1);

            /* Dynamic Table Size */
            --table-width: 180px;
            --table-height: 80px;

            /* Status Colors */
            --status-red: #ff0000;
            --status-orange: #ff8800;
            --status-yellow: #ffdd00;
            --status-lightgreen: #90ee90;
            --status-darkgreen: #006400;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-color);
            margin: 0;
            padding: 5px;
            /* Reduced from 20px */
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 5px;
            /* Reduced from 15px */
            margin-bottom: 5px;
            /* Reduced from 20px */
            padding: 5px 10px;
            /* Reduced from 15px 20px */
            background: var(--panel-bg);
            border: var(--panel-border);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            /* Reduced from 1.8rem */
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        .class-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .info-input {
            padding: 4px 8px;
            /* Reduced from 8px 12px */
            border: 1px solid #444;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border-radius: 5px;
            font-size: 0.9rem;
            /* Reduced from 1rem */
            width: 200px;
        }

        /* ... Select styling skipped ... */

        .controls {
            display: flex;
            gap: 5px;
            /* Reduced from 10px */
            align-items: center;
            flex-wrap: wrap;
        }

        /* ... Button styles skipped ... */

        /* CALENDAR STYLES */
        .calendar-wrapper {
            background: var(--panel-bg);
            border: var(--panel-border);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            margin-bottom: 5px;
            /* Reduced from 20px */
            padding: 5px;
            /* Reduced from 10px */
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .calendar-months {
            display: flex;
            margin-bottom: 0;
            padding-left: 0;
            width: 100%;
        }

        .calendar-strip {
            display: flex;
            gap: 0;
            width: 100%;
            border-top: 1px solid #111;
        }

        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #444;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background-color: #333;
            border-left: 3px solid var(--primary-color);
        }

        /* ... */

        .week-btn {
            flex: 1;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #004d80;
            color: #fff;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #111;
            box-sizing: border-box;
            transition: all 0.2s;
            user-select: none;
        }

        /* Alternate colors like in the image */
        .week-btn:nth-child(even):not(.holiday) {
            background-color: #7b7021;
        }

        .week-btn.holiday {
            background-color: #888;
            color: #400;
        }

        .info-input::placeholder {
            color: #aaa;
        }

        /* Select styling */
        select.info-input {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300f2ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            padding-right: 2.5em;
        }

        select.info-input option {
            background-color: #333;
            color: white;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        button,
        input[type="file"]::file-selector-button,
        .toggle-btn {
            padding: 7.75px 15.5px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.872rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover,
        input[type="file"]::file-selector-button:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 0 15px var(--primary-color);
        }

        input[type="file"] {
            display: none;
        }

        .btn-secondary {
            background-color: #444;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #555;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .btn-mode {
            background-color: #00ff88;
            color: black;
        }

        .btn-mode.active {
            background-color: #00cc6a;
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2), 0 0 15px #00ff88;
        }

        .btn-magnet {
            background-color: #b0b0b0;
            color: #333;
        }

        .btn-magnet.active {
            background-color: #ffcc00;
            /* Gold/Yellow for Magnet ON */
            color: black;
            box-shadow: 0 0 15px #ffcc00;
        }

        .btn-add {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-add:hover {
            background-color: #d60047;
            box-shadow: 0 0 15px var(--accent-color);
        }

        .btn-reset {
            background-color: #ff3333;
            color: white;
        }

        .btn-reset:hover {
            background-color: #cc0000;
            box-shadow: 0 0 15px #ff3333;
        }

        .btn-auto {
            background-color: #9d00ff;
            color: white;
        }

        .btn-auto:hover {
            background-color: #7a00cc;
            box-shadow: 0 0 15px #9d00ff;
        }

        .main-container {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden;
        }

        /* Sidebar for Students */
        .student-pool {
            width: 320px;
            /* Increased default */
            min-width: 200px;
            max-width: 600px;
            background: var(--panel-bg);
            border: var(--panel-border);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
            /* for resizer */
        }

        .student-pool-resizer {
            position: absolute;
            right: 0;
            top: 0;
            width: 10px;
            height: 100%;
            cursor: col-resize;
            background: rgba(255, 255, 255, 0.05);
            z-index: 100;
        }

        .student-pool-resizer:hover {
            background: var(--primary-color);
        }

        .student-pool h2 {
            font-size: 1.1rem;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 10px;
            color: var(--primary-color);
        }

        .student-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 100px;
            overflow-y: auto;
            flex: 1;
            /* Take remaining height */
        }

        /* Sidebar Tabs */
        .sidebar-tabs {
            display: flex;
            background: #222;
            border-radius: 5px;
            padding: 2px;
            gap: 2px;
            margin-bottom: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 6px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: black;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .file-list-panel {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.2);
        }

        .file-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            color: #ddd;
            font-size: 0.9rem;
            transition: background 0.1s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Space button to right */
        }

        .file-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .file-item .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-delete-file {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 1.1rem;
            border-radius: 4px;
            transition: color 0.2s, background 0.2s;
        }

        .btn-delete-file:hover {
            color: #ff4444;
            background: rgba(255, 0, 0, 0.1);
        }

        .file-item.selected {
            background-color: rgba(0, 242, 255, 0.2);
            border-left: 3px solid var(--primary-color);
            color: white;
        }

        /* Classroom Layout */
        .classroom {
            flex: 1;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 40px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: auto;
            align-items: center;
            transform-origin: top center;
        }

        /* TEACHER DESK */
        .teacher-desk {
            width: 182px;
            /* Reduced by 30% from 260px */
            height: 77px;
            /* Reduced by 30% from 110px */
            background-color: #333;
            color: white;
            border: 2px solid #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 20px 20px 8px 8px;
            /* Slightly reduced radius */
            margin-bottom: 120px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
            align-self: flex-end;
            margin-right: 10%;
            position: relative;
            z-index: 10;
            cursor: default;
        }

        .teacher-desk::before {
            content: '';
            position: absolute;
            top: -14px;
            /* Reduced by 30% from -20px */
            width: 56px;
            /* Reduced by 30% from 80px */
            height: 18px;
            /* Reduced by 30% from 25px (approx) */
            background-color: #444;
            border: 1px solid #555;
            border-radius: 4px;
            z-index: -1;
        }

        /* Input inside Teacher Desk */
        .teacher-name-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 1rem;
            /* Reduced from 1.2rem */
            font-weight: bold;
            text-align: center;
            width: 90%;
            outline: none;
            font-family: inherit;
        }

        .teacher-name-input::placeholder {
            color: #888;
            font-weight: normal;
        }

        .layout-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
            align-items: center;
            padding-bottom: 40px;
        }

        .classroom-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            /* Reduced gap for 4 columns */
        }

        /* Table Styling */
        .table {
            width: var(--table-width);
            height: var(--table-height);
            border-radius: 10px;
            display: flex;
            flex-direction: row;
            padding: 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            box-sizing: border-box;
            overflow: visible;
            border: 2px solid #000;
            transition: box-shadow 0.3s, transform 0.3s, width 0.3s, height 0.3s;
            background-color: #f0f0f0;
        }

        .table.draggable-mode {
            cursor: move;
            z-index: 100;
            border-color: var(--primary-color);
        }

        .table.draggable-mode:hover {
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
        }

        /* Selection Style */
        .table.selected {
            border: 3px solid #ffcc00 !important;
            /* Gold border */
            box-shadow: 0 0 25px rgba(255, 204, 0, 0.6) !important;
            z-index: 150;
        }

        /* Table Controls */
        .table-controls {
            position: absolute;
            top: -35px;
            right: 0;
            display: none;
            gap: 5px;
            z-index: 200;
            background: rgba(0, 0, 0, 0.8);
            padding: 4px;
            border-radius: 20px;
            border: 1px solid var(--primary-color);
        }

        .table.draggable-mode .table-controls {
            display: flex;
        }

        .control-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            font-weight: bold;
        }

        .btn-delete {
            background-color: #ff0055;
        }

        .btn-rotate-left,
        .btn-rotate-right {
            background-color: var(--primary-color);
            color: black;
        }

        /* Colors */
        .table:nth-child(8n+1) {
            background-color: var(--table-color-1);
        }

        .table:nth-child(8n+2) {
            background-color: var(--table-color-2);
        }

        .table:nth-child(8n+3) {
            background-color: var(--table-color-3);
        }

        .table:nth-child(8n+4) {
            background-color: var(--table-color-4);
        }

        .table:nth-child(8n+5) {
            background-color: var(--table-color-5);
        }

        .table:nth-child(8n+6) {
            background-color: var(--table-color-6);
        }

        .table:nth-child(8n+7) {
            background-color: var(--table-color-7);
        }

        .table:nth-child(8n+8) {
            background-color: var(--table-color-8);
        }

        .student-slot {
            flex: 1;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            position: relative;
            padding: 4px;
            overflow: hidden;
        }

        .student-slot:first-child {
            border-right: 2px solid black;
        }

        .student-slot.drag-over {
            background-color: rgba(0, 255, 0, 0.3);
        }

        /* Draggable Student */
        .student-card {
            background-color: var(--student-bg);
            color: var(--student-text);
            border: 1px solid #999;
            border-radius: 4px;
            cursor: grab;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
            user-select: none;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            word-break: break-word;
            line-height: 1.1;
            padding: 2px;
            transition: all 0.2s;
            position: relative;
        }

        .student-card:active {
            cursor: grabbing;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        /* Color indicator for students */
        /* Color indicator button is only shown inside student sheet now. */

        /* Adaptive student name sizing to fit table slot */
        .student-card .student-name {
            display: block;
            width: 100%;
            text-align: center;
            font-size: clamp(10px, 1.8vw, 14px);
            line-height: 1.0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 2px 6px;
        }

        /* Absent Student Style */
        .student-card.absent {
            background-color: #888 !important;
            color: #ccc !important;
            border-color: #666 !important;
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* Status indicator */
        .student-status {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #333;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
        }

        .student-status:hover {
            transform: scale(1.2);
        }

        .student-status.status-none {
            background-color: #ccc;
            border-color: #999;
        }

        .student-status.status-red {
            background-color: var(--status-red);
            box-shadow: 0 0 8px var(--status-red);
        }

        .student-status.status-orange {
            background-color: var(--status-orange);
            box-shadow: 0 0 8px var(--status-orange);
        }

        .student-status.status-yellow {
            background-color: var(--status-yellow);
            box-shadow: 0 0 8px var(--status-yellow);
        }

        .student-status.status-lightgreen {
            background-color: var(--status-lightgreen);
            box-shadow: 0 0 8px var(--status-lightgreen);
        }

        .student-status.status-darkgreen {
            background-color: var(--status-darkgreen);
            box-shadow: 0 0 8px var(--status-darkgreen);
        }

        .student-name {
            padding-right: 18px;
        }

        .student-last {
            display: block;
            font-weight: 700;
            line-height: 1;
        }

        .student-first {
            display: block;
            font-size: 0.85em;
            opacity: 0.95;
            line-height: 1;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 30000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #1a1a1a;
            padding: 25px;
            border: 2px solid var(--primary-color);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            color: white;
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.4);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close-modal:hover {
            color: white;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: bold;
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        /* Print Styles */
        @media print {

            html,
            body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
                background-color: white !important;
                background-image: none !important;
                color: black !important;
            }

            header,
            .student-pool,
            .modal {
                display: none !important;
            }

            .main-container {
                display: block;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            .classroom {
                background: white !important;
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                overflow: visible;
                display: block;
                width: 100%;
                height: 100%;
            }

            .teacher-desk {
                margin-right: 0;
                float: right;
                background-color: #eee !important;
                color: black !important;
                border: 2px solid black !important;
                box-shadow: none !important;
            }

            /* Hide Desk if requested */
            body.print-hide-desk .teacher-desk {
                display: none !important;
            }

            .teacher-desk::before {
                background-color: #ddd !important;
                border-color: #999 !important;
            }

            .teacher-name-input {
                color: black !important;
            }

            .layout-grid {
                clear: both;
                padding-top: 20px;
            }

            .table {
                border: 2px solid black !important;
                box-shadow: none !important;
                page-break-inside: avoid;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .table-controls {
                display: none !important;
            }

            .student-card {
                border: none;
                box-shadow: none;
                background: transparent;
                font-weight: bold;
                color: black !important;
            }

            /* Print style for absent students */
            .student-card.absent {
                color: #aaa !important;
                text-decoration: line-through;
                background-color: transparent !important;
            }

            /* Hide Names if requested */
            body.print-hide-names .student-card {
                color: transparent !important;
                text-decoration: none !important;
            }

            .print-info {
                display: block !important;
                margin-bottom: 20px;
                font-size: 1.5rem;
                font-weight: bold;
                text-align: center;
                width: 100%;
                color: black !important;
            }
        }

        .print-info {
            display: none;
        }

        /* CALENDAR STYLES */
        .calendar-wrapper {
            background: var(--panel-bg);
            border: var(--panel-border);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            margin-bottom: 5px;
            /* Reduced from 20px */
            padding: 5px;
            /* Reduced from 10px */
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .calendar-months {
            display: flex;
            margin-bottom: 2px;
            /* Reduced from 5px */
            padding-left: 0;
        }

        .month-label {
            font-size: 0.75rem;
            color: #eee;
            border-left: 1px solid #777;
            padding-left: 4px;
            background: #555;
            height: 18px;
            display: flex;
            align-items: center;
            box-sizing: border-box;
            overflow: hidden;
            white-space: nowrap;
        }

        .calendar-strip {
            display: flex;
            gap: 2px;
            padding-left: 0;
            min-width: max-content;
        }

        .week-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #004d55;
            /* Dark Cyan */
            color: #fff;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #006d77;
            border-radius: 3px;
            transition: all 0.2s;
            user-select: none;
        }

        .week-btn:hover {
            background-color: var(--primary-color);
            color: black;
        }

        .week-btn.active {
            background-color: var(--primary-color);
            color: black;
            box-shadow: 0 0 10px var(--primary-color);
            border-color: #fff;
            transform: scale(1.1);
            z-index: 5;
        }

        .week-btn.holiday {
            background-color: #555;
            color: #aaa;
            border-color: #444;
        }

        .week-btn.holiday.active {
            background-color: #888;
            color: white;
        }

        .week-btn.batch-selected {
            border: 2px solid var(--primary-color) !important;
            box-shadow: inset 0 0 10px rgba(0, 242, 255, 0.5);
            background-color: rgba(0, 242, 255, 0.2);
        }

        /* Student sheet modal: better layout, focus and input sizing */
        #studentSheetModal * {
            box-sizing: border-box;
        }

        #studentSheetModal input,
        #studentSheetModal textarea,
        #studentSheetModal select {
            font-size: 1rem !important;
            color: #fff !important;
        }

        #studentSheetModal input:focus,
        #studentSheetModal textarea:focus,
        #studentSheetModal select:focus {
            outline: none !important;
            border: 2px solid #002244 !important;
            /* dark blue frame */
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.65) !important;
            /* bright white highlight */
            background-color: #1f1f2a !important;
        }

        #studentSheetModal #sheet-weeks-calendar {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)) !important;
            gap: 8px !important;
        }

        #studentSheetModal #sheet-weeks-calendar button {
            padding: 8px !important;
            font-size: 0.95rem !important;
            min-width: 48px !important;
            border-radius: 6px !important;
            background: #222 !important;
            color: #fff !important;
            border: 1px solid #333 !important;
            transition: transform 0.12s ease !important;
        }

        #studentSheetModal #sheet-weeks-calendar button:hover {
            transform: translateY(-2px) !important;
        }

        /* Sections inside the sheet: avoid overlap and provide focus highlight */
        #studentSheetModal .sheet-section {
            position: relative !important;
            z-index: 1 !important;
            margin-bottom: 22px !important;
        }

        #studentSheetModal .sheet-section:focus-within {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.5) !important;
            border-left-color: #002244 !important;
        }

        /* SECURITY OVERLAY */
        #securityOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .login-box {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            text-align: center;
            width: 320px;
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #222;
            color: white;
            font-size: 1rem;
            text-align: center;
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-box button:hover {
            transform: scale(1.02);
        }
    </style>
    <style id="page-style"></style>
</head>

<body>

    <!-- Security Overlay - DÉSACTIVÉ -->
    <div id="securityOverlay" style="display:none;">
        <div class="login-box">
            <h2>Accès Sécurisé</h2>
            <input type="password" id="passInput" placeholder="Mot de passe"
                onkeydown="if(event.key==='Enter') checkPass()">
            <button onclick="checkPass()">Entrer</button>
            <p id="passError" style="color:#ff6666; margin-top:10px; font-size:0.85rem; display:none;">Mot de passe
                incorrect</p>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- MODULE IMPORT INTEGRÉ -->
    <!-- ============================================ -->
    <div id="import-module" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; overflow-y:auto;">
        <div class="import-container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
            <div class="import-header" style="background: #222; padding: 25px; border-radius: 10px; border: 2px solid #FFA500; margin-bottom: 30px; text-align: center; position: relative;">
                <h1 style="color: #FFA500; font-size: 2.5rem; margin-bottom: 10px;">📋 Import - Créateur de fichier établissement</h1>
                <p style="color: #aaa; font-size: 1.1rem;">Créez et gérez facilement vos fichiers d'importation pour LOGECPE</p>
                <button onclick="document.getElementById('import-module').style.display='none';" style="position:absolute; top:25px; right:25px; background:#f44336; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:1rem;">✖ Fermer</button>
            </div>

            <div class="import-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; text-align: center;">
                    <div id="import-total-students" style="font-size: 2.5rem; color: #FFA500; font-weight: bold;">0</div>
                    <div style="color: #aaa; margin-top: 5px;">Élèves</div>
                </div>
                <div style="background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; text-align: center;">
                    <div id="import-total-classes" style="font-size: 2.5rem; color: #FFA500; font-weight: bold;">0</div>
                    <div style="color: #aaa; margin-top: 5px;">Classes</div>
                </div>
                <div style="background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; text-align: center;">
                    <div id="import-last-saved" style="font-size: 2.5rem; color: #FFA500; font-weight: bold;">-</div>
                    <div style="color: #aaa; margin-top: 5px;">Dernière sauvegarde</div>
                </div>
            </div>

            <div class="import-toolbar" style="background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <button class="btn btn-primary" onclick="importOpenAddStudentModal()" style="padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; background: #FFA500; color: #000;">
                    ➕ Ajouter un élève
                </button>
                <button class="btn btn-success" onclick="importExportAndLoadToLOGECPE()" style="padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; background: #4CAF50; color: #fff;">
                    💾 Charger dans LOGECPE
                </button>
                <button class="btn btn-info" onclick="importFromCSVFile()" style="padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; background: #2196F3; color: #fff;">
                    📂 Importer CSV/XLSX
                </button>
                <button class="btn btn-warning" onclick="importFromClipboardRPP()" style="padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; background: #FF9800; color: #fff;">
                    📋 RPP
                </button>
                <button class="btn btn-secondary" onclick="importGenerateSample()" style="padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; background: #607D8B; color: #fff;">
                    🎲 Exemple de données
                </button>
                <button class="btn btn-danger" onclick="importClearAllData()" style="padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem; background: #f44336; color: #fff;">
                    🗑️ Tout effacer
                </button>
                <div style="flex: 1; min-width: 300px;">
                    <input type="text" id="import-search-input" placeholder="🔍 Rechercher un élève..." oninput="importFilterStudents()" style="width: 100%; padding: 12px 15px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                </div>
            </div>

            <div class="import-table-container" style="background: #222; border-radius: 10px; border: 1px solid #444; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                    <thead style="background: rgba(255, 165, 0, 0.2); position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 8%;">Nom</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 8%;">Prénom</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 7%;">Né(e) le</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 5%;">Sexe</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 6%;">Classe</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 10%;">Groupes</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 12%;">Options</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 10%;">Projet</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 8%;">Allergie</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 8%;">Engagement</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 6%;">Redoub.</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 5%;">Majeur</th>
                            <th style="padding: 15px 8px; text-align: left; color: #FFA500; font-weight: bold; border-bottom: 2px solid #FFA500; width: 7%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="import-students-table">
                        <tr style="text-align: center; padding: 60px 20px; color: #aaa;">
                            <td colspan="13" style="padding: 60px 20px;">
                                <h3 style="font-size: 1.5rem; margin-bottom: 10px;">Aucun élève</h3>
                                <p>Commencez par ajouter un élève ou importez un fichier CSV</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal Ajouter/Éditer élève dans le module import -->
        <div id="import-student-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:11000; justify-content:center; align-items:center;">
            <div style="background: #222; padding: 30px; border-radius: 10px; border: 2px solid #FFA500; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <h2 id="import-modal-title" style="color: #FFA500; margin-bottom: 20px;">Ajouter un élève</h2>
                <form id="import-student-form" onsubmit="importSaveStudent(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Nom *</label>
                        <input type="text" id="import-student-nom" required style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Prénom *</label>
                        <input type="text" id="import-student-prenom" required style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Né(e) le</label>
                        <input type="text" id="import-student-dob" placeholder="JJ/MM/AAAA" style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Sexe</label>
                        <select id="import-student-sexe" style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                            <option value="">-</option>
                            <option value="M">M</option>
                            <option value="F">F</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Classe *</label>
                        <input type="text" id="import-student-classe" placeholder="Ex: 2GT1, 1ES2, TG3..." required style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Groupes</label>
                        <input type="text" id="import-student-groupes" placeholder="Ex: Anglais LVA, Maths" style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Toutes les options</label>
                        <input type="text" id="import-student-options" placeholder="Ex: Latin, Théâtre..." style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Projet accompagnement</label>
                        <input type="text" id="import-student-projet" placeholder="Ex: PPRE, PAP..." style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Allergie PAI</label>
                        <input type="text" id="import-student-allergie" placeholder="Ex: Arachide, Lactose..." style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Engagement</label>
                        <input type="text" id="import-student-engagement" placeholder="Ex: Délégué, Éco-délégué..." style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Redoublant</label>
                        <select id="import-student-redoublant" style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                            <option value="">-</option>
                            <option value="Oui">Oui</option>
                            <option value="Non">Non</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #aaa; font-weight: bold;">Majeur</label>
                        <select id="import-student-majeur" style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9rem;">
                            <option value="">-</option>
                            <option value="Oui">Oui</option>
                            <option value="Non">Non</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" style="flex: 1; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #FFA500; color: #000;">
                            💾 Enregistrer
                        </button>
                        <button type="button" onclick="document.getElementById('import-student-modal').style.display='none';" style="flex: 1; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: #607D8B; color: #fff;">
                            ✖ Annuler
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <input type="file" id="import-csv-file-input" accept=".csv,.xlsx,.xls" style="display:none" onchange="importHandleFileImport(event)">
    </div>

    <div class="print-info" id="printInfo"></div>

    <!-- Print Settings Modal -->
    <div id="printModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closePrintModal()">×</span>
            <h2 style="margin-top:0; color:var(--primary-color);">Impression</h2>

            <div class="setting-group">
                <label>Orientation</label>
                <div class="setting-row">
                    <input type="radio" name="p-orient" id="orient-p" value="portrait" checked="">
                    <label for="orient-p" style="margin:0; color:white; font-weight:normal;">Portrait</label>

                    <input type="radio" name="p-orient" id="orient-l" value="landscape" style="margin-left:15px;">
                    <label for="orient-l" style="margin:0; color:white; font-weight:normal;">Paysage</label>
                </div>




            </div>
        </body>
    </html>
        </body>
    </html>
        </body>
    </html>
        </body>
    </html>

            <div class="setting-group">
                <label>Echelle (Zoom)</label>
                <div class="setting-row">
                    <input type="checkbox" id="p-auto-scale" checked="" onchange="toggleScaleInput()">
                    <label for="p-auto-scale" style="margin:0; color:white; font-weight:normal;">Ajuster auto.</label>
                </div>
                <div class="setting-row">
                    <input type="range" id="p-scale" min="50" max="150" value="100" disabled=""
                        oninput="document.getElementById('p-scale-val').textContent = this.value + '%'">
                    <span id="p-scale-val">100%</span>
                </div>
            </div>

            <div class="setting-group">
                <label>Options</label>
                <div class="setting-row">
                    <input type="checkbox" id="p-hide-desk">
                    <label for="p-hide-desk" style="margin:0; color:white; font-weight:normal;">Masquer Bureau
                        Prof</label>
                </div>
                <div class="setting-row">
                    <input type="checkbox" id="p-hide-names">
                    <label for="p-hide-names" style="margin:0; color:white; font-weight:normal;">Masquer Noms
                        (Anonyme)</label>
                </div>
            </div>

            <button onclick="confirmPrint()" style="width:100%; padding:12px; margin-top:10px;">Lancer
                l'Impression</button>
        </div>
    </div>

    <!-- Annual Summary Modal -->
    <div id="annualSummaryModal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <span class="close-modal"
                onclick="document.getElementById('annualSummaryModal').style.display='none'">×</span>
            <h2 style="color:var(--primary-color); margin-top:0;">Synthèse Annuelle</h2>

            <div id="summary-options-main">
                <button onclick="printAnnualSummary({type: 'all'})"
                    style="width:100%; margin-bottom:10px; padding:15px; background:#333; color:white; border:1px solid #555; cursor:pointer; text-align:left; font-size:1rem;">📑
                    Toutes les fiches (Tout l'établissement)</button>
                <button onclick="showSummaryClassSelection()"
                    style="width:100%; margin-bottom:10px; padding:15px; background:#333; color:white; border:1px solid #555; cursor:pointer; text-align:left; font-size:1rem;">🏫
                    Toutes les fiches d'une Classe</button>
                <button onclick="showSummaryStudentSearch()"
                    style="width:100%; margin-bottom:10px; padding:15px; background:#333; color:white; border:1px solid #555; cursor:pointer; text-align:left; font-size:1rem;">👤
                    Recherche Élève Unique</button>
            </div>

            <div id="summary-options-class" style="display:none;">
                <h3 style="margin-top:0;">Choisir une classe</h3>
                <select id="summary-class-select"
                    style="width:100%; padding:10px; margin-bottom:15px; background:#222; color:white; border:1px solid #555; font-size:1rem;">
                    <!-- Options populated by JS -->
                </select>
                <div style="display:flex; gap:10px;">
                    <button onclick="confirmSummaryClass()"
                        style="flex:1; background:var(--primary-color); color:black; padding:10px; border:none; font-weight:bold; cursor:pointer;">Valider</button>
                    <button onclick="resetSummaryModal()"
                        style="flex:1; background:#555; color:white; padding:10px; border:none; cursor:pointer;">Retour</button>
                </div>
            </div>

            <div id="summary-options-student" style="display:none;">
                <h3 style="margin-top:0;">Rechercher un élève</h3>
                <input type="text" id="summary-student-search" placeholder="Nom ou Prénom..."
                    oninput="performSummarySearch()"
                    style="width:100%; padding:10px; margin-bottom:10px; background:#222; color:white; border:1px solid #555; font-size:1rem;">
                <div id="summary-search-results"
                    style="max-height:200px; overflow-y:auto; border:1px solid #444; margin-bottom:15px; background:#111;">
                </div>
                <button onclick="resetSummaryModal()"
                    style="width:100%; background:#555; color:white; padding:10px; border:none; cursor:pointer;">Retour</button>
            </div>
        </div>
    </div>

    <!-- STATISTICS MODAL -->
    <div id="statisticsModal" class="modal" style="z-index: 2000;">
        <div class="modal-content"
            style="width: 95%; height: 90vh; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; background: #1a1a1a; color: #e0e0e0; position:relative;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px;">
                <h2 style="margin:0; color:var(--primary-color); display:flex; align-items:center; gap:10px;">
                    📈 Tableau de Bord Statistiques
                </h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button onclick="printStats()"
                        style="background:#555; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;"
                        title="Imprimer">🖨️ Imprimer</button>
                    <button onclick="toggleStatsFullScreen()"
                        style="background:#333; color:#aaa; border:1px solid #444; padding:8px; border-radius:4px; cursor:pointer;"
                        title="Plein Écran">⛶</button>
                    <span class="close-modal" onclick="document.getElementById('statisticsModal').style.display='none'"
                        style="font-size: 2rem; line-height: 1; cursor:pointer;">×</span>
                </div>
            </div>

            <!-- Toolbar Grid -->
            <div
                style="display: flex; flex-direction:column; gap: 10px; padding: 10px; background: #222; border-bottom: 1px solid #333;">
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 20px; align-items: center;">
                    <!-- Time Filters -->
                    <div style="display:flex; gap: 5px;">
                        <button class="stats-filter-btn" onclick="setStatsRange('day')">Aujourd'hui</button>
                        <button class="stats-filter-btn" onclick="setStatsRange('week')">Semaine</button>
                        <button class="stats-filter-btn" onclick="setStatsRange('month')">Mois</button>
                        <button class="stats-filter-btn" onclick="setStatsRange('year')">Année</button>
                    </div>
                    <!-- Search -->
                    <input type="text" id="statsSearchInput" placeholder="Rechercher (Nom, Description...)"
                        oninput="renderStats()"
                        style="background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px;">
                </div>

                <!-- Stats Calendar Clone -->
                <div class="calendar-wrapper" style="margin:0; padding:5px; background:rgba(255,255,255,0.03);">
                    <div id="statsCalendarMonths" class="calendar-months"></div>
                    <div id="statsCalendarStrip" class="calendar-strip"></div>
                </div>
            </div>

            <div id="statsContent" style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- DYNAMIC CONTENT HERE -->
                <div style="text-align:center; color: #888;">Chargement...</div>
            </div>

            <!-- Motif List Modal (Embedded in Statistics for Z-Index handling in Fullscreen) -->
            <div id="motifListModal" class="modal"
                style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:30000; align-items:center; justify-content:center;">
                <div class="modal-content" id="motifListContent"
                    style="max-width: 800px; width: 90%; display:flex; flex-direction:column; max-height:85vh; background: #1a1a1a; border: 1px solid var(--primary-color);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 id="motifListTitle" style="color:var(--primary-color); margin:0;">Liste Motif</h3>
                        <div style="display:flex; gap:10px;">
                            <button onclick="toggleMotifListFullscreen()"
                                style="background:#333; color:#aaa; border:1px solid #444; padding:5px; border-radius:4px; cursor:pointer;"
                                title="Plein Écran">⛶</button>
                            <span onclick="document.getElementById('motifListModal').style.display='none'"
                                style="font-size:1.5rem; cursor:pointer; line-height:1;">×</span>
                        </div>
                    </div>

                    <div style="margin:10px 0; display:flex; gap:10px; flex-wrap:wrap;">
                        <button onclick="printMotifList()"
                            style="background:#4CAF50; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:4px;">🖨️
                            Imprimer</button>
                        <button onclick="toggleMotifSelection(true)"
                            style="background:#444; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:4px;">Tout
                            sélectionner</button>
                        <button onclick="toggleMotifSelection(false)"
                            style="background:#444; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:4px;">Tout
                            désélectionner</button>
                        <button onclick="editMotifForSelected()"
                            style="background:#ff9800; color:black; border:none; padding:5px 10px; cursor:pointer; font-weight:bold; border-radius:4px;">Modifier
                            Motif Sél.</button>
                    </div>
                    <p style="color:#aaa; font-style:italic; font-size:0.9em; margin-top:0;">Cliquez sur un nom pour
                        voir la fiche élève.</p>
                    <div id="motifListContainer"
                        style="flex:1; overflow-y:auto; border:1px solid #444; padding:5px; background:rgba(0,0,0,0.2);">
                        <!-- Content here -->
                    </div>
                    <div style="margin-top:10px; text-align:right;">
                        <button onclick="document.getElementById('motifListModal').style.display='none'"
                            class="btn-secondary">Fermer</button>
                    </div>
                </div>
            </div>

            <style>
                .modal-content.fullscreen-mode {
                    width: 100% !important;
                    height: 100% !important;
                    max-height: 100vh !important;
                    border-radius: 0 !important;
                }

                @keyframes blinkGreenAnim {
                    0% {
                        background-color: #030;
                        box-shadow: 0 0 2px #0f0;
                    }

                    50% {
                        background-color: #0f0;
                        box-shadow: 0 0 15px #0f0;
                    }

                    100% {
                        background-color: #030;
                        box-shadow: 0 0 2px #0f0;
                    }
                }

                .indicator-on-red {
                    background-color: #ff0000 !important;
                    box-shadow: 0 0 15px #ff0000 !important;
                }

                .indicator-on-green {
                    background-color: #00ff00 !important;
                    box-shadow: 0 0 15px #00ff00 !important;
                }

                .indicator-blinking {
                    animation: blinkGreenAnim 0.3s linear 10;
                    /* 10 times, fast blink */
                }

                .stats-filter-btn {
                    background: #333;
                    color: #aaa;
                    border: 1px solid #444;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                }

                .stats-filter-btn:hover {
                    background: #444;
                    color: white;
                }

                .stats-filter-btn.active {
                    background: var(--primary-color);
                    color: black;
                    font-weight: bold;
                    border-color: var(--primary-color);
                }

                .stats-card {
                    background: #252525;
                    border: 1px solid #333;
                    border-radius: 8px;
                    padding: 20px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
                }

                .stats-card h3 {
                    margin-top: 0;
                    color: #ccc;
                    border-bottom: 1px solid #444;
                    padding-bottom: 10px;
                    margin-bottom: 15px;
                    font-size: 1.1rem;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                }
            </style>

            <!-- Population List Modal (Nested for Fullscreen compatibility) -->
            <div id="populationListModal" class="modal"
                style="display:none; z-index:30000; background: rgba(0,0,0,0.8);">
                <div class="modal-content"
                    style="width:500px; max-height:80vh; display:flex; flex-direction:column; background:#222; border:1px solid #444; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                        <h3 id="popListTitle" style="margin:0; color:#fff;">Liste</h3>
                        <button onclick="closePopulationListModal()"
                            style="background:transparent; border:none; color:white; font-size:1.5em; cursor:pointer;">×</button>
                    </div>

                    <div id="popListContainer"
                        style="flex:1; overflow-y:auto; margin-bottom:15px; border:1px solid #333; background:#1a1a1a; padding:5px;">
                        <!-- List items go here -->
                    </div>

                    <div style="display:flex; justify-content:flex-end; gap:10px;">
                        <button onclick="printPopulationList()" class="btn-secondary"
                            style="background:#607D8B; color:white;">Imprimer</button>
                        <button onclick="closePopulationListModal()" class="btn-secondary">Fermer</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <span class="close-modal" onclick="document.getElementById('settingsModal').style.display='none'">×</span>
            <h2 style="margin-top:0; color:var(--primary-color);">⚙️ Paramètres</h2>

            <div class="setting-group" style="margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:20px;">
                <h3 style="color:#fff; margin-bottom:10px;">📅 Configuration Scolaire</h3>

                <div style="margin-bottom:10px;">
                    <label style="display:block; color:#aaa; margin-bottom:5px;">Année de Rentrée (Début
                        Septembre)</label>
                    <input type="number" id="setting-school-year" placeholder="2025" min="2020" max="2030"
                        style="width:100%; padding:8px; background:#222; border:1px solid #444; color:white;">
                    <small style="color:#888;">Changez ceci pour 2026, 2027... pour aligner correctement les
                        mois.</small>
                </div>
            </div>

            <div class="setting-group" style="margin-bottom:20px; border-bottom:1px solid #444; padding-bottom:20px;">
                <h3 style="color:#fff; margin-bottom:10px;">💾 Enregistrement Automatique</h3>

                <div style="margin-bottom:10px;">
                    <label style="display:block; color:#aaa; margin-bottom:5px;">Nom de la base (Fichier)</label>
                    <input type="text" id="setting-db-name" placeholder="plan_de_classe_backup"
                        style="width:100%; padding:8px; background:#222; border:1px solid #444; color:white;">
                </div>

                <div style="margin-bottom:10px;">
                    <label style="display:block; color:#aaa; margin-bottom:5px;">Répertoire d'enregistrement
                        (Simulé)</label>
                    <input type="text" id="setting-save-dir" placeholder="Téléchargements (Par défaut navigateur)"
                        style="width:100%; padding:8px; background:#222; border:1px solid #444; color:white;"
                        readonly="" title="Le navigateur enregistre par défaut dans le dossier Téléchargements">
                    <small style="color:#666;">Note: Pour des raisons de sécurité, le navigateur contrôle le dossier de
                        destination.</small>
                    <button onclick="pickAutoSaveLocation()"
                        style="margin-top:5px; width:100%; padding:8px; background:#333; color:white; border:1px solid #555; cursor:pointer;">📂
                        Choisir l'emplacement (Chrome/Edge)</button>
                </div>

                <div style="margin-bottom:10px;">
                    <label style="display:block; color:#aaa; margin-bottom:5px;">Durée entre chaque enregistrement
                        (minutes)</label>
                    <input type="number" id="setting-autosave-interval" min="1" value="5"
                        style="width:100%; padding:8px; background:#222; border:1px solid #444; color:white;">
                </div>

                <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                    <input type="checkbox" id="setting-autosave-enable">
                    <label for="setting-autosave-enable" style="color:white;">Activer l'enregistrement
                        automatique</label>
                </div>
            </div>

            <div class="setting-group">
                <h3 style="color:#fff; margin-bottom:10px;">🔒 Sécurité</h3>

                <div style="margin-bottom:10px;">
                    <label style="display:block; color:#aaa; margin-bottom:5px;">Définir/Modifier Mot de Passe
                        d'Accès</label>
                    <input type="password" id="setting-password" placeholder="Nouveau mot de passe"
                        style="width:100%; padding:8px; background:#222; border:1px solid #444; color:white;">
                </div>
                <div style="margin-bottom:10px;">
                    <input type="password" id="setting-password-confirm" placeholder="Confirmer mot de passe"
                        style="width:100%; padding:8px; background:#222; border:1px solid #444; color:white;">
                </div>
            </div>

            <div class="setting-group" style="margin-top:20px; border-top:1px solid #444; padding-top:20px;">
                <h3 style="color:#FFA500; margin-bottom:10px;">🔐 Verrouillage Temporel</h3>
                <p style="color:#888; font-size:0.9rem; margin-bottom:15px;">Configurez une date limite d'utilisation du logiciel. Après cette date, le logiciel passera en mode consultation uniquement.</p>
                <button onclick="openLockSettingsModal()" 
                    style="width:100%; padding:12px; background:#FF9800; color:black; font-weight:bold; border:none; cursor:pointer; border-radius:5px;">
                    🔒 Configurer le Verrouillage
                </button>
            </div>

            <button onclick="saveSettings()"
                style="width:100%; padding:12px; background:var(--primary-color); color:black; font-weight:bold; border:none; cursor:pointer; margin-top:10px;">Enregistrer
                les Paramètres</button>
        </div>
    </div>

    <!-- Calendar Creator Modal -->
    <div id="calendarCreatorModal" class="modal" style="display:none; z-index:35000;">
        <div class="modal-content"
            style="width: 900px; max-width:95vw; background:#1e1e1e; border:2px solid var(--primary-color);">
            <span class="close-modal"
                onclick="document.getElementById('calendarCreatorModal').style.display='none'">×</span>
            <h2 style="color:var(--primary-color); margin-top:0;">📅 Générateur de Calendrier Scolaire</h2>

            <div
                style="background: #333; padding: 15px; border-radius: 6px; margin-bottom: 20px; color:#ddd; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <label>Année de rentrée (ex: 2025):
                    <input type="number" id="genStartYear" value="2025" min="2020" max="2100"
                        style="padding: 8px; font-weight: bold; width:80px; background:#222; color:white; border:1px solid #555;">
                </label>
                <button onclick="generateCreatorCalendar()"
                    style="background: #2196F3; color: white; padding:10px; border:none; border-radius:4px; cursor:pointer;">Générer
                    les semaines</button>
                <button onclick="applyCreatedCalendar()"
                    style="background: #E91E63; color: white; padding:10px; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Télécharger
                    et Mettre à jour Logiciel</button>
            </div>

            <div id="creatorPreview"
                style="max-height:50vh; overflow-y:auto; background:#f5f5f5; color:#333; padding:10px; border-radius:4px;">
            </div>

            <style>
                /* Scoped styles for creator */
                .month-block {
                    margin-bottom: 20px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    overflow: hidden;
                    background: white;
                }

                .month-header {
                    background: #2c3e50;
                    color: white;
                    padding: 10px 15px;
                    font-weight: bold;
                }

                .week-row {
                    display: flex;
                    align-items: center;
                    padding: 8px 15px;
                    border-bottom: 1px solid #eee;
                }

                .week-row:hover {
                    background: #f9f9f9;
                }

                .zone-holiday {
                    background: #fff3e0 !important;
                }
            </style>
        </div>
    </div>

    <!-- Load Settings Modal -->
    <div id="loadModal" class="modal">
        <div class="modal-content" style="width: 450px;">
            <span class="close-modal" onclick="closeLoadModal()">×</span>
            <h2 style="margin-top:0; color:var(--primary-color);">Charger un Plan</h2>

            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button onclick="triggerFileLoad()" style="flex:1;">Fichier Unique</button>
            </div>
            <button onclick="triggerFileLoad()"
                style="width:100%; background-color:#9d00ff; color:white; margin-bottom:20px;">Restaurer Sauvegarde
                Globale (Complet)</button>

            <div id="folderFileList"
                style="max-height:300px; overflow-y:auto; border:1px solid #444; padding:5px; display:none; background:#111; border-radius:5px;">
                <!-- List items go here -->
            </div>
        </div>
    </div>

    <!-- Print Range Selection Modal -->
    <div id="printRangeModal" class="modal"
        style="display:none; z-index:35000; align-items:center; justify-content:center;">
        <div class="modal-content"
            style="width: 500px; max-width:95vw; background:#1e1e1e; border:2px solid var(--primary-color); border-radius:8px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
            <h2 style="color:var(--primary-color); margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">🖨️
                Imprimer Rapport Périodique</h2>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">Sélectionnez la semaine de début et la semaine
                de fin.</p>

            <div id="print-range-calendar"
                style="display:grid; grid-template-columns:repeat(auto-fill, minmax(60px, 1fr)); gap:5px; max-height:300px; overflow-y:auto; margin-bottom:20px; padding-right:5px;">
                <!-- Buttons generated here -->
            </div>

            <div
                style="background:#252525; padding:15px; border-radius:4px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; border:1px solid #333;">
                <div style="text-align:center; flex:1;">
                    <div style="color:#888; font-size:0.8rem; text-transform:uppercase;">DÉBUT</div>
                    <div id="print-range-start-display"
                        style="font-weight:bold; color:var(--primary-color); font-size:1.4rem;">--</div>
                </div>
                <div style="color:#555; font-size:1.5rem;">➔</div>
                <div style="text-align:center; flex:1;">
                    <div style="color:#888; font-size:0.8rem; text-transform:uppercase;">FIN</div>
                    <div id="print-range-end-display"
                        style="font-weight:bold; color:var(--primary-color); font-size:1.4rem;">--</div>
                </div>
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end; border-top:1px solid #333; padding-top:15px;">
                <button onclick="document.getElementById('printRangeModal').style.display='none'" class="btn-secondary"
                    style="background:#333; color:#ccc;">ANNULER</button>
                <button onclick="confirmPrintRange()" class="btn-primary"
                    style="background:var(--primary-color); color:#000; font-weight:bold; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; box-shadow:0 0 10px rgba(0,242,255,0.3);">IMPRIMER</button>
            </div>
        </div>
    </div>



    <!-- Assistance Menu Modal -->
    <div id="assistanceMenuModal" class="modal"
        style="display:none; z-index:41000; align-items:center; justify-content:center; background: rgba(0,0,0,0.85);">
        <div class="modal-content"
            style="width: 500px; background:#1a1a1a; border:2px solid #FFA500; border-radius:15px; padding:30px; position:relative; box-shadow: 0 0 30px rgba(255, 165, 0, 0.4);">
            <span class="close-modal" onclick="closeAssistanceMenu()"
                style="position:absolute; top:15px; right:20px; font-size:2.5rem; cursor:pointer; color:#888; transition: color 0.2s;">×</span>
            <style>
                #assistanceMenuModal .close-modal:hover {
                    color: #fff !important;
                }

                .assistance-menu-btn {
                    height: 140px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    background: #222;
                    border: 1px solid #444;
                    border-radius: 12px;
                    color: white;
                    cursor: pointer;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    padding: 10px;
                }

                .assistance-menu-btn:hover {
                    background: #333;
                    border-color: #FFA500;
                    transform: translateY(-5px);
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3), 0 0 15px rgba(255, 165, 0, 0.2);
                }

                .assistance-menu-btn span:first-child {
                    font-size: 3rem;
                    transition: transform 0.3s;
                }

                .assistance-menu-btn:hover span:first-child {
                    transform: scale(1.1);
                }

                .assistance-menu-btn span:last-child {
                    font-weight: bold;
                    font-size: 1.1rem;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
            </style>
            <h2
                style="color:#FFA500; margin-top:0; margin-bottom:30px; text-align:center; font-size:1.8rem; letter-spacing:1px; text-shadow: 0 0 10px rgba(255,165,0,0.3);">
                📚 CENTRE D'ASSISTANCE</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <button class="assistance-menu-btn" onclick="openAssistanceInNewWindowDirect('Guide_Complet_LOGECPE')"
                    style="width:100%;">
                    <span>📖</span>
                    <span>Guide Complet</span>
                </button>
                <button class="assistance-menu-btn"
                    onclick="openAssistanceInNewWindowDirect('Guide_Detaille_Fiche_Eleve')" style="width:100%;">
                    <span>📑</span>
                    <span>Fiche Élève</span>
                </button>
                <button class="assistance-menu-btn" onclick="openAssistanceInNewWindowDirect('Guide_Visuel_LOGECPE')"
                    style="width:100%;">
                    <span>🖼️</span>
                    <span>Guide Visuel</span>
                </button>
                <button class="assistance-menu-btn"
                    onclick="openAssistanceInNewWindowDirect('Reference_Boutons_LOGECPE')" style="width:100%;">
                    <span>🎯</span>
                    <span>Réf. Boutons</span>
                </button>
            </div>
            <div style="margin-top:25px; text-align:center; color:#666; font-size:0.9rem; font-style:italic;">
                Cliquez sur un guide pour l'ouvrir dans un nouvel onglet.
            </div>
        </div>
    </div>


    <header>
        <div class="header-top">
            <h1>LOGECPE_NTP BETA TEST 4 <span id="headerSchoolYear"
                    style="font-size:0.6em; color:#aaa; margin-left:10px;">(Année scolaire 2025 2026)</span> <span
                    style="font-size:0.6em; color:#aaa; margin-left:10px;">Base chargée : <span id="baseNameDisplay"
                        style="color:#fff;">Aucune</span>
                    <span style="display:inline-flex; gap:5px; margin-left:10px; vertical-align:middle;">
                        <div id="indicator-red" class="indicator-on-red"
                            style="width:12px; height:12px; border-radius:50%; background-color:#500; border:1px solid #f00; box-shadow:0 0 2px #f00;">
                        </div>
                        <div id="indicator-green"
                            style="width:12px; height:12px; border-radius:50%; background-color:#030; border:1px solid #0f0; box-shadow:0 0 2px #0f0;">
                        </div>
                        <span id="rdvInfoBox" style="display:inline-flex; align-items:center; background:#232b2b; color:#4CAF50; border-radius:6px; margin-left:12px; padding:3px 10px; font-size:0.85em; min-width:60px; box-shadow:0 1px 4px rgba(0,0,0,0.2);">
                            <span style="font-weight:bold; margin-right:5px;">RDV:</span>
                            <span id="rdvCountDisplay" style="font-size:1em; color:#4CAF50;">0</span>
                        </span>
                        <span id="usageTimer" style="font-size:0.75rem; color:#2196F3; opacity:0.7; margin-left:8px; font-family:monospace; letter-spacing:0.5px;">00:00:00</span>
                        <script>
                            // Start timer immediately inline
                            (function() {
                                const startTime = Date.now();
                                const timerEl = document.getElementById('usageTimer');
                                if (timerEl) {
                                    setInterval(() => {
                                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                                        const h = String(Math.floor(elapsed / 3600)).padStart(2, '0');
                                        const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
                                        const s = String(elapsed % 60).padStart(2, '0');
                                        timerEl.textContent = `${h}:${m}:${s}`;
                                    }, 1000);
                                }
                            })();
                        </script>
                    </span></span></h1>
            <div class="class-info">
                <input type="text" id="className" placeholder="Classe" class="info-input" oninput="updatePrintInfo()"
                    list="knownClasses">
                <datalist id="knownClasses"></datalist>
                <div
                    style="display:inline-flex; flex-direction:column; align-items:flex-end; background:#333; padding:5px 12px; border-radius:4px; margin-left:10px; min-width:120px;">
                    <div class="sheetClockDisplay"
                        style="font-family:'Segoe UI', monospace; font-size:1.2rem; font-weight:bold; color:var(--primary-color); text-shadow:0 0 5px rgba(0,242,255,0.5); line-height:1.2;">
                        00:00:00</div>
                    <div class="sheetDateDisplay"
                        style="font-family:'Segoe UI', sans-serif; font-size:0.8rem; color:#aaa; line-height:1;">
                        01/01/2024</div>
                </div>
                <input type="text" id="roomName" placeholder="Salle" class="info-input"
                    oninput="updatePrintInfo(); scheduleAutoSave();" style="display:none;">
                <button onclick="openQuitModal()"
                    style="display:none; background-color: #D32F2F; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left:10px;">
                    ✖ QUITTER
                </button>
            </div>
        </div>

        <div class="controls">
            <!-- BOUTON MASQUÉ: Mode Placer Élèves -->
            <button id="modeBtn" class="btn-mode active" disabled=""
                style="display:none; background-color: #555 !important; color: #aaa !important; cursor: not-allowed !important; opacity: 0.6 !important; box-shadow: none !important;">Mode:
                Placer Élèves</button>

            <span id="expertControls" style="display:none; gap:10px; align-items:center;">
                <button id="magnetBtn" class="btn-magnet active" onclick="toggleMagnetism()">Aimant: ON</button>
                <button onclick="addTable()" class="btn-add">Ajouter Table</button>

                <select id="sizeSelect" onchange="changeTableSize(this.value)" class="info-input"
                    style="width:auto; padding-right: 2.5em;">
                    <option value="standard" selected="">Taille: Standard</option>
                    <option value="compact">Taille: Compacte</option>
                    <option value="large">Taille: Large</option>
                </select>
            </span>

            <!-- BOUTON MASQUÉ: Importer CSV -->
            <label class="btn-secondary"
                style="display:none; padding:8px 16px; border-radius:5px; cursor:not-allowed; color:#aaa; font-weight:bold; font-size:0.9rem; text-transform:uppercase; background-color: #555; opacity: 0.6;">
                Importer CSV
            </label>
            <input type="file" id="csvInput" accept=".csv" disabled="" style="display:none;">

            <button onclick="var elem = document.getElementById('import-module'); if(elem) { elem.style.display='block'; setTimeout(function(){ alert('Module affiché. Visible? ' + (elem.offsetHeight > 0)); }, 100); } else { alert('Element non trouvé!'); }" class="btn-add" style="background-color:#00cc00; color:black;">
                Import Etablissement
            </button>
            <button onclick="toggleAgendaView()" class="btn-secondary" style="background-color:#FF9800; color:black;">📅
                Agenda des saisies</button>
            <button onclick="toggleRdvView()" class="btn-secondary" style="background-color:#E91E63; color:white;">📅
                Agenda RDV</button>
            <input type="file" id="berliozInput" accept=".csv" style="display:none;"
                onchange="handleBerliozImport(this)">

            <!-- BOUTON MASQUÉ: Répartition Auto -->
            <button class="btn-auto" disabled=""
                style="display:none; background-color: #555 !important; color: #aaa !important; cursor: not-allowed !important; opacity: 0.6 !important; box-shadow: none !important;">Répartition
                Auto</button>

            <!-- <button onclick="savePlan()">Enregistrer</button> SUPPRIMÉ -->
            <button onclick="saveSoftwareState()"
                style="background-color: #8E24AA; color:white; border:2px solid #D1C4E9; box-shadow:0 0 10px rgba(142, 36, 170, 0.4);">💾
                Sauvegarder le LOGICIEL (HTML)</button>
            <button onclick="saveStandaloneHTML()" style="background-color: #9C27B0; color:white;">💾 Sauvegarde Clé
                USB/Cloud (JSON)</button>
            <button onclick="openLoadModal()" class="btn-secondary">Charger</button>
            <input type="file" id="loadInput" accept=".json" style="display:none" onchange="loadPlan(this)">

            <button onclick="openPrintModal()" style="background-color: #ff9900; color:black;">🖨
                Imprimer...</button>
            <button onclick="openAnnualSummaryModal()" style="background-color: #4CAF50; color:white;">📊 Synthèse
                Annuelle</button>
            <button onclick="openStatisticsModal()" style="background-color: #2196F3; color:white;">📈
                Statistique</button>
            <button onclick="openSettingsModal()" style="background-color: #607D8B; color:white;">⚙️ Paramètres</button>
            <!-- <button onclick="openQuitModal()" class="btn-secondary">Fermer le logiciel</button> SUPPRIMÉ -->

            <button onclick="toggleCalendarTools()" class="btn-secondary"
                style="background:#555; color:white; display:none;">📅
                Calendrier</button>
            <span id="calendarTools" style="display: none;">
                <button onclick="importPronoteZoneA()" class="btn-secondary" title="Importer vacances Zone A (Pronote)"
                    style="display:none">Importer Zone A (Pronote)</button>
                <button onclick="openHolidayEditor()" class="btn-secondary" title="Éditer vacances"
                    style="display:none">Éditer
                    Vacances</button>
                <button onclick="triggerImportCalendar()" class="btn-secondary"
                    title="Importer calendrier JSON">Importer
                    calendrier</button>
            </span>

            <!-- BUTTON UTILITAIRES -->
            <button onclick="toggleUtilityTools()" class="btn-secondary" style="background:#795548; color:white;">🛠️
                Utilitaires</button>
            <span id="utilityTools" style="display: none;">
                <button onclick="openCalendarCreatorModal()" class="btn-secondary"
                    title="Créer un nouveau calendrier">Nouveau Calendrier</button>
            </span>

            <input type="file" id="calendarInput" accept=".json" style="display:none;"
                onchange="handleCalendarImport(this)">
            <button onclick="resetPlan()" class="btn-reset">Réinitialiser</button>

            <!-- BOUTON ASSISTANCE -->
            <button onclick="toggleAssistanceTools()" class="btn-secondary"
                style="background:#FFA500; color:black; font-weight:bold; margin-left:auto;">❓ Assistance</button>
        </div>
    </header>

    <script>
        // Affiche le nombre de RDV validés (verts) de la classe courante
        window.updateClassRDVDisplay = function() {
            var rdvDisplay = document.getElementById('rdvCountDisplay');
            if (!rdvDisplay) {
                console.error('[RDV Display] Element rdvCountDisplay introuvable');
                return;
            }
            
            // Récupère le nom de la classe courante
            var className = '';
            var classNameInput = document.getElementById('className');
            if (classNameInput && classNameInput.value.trim()) {
                className = classNameInput.value.trim();
            } else if (typeof getClassName === 'function') {
                className = getClassName();
            }
            
            console.log('[RDV Display] Classe courante:', className);
            
            if (!className) {
                rdvDisplay.textContent = '-';
                console.log('[RDV Display] Aucun nom de classe détecté');
                return;
            }
            
            // Calcule directement à partir d'appData.rdv (compte les RDV validés uniquement)
            if (!appData || !appData.rdv || !Array.isArray(appData.rdv)) {
                rdvDisplay.textContent = '0';
                console.log('[RDV Display] Pas de données RDV dans appData');
                return;
            }
            
            // Compte les RDV validés pour cette classe
            var totalRDV = 0;
            var rdvDetails = [];
            
            appData.rdv.forEach(function(rdv) {
                // Ne compter que les RDV validés (verts)
                if (rdv.status !== 'validated') return;
                
                if (rdv.students && Array.isArray(rdv.students)) {
                    var hasStudentFromClass = false;
                    rdv.students.forEach(function(studentStr) {
                        // Format: "NOM Prénom (Classe)"
                        var match = studentStr.match(/\(([^)]+)\)$/);
                        if (match && match[1] === className) {
                            hasStudentFromClass = true;
                        }
                    });
                    
                    if (hasStudentFromClass) {
                        totalRDV++;
                        rdvDetails.push(rdv.title || rdv.description || 'RDV sans titre');
                    }
                }
            });
            
            rdvDisplay.textContent = totalRDV;
            rdvDisplay.style.display = 'inline-block';
            console.log('[RDV Display] Total RDV validés pour classe ' + className + ':', totalRDV);
            if (rdvDetails.length > 0 && rdvDetails.length <= 5) {
                console.log('[RDV Display] Exemples:', rdvDetails);
            }
        };
        
        // Initialize display on page load and after data changes
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[RDV Display] DOMContentLoaded - Initialisation...');
            
            // Appel initial après un délai
            setTimeout(function() {
                console.log('[RDV Display] Appel initial après 1s');
                updateClassRDVDisplay();
            }, 1000);
            
            // Appel après 3s au cas où
            setTimeout(function() {
                console.log('[RDV Display] Appel de secours après 3s');
                updateClassRDVDisplay();
            }, 3000);
            
            // Update on class name change - avec debounce
            var classNameInput = document.getElementById('className');
            if (classNameInput) {
                var updateTimeout;
                
                // Event input pour mise à jour en temps réel pendant la frappe
                classNameInput.addEventListener('input', function() {
                    console.log('[RDV Display] Input event - classe:', this.value);
                    clearTimeout(updateTimeout);
                    updateTimeout = setTimeout(function() {
                        updateClassRDVDisplay();
                    }, 300);
                });
                
                // Event change pour mise à jour immédiate après sélection
                classNameInput.addEventListener('change', function() {
                    console.log('[RDV Display] Change event - classe:', this.value);
                    clearTimeout(updateTimeout);
                    updateClassRDVDisplay();
                });
                
                // Event blur pour mise à jour quand on quitte le champ
                classNameInput.addEventListener('blur', function() {
                    console.log('[RDV Display] Blur event - classe:', this.value);
                    clearTimeout(updateTimeout);
                    setTimeout(updateClassRDVDisplay, 100);
                });
            }
        });

        function toggleCalendarTools() {
            const el = document.getElementById('calendarTools');
            el.style.display = (el.style.display === 'none') ? 'inline' : 'none';
        }

        function toggleUtilityTools() {
            const el = document.getElementById('utilityTools');
            el.style.display = (el.style.display === 'none') ? 'inline' : 'none';
        }

        function openCalendarCreatorModal() {
            document.getElementById('calendarCreatorModal').style.display = 'flex';
            // Init with current year if possible
            if (appData && appData.schoolYear) document.getElementById('genStartYear').value = appData.schoolYear;
            generateCreatorCalendar();
        }

        function toggleAssistanceTools() {
            document.getElementById('assistanceMenuModal').style.display = 'flex';
        }

        function closeAssistanceMenu() {
            document.getElementById('assistanceMenuModal').style.display = 'none';
        }

        // Fermer le menu d'assistance en cliquant à l'extérieur
        window.onclick = function (event) {
            const menuModal = document.getElementById('assistanceMenuModal');
            if (event.target == menuModal) {
                closeAssistanceMenu();
            }
            // Add other modals here if needed
            const quitModal = document.getElementById('quitModal');
            if (event.target == quitModal) quitModal.style.display = 'none';
            const loadModal = document.getElementById('loadModal');
            if (event.target == loadModal) loadModal.style.display = 'none';
        }

        // Raccourcis clavier
        window.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeAssistanceMenu();
                const helpModal = document.getElementById('helpModal');
                if (helpModal) helpModal.style.display = 'none';
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) settingsModal.style.display = 'none';
                const loadModal = document.getElementById('loadModal');
                if (loadModal) loadModal.style.display = 'none';
                const quitModal = document.getElementById('quitModal');
                if (quitModal) quitModal.style.display = 'none';
            }
        });

        function openAssistanceInNewWindowDirect(guideName) {
            const template = document.getElementById('guide-content-' + guideName);
            if (template) {
                const content = template.innerHTML;
                const newWin = window.open('', '_blank');
                newWin.document.open();
                newWin.document.write(content);
                newWin.document.close();

                const titleMap = {
                    'Guide_Complet_LOGECPE': '📖 Guide Complet LOGECPE',
                    'Guide_Detaille_Fiche_Eleve': '📑 Guide Détaillé: Fiche Élève',
                    'Guide_Visuel_LOGECPE': '🖼️ Guide Visuel: Pas à Pas',
                    'Reference_Boutons_LOGECPE': '🎯 Référence des Boutons'
                };
                newWin.document.title = titleMap[guideName] || 'Guide d\'Assistance';
            }
        }

        function toggleAssistanceFullScreen() {
            const modal = document.getElementById('assistanceModal');
            if (!document.fullscreenElement) {
                if (modal.requestFullscreen) {
                    modal.requestFullscreen();
                } else if (modal.webkitRequestFullscreen) {
                    modal.webkitRequestFullscreen();
                } else if (modal.msRequestFullscreen) {
                    modal.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function openAssistanceGuide(guideName) {
            const guides = {
                'Guide_Complet_LOGECPE': `...`, // Content will be replaced in next step or use a method to load it
                'Guide_Detaille_Fiche_Eleve': `...`,
                'Guide_Visuel_LOGECPE': `...`,
                'Reference_Boutons_LOGECPE': `...`
            };

            // Note: Content is very large, I will define a helper script or use fetch if possible, 
            // but for standalone I should embed.
            // I will use a separate script section to hold these large strings to keep the logic clean.

            const titleMap = {
                'Guide_Complet_LOGECPE': '📖 Guide Complet LOGECPE',
                'Guide_Detaille_Fiche_Eleve': '📑 Guide Détaillé: Fiche Élève',
                'Guide_Visuel_LOGECPE': '🖼️ Guide Visuel: Pas à Pas',
                'Reference_Boutons_LOGECPE': '🎯 Référence des Boutons'
            };

            document.getElementById('assistanceModalTitle').textContent = titleMap[guideName] || 'Guide d\'Assistance';
            const modal = document.getElementById('assistanceModal');
            modal.style.display = 'flex';

            const frame = document.getElementById('assistanceFrame');
            // Instead of direct string which is huge, I'll attempt to load from path if available 
            // OR I will embed the content in a hidden div/script tag.
            // Given the instruction "inserer... les codes", I will embed them.

            const content = document.getElementById('guide-content-' + guideName).innerHTML;
            frame.srcdoc = content;
        }
    </script>

    <!-- Liséré décoratif bleu camouflage fluo -->
    <div id="decorativeDivider" style="
        height: 2px;
        background: linear-gradient(90deg, 
            rgba(0, 212, 255, 0.3) 0%, 
            rgba(0, 212, 255, 0.9) 25%, 
            rgba(0, 153, 255, 1) 50%, 
            rgba(0, 212, 255, 0.9) 75%, 
            rgba(0, 212, 255, 0.3) 100%
        );
        box-shadow: 
            0 0 10px rgba(0, 212, 255, 0.8),
            0 1px 3px rgba(0, 153, 255, 0.5);
        margin: 1px 0;
        width: 100%;
        animation: pulseGlow 2s ease-in-out 15;
        animation-fill-mode: forwards;
        transition: opacity 60s ease-out;
    "></div>

    <style>
        @keyframes slideGlow {
            0% {
                background-position: -200% center;
            }

            100% {
                background-position: 200% center;
            }
        }
    </style>



    <!-- Calendar Section -->
    <div class="calendar-wrapper">
        <div id="calendarMonths" class="calendar-months">
            <div class="month-label"
                style="flex: 4.28571 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                septembre</div>
            <div class="month-label"
                style="flex: 4.42857 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                octobre</div>
            <div class="month-label"
                style="flex: 4.28571 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                novembre</div>
            <div class="month-label"
                style="flex: 4.42857 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                décembre</div>
            <div class="month-label"
                style="flex: 4.42857 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                janvier</div>
            <div class="month-label"
                style="flex: 4 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                février</div>
            <div class="month-label"
                style="flex: 4.42857 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                mars</div>
            <div class="month-label"
                style="flex: 4.28571 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                avril</div>
            <div class="month-label"
                style="flex: 4.42857 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                mai</div>
            <div class="month-label"
                style="flex: 4.28571 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                juin</div>
            <div class="month-label"
                style="flex: 2.71429 1 0%; min-width: 0px; overflow: hidden; white-space: nowrap; text-align: center; box-sizing: border-box;">
                juillet</div>
        </div>
        <div id="calendarStrip" class="calendar-strip">
            <div class="week-btn" data-id="36" data-orig-display="36">36</div>
            <div class="week-btn" data-id="37" data-orig-display="37">37</div>
            <div class="week-btn" data-id="38" data-orig-display="38">38</div>
            <div class="week-btn" data-id="39" data-orig-display="39">39</div>
            <div class="week-btn" data-id="40" data-orig-display="40">40</div>
            <div class="week-btn" data-id="41" data-orig-display="41">41</div>
            <div class="week-btn" data-id="42" data-orig-display="42">42</div>
            <div class="week-btn holiday" data-id="F_7" data-orig-display="F">F</div>
            <div class="week-btn holiday" data-id="F_8" data-orig-display="F">F</div>
            <div class="week-btn" data-id="45" data-orig-display="45">45</div>
            <div class="week-btn" data-id="46" data-orig-display="46">46</div>
            <div class="week-btn" data-id="47" data-orig-display="47">47</div>
            <div class="week-btn" data-id="48" data-orig-display="48">48</div>
            <div class="week-btn" data-id="49" data-orig-display="49">49</div>
            <div class="week-btn" data-id="50" data-orig-display="50">50</div>
            <div class="week-btn" data-id="51" data-orig-display="51">51</div>
            <div class="week-btn holiday" data-id="F_16" data-orig-display="F">F</div>
            <div class="week-btn holiday" data-id="F_17" data-orig-display="F">F</div>
            <div class="week-btn" data-id="2" data-orig-display="2">2</div>
            <div class="week-btn" data-id="3" data-orig-display="3">3</div>
            <div class="week-btn" data-id="4" data-orig-display="4">4</div>
            <div class="week-btn" data-id="5" data-orig-display="5">5</div>
            <div class="week-btn" data-id="6" data-orig-display="6">6</div>
            <div class="week-btn holiday" data-id="F_23" data-orig-display="F">F</div>
            <div class="week-btn holiday" data-id="F_24" data-orig-display="F">F</div>
            <div class="week-btn" data-id="9" data-orig-display="9">9</div>
            <div class="week-btn" data-id="10" data-orig-display="10">10</div>
            <div class="week-btn" data-id="11" data-orig-display="11">11</div>
            <div class="week-btn" data-id="12" data-orig-display="12">12</div>
            <div class="week-btn" data-id="13" data-orig-display="13">13</div>
            <div class="week-btn" data-id="14" data-orig-display="14">14</div>
            <div class="week-btn holiday" data-id="F_31" data-orig-display="F">F</div>
            <div class="week-btn holiday" data-id="F_32" data-orig-display="F">F</div>
            <div class="week-btn" data-id="17" data-orig-display="17">17</div>
            <div class="week-btn" data-id="18" data-orig-display="18">18</div>
            <div class="week-btn" data-id="19" data-orig-display="19">19</div>
            <div class="week-btn" data-id="20" data-orig-display="20">20</div>
            <div class="week-btn" data-id="21" data-orig-display="21">21</div>
            <div class="week-btn" data-id="22" data-orig-display="22">22</div>
            <div class="week-btn" data-id="23" data-orig-display="23">23</div>
            <div class="week-btn" data-id="24" data-orig-display="24">24</div>
            <div class="week-btn" data-id="25" data-orig-display="25">25</div>
            <div class="week-btn" data-id="26" data-orig-display="26">26</div>
            <div class="week-btn" data-id="27" data-orig-display="27">27</div>
            <div class="week-btn" data-id="28" data-orig-display="28">28</div>
            <div class="week-btn" data-id="29" data-orig-display="29">29</div>
        </div>
        <div style="margin-top:5px; font-size:0.8rem; color:#888; text-align:right;">
            Semaine active : <span id="currentWeekDisplay" style="color:var(--primary-color); font-weight:bold;">Semaine
                2</span>
        </div>

        <!-- Batch Selection Area -->
        <div id="batchSelectionArea"
            style="margin-top:10px; border-top:1px solid #444; padding-top:10px; display:none; justify-content:flex-end; gap:10px;">
            <!-- BOUTON DÉSACTIVÉ POUR CETTE VERSION -->
            <button class="btn-secondary" disabled=""
                style="padding:8px 16px; font-size:0.9rem; background-color: #555 !important; color: #aaa !important; font-weight:bold; cursor: not-allowed !important; opacity: 0.6 !important; box-shadow: none !important;">
                ✓ Valider
            </button>
            <!-- BOUTON DÉSACTIVÉ POUR CETTE VERSION -->
            <button class="btn-secondary" disabled=""
                style="padding:6px 14px; font-size:0.9rem; background-color: #555 !important; color: #aaa !important; font-weight:bold; cursor: not-allowed !important; opacity: 0.6 !important; box-shadow: none !important;">
                ✓ Valider la sélection / Répartir...
            </button>
        </div>

    </div>

    <!-- Liséré décoratif bleu camouflage fluo (bas du calendrier) -->
    <div id="decorativeDivider2" style="
        height: 2px;
        background: linear-gradient(90deg, 
            rgba(0, 212, 255, 0.3) 0%, 
            rgba(0, 212, 255, 0.9) 25%, 
            rgba(0, 153, 255, 1) 50%, 
            rgba(0, 212, 255, 0.9) 75%, 
            rgba(0, 212, 255, 0.3) 100%
        );
        box-shadow: 
            0 0 8px rgba(0, 212, 255, 0.7),
            0 1px 2px rgba(0, 153, 255, 0.4);
        margin: 1px 0;
        width: 100%;
        animation: pulseGlow 2s ease-in-out 15;
        animation-fill-mode: forwards;
        transition: opacity 60s ease-out;
    "></div>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="student-pool" id="studentSidebar">
            <div class="student-pool-resizer" id="sidebarResizer"></div>
            <div class="sidebar-tabs">
                <button class="tab-btn active" id="btn-tab-students"
                    onclick="refreshAndShowStudentsTab()">Élèves</button>
                <button class="tab-btn" id="btn-tab-search" onclick="openSearchHub()"
                    style="background-color:#2196F3; color:white; border:none;">🔍 Recherche</button><button
                    id="btn-tab-classes" class="tab-btn">Classes</button>
            </div>

            <!-- Students Tab -->
            <div id="tab-students" class="tab-content" style="display:flex; flex-direction:column; height:100%;">
                <h2 style="font-size:1rem; margin:10px 0; border-bottom:1px solid #333; padding-bottom:5px;">
                    Liste (<span id="studentCount">0</span>)
                </h2>
                <div id="poolList" class="student-list" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
            </div>
            <div id="tab-classes" class="tab-content" style="display: none; flex-direction: column; height: 100%;">
                <h2 style="font-size:1rem; margin:10px 0; border-bottom:1px solid #333; padding-bottom:5px;">Classes (0)
                </h2>
                <div class="student-list"></div>
            </div>
        </div>

        <!-- Liséré vertical de séparation -->
        <div id="decorativeDividerVertical" style="
        width: 2px;
        background: linear-gradient(180deg, 
            rgba(0, 212, 255, 0.2) 0%, 
            rgba(0, 212, 255, 0.4) 20%,
            rgba(0, 212, 255, 0.7) 40%,
            rgba(0, 153, 255, 1) 50%, 
            rgba(0, 212, 255, 0.7) 60%,
            rgba(0, 212, 255, 0.4) 80%,
            rgba(0, 212, 255, 0.2) 100%
        );
        box-shadow: 
            0 0 10px rgba(0, 212, 255, 0.8),
            0 0 5px rgba(0, 153, 255, 0.5);
        margin: 0 1px;
        opacity: 1;
        align-self: stretch;
    "></div>

        <!-- Classroom -->
        <div class="classroom" id="classroomArea" style="display: none;">
            <div class="teacher-desk" id="teacherDesk" style="cursor: default;">
                <input type="text" id="teacherNameInput" class="teacher-name-input" placeholder="Nom du Prof">
            </div>

            <div class="layout-grid" id="layoutGrid">
                <div class="classroom-row">
                    <div class="table" id="table-r1-t1" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r1-t1-s1"></div>
                        <div class="student-slot" id="table-r1-t1-s2"></div>
                    </div>
                    <div class="table" id="table-r1-t2" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r1-t2-s1"></div>
                        <div class="student-slot" id="table-r1-t2-s2"></div>
                    </div>
                    <div class="table" id="table-r1-t3" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r1-t3-s1"></div>
                        <div class="student-slot" id="table-r1-t3-s2"></div>
                    </div>
                    <div class="table" id="table-r1-t4" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r1-t4-s1"></div>
                        <div class="student-slot" id="table-r1-t4-s2"></div>
                    </div>
                </div>
                <div class="classroom-row">
                    <div class="table" id="table-r2-t1" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r2-t1-s1"></div>
                        <div class="student-slot" id="table-r2-t1-s2"></div>
                    </div>
                    <div class="table" id="table-r2-t2" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r2-t2-s1"></div>
                        <div class="student-slot" id="table-r2-t2-s2"></div>
                    </div>
                    <div class="table" id="table-r2-t3" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r2-t3-s1"></div>
                        <div class="student-slot" id="table-r2-t3-s2"></div>
                    </div>
                    <div class="table" id="table-r2-t4" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r2-t4-s1"></div>
                        <div class="student-slot" id="table-r2-t4-s2"></div>
                    </div>
                </div>
                <div class="classroom-row">
                    <div class="table" id="table-r3-t1" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r3-t1-s1"></div>
                        <div class="student-slot" id="table-r3-t1-s2"></div>
                    </div>
                    <div class="table" id="table-r3-t2" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r3-t2-s1"></div>
                        <div class="student-slot" id="table-r3-t2-s2"></div>
                    </div>
                    <div class="table" id="table-r3-t3" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r3-t3-s1"></div>
                        <div class="student-slot" id="table-r3-t3-s2"></div>
                    </div>
                    <div class="table" id="table-r3-t4" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r3-t4-s1"></div>
                        <div class="student-slot" id="table-r3-t4-s2"></div>
                    </div>
                </div>
                <div class="classroom-row">
                    <div class="table" id="table-r4-t1" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r4-t1-s1"></div>
                        <div class="student-slot" id="table-r4-t1-s2"></div>
                    </div>
                    <div class="table" id="table-r4-t2" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r4-t2-s1"></div>
                        <div class="student-slot" id="table-r4-t2-s2"></div>
                    </div>
                    <div class="table" id="table-r4-t3" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r4-t3-s1"></div>
                        <div class="student-slot" id="table-r4-t3-s2"></div>
                    </div>
                    <div class="table" id="table-r4-t4" data-rotation="0" title="">
                        <div class="table-controls"><button class="control-btn btn-rotate-left"
                                title="Pivoter Gauche -18°">↺</button><button class="control-btn btn-rotate-right"
                                title="Pivoter Droite +18°">↻</button><button class="control-btn btn-delete"
                                title="Supprimer">✕</button></div>
                        <div class="student-slot" id="table-r4-t4-s1"></div>
                        <div class="student-slot" id="table-r4-t4-s2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agenda View -->
        <div id="agendaArea"
            style="display: block; flex: 1 1 0%; background: var(--panel-bg); border: var(--panel-border); border-radius: 10px; padding: 20px; overflow-y: auto; margin-left: 10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; color:var(--primary-color);">Agenda des Saisies</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="changeAgendaMonth(-1)" class="btn-secondary">&lt; Précédent</button>
                    <span id="agendaMonthDisplay"
                        style="font-size:1.2rem; font-weight:bold; min-width:200px; text-align:center; color:white;">JANVIER
                        2026</span>
                    <button onclick="changeAgendaMonth(1)" class="btn-secondary">Suivant &gt;</button>
                    <button onclick="printAgenda()" class="btn-secondary"
                        style="margin-left:10px; background-color: #607D8B; color: white;">🖨️ Imprimer</button>

                </div>
            </div>
            <div
                style="display:grid; grid-template-columns: repeat(7, 1fr); gap:5px; margin-bottom:10px; text-align:center; font-weight:bold; color:#aaa;">
                <div>Lun</div>
                <div>Mar</div>
                <div>Mer</div>
                <div>Jeu</div>
                <div>Ven</div>
                <div>Sam</div>
                <div>Dim</div>
            </div>
            <div id="agendaGrid"
                style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; grid-auto-rows: minmax(100px, auto);">
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 5px;"></div>
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 5px;"></div>
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 5px;"></div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">1</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">2</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">3</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">4</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">5</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">6</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">7</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">8</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">9</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">10</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">11</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">12</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">13</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">14</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">15</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">16</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">17</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">18</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">19</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">20</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">21</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">22</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">23</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">24</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">25</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">26</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">27</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">28</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">29</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">30</div>
                </div>
                <div
                    style="background: rgba(30, 30, 30, 0.8); border: 1px solid rgb(68, 68, 68); border-radius: 5px; padding: 5px; min-height: 100px; position: relative;">
                    <div style="font-weight: bold; margin-bottom: 5px; color: var(--primary-color);">31</div>
                </div>
            </div>
        </div>

        <!-- RDV View -->
        <div id="rdvArea"
            style="display:none; flex:1; background:var(--panel-bg); border:var(--panel-border); border-radius:10px; padding:20px; overflow-y:auto; margin-left: 10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; color:#E91E63;">Agenda RDV</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="setRdvViewMode('day')" class="btn-secondary" id="btn-rdv-day">Jour</button>
                    <button onclick="setRdvViewMode('week')" class="btn-secondary" id="btn-rdv-week">Semaine</button>
                    <button onclick="setRdvViewMode('month')" class="btn-secondary" id="btn-rdv-month">Mois</button>
                    <!-- Bouton Plein Écran -->
                    <button onclick="toggleRdvFullScreen()" class="btn-secondary" id="btn-rdv-fullscreen"
                        title="Plein Écran" style="font-size:1.2rem; padding: 0 10px;">⛶</button>

                    <button onclick="openPrintOptions()" class="btn-secondary"
                        style="background-color:#607D8B; color:white;">Imprimer</button>
                    <button onclick="closeRdvView()" class="btn-secondary"
                        style="background-color:#F44336; color:white; margin-left:10px;">Fermer</button>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button onclick="changeRdvDate(-1)" class="btn-secondary">&lt;</button>
                    <span id="rdvDateDisplay"
                        style="font-size:1.2rem; font-weight:bold; min-width:200px; text-align:center; color:white;"></span>
                    <button onclick="changeRdvDate(1)" class="btn-secondary">&gt;</button>
                </div>
                <button onclick="openRdvTypeSelection()" class="btn-add" style="background-color:#E91E63;">+ Nouveau
                    RDV</button>
            </div>
            <div id="rdvGrid" style="height: calc(100% - 60px); overflow-y: auto;">
                <!-- Content -->
            </div>
        </div>
    </div>

    <!-- Bandeau de verrouillage -->
    <div id="lockBanner" style="display:none; position:fixed; top:0; left:0; right:0; background:linear-gradient(135deg, #F44336, #D32F2F); color:white; padding:15px; text-align:center; z-index:100000; box-shadow:0 4px 6px rgba(0,0,0,0.3); font-weight:bold; font-size:1.1rem;">
        <span style="margin-right:20px;">🔒 LOGICIEL VERROUILLÉ - Mode consultation uniquement (Date limite dépassée)</span>
        <button onclick="openUnlockModal()" style="background:#FFA500; color:black; border:none; padding:8px 20px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:1rem;">🔓 Déverrouiller</button>
    </div>

    <!-- Modal de déverrouillage -->
    <div id="unlockModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100001; justify-content:center; align-items:center;">
        <div style="background:#2d2d2d; border:2px solid #FFA500; border-radius:15px; padding:30px; width:500px; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
            <h2 style="color:#FFA500; margin:0 0 20px 0; text-align:center;">🔓 Déverrouillage de l'application</h2>
            
            <div style="background:rgba(244,67,54,0.2); border-left:4px solid #F44336; padding:15px; margin-bottom:20px; border-radius:5px;">
                <p style="margin:0; color:#FF5252; font-weight:bold;">⚠️ Application verrouillée</p>
                <p style="margin:5px 0 0 0; color:#FFB74D; font-size:0.95rem;">La date et l'heure limite d'utilisation sont dépassées. Entrez le mot de passe pour déverrouiller.</p>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; color:#FFA500; font-weight:bold; margin-bottom:5px;">📅 Date et heure limite actuelle :</label>
                <input type="datetime-local" id="unlock-date" readonly style="width:100%; padding:10px; background:#1e1e1e; border:1px solid #555; border-radius:5px; color:#FFA500; font-size:1rem;">
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; color:#FFA500; font-weight:bold; margin-bottom:5px;">🔑 Mot de passe :</label>
                <input type="password" id="unlock-password" placeholder="Entrez le mot de passe" style="width:100%; padding:10px; background:#1e1e1e; border:1px solid #555; border-radius:5px; color:white; font-size:1rem;">
            </div>
            
            <div id="unlock-error" style="color:#F44336; font-weight:bold; margin-bottom:15px; text-align:center; min-height:20px;"></div>
            
            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="unlockApplication()" style="background:#4CAF50; color:white; border:none; padding:12px 30px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:1rem;">✅ Déverrouiller</button>
                <button onclick="closeUnlockModal()" style="background:#607D8B; color:white; border:none; padding:12px 30px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:1rem;">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal de configuration du verrouillage -->
    <div id="lockSettingsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100002; justify-content:center; align-items:center;">
        <div style="background:#2d2d2d; border:2px solid #FFA500; border-radius:15px; padding:30px; width:600px; box-shadow:0 10px 30px rgba(0,0,0,0.5); max-height:90vh; overflow-y:auto;">
            <h2 style="color:#FFA500; margin:0 0 20px 0; text-align:center;">⚙️ Configuration du Verrouillage Temporel</h2>
            
            <div style="background:rgba(255,165,0,0.15); border-left:4px solid #FFA500; padding:15px; margin-bottom:25px; border-radius:5px;">
                <p style="margin:0; color:#FFA500; font-weight:bold;">ℹ️ À propos du verrouillage</p>
                <p style="margin:8px 0 0 0; color:#FFB74D; font-size:0.9rem; line-height:1.5;">Cette fonctionnalité permet de définir une date et heure limite d'utilisation. Après cette date et heure, le logiciel passera automatiquement en mode consultation uniquement (lecture seule des fiches élèves). Un mot de passe sera nécessaire pour déverrouiller l'application.</p>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="lock-enabled" style="width:20px; height:20px; cursor:pointer;">
                    <span style="color:#FFA500; font-weight:bold; font-size:1.1rem;">🔒 Activer le verrouillage temporel</span>
                </label>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; color:#FFA500; font-weight:bold; margin-bottom:5px;">📅 Date et heure limite d'utilisation :</label>
                <input type="datetime-local" id="lock-date" style="width:100%; padding:10px; background:#1e1e1e; border:1px solid #555; border-radius:5px; color:white; font-size:1rem;">
                <small style="color:#888; display:block; margin-top:5px;">Après cette date et heure, le logiciel sera en mode consultation uniquement.</small>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; color:#FFA500; font-weight:bold; margin-bottom:5px;">🔑 Mot de passe de déverrouillage :</label>
                <input type="password" id="lock-password" placeholder="Entrez un mot de passe (min. 4 caractères)" style="width:100%; padding:10px; background:#1e1e1e; border:1px solid #555; border-radius:5px; color:white; font-size:1rem;">
                <small style="color:#888; display:block; margin-top:5px;">Laissez vide pour conserver le mot de passe actuel.</small>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; color:#FFA500; font-weight:bold; margin-bottom:5px;">🔑 Confirmer le mot de passe :</label>
                <input type="password" id="lock-password-confirm" placeholder="Confirmez le mot de passe" style="width:100%; padding:10px; background:#1e1e1e; border:1px solid #555; border-radius:5px; color:white; font-size:1rem;">
            </div>
            
            <div style="background:rgba(76,175,80,0.15); border-left:4px solid #4CAF50; padding:15px; margin-bottom:20px; border-radius:5px;">
                <p style="margin:0; color:#4CAF50; font-weight:bold;">✅ Actions autorisées en mode verrouillé :</p>
                <ul style="margin:8px 0 0 20px; color:#81C784; font-size:0.9rem; line-height:1.6;">
                    <li>Charger des données existantes</li>
                    <li>Consulter les fiches élèves</li>
                    <li>Voir le sidebar avec classes et élèves</li>
                </ul>
                <p style="margin:12px 0 0 0; color:#F44336; font-weight:bold;">❌ Actions bloquées en mode verrouillé :</p>
                <ul style="margin:8px 0 0 20px; color:#E57373; font-size:0.9rem; line-height:1.6;">
                    <li>Édition des plans de classe</li>
                    <li>Ajout/modification d'élèves</li>
                    <li>Création/modification de RDV</li>
                    <li>Sauvegarde et impression</li>
                    <li>Import de données</li>
                    <li>Accès aux statistiques</li>
                </ul>
            </div>
            
            <div id="lock-settings-error" style="color:#F44336; font-weight:bold; margin-bottom:15px; text-align:center; min-height:20px;"></div>
            
            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="saveLockSettings()" style="background:#4CAF50; color:white; border:none; padding:12px 30px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:1rem;">💾 Enregistrer</button>
                <button onclick="closeLockSettingsModal()" style="background:#607D8B; color:white; border:none; padding:12px 30px; border-radius:5px; cursor:pointer; font-weight:bold; font-size:1rem;">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * logiciel v35 - Architecture Refactored
         * 
         * KEY IMPROVEMENTS:
         * 1. Merged functions: selectWeek() now handles save + load (no separate loadWeekState/saveCurrentWeekState)
         * 2. Unified calendar refresh: refreshCalendarState() replaces updateCalendarHighlights + renderBatchHighlights
         * 3. Simplified toggleEditMode: Auto-freezes layout when entering edit mode
         * 4. Auto-save system: Debounced auto-save on student drag, status change, position update
         * 5. Removed dead code: _deprecated_validateActiveWeeks() + empty updateBatchDisplay()
         * 
         * ARCHITECTURE:
         * - weeklyPlans: {className: {weekId: snapshot}}  - All data per class per week
         * - activeWeeksPerClass: {className: [weekIds]}    - Active weeks for distribution
         * - currentWeekId: Currently viewed week
         * - isEditMode: Edit mode toggle (auto-syncs with isLayoutFrozen)
         * 
         * WORKFLOW:
         * 1. User clicks week -> selectWeek() saves current + loads new
         * 2. User drags student -> scheduleAutoSave() debounces -> autoSavePlan()
         * 3. User changes class name -> onClassNameChange() switches or renames context
         * 4. User validates weeks -> confirmWeekSelection() applies snapshot to selected weeks
         */

        // Global State
        let isEditMode = false;
        let isLayoutFrozen = false;
        let isMagnetActive = true;

        let currentWeekId = null;
        let weeklyPlans = {};
        let activeWeeksPerClass = {};
        let tempBatchSelection = new Set();
        let lastActiveClassName = "Classe Sans Nom";
        let currentDocName = "";

        // Fonction pour mettre à jour les indicateurs de base chargée
        function updateBaseIndicators() {
            const redIndicator = document.getElementById('indicator-red');
            const greenIndicator = document.getElementById('indicator-green');
            const baseNameDisplay = document.getElementById('baseNameDisplay');
            
            // Vérifier si une base est réellement chargée avec des élèves
            let hasStudents = false;
            if (appData.students && typeof appData.students === 'object') {
                for (const className in appData.students) {
                    if (Object.keys(appData.students[className]).length > 0) {
                        hasStudents = true;
                        break;
                    }
                }
            }
            
            const hasLoadedBase = (currentDocName && currentDocName !== '') && hasStudents;
            
            if (hasLoadedBase) {
                // Base chargée : vert allumé, rouge éteint
                if (redIndicator) {
                    redIndicator.classList.remove('indicator-on-red');
                    redIndicator.style.cssText = 'width:12px; height:12px; border-radius:50%; background-color:#030; border:1px solid #f00; box-shadow:0 0 2px rgba(255,0,0,0.2);';
                }
                if (greenIndicator) {
                    greenIndicator.classList.add('indicator-on-green');
                    greenIndicator.style.cssText = 'width:12px; height:12px; border-radius:50%; background-color:#00ff00; border:1px solid #0f0; box-shadow:0 0 15px #00ff00;';
                }
                if (baseNameDisplay) {
                    baseNameDisplay.textContent = currentDocName || 'Base chargée';
                    baseNameDisplay.style.color = '#0f0';
                }
            } else {
                // Pas de base : rouge allumé, vert éteint
                if (redIndicator) {
                    redIndicator.classList.add('indicator-on-red');
                    redIndicator.style.cssText = 'width:12px; height:12px; border-radius:50%; background-color:#ff0000; border:1px solid #f00; box-shadow:0 0 15px #ff0000;';
                }
                if (greenIndicator) {
                    greenIndicator.classList.remove('indicator-on-green');
                    greenIndicator.style.cssText = 'width:12px; height:12px; border-radius:50%; background-color:#030; border:1px solid #0f0; box-shadow:0 0 2px rgba(0,255,0,0.2);';
                }
                if (baseNameDisplay) {
                    baseNameDisplay.textContent = 'Aucune';
                    baseNameDisplay.style.color = '#aaa';
                }
            }
        }

        // ===== SYSTÈME COMPLET DE SAUVEGARDE AUTOMATIQUE =====
        const APP_VERSION = "3.6";
        const STORAGE_KEY = "planClasse_appData";
        const ARCHIVE_KEY = "planClasse_archives";

        // === SYSTÈME DE VERROUILLAGE TEMPOREL ===
        function isApplicationLocked() {
            if (!appData.lockSettings) {
                appData.lockSettings = {
                    enabled: false,
                    lockDate: "2026-06-30T23:59",
                    password: "",
                    isUnlocked: false
                };
            }
            
            if (!appData.lockSettings.enabled) return false;
            if (appData.lockSettings.isUnlocked) return false;
            
            const today = new Date();
            const lockDate = new Date(appData.lockSettings.lockDate);
            
            return today > lockDate;
        }

        function checkLockAndShowWarning() {
            if (isApplicationLocked()) {
                const lockBanner = document.getElementById('lockBanner');
                if (lockBanner) {
                    lockBanner.style.display = 'flex';
                }
                applyLockRestrictions();
                return true;
            }
            return false;
        }

        function applyLockRestrictions() {
            // Désactiver tous les boutons d'édition
            const editButtons = [
                'btn-edit-mode', 'btn-add-student', 'btn-add-rdv', 'btn-stats',
                'openImportBtn', 'btn-save', 'openPrintBtn'
            ];
            
            editButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.4';
                    btn.style.cursor = 'not-allowed';
                    btn.title = '🔒 Logiciel verrouillé - Mode consultation uniquement';
                }
            });

            // Désactiver les boutons dans le sidebar
            const sidebarButtons = document.querySelectorAll('#studentsSidebar button');
            sidebarButtons.forEach(btn => {
                if (!btn.classList.contains('student-item') && btn.textContent !== 'Fermer') {
                    btn.disabled = true;
                    btn.style.opacity = '0.4';
                    btn.style.cursor = 'not-allowed';
                }
            });

            // Bloquer le drag & drop
            isEditMode = false;
            isLayoutFrozen = true;
        }

        function openUnlockModal() {
            const modal = document.getElementById('unlockModal');
            const dateInput = document.getElementById('unlock-date');
            const passwordInput = document.getElementById('unlock-password');
            const errorMsg = document.getElementById('unlock-error');
            
            if (appData.lockSettings && appData.lockSettings.lockDate) {
                dateInput.value = appData.lockSettings.lockDate;
            }
            passwordInput.value = '';
            errorMsg.textContent = '';
            
            modal.style.display = 'flex';
        }

        function closeUnlockModal() {
            document.getElementById('unlockModal').style.display = 'none';
        }

        function unlockApplication() {
            const passwordInput = document.getElementById('unlock-password').value;
            const errorMsg = document.getElementById('unlock-error');
            
            if (!appData.lockSettings || !appData.lockSettings.password) {
                errorMsg.textContent = '❌ Aucun mot de passe configuré. Allez dans Paramètres pour en définir un.';
                return;
            }
            
            if (passwordInput === appData.lockSettings.password) {
                appData.lockSettings.isUnlocked = true;
                saveAppData();
                
                // Masquer le bandeau de verrouillage
                const lockBanner = document.getElementById('lockBanner');
                if (lockBanner) lockBanner.style.display = 'none';
                
                // Réactiver tous les boutons
                const editButtons = document.querySelectorAll('button');
                editButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.title = '';
                });
                
                closeUnlockModal();
                alert('✅ Application déverrouillée avec succès !');
                location.reload(); // Recharger pour appliquer tous les changements
            } else {
                errorMsg.textContent = '❌ Mot de passe incorrect !';
            }
        }

        function openLockSettingsModal() {
            const modal = document.getElementById('lockSettingsModal');
            const enabledCheckbox = document.getElementById('lock-enabled');
            const dateInput = document.getElementById('lock-date');
            const passwordInput = document.getElementById('lock-password');
            const confirmInput = document.getElementById('lock-password-confirm');
            
            if (appData.lockSettings) {
                enabledCheckbox.checked = appData.lockSettings.enabled || false;
                dateInput.value = appData.lockSettings.lockDate || '2026-06-30T23:59';
            } else {
                enabledCheckbox.checked = false;
                dateInput.value = '2026-06-30T23:59';
            }
            
            passwordInput.value = '';
            confirmInput.value = '';
            document.getElementById('lock-settings-error').textContent = '';
            
            modal.style.display = 'flex';
        }

        function closeLockSettingsModal() {
            document.getElementById('lockSettingsModal').style.display = 'none';
        }

        function saveLockSettings() {
            const enabled = document.getElementById('lock-enabled').checked;
            const lockDate = document.getElementById('lock-date').value;
            const password = document.getElementById('lock-password').value;
            const confirmPassword = document.getElementById('lock-password-confirm').value;
            const errorMsg = document.getElementById('lock-settings-error');
            
            if (enabled) {
                if (!lockDate) {
                    errorMsg.textContent = '❌ Veuillez sélectionner une date limite.';
                    return;
                }
                
                if (password || confirmPassword) {
                    if (password !== confirmPassword) {
                        errorMsg.textContent = '❌ Les mots de passe ne correspondent pas.';
                        return;
                    }
                    if (password.length < 4) {
                        errorMsg.textContent = '❌ Le mot de passe doit contenir au moins 4 caractères.';
                        return;
                    }
                }
            }
            
            if (!appData.lockSettings) {
                appData.lockSettings = {};
            }
            
            appData.lockSettings.enabled = enabled;
            appData.lockSettings.lockDate = lockDate;
            if (password) {
                appData.lockSettings.password = password;
            }
            appData.lockSettings.isUnlocked = false;
            
            saveAppData();
            closeLockSettingsModal();
            alert('✅ Paramètres de verrouillage enregistrés avec succès !');
            
            // Vérifier immédiatement si on doit verrouiller
            if (enabled && isApplicationLocked()) {
                checkLockAndShowWarning();
            }
        }

        /* MARKER:APPDATA_START */
        let appData = {
            "version": "3.6",
            "lastUpdate": "2026-01-11T16:41:17.382Z",
            "students": {},
            "classes": {
                "Classe Sans Nom": {
                    "students": [],
                    "room": "",
                    "subject": ""
                }
            },
            "weeklyReports": {},
            "studentColors": {},
            "customRubriques": {},
            "plans": {
                "Classe Sans Nom": {}
            },
            "rdv": [],
            "schoolYear": 2025,
            "lockSettings": {
                "enabled": false,
                "lockDate": "2026-06-30T23:59",
                "password": "",
                "isUnlocked": false
            },
            "holidays": [],
            "calendar": {
                "months": [
                    {
                        "name": "septembre",
                        "flex": 4.285714285714286
                    },
                    {
                        "name": "octobre",
                        "flex": 4.428571428571429
                    },
                    {
                        "name": "novembre",
                        "flex": 4.285714285714286
                    },
                    {
                        "name": "décembre",
                        "flex": 4.428571428571429
                    },
                    {
                        "name": "janvier",
                        "flex": 4.428571428571429
                    },
                    {
                        "name": "février",
                        "flex": 4
                    },
                    {
                        "name": "mars",
                        "flex": 4.428571428571429
                    },
                    {
                        "name": "avril",
                        "flex": 4.285714285714286
                    },
                    {
                        "name": "mai",
                        "flex": 4.428571428571429
                    },
                    {
                        "name": "juin",
                        "flex": 4.285714285714286
                    },
                    {
                        "name": "juillet",
                        "flex": 4.428571428571429
                    }
                ],
                "weeks": [
                    36,
                    37,
                    38,
                    39,
                    40,
                    41,
                    42,
                    "F",
                    "F",
                    45,
                    46,
                    47,
                    48,
                    49,
                    50,
                    51,
                    "F",
                    "F",
                    2,
                    3,
                    4,
                    5,
                    6,
                    "F",
                    "F",
                    9,
                    10,
                    11,
                    12,
                    13,
                    14,
                    "F",
                    "F",
                    17,
                    18,
                    19,
                    20,
                    21,
                    22,
                    23,
                    24,
                    25,
                    26,
                    27,
                    28,
                    29
                ]
            },
            "activeWeeksPerClass": {},
            "info": {
                "room": "",
                "subject": "",
                "teacher": "",
                "lastClass": "Classe Sans Nom",
                "lastWeek": "2"
            }
        };
        /* MARKER:APPDATA_END */

        // Variable globale pour les données hebdomadaires (Source de vérité runtime)
        let studentWeeklyData = {};

        // Load studentWeeklyData from localStorage on startup
        try {
            const savedWeeklyData = localStorage.getItem('studentWeeklyData');
            if (savedWeeklyData) {
                studentWeeklyData = JSON.parse(savedWeeklyData);
                console.log("✓ Données hebdomadaires chargées depuis localStorage");
            }
        } catch (e) {
            console.error("Erreur chargement studentWeeklyData:", e);
        }

        // Reconstruire berliozData depuis appData (Source de vérité)
        function rebuildBerliozFromAppData() {
            berliozData.students = [];
            berliozData.studentsByClass = {};
            berliozData.classes = {};

            console.log("🔄 Reconstruction de berliozData depuis appData...");
            console.log("appData.students:", appData.students);

            if (appData.students) {
                Object.keys(appData.students).forEach(className => {
                    console.log(`  Traitement classe: ${className}`);
                    const classObj = appData.students[className];
                    console.log(`    Nombre d'entrées:`, Object.keys(classObj).length);

                    Object.keys(classObj).forEach(key => {
                        const s = classObj[key];
                        console.log(`    Élève trouvé:`, s.nom, s.prenom, "classe:", s.classe);
                        berliozData.students.push(s);
                        if (!berliozData.studentsByClass[s.classe]) {
                            berliozData.studentsByClass[s.classe] = [];
                            console.log(`      Création tableau pour classe: ${s.classe}`);
                        }
                        berliozData.studentsByClass[s.classe].push(s);
                        berliozData.classes[s.classe] = true;
                    });
                });
            }
            console.log("✓ berliozData reconstruit: " + berliozData.students.length + " élèves");
            console.log("✓ Classes trouvées:", Object.keys(berliozData.classes));
            console.log("✓ studentsByClass:", Object.keys(berliozData.studentsByClass).map(c => `${c}(${berliozData.studentsByClass[c].length})`).join(', '));
        }

        // Fonction de diagnostic et réparation
        function diagnoseAndRepair() {
            console.log("🔍 === DIAGNOSTIC COMPLET ===");

            // 1. Vérifier localStorage
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) {
                console.log("ℹ️ Aucune donnée dans localStorage (normal après reset ou au premier démarrage)");
                return false;
            }

            let data;
            try {
                data = JSON.parse(saved);
                console.log("✓ localStorage parsé avec succès");
                console.log("Clés dans appData:", Object.keys(data));
            } catch (e) {
                console.error("❌ Erreur parsing localStorage:", e);
                return false;
            }

            // 2. Vérifier structure students
            if (!data.students || Object.keys(data.students).length === 0) {
                console.log("ℹ️ Pas de données élèves dans appData.students (base vide)");
                return false;
            }

            console.log("✓ Élèves trouvés dans", Object.keys(data.students).length, "classes");

            // 3. Compter les élèves
            let totalStudents = 0;
            Object.keys(data.students).forEach(className => {
                const count = Object.keys(data.students[className]).length;
                totalStudents += count;
                console.log(`  ${className}: ${count} élèves`);
            });

            console.log(`✓ Total: ${totalStudents} élèves dans la base`);

            // 4. Vérifier berliozData
            console.log("berliozData.students.length:", berliozData.students.length);
            console.log("berliozData.classes:", Object.keys(berliozData.classes));

            if (berliozData.students.length === 0 && totalStudents > 0) {
                console.log("⚠️ berliozData vide mais appData contient des élèves - reconstruction...");
                rebuildBerliozFromAppData();
                generateClassesList();
                updateClassesPanel();
                console.log("✓ Reconstruction terminée");
                return true;
            }

            return true;
        }

        // Fonction pour créer un fichier de SAUVEGARDE COMPLÈTE (simple et fiable)
        async function saveStandaloneHTML(isAuto = false) {
            // CHECK: Si aucune base n'est ouverte, on bloque la sauvegarde (sauf auto)
            if (!isAuto) {
                const hasData = appData && appData.students && Object.keys(appData.students).length > 0;
                if (!hasData) {
                    alert("⛔ ACTION BLOQUÉE : Aucune base de données n'est ouverte.\n\nIl n'y a rien à sauvegarder.");
                    return;
                }
            }

            try {
                // 0. FORCER l'enregistrement de la fiche élève si elle est ouverte
                const sheetModal = document.getElementById('studentSheetModal');
                if (sheetModal && sheetModal.style.display !== 'none') {
                    console.log("⚠️ Fiche élève ouverte - Sauvegarde forcée des notes en cours...");

                    // CAPTURE MANUELLE DE SÉCURITÉ (Double vérification)
                    try {
                        const notesEl = document.getElementById('sheet-week-notes');
                        const statusEl = document.getElementById('sheet-week-status');
                        const studentJsonEl = document.getElementById('sheet-student-json');
                        const weekIdEl = document.getElementById('sheet-current-week');

                        if (notesEl && studentJsonEl && weekIdEl && weekIdEl.value) {
                            const student = JSON.parse(studentJsonEl.value);
                            const weekId = weekIdEl.value;
                            const key = `${student.classe}_${student.nom}_${student.prenom}_w${weekId}`;

                            // Mise à jour directe de la mémoire
                            if (!studentWeeklyData[key]) studentWeeklyData[key] = {};
                            studentWeeklyData[key].notes = notesEl.value;
                            studentWeeklyData[key].status = statusEl ? statusEl.value : '';
                            studentWeeklyData[key].timestamp = new Date().toLocaleString('fr-FR');

                            console.log("✅ Capture manuelle forcée pour:", key);
                            console.log("📝 Contenu:", notesEl.value.substring(0, 50));
                        }
                    } catch (e) {
                        console.error("Erreur capture manuelle:", e);
                    }

                    saveWeeklyData(false); // Sauvegarder sans afficher de confirmation
                }

                // 1. FORCER la synchronisation de TOUTES les données en cours
                synchronizeAllData();

                // 2. S'assurer que studentWeeklyData est bien dans appData.weeklyReports
                if (!appData.weeklyReports) appData.weeklyReports = {};
                appData.weeklyReports = JSON.parse(JSON.stringify(studentWeeklyData));
                console.log("✓ Notes pédagogiques synchronisées:", Object.keys(appData.weeklyReports).length, "fiches");

                // 3. Capturer EXPLICITEMENT toutes les modifications en cours
                // S'assurer que la répartition actuelle est bien capturée
                const currentClass = getClassName();
                if (currentClass && currentWeekId !== null) {
                    if (!weeklyPlans[currentClass]) weeklyPlans[currentClass] = {};
                    weeklyPlans[currentClass][currentWeekId] = getSnapshot();
                    console.log("✓ Répartition actuelle capturée pour", currentClass, "semaine", currentWeekId);
                }

                // 4. Créer une sauvegarde ULTRA-COMPLÈTE de tout
                const completeSave = {
                    // DONNÉES PRINCIPALES
                    appData: JSON.parse(JSON.stringify(appData)), // Clone profond pour éviter les références

                    // RÉPARTITIONS (toutes les classes, toutes les semaines)
                    weeklyPlans: JSON.parse(JSON.stringify(weeklyPlans)),

                    // SEMAINES ACTIVES par classe
                    activeWeeksPerClass: JSON.parse(JSON.stringify(activeWeeksPerClass)),

                    // FICHES ÉLÈVES (toutes les notes, tous les statuts)
                    studentWeeklyData: JSON.parse(JSON.stringify(studentWeeklyData)),

                    // MÉTADONNÉES
                    savedDate: new Date().toISOString(),
                    savedDateReadable: new Date().toLocaleString('fr-FR'),
                    currentClass: currentClass,
                    currentWeek: currentWeekId,
                    version: "Sauvegarde Complète v1.0",
                    description: "Fichier de sauvegarde complète - Toutes classes, répartitions, fiches élèves, notes pédagogiques",

                    // PARAMÈTRES UTILISATEUR (Sauvegardés dans le JSON)
                    settings: {
                        dbName: localStorage.getItem('dbName') || 'plan_de_classe_backup',
                        autoSaveInterval: localStorage.getItem('autoSaveInterval') || 5,
                        autoSaveEnabled: localStorage.getItem('autoSaveEnabled') || 'false',
                        appPassword: localStorage.getItem('appPassword') || ''
                    }
                };

                // 5. Compter ce qui est sauvegardé pour information
                let totalClasses = Object.keys(completeSave.appData.students || {}).length;
                let totalStudents = 0;
                Object.values(completeSave.appData.students || {}).forEach(classe => {
                    totalStudents += Object.keys(classe).length;
                });
                let totalWeekPlans = 0;
                Object.values(completeSave.weeklyPlans || {}).forEach(classWeeks => {
                    totalWeekPlans += Object.keys(classWeeks).length;
                });
                let totalFiches = Object.keys(completeSave.studentWeeklyData || {}).length;
                let totalNotesPeda = Object.keys(completeSave.appData.weeklyReports || {}).length;

                console.log("📦 SAUVEGARDE:", totalClasses, "classes,", totalStudents, "élèves,", totalWeekPlans, "répartitions,", totalNotesPeda, "notes pédagogiques");

                // 6. Convertir en JSON
                const jsonString = JSON.stringify(completeSave, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });

                // 7. Sauvegarde avec choix du dossier (si supporté par le navigateur)
                const dbName = localStorage.getItem('dbName') || 'SAUVEGARDE_COMPLETE';
                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '_');
                const suggestedName = `${dbName}_${dateStr}`;
                let saveSuccess = false;
                let finalFileName = suggestedName;

                try {
                    // AUTO SAVE MODE
                    if (isAuto) {
                        // 1. Try to use the File System Access Handle if available
                        if (autoSaveFileHandle) {
                            try {
                                const writable = await autoSaveFileHandle.createWritable();
                                await writable.write(jsonString);
                                await writable.close();
                                console.log("✅ Auto-save executed to handle:", autoSaveFileHandle.name);
                                return;
                            } catch (err) {
                                console.warn("Auto-save handle failed (permission lost?), falling back to download.", err);
                                // Fallback to download if handle fails (e.g. permission expired)
                            }
                        }

                        // 2. Fallback: Download method
                        const dbName = localStorage.getItem('dbName') || 'plan_de_classe_backup';
                        const fileName = `${dbName}_${dateStr}`;

                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName + '.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        console.log("✅ Auto-save executed (Download):", fileName);
                        return; // Exit silently
                    }

                    // OPTION A: API Moderne (Chrome, Edge, Opera) - Ouvre une vraie fenêtre "Enregistrer sous"
                    if (window.showSaveFilePicker) {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: suggestedName + '.json',
                            types: [{
                                description: 'Sauvegarde logiciel',
                                accept: { 'application/json': ['.json'] },
                            }],
                        });
                        const writable = await handle.createWritable();
                        await writable.write(jsonString);
                        await writable.close();
                        saveSuccess = true;
                        finalFileName = handle.name;
                    } else {
                        throw new Error("API non supportée");
                    }
                } catch (err) {
                    // Si l'utilisateur annule, on arrête tout
                    if (err.name === 'AbortError') return;

                    // OPTION B: Fallback (Firefox, Safari) - Téléchargement classique
                    // Note: Pour choisir le dossier dans Firefox, il faut régler le navigateur sur "Toujours demander où enregistrer les fichiers"
                    const fileName = prompt("💾 Nom du fichier (le dossier dépend des réglages de votre navigateur):", suggestedName);

                    if (fileName) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName + '.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        saveSuccess = true;
                        finalFileName = fileName + '.json';
                    }
                }

                if (saveSuccess) {
                    console.log("✅ Sauvegarde terminée:", finalFileName);
                    alert('✅ SAUVEGARDE COMPLÈTE CRÉÉE!\n\n' +
                        '📁 Fichier: ' + finalFileName + '\n\n' +
                        '📦 CONTENU SAUVEGARDÉ:\n' +
                        '• ' + totalClasses + ' classes\n' +
                        '• ' + totalStudents + ' élèves\n' +
                        '• ' + totalWeekPlans + ' répartitions de classe\n' +
                        '• ' + totalNotesPeda + ' notes pédagogiques\n' +
                        '• Toutes les fiches élèves\n' +
                        '• Tous les statuts et observations\n' +
                        '• Tous les calendriers\n\n' +
                        '💡 UTILISATION:\n' +
                        '1. Copiez ce fichier sur clé USB ou cloud\n' +
                        '2. Sur un autre ordinateur, ouvrez le logiciel\n' +
                        '3. Cliquez "Charger" et sélectionnez ce fichier\n' +
                        '4. TOUT sera restauré!\n\n' +
                        '✨ Simple, rapide, fiable!');
                }
            } catch (err) {
                console.error("Erreur sauvegarde complète:", err);
                alert("Erreur lors de la sauvegarde: " + err.message);
            }
        }

        // Helper to animate indicators when data is loaded
        function animateBaseLoadIndicators() {
            const red = document.getElementById('indicator-red');
            const green = document.getElementById('indicator-green');
            if (!red || !green) return;

            // Red OFF
            red.classList.remove('indicator-on-red');

            // Green Animation (Blink)
            green.classList.add('indicator-blinking');

            // After 10 blinks (approx 3s), go steady Green
            setTimeout(() => {
                green.classList.remove('indicator-blinking');
                green.classList.add('indicator-on-green');
            }, 3000);
        }

        // Charger les données depuis localStorage au démarrage
        function loadAppData() {
            // Restore persistent filename
            const savedName = localStorage.getItem('currentDocName');
            if (savedName) {
                currentDocName = savedName;
                const display = document.getElementById('baseNameDisplay');
                if (display) display.textContent = currentDocName;
            }

            // Check for URL params for "Open in New Tab" action
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');

            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                    
                    // Vérifier et initialiser lockSettings s'il n'existe pas
                    if (!appData.lockSettings) {
                        appData.lockSettings = {
                            enabled: false,
                            lockDate: "2026-06-30T23:59",
                            password: "",
                            isUnlocked: false
                        };
                        console.log("🔒 lockSettings initialisé lors du chargement");
                    }
                    
                    console.log("✓ Données chargées depuis localStorage");
                    animateBaseLoadIndicators(); // Trigger Visual Indicator

                    // Restore weeklyPlans from appData.plans if present
                    if (appData.plans) {
                        weeklyPlans = JSON.parse(JSON.stringify(appData.plans));
                        console.log("✓ weeklyPlans restaurés:", Object.keys(weeklyPlans));
                    }
                    // HANDLE URL ACTION AFTER DATA LOAD (No password check for new tab)
                    if (action === 'openSheet') {
                        const className = urlParams.get('class');
                        const nom = urlParams.get('nom');
                        const prenom = urlParams.get('prenom');
                        const weekId = urlParams.get('week');

                        // Wait a bit for DOM to be ready
                        setTimeout(() => {
                            if (className && nom && prenom && appData.students && appData.students[className]) {
                                // Reconstruct key
                                const studentKey = `${className}_${nom}_${prenom}`;
                                const student = appData.students[className][studentKey];
                                if (student) {
                                    // Flag: Skip password protection for new tab from annual summary
                                    window.skipPasswordProtection = true;
                                    openStudentSheet(student);
                                    if (weekId) {
                                        selectWeekInSheet(weekId, student);
                                    }
                                }
                            }
                        }, 500);
                    }

                    // Restore activeWeeksPerClass if present
                    if (appData.activeWeeksPerClass) {
                        activeWeeksPerClass = JSON.parse(JSON.stringify(appData.activeWeeksPerClass));
                        console.log("✓ activeWeeksPerClass restaurés:", Object.keys(activeWeeksPerClass));
                    }

                    // Restore Calendar if present
                    if (appData.calendar) {
                        CALENDAR_DATA = JSON.parse(JSON.stringify(appData.calendar));
                        console.log("✓ CALENDAR_DATA restauré depuis appData");
                    }

                    // Rebuild berliozData from appData.students so UI lists work
                    rebuildBerliozFromAppData();

                    // Remove duplicates that may have been persisted
                    try { removeDuplicateStudents(); } catch (e) { console.warn('removeDuplicateStudents failed', e); }

                    // Restore per-student weekly data if present
                    if (appData.weeklyReports) {
                        studentWeeklyData = appData.weeklyReports;
                        console.log(`✓ ${Object.keys(studentWeeklyData).length} notes hebdomadaires restaurées depuis appData`);
                    } else {
                        studentWeeklyData = {};
                        console.warn("⚠️ Aucune note hebdomadaire trouvée dans la sauvegarde (appData.weeklyReports vide)");
                    }
                    
                    // Update RDV display after data load
                    if (typeof updateClassRDVDisplay === 'function') {
                        setTimeout(updateClassRDVDisplay, 300);
                    }

                    return true;
                } catch (err) {
                    console.error("Erreur chargement données:", err);
                    return false;
                }
            }
            return false;
        }

        // Synchronise toutes les données volatiles dans l'objet appData
        function synchronizeAllData() {
            // 1. Capturer l'état actuel de la semaine affichée
            const className = getClassName();
            if (className && currentWeekId !== null) {
                if (!appData.plans) appData.plans = {};
                if (!appData.plans[className]) appData.plans[className] = {};
                appData.plans[className][currentWeekId] = getSnapshot();
            }

            // 2. Synchroniser weeklyPlans vers appData.plans (pour toutes les classes et semaines)
            appData.plans = JSON.parse(JSON.stringify(weeklyPlans));

            // 2b. Synchroniser activeWeeksPerClass
            appData.activeWeeksPerClass = JSON.parse(JSON.stringify(activeWeeksPerClass));

            // 2c. Synchroniser CALENDAR_DATA
            appData.calendar = CALENDAR_DATA;

            // 3. Capturer les infos générales (Global & Per Class)
            const roomVal = document.getElementById('roomName')?.value || '';
            const subjVal = document.getElementById('subjectName')?.value || '';

            appData.info = {
                room: roomVal,
                subject: subjVal,
                teacher: document.getElementById('teacherNameInput')?.value || '',
                lastClass: className,
                lastWeek: currentWeekId // Save current week for restoration
            };

            if (className) {
                if (!appData.classes) appData.classes = {};
                if (!appData.classes[className]) appData.classes[className] = { students: [] };
                appData.classes[className].room = roomVal;
                appData.classes[className].subject = subjVal;
            }

            // 4. Capturer les statuts/fiches élèves
            appData.weeklyReports = JSON.parse(JSON.stringify(studentWeeklyData));

            // 5. Capturer les couleurs personnalisées et rubriques si nécessaire
            // (Lés variables globales appData.studentColors etc. sont normalement déjà à jour)
        }

        // Sauvegarder automatiquement dans localStorage
        function saveAppData() {
            synchronizeAllData();
            appData.lastUpdate = new Date().toISOString();
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                localStorage.setItem('studentWeeklyData', JSON.stringify(studentWeeklyData)); // Also save weekly data separately
                console.log("✓ Données sauvegardées dans localStorage");
                return true;
            } catch (err) {
                console.error("Erreur sauvegarde:", err);
                return false;
            }
        }

        // Archiver l'année scolaire
        function archiveSchoolYear() {
            const archives = JSON.parse(localStorage.getItem(ARCHIVE_KEY) || '[]');
            const archiveData = JSON.parse(JSON.stringify(appData));
            archiveData.archivedDate = new Date().toISOString();
            archives.push(archiveData);
            localStorage.setItem(ARCHIVE_KEY, JSON.stringify(archives));
            console.log("✓ Année scolaire archivée");
        }

        // Print Settings
        let printSettings = {
            orientation: 'portrait',
            autoScale: true,
            scale: 100,
            hideDesk: false,
            hideNames: false
        };

        // Global handle for auto-save
        let autoSaveFileHandle = null;

        // --- AUTO-SAVE SYSTEM ---
        // Debounced auto-save to prevent excessive writes
        let autoSaveTimeout = null;

        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                autoSavePlan();
            }, 1500); // Save after 1.5 seconds of inactivity
        }

        async function autoSavePlan() {
            // Save current layout snapshot per class/week so every class distribution is independent
            try {
                if (currentWeekId !== null) {
                    const className = getClassName();
                    if (className) {
                        if (!appData.plans) appData.plans = {};
                        if (!appData.plans[className]) appData.plans[className] = {};
                        appData.plans[className][currentWeekId] = getSnapshot();
                    }
                }
            } catch (err) {
                console.warn('Auto-save snapshot failed', err);
            }

            // Sauvegarder aussi dans appData général
            saveAppData();
        }

        // Hook auto-save to key events
        function setupAutoSaveHooks() {
            // Drag end (student moved)
            document.addEventListener('dragend', () => scheduleAutoSave());

            // Status change (student status clicked)
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('student-status')) {
                    scheduleAutoSave();
                }
                // Absence toggle
                if (e.target.closest('.student-card') && !e.target.classList.contains('student-status')) {
                    if (!isEditMode) scheduleAutoSave();
                }
            });

            // Table position changed (tables dragged)
            document.addEventListener('mouseup', (e) => {
                if (isEditMode && activeDragElement) {
                    scheduleAutoSave();
                }
            });
        }

        // --- CALENDAR DATA DEFINITION ---
        // Pronote Calendar Model (Exact copy from user image and boundary descriptions)
        /* MARKER:CALENDAR_DATA_START */
        let CALENDAR_DATA = {
            "months": [
                {
                    "name": "septembre",
                    "flex": 4.285714285714286
                },
                {
                    "name": "octobre",
                    "flex": 4.428571428571429
                },
                {
                    "name": "novembre",
                    "flex": 4.285714285714286
                },
                {
                    "name": "décembre",
                    "flex": 4.428571428571429
                },
                {
                    "name": "janvier",
                    "flex": 4.428571428571429
                },
                {
                    "name": "février",
                    "flex": 4
                },
                {
                    "name": "mars",
                    "flex": 4.428571428571429
                },
                {
                    "name": "avril",
                    "flex": 4.285714285714286
                },
                {
                    "name": "mai",
                    "flex": 4.428571428571429
                },
                {
                    "name": "juin",
                    "flex": 4.285714285714286
                },
                {
                    "name": "juillet",
                    "flex": 4.428571428571429
                }
            ],
            "weeks": [
                36,
                37,
                38,
                39,
                40,
                41,
                42,
                "F",
                "F",
                45,
                46,
                47,
                48,
                49,
                50,
                51,
                "F",
                "F",
                2,
                3,
                4,
                5,
                6,
                "F",
                "F",
                9,
                10,
                11,
                12,
                13,
                14,
                "F",
                "F",
                17,
                18,
                19,
                20,
                21,
                22,
                23,
                24,
                25,
                26,
                27,
                28,
                29
            ]
        };
        /* MARKER:CALENDAR_DATA_END */
        // NOTE: CALENDAR_DATA will be auto-generated inside initCalendar if empty

        // --- SELF-SAVING FUNCTIONALITY ---
        async function saveSoftwareState() {
            // CHECK: Si une base est ouverte, on bloque la sauvegarde du logiciel
            const hasData = appData && appData.students && Object.keys(appData.students).length > 0;
            if (hasData) {
                alert("⛔ ACTION BLOQUÉE : Une base de données est actuellement ouverte.\n\nVous ne pouvez pas écraser le logiciel vide avec des données chargées. Utilisez 'Sauvegarde Clé USB/Cloud' pour sauvegarder vos données.");
                return;
            }

            try {
                // 1. Get current HTML source logic
                // STRATEGY: We take the current outerHTML, but we accept that the saved file will have the "current view" pre-rendered.
                // This is acceptable as init() functions generally clear containers (innerHTML='') before re-rendering.

                let htmlContent = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;

                // 2. Prepare Data for Injection
                // We need to ensure we serialize correctly (avoid circular refs if any, though appData shouldn't have any)
                const appDataJson = JSON.stringify(appData, null, 4);
                const calendarJson = JSON.stringify(CALENDAR_DATA, null, 4);

                // 3. Inject appData
                const appDataStartMarker = "/* MARKER:APPDATA_START */";
                const appDataEndMarker = "/* MARKER:APPDATA_END */";
                const appDataRegex = new RegExp(`(${escapeRegExp(appDataStartMarker)})[\\s\\S]*?(${escapeRegExp(appDataEndMarker)})`);

                if (htmlContent.match(appDataRegex)) {
                    const newAppDataBlock = `${appDataStartMarker}\n        let appData = ${appDataJson};\n        ${appDataEndMarker}`;
                    htmlContent = htmlContent.replace(appDataRegex, newAppDataBlock);
                } else {
                    console.warn("Marker appData not found, persisting only Calendar?");
                }

                // 4. Inject CALENDAR_DATA
                const calStartMarker = "/* MARKER:CALENDAR_DATA_START */";
                const calEndMarker = "/* MARKER:CALENDAR_DATA_END */";
                const calRegex = new RegExp(`(${escapeRegExp(calStartMarker)})[\\s\\S]*?(${escapeRegExp(calEndMarker)})`);

                if (htmlContent.match(calRegex)) {
                    const newCalBlock = `${calStartMarker}\n        let CALENDAR_DATA = ${calendarJson};\n        ${calEndMarker}`;
                    htmlContent = htmlContent.replace(calRegex, newCalBlock);
                }

                // 5. Clean up "dirty" DOM states / Visual artifacts
                // Remove displays blocks that shouldn't be there on startup
                htmlContent = htmlContent.replace(/style="display:\s*block;"/g, 'style="display:none;"')
                    .replace(/style="display:\s*flex;"/g, 'style="display:none;"');

                // 6. Save File using Chrome/Edge File System API OR Fallback
                const fileName = `plan_de_classe_complet_${new Date().toISOString().slice(0, 10)}.html`;
                const blob = new Blob([htmlContent], { type: 'text/html' });

                if (window.showSaveFilePicker) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: fileName,
                            types: [{
                                description: 'Application logiciel (.html)',
                                accept: { 'text/html': ['.html'] },
                            }],
                        });
                        const writable = await handle.createWritable();
                        await writable.write(blob);
                        await writable.close();

                        alert("✓ LOGICIEL SAUVEGARDÉ !\n\nVous avez créé une nouvelle version autonome du logiciel :\n" + handle.name + "\n\nCette version contient toutes vos données et votre calendrier à jour.");
                    } catch (pickerErr) {
                        if (pickerErr.name === 'AbortError') {
                            // User cancelled, do nothing
                            return;
                        }
                        throw pickerErr;
                    }
                } else {
                    // Fallback for Firefox/Safari
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    alert("✓ LOGICIEL SAUVEGARDÉ (Dossier Téléchargement) !\n\nLe fichier '" + fileName + "' a été généré.\nIl contient le logiciel complet avec vos données.");
                }

            } catch (e) {
                console.error("Save Software Error:", e);
                alert("Erreur lors de la sauvegarde du logiciel: " + e.message);
            }
        }
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialiser le système de sauvegarde
            const dataLoaded = loadAppData();  // Charger les données depuis localStorage
            console.log("=== INITIALIZATION ===");
            console.log("Data loaded:", dataLoaded);
            console.log("appData.students:", appData.students ? Object.keys(appData.students) : 'none');
            console.log("berliozData.students:", berliozData.students.length);
            console.log("berliozData.classes:", Object.keys(berliozData.classes));

            // Vérifier le verrouillage dès le chargement
            setTimeout(() => {
                checkLockAndShowWarning();
            }, 300);

            // Diagnostic automatique
            setTimeout(() => {
                diagnoseAndRepair();
            }, 500);

            // Setup className listener
            const classInput = document.getElementById('className');
            if (classInput) {
                classInput.addEventListener('change', onClassNameChange);
            }
            lastActiveClassName = getClassName();

            // Rebuild UI from loaded data: classes, sidebar FIRST
            generateClassesList();
            updateClassesPanel();

            // Ne PAS charger de classe par défaut - démarrer vide
            // Set the class name BEFORE initializing calendar
            // const lastClass = (appData.info && appData.info.lastClass) || getClassName() || lastActiveClassName || Object.keys(berliozData.classes)[0];
            // if (lastClass) {
            //     document.getElementById('className').value = lastClass;
            //     lastActiveClassName = lastClass;
            //     if (typeof updateClassRDVDisplay === 'function') setTimeout(updateClassRDVDisplay, 500);
            // }

            // Initialize calendar AFTER class is set (this will call selectWeek)
            initCalendar();
            setupAutoSaveHooks();

            // Ne PAS charger d'élèves au démarrage - démarrer vide
            // Load students for the class (this will restore the week's snapshot)
            // if (lastClass) {
            //     showClassStudents(lastClass);
            // }

            // Background click to clear selection
            document.getElementById('classroomArea').addEventListener('mousedown', (e) => {
                if (isEditMode && e.target === document.getElementById('classroomArea')) {
                    clearSelection();
                }
            });

            // Démarrer l'horloge directement (mot de passe supprimé)
            startClockUpdates();
            
            // Mettre à jour les indicateurs de base
            updateBaseIndicators();

            // Start usage timer - multiple attempts to ensure it starts
            console.log('🕐 Attempting to start usage timer...');
            
            const startTimer = () => {
                const timerEl = document.getElementById('usageTimer');
                console.log('Timer element check:', timerEl ? 'FOUND' : 'NOT FOUND');
                if (timerEl) {
                    startUsageTimer();
                    return true;
                }
                return false;
            };
            
            // Try immediately
            if (!startTimer()) {
                // Try after 50ms
                setTimeout(() => {
                    if (!startTimer()) {
                        // Try after 200ms
                        setTimeout(() => {
                            if (!startTimer()) {
                                console.error('❌ Failed to start usage timer after multiple attempts');
                            }
                        }, 200);
                    }
                }, 50);
            }

            // Auto-save before window unload
            window.addEventListener('beforeunload', (e) => {
                // Sauvegarde synchrone immédiate
                saveAppData();
                // Note: On ne peut pas garantir le téléchargement du backup ici sur tous les navigateurs
            });

            // FORCE "Mode: Placer Élèves" par défaut au démarrage
            // isEditMode = false -> Mode Placer Élèves (élèves déplaçables, tables fixes)
            // isEditMode = true  -> Mode Aménager Classe (tables déplaçables, élèves fixes)
            toggleEditMode(false); // Force le mode "Placer Élèves"

            // Initialize CPE names list
            updateCpeNamesList();

            // Start in Agenda View
            toggleAgendaView();

            console.log("✓ App initialisée avec données persistantes");
        });

        function startClockUpdates() {
            function update() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateStr = now.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });

                // Update all clock instances (main UI + modals)
                document.querySelectorAll('.sheetClockDisplay').forEach(el => el.textContent = timeStr);
                document.querySelectorAll('.sheetDateDisplay').forEach(el => el.textContent = dateStr);
            }
            update(); // Immediate
            setInterval(update, 1000);
        }

        // Usage Timer - Track session time
        let usageStartTime = null;
        let usageTimerInterval = null;
        
        function startUsageTimer() {
            console.log('🕐 startUsageTimer called');
            
            // Clear any existing interval
            if (usageTimerInterval) {
                clearInterval(usageTimerInterval);
                console.log('Cleared existing interval');
            }
            
            // Set start time
            usageStartTime = Date.now();
            console.log('Start time set:', new Date(usageStartTime).toLocaleTimeString());
            
            function updateTimer() {
                if (!usageStartTime) return;
                
                const elapsed = Math.floor((Date.now() - usageStartTime) / 1000); // seconds
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                const timerEl = document.getElementById('usageTimer');
                if (timerEl) {
                    timerEl.textContent = timeStr;
                } else {
                    console.error('Timer element not found!');
                }
            }
            
            // Update immediately
            updateTimer();
            
            // Update every second
            usageTimerInterval = setInterval(updateTimer, 1000);
            console.log('✅ Usage timer interval started, ID:', usageTimerInterval);
        }

        // --- INDEXED DB FOR FILE HANDLES ---
        const DB_NAME = 'PlanDeClasseDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'fileHandles';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function saveFileHandle(handle) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(handle, 'autoSaveHandle');
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async function getFileHandle() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get('autoSaveHandle');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function verifyPermission(fileHandle, readWrite) {
            const options = {};
            if (readWrite) {
                options.mode = 'readwrite';
            }
            if ((await fileHandle.queryPermission(options)) === 'granted') {
                return true;
            }
            if ((await fileHandle.requestPermission(options)) === 'granted') {
                return true;
            }
            return false;
        }

        // --- SETTINGS & AUTO-SAVE ---
        let autoSaveIntervalId = null;

        async function openSettingsModal() {
            const modal = document.getElementById('settingsModal');

            // Vérifier le verrouillage au démarrage
            checkLockAndShowWarning();

            // Load values
            // FIXED: Default DB Name updated to "sauvegardebasecomplete2025_2026"
            document.getElementById('setting-db-name').value = localStorage.getItem('dbName') || 'sauvegardebasecomplete2025_2026';
            document.getElementById('setting-autosave-interval').value = localStorage.getItem('autoSaveInterval') || 5;
            document.getElementById('setting-autosave-enable').checked = (localStorage.getItem('autoSaveEnabled') === 'true');
            document.getElementById('setting-school-year').value = appData.schoolYear || 2025;

            // Password fields are empty by default
            document.getElementById('setting-password').value = '';
            document.getElementById('setting-password-confirm').value = '';

            // Show file status
            const statusInput = document.getElementById('setting-save-dir');
            // Set default descriptive path if empty (visual only, actual handle is managed by browser security)
            if (!statusInput.value && !autoSaveFileHandle) {
                statusInput.placeholder = "C:\\gravity\\gravity (ou autre)";
            }
            const btnContainer = statusInput.parentNode;

            // Remove old verify button if exists
            const oldBtn = document.getElementById('btn-verify-handle');
            if (oldBtn) oldBtn.remove();

            if (autoSaveFileHandle) {
                // Check permission
                const hasAccess = (await autoSaveFileHandle.queryPermission({ mode: 'readwrite' })) === 'granted';

                if (hasAccess) {
                    statusInput.value = "✅ Actif: " + autoSaveFileHandle.name;
                } else {
                    statusInput.value = "⚠️ " + autoSaveFileHandle.name + " (Accès requis)";

                    // Add Verify Button
                    const verifyBtn = document.createElement('button');
                    verifyBtn.id = 'btn-verify-handle';
                    verifyBtn.textContent = "Autoriser";
                    verifyBtn.style.backgroundColor = "#FF9800";
                    verifyBtn.style.color = "black";
                    verifyBtn.onclick = async () => {
                        if (await verifyPermission(autoSaveFileHandle, true)) {
                            statusInput.value = "✅ Actif: " + autoSaveFileHandle.name;
                            verifyBtn.remove();
                            alert("Accès autorisé !");
                        } else {
                            alert("Accès refusé.");
                        }
                    };
                    btnContainer.appendChild(verifyBtn);
                }
            } else {
                const lastFile = localStorage.getItem('lastAutoSaveFileName');
                if (lastFile) {
                    statusInput.value = "⚠️ Précédent: " + lastFile + " (Re-sélectionner)";
                } else {
                    statusInput.value = "C:\\gravity\\gravity"; // Default suggestion displayed
                }
            }

            modal.style.display = 'flex';
        }

        async function pickAutoSaveLocation() {
            if (!window.showSaveFilePicker) {
                alert("Votre navigateur ne supporte pas la sélection de dossier avancée (API File System Access). Utilisez Chrome, Edge ou Opera.");
                return;
            }

            try {
                const dbName = document.getElementById('setting-db-name').value.trim() || 'plan_de_classe_backup';
                const handle = await window.showSaveFilePicker({
                    suggestedName: dbName + '.json',
                    types: [{
                        description: 'Sauvegarde logiciel',
                        accept: { 'application/json': ['.json'] },
                    }],
                });

                autoSaveFileHandle = handle;
                localStorage.setItem('lastAutoSaveFileName', handle.name); // Save name
                await saveFileHandle(handle); // Save handle to IndexedDB

                document.getElementById('setting-save-dir').value = "✅ Actif: " + handle.name;
                alert("Emplacement de sauvegarde défini ! Les sauvegardes automatiques écraseront ce fichier.");
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error("Erreur sélection fichier:", err);
                    alert("Erreur lors de la sélection du fichier.");
                }
            }
        }

        function saveSettings() {
            const dbName = document.getElementById('setting-db-name').value.trim() || 'plan_de_classe_backup';
            const interval = parseInt(document.getElementById('setting-autosave-interval').value) || 5;
            const enabled = document.getElementById('setting-autosave-enable').checked;
            const sYear = parseInt(document.getElementById('setting-school-year').value) || 2025;

            const pass = document.getElementById('setting-password').value;
            const passConfirm = document.getElementById('setting-password-confirm').value;

            if (pass || passConfirm) {
                if (pass !== passConfirm) {
                    alert("Les mots de passe ne correspondent pas.");
                    return;
                }
                localStorage.setItem('appPassword', pass);
                alert("Mot de passe mis à jour.");
            }

            localStorage.setItem('dbName', dbName);
            localStorage.setItem('autoSaveInterval', interval);
            localStorage.setItem('autoSaveEnabled', enabled);

            // Save School Year
            if (sYear !== appData.schoolYear) {
                appData.schoolYear = sYear;
                // Force Calendar Refresh
                CALENDAR_DATA = generateAutoCalendar(); // Regenerate fully for new year structure
                initCalendar();
                alert(`Année scolaire définie sur ${sYear}-${sYear + 1}.\nLe calendrier a été recalculé.`);
            }

            startAutoSaveLoop();
            document.getElementById('settingsModal').style.display = 'none';
            // alert("Paramètres enregistrés."); // merged into above logic or implicit
        }

        function startAutoSaveLoop() {
            if (autoSaveIntervalId) clearInterval(autoSaveIntervalId);

            const enabled = (localStorage.getItem('autoSaveEnabled') === 'true');
            if (!enabled) return;

            const intervalMin = parseInt(localStorage.getItem('autoSaveInterval')) || 5;
            const intervalMs = intervalMin * 60 * 1000;

            console.log(`Auto-save enabled. Interval: ${intervalMin} min.`);

            autoSaveIntervalId = setInterval(() => {
                console.log("Triggering Auto-Save...");
                saveStandaloneHTML(true); // true = auto mode (silent or specific naming)
            }, intervalMs);
        }

        function checkPass() {
            const storedPass = localStorage.getItem('appPassword');
            if (!storedPass) {
                // No password set
                document.getElementById('securityOverlay').style.display = 'none';
                startClockUpdates();
                startAutoSaveLoop(); // Start auto-save on login
                return;
            }

            const input = document.getElementById('passInput').value;
            if (input === storedPass) {
                document.getElementById('securityOverlay').style.display = 'none';
                startClockUpdates();
                startAutoSaveLoop(); // Start auto-save on login
            } else {
                document.getElementById('passError').style.display = 'block';
            }
        }

        // Initialize on load
        window.addEventListener('load', async () => {
            // Restore File Handle from IndexedDB
            try {
                const handle = await getFileHandle();
                if (handle) {
                    autoSaveFileHandle = handle;
                    console.log("✅ File Handle restored from IndexedDB:", handle.name);
                }
            } catch (e) {
                console.warn("Could not restore file handle:", e);
            }

            const urlParams = new URLSearchParams(window.location.search);
            const isDeepLink = urlParams.get('action') === 'openSheet';
            // Allow skip signal from loadAppData or direct deep link check
            if (isDeepLink) window.skipPasswordProtection = true;

            const storedPass = localStorage.getItem('appPassword');
            if (storedPass && !window.skipPasswordProtection) {
                document.getElementById('securityOverlay').style.display = 'flex';
            } else {
                document.getElementById('securityOverlay').style.display = 'none';
                startClockUpdates();
                startAutoSaveLoop();
            }
        });

        function getClassName() {
            let name = document.getElementById('className').value.trim();
            if (!name) {
                if (currentDocName) return currentDocName;
                return "Classe Sans Nom";
            }
            return name;
        }

        // Helper to get current ISO week number
        function getISOWeek(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getCurrentSchoolWeekId() {
            const now = new Date();
            const currentISOWeek = getISOWeek(now);

            // Simple mapping: check if current ISO week exists in our calendar
            // Note: This assumes the calendar weeks match ISO weeks roughly.
            // If it's a holiday (F), we might want to find the closest week or just return the week number if it exists.

            // Check if the week exists in our generated buttons
            const stripContainer = document.getElementById('calendarStrip');
            if (!stripContainer) return null;

            const buttons = Array.from(stripContainer.children);
            // Try to find a button with text content matching current ISO week
            const match = buttons.find(btn => btn.textContent === String(currentISOWeek));

            if (match) {
                return match.dataset.id;
            }

            // If not found (e.g. holiday or out of range), try to find by index?
            // Or just default to null and let fallback handle it.
            return null;
        }

        // --- CALENDAR INITIALIZATION & MANAGEMENT ---
        // Initializes the school year calendar with all weeks and holidays
        // --- CALENDAR HELPERS (Auto-generation logic) ---
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function generateAutoCalendar() {
            // Génération précise Pixel-Perfect pour l'alignement des mois
            const startYear = (typeof appData !== 'undefined' && appData.schoolYear) ? parseInt(appData.schoolYear) : 2025;
            const startDate = new Date(startYear, 8, 1); // 1er Sept
            // Reculer au Lundi de cette semaine (Début Calendrier)
            let day = startDate.getDay() || 7;
            startDate.setDate(startDate.getDate() - (day - 1));

            // Fin du calendrier (mi-juillet année suivante)
            const endDate = new Date(startYear + 1, 6, 20);

            // 1. Générer la liste des semaines (Boutons du bas)
            let weeksList = [];
            let currentWk = new Date(startDate);
            while (currentWk < endDate) {
                weeksList.push(getWeekNumber(currentWk));
                currentWk.setDate(currentWk.getDate() + 7);
            }

            // 2. Générer la liste des mois avec largeur précise (en semaines fractionnaires)
            // On parcourt le temps jour par jour ou on calcule les intersections
            let monthsList = [];

            // Curseur pour début de mois à traiter dans la timeline
            let cursor = new Date(startDate);

            while (cursor < endDate) {
                // Mois actuel du curseur
                let mIndex = cursor.getMonth();
                let y = cursor.getFullYear();

                // Fin du mois actuel
                // astuce: jour 0 du mois suivant = dernier jour ce mois
                let endOfMonth = new Date(y, mIndex + 1, 0);

                // L'intervalle effectif de ce mois dans notre vue calendrier
                // Début: cursor. Fin: Min(FinMois, FinCalendrier)
                let effectiveStart = new Date(cursor);
                let effectiveEnd = (endOfMonth < endDate) ? endOfMonth : new Date(endDate);
                effectiveEnd.setHours(23, 59, 59, 999); // Inclure toute la journée

                // Calculer durée en jours
                let diffTime = effectiveEnd - effectiveStart;
                let diffDays = (Math.ceil(diffTime / (1000 * 60 * 60 * 24))) + (endOfMonth < endDate ? 0 : 0);
                // Note: Math.ceil est risqué avec les changements d'heure, mais on reste en UTC midi si possible.
                // Mieux: diffDays = (effectiveEnd.getTime() - effectiveStart.getTime()) / 86400000;
                // On va supposer des journées complètes.
                // Le curseur est à minuit (début de journée).
                // Si fin du mois est le 30 à minuit? non le 30 à 23h59.
                // Une approche plus simple: compter combien de jours de ce mois tombent dans l'intervalle [startDate, endDate]

                let mName = cursor.toLocaleDateString('fr-FR', { month: 'long' });

                // Combien de jours de ce mois sont APRES ou EGAL à startDate et AVANT endDate ?
                // Le mois va de 1er à FinMois.
                // Intersection: [Max(StartCal, StartMonth), Min(EndCal, EndMonth)]

                let monthStartComplete = new Date(y, mIndex, 1);
                let monthEndComplete = new Date(y, mIndex + 1, 0);

                // Ajuster limites
                let interStart = (monthStartComplete < startDate) ? startDate : monthStartComplete;
                let interEnd = (monthEndComplete > endDate) ? endDate : monthEndComplete;

                // Nb Jours (+1 car inclusif)
                let nbDays = Math.round((interEnd - interStart) / (1000 * 60 * 60 * 24)) + 1;

                if (nbDays > 0) {
                    // Convertir en "semaines" (1 semaine = 7 jours)
                    let flexVal = nbDays / 7;
                    monthsList.push({ name: mName, flex: flexVal });
                }

                // Avancer le curseur au début du mois suivant
                cursor = new Date(y, mIndex + 1, 1);
                // Si le début du mois suivant est avant startDate (impossible par logique), on force startDate
                if (cursor < startDate) cursor = new Date(startDate);
            }

            return { months: monthsList, weeks: weeksList };
        }

        function initCalendar() {
            const startYear = (typeof appData !== 'undefined' && appData.schoolYear) ? parseInt(appData.schoolYear) : 2025;
            console.log("📅 Initialisation Calendrier pour année scolaire:", startYear);

            // Update Header Display
            const headerSpan = document.getElementById('headerSchoolYear');
            if (headerSpan) headerSpan.textContent = `(Année scolaire ${startYear} ${startYear + 1})`;

            // Si CALENDAR_DATA est incomplet ou vide, on le régénère automatiquement
            if (!CALENDAR_DATA || !CALENDAR_DATA.months || CALENDAR_DATA.months.length === 0) {
                console.log("⚠️ CALENDAR_DATA vide ou incomplet -> Régénération...");
                CALENDAR_DATA = generateAutoCalendar();
                appData.calendar = CALENDAR_DATA;
            }

            const monthContainer = document.getElementById('calendarMonths');
            const stripContainer = document.getElementById('calendarStrip');

            monthContainer.innerHTML = '';
            stripContainer.innerHTML = '';

            // 1. Recalculate Precise Month Widths based on Timeline (UTC for Pixel Perfect Alignment)
            // Logic: Calendar starts specifically on the Monday of the week containing Sept 1st.
            const startDate = new Date(Date.UTC(startYear, 8, 1));
            let day = startDate.getUTCDay() || 7;
            startDate.setUTCDate(startDate.getUTCDate() - (day - 1)); // Back to Monday

            // Total weeks to render
            const totalWeeks = CALENDAR_DATA.weeks.length;
            const endDate = new Date(startDate);
            endDate.setUTCDate(endDate.getUTCDate() + (totalWeeks * 7));

            let currentCursor = new Date(startDate);
            let monthVisuals = [];
            const MSDAY = 1000 * 60 * 60 * 24;

            while (currentCursor < endDate) {
                let mIndex = currentCursor.getUTCMonth();
                let y = currentCursor.getUTCFullYear();
                let mName = new Date(currentCursor).toLocaleDateString('fr-FR', { month: 'long' });

                let mStartAbs = new Date(Date.UTC(y, mIndex, 1));
                if (mStartAbs < startDate) mStartAbs = new Date(startDate);

                let mEndAbs = new Date(Date.UTC(y, mIndex + 1, 1)); // Start of next month
                if (mEndAbs > endDate) mEndAbs = new Date(endDate);

                let daysDuration = (mEndAbs - mStartAbs) / MSDAY;

                if (daysDuration > 0.1) {
                    // Precision: Use Flex relative to weeks (1 week = 1 flex unit)
                    let flexVal = daysDuration / 7;
                    monthVisuals.push({ name: mName, flex: flexVal });
                }

                currentCursor = new Date(Date.UTC(y, mIndex + 1, 1));
            }

            // Render Calculated Months
            monthVisuals.forEach(m => {
                const mLabel = document.createElement('div');
                mLabel.className = 'month-label';
                mLabel.textContent = m.name;
                mLabel.style.flex = m.flex;
                mLabel.style.minWidth = '0'; // Allow shrinking if needed
                mLabel.style.overflow = 'hidden';
                mLabel.style.whiteSpace = 'nowrap';
                mLabel.style.textAlign = 'center';
                mLabel.style.boxSizing = 'border-box';
                // Optional: add borders or styling if needed, handled by CSS class usually
                monthContainer.appendChild(mLabel);
            });

            // 2. Build week buttons from flat list
            let globalWeekIndex = 0;
            if (!window._calendarOccurrences) window._calendarOccurrences = {};

            CALENDAR_DATA.weeks.forEach(w => {
                const btn = document.createElement('div');
                btn.className = 'week-btn';

                let display = w;
                let id;

                if (w === 'F') {
                    btn.classList.add('holiday');
                    display = 'F';
                    id = 'F_' + globalWeekIndex;
                } else {
                    const k = String(w);
                    if (!window._calendarOccurrences[k]) {
                        window._calendarOccurrences[k] = 0;
                        id = k;
                    } else {
                        window._calendarOccurrences[k]++;
                        id = `${k}@${window._calendarOccurrences[k]}`;
                    }
                }

                btn.textContent = display;
                btn.dataset.id = id;
                btn.dataset.origDisplay = display;
                btn.onclick = () => selectWeek(id);
                btn.ondblclick = (e) => { e.stopPropagation(); toggleWeekDeletion(id); };

                const holidays = appData.holidays || [];
                if (holidays.includes(id)) {
                    btn.classList.add('holiday');
                }

                stripContainer.appendChild(btn);
                globalWeekIndex++;
            });

            // Initialize with smart week selection
            const className = getClassName();
            let weekToLoad = '36'; // Default fallback

            // 1. Try to calculate current week from date (Priority 1 - User Request)
            const currentSchoolWeek = getCurrentSchoolWeekId();
            if (currentSchoolWeek) {
                weekToLoad = currentSchoolWeek;
                console.log('Loading current school week (Auto):', weekToLoad);
            }
            // 2. Fallback to last used if no current week found (e.g. summer)
            else if (appData.info && appData.info.lastWeek) {
                weekToLoad = appData.info.lastWeek;
            }

            selectWeek(weekToLoad);
        }

        // Return ordered list of week ids
        function getAllWeekIdsOrdered() {
            const ids = [];
            const occurrences = {};
            let globalIndex = 0;
            CALENDAR_DATA.weeks.forEach(w => {
                let id;
                if (w === 'F') {
                    id = 'F_' + globalIndex;
                } else {
                    const k = String(w);
                    if (!occurrences[k]) {
                        occurrences[k] = 0;
                        id = k;
                    } else {
                        occurrences[k]++;
                        id = `${k}@${occurrences[k]}`;
                    }
                }
                ids.push(id);
                globalIndex++;
            });
            return ids;
        }

        // Import Pronote Zone A defaults
        function importPronoteZoneA() {
            const holidays = [];
            let idx = 0;
            CALENDAR_DATA.weeks.forEach(w => {
                if (w === 'F') holidays.push('F_' + idx);
                idx++;
            });
            appData.holidays = holidays;
            saveAppData();
            refreshCalendarState();
            alert('Calendrier Pronote Zone A importé. Les semaines "F" sont marquées comme vacances.');
        }

        // Toggle batch selection for modal week selection
        function toggleBatchSelection(weekId, btn) {
            if (tempBatchSelection.has(weekId)) {
                tempBatchSelection.delete(weekId);
                btn.classList.remove('batch-selected');
            } else {
                tempBatchSelection.add(weekId);
                btn.classList.add('batch-selected');
            }
        }

        // UNIFIED: selectWeek + loadWeekState merged for efficiency
        function selectWeek(weekId) {
            if (currentWeekId === weekId) return;

            // 1. Save current week state before switching
            if (currentWeekId !== null) {
                const className = getClassName();
                if (!weeklyPlans[className]) weeklyPlans[className] = {};
                weeklyPlans[className][currentWeekId] = getSnapshot();
                refreshCalendarState(); // Update visual indicators
            }

            // 2. Update week button highlight
            document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('active'));
            const newBtn = document.querySelector(`.week-btn[data-id='${weekId}']`);
            if (newBtn) newBtn.classList.add('active');

            // Update week display text
            document.getElementById('currentWeekDisplay').textContent =
                (String(weekId).startsWith('F_') ? 'Vacances' : 'Semaine ' + weekId);

            // 3. Load new week state
            currentWeekId = weekId;
            const className = getClassName();
            if (!weeklyPlans[className]) weeklyPlans[className] = {};

            const state = weeklyPlans[className][weekId];

            // Ensure layout exists
            if (document.querySelectorAll('.table').length === 0) {
                generateLayout();
            }

            if (state) {
                restoreSnapshot(state);
            } else {
                // New week: clear students but keep layout structure
                console.log("Week has no data. Clearing students.");
                document.querySelectorAll('.student-slot').forEach(slot => slot.innerHTML = '');
                updateCount();
            }
        }

        // Valider la répartition actuelle dans la semaine active (sans sauvegarde fichier)
        async function validateDistribution() {
            const className = getClassName();
            if (!className || currentWeekId === null) {
                alert('Sélectionnez une classe et une semaine d\'abord.');
                return;
            }

            if (!weeklyPlans[className]) weeklyPlans[className] = {};
            weeklyPlans[className][currentWeekId] = getSnapshot();

            // Persist into appData
            if (!appData.plans) appData.plans = {};
            if (!appData.plans[className]) appData.plans[className] = {};
            appData.plans[className][currentWeekId] = weeklyPlans[className][currentWeekId];

            saveAppData();

            // await savePlan(); // SUPPRIMÉ

            alert(`✓ Répartition validée pour ${className} semaine ${currentWeekId}`);
        }

        // REMOVED (merged into selectWeek):
        // - loadWeekState()
        // - saveCurrentWeekState() 
        // - updateBatchDisplay()
        // - renderBatchHighlights()

        // --- NEW MODAL LOGIC for Week Selection ---

        function openWeekSelectionModal() {
            const modal = document.getElementById('weekSelectionModal');
            const grid = document.getElementById('modalWeekGrid');

            grid.innerHTML = '';

            const className = getClassName();
            let activeSet = new Set();
            if (weeklyPlans[className]) {
                Object.keys(weeklyPlans[className]).forEach(k => activeSet.add(String(k)));
            }
            if (activeSet.size === 0 && currentWeekId) {
                activeSet.add(String(currentWeekId));
            }

            tempBatchSelection = new Set(activeSet);

            const allIds = getAllWeekIdsOrdered();
            allIds.forEach(id => {
                const btn = document.createElement('div');
                btn.className = 'week-btn';
                btn.textContent = id.split('@')[0].replace('F_', 'V');
                btn.dataset.id = id;
                btn.style.width = '100%';
                btn.style.height = '40px';

                if (tempBatchSelection.has(id)) {
                    btn.classList.add('batch-selected');
                }

                const classData = weeklyPlans[className] || {};
                if (classData[id]) {
                    btn.classList.add('has-data');
                }

                btn.onclick = () => toggleModalWeek(id, btn);
                grid.appendChild(btn);
            });

            modal.style.display = 'flex';
        }

        // Holiday editor modal (view / edit appData.holidays)
        function openHolidayEditor() {
            const modalId = 'holidayEditorModal';
            let m = document.getElementById(modalId);
            if (m) { m.style.display = 'flex'; return; }

            m = document.createElement('div');
            m.id = modalId;
            m.className = 'modal';
            m.style.zIndex = 10002;
            m.innerHTML = `
                <div class="modal-content" style="width:420px; max-width:95%;">
                    <span class="close-modal" onclick="document.getElementById('${modalId}').style.display='none'">&times;</span>
                    <h3 style="color:var(--primary-color);">Éditer les vacances (Zone A)</h3>
                    <div id="holidayEditorList" style="max-height:360px; overflow:auto; margin-top:8px;">
                    </div>
                    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
                        <button class="btn-secondary" onclick="document.getElementById('${modalId}').style.display='none'">Annuler</button>
                        <button style="background:var(--primary-color); color:black; font-weight:bold;" onclick="saveHolidaysFromEditor()">Enregistrer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(m);

            const list = document.getElementById('holidayEditorList');
            list.innerHTML = '';
            // Temporary set to reflect immediate changes in the modal before saving
            window.tempHolidays = new Set(appData.holidays || []);

            // build entries from calendar buttons
            CALENDAR_DATA.weeks.forEach((w, idx) => {
                const id = 'F_' + idx; // Re-use ID logic
                if (w !== 'F') return; // Only 'F' in editor

                const label = 'Holidays (' + idx + ')';
                const row = document.createElement('div');
                row.style.cssText = 'display:flex; align-items:center; gap:8px; padding:6px; border-bottom:1px solid #333;';
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.dataset.weekId = id;
                chk.checked = window.tempHolidays.has(id);
                chk.onchange = function () {
                    const wid = this.dataset.weekId;
                    if (this.checked) window.tempHolidays.add(wid);
                    else window.tempHolidays.delete(wid);
                    applyTempHolidays();
                };
                const lbl = document.createElement('div');
                lbl.textContent = 'Vacances Semaine ' + idx;
                lbl.style.flex = '1';
                row.appendChild(chk);
                row.appendChild(lbl);
                list.appendChild(row);
            });
            m.style.display = 'flex';
        }

        function saveHolidaysFromEditor() {
            const modalId = 'holidayEditorModal';
            const modal = document.getElementById(modalId);
            if (!modal) return;
            // Persist temporary holidays into appData
            appData.holidays = Array.from(window.tempHolidays || []);
            saveAppData();
            refreshCalendarState();
            modal.style.display = 'none';
            alert('Vacances mises à jour');
        }

        // Toggle deletion (mark/unmark) for a week occurrence
        function toggleWeekDeletion(weekId) {
            if (!appData.holidays) appData.holidays = [];
            const idx = appData.holidays.indexOf(weekId);
            if (idx === -1) {
                appData.holidays.push(weekId);
                alert('Semaine ' + String(weekId).split('@')[0] + ' marquée comme supprimée');
            } else {
                appData.holidays.splice(idx, 1);
                alert('Semaine ' + String(weekId).split('@')[0] + ' restaurée');
            }
            saveAppData();
            // update visuals
            if (window.tempHolidays) {
                // keep tempHolidays in sync for modal preview
                window.tempHolidays = new Set(appData.holidays || []);
            }
            applyTempHolidays();
            refreshCalendarState();
        }



        function closeWeekSelectionModal() {
            document.getElementById('weekSelectionModal').style.display = 'none';
        }

        function toggleModalWeek(id, btn) {
            if (tempBatchSelection.has(id)) {
                tempBatchSelection.delete(id);
                btn.classList.remove('batch-selected');
            } else {
                tempBatchSelection.add(id);
                btn.classList.add('batch-selected');
            }
        }

        async function confirmWeekSelection() {
            const className = getClassName();
            document.getElementById('className').value = className;
            if (typeof updateClassRDVDisplay === 'function') setTimeout(updateClassRDVDisplay, 200);

            const selectedWeeks = Array.from(tempBatchSelection).map(String);

            closeWeekSelectionModal();

            // 0. Save Current State before applying
            if (currentWeekId) {
                if (!weeklyPlans[className]) weeklyPlans[className] = {};
                weeklyPlans[className][currentWeekId] = getSnapshot();
            }

            // 1. Capture snapshot
            const currentSnapshot = getSnapshot();

            // 2. Apply to selected weeks
            if (!weeklyPlans[className]) weeklyPlans[className] = {};

            selectedWeeks.forEach(weekId => {
                weeklyPlans[className][weekId] = JSON.parse(JSON.stringify(currentSnapshot));
            });

            // 3. Cleanup Unselected (Optional: keep them if you want but the user requested 'sync' usually)
            // For now, only selected weeks exist for this class.
            const existingWeeks = Object.keys(weeklyPlans[className]);
            existingWeeks.forEach(weekId => {
                if (!selectedWeeks.includes(weekId)) {
                    delete weeklyPlans[className][weekId];
                }
            });

            // 4. Update UI
            if (currentWeekId) {
                if (weeklyPlans[className][currentWeekId]) {
                    restoreSnapshot(weeklyPlans[className][currentWeekId]);
                } else {
                    document.querySelectorAll('.student-slot').forEach(slot => slot.innerHTML = '');
                }
            }
            refreshCalendarState();

            // 5. Auto Save to LocalStorage
            saveAppData();
            // setTimeout(async () => {
            //    if (confirm("Répartition effectuée. Voulez-vous enregistrer les modifications maintenant ?")) {
            //        await savePlan();
            //    }
            // }, 100);
        }

        // REMOVED: _deprecated_validateActiveWeeks() - dead code
        // Logic is now in confirmWeekSelection()

        // UNIFIED UPDATE: Refreshes calendar highlights based on class data
        function refreshCalendarState() {
            const className = getClassName();
            const classData = weeklyPlans[className] || {};

            document.querySelectorAll('.week-btn').forEach(btn => {
                const wid = btn.dataset.id;
                const hasData = !!classData[wid];

                // Update visual indicator efficiently
                if (hasData) {
                    btn.classList.add('has-data');
                } else {
                    btn.classList.remove('has-data');
                }
                // also ensure holiday mark reflects appData.holidays
                const holidays = appData.holidays || [];
                if (holidays.includes(wid) || holidays.includes(String(btn.textContent))) {
                    btn.classList.add('holiday');
                } else {
                    btn.classList.remove('holiday');
                }
            });
        }


        // Return mapping of non-holiday weeks numbered 1..maxWeeks
        function getCountedWeekMapping(maxWeeks = 36) {
            const all = getAllWeekIdsOrdered();
            const holidaysSet = new Set(appData.holidays || []);
            const useSet = window.tempHolidays ? window.tempHolidays : holidaysSet;

            const mapping = [];
            let counter = 0;
            for (let id of all) {
                if (useSet.has(id)) continue;
                counter++;
                mapping.push({ id, number: counter });
                if (counter >= maxWeeks) break;
            }
            return mapping;
        }

        // Apply temporary holidays (visual only) and refresh week numbering where needed
        function applyTempHolidays() {
            // Update week-btn holiday classes based on tempHolidays and adjust display
            const useSet = window.tempHolidays || new Set(appData.holidays || []);
            document.querySelectorAll('.week-btn').forEach(btn => {
                const wid = btn.dataset.id;
                if (useSet.has(wid)) {
                    btn.classList.add('holiday');
                    // When marked holiday, show the underlying week number (strip any occurrence suffix)
                    if (!String(wid).startsWith('F_')) btn.textContent = String(wid).split('@')[0];
                } else {
                    btn.classList.remove('holiday');
                    // Restore original display
                    if (btn.dataset.origDisplay) btn.textContent = btn.dataset.origDisplay;
                }
            });
            // If a student sheet is open, regenerate its week buttons so numbering updates
            const sheetModal = document.getElementById('studentSheetModal');
            if (sheetModal && sheetModal.style.display === 'flex') {
                const studentJson = document.getElementById('sheet-student-json') && document.getElementById('sheet-student-json').value;
                try {
                    const student = studentJson ? JSON.parse(studentJson) : null;
                    if (student) generateWeeksCalendar(student);
                } catch (e) { /* ignore */ }
            }
            // Refresh calendar visuals
            refreshCalendarState();
        }

        // REMOVED: updateCalendarHighlights() - replaced by refreshCalendarState()
        // REMOVED: renderBatchHighlights() - replaced by direct DOM updates

        // Triggered when Class Name Input changes
        function onClassNameChange() {
            const newName = getClassName();
            if (newName === lastActiveClassName) return;

            console.log(`Class Name Changed: "${lastActiveClassName}" -> "${newName}"`);

            // 1. Check if we are Switching to an EXISTING class or Renaming
            const targetHasData = weeklyPlans[newName] && Object.keys(weeklyPlans[newName]).length > 0;

            if (targetHasData) {
                // SWITCHING: Save old, load new
                if (currentWeekId) {
                    if (!weeklyPlans[lastActiveClassName]) weeklyPlans[lastActiveClassName] = {};
                    weeklyPlans[lastActiveClassName][currentWeekId] = getSnapshot();
                }

                tempBatchSelection.clear();
                if (activeWeeksPerClass[newName]) {
                    activeWeeksPerClass[newName].forEach(w => tempBatchSelection.add(w));
                }

                // Reload current week for new class context
                const oldWeekId = currentWeekId;
                currentWeekId = null;
                selectWeek(oldWeekId);
                console.log("Switched context to existing class.");
            } else {
                // RENAMING: Move data from old name to new
                if (weeklyPlans[lastActiveClassName]) {
                    weeklyPlans[newName] = weeklyPlans[lastActiveClassName];
                    delete weeklyPlans[lastActiveClassName];
                }

                if (activeWeeksPerClass[lastActiveClassName]) {
                    activeWeeksPerClass[newName] = activeWeeksPerClass[lastActiveClassName];
                    delete activeWeeksPerClass[lastActiveClassName];
                }

                console.log("Renamed class / Moved data.");
            }

            // Unified Update
            lastActiveClassName = newName;
            updateKnownClassesList();
            refreshCalendarState();

            // Update Sidebar Student List
            showClassStudents(newName);

            // FORCE "Mode: Placer Élèves" when switching classes
            if (isEditMode) {
                toggleEditMode(false);
            }

            // REMOVED: renderBatchHighlights() - no longer needed
            // REMOVED: updateBatchDisplay() - consolidated
        }

        function getSnapshot() {
            const slots = document.querySelectorAll('.student-slot');
            const pool = document.getElementById('poolList');
            const tables = document.querySelectorAll('.table');
            const desk = document.getElementById('teacherDesk');

            const snapshot = {
                layout: {
                    frozen: isLayoutFrozen,
                    tables: [],
                    desk: {
                        left: desk.style.left,
                        top: desk.style.top
                    }
                },
                slots: {},
                pool: []
            };

            if (isLayoutFrozen) {
                tables.forEach(table => {
                    snapshot.layout.tables.push({
                        id: table.id,
                        left: table.style.left,
                        top: table.style.top,
                        rotation: table.dataset.rotation || 0
                    });
                });
            } else {
                // If layout is not frozen (grid mode), we still might want to save the grid config?
                // For now, if not frozen, we don't save specific positions, 
                // but we should probably save the fact that it's grid mode.
                // The restore function handles grid regeneration if 'frozen' is false.
            }

            slots.forEach(slot => {
                if (slot.children.length > 0) {
                    const student = slot.children[0];
                    const last = (student.querySelector('.student-last') && student.querySelector('.student-last').textContent) || '';
                    const first = (student.querySelector('.student-first') && student.querySelector('.student-first').textContent) || '';
                    snapshot.slots[slot.id] = {
                        id: student.id,
                        name: (last + ' ' + first).trim(),
                        key: student.dataset.studentKey || null,
                        absent: student.classList.contains('absent'),
                        status: student.dataset.status || 'none'
                    };
                }
            });

            Array.from(pool.children).forEach(card => {
                const last = (card.querySelector('.student-last') && card.querySelector('.student-last').textContent) || '';
                const first = (card.querySelector('.student-first') && card.querySelector('.student-first').textContent) || '';
                snapshot.pool.push({
                    id: card.id,
                    name: (last + ' ' + first).trim(),
                    key: card.dataset.studentKey || null,
                    absent: card.classList.contains('absent'),
                    status: card.dataset.status || 'none'
                });
            });

            return snapshot;
        }

        function restoreSnapshot(data) {
            // Clear current content
            document.getElementById('poolList').innerHTML = '';
            document.querySelectorAll('.student-slot').forEach(slot => slot.innerHTML = '');

            // Restore Layout
            if (data.layout && data.layout.frozen) {
                // Snapshot is FROZEN (Free positioning)

                // If we are NOT currently frozen, we must freeze first (hide grid, prep container)
                if (!isLayoutFrozen) {
                    toggleEditMode(true); // Helper to switch to Free Mode
                }

                const desk = document.getElementById('teacherDesk');
                if (data.layout.desk && data.layout.desk.left) desk.style.left = data.layout.desk.left;
                if (data.layout.desk && data.layout.desk.top) desk.style.top = data.layout.desk.top;

                const classroom = document.getElementById('classroomArea');

                // Remove ALL existing tables to rebuild exactly from snapshot
                document.querySelectorAll('.table').forEach(t => t.remove());

                data.layout.tables.forEach(item => {
                    const table = createTableElement(item.id, classroom);
                    table.style.position = 'absolute';
                    table.style.left = item.left;
                    table.style.top = item.top;

                    if (item.rotation) {
                        table.dataset.rotation = item.rotation;
                        table.style.transform = `rotate(${item.rotation}deg)`;
                    }
                });
            } else {
                // Snapshot is NOT frozen (Grid Mode)

                // If we ARE currently frozen, we must unfreeze (show grid)
                if (isLayoutFrozen) {
                    toggleEditMode(false); // Helper to switch to Grid Mode
                }

                // Note: In grid mode, we rely on generateLayout() or existing grid.
                // If the snapshot implies a Grid mode, we assume the default grid layout is active
                // unless we saved specific grid configs (which we don't currently).
                // Ensure grid is populated if empty?
                if (document.querySelectorAll('.table').length === 0) {
                    generateLayout();
                }
            }

            // Restore Students
            // Pool
            if (data.pool) {
                data.pool.forEach(student => {
                    let createdCard = null;
                    if (student.key) {
                        const parts = student.key.split('_');
                        const className = parts[0];
                        if (appData.students && appData.students[className] && appData.students[className][student.key]) {
                            const sObj = appData.students[className][student.key];
                            createdCard = createStudentCard(sObj, student.id, student.absent, student.status || 'none');
                            createdCard.dataset.student = JSON.stringify(sObj);
                            createdCard.dataset.studentKey = student.key;
                        }
                    }

                    if (!createdCard) {
                        const fullname = (student.name || '').trim();
                        const matched = findStudentByFullName(fullname);
                        if (matched) {
                            createdCard = createStudentCard(matched.studentObj, student.id, student.absent, student.status || 'none');
                            createdCard.dataset.student = JSON.stringify(matched.studentObj);
                            createdCard.dataset.studentKey = matched.key;
                        } else {
                            createdCard = createStudentCard(student.name, student.id, student.absent, student.status || 'none');
                        }
                    }

                    if (createdCard) {
                        createdCard.ondblclick = () => openStudentSheet(createdCard.dataset.student ? JSON.parse(createdCard.dataset.student) : {}, createdCard.id);
                        createdCard.ondragstart = drag;
                        document.getElementById('poolList').appendChild(createdCard);
                    }
                });
            }

            // Slots (Tables)
            if (data.slots) {
                for (const [slotId, student] of Object.entries(data.slots)) {
                    // In Grid Mode, slots are within the grid tables (e.g. 'table-0-slot-0').
                    // In Free Mode, tables are recreated with IDs (e.g. 'table-1').
                    // createTableElement() generates slots with IDs like 'table-X-slot-Y'.
                    // IDs must match for restoration.

                    const slot = document.getElementById(slotId);
                    if (slot) {
                        let card;
                        // Prefer matching by saved student key when available
                        if (student.key) {
                            // student.key is expected in format classe_nom_prenom
                            const parts = student.key.split('_');
                            const k = student.key;
                            const className = parts[0];
                            if (appData.students && appData.students[className] && appData.students[className][k]) {
                                const sObj = appData.students[className][k];
                                card = createStudentCard(sObj, student.id, student.absent, student.status || 'none');
                                card.dataset.student = JSON.stringify(sObj);
                                card.dataset.studentKey = k;
                            }
                        }

                        if (!card) {
                            const fullname = (student.name || '').trim();
                            const matched = findStudentByFullName(fullname);
                            if (matched) {
                                card = createStudentCard(matched.studentObj, student.id, student.absent, student.status || 'none');
                                card.dataset.student = JSON.stringify(matched.studentObj);
                                card.dataset.studentKey = matched.key;
                            } else {
                                card = createStudentCard(student.name, student.id, student.absent, student.status || 'none');
                            }
                        }

                        if (card) {
                            card.ondblclick = () => openStudentSheet(card.dataset.student ? JSON.parse(card.dataset.student) : {}, card.id);
                            card.ondragstart = drag;
                            slot.appendChild(card);
                        }
                    }
                }
            }
            updateCount();
        }

        // Helper: find a student object in appData by full name (nom + prenom)
        function findStudentByFullName(fullname) {
            if (!fullname) return null;
            const normalized = fullname.trim().toLowerCase();
            for (const className of Object.keys(appData.students || {})) {
                const classObj = appData.students[className] || {};
                for (const key of Object.keys(classObj)) {
                    const s = classObj[key];
                    const candidate = ((s.nom || '') + ' ' + (s.prenom || '')).trim().toLowerCase();
                    if (candidate === normalized) return { studentObj: s, key };
                }
            }
            return null;
        }

        // ----- Quit Modal & Backup helpers -----
        async function openQuitModal() {
            // 1. Sauvegarder au format JSON
            let success = false;
            try {
                success = await downloadBackup();
            } catch (e) {
                alert("Erreur lors de la sauvegarde: " + e.message);
                return;
            }

            // 2. Si la sauvegarde est OK, on nettoie et on ferme
            if (success) {
                try {
                    // Nettoyage complet
                    localStorage.clear();
                    sessionStorage.clear();
                    if (window.indexedDB && window.indexedDB.databases) {
                        try {
                            const dbs = await window.indexedDB.databases();
                            dbs.forEach(db => { window.indexedDB.deleteDatabase(db.name) });
                        } catch (idxErr) {
                            console.warn("IndexedDB clean warning:", idxErr);
                        }
                    }
                    console.log("✓ Données nettoyées.");
                } catch (cleanErr) {
                    console.warn("Erreur mineure nettoyage:", cleanErr);
                }

                // 3. Feedback visuel avant fermeture
                document.body.innerHTML = `
                    <div style="
                        height: 100vh; 
                        display: flex; 
                        flex-direction: column; 
                        justify-content: center; 
                        align-items: center; 
                        background: #1a1a1a; 
                        color: #00f2ff; 
                        font-family: sans-serif; 
                        text-align: center;">
                        <h1 style="font-size: 3em; margin-bottom: 20px;">✓ A BIENTÔT !</h1>
                        <p style="color: #e0e0e0; font-size: 1.2em;">Sauvegarde JSON effectuée.<br>Mémoire du navigateur effacée.</p>
                        <p style="color: #888; margin-top: 30px;">Fermeture en cours...</p>
                        <button onclick="window.close()" style="
                            margin-top: 20px; 
                            padding: 12px 24px; 
                            background: #333; 
                            color: white; 
                            border: 1px solid #555; 
                            cursor: pointer; 
                            font-size: 1rem; 
                            border-radius: 4px;">Fermer maintenant</button>
                    </div>
                `;

                // Tentative de fermeture
                setTimeout(() => window.close(), 500);
            }
        }

        async function downloadBackup() {
            try {
                // Synchronisation des données
                if (typeof synchronizeAllData === 'function') {
                    synchronizeAllData();
                }

                const data = JSON.stringify(appData, null, 2);
                const ts = new Date().toISOString().slice(0, 10);
                let fileName = (typeof currentDocName !== 'undefined' && currentDocName) ? currentDocName : `sauvegarde_pdc_${ts}`;
                fileName = fileName.replace(/\.json$/i, '') + '.json';

                // Méthode 1: File System Access API (Chrome/Edge)
                if (window.showSaveFilePicker) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: fileName,
                            types: [{
                                description: 'Fichier JSON logiciel',
                                accept: { 'application/json': ['.json'] },
                            }],
                        });
                        const writable = await handle.createWritable();
                        await writable.write(data);
                        await writable.close();
                        return true;
                    } catch (err) {
                        if (err.name === 'AbortError') {
                            return false; // Annulation utilisateur
                        }
                        // Continue vers fallback si autre erreur
                        console.warn('FilePicker fail, fallback to download', err);
                    }
                }

                // Méthode 2: Fallback Téléchargement Classique (Pas de prompt pour éviter annulation confuse)
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();

                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 200);

                return true;
            } catch (err) {
                console.error(err);
                alert("Erreur critique sauvegarde: " + err.message);
                return false;
            }
        }



        // Helper to switch modes properly without data loss (visual toggle)
        function toggleEditMode(forceFrozenState) {
            // Vérifier si l'application est verrouillée
            if (isApplicationLocked()) {
                alert('🔒 Application verrouillée\n\nLe logiciel est en mode consultation uniquement.\nVous ne pouvez pas éditer les plans de classe.\n\nCliquez sur le bouton "Déverrouiller" en haut de l\'\u00e9cran.');
                return;
            }
            
            const btn = document.querySelector('.btn-mode'); // "Modifier Plan" button
            const grid = document.getElementById('layoutGrid');
            const classroom = document.getElementById('classroomArea');

            // If an argument is provided, enforce that state.
            // forceFrozenState = true -> Free Mode (Frozen Grid)
            // forceFrozenState = false -> Grid Mode

            if (typeof forceFrozenState !== 'undefined') {
                isLayoutFrozen = forceFrozenState;
            } else {
                isLayoutFrozen = !isLayoutFrozen;
            }

            if (isLayoutFrozen) {
                // Free Mode
                grid.style.display = 'none';
                if (btn) {
                    btn.classList.add('active');
                    btn.textContent = 'Verrouiller Plan';
                }
                // We don't necessarily convert elements here, restoreSnapshot handles the rebuilding.
            } else {
                // Grid Mode
                grid.style.display = 'flex';
                // Remove absolute tables if any (cleanup)
                document.querySelectorAll('.table').forEach(t => {
                    if (t.style.position === 'absolute') t.remove();
                });

                if (btn) {
                    btn.classList.remove('active');
                    btn.textContent = 'Modifier Plan';
                }
                // Ensure grid exists
                if (grid.children.length === 0) generateLayout();
            }
        }

        // Modal Functions
        function openPrintModal() {
            document.getElementById('printModal').style.display = 'block';
        }

        function closePrintModal() {
            document.getElementById('printModal').style.display = 'none';
        }

        function toggleScaleInput() {
            const auto = document.getElementById('p-auto-scale').checked;
            document.getElementById('p-scale').disabled = auto;
        }

        function confirmPrint() {
            // Gather settings
            printSettings.orientation = document.querySelector('input[name="p-orient"]:checked').value;
            printSettings.autoScale = document.getElementById('p-auto-scale').checked;
            printSettings.scale = parseInt(document.getElementById('p-scale').value);
            printSettings.hideDesk = document.getElementById('p-hide-desk').checked;
            printSettings.hideNames = document.getElementById('p-hide-names').checked;

            // Apply orientation immediately to CSS
            const pageStyle = document.getElementById('page-style');
            pageStyle.innerHTML = `@page { size: A4 ${printSettings.orientation}; margin: 0.5cm; }`;

            closePrintModal();
            window.print();
        }

        // Close modal if clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('printModal');
            if (event.target == modal) {
                closePrintModal();
            }
        }

        // Table Size Management
        function changeTableSize(size) {
            const root = document.documentElement;
            if (size === 'compact') {
                root.style.setProperty('--table-width', '140px');
                root.style.setProperty('--table-height', '60px');
            } else if (size === 'large') {
                root.style.setProperty('--table-width', '220px');
                root.style.setProperty('--table-height', '100px');
            } else {
                root.style.setProperty('--table-width', '180px');
                root.style.setProperty('--table-height', '80px');
            }
        }

        // Print Handling
        window.addEventListener('beforeprint', () => {
            // Update print info with full details
            const className = document.getElementById('className').value;
            const room = document.getElementById('roomName').value;
            const subject = document.getElementById('subjectName').value;
            const count = document.querySelectorAll('.student-card').length;

            let infoText = '';
            if (className) infoText += className + ' - ';
            if (room) infoText += room + ' - ';
            if (subject) infoText += subject + ' - ';

            // Remove trailing dash if exists
            if (infoText.endsWith(' - ')) {
                infoText = infoText.substring(0, infoText.length - 3);
            }

            // Add student count on a new line or appended
            if (infoText) {
                document.getElementById('printInfo').innerHTML = `${infoText}<br><span style="font-size:0.8em; font-weight:normal;">(Nombre d'élèves : ${count})</span>`;
            } else {
                document.getElementById('printInfo').textContent = `Nombre d'élèves : ${count}`;
            }

            // Apply Hiding Classes
            if (printSettings.hideDesk) document.body.classList.add('print-hide-desk');
            if (printSettings.hideNames) document.body.classList.add('print-hide-names');

            const classroom = document.getElementById('classroomArea');

            // Calculate Scale
            let scale = 1;

            if (printSettings.autoScale) {
                // AUTO-FIT LOGIC
                const tables = document.querySelectorAll('.table');
                const desk = document.getElementById('teacherDesk');

                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                const elementsToCheck = [...tables];
                if (!printSettings.hideDesk) elementsToCheck.push(desk);

                if (!isLayoutFrozen) {
                    const grid = document.getElementById('layoutGrid');
                    const gridRect = grid.getBoundingClientRect();
                    minY = grid.offsetTop;
                    maxY = grid.offsetTop + grid.offsetHeight;
                    if (!printSettings.hideDesk) {
                        minY = Math.min(desk.offsetTop, minY);
                        maxY = Math.max(desk.offsetTop + desk.offsetHeight, maxY);
                    }
                    minX = 0;
                    maxX = classroom.offsetWidth;
                } else {
                    elementsToCheck.forEach(el => {
                        const elLeft = el.offsetLeft;
                        const elTop = el.offsetTop;
                        const elWidth = el.offsetWidth;
                        const elHeight = el.offsetHeight;
                        if (elLeft < minX) minX = elLeft;
                        if (elTop < minY) minY = elTop;
                        if (elLeft + elWidth > maxX) maxX = elLeft + elWidth;
                        if (elTop + elHeight > maxY) maxY = elTop + elHeight;
                    });
                }

                if (maxX === -Infinity) { maxX = 1000; maxY = 1000; minX = 0; minY = 0; }

                const contentWidth = maxX - minX + 40;
                const contentHeight = maxY - minY + 100;

                // A4 Dimensions (approx pixels)
                // Portrait: 750x1050, Landscape: 1080x750
                let availWidth = 750;
                let availHeight = 1050;

                if (printSettings.orientation === 'landscape') {
                    availWidth = 1080;
                    availHeight = 750;
                }

                const scaleX = availWidth / contentWidth;
                const scaleY = availHeight / contentHeight;

                scale = Math.min(scaleX, scaleY, 1) * 0.85; // 85% safety factor
            } else {
                // MANUAL SCALE
                scale = printSettings.scale / 100;
            }

            // Apply Scale
            classroom.style.transform = `scale(${scale})`;
            classroom.style.width = '100%';
            // Force height to fit scaled content so next pages aren't blank
            // Note: This is an approximation.
            classroom.style.height = (1200 * scale) + 'px';

            // Center horizontally
            // We need to calculate center based on orientation
            let availWidth = (printSettings.orientation === 'landscape') ? 1123 : 794; // A4 pixels full width
            // Simple centering margin
            // classroom.style.marginLeft = 'auto'; // Flexbox handles this in print media often, but let's be safe
        });

        window.addEventListener('afterprint', () => {
            const classroom = document.getElementById('classroomArea');
            classroom.style.transform = '';
            classroom.style.width = '';
            classroom.style.height = '';

            document.body.classList.remove('print-hide-desk');
            document.body.classList.remove('print-hide-names');
        });

        function generateLayout() {
            const grid = document.getElementById('layoutGrid');
            grid.innerHTML = ''; // Clear existing

            // 4 Rows for Vertical Layout (Reduced from 6)
            for (let r = 1; r <= 4; r++) {
                const row = document.createElement('div');
                row.className = 'classroom-row';

                // 4 Tables per row (Requested)
                for (let t = 1; t <= 4; t++) {
                    createTableElement(`table-r${r}-t${t}`, row);
                }
                grid.appendChild(row);
            }

            // Also make teacher desk draggable in edit mode
            const desk = document.getElementById('teacherDesk');
            desk.addEventListener('mousedown', startDragTable);
        }

        function createTableElement(id, parent) {
            const table = document.createElement('div');
            table.className = 'table';
            table.id = id;
            table.dataset.rotation = 0; // Initialize rotation

            // Controls (Delete/Rotate)
            const controls = document.createElement('div');
            controls.className = 'table-controls';

            // Rotate Left (-18)
            const btnRotateLeft = document.createElement('button');
            btnRotateLeft.className = 'control-btn btn-rotate-left';
            btnRotateLeft.innerHTML = '&#8634;'; // CCW arrow
            btnRotateLeft.title = 'Pivoter Gauche -18°';
            btnRotateLeft.onclick = (e) => {
                e.stopPropagation();
                rotateTableElement(table, -18);
            };

            // Rotate Right (+18)
            const btnRotateRight = document.createElement('button');
            btnRotateRight.className = 'control-btn btn-rotate-right';
            btnRotateRight.innerHTML = '&#8635;'; // CW arrow
            btnRotateRight.title = 'Pivoter Droite +18°';
            btnRotateRight.onclick = (e) => {
                e.stopPropagation();
                rotateTableElement(table, 18);
            };

            const btnDelete = document.createElement('button');
            btnDelete.className = 'control-btn btn-delete';
            btnDelete.innerHTML = '&#10005;'; // X icon
            btnDelete.title = 'Supprimer';
            btnDelete.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Supprimer cette table ?')) {
                    const slots = table.querySelectorAll('.student-slot');
                    slots.forEach(slot => {
                        if (slot.children.length > 0) {
                            const student = slot.children[0];
                            document.getElementById('poolList').appendChild(student);
                        }
                    });
                    table.remove();
                    updateCount();
                }
            };

            controls.appendChild(btnRotateLeft);
            controls.appendChild(btnRotateRight);
            controls.appendChild(btnDelete);
            table.appendChild(controls);

            // 2 Slots per table
            for (let s = 1; s <= 2; s++) {
                const slot = document.createElement('div');
                slot.className = 'student-slot';
                slot.id = `${id}-s${s}`;
                slot.ondrop = drop;
                slot.ondragover = allowDrop;
                table.appendChild(slot);
            }

            table.addEventListener('mousedown', startDragTable);

            if (isEditMode) {
                table.classList.add('draggable-mode');
                table.addEventListener('dblclick', (e) => rotateTableElement(e.currentTarget, 18));
                table.title = "Double-cliquez pour pivoter +18°";
            }

            if (parent) {
                parent.appendChild(table);
            }
            return table;
        }

        function rotateTableElement(table, angle) {
            let currentRotation = parseInt(table.dataset.rotation || 0);
            currentRotation = (currentRotation + angle) % 360;
            table.dataset.rotation = currentRotation;
            table.style.transform = `rotate(${currentRotation}deg)`;
        }

        function addTable() {
            // Enter edit mode (which auto-freezes layout)
            if (!isEditMode) toggleEditMode(true);

            const id = 'table-custom-' + Date.now();
            const table = createTableElement(id, null); // Don't append yet

            table.style.position = 'absolute';
            table.style.left = '50px';
            table.style.top = '50px';
            table.style.backgroundColor = 'var(--table-color-1)'; // Default color

            document.getElementById('classroomArea').appendChild(table);
        }

        // Auto Distribution of Students
        function autoDistributeStudents() {
            const poolList = document.getElementById('poolList');
            const students = Array.from(poolList.children);

            if (students.length === 0) {
                alert("Il n'y a pas d'élèves dans la liste à répartir.");
                return;
            }

            // Find all empty slots
            const allSlots = Array.from(document.querySelectorAll('.student-slot'));
            const emptySlots = allSlots.filter(slot => slot.children.length === 0);

            if (emptySlots.length === 0) {
                alert("Il n'y a plus de places libres dans la classe.");
                return;
            }

            if (confirm(`Voulez-vous répartir aléatoirement ${Math.min(students.length, emptySlots.length)} élèves ?`)) {
                // Shuffle students
                const shuffledStudents = students.sort(() => Math.random() - 0.5);

                // Shuffle slots too for better randomness
                const shuffledSlots = emptySlots.sort(() => Math.random() - 0.5);

                // Distribute
                for (let i = 0; i < shuffledStudents.length; i++) {
                    if (i < shuffledSlots.length) {
                        shuffledSlots[i].appendChild(shuffledStudents[i]);
                    } else {
                        break; // No more slots
                    }
                }
                updateCount();
            }
        }

        // Toggle Magnetism
        function toggleMagnetism() {
            isMagnetActive = !isMagnetActive;
            const btn = document.getElementById('magnetBtn');
            if (isMagnetActive) {
                btn.textContent = "Aimant: ON";
                btn.classList.add('active');
            } else {
                btn.textContent = "Aimant: OFF";
                btn.classList.remove('active');
            }
        }

        // --- AGENDA VIEW ---
        let currentAgendaDate = new Date();
        let isAgendaView = false;

        function toggleAgendaView() {
            // isAgendaView = !isAgendaView; // OLD TOGGLE behavior disabled
            if (isAgendaView) return; // If already open, do nothing (User must use Close button)

            isAgendaView = true;
            const classroom = document.getElementById('classroomArea');
            const agenda = document.getElementById('agendaArea');
            const rdv = document.getElementById('rdvArea');

            // Force show
            classroom.style.display = 'none';
            if (rdv) rdv.style.display = 'none';
            isRdvView = false;
            agenda.style.display = 'block';
            renderAgenda();
        }

        function closeAgendaView() {
            isAgendaView = false;
            document.getElementById('classroomArea').style.display = 'block';
            document.getElementById('agendaArea').style.display = 'none';
        }

        // --- RDV SYSTEM ---
        let isRdvView = false;
        let currentRdvDate = new Date();
        let currentRdvViewMode = 'month'; // 'day', 'week', 'month'

        function toggleRdvView() {
            // isRdvView = !isRdvView; // OLD TOGGLE behavior disabled
            if (isRdvView) return; // If already open, do nothing

            isRdvView = true;
            const classroom = document.getElementById('classroomArea');
            const agenda = document.getElementById('agendaArea');
            const rdv = document.getElementById('rdvArea');

            classroom.style.display = 'none';
            agenda.style.display = 'none';
            isAgendaView = false;
            rdv.style.display = 'block';
            renderRdvCalendar();
        }

        function closeRdvView() {
            isRdvView = false;
            document.getElementById('classroomArea').style.display = 'block';
            document.getElementById('rdvArea').style.display = 'none';
        }

        function toggleRdvFullScreen() {
            const rdvArea = document.getElementById('rdvArea');
            const btn = document.getElementById('btn-rdv-fullscreen');

            if (!rdvArea.classList.contains('fullscreen-mode')) {
                // ACTIVER LE PLEIN ÉCRAN
                rdvArea.classList.add('fullscreen-mode');

                rdvArea.style.position = 'fixed';
                rdvArea.style.top = '0';
                rdvArea.style.left = '0';
                rdvArea.style.width = '100vw';
                rdvArea.style.height = '100vh';
                rdvArea.style.zIndex = '9999';
                rdvArea.style.margin = '0'; // Enlève le margin-left
                rdvArea.style.borderRadius = '0';
                rdvArea.style.border = 'none';

                btn.innerHTML = '🗗'; // Symbole Réduire
                btn.title = "Réduire";
            } else {
                // DÉSACTIVER LE PLEIN ÉCRAN
                rdvArea.classList.remove('fullscreen-mode');

                rdvArea.style.position = '';
                rdvArea.style.top = '';
                rdvArea.style.left = '';
                rdvArea.style.width = '';
                rdvArea.style.height = '';
                rdvArea.style.zIndex = '';
                rdvArea.style.margin = '';
                rdvArea.style.marginLeft = '10px'; // Restaure le style original
                rdvArea.style.borderRadius = '10px';
                rdvArea.style.border = '';

                btn.innerHTML = '⛶';
                btn.title = "Plein Écran";
            }
        }

        function setRdvViewMode(mode) {
            currentRdvViewMode = mode;
            renderRdvCalendar();
        }

        function changeRdvDate(delta) {
            if (currentRdvViewMode === 'month') {
                currentRdvDate.setMonth(currentRdvDate.getMonth() + delta);
            } else if (currentRdvViewMode === 'week') {
                currentRdvDate.setDate(currentRdvDate.getDate() + (delta * 7));
            } else {
                currentRdvDate.setDate(currentRdvDate.getDate() + delta);
            }
            renderRdvCalendar();
        }

        function renderRdvCalendar() {
            const grid = document.getElementById('rdvGrid');
            const display = document.getElementById('rdvDateDisplay');
            grid.innerHTML = '';

            // Update buttons state
            ['day', 'week', 'month'].forEach(m => {
                const btn = document.getElementById('btn-rdv-' + m);
                if (btn) {
                    btn.style.background = (m === currentRdvViewMode) ? '#E91E63' : '#444';
                    btn.style.color = 'white';
                }
            });

            if (currentRdvViewMode === 'month') {
                renderRdvMonth(grid, display);
            } else if (currentRdvViewMode === 'week') {
                renderRdvWeek(grid, display);
            } else {
                renderRdvDay(grid, display);
            }
        }

        function printRdvCalendar() {
            const mode = currentRdvViewMode;
            const date = currentRdvDate;
            let title = "";
            let content = "";

            // Helper to get RDVs
            const getRdvs = (dStr) => (appData.rdv || []).filter(r => r.date === dStr);

            if (mode === 'month') {
                const year = date.getFullYear();
                const month = date.getMonth();
                title = date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' }).toUpperCase();

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1);
                let startDay = firstDay.getDay() - 1;
                if (startDay === -1) startDay = 6;

                content = '<div style="display:grid; grid-template-columns:repeat(7, 1fr); gap:5px;">';
                ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(d => {
                    content += `<div style="font-weight:bold; text-align:center; padding:5px; background:#eee;">${d}</div>`;
                });

                for (let i = 0; i < startDay; i++) content += '<div></div>';

                for (let d = 1; d <= daysInMonth; d++) {
                    const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const rdvs = getRdvs(dStr);

                    let cellContent = `<div style="font-weight:bold; margin-bottom:5px;">${d}</div>`;
                    rdvs.forEach(r => {
                        let color = (r.status === 'validated') ? '#4CAF50' : '#E91E63';
                        let textColor = 'white';
                        if (r.type === 'famille') { color = '#FFD700'; textColor = 'black'; }
                        else if (r.type === 'reunion') { color = '#9C27B0'; textColor = 'white'; }

                        cellContent += `<div style="font-size:0.7rem; background:${color}; color:${textColor}; padding:2px; margin-bottom:2px; border-radius:2px;">
                            ${r.time || ''} ${r.title}
                        </div>`;
                    });

                    content += `<div style="border:1px solid #ccc; min-height:80px; padding:5px;">${cellContent}</div>`;
                }
                content += '</div>';

            } else if (mode === 'week') {
                const startOfWeek = new Date(date);
                const day = startOfWeek.getDay() || 7;
                if (day !== 1) startOfWeek.setDate(startOfWeek.getDate() - (day - 1));

                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                title = `Semaine du ${startOfWeek.toLocaleDateString()} au ${endOfWeek.toLocaleDateString()}`;

                // Grid Header
                content = '<div style="display:grid; grid-template-columns:60px repeat(7, 1fr); border:1px solid #ccc;">';
                content += '<div style="background:#eee; border-bottom:1px solid #ccc;"></div>'; // Corner

                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(d.getDate() + i);
                    weekDates.push(d);
                    content += `<div style="background:#eee; padding:5px; text-align:center; font-weight:bold; border-left:1px solid #ccc; border-bottom:1px solid #ccc;">
                        ${d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' })}
                    </div>`;
                }

                // Grid Body (8h - 20h)
                const startHour = 8;
                const endHour = 20;
                const slots = (endHour - startHour) * 4; // 15 min slots

                // Time labels column
                for (let i = 0; i < slots; i++) {
                    const totalMin = (startHour * 60) + (i * 15);
                    const h = Math.floor(totalMin / 60);
                    const m = totalMin % 60;
                    const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                    // Time Label
                    content += `<div style="grid-column:1; grid-row:${i + 2}; text-align:right; padding:2px 5px; font-size:0.6rem; color:#666; border-bottom:1px solid #eee;">${timeStr}</div>`;

                    // Empty cells for grid lines
                    for (let col = 0; col < 7; col++) {
                        content += `<div style="grid-column:${col + 2}; grid-row:${i + 2}; border-left:1px solid #eee; border-bottom:1px solid #eee;"></div>`;
                    }
                }

                // Events overlay
                for (let col = 0; col < 7; col++) {
                    const d = weekDates[col];
                    const dStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const rdvs = getRdvs(dStr);

                    rdvs.forEach(r => {
                        if (!r.time) return;
                        const [h, m] = r.time.split(':').map(Number);
                        if (h < startHour || h >= endHour) return;

                        const minutesFromStart = (h * 60 + m) - (startHour * 60);
                        const rowStart = Math.floor(minutesFromStart / 15) + 2; // +2 because row 1 is header

                        const duration = r.duration || 15;
                        const rowSpan = Math.ceil(duration / 15);

                        let color = (r.status === 'validated') ? '#4CAF50' : '#E91E63';
                        let textColor = 'white';
                        if (r.type === 'famille') { color = '#FFD700'; textColor = 'black'; }
                        else if (r.type === 'reunion') { color = '#9C27B0'; textColor = 'white'; }

                        content += `<div style="grid-column:${col + 2}; grid-row:${rowStart} / span ${rowSpan}; background:${color}; color:${textColor}; font-size:0.7rem; padding:2px; margin:1px; border-radius:2px; z-index:10; overflow:hidden;">
                            ${r.time} ${r.title}
                        </div>`;
                    });
                }
                content += '</div>';

            } else {
                // Day View
                title = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();
                const dStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

                content = '<div style="display:grid; grid-template-columns:60px 1fr; border:1px solid #ccc;">';

                const startHour = 8;
                const endHour = 20;
                const slots = (endHour - startHour) * 4;

                for (let i = 0; i < slots; i++) {
                    const totalMin = (startHour * 60) + (i * 15);
                    const h = Math.floor(totalMin / 60);
                    const m = totalMin % 60;
                    const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                    content += `<div style="grid-column:1; grid-row:${i + 1}; text-align:right; padding:5px; border-bottom:1px solid #eee; color:#666;">${timeStr}</div>`;
                    content += `<div style="grid-column:2; grid-row:${i + 1}; border-left:1px solid #ccc; border-bottom:1px solid #eee;"></div>`;
                }

                const rdvs = getRdvs(dStr);

                rdvs.forEach(r => {
                    if (!r.time) return;

                    // Filter: Only print Standard/Convocation (exclude famille/reunion)
                    if (r.type === 'famille' || r.type === 'reunion') return;

                    const [h, m] = r.time.split(':').map(Number);
                    if (h < startHour || h >= endHour) return;

                    const minutesFromStart = (h * 60 + m) - (startHour * 60);
                    const rowStart = Math.floor(minutesFromStart / 15) + 1;

                    const duration = r.duration || 15;
                    const rowSpan = Math.ceil(duration / 15);

                    let color = (r.status === 'validated') ? '#4CAF50' : '#E91E63';
                    let textColor = 'white';
                    if (r.type === 'famille') { color = '#FFD700'; textColor = 'black'; }
                    else if (r.type === 'reunion') { color = '#9C27B0'; textColor = 'white'; }

                    content += `<div style="grid-column:2; grid-row:${rowStart} / span ${rowSpan}; background:${color}; color:${textColor}; padding:5px; border-radius:4px; z-index:10; overflow:hidden; margin:2px;">
                            <b>${r.time}</b> ${r.title}<br>${r.description || ''}
                            ${r.students ? '<br><small>' + r.students.join(', ') + '</small>' : ''}
                    </div>`;
                });

                content += '</div>';
            }

            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <title>Agenda - ${title}</title>
                    <style>
                        @page { size: landscape; margin: 5mm; }
                        body { font-family: 'Segoe UI', sans-serif; padding: 10px; color:black; font-size: 12px; zoom: 0.85; }
                        h1 { text-align: center; margin-bottom: 10px; font-size: 16px; }
                        * { -webkit-print-color-adjust: exact; print-color-adjust: exact; box-sizing: border-box; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${content}
                </body>
                </html>
            `);
            w.document.close();
            setTimeout(() => w.print(), 500);
        }

        function openPrintOptions() {
            const modal = document.getElementById('printOptionsModal');
            const btnConvoc = document.getElementById('btnPrintConvocations');

            if (currentRdvViewMode === 'day') {
                btnConvoc.style.display = 'block';
            } else {
                btnConvoc.style.display = 'none';
            }

            modal.style.display = 'flex';
        }

        function closePrintOptionsModal() {
            document.getElementById('printOptionsModal').style.display = 'none';
        }

        function printAllConvocationsForDay() {
            const date = currentRdvDate;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dStr = `${year}-${month}-${day}`;

            // Filter for standard RDVs only (exclude 'famille' and 'reunion')
            const rdvs = (appData.rdv || []).filter(r => r.date === dStr && (!r.type || r.type === 'standard'));

            if (rdvs.length === 0) {
                alert("Aucune convocation élève à imprimer pour cette journée.");
                return;
            }

            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <title>Convocations du ${dStr}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; margin: 0; padding: 0; color: #000; }
                        @page { size: A4; margin: 0; }
                        .a4-page { 
                            width: 210mm; 
                            height: 296mm; 
                            padding: 10mm; 
                            margin: 0 auto; 
                            box-sizing: border-box; 
                            display: flex; 
                            flex-direction: column; 
                            justify-content: space-between;
                            page-break-after: always;
                        }
                        .a4-page:last-child { page-break-after: auto; }
                        
                        .convocation-item {
                            height: 32%; 
                            border: 1px dashed #000;
                            padding: 15px;
                            box-sizing: border-box;
                            display: flex;
                            flex-direction: column;
                            position: relative;
                            overflow: hidden;
                        }
                        
                        .header { display: flex; justify-content: space-between; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
                        .establishment { font-weight: bold; text-transform: uppercase; font-size: 0.9rem; }
                        .date { font-size: 0.9rem; }
                        
                        .title { font-size: 1.2rem; font-weight: bold; text-align: center; margin: 5px 0; text-transform: uppercase; text-decoration: underline; }
                        
                        .content { font-size: 0.95rem; flex: 1; display: flex; flex-direction: column; justify-content: center; }
                        .content p { margin: 5px 0; }
                        
                        .details { margin: 5px 0; padding: 5px; background: #f0f0f0; border: 1px solid #ddd; font-size: 0.9rem; }
                        
                        .signature { text-align: right; font-weight: bold; margin-top: 10px; font-size: 1rem; }
                        
                        @media print {
                            body { margin: 0; }
                            .a4-page { margin: 0; border: none; }
                            .convocation-item { border: 1px dashed #000; }
                            .details { background: none; border: 1px solid #000; }
                        }
                    </style>
                </head>
                <body>
            `);

            for (let i = 0; i < rdvs.length; i += 3) {
                const chunk = rdvs.slice(i, i + 3);

                w.document.write('<div class="a4-page">');

                chunk.forEach(rdv => {
                    const dateObj = new Date(rdv.date);
                    const dateFormatted = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

                    let studentNames = "l'élève";
                    if (rdv.students && rdv.students.length > 0) {
                        const studentsWithClass = rdv.students.map(name => {
                            if (name.includes('(') && name.includes(')')) return name; // Already has class

                            let className = '';
                            if (appData.students) {
                                for (const c in appData.students) {
                                    if (appData.students[c][name]) {
                                        className = c;
                                        break;
                                    }
                                }
                            }
                            return className ? `${name} (${className})` : name;
                        });
                        studentNames = studentsWithClass.join(', ');
                    }

                    const cpeName = rdv.cpeName || "Le(a) CPE";

                    w.document.write(`
                        <div class="convocation-item">
                            <div class="header">
                                <div class="establishment">Vie Scolaire - Service CPE</div>
                                <div class="date">Le ${new Date().toLocaleDateString('fr-FR')}</div>
                            </div>

                            <div class="title">CONVOCATION</div>

                            <div class="content">
                                <p><strong>Pour : ${studentNames}</strong></p>
                                <p>Vous êtes convoqué(e) au bureau de le (a) CPE pour un entretien.</p>
                                
                                <div class="details">
                                    <strong>Date :</strong> ${dateFormatted} à <span style="font-size: 1.4em; font-weight: bold; font-style: italic;">${rdv.time}</span>
                                    ${rdv.description ? `<br><strong>Motif :</strong> ${rdv.description}` : ''}
                                </div>
                                
                                <p style="font-size:0.8rem; font-style:italic;">La présence à cet entretien est obligatoire sauf évaluation, le rdv sera reporté.</p>
                            </div>

                            <div style="margin-top: 5px; display: flex; justify-content: space-between; align-items: flex-end;">
                                <div style="font-weight: bold; font-style: italic; font-size: 0.9rem;">Retour en cours à :</div>
                                <div class="signature" style="margin-top: 0;">
                                    ${cpeName}
                                </div>
                            </div>
                        </div>
                    `);
                });

                w.document.write('</div>');
            }

            w.document.write(`</body></html>`);
            w.document.close();
            setTimeout(() => w.print(), 500);
        }

        function getSaisiesForDate(targetDate) {
            const events = [];
            if (typeof studentWeeklyData !== 'undefined') {
                const year = targetDate.getFullYear();
                const month = targetDate.getMonth();
                const day = targetDate.getDate();

                Object.keys(studentWeeklyData).forEach(key => {
                    const entry = studentWeeklyData[key];
                    if (entry && entry.timestamp) {
                        // Parse timestamp: "dd/mm/yyyy hh:mm:ss"
                        const parts = entry.timestamp.split(' ')[0].split('/');
                        if (parts.length === 3) {
                            const entryDate = new Date(parts[2], parts[1] - 1, parts[0]);
                            if (entryDate.getFullYear() === year && entryDate.getMonth() === month && entryDate.getDate() === day) {
                                // Extract Name
                                const lastUnderscore = key.lastIndexOf('_w');
                                let namePart = key;
                                if (lastUnderscore > 0) {
                                    namePart = key.substring(0, lastUnderscore);
                                }
                                events.push({
                                    type: 'saisie',
                                    key: key,
                                    name: namePart.replace(/_/g, ' '),
                                    notes: entry.notes,
                                    status: entry.status,
                                    timestamp: entry.timestamp
                                });
                            }
                        }
                    }
                });
            }
            return events;
        }

        // --- RDV Drag & Drop and Copy/Paste Utilities ---
        let copiedRdvData = null;

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:5px; z-index:32000; box-shadow:0 0 10px rgba(0,0,0,0.5); font-weight:bold;";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function handleRdvDragStart(e, rdvId) {
            if (e) {
                e.dataTransfer.setData("text/plain", rdvId);
                e.dataTransfer.effectAllowed = e.ctrlKey ? "copy" : "move";
            }
        }

        function handleRdvDropOnCell(e, dateStr, timeStr) {
            e.preventDefault();
            const rdvId = e.dataTransfer.getData("text/plain");
            if (!rdvId || isNaN(rdvId)) return;

            const rdv = appData.rdv.find(r => r.id == rdvId);
            if (!rdv) return;

            // Direct Move (or Drag-Copy if Ctrl held)
            if (e.ctrlKey) {
                // Copy
                const newId = Date.now();
                const clone = {
                    ...rdv,
                    id: newId,
                    date: dateStr,
                    time: timeStr || rdv.time, // Use new time or keep original if null (Month View)
                    status: 'pending'
                };
                appData.rdv.push(clone);
                saveData();
                renderRdvCalendar(); // Refresh
                showToast("RDV Dupliqué");
            } else {
                // Move
                rdv.date = dateStr;
                if (timeStr) rdv.time = timeStr; // Only update time if specific time dropped
                saveData();
                renderRdvCalendar(); // Refresh
            }
        }

        function copyRdvToClipboard(rdvId) {
            const rdv = appData.rdv.find(r => r.id == rdvId);
            if (rdv) {
                copiedRdvData = { ...rdv };
                showToast("RDV Copié (Ctrl+V pour coller)");
            }
        }

        // Initialize Global Paste Listener (Hover based)
        let hoveredRdvSlot = null; // {date: 'yyyy-mm-dd', time: 'HH:mm'}

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && (e.key === 'v' || e.key === 'V')) {
                // If we have copied data, a hovered slot, and NO modal open
                const modal = document.getElementById('addRdvModal');
                if (copiedRdvData && hoveredRdvSlot && (!modal || modal.style.display === 'none')) {
                    e.preventDefault();

                    // Direct Paste (Create new RDV)
                    const newId = Date.now();
                    const clone = {
                        ...copiedRdvData,
                        id: newId,
                        date: hoveredRdvSlot.date,
                        time: hoveredRdvSlot.time || copiedRdvData.time,
                        status: 'pending' // Reset status for new copy
                    };
                    appData.rdv.push(clone);
                    saveData();
                    renderRdvCalendar(); // Refresh view
                    showToast(`RDV Collé le ${hoveredRdvSlot.date} à ${hoveredRdvSlot.time}`);
                    return;
                }

                // Fallback: If no hover but global view open => Open modal pre-filled (Old logic)
                const rdvView = document.getElementById('rdvView');
                if (copiedRdvData && rdvView && rdvView.style.display !== 'none' && (!modal || modal.style.display === 'none')) {
                    // Only if NOT hovering a slot (otherwise handled above)
                    if (!hoveredRdvSlot) {
                        e.preventDefault();
                        openAddRdvModal(null, copiedRdvData.date, copiedRdvData.time);
                        setTimeout(() => {
                            const titleInput = document.getElementById('rdvTitle');
                            const typeSelect = document.getElementById('rdvType');
                            if (titleInput) titleInput.value = copiedRdvData.title || '';
                            if (typeSelect) typeSelect.value = copiedRdvData.type || 'standard';
                        }, 50);
                    }
                }
            }
        });

        function handleStudentNameDragStart(e) {
            const nom = document.getElementById('sheet-display-nom').textContent;
            const prenom = document.getElementById('sheet-display-prenom').textContent;
            e.dataTransfer.setData("text/plain", `${nom} ${prenom}`);
            e.dataTransfer.setData("application/x-student-name", `${nom} ${prenom}`);
        }

        function handleStudentNameDropInModal(e) {
            e.preventDefault();
            const data = e.dataTransfer.getData("application/x-student-name") || e.dataTransfer.getData("text/plain");
            if (data) {
                e.target.value = data;
            }
        }

        function renderRdvMonth(grid, display) {
            const year = currentRdvDate.getFullYear();
            const month = currentRdvDate.getMonth();
            display.textContent = new Date(year, month).toLocaleString('fr-FR', { month: 'long', year: 'numeric' }).toUpperCase();

            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
            grid.style.gap = '10px';
            grid.style.overflowY = 'auto'; // Ensure scrollable
            grid.style.height = '100%';    // Take full height
            grid.style.autoRows = 'minmax(120px, auto)'; // Increased min-height and auto expansion

            // Headers
            const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            days.forEach(d => {
                const h = document.createElement('div');
                h.textContent = d;
                h.style.textAlign = 'center';
                h.style.fontWeight = 'bold';
                h.style.color = '#aaa';
                grid.appendChild(h);
            });

            const firstDay = new Date(year, month, 1);
            let startDay = firstDay.getDay() - 1;
            if (startDay === -1) startDay = 6;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7; // Complete the grid to full weeks

            // --- Fill Previous Month Days ---
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = 0; i < startDay; i++) {
                const dayNum = prevMonthLastDay - (startDay - 1) + i;
                const cell = document.createElement('div');
                cell.style.background = 'transparent';
                cell.style.border = '1px solid #333';
                cell.style.opacity = '0.5';
                cell.style.padding = '5px';
                cell.style.display = 'flex';
                cell.style.flexDirection = 'column';

                const num = document.createElement('div');
                num.textContent = dayNum;
                num.style.fontWeight = 'bold';
                num.style.color = '#666';
                cell.appendChild(num);
                grid.appendChild(cell);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.style.background = 'rgba(30,30,30,0.8)';
                cell.style.border = '1px solid #444';
                cell.style.borderRadius = '5px';
                cell.style.padding = '5px';
                cell.style.display = 'flex';
                cell.style.flexDirection = 'column';
                cell.style.position = 'relative';

                const dateNum = document.createElement('div');
                dateNum.textContent = d;
                dateNum.style.fontWeight = 'bold';
                dateNum.style.marginBottom = '5px';
                cell.appendChild(dateNum);

                // Hover Tracking (Month View)
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                // Drop Zone (Month View)
                cell.ondragover = (e) => { e.preventDefault(); cell.style.background = 'rgba(0, 255, 0, 0.1)'; };
                cell.ondrop = (e) => handleRdvDropOnCell(e, dateStr, null); // Time null = preserve original

                cell.onmouseenter = () => {
                    cell.style.background = 'rgba(255,255,255,0.05)';
                    hoveredRdvSlot = { date: dateStr, time: null }; // Time preserved from copy logic
                };
                cell.onmouseleave = () => {
                    cell.style.background = 'rgba(30,30,30,0.8)';
                    hoveredRdvSlot = null;
                };

                // Show RDVs
                const rdvs = (appData.rdv || []).filter(r => r.date === dateStr);
                rdvs.forEach(r => {
                    const rdvEl = document.createElement('div');
                    rdvEl.textContent = (r.time ? r.time + ' ' : '') + r.title;

                    if (r.type === 'famille') {
                        rdvEl.style.background = '#FFD700';
                        rdvEl.style.color = 'black';
                    } else if (r.type === 'reunion') {
                        rdvEl.style.background = '#9C27B0';
                        rdvEl.style.color = 'white';
                    } else {
                        // Standard
                        if (r.status === 'validated') {
                            rdvEl.style.background = '#4CAF50';
                            rdvEl.style.color = 'white';
                        } else if (r.status === 'cancelled') {
                            rdvEl.style.background = '#F44336';
                            rdvEl.style.color = 'white';
                        } else {
                            // Pending
                            rdvEl.style.background = '#FFB6C1';
                            rdvEl.style.color = 'black';
                        }
                    }

                    rdvEl.style.fontSize = '0.8rem';
                    rdvEl.style.padding = '2px 4px';
                    rdvEl.style.borderRadius = '3px';
                    rdvEl.style.marginBottom = '2px';
                    rdvEl.style.cursor = 'pointer';
                    // Allow text wrap
                    rdvEl.style.whiteSpace = 'normal';

                    rdvEl.draggable = true;
                    rdvEl.ondragstart = (e) => handleRdvDragStart(e, r.id);
                    rdvEl.oncontextmenu = (e) => { e.preventDefault(); copyRdvToClipboard(r.id); };

                    rdvEl.onclick = (e) => { e.stopPropagation(); editRdv(r.id); };
                    cell.appendChild(rdvEl);
                });

                cell.ondblclick = () => {
                    currentRdvDate = new Date(year, month, d);
                    setRdvViewMode('day');
                };

                grid.appendChild(cell);
            }

            // Fill remaining cells for the last week (Next Month Days)
            const cellsFilled = startDay + daysInMonth;
            let nextMonthDay = 1;
            for (let i = cellsFilled; i < totalCells; i++) {
                const cell = document.createElement('div');
                cell.style.background = 'transparent';
                cell.style.border = '1px solid #333';
                cell.style.opacity = '0.5';
                cell.style.padding = '5px';
                cell.style.display = 'flex';
                cell.style.flexDirection = 'column';

                const num = document.createElement('div');
                num.textContent = nextMonthDay;
                num.style.fontWeight = 'bold';
                num.style.color = '#666';
                cell.appendChild(num);

                grid.appendChild(cell);
                nextMonthDay++;
            }
        }

        function renderRdvWeek(grid, display) {
            // Calculate start of week (Monday)
            const startOfWeek = new Date(currentRdvDate);
            const day = startOfWeek.getDay() || 7;
            // Use setDate instead of setHours to avoid DST/Timezone issues
            if (day !== 1) startOfWeek.setDate(startOfWeek.getDate() - (day - 1));

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);

            display.textContent = `Semaine du ${startOfWeek.toLocaleDateString()} au ${endOfWeek.toLocaleDateString()}`;

            // Main Container
            grid.style.display = 'flex';
            grid.style.flexDirection = 'column';
            grid.style.height = '100%';
            grid.style.overflow = 'hidden';

            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startOfWeek);
                d.setDate(d.getDate() + i);
                weekDates.push(d);
            }

            // Scrollable Time Grid (Now includes Sticky Headers)
            const scrollArea = document.createElement('div');
            scrollArea.style.flex = '1';
            scrollArea.style.overflowY = 'auto';
            scrollArea.style.display = 'grid';
            scrollArea.style.gridTemplateColumns = '60px repeat(7, 1fr)';
            // 08:00 to 20:00
            const startHour = 8;
            const endHour = 20;
            const slotsPerHour = 4; // 15 mins
            const totalSlots = (endHour - startHour) * slotsPerHour;

            scrollArea.style.gridTemplateRows = `40px repeat(${totalSlots}, minmax(40px, auto))`;

            // Sticky Header Corner
            const corner = document.createElement('div');
            corner.style.background = '#333';
            corner.style.borderBottom = '1px solid #555';
            corner.style.gridColumn = '1';
            corner.style.gridRow = '1';
            corner.style.position = 'sticky';
            corner.style.top = '0';
            corner.style.zIndex = '100';
            scrollArea.appendChild(corner);

            // Sticky Header Days
            for (let i = 0; i < 7; i++) {
                const h = document.createElement('div');
                h.textContent = weekDates[i].toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' });
                h.style.padding = '10px';
                h.style.textAlign = 'center';
                h.style.fontWeight = 'bold';
                h.style.borderLeft = '1px solid #555';
                h.style.background = '#333';
                h.style.borderBottom = '1px solid #555';
                h.style.gridColumn = `${i + 2}`;
                h.style.gridRow = '1';
                h.style.position = 'sticky';
                h.style.top = '0';
                h.style.zIndex = '100';
                scrollArea.appendChild(h);
            }

            // Time Labels
            for (let i = 0; i < totalSlots; i++) {
                const totalMinutes = (startHour * 60) + (i * 15);
                const h = Math.floor(totalMinutes / 60);
                const m = totalMinutes % 60;
                const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                const label = document.createElement('div');
                label.textContent = timeStr;
                label.style.textAlign = 'right';
                label.style.padding = '5px 10px 0 0';
                label.style.color = '#aaa';
                label.style.fontSize = '0.8rem';
                label.style.borderBottom = '1px solid #444';
                label.style.gridColumn = '1';
                label.style.gridRow = `${i + 2}`; // Shift +1 for header
                scrollArea.appendChild(label);
            }

            // Grid Cells & Events
            for (let col = 0; col < 7; col++) {
                const currentDate = weekDates[col];
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;

                // Create background cells for interaction
                for (let row = 0; row < totalSlots; row++) {
                    const cell = document.createElement('div');
                    cell.style.borderLeft = '1px solid #444';
                    cell.style.borderBottom = '1px solid #444';
                    cell.style.gridColumn = `${col + 2}`;
                    cell.style.gridRow = `${row + 2}`; // Shift +1 for header
                    cell.style.cursor = 'pointer';
                    cell.title = "Ajouter un RDV";

                    // Calculate time for this cell
                    const totalMinutes = (startHour * 60) + (row * 15);
                    const h = Math.floor(totalMinutes / 60);
                    const m = totalMinutes % 60;
                    const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                    cell.onclick = () => openAddRdvModal(null, dateStr, timeStr);

                    // Drop Zone
                    cell.ondragover = (e) => { e.preventDefault(); cell.style.background = 'rgba(0, 255, 0, 0.1)'; };
                    cell.ondrop = (e) => handleRdvDropOnCell(e, dateStr, timeStr);

                    // Hover effect & Tracking
                    cell.onmouseenter = () => {
                        cell.style.background = 'rgba(255,255,255,0.05)';
                        hoveredRdvSlot = { date: dateStr, time: timeStr };
                    };
                    cell.onmouseleave = () => {
                        cell.style.background = 'transparent';
                        hoveredRdvSlot = null;
                        // Small delay to prevent flickering null if quickly moving? 
                        // Actually strict null is safer to avoid accidental paste.
                    };

                    scrollArea.appendChild(cell);
                }

                // Place RDVs directly
                const rdvs = (appData.rdv || []).filter(r => r.date === dateStr);

                rdvs.forEach(r => {
                    if (!r.time) return;
                    const [h, m] = r.time.split(':').map(Number);
                    if (h < startHour || h >= endHour) return;
                    const minutesFromStart = (h * 60 + m) - (startHour * 60);
                    const rowStart = Math.floor(minutesFromStart / 15) + 1;

                    // Duration Handling
                    const duration = r.duration || 15;
                    const rowSpan = Math.ceil(duration / 15);

                    const el = document.createElement('div');
                    el.innerHTML = `<b>${r.time}</b> ${r.title}<br>${r.description || ''}`;
                    el.style.wordBreak = 'break-word';

                    if (r.type === 'famille') {
                        el.style.background = '#FFD700';
                        el.style.color = 'black';
                    } else if (r.type === 'reunion') {
                        el.style.background = '#9C27B0';
                        el.style.color = 'white';
                    } else {
                        if (r.status === 'validated') {
                            el.style.background = '#4CAF50';
                            el.style.color = 'white';
                        } else if (r.status === 'cancelled') {
                            el.style.background = '#F44336';
                            el.style.color = 'white';
                        } else {
                            // Pending
                            el.style.background = '#FFB6C1';
                            el.style.color = 'black';
                        }
                    }

                    el.style.fontSize = '0.75rem';
                    el.style.padding = '5px';
                    el.style.borderRadius = '3px';
                    el.style.overflow = 'hidden';
                    el.style.cursor = 'pointer';
                    el.style.pointerEvents = 'auto'; // Re-enable clicks
                    el.style.zIndex = '10';
                    el.style.margin = '1px';

                    // Direct Grid Placement
                    el.style.gridColumn = `${col + 2}`;
                    el.style.gridRow = `${parseInt(rowStart) + 1} / span ${rowSpan}`; // Shift +1 for Header

                    el.draggable = true;
                    el.ondragstart = (e) => handleRdvDragStart(e, r.id);
                    el.oncontextmenu = (e) => { e.preventDefault(); copyRdvToClipboard(r.id); };
                    el.onclick = (e) => { e.stopPropagation(); editRdv(r.id); };

                    scrollArea.appendChild(el);
                });

                // Place Saisies (Keep as overlay for now, or group them too?)
                // Let's keep them separate but maybe offset them if needed.
                // For now, existing logic for Saisies is fine as they have margin-left.
                // DISABLED SAISIES IN RDV VIEW
                /*
                const saisies = getSaisiesForDate(currentDate);
                saisies.forEach(s => {
                    // Extract time from timestamp "dd/mm/yyyy hh:mm:ss"
                    const timePart = s.timestamp.split(' ')[1];
                    if (!timePart) return;
                    const [h, m] = timePart.split(':').map(Number);
                    if (h < startHour || h >= endHour) return;

                    const minutesFromStart = (h * 60 + m) - (startHour * 60);
                    const rowStart = Math.floor(minutesFromStart / 30) + 1;

                    const el = document.createElement('div');
                    el.textContent = `Saisie: ${s.name}`;
                    el.style.background = '#2196F3';
                    el.style.color = 'white';
                    el.style.fontSize = '0.75rem';
                    el.style.padding = '2px';
                    el.style.borderRadius = '3px';
                    el.style.overflow = 'hidden';
                    el.style.whiteSpace = 'nowrap';
                    el.style.textOverflow = 'ellipsis';
                    el.style.cursor = 'pointer';
                    el.title = s.notes;
                    el.style.zIndex = '10';

                    el.style.gridColumn = `${col + 2}`;
                    el.style.gridRow = `${rowStart} / span 1`;
                    el.style.margin = '1px 1px 1px 15px'; // Indent slightly to distinguish

                    scrollArea.appendChild(el);
                });
                */
            }

            grid.appendChild(scrollArea);
        }

        function renderRdvDay(grid, display) {
            const dateStr = `${currentRdvDate.getFullYear()}-${String(currentRdvDate.getMonth() + 1).padStart(2, '0')}-${String(currentRdvDate.getDate()).padStart(2, '0')}`;
            display.textContent = currentRdvDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();

            grid.style.display = 'flex';
            grid.style.flexDirection = 'column';
            grid.style.height = '100%';
            grid.style.overflow = 'hidden';

            // Scrollable Time Grid
            const scrollArea = document.createElement('div');
            scrollArea.style.flex = '1';
            scrollArea.style.overflowY = 'auto';
            scrollArea.style.display = 'grid';
            scrollArea.style.gridTemplateColumns = '50px 1fr';

            const startHour = 8;
            const endHour = 20;
            const slotsPerHour = 4; // 15 mins (Modified from 6/10mins)
            const totalSlots = (endHour - startHour) * slotsPerHour;

            // Auto-expanding rows starting at 60px
            scrollArea.style.gridTemplateRows = `repeat(${totalSlots}, minmax(40px, auto))`;

            // Time Labels & Rows
            for (let i = 0; i < totalSlots; i++) {
                const totalMinutes = (startHour * 60) + (i * 15);
                const h = Math.floor(totalMinutes / 60);
                const m = totalMinutes % 60;
                const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                // Label
                const label = document.createElement('div');
                label.textContent = timeStr;
                label.style.textAlign = 'right';
                label.style.padding = '10px 5px 0 0';
                label.style.color = '#aaa';
                label.style.fontSize = '1rem';
                label.style.borderBottom = '1px solid #444';
                label.style.gridColumn = '1';
                label.style.gridRow = `${i + 1}`;
                scrollArea.appendChild(label);

                // Cell
                const cell = document.createElement('div');
                cell.style.borderLeft = '1px solid #444';
                cell.style.borderBottom = '1px solid #444';
                cell.style.gridColumn = '2';
                cell.style.gridRow = `${i + 1}`;
                cell.style.cursor = 'pointer';
                cell.style.position = 'relative';

                cell.onclick = () => openAddRdvModal(null, dateStr, timeStr);

                // Drop Zone (Day View)
                cell.ondragover = (e) => { e.preventDefault(); cell.style.background = 'rgba(0, 255, 0, 0.1)'; };
                cell.ondrop = (e) => handleRdvDropOnCell(e, dateStr, timeStr);

                cell.onmouseenter = () => {
                    cell.style.background = 'rgba(255,255,255,0.05)';
                    hoveredRdvSlot = { date: dateStr, time: timeStr };
                };
                cell.onmouseleave = () => {
                    cell.style.background = 'transparent';
                    hoveredRdvSlot = null;
                };

                scrollArea.appendChild(cell);
            }

            // Place RDVs directly
            const rdvs = (appData.rdv || []).filter(r => r.date === dateStr);

            rdvs.forEach(r => {
                if (!r.time) return;
                const [h, m] = r.time.split(':').map(Number);
                if (h < startHour || h >= endHour) return;
                const minutesFromStart = (h * 60 + m) - (startHour * 60);
                const rowStart = Math.floor(minutesFromStart / 15) + 1;

                // Duration Handling
                const duration = r.duration || 15;
                const rowSpan = Math.ceil(duration / 15);

                const el = document.createElement('div');
                el.innerHTML = `<b>${r.time}</b> ${r.title}<br><span style="font-size:0.8em">${r.description || ''}</span>`;

                if (r.type === 'famille') {
                    el.style.background = '#FFD700';
                    el.style.color = 'black';
                } else if (r.type === 'reunion') {
                    el.style.background = '#9C27B0';
                    el.style.color = 'white';
                } else {
                    if (r.status === 'validated') {
                        el.style.background = '#4CAF50';
                        el.style.color = 'white';
                    } else if (r.status === 'cancelled') {
                        el.style.background = '#F44336';
                        el.style.color = 'white';
                    } else {
                        // En attente (not_validated or pending)
                        el.style.background = '#FFB6C1';
                        el.style.color = 'black';
                    }
                }

                el.style.padding = '8px'; // Nice padding
                el.style.borderRadius = '4px';
                el.style.cursor = 'pointer';
                el.style.pointerEvents = 'auto';
                el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)'; // Add depth
                el.style.overflow = 'hidden';
                el.style.wordBreak = 'break-word';
                el.style.zIndex = '10';
                el.style.margin = '2px';

                // Direct Grid Placement
                el.style.gridColumn = '2';
                el.style.gridRow = `${rowStart} / span ${rowSpan}`;

                el.draggable = true;
                el.ondragstart = (e) => handleRdvDragStart(e, r.id);
                el.oncontextmenu = (e) => { e.preventDefault(); copyRdvToClipboard(r.id); };
                el.onclick = (e) => { e.stopPropagation(); editRdv(r.id); };

                scrollArea.appendChild(el);
            });
            grid.appendChild(scrollArea);
        }

        let currentRdvStudents = [];
        let currentRdvType = 'standard'; // 'standard', 'famille', 'reunion'
        let currentSelectedSlots = [];

        function openRdvTypeSelection() {
            document.getElementById('rdvTypeModal').style.display = 'flex';
        }

        function selectRdvType(type) {
            document.getElementById('rdvTypeModal').style.display = 'none';
            openAddRdvModal(null, null, null, type);
        }

        function updateAvailableSlots() {
            const dateInput = document.getElementById('rdvDate');
            const listContainer = document.getElementById('rdvAvailableSlotsList');
            const mainContainer = document.getElementById('rdvAvailableSlotContainer');
            const selectedContainer = document.getElementById('rdvSelectedSlotsContainer');
            const selectedList = document.getElementById('rdvSelectedSlotsList');

            console.log('=== updateAvailableSlots called ===');
            console.log('dateInput:', dateInput);
            console.log('dateInput.value:', dateInput ? dateInput.value : 'NULL');
            console.log('listContainer:', listContainer);
            console.log('mainContainer:', mainContainer);
            console.log('appData.rdv exists:', appData.rdv ? 'YES' : 'NO');
            console.log('appData.rdv length:', appData.rdv ? appData.rdv.length : 'N/A');

            if (!dateInput || !dateInput.value) {
                console.log('No date selected, hiding slots');
                if (mainContainer) mainContainer.style.display = 'none';
                if (selectedContainer) selectedContainer.style.display = 'none';
                return;
            }

            console.log('✓ Date selected:', dateInput.value);
            console.log('✓ Showing mainContainer');
            if (mainContainer) {
                mainContainer.style.display = 'block';
                console.log('✓ mainContainer.style.display set to block');
            } else {
                console.error('ERROR: mainContainer is null!');
            }

            // --- Helper: Render Selected Slots ---
            const renderSelected = () => {
                if (!selectedList) return;
                selectedList.innerHTML = '';
                currentSelectedSlots.sort();

                if (currentSelectedSlots.length > 0) {
                    if (selectedContainer) selectedContainer.style.display = 'block';
                    currentSelectedSlots.forEach(slotTime => {
                        const chip = document.createElement('div');
                        chip.textContent = slotTime;
                        chip.style.background = '#E91E63';
                        chip.style.color = 'white';
                        chip.style.padding = '2px 8px';
                        chip.style.borderRadius = '12px';
                        chip.style.fontSize = '0.8rem';
                        chip.style.cursor = 'pointer';
                        chip.title = "Cliquez pour retirer";

                        // Click to deselect
                        chip.onclick = () => {
                            currentSelectedSlots = currentSelectedSlots.filter(t => t !== slotTime);
                            // Update input
                            if (currentSelectedSlots.length > 0) {
                                document.getElementById('rdvTime').value = currentSelectedSlots[0];
                            } else {
                                document.getElementById('rdvTime').value = '';
                            }
                            updateAvailableSlots(); // Re-render available list
                        };
                        selectedList.appendChild(chip);
                    });
                } else {
                    if (selectedContainer) selectedContainer.style.display = 'none';
                }
            };
            renderSelected();


            if (listContainer) {
                listContainer.innerHTML = '';
                const dateStr = dateInput.value;

                // --- Occupied Calculation (Duration Support) ---
                const occupiedTimes = new Set();
                const existingRdvs = (appData.rdv || []).filter(r => r.date === dateStr);

                existingRdvs.forEach(r => {
                    const startT = r.time;
                    const duration = r.duration || 15;
                    if (startT) {
                        const [h, m] = startT.split(':').map(Number);
                        const startMin = h * 60 + m;
                        // Mark all 15-min slots covered by this RDV as occupied
                        for (let t = 0; t < duration; t += 15) {
                            const curMin = startMin + t;
                            const curH = Math.floor(curMin / 60);
                            const curM = curMin % 60;
                            const timeStr = `${String(curH).padStart(2, '0')}:${String(curM).padStart(2, '0')}`;
                            occupiedTimes.add(timeStr);
                        }
                    }
                });

                const startHour = 8;
                const endHour = 20;
                
                console.log('=== Generating time slots from', startHour, 'to', endHour, '===');
                let slotCount = 0;

                for (let h = startHour; h < endHour; h++) {
                    for (let m = 0; m < 60; m += 15) {
                        const timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                        // Check if time is occupied OR already selected
                        if (!occupiedTimes.has(timeStr) && !currentSelectedSlots.includes(timeStr)) {
                            const slot = document.createElement('div');
                            slot.textContent = timeStr;

                            slot.style.background = '#444';
                            slot.style.color = 'white';
                            slot.style.padding = '2px 6px';
                            slot.style.fontSize = '0.8rem';
                            slot.style.borderRadius = '3px';
                            slot.style.cursor = 'pointer';

                            slot.onclick = () => {
                                if (currentRdvType === 'reunion') {
                                    // Multi-select behavior
                                    if (!currentSelectedSlots.includes(timeStr)) {
                                        currentSelectedSlots.push(timeStr);
                                    }
                                } else {
                                    // Single select behavior (clear others)
                                    currentSelectedSlots = [timeStr];
                                }

                                // Update input with first selected
                                if (currentSelectedSlots.length > 0) {
                                    currentSelectedSlots.sort();
                                    document.getElementById('rdvTime').value = currentSelectedSlots[0];
                                }
                                updateAvailableSlots(); // Re-render to move from Available to Selected
                            };
                            listContainer.appendChild(slot);
                            slotCount++;
                        }
                    }
                }
                
                console.log('✓✓✓ Total slots generated:', slotCount);
                console.log('✓✓✓ Occupied times:', occupiedTimes.size);
                console.log('✓✓✓ Selected slots:', currentSelectedSlots.length);

                console.log('Total slots in container:', listContainer.children.length);

                if (listContainer.children.length === 0) {
                    listContainer.innerHTML = '<span style="color:#888; font-style:italic;">Aucun créneau disponible</span>';
                }
            }
        }

        function openAddRdvModal(rdvId = null, defaultDate = null, defaultTime = null, type = 'standard') {
            // Vérifier si l'application est verrouillée
            if (isApplicationLocked()) {
                alert('🔒 Application verrouillée\n\nLe logiciel est en mode consultation uniquement.\nVous ne pouvez pas créer ou modifier de RDV.\n\nCliquez sur le bouton "Déverrouiller" en haut de l\'\u00e9cran.');
                return;
            }
            
            const modal = document.getElementById('rdvModal');
            modal.style.display = 'flex';
            const btnDelete = document.getElementById('btnDeleteRdv');

            // Reset state
            currentSelectedSlots = [];

            // Reset Search
            document.getElementById('rdvStudentSearch').value = '';
            document.getElementById('rdvSearchResults').style.display = 'none';
            currentRdvStudents = [];
            
            // Update CPE names list
            updateCpeNamesList();

            // Set Type
            currentRdvType = type;
            const modalTitle = document.querySelector('#rdvModal h2');
            const studentSection = document.getElementById('rdvStudentSection');
            const cpeSection = document.getElementById('rdvCpeSection');
            const statusSection = document.getElementById('rdvStatusSection');

            // Reset visibility
            studentSection.style.display = 'block';
            cpeSection.style.display = 'block';
            statusSection.style.display = 'flex';

            if (type === 'famille') {
                modalTitle.textContent = "Nouveau RDV Famille";
                modalTitle.style.color = '#FFD700';
                document.getElementById('rdvStudentSearch').placeholder = "Rechercher Nom de Famille (Élève)...";
            } else if (type === 'reunion') {
                modalTitle.textContent = "RDV Réunion";
                modalTitle.style.color = '#9C27B0';
                studentSection.style.display = 'none'; // Hide student search for meetings? Or keep it? User said "fiche simple avec info reunion simple"
                // Maybe hide student search for reunion if it's just a meeting
                // But user might want to link students. Let's hide it for "simple" request.
                studentSection.style.display = 'none';
                cpeSection.style.display = 'none'; // Hide CPE name for reunion?
                statusSection.style.display = 'none'; // Hide status for reunion?
            } else {
                modalTitle.textContent = "Nouveau Rendez-vous";
                modalTitle.style.color = 'white';
                document.getElementById('rdvStudentSearch').placeholder = "Rechercher un élève...";
            }

            // POPULATE MOTIFS SELECTOR
            const motifSelect = document.getElementById('rdvDescSelect');
            if (motifSelect) {
                // Collect existing motifs from all RDVs
                const motifs = new Set();
                appData.rdv.forEach(r => {
                    if (r.description && r.description.trim().length > 2) {
                        motifs.add(r.description.trim());
                    }
                });
                // Sort
                const sortedMotifs = Array.from(motifs).sort();

                // Clear and Rebuild Options
                motifSelect.innerHTML = '<option value="">-- Choisir un motif existant --</option>';
                sortedMotifs.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m.substring(0, 50) + (m.length > 50 ? '...' : '');
                    motifSelect.appendChild(opt);
                });
            }

            if (rdvId) {
                const rdv = appData.rdv.find(r => r.id === rdvId);
                if (rdv) {
                    currentRdvType = rdv.type || 'standard'; // Restore type
                    // Update UI based on restored type
                    if (currentRdvType === 'famille') {
                        modalTitle.textContent = "Modifier RDV Famille";
                        modalTitle.style.color = '#FFD700';
                        document.getElementById('rdvStudentSearch').placeholder = "Rechercher Nom de Famille (Élève)...";
                    } else if (currentRdvType === 'reunion') {
                        modalTitle.textContent = "Modifier Réunion";
                        modalTitle.style.color = '#9C27B0';
                        studentSection.style.display = 'none';
                        cpeSection.style.display = 'none';
                        statusSection.style.display = 'none';
                    } else {
                        modalTitle.textContent = "Modifier Rendez-vous";
                        modalTitle.style.color = 'white';
                    }

                    document.getElementById('rdvTitle').value = rdv.title;
                    document.getElementById('rdvDate').value = rdv.date;
                    document.getElementById('rdvTime').value = rdv.time;
                    document.getElementById('rdvDesc').value = rdv.description;
                    document.getElementById('rdvCpeName').value = rdv.cpeName || '';
                    setRdvStatus(rdv.status || 'not_validated');

                    // Recover duration to populate currentSelectedSlots for editing
                    currentSelectedSlots = [];
                    if (rdv.time) {
                        const startDuration = rdv.duration || 15;
                        const [h, m] = rdv.time.split(':').map(Number);
                        const startMin = h * 60 + m;
                        for (let t = 0; t < startDuration; t += 15) {
                            const curMin = startMin + t;
                            const curH = Math.floor(curMin / 60);
                            const curM = curMin % 60;
                            const timeStr = `${String(curH).padStart(2, '0')}:${String(curM).padStart(2, '0')}`;
                            currentSelectedSlots.push(timeStr);
                        }
                    }

                    // Load students if any
                    if (rdv.students && Array.isArray(rdv.students)) {
                        currentRdvStudents = [...rdv.students];
                    }

                    modal.dataset.editId = rdvId;
                    if (btnDelete) btnDelete.style.display = 'block';
                }
            } else {
                document.getElementById('rdvTitle').value = '';
                // Use local date string instead of toISOString() to avoid timezone shifts
                const now = currentRdvDate || new Date();
                const localDateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                document.getElementById('rdvDate').value = defaultDate || localDateStr;
                document.getElementById('rdvTime').value = defaultTime || '';
                document.getElementById('rdvDesc').value = '';
                document.getElementById('rdvCpeName').value = '';
                setRdvStatus('not_validated');
                delete modal.dataset.editId;
                if (btnDelete) btnDelete.style.display = 'none';
            }
            
            // Initialiser appData.rdv si nécessaire
            if (!appData.rdv) appData.rdv = [];
            
            renderRdvSelectedStudents();
            
            // Forcer l'affichage immédiat des créneaux horaires
            // Attendre que le DOM soit bien à jour
            setTimeout(() => {
                // Vérifier que la date est bien définie
                const dateInput = document.getElementById('rdvDate');
                console.log('Forcing slot update - date value:', dateInput ? dateInput.value : 'null');
                
                // Forcer l'affichage du conteneur de créneaux
                const mainContainer = document.getElementById('rdvAvailableSlotContainer');
                if (mainContainer) {
                    mainContainer.style.display = 'block';
                    console.log('MainContainer forced to display block');
                }
                
                updateAvailableSlots();
            }, 100);
        }

        function searchRdvStudents(query) {
            const resultsDiv = document.getElementById('rdvSearchResults');
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            const q = query.toLowerCase();
            const matches = [];

            // Helper to process a student
            const processStudent = (student, className) => {
                if (!student) return;
                const nom = (student.nom || '').toLowerCase();
                const prenom = (student.prenom || '').toLowerCase();
                const fullName = `${student.nom || ''} ${student.prenom || ''}`.trim();

                if (!fullName) return;

                let score = 0;
                if (nom.startsWith(q)) score = 100;
                else if (nom.includes(q)) score = 50;
                else if (prenom.startsWith(q)) score = 20;
                else if (prenom.includes(q)) score = 10;
                else if (fullName.toLowerCase().includes(q)) score = 5;

                if (score > 0) {
                    // Avoid duplicates
                    if (!matches.find(m => m.name === fullName && m.class === className)) {
                        matches.push({
                            name: fullName,
                            class: className,
                            id: student.id || Date.now(),
                            score: score
                        });
                    }
                }
            };

            // Search in appData
            if (appData && appData.students) {
                Object.keys(appData.students).forEach(className => {
                    const classObj = appData.students[className];
                    if (classObj) {
                        Object.values(classObj).forEach(student => {
                            processStudent(student, className);
                        });
                    }
                });
            }

            // Fallback: Search in berliozData if available and matches is empty
            if (matches.length === 0 && typeof berliozData !== 'undefined' && berliozData.students) {
                berliozData.students.forEach(student => {
                    processStudent(student, student.classe || 'Inconnue');
                });
            }

            // Sort by score descending
            matches.sort((a, b) => b.score - a.score);

            if (matches.length === 0) {
                resultsDiv.style.display = 'none';
                return;
            }

            resultsDiv.innerHTML = '';
            matches.slice(0, 10).forEach(m => {
                const div = document.createElement('div');
                div.textContent = `${m.name} (${m.class})`;
                div.style.padding = '5px';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #333';
                div.onmouseenter = () => div.style.background = '#444';
                div.onmouseleave = () => div.style.background = 'transparent';
                div.onclick = () => addStudentToRdv(m.name, m.class);
                resultsDiv.appendChild(div);
            });
            resultsDiv.style.display = 'block';
        }

        function addStudentToRdv(name, className) {
            if (currentRdvStudents.length >= 4) {
                alert('Maximum 4 élèves');
                return;
            }

            const displayName = className ? `${name} (${className})` : name;

            if (!currentRdvStudents.includes(displayName)) {
                currentRdvStudents.push(displayName);
                renderRdvSelectedStudents();
                updateRdvTitleFromStudents();
            }
            document.getElementById('rdvStudentSearch').value = '';
            document.getElementById('rdvSearchResults').style.display = 'none';
        }

        function removeStudentFromRdv(index) {
            currentRdvStudents.splice(index, 1);
            renderRdvSelectedStudents();
            updateRdvTitleFromStudents();
        }

        function renderRdvSelectedStudents() {
            const container = document.getElementById('rdvSelectedStudents');
            container.innerHTML = '';
            currentRdvStudents.forEach((s, idx) => {
                const chip = document.createElement('div');
                chip.style.background = '#E91E63';
                chip.style.color = 'white';
                chip.style.padding = '2px 8px';
                chip.style.borderRadius = '12px';
                chip.style.fontSize = '0.8rem';
                chip.style.display = 'flex';
                chip.style.alignItems = 'center';
                chip.style.gap = '5px';

                const text = document.createElement('span');
                text.textContent = s;
                text.style.cursor = 'pointer';
                text.style.textDecoration = 'underline';
                text.title = "Ouvrir la fiche élève";

                text.onclick = (e) => {
                    e.stopPropagation();
                    let found = null;
                    const nameToSearch = s.includes('(') ? s.split('(')[0].trim() : s;

                    // Search in appData
                    if (appData && appData.students) {
                        for (const cls in appData.students) {
                            for (const key in appData.students[cls]) {
                                const st = appData.students[cls][key];
                                const fullName = `${st.nom || ''} ${st.prenom || ''}`.trim();
                                if (fullName === nameToSearch) {
                                    found = st;
                                    break;
                                }
                            }
                            if (found) break;
                        }
                    }

                    // Fallback search in berliozData if not found in appData
                    if (!found && typeof berliozData !== 'undefined' && berliozData.students) {
                        found = berliozData.students.find(st => {
                            const fullName = `${st.nom || ''} ${st.prenom || ''}`.trim();
                            return fullName === nameToSearch;
                        });
                    }

                    if (found) {
                        openStudentSheet(found, null);
                    } else {
                        alert("Fiche élève introuvable pour : " + s);
                    }
                };

                const close = document.createElement('span');
                close.textContent = '×';
                close.style.cursor = 'pointer';
                close.style.fontWeight = 'bold';
                close.onclick = () => removeStudentFromRdv(idx);

                chip.appendChild(text);
                chip.appendChild(close);
                container.appendChild(chip);
            });
        }

        function updateRdvTitleFromStudents() {
            const titleInput = document.getElementById('rdvTitle');
            if (currentRdvStudents.length > 0) {
                titleInput.value = currentRdvStudents.join(', ');
            }
        }

        function setRdvStatus(status) {
            document.getElementById('rdvStatus').value = status;

            const btnValid = document.getElementById('btnStatusValid');
            const btnInvalid = document.getElementById('btnStatusInvalid');
            const btnCancel = document.getElementById('btnStatusCancelled');

            // Reset all to transparent default
            if (btnValid) { btnValid.style.background = 'transparent'; btnValid.style.color = '#4CAF50'; }
            if (btnInvalid) { btnInvalid.style.background = 'transparent'; btnInvalid.style.color = '#FF9800'; }
            if (btnCancel) { btnCancel.style.background = 'transparent'; btnCancel.style.color = '#F44336'; }

            // Active Highlight
            if (status === 'validated' && btnValid) {
                btnValid.style.background = '#4CAF50';
                btnValid.style.color = 'white';
            } else if (status === 'cancelled' && btnCancel) {
                btnCancel.style.background = '#F44336';
                btnCancel.style.color = 'white';
            } else if ((status === 'not_validated' || status === 'pending') && btnInvalid) {
                if (!currentRdvType || currentRdvType === 'standard') {
                    btnInvalid.style.background = '#FFB6C1';
                    btnInvalid.style.color = 'black';
                } else {
                    btnInvalid.style.background = '#FF9800';
                    btnInvalid.style.color = 'white';
                }
            }
        }

        function deleteCurrentRdv() {
            const modal = document.getElementById('rdvModal');
            if (modal.dataset.editId) {
                if (confirm('Supprimer ce rendez-vous ?')) {
                    const id = parseInt(modal.dataset.editId);
                    appData.rdv = appData.rdv.filter(r => r.id !== id);
                    saveAppData();
                    closeRdvModal();
                    renderRdvCalendar();
                }
            }
        }

        // Global state for navigation context
        let lastStudentSheetData = null;

        // Update CPE names datalist
        function updateCpeNamesList() {
            const datalist = document.getElementById('cpeNamesList');
            if (!datalist) return;
            
            datalist.innerHTML = '';
            
            if (appData.cpeNames && appData.cpeNames.length > 0) {
                appData.cpeNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    datalist.appendChild(option);
                });
            }
        }

        function closeRdvModal() {
            document.getElementById('rdvModal').style.display = 'none';
            // Restore Student Sheet if context exists
            if (lastStudentSheetData) {
                openStudentSheet(lastStudentSheetData.student, lastStudentSheetData.elementId);
                lastStudentSheetData = null; // Clear context
            }
        }

        function saveRdv() {
            // Vérifier si l'application est verrouillée
            if (isApplicationLocked()) {
                alert('🔒 Application verrouillée\n\nLe logiciel est en mode consultation uniquement.\nVous ne pouvez pas sauvegarder de RDV.\n\nCliquez sur le bouton "Déverrouiller" en haut de l\'écran.');
                return;
            }
            
            const title = document.getElementById('rdvTitle').value;
            const date = document.getElementById('rdvDate').value;
            const time = document.getElementById('rdvTime').value;
            const desc = document.getElementById('rdvDesc').value;
            const status = document.getElementById('rdvStatus').value;
            const cpeName = document.getElementById('rdvCpeName').value;

            if (!title || !date) {
                alert('Titre et Date requis');
                return;
            }

            if (!appData.rdv) appData.rdv = [];

            const modal = document.getElementById('rdvModal');

            // Determine logical time slots to process
            let timesToSave = [];
            if (currentSelectedSlots && currentSelectedSlots.length > 0) {
                timesToSave = [...currentSelectedSlots];
            } else if (time) {
                timesToSave = [time];
            }

            if (timesToSave.length === 0) {
                alert('Heure requise');
                return;
            }

            // --- Merge Logic (Consecutive Slots) ---
            timesToSave.sort();
            const toMin = (t) => {
                const [h, m] = t.split(':').map(Number);
                return h * 60 + m;
            };

            let mergedRdvs = [];
            if (timesToSave.length > 0) {
                let currentSequence = [timesToSave[0]];

                for (let i = 1; i < timesToSave.length; i++) {
                    const prev = toMin(currentSequence[currentSequence.length - 1]);
                    const curr = toMin(timesToSave[i]);

                    // Check consecutiveness (15 min diff)
                    if (curr - prev === 15) {
                        currentSequence.push(timesToSave[i]);
                    } else {
                        mergedRdvs.push(currentSequence);
                        currentSequence = [timesToSave[i]];
                    }
                }
                mergedRdvs.push(currentSequence);
            }

            if (modal.dataset.editId) {
                const id = parseInt(modal.dataset.editId);
                const idx = appData.rdv.findIndex(r => r.id === id);
                if (idx !== -1) {
                    // Update primary entry with first sequence
                    const firstSeq = mergedRdvs[0];
                    appData.rdv[idx] = {
                        ...appData.rdv[idx],
                        title,
                        date,
                        time: firstSeq[0],
                        duration: firstSeq.length * 15, // Store total duration in minutes
                        description: desc,
                        status,
                        cpeName,
                        students: currentRdvStudents,
                        type: currentRdvType
                    };

                    // Create new entries for other sequences (if gap existed)
                    for (let i = 1; i < mergedRdvs.length; i++) {
                        const seq = mergedRdvs[i];
                        const newRdv = {
                            id: Date.now() + i,
                            title,
                            date,
                            time: seq[0],
                            duration: seq.length * 15,
                            description: desc,
                            status,
                            cpeName,
                            students: [...currentRdvStudents],
                            type: currentRdvType
                        };
                        appData.rdv.push(newRdv);
                    }
                }
            } else {
                // Creation Mode
                mergedRdvs.forEach((seq, index) => {
                    const newRdv = {
                        id: Date.now() + index,
                        title,
                        date,
                        time: seq[0],
                        duration: seq.length * 15,
                        description: desc,
                        status,
                        cpeName,
                        students: [...currentRdvStudents], // Clone array to avoid ref sharing
                        type: currentRdvType
                    };
                    appData.rdv.push(newRdv);
                });
            }

            saveAppData();
            
            // Save CPE name to history if provided
            if (cpeName && cpeName.trim()) {
                if (!appData.cpeNames) appData.cpeNames = [];
                const trimmedName = cpeName.trim();
                if (!appData.cpeNames.includes(trimmedName)) {
                    appData.cpeNames.push(trimmedName);
                    saveAppData();
                    updateCpeNamesList();
                }
            }
            
            const wasEditing = !!modal.dataset.editId;
            closeRdvModal(); // This will trigger sheet restore if applicable
            renderRdvCalendar();

            // If we just saved (edited or created), and we went back to student sheet, refresh its list
            if (lastStudentSheetData) {
                // Wait for modal transition then refresh
                /* Actually closeRdvModal already reopened the sheet, 
                   but lastStudentSheetData is nulled there. 
                   Wait, if I null it in closeRdvModal, I can't check it here.
                   But closeRdvModal calls openStudentSheet which calls renderStudentRdvList.
                   So the list should be auto-refreshed!
                   The openStudentSheet function rebuilds the entire sheet.
                 */
            }
        }

        function printConvocation() {
            const title = document.getElementById('rdvTitle').value;
            const dateVal = document.getElementById('rdvDate').value;
            const time = document.getElementById('rdvTime').value;
            const desc = document.getElementById('rdvDesc').value;
            const cpeName = document.getElementById('rdvCpeName').value || "Le(a) CPE";
            const status = document.getElementById('rdvStatus').value;

            if (!dateVal || !time) {
                alert("Veuillez renseigner la date et l'heure pour imprimer la convocation.");
                return;
            }

            const dateObj = new Date(dateVal);
            const dateStr = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            let studentNames = currentRdvStudents.join(', ');
            if (!studentNames) studentNames = "l'élève";

            // STYLE LOGIC
            let detailsBg = '#f9f9f9';
            if ((!currentRdvType || currentRdvType === 'standard') && (status === 'not_validated' || status === 'pending')) {
                detailsBg = '#FFB6C1'; // Light Pink
            }

            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <title>Convocation</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 40px; max-width: 800px; margin: 0 auto; color: #000; line-height: 1.6; }
                        .header { text-align: center; margin-bottom: 50px; border-bottom: 2px solid #000; padding-bottom: 20px; }
                        .establishment { font-size: 1.2rem; font-weight: bold; text-transform: uppercase; }
                        .title { font-size: 2rem; font-weight: bold; text-align: center; margin: 40px 0; text-transform: uppercase; letter-spacing: 2px; text-decoration: underline; }
                        .content { font-size: 1.2rem; margin-bottom: 40px; text-align: justify; }
                        .details { margin: 20px 0; padding: 20px; border: 1px solid #ccc; background: ${detailsBg}; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .signature { text-align: right; margin-top: 60px; font-weight: bold; font-size: 1.2rem; }
                        .footer { margin-top: 100px; font-size: 0.8rem; text-align: center; color: #666; border-top: 1px solid #ccc; padding-top: 10px; }
                        @media print {
                            body { padding: 0; }
                            .details { background: ${detailsBg} !important; border: 1px solid #000; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="establishment">Vie Scolaire</div>
                        <div>Service CPE</div>
                    </div>

                    <div style="text-align: right; margin-bottom: 20px;">
                        Le ${new Date().toLocaleDateString('fr-FR')}
                    </div>

                    <div class="title">CONVOCATION</div>

                    <div class="content">
                        <p><strong>${studentNames}</strong></p>
                        
                        <p>Vous êtes convoqué(e) au bureau de le (a) CPE pour un entretien.</p>
                        
                        <div class="details">
                            <p><strong>Date :</strong> ${dateStr}</p>
                            <p><strong>Heure :</strong> <span style="font-size: 2em; font-weight: bold; font-style: italic;">${time}</span></p>
                            ${desc ? `<p><strong>Motif :</strong> ${desc}</p>` : ''}
                        </div>

                        <p>La présence à cet entretien est obligatoire sauf évaluation, le rdv sera reporté.</p>
                    </div>

                    <div style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-end;">
                         <div style="font-weight: bold; font-style: italic;">Retour en cours à :</div>
                         <div class="signature" style="margin-top: 0;">
                            ${cpeName}
                        </div>
                    </div>

                    <div class="footer">
                        Document généré le ${new Date().toLocaleString('fr-FR')}
                    </div>
                </body>
                </html>
            `);
            w.document.close();
            setTimeout(() => w.print(), 500);
        }

        function editRdv(id) {
            openAddRdvModal(id);
        }

        function changeAgendaMonth(delta) {
            currentAgendaDate.setMonth(currentAgendaDate.getMonth() + delta);
            renderAgenda();
        }

        function renderAgenda() {
            const grid = document.getElementById('agendaGrid');
            const display = document.getElementById('agendaMonthDisplay');
            grid.innerHTML = '';

            const year = currentAgendaDate.getFullYear();
            const month = currentAgendaDate.getMonth();

            display.textContent = new Date(year, month).toLocaleString('fr-FR', { month: 'long', year: 'numeric' }).toUpperCase();

            // First day of month
            const firstDay = new Date(year, month, 1);
            // Adjust for Monday start (0=Sun, 1=Mon)
            let startDay = firstDay.getDay() - 1;
            if (startDay === -1) startDay = 6;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Empty slots before
            for (let i = 0; i < startDay; i++) {
                const cell = document.createElement('div');
                cell.style.background = 'rgba(255,255,255,0.05)';
                cell.style.borderRadius = '5px';
                grid.appendChild(cell);
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.style.background = 'rgba(30,30,30,0.8)';
                cell.style.border = '1px solid #444';
                cell.style.borderRadius = '5px';
                cell.style.padding = '5px';
                cell.style.minHeight = '100px';
                cell.style.position = 'relative';

                // Double click to open daily view
                cell.ondblclick = () => renderDailyView(new Date(year, month, d));

                const dateNum = document.createElement('div');
                dateNum.textContent = d;
                dateNum.style.fontWeight = 'bold';
                dateNum.style.marginBottom = '5px';
                dateNum.style.color = 'var(--primary-color)';
                cell.appendChild(dateNum);

                // Find events for this day
                const events = [];
                if (typeof studentWeeklyData !== 'undefined') {
                    Object.keys(studentWeeklyData).forEach(key => {
                        const entry = studentWeeklyData[key];
                        // NEW LOGIC: Use EFFECTIVE DATE for Agenda Placement (Ignore Timestamp/Creation Date)
                        const lastUnderscore = key.lastIndexOf('_w');
                        if (lastUnderscore > 0) {
                            const weekId = key.substring(lastUnderscore + 2);
                            const effectiveDates = [];

                            // 1. Specific Days (granular entries)
                            if (entry.days && Object.keys(entry.days).length > 0) {
                                Object.keys(entry.days).forEach(dIdx => {
                                    const dObj = entry.days[dIdx];
                                    if (dObj.notes || dObj.status) {
                                        const effDate = getDateFromWeekId(weekId, parseInt(dIdx));
                                        if (effDate) effectiveDates.push({ date: effDate, notes: dObj.notes, status: dObj.status });
                                    }
                                });
                            }
                            // 2. Global Fallback if no specific days but global data exists
                            else if (entry.notes || entry.status) {
                                let dayIndex = 0; // Default to Monday
                                if (entry.timestamp) {
                                    // Try to preserve the "Day of Week" from the timestamp
                                    const parts = entry.timestamp.split(' ');
                                    if (parts.length > 0) {
                                        const dParts = parts[0].split('/');
                                        if (dParts.length === 3) {
                                            // Create date object (Month is 0-indexed)
                                            const tDate = new Date(parseInt(dParts[2]), parseInt(dParts[1]) - 1, parseInt(dParts[0]));
                                            // Get day (0=Sun, 1=Mon...) - Convert to 0=Mon, 6=Sun for our helper ??
                                            // Actually our helper getDateFromWeekId uses 0=Monday? Let's check.
                                            // Standard ISO weeks: Monday is start.
                                            // JS getDay(): 0=Sun, 1=Mon, ..., 6=Sat.
                                            // Let's assume getDateFromWeekId expects 0=Monday (based on common usage in this file).
                                            // We need to verify `getDateFromWeekId`.
                                            // Assuming it does:
                                            let jsDay = tDate.getDay(); // 0(Sun) to 6(Sat)
                                            // Convert to 0(Mon) ... 6(Sun)
                                            let weekDayIdx = jsDay - 1;
                                            if (weekDayIdx === -1) weekDayIdx = 6;
                                            dayIndex = weekDayIdx;
                                        }
                                    }
                                }
                                const effDate = getDateFromWeekId(weekId, dayIndex);
                                if (effDate) effectiveDates.push({ date: effDate, notes: entry.notes, status: entry.status });
                            }

                            // Check matches for current Day Cell (d) of the loop
                            effectiveDates.forEach(eff => {
                                if (eff.date.getFullYear() === year && eff.date.getMonth() === month && eff.date.getDate() === d) {
                                    let namePart = key.substring(0, lastUnderscore);
                                    events.push({
                                        key: key,
                                        name: namePart.replace(/_/g, ' '),
                                        notes: eff.notes,
                                        status: eff.status
                                    });
                                }
                            });
                        }
                    });
                }

                events.forEach(ev => {
                    const evDiv = document.createElement('div');
                    evDiv.style.fontSize = '0.75rem';
                    evDiv.style.background = 'rgba(0, 242, 255, 0.1)';
                    evDiv.style.marginBottom = '2px';
                    evDiv.style.padding = '2px';
                    evDiv.style.borderRadius = '3px';
                    evDiv.style.whiteSpace = 'nowrap';
                    evDiv.style.overflow = 'hidden';
                    evDiv.style.textOverflow = 'ellipsis';
                    evDiv.style.cursor = 'pointer';
                    evDiv.title = ev.name + (ev.notes ? ': ' + ev.notes : '');

                    // Color code based on status
                    if (ev.status === 'red') evDiv.style.borderLeft = '3px solid red';
                    else if (ev.status === 'orange') evDiv.style.borderLeft = '3px solid orange';
                    else if (ev.status === 'yellow') evDiv.style.borderLeft = '3px solid yellow';
                    else if (ev.status === 'green') evDiv.style.borderLeft = '3px solid green';
                    else evDiv.style.borderLeft = '3px solid var(--primary-color)';

                    evDiv.textContent = ev.name;

                    // Click handler to open student sheet
                    evDiv.onclick = (e) => {
                        e.stopPropagation();
                        // Call helper with key
                        openStudentSheetFromAgenda(ev.key);
                    };

                    // BUTTON DELETE (Cross)
                    const delBtn = document.createElement('span');
                    delBtn.textContent = ' ✖'; // Heavy Multiplication X
                    delBtn.style.color = '#ff4444';
                    delBtn.style.fontWeight = 'bold';
                    delBtn.style.cursor = 'pointer';
                    delBtn.style.marginLeft = 'auto'; // Push to right if flex
                    delBtn.style.float = 'right'; // fallback
                    delBtn.title = 'Supprimer cette saisie';

                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteEntryConfirm(ev.key);
                    };

                    evDiv.appendChild(delBtn);

                    cell.appendChild(evDiv);
                });

                // Show RDVs
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const rdvs = (appData.rdv || []).filter(r => r.date === dateStr);
                if (rdvs.length > 0) {
                    const rdvMarker = document.createElement('div');
                    rdvMarker.textContent = `${rdvs.length} RDV`;
                    rdvMarker.style.background = '#E91E63';
                    rdvMarker.style.color = 'white';
                    rdvMarker.style.fontSize = '0.7rem';
                    rdvMarker.style.padding = '2px 4px';
                    rdvMarker.style.borderRadius = '3px';
                    rdvMarker.style.marginTop = '5px';
                    rdvMarker.style.cursor = 'pointer';
                    rdvMarker.onclick = (e) => {
                        e.stopPropagation();
                        // Switch to RDV view for this day
                        currentRdvDate = new Date(year, month, d);
                        toggleRdvView();
                        setRdvViewMode('day');
                    };
                    cell.appendChild(rdvMarker);
                }

                grid.appendChild(cell);
            }
        }

        // --- GLOBAL HELPER FUNCTIONS ---

        function openStudentSheetFromAgenda(key) {
            let foundStudent = null;
            let foundWeekId = null;

            // Try to find student in appData
            if (appData.students) {
                for (const className of Object.keys(appData.students)) {
                    if (key.startsWith(className + '_')) {
                        const remainder = key.substring(className.length + 1);
                        const lastW = remainder.lastIndexOf('_w');
                        if (lastW > 0) {
                            const partialName = remainder.substring(0, lastW);
                            const weekId = remainder.substring(lastW + 2);
                            const fullStudentKey = className + '_' + partialName;

                            if (appData.students[className][fullStudentKey]) {
                                foundStudent = appData.students[className][fullStudentKey];
                                foundWeekId = weekId;
                                break;
                            }
                        }
                    }
                }
            }

            if (foundStudent) {
                openStudentSheet(foundStudent, null, foundWeekId);
            } else {
                alert("Impossible de trouver la fiche élève associée.");
            }
        }

        function deleteEntryConfirm(key) {
            if (confirm("⚠️ ATTENTION : Vous êtes sur le point de SUPPRIMER cette saisie.\n\nVoulez-vous continuer ?")) {
                if (confirm("⛔ CONFIRMATION FINALE :\n\nCette action est IRRÉVERSIBLE.\nLa saisie sera définitivement effacée de la base.\n\nÊtes-vous SÛR ?")) {
                    if (studentWeeklyData[key]) {
                        delete studentWeeklyData[key];
                        saveAppData();
                        // Also remove from appData.plans if possible/needed, but studentWeeklyData is the source 
                        // Synchronize happens in saveAppData usually.

                        renderAgenda(); // Refresh Agenda

                        // Close sheet if open 
                        const sheet = document.getElementById('studentSheetModal');
                        if (sheet && sheet.style.display !== 'none') {
                            sheet.style.display = 'none';
                        }

                        showToast("Saisie supprimée définitivement.");
                    }
                }
            }
        }

        // Toggle Edit Mode - with automatic layout freeze handling
        function toggleEditMode(forceState) {
            // If an argument is provided, enforce that state
            // forceState = true -> Edit Mode (frozen layout)
            // forceState = false -> Normal Mode (grid layout)

            if (typeof forceState !== 'undefined') {
                isEditMode = forceState;
                if (isEditMode) {
                    isLayoutFrozen = true; // Auto-sync frozen state ONLY when enabling edit mode
                }
                // When disabling edit mode (forceState=false), we DO NOT touch isLayoutFrozen.
                // This allows "Placer Élèves" mode to work with EITHER Grid or Frozen layout.
            } else {
                isEditMode = !isEditMode;
                if (isEditMode && !isLayoutFrozen) {
                    // Auto-freeze when entering edit mode
                    _freezeLayout();
                }
            }

            const btn = document.getElementById('modeBtn');
            const expertGroup = document.getElementById('expertControls');
            const tables = document.querySelectorAll('.table');
            const desk = document.getElementById('teacherDesk');
            const students = document.querySelectorAll('.student-card');

            if (isEditMode) {
                btn.textContent = "Mode: Aménager Classe";
                btn.classList.remove('active'); // Not active in layout mode
                if (expertGroup) expertGroup.style.display = 'inline-flex';

                // Enable dragging for tables/desk
                tables.forEach(el => {
                    el.classList.add('draggable-mode');
                    el.ondblclick = (e) => rotateTableElement(e.currentTarget, 18);
                    el.title = "Double-cliquez pour pivoter +18°";
                });
                desk.classList.add('draggable-mode');
                desk.style.cursor = 'move';

                // Disable student dragging in edit mode
                students.forEach(el => el.draggable = false);
            } else {
                btn.textContent = "Mode: Placer Élèves";
                btn.classList.add('active'); // ACTIVE by default for "Placer Élèves"
                if (expertGroup) expertGroup.style.display = 'none';

                // Clear selection when exiting edit mode
                clearSelection();

                // Disable table dragging
                tables.forEach(el => {
                    el.classList.remove('draggable-mode');
                    el.ondblclick = null;
                    el.title = "";
                });
                desk.classList.remove('draggable-mode');
                desk.style.cursor = 'default';

                // Enable student dragging
                students.forEach(el => el.draggable = true);
            }
        }

        // INTERNAL: Freeze layout (convert grid to absolute positioning)
        function _freezeLayout() {
            if (isLayoutFrozen) return; // Already frozen

            const classroom = document.getElementById('classroomArea');
            const classroomRect = classroom.getBoundingClientRect();
            const grid = document.getElementById('layoutGrid');
            const elementsToFreeze = [...document.querySelectorAll('.table'), document.getElementById('teacherDesk')];

            // Calculate positions relative to classroom
            const positions = elementsToFreeze.map(el => {
                const rect = el.getBoundingClientRect();
                return {
                    element: el,
                    left: rect.left - classroomRect.left,
                    top: rect.top - classroomRect.top
                };
            });

            // Hide grid and apply absolute positioning
            grid.style.display = 'none';
            positions.forEach(pos => {
                const el = pos.element;
                if (el.parentNode !== classroom) {
                    el.style.left = pos.left + 'px';
                    el.style.top = pos.top + 'px';
                    classroom.appendChild(el);
                }
                el.style.position = 'absolute';
                el.style.margin = '0';
            });

            isLayoutFrozen = true;
        }

        // Selection Logic
        let selectedElements = new Set();

        function toggleSelection(element) {
            if (selectedElements.has(element)) {
                element.classList.remove('selected');
                selectedElements.delete(element);
            } else {
                element.classList.add('selected');
                selectedElements.add(element);
            }
        }

        function selectElement(element) {
            if (!selectedElements.has(element)) {
                element.classList.add('selected');
                selectedElements.add(element);
            }
        }

        function clearSelection() {
            selectedElements.forEach(el => el.classList.remove('selected'));
            selectedElements.clear();
        }

        // Table Dragging Logic (Vanilla JS Mouse Events)
        let activeDragElement = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        // Variables for accurate snapping with rotation
        let dragVisualOffsetX = 0;
        let dragVisualOffsetY = 0;
        let dragVisualWidth = 0;
        let dragVisualHeight = 0;

        // Map to store initial positions of all selected elements
        let initialPositions = new Map();

        function startDragTable(e) {
            if (!isEditMode) return;
            // Ignore if clicking on controls or input
            if (e.target.closest('.table-controls') || e.target.tagName === 'INPUT') return;

            const target = e.currentTarget;

            // Selection Logic
            if (e.ctrlKey || e.metaKey) {
                // Toggle selection
                toggleSelection(target);
                // If we just deselected the target, we shouldn't drag it unless it was the only one?
                // Actually standard behavior is you can't drag a deselected item.
                if (!selectedElements.has(target)) {
                    return;
                }
            } else {
                // If clicking an unselected item without Ctrl, clear others and select this one
                if (!selectedElements.has(target)) {
                    clearSelection();
                    selectElement(target);
                }
                // If clicking a selected item, keep selection (to allow dragging group)
            }

            activeDragElement = target;

            dragOffsetX = e.clientX;
            dragOffsetY = e.clientY;

            // Store initial positions for ALL selected elements
            initialPositions.clear();
            selectedElements.forEach(el => {
                initialPositions.set(el, {
                    startX: parseFloat(el.style.left) || el.offsetLeft,
                    startY: parseFloat(el.style.top) || el.offsetTop
                });
            });

            // Calculate visual offsets for rotation-aware snapping (ONLY FOR ACTIVE ELEMENT)
            const classroom = document.getElementById('classroomArea');
            const classroomRect = classroom.getBoundingClientRect();
            const elRect = activeDragElement.getBoundingClientRect();

            // Current visual position relative to classroom
            const visualLeft = elRect.left - classroomRect.left;
            const visualTop = elRect.top - classroomRect.top;

            // Current style position (logical position)
            const styleLeft = parseFloat(activeDragElement.style.left) || activeDragElement.offsetLeft;
            const styleTop = parseFloat(activeDragElement.style.top) || activeDragElement.offsetTop;

            // The offset is constant during drag (as rotation doesn't change while dragging)
            dragVisualOffsetX = visualLeft - styleLeft;
            dragVisualOffsetY = visualTop - styleTop;
            dragVisualWidth = elRect.width;
            dragVisualHeight = elRect.height;

            document.addEventListener('mousemove', dragTable);
            document.addEventListener('mouseup', stopDragTable);
        }

        function dragTable(e) {
            if (!activeDragElement) return;
            e.preventDefault();

            const dx = e.clientX - dragOffsetX;
            const dy = e.clientY - dragOffsetY;

            // Calculate new position for the ACTIVE element first (to handle snapping)
            const activeInit = initialPositions.get(activeDragElement);
            let newActiveX = activeInit.startX + dx;
            let newActiveY = activeInit.startY + dy;

            // MAGNETISM / SNAPPING LOGIC (Only for active element)
            if (isMagnetActive) {
                const threshold = 15; // px

                // Calculate proposed VISUAL AABB
                const myRect = {
                    left: newActiveX + dragVisualOffsetX,
                    top: newActiveY + dragVisualOffsetY,
                    width: dragVisualWidth,
                    height: dragVisualHeight
                };
                myRect.right = myRect.left + myRect.width;
                myRect.bottom = myRect.top + myRect.height;

                const others = document.querySelectorAll('.table');
                const desk = document.getElementById('teacherDesk');
                const allElements = [...others, desk];
                const classroom = document.getElementById('classroomArea');
                const classroomRect = classroom.getBoundingClientRect();

                for (let other of allElements) {
                    // Skip if other is in the selected group (don't snap to moving neighbors)
                    if (selectedElements.has(other)) continue;

                    // Get other's VISUAL rect relative to classroom
                    const otherRectRaw = other.getBoundingClientRect();
                    const otherRect = {
                        left: otherRectRaw.left - classroomRect.left,
                        top: otherRectRaw.top - classroomRect.top,
                        right: (otherRectRaw.left - classroomRect.left) + otherRectRaw.width,
                        bottom: (otherRectRaw.top - classroomRect.top) + otherRectRaw.height,
                        width: otherRectRaw.width,
                        height: otherRectRaw.height
                    };

                    // Snap X
                    if (Math.abs(myRect.right - otherRect.left) < threshold) {
                        newActiveX = (otherRect.left - myRect.width) - dragVisualOffsetX;
                    } else if (Math.abs(myRect.left - otherRect.right) < threshold) {
                        newActiveX = otherRect.right - dragVisualOffsetX;
                    } else if (Math.abs(myRect.left - otherRect.left) < threshold) {
                        newActiveX = otherRect.left - dragVisualOffsetX;
                    } else if (Math.abs(myRect.right - otherRect.right) < threshold) {
                        newActiveX = (otherRect.right - myRect.width) - dragVisualOffsetX;
                    }

                    // Snap Y
                    if (Math.abs(myRect.bottom - otherRect.top) < threshold) {
                        newActiveY = (otherRect.top - myRect.height) - dragVisualOffsetY;
                    } else if (Math.abs(myRect.top - otherRect.bottom) < threshold) {
                        newActiveY = otherRect.bottom - dragVisualOffsetY;
                    } else if (Math.abs(myRect.top - otherRect.top) < threshold) {
                        newActiveY = otherRect.top - dragVisualOffsetY;
                    } else if (Math.abs(myRect.bottom - otherRect.bottom) < threshold) {
                        newActiveY = (otherRect.bottom - myRect.height) - dragVisualOffsetY;
                    }
                }
            }

            // Calculate the actual delta applied after snapping
            const finalDx = newActiveX - activeInit.startX;
            const finalDy = newActiveY - activeInit.startY;

            // Apply this delta to ALL selected elements
            selectedElements.forEach(el => {
                const init = initialPositions.get(el);
                el.style.left = (init.startX + finalDx) + 'px';
                el.style.top = (init.startY + finalDy) + 'px';
            });
        }

        function stopDragTable() {
            activeDragElement = null;
            document.removeEventListener('mousemove', dragTable);
            document.removeEventListener('mouseup', stopDragTable);
        }


        // Student Drag and Drop Functions (HTML5 DnD)
        function allowDrop(ev) {
            if (isEditMode) return;
            ev.preventDefault();
            if (ev.target.classList.contains('student-slot') || ev.target.classList.contains('student-list')) {
                ev.target.classList.add('drag-over');
            }
        }

        function drag(ev) {
            if (isEditMode) {
                ev.preventDefault();
                return;
            }
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            if (isEditMode) return;
            ev.preventDefault();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

            var data = ev.dataTransfer.getData("text");
            var draggedElement = document.getElementById(data);
            if (!draggedElement) return;

            let target = ev.target;

            if (target.classList.contains('student-slot')) {
                if (target.children.length === 0) {
                    target.appendChild(draggedElement);
                } else {
                    const existingStudent = target.children[0];
                    const originalParent = draggedElement.parentNode;
                    originalParent.appendChild(existingStudent);
                    target.appendChild(draggedElement);
                }
            }
            else if (target.classList.contains('student-list') || target.closest('.student-list')) {
                const list = document.getElementById('poolList');
                list.appendChild(draggedElement);
            }
        }

        const STATUS_COLORS = ['none', 'red', 'orange', 'yellow', 'lightgreen', 'darkgreen'];

        // CSV Import
        document.getElementById('csvInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');

                lines.forEach((name) => {
                    const cleanName = name.replace(/,/g, ' ').trim();
                    if (cleanName) {
                        createStudentCard(cleanName);
                    }
                });
                updateCount();
            };
            reader.readAsText(file);
            this.value = '';
        });

        // --- Compte RDV annuels par élève (clé: Classe_Nom_Prenom) ---
        function getAnnualRDVCountByStudent() {
            // Retourne un objet { 'NOM Prénom (Classe)': count } pour les RDV validés (verts)
            const rdvCounts = {};
            if (appData.rdv && Array.isArray(appData.rdv)) {
                appData.rdv.forEach(rdv => {
                    if (rdv.status === 'validated' && rdv.students && Array.isArray(rdv.students)) {
                        rdv.students.forEach(s => {
                            // s est du type "NOM Prénom (Classe)"
                            rdvCounts[s] = (rdvCounts[s] || 0) + 1;
                        });
                    }
                });
            }
            return rdvCounts;
        }

        function createStudentCard(data, id = null, isAbsent = false, status = 'none') {
            // `data` can be a string (full name) or an object {nom, prenom, classe}
            let nom = '', prenom = '';
            if (typeof data === 'object' && data !== null) {
                nom = data.nom || '';
                prenom = data.prenom || '';
            } else if (typeof data === 'string') {
                // Try to split into two parts: last + first
                const parts = data.trim().split(/\s+/);
                if (parts.length === 1) {
                    nom = parts[0];
                } else {
                    prenom = parts.pop();
                    nom = parts.join(' ');
                }
            }

            const div = document.createElement('div');
            div.className = 'student-card';
            if (isAbsent) div.classList.add('absent');

            div.draggable = true;
            // Note: ondragstart is set by caller (showClassStudents) to avoid conflicts
            div.id = id || 'student-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            div.dataset.status = status;

            // Student key for color mapping: if classe known use it, otherwise empty
            let studentKey = '';
            if (typeof data === 'object' && data !== null && data.classe) {
                studentKey = `${data.classe}_${nom}_${prenom}`;
            }
            if (studentKey) div.dataset.studentKey = studentKey;

            const lastSpan = document.createElement('span');
            lastSpan.className = 'student-last';
            lastSpan.textContent = nom;
            div.appendChild(lastSpan);

            const firstSpan = document.createElement('span');
            firstSpan.className = 'student-first';
            firstSpan.textContent = prenom;
            div.appendChild(firstSpan);


            // --- Couleur population annuelle (statistique) ---

            // Correction : la clé de population annuelle doit être du format "NOM Prénom (Classe)"
            let annualCount = 0;
            if (typeof data === 'object' && data !== null && data.nom && data.prenom && data.classe) {
                const popKey = `${data.nom} ${data.prenom} (${data.classe})`;
                // Recalcule à chaque fois pour garantir la synchro
                const annualRDVCounts = getAnnualRDVCountByStudent();
                if (annualRDVCounts && annualRDVCounts[popKey]) annualCount = annualRDVCounts[popKey];
            }



            // Synchronisation stricte avec la logique population annuelle (statistique)
            let popColor = '';
            if (annualCount === 0) popColor = 'color-grey';
            else if (annualCount === 1) popColor = 'color-blue';
            else if (annualCount === 2) popColor = 'color-purple';
            else if (annualCount === 3) popColor = 'color-orange';
            else if (annualCount >= 4 && annualCount < 7) popColor = 'color-red';
            else if (annualCount >= 7) popColor = 'color-black';


            // Appliquer la couleur de population annuelle sur toute la carte élève
            if (popColor) {
                // Couleurs de fond et texte adaptées
                let bg = '', txt = '#222';
                if (popColor === 'color-grey') { bg = '#607D8B'; txt = '#fff'; }
                else if (popColor === 'color-blue') { bg = '#2196F3'; txt = '#fff'; }
                else if (popColor === 'color-purple') { bg = '#9C27B0'; txt = '#fff'; }
                else if (popColor === 'color-orange') { bg = '#FF9800'; txt = '#222'; }
                else if (popColor === 'color-red') { bg = '#F44336'; txt = '#fff'; }
                else if (popColor === 'color-black') { bg = '#000'; txt = '#fff'; }
                div.style.background = bg;
                div.style.color = txt;
            }

            // Create status indicator
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'student-status status-' + status + (popColor ? ' ' + popColor : '');
            statusIndicator.title = 'Cliquez pour changer le statut';
            statusIndicator.onclick = function (e) {
                e.stopPropagation();
                cycleStatus(this);
            };
            div.appendChild(statusIndicator);

            // Affichage debug : clé population et nombre RDV à côté du bouton couleur
            if (typeof data === 'object' && data !== null && data.nom && data.prenom && data.classe) {
                const popKey = `${data.nom} ${data.prenom} (${data.classe})`;
                const debugSpan = document.createElement('span');
                debugSpan.style.cssText = 'font-size:0.7em; color:#fff; margin-left:6px;';
                debugSpan.textContent = `[${popKey}] RDV:${annualCount}`;
                div.appendChild(debugSpan);
            }

            // Toggle absence on card click (not status indicator)
            div.onclick = function (e) {
                if (!isEditMode && !e.target.classList.contains('student-status')) {
                    this.classList.toggle('absent');
                    // If a week is active and this card has a studentKey, persist as 'status-red' when absent, 'status-none' when present
                    try {
                        const sk = this.dataset.studentKey;
                        if (sk && window.currentWeekId) {
                            const wk = String(window.currentWeekId);
                            const s = this.classList.contains('absent') ? 'status-red' : 'status-none';
                            if (!appData.weeklyReports) appData.weeklyReports = {};
                            const key = `${sk}_w${wk}`;
                            const existing = appData.weeklyReports[key] || {};
                            existing.status = s;
                            appData.weeklyReports[key] = existing;
                            saveAppData();
                        }
                    } catch (e) { /* ignore */ }
                }
            };

            // Keep student card labels neutral (white background / dark text) on tables/pool.
            // Colors are managed from the student sheet only.

            // Note: Do NOT append to poolList here - let the caller decide where to place it
            // document.getElementById('poolList').appendChild(div);
            // updateCount();
            return div;
        }

        function cycleStatus(statusElement) {
            const card = statusElement.parentElement;
            const currentStatus = card.dataset.status || 'none';
            const currentIndex = STATUS_COLORS.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % STATUS_COLORS.length;
            const nextStatus = STATUS_COLORS[nextIndex];

            // Update status
            card.dataset.status = nextStatus;
            statusElement.className = 'student-status status-' + nextStatus;
            // Persist status to appData.weeklyReports for the currently selected week (if we have a studentKey)
            try {
                const sk = card.dataset.studentKey;
                if (sk && window.currentWeekId) {
                    const wk = String(window.currentWeekId);
                    if (!appData.weeklyReports) appData.weeklyReports = {};
                    const key = `${sk}_w${wk}`;
                    const existing = appData.weeklyReports[key] || {};
                    existing.status = nextStatus;
                    appData.weeklyReports[key] = existing;
                    saveAppData();
                }
            } catch (e) { /* ignore */ }
        }

        function updateCount() {
            const count = document.querySelectorAll('.student-card').length;
            document.getElementById('studentCount').textContent = count;
        }

        function updatePrintInfo() {
            const className = document.getElementById('className').value;
            const room = document.getElementById('roomName').value;
            const subject = document.getElementById('subjectName').value;

            // Recalculer les compteurs d'événements
            let classCount = 0;
            let totalCount = 0;
            const weeks = [36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26];

            // Parcourir toutes les données hébdomadaires (weeklyPlans ou studentWeeklyData)
            // On utilise studentWeeklyData car c'est la source fusionnée active
            // Cependant, studentWeeklyData utilise des clés composées : Class_Nom_Prenom_wX
            // On peut aussi itérer sur appData.weeklyReports pour un accès direct

            // Itération sur toutes les entrées de weeklyReports
            for (const key in appData.weeklyReports) {
                const report = appData.weeklyReports[key];
                // Check logic matches Statistics Dashboard "Priorité des Saisies"
                if ((report.notes && report.notes.trim().length > 0) || (report.status && report.status.length > 0) || report.color) {
                    totalCount++;

                    // Si une classe est sélectionnée, on vérifie si l'entrée appartient à cette classe
                    if (className && key.startsWith(className + '_')) {
                        classCount++;
                    }
                }
            }

            // Add RDV count to total (Appointments)
            if (appData.rdv && Array.isArray(appData.rdv)) {
                totalCount += appData.rdv.length;
            }

            // Mise à jour de l'affichage
            const elTotal = document.getElementById('eventsTotalDisplay');
            if (elTotal) elTotal.textContent = `Total Année: ${totalCount}`;

            let infoText = '';
            if (className) infoText += className + ' - ';
            if (room) infoText += room + ' - ';
            if (subject) infoText += subject;


            // Remove trailing dash if exists
            if (infoText.endsWith(' - ')) {
                infoText = infoText.substring(0, infoText.length - 3);
            }

            document.getElementById('printInfo').textContent = infoText;
        }

        // Save & Load Functions

        function updateKnownClassesList() {
            const dl = document.getElementById('knownClasses');
            if (!dl) return;
            dl.innerHTML = '';
            Object.keys(activeWeeksPerClass).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                dl.appendChild(opt);
            });
        }



        // ... 

        // Save & Load
        async function savePlan() {
            // Ensure current week is saved to memory first
            if (currentWeekId !== null) {
                const className = getClassName();
                if (!weeklyPlans[className]) weeklyPlans[className] = {};
                weeklyPlans[className][currentWeekId] = getSnapshot();
            }

            // Sync runtime plans to appData before saving
            appData.plans = weeklyPlans;
            appData.activeWeeksPerClass = activeWeeksPerClass;
            appData.lastUpdate = new Date().toISOString();

            // Create a comprehensive data object including all student sheets and app data
            const data = {
                ...appData, // Includes students, classes, weeklyReports, customRubriques, studentColors, plans

                // Context info
                info: {
                    className: document.getElementById('className').value,
                    room: document.getElementById('roomName').value,
                    subject: document.getElementById('subjectName').value,
                    teacher: document.getElementById('teacherNameInput').value
                },
                weeklyPlans: weeklyPlans, // Redundant with appData.plans but kept for compatibility
                currentWeekId: currentWeekId
            };

            // ... existing stringify ...
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });

            try {
                if (window.showSaveFilePicker) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: currentDocName ? currentDocName + '.json' : 'logiciel 36.json',
                        types: [{
                            description: 'JSON Files',
                            accept: { 'application/json': ['.json'] },
                        }],
                    });

                    // Capture the chosen filename as the new current doc name
                    currentDocName = handle.name.replace(/\.json$/i, '');

                    // Update the input if it was empty, to keep things consistent
                    if (!document.getElementById('className').value) {
                        document.getElementById('className').value = currentDocName;
                        // IMPORTANT: Update data object with the new class name logic
                        const newName = currentDocName;
                        // If we are auto-naming, we treat it as a Rename from "Classe Sans Nom" (or whatever was active)
                        // But savePlan has ALREADY constructed 'data'.
                        // We must reconstruct it or patch it.
                        // Simplest is to just update the info block and rely on the fact that
                        // if we Save again, it will be correct. 
                        // BUT for THIS file write, 'weeklyPlans' key is still the OLD name.
                        // THIS IS A BUG source. 

                        // Fix: Re-generate data object if name changed.
                        data.info.className = newName;
                        // We also need to remap the weeklyPlans key in the data object we are saving
                        const oldName = getClassName() === newName ? lastActiveClassName : getClassName();
                        // Actually getClassName() now returns newName because we updated the DOM.

                        // If we had data under "Classe Sans Nom" and now we save as "Classe A.json",
                        // we want the saved JSON to have "Classe A": {...}

                        if (data.weeklyPlans["Classe Sans Nom"] && newName !== "Classe Sans Nom") {
                            data.weeklyPlans[newName] = data.weeklyPlans["Classe Sans Nom"];
                            delete data.weeklyPlans["Classe Sans Nom"];
                        }

                        if (data.activeWeeksPerClass["Classe Sans Nom"] && newName !== "Classe Sans Nom") {
                            data.activeWeeksPerClass[newName] = data.activeWeeksPerClass["Classe Sans Nom"];
                            delete data.activeWeeksPerClass["Classe Sans Nom"];
                        }
                        // Update lastActiveClassName for future interaction
                        lastActiveClassName = newName;
                    }

                    // Re-stringify with potential updates
                    const updatedJsonString = JSON.stringify(data, null, 2);
                    const updatedBlob = new Blob([updatedJsonString], { type: 'application/json' });

                    const writable = await handle.createWritable();
                    await writable.write(updatedBlob);
                    await writable.close();
                } else {
                    throw new Error("File System Access API not supported");
                }
            } catch (err) {
                // ... fallback ...
            }
        }

        function downloadBackup() {
            // Fonctionnalité supprimée
            return false;
        }

        function loadPlan(input) {
            const file = input.files[0];
            if (!file) return;
            processLoadFile(file);
            input.value = '';
        }

        function processLoadFile(file) {
            // Capture filename context
            const newName = file.name.replace(/\.json$/i, '');
            if (currentDocName === newName) {
                alert("Attention : La base " + newName + " est déjà chargée sur le logiciel !");
            }
            currentDocName = newName;
            localStorage.setItem('currentDocName', currentDocName); // Persist name across reload

            const display = document.getElementById('baseNameDisplay');
            if (display) display.textContent = currentDocName;
            
            // Mettre à jour les indicateurs de base
            if (typeof updateBaseIndicators === 'function') {
                updateBaseIndicators();
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // NOUVELLE DÉTECTION: Sauvegarde Complète (format simple)
                    if (data.appData && data.weeklyPlans && data.version && data.version.includes("Sauvegarde Complète")) {
                        if (confirm("🎯 SAUVEGARDE COMPLÈTE DÉTECTÉE!\n\n" +
                            "Ce fichier contient TOUTES vos données:\n" +
                            "• Classes et élèves\n" +
                            "• Fiches élèves\n" +
                            "• Plans de classe\n" +
                            "• Calendriers\n\n" +
                            "Voulez-vous TOUT RESTAURER?\n" +
                            "(Les données actuelles seront remplacées)")) {

                            // IMPORTANT: Sauvegarder les lockSettings AVANT de restaurer
                            const currentLockSettings = appData.lockSettings ? JSON.parse(JSON.stringify(appData.lockSettings)) : null;

                            // Restaurer TOUT
                            appData = data.appData;
                            
                            // PRÉSERVER les lockSettings locaux (ne pas les écraser)
                            if (currentLockSettings) {
                                appData.lockSettings = currentLockSettings;
                                console.log("🔒 Paramètres de verrouillage préservés lors de la restauration");
                            }
                            
                            weeklyPlans = data.weeklyPlans;
                            activeWeeksPerClass = data.activeWeeksPerClass || {};
                            studentWeeklyData = data.studentWeeklyData || {};

                            // Restaurer les paramètres s'ils existent
                            if (data.settings) {
                                if (data.settings.dbName) localStorage.setItem('dbName', data.settings.dbName);
                                if (data.settings.autoSaveInterval) localStorage.setItem('autoSaveInterval', data.settings.autoSaveInterval);
                                if (data.settings.autoSaveEnabled) localStorage.setItem('autoSaveEnabled', data.settings.autoSaveEnabled);
                                if (data.settings.appPassword) localStorage.setItem('appPassword', data.settings.appPassword);
                                console.log("✅ Paramètres restaurés depuis le fichier de sauvegarde.");
                            }

                            // Sauvegarder dans localStorage
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                            localStorage.setItem('studentWeeklyData', JSON.stringify(studentWeeklyData)); // Ensure weekly data is also persisted

                            // Mettre à jour les indicateurs de base
                            if (typeof updateBaseIndicators === 'function') {
                                updateBaseIndicators();
                            }
                            
                            alert("✅ RESTAURATION COMPLÈTE RÉUSSIE!\n\n" +
                                "Toutes vos données ont été restaurées.\n" +
                                "L'application va redémarrer.");
                            location.reload();
                            return;
                        } else {
                            return; // L'utilisateur a annulé
                        }
                    }

                    // DETECTION: Backup Complet (ancien format appData) vs Plan Unique
                    if (data.students && data.plans) {
                        if (confirm("Ce fichier semble être une SAUVEGARDE GLOBALE (toutes les classes, fiches et calendriers).\n\nVoulez-vous RESTAURER TOUTES LES DONNÉES ?\n(Attention : cela écrasera les données actuelles de ce navigateur)")) {
                            // IMPORTANT: Sauvegarder les lockSettings AVANT de restaurer
                            const currentLockSettings = appData.lockSettings ? JSON.parse(JSON.stringify(appData.lockSettings)) : null;
                            
                            appData = data;
                            
                            // PRÉSERVER les lockSettings locaux
                            if (currentLockSettings) {
                                appData.lockSettings = currentLockSettings;
                                console.log("🔒 Paramètres de verrouillage préservés lors de la restauration globale");
                            }
                            
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                            alert("✓ Restauration globale réussie. L'application va redémarrer pour appliquer les changements.");
                            location.reload();
                            return;
                        }
                    }

                    // 1. Manually Reset State (instead of resetPlan which might be too aggressive)
                    weeklyPlans = {};
                    activeWeeksPerClass = {};
                    tempBatchSelection.clear();

                    // 2. Restore Info / Inputs
                    if (data.info) {
                        document.getElementById('className').value = data.info.className || '';
                        document.getElementById('roomName').value = data.info.room || '';
                        document.getElementById('subjectName').value = data.info.subject || '';
                        document.getElementById('teacherNameInput').value = data.info.teacher || '';
                    } else {
                        // Legacy handling
                        document.getElementById('className').value = '';
                    }

                    // Fallback: If class name is empty, use filename
                    if (!document.getElementById('className').value && currentDocName) {
                        document.getElementById('className').value = currentDocName;
                    }

                    updatePrintInfo();
                    const loadedClassName = getClassName(); // Now assured to be set

                    // 3. Handle Weekly Plans & Migration
                    // Case A: Legacy "Single Plan" (no weeklyPlans key)
                    if (!data.weeklyPlans) {
                        if (confirm("Ce fichier semble être un ancien format (Plan unique). Voulez-vous l'importer dans la semaine actuelle ?")) {
                            restoreSnapshot(data);
                            saveAppData(); // Synchronise et enregistre dans le localStorage
                        }
                        return; // Stop here for legacy single plan
                    }

                    // Case B: Weekly Plans Exist (Flat or Nested)
                    let loadedPlans = data.weeklyPlans || {};
                    let isFlat = false;

                    // Detect Flat Structure: check if keys are numeric (weeks) or start with F_ (holidays)
                    // AND the values look like snapshots (have .layout or .slots)
                    const keys = Object.keys(loadedPlans);
                    if (keys.length > 0) {
                        // Take first key
                        const firstKey = keys[0];
                        const firstVal = loadedPlans[firstKey];
                        // If key is a week ID (like "36") OR value is a snapshot
                        if (!isNaN(firstKey) || firstKey.startsWith('F_')) {
                            isFlat = true;
                        } else if (firstVal && (firstVal.layout || firstVal.slots)) {
                            // Backup check: if key is "ClasseName" but value is snapshot? Rare but possible if name is number
                            // Actually if it is nested, loadedPlans["ClasseName"] is an OBJECT of weeks.
                            // So firstVal would not have .layout directly.
                            // So if firstVal HAS .layout, it implies loadedPlans is a DIC of weeks (Flat).
                            isFlat = true;
                        }
                    }

                    if (isFlat) {
                        console.log("Migrating Flat/Legacy weeklyPlans...");
                        weeklyPlans[loadedClassName] = loadedPlans;

                        // Attempt to recover active weeks
                        if (data.activeWeeks) {
                            activeWeeksPerClass[loadedClassName] = data.activeWeeks;
                        } else if (data.activeWeeksPerClass && data.activeWeeksPerClass[loadedClassName]) {
                            activeWeeksPerClass[loadedClassName] = data.activeWeeksPerClass[loadedClassName];
                        } else {
                            // Deduce from keys
                            activeWeeksPerClass[loadedClassName] = Object.keys(loadedPlans);
                        }
                    } else {
                        // Nested (Correct Format)
                        weeklyPlans = loadedPlans;
                        activeWeeksPerClass = data.activeWeeksPerClass || {};

                        // Ensure activeWeeksPerClass has entry for current class
                        if (!activeWeeksPerClass[loadedClassName] && weeklyPlans[loadedClassName]) {
                            activeWeeksPerClass[loadedClassName] = Object.keys(weeklyPlans[loadedClassName]);
                        }
                    }

                    // 4. Update UI & Global State
                    lastActiveClassName = loadedClassName;
                    updateKnownClassesList();

                    // Sync Active Weeks for Modal
                    if (activeWeeksPerClass[loadedClassName]) {
                        tempBatchSelection = new Set(activeWeeksPerClass[loadedClassName]);
                    }

                    refreshCalendarState();

                    // 5. Restore View
                    currentWeekId = null; // Force reload
                    if (data.currentWeekId) {
                        selectWeek(String(data.currentWeekId));
                    } else {
                        selectWeek('36');
                    }

                    // Render Class List in Sidebar
                    renderSideBarClassList();

                    animateBaseLoadIndicators();

                } catch (err) {
                    alert("Erreur lors du chargement du fichier.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // --- SIDEBAR CLASS LIST ---
        function renderSideBarClassList() {
            const poolList = document.getElementById('poolList');
            
            // Vérifier si une classe est sélectionnée
            const currentClassName = document.getElementById('className').value;
            
            // Ne rien afficher dans poolList si aucune classe n'est sélectionnée
            if (!currentClassName || currentClassName.trim() === '') {
                poolList.innerHTML = '';
                return;
            }
            
            // Only if we have classes
            if (!appData.students || Object.keys(appData.students).length === 0) return;

            poolList.innerHTML = ''; // Clear students

            // Show classes header
            const header = document.createElement('div');
            header.innerHTML = '<h3 style="color:var(--primary-color); border-bottom:1px solid #444; padding-bottom:5px; margin-top:0;">📚 CHOIX DE LA CLASSE</h3>';
            poolList.appendChild(header);

            // List classes
            Object.keys(appData.students).sort().forEach(clsName => {
                const div = document.createElement('div');
                div.style.cssText = "padding:12px; border:1px solid #444; background:#333; margin-bottom:8px; border-radius:5px; cursor:pointer; color:#eee; font-weight:bold; transition:all 0.2s;";
                div.textContent = clsName;
                div.onmouseover = () => { div.style.background = '#444'; div.style.borderColor = 'var(--primary-color)'; };
                div.onmouseout = () => { div.style.background = '#333'; div.style.borderColor = '#444'; };
                div.onclick = () => {
                    document.getElementById('className').value = clsName;
                    updatePrintInfo();
                    // Trigger loading of students for this class
                    // Assuming updatePrintInfo or similar handles persistence, but we need to load layout
                    // Logic to load class plan:
                    // 1. Set current class
                    lastActiveClassName = clsName;
                    // 2. Select current week (re-trigger) to load plan + students
                    // Or call a function that loads the class plan specifically?
                    // selectWeek handles loading the plan for the *current class* and *week*.
                    // Since we changed className input, check if selectWeek reads from input or variable.
                    // selectWeek -> uses (internal logic using weeklyPlans[className])
                    // It relies on getClassName().

                    selectWeek(currentWeekId || '36');
                };
                poolList.appendChild(div);
            });
        }

        // Load Modal Functions
        function openLoadModal() {
            document.getElementById('loadModal').style.display = 'block';
        }

        function closeLoadModal() {
            document.getElementById('loadModal').style.display = 'none';
        }

        function triggerFileLoad() {
            closeLoadModal();
            document.getElementById('loadInput').click();
        }

        // Sidebar Tabs Logic - REMOVED (Duplicate)


        let currentDirHandle = null;

        async function triggerFolderLoad() {
            // If called from modal, close it first
            closeLoadModal();

            // Switch to files tab
            switchSidebarTab('files');

            if (!window.showDirectoryPicker) {
                alert("Votre navigateur ne supporte pas l'API File System Access.");
                return;
            }

            try {
                const dirHandle = await window.showDirectoryPicker();
                currentDirHandle = dirHandle; // Store handle for refresh
                await renderFileList();

            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error(e);
                    alert("Erreur d'accès au dossier.");
                } else {
                    const listPanel = document.getElementById('fileListPanel');
                    if (listPanel.innerHTML.includes('Chargement...')) {
                        listPanel.innerHTML = '<div style="color:#777; font-style:italic; font-size:0.85rem; padding:10px; text-align:center;">Aucun dossier chargé.<br>Cliquez sur "Ouvrir Dossier".</div>';
                    }
                }
            }
        }

        async function renderFileList() {
            if (!currentDirHandle) return;

            const listPanel = document.getElementById('fileListPanel');
            listPanel.innerHTML = '<div style="padding:10px; color:#aaa;">Chargement...</div>';

            try {
                const files = [];
                for await (const entry of currentDirHandle.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.json')) {
                        files.push(entry);
                    }
                }

                listPanel.innerHTML = ''; // Clear

                if (files.length === 0) {
                    listPanel.innerHTML = '<div style="padding:10px; color:#aaa; font-style:italic;">Aucun fichier JSON.</div>';
                    return;
                }

                // Sort files by name
                files.sort((a, b) => a.name.localeCompare(b.name));

                files.forEach(handle => {
                    const div = document.createElement('div');
                    div.className = 'file-item';

                    // Left Part: Name
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'file-name';
                    nameSpan.textContent = handle.name;
                    div.appendChild(nameSpan);

                    // Right Part: Delete Button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn-delete-file';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'Supprimer ce fichier';
                    deleteBtn.onclick = async (e) => {
                        e.stopPropagation(); // prevent selection
                        if (confirm(`Voulez-vous vraiment supprimer "${handle.name}" ?`)) {
                            try {
                                await currentDirHandle.removeEntry(handle.name);
                                renderFileList(); // Refresh list
                            } catch (err) {
                                console.error(err);
                                alert("Erreur lors de la suppression.");
                            }
                        }
                    };
                    div.appendChild(deleteBtn);

                    div.title = handle.name;

                    // Single Click: Select/Highlight
                    div.onclick = (e) => {
                        // Clear other selections
                        document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
                        div.classList.add('selected');
                    };

                    // Double Click: Load
                    div.ondblclick = async () => {
                        try {
                            const file = await handle.getFile();
                            processLoadFile(file);
                        } catch (err) {
                            console.error(err);
                            alert("Erreur lors de l'ouverture du fichier.");
                        }
                    };

                    listPanel.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                listPanel.innerHTML = '<div style="padding:10px; color:red;">Erreur lecture dossier.</div>';
            }
        }

        function resetPlan(askConfirmation = true) {
            if (!askConfirmation) {
                // Perform the reset
                performReset();
                return;
            }

            // First confirmation
            const modal = document.createElement('div');
            modal.id = 'resetConfirmModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.7); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
                font-family: Arial, sans-serif;
            `;

            modal.innerHTML = `
                <div style="background: #222; color: #fff; padding: 30px; border-radius: 10px; max-width: 500px; text-align: center;">
                    <h2 style="margin-top: 0; color: #ff6b6b;">⚠️ Réinitialiser l'année scolaire</h2>
                    <p>Cela effacera TOUTES les données de l'application sur ce navigateur.</p>
                    <p><strong>Cette action ne peut pas être annulée.</strong></p>
                    <div style="margin-top: 20px;">
                        <button onclick="performResetConfirmed()" style="background: #ff6b6b; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px;">
                            ✓ Confirmer réinitialisation
                        </button>
                        <button onclick="document.getElementById('resetConfirmModal').remove()" style="background: #444; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px;">
                            ✗ Annuler
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function executeReset() {
            try {
                performReset();
                const m1 = document.getElementById('resetConfirmModal');
                const m2 = document.getElementById('resetConfirmModal2');
                if (m1) m1.remove();
                if (m2) m2.remove();
            } catch (e) {
                console.error("Reset failed:", e);
                alert("Erreur lors de la réinitialisation: " + e.message);
            }
        }

        function performResetConfirmed() {
            // Second confirmation (must click twice)
            const modal2 = document.createElement('div');
            modal2.id = 'resetConfirmModal2';
            modal2.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                font-family: Arial, sans-serif;
            `;

            modal2.innerHTML = `
                <div style="background: #1a1a1a; color: #fff; padding: 30px; border-radius: 10px; max-width: 500px; text-align: center;">
                    <h2 style="margin-top: 0; color: #ff9999;">⚠️⚠️ DERNIER AVERTISSEMENT</h2>
                    <p>Êtes-vous <strong>ABSOLUMENT CERTAIN(E)</strong> ?</p>
                    <p style="color: #ffcccc;">Toutes les données seront définitivement effacées de la mémoire du navigateur.</p>
                    <div style="margin-top: 20px;">
                        <button onclick="executeReset()" style="background: #ff3333; color: white; border: none; padding: 12px 24px; margin: 5px; cursor: pointer; border-radius: 5px; font-weight: bold;">
                            OUI, RÉINITIALISER
                        </button>
                        <button onclick="document.getElementById('resetConfirmModal').remove(); document.getElementById('resetConfirmModal2').remove();" style="background: #444; color: white; border: none; padding: 12px 24px; margin: 5px; cursor: pointer; border-radius: 5px;">
                            Non, garder mes données
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal2);
        }

        function performReset() {
            // Clear all variables
            currentDocName = "";
            appData = {
                students: {},
                classes: {},
                studentColors: {},
                info: {},
                rdv: [],
                lockSettings: {
                    enabled: false,
                    lockDate: "2026-06-30T23:59",
                    password: "",
                    isUnlocked: false
                }
            };
            berliozData = {
                students: [],
                classes: {},
                studentsByClass: {}
            };
            weeklyPlans = {};
            activeWeeksPerClass = {};
            
            // Clear localStorage completely to wipe data
            localStorage.clear();
            
            // Clear the class name input
            const classNameInput = document.getElementById('className');
            if (classNameInput) {
                classNameInput.value = '';
            }
            
            // Update base indicators before reload
            if (typeof updateBaseIndicators === 'function') {
                updateBaseIndicators();
            }

            // Reload page to start fresh (avoids UI errors and clears memory)
            setTimeout(() => {
                window.location.reload();
            }, 100);
        }

        // ========== IMPORT BERLIOZ CSV FUNCTIONS ==========
        let berliozData = {
            students: [],
            classes: {},
            studentsByClass: {}
        };

        function triggerImportBerlioz() {
            // Au lieu d'ouvrir le sélecteur de fichier, on ouvre le module import intégré
            console.log('triggerImportBerlioz appelée');
            console.log('openImportModule existe?', typeof openImportModule);
            if (typeof openImportModule === 'function') {
                openImportModule();
            } else {
                alert('Erreur: openImportModule n\'est pas définie. Vérifiez la console.');
                console.error('openImportModule n\'est pas une fonction');
            }
        }

        function triggerImportCalendar() {
            document.getElementById('calendarInput').click();
        }

        function handleCalendarImport(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // Transformation de l'ancien format (objet listant months/weeks) ou nouveau format (tableau d'objets)

                    let newCalendarData = { months: [], weeks: [] };

                    // Cas 1: Nouveau format (Array generated by generator)
                    // Format: [{"month":"Septembre","weeks":[36,37,"F",...]}, ...]
                    if (Array.isArray(data) && data.every(m => m.month && Array.isArray(m.weeks))) {
                        data.forEach(m => {
                            const wCount = m.weeks.length;
                            // Flex = nbr semaines
                            newCalendarData.months.push({
                                name: m.month.toLowerCase(),
                                flex: wCount
                            });
                            newCalendarData.weeks.push(...m.weeks);
                        });
                    }
                    // Cas 2: Ancien format direct (Object {months: [], weeks: []})
                    else if (data.months && data.weeks && Array.isArray(data.months) && Array.isArray(data.weeks)) {
                        newCalendarData = data;
                    }
                    else {
                        throw new Error('Format JSON non reconnu. Utilisez le générateur de calendrier.');
                    }

                    // Validation minimale
                    if (newCalendarData.months.length === 0 || newCalendarData.weeks.length === 0) {
                        throw new Error("Le calendrier importé semble vide (mois ou semaines manquants).");
                    }

                    // Replace CALENDAR_DATA globalement
                    CALENDAR_DATA = newCalendarData;

                    // NEW: Prompt for School Year alignment
                    if (CALENDAR_DATA.months.length > 0) {
                        const currentYear = (appData && appData.schoolYear) ? appData.schoolYear : 2025;
                        const userYear = prompt("Pour quelle année scolaire importez-vous ce calendrier ?\n(Ex: 2025 pour 2025-2026)", currentYear);
                        const sYear = parseInt(userYear) || parseInt(currentYear);

                        // Update global setting
                        if (typeof appData === 'undefined') window.appData = {};
                        appData.schoolYear = sYear;

                        // Recalculate widths to match the chosen year's specific days layout
                        recalculateMonthWidthsForYear(CALENDAR_DATA, sYear);
                    }

                    // SAVE PERSISTENT: Mise à jour explicite de appData
                    appData.calendar = JSON.parse(JSON.stringify(CALENDAR_DATA));

                    // Clear DOM elements to force full redraw
                    try {
                        const mContainer = document.getElementById('calendarMonths');
                        if (mContainer) mContainer.innerHTML = '';
                        const sContainer = document.getElementById('calendarStrip');
                        if (sContainer) sContainer.innerHTML = '';
                    } catch (e) { }

                    // Re-init Calendar Visuals
                    initCalendar();

                    // FORCE SAVE to LocalStorage immediately
                    saveAppData();

                    console.log("✓ Calendrier importé et sauvegardé dans les données persistantes.");
                    alert(`✓ Calendrier importé avec succès pour l'année ${appData.schoolYear} !\nIl est maintenant aligné sur les semaines réelles.`);
                } catch (err) {
                    console.error(err);
                    alert('Erreur import calendrier: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Helper to recalculate Flex values based on Year
        function recalculateMonthWidthsForYear(calData, startYear) {
            if (!calData.months || calData.months.length === 0) return;

            const frenchMonths = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin',
                'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];

            // Standard Start: Sept 1st of StartYear (or late Aug depending on year)
            // Ideally we track the Monday of the week including Sept 1
            const startDate = new Date(Date.UTC(startYear, 8, 1));
            let day = startDate.getUTCDay() || 7;
            let cursor = new Date(startDate);
            cursor.setUTCDate(cursor.getUTCDate() - (day - 1)); // Back to Monday

            calData.months.forEach(m => {
                let mNameClean = m.name.toLowerCase().trim();
                let mIdx = frenchMonths.indexOf(mNameClean);
                if (mIdx === -1 && mNameClean.includes('août')) mIdx = 7;

                if (mIdx !== -1) {
                    // Determine Year for this month block
                    let y = cursor.getUTCFullYear();
                    let targetYear = y;
                    // Lookahead: if current Month is Aug/Sept, and block is Jan, it's next year
                    if (mIdx < 8 && cursor.getUTCMonth() >= 8) targetYear++;
                    // If current Month is Jan, and block is Dec, highly unlikely in this order

                    // Month End: 1st of next Month
                    let monthEnd = new Date(Date.UTC(targetYear, mIdx + 1, 1));

                    // Duration from CURRENT CURSOR to END OF THIS MONTH
                    // If cursor is already past the start of this month, we just take the remainder.
                    // If cursor is before the start (e.g. Month starts on 1st, cursor is 1st), full month.
                    // But wait, the previous block advanced the cursor.
                    // We assume blocks are contiguous.

                    // If the calculated end is BEFORE the cursor, something is wrong (dates/years mismatch).
                    // We just force valid positive duration.
                    if (monthEnd <= cursor) {
                        // Fallback or skip
                    } else {
                        let diffDays = (monthEnd - cursor) / (1000 * 60 * 60 * 24);
                        if (diffDays > 0) {
                            m.flex = diffDays / 7;
                            cursor = monthEnd;
                        }
                    }
                }
            });
        }

        function handleBerliozImport(fileInput) {
            if (!fileInput.files || !fileInput.files[0]) return;

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const csvContent = e.target.result;
                    const importedStudents = parseBerliozCSV(csvContent);

                    // Sync to appData (Merge)
                    syncBerliozToAppData(importedStudents);

                    // Rebuild UI data from appData
                    rebuildBerliozFromAppData();

                    generateClassesList();
                    showClassesTab();
                    alert('Import Berlioz réussi! ' + importedStudents.length + ' élèves importés et fusionnés.');
                } catch (err) {
                    console.error('Erreur import Berlioz:', err);
                    alert('Erreur lors de l\'import: ' + err.message);
                }
            };

            reader.readAsText(file);
            fileInput.value = '';
        }

        function parseBerliozCSV(csvContent) {
            const lines = csvContent.trim().split('\n');
            if (lines.length < 2) throw new Error('Fichier CSV vide');

            const headers = parseCSVLine(lines[0]);
            const headerMap = {};
            headers.forEach((h, idx) => {
                headerMap[h.trim()] = idx;
            });
            
            console.log('=== HEADERS DÉTECTÉS ===');
            console.log('Nombre d\'en-têtes:', headers.length);
            headers.forEach((h, idx) => {
                console.log(`  [${idx}] "${h}"`);
            });
            console.log('HeaderMap:', headerMap);

            const students = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = parseCSVLine(line);
                
                // Trouver les indices avec log pour debug
                const nomIdx = headerMap['Nom'];
                const prenomIdx = headerMap['Prénom'];
                const dobIdx = headerMap['Né(e) le'];
                const sexeIdx = headerMap['Sexe'];
                const classeIdx = headerMap['Classe'] ?? headerMap['Formation'];
                const groupesIdx = headerMap['Groupes'];
                const optionsIdx = headerMap['Toutes les options'] ?? headerMap['Options'];
                const projetIdx = headerMap['Projet d\'accompagnement'] ?? headerMap['Projet accompagnement'];
                const allergiesIdx = headerMap['Allergies'] ?? headerMap['Allergie PAI'];
                const engagementIdx = headerMap['Engagement'];
                const redoublantIdx = headerMap['Redoublant'];
                const majeurIdx = headerMap['Majeur'];
                
                if (i === 1) {
                    console.log('=== INDICES DES COLONNES ===');
                    console.log('Nom:', nomIdx, '→', values[nomIdx]);
                    console.log('Prénom:', prenomIdx, '→', values[prenomIdx]);
                    console.log('Né(e) le:', dobIdx, '→', values[dobIdx]);
                    console.log('Sexe:', sexeIdx, '→', values[sexeIdx]);
                    console.log('Classe:', classeIdx, '→', values[classeIdx]);
                    console.log('Groupes:', groupesIdx, '→', values[groupesIdx]);
                    console.log('Options:', optionsIdx, '→', values[optionsIdx]);
                    console.log('Projet:', projetIdx, '→', values[projetIdx]);
                    console.log('Allergies:', allergiesIdx, '→', values[allergiesIdx]);
                    console.log('Engagement:', engagementIdx, '→', values[engagementIdx]);
                    console.log('Redoublant:', redoublantIdx, '→', values[redoublantIdx]);
                    console.log('Majeur:', majeurIdx, '→', values[majeurIdx]);
                    console.log('=== TOUTES LES VALEURS PARSÉES (ligne 1) ===');
                    console.log('Nombre de colonnes:', values.length);
                    values.forEach((val, idx) => {
                        console.log(`  [${idx}] "${val}"`);
                    });
                }
                
                const student = {
                    nom: values[nomIdx] || values[0] || '',
                    prenom: values[prenomIdx] || values[1] || '',
                    dob: values[dobIdx] || (values[2] || ''),
                    sexe: values[sexeIdx] || '',
                    classe: extractClassName(values[classeIdx] || ''),
                    groupes: values[groupesIdx] || '',
                    options: values[optionsIdx] || '',
                    projet: values[projetIdx] || '',
                    allergies: values[allergiesIdx] || '',
                    engagement: values[engagementIdx] || '',
                    redoublant: values[redoublantIdx] || '',
                    majeur: values[majeurIdx] || ''
                };

                if (student.nom && student.classe) {
                    students.push(student);
                }
            }
            return students;
        }

        // ==========================================
        // MODULE IMPORT INTÉGRÉ - FONCTIONS
        // ==========================================
        let importStudents = [];
        let importEditingIndex = -1;

        function openImportModule() {
            document.getElementById('import-module').style.display = 'block';
            importLoadData();
        }

        function closeImportModule() {
            document.getElementById('import-module').style.display = 'none';
        }

        function importLoadData() {
            const saved = localStorage.getItem('import-students');
            if (saved) {
                importStudents = JSON.parse(saved);
                importRenderTable();
                importUpdateStats();
            }
        }

        function importSaveData() {
            localStorage.setItem('import-students', JSON.stringify(importStudents));
            localStorage.setItem('import-last-saved', new Date().toLocaleString('fr-FR'));
            importUpdateStats();
        }

        function importUpdateStats() {
            document.getElementById('import-total-students').textContent = importStudents.length;
            
            const classes = [...new Set(importStudents.map(s => s.classe))];
            document.getElementById('import-total-classes').textContent = classes.length;
            
            const lastSaved = localStorage.getItem('import-last-saved');
            document.getElementById('import-last-saved').textContent = lastSaved ? lastSaved.split(' ')[1] : '-';
        }

        function importRenderTable() {
            const tbody = document.getElementById('import-students-table');
            
            if (importStudents.length === 0) {
                tbody.innerHTML = `
                    <tr style="text-align: center; padding: 60px 20px; color: #aaa;">
                        <td colspan="13" style="padding: 60px 20px;">
                            <h3 style="font-size: 1.5rem; margin-bottom: 10px;">Aucun élève</h3>
                            <p>Commencez par ajouter un élève ou importez un fichier CSV</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = importStudents.map((student, index) => `
                <tr style="transition: background 0.2s; border-bottom: 1px solid #444;" onmouseover="this.style.background='rgba(255, 165, 0, 0.1)'" onmouseout="this.style.background=''">
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word;">${student.nom}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word;">${student.prenom}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.9em;">${student.dob || '-'}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.9em;">${student.sexe || '-'}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word;">${student.classe}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.85em;">${student.groupes || '-'}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.85em;">${student.options || '-'}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.85em;">${student.projetAccompagnement || '-'}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.85em;">${student.allergiePAI || '-'}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.85em;">${student.engagement || '-'}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.85em;">${student.redoublant || '-'}</td>
                    <td style="padding: 10px 8px; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.85em;">${student.majeur || '-'}</td>
                    <td style="padding: 10px 8px;">
                        <button onclick="importEditStudent(${index})" style="padding: 5px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; background: #2196F3; color: #fff; margin-bottom: 3px; width: 100%;">✏️</button>
                        <button onclick="importDeleteStudent(${index})" style="padding: 5px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; background: #f44336; color: #fff; width: 100%;">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        function importOpenAddStudentModal() {
            importEditingIndex = -1;
            document.getElementById('import-modal-title').textContent = 'Ajouter un élève';
            document.getElementById('import-student-form').reset();
            document.getElementById('import-student-modal').style.display = 'flex';
        }

        function importEditStudent(index) {
            importEditingIndex = index;
            const student = importStudents[index];
            document.getElementById('import-modal-title').textContent = 'Éditer un élève';
            document.getElementById('import-student-nom').value = student.nom;
            document.getElementById('import-student-prenom').value = student.prenom;
            document.getElementById('import-student-dob').value = student.dob || '';
            document.getElementById('import-student-sexe').value = student.sexe || '';
            document.getElementById('import-student-classe').value = student.classe;
            document.getElementById('import-student-groupes').value = student.groupes || '';
            document.getElementById('import-student-options').value = student.options || '';
            document.getElementById('import-student-projet').value = student.projetAccompagnement || '';
            document.getElementById('import-student-allergie').value = student.allergiePAI || '';
            document.getElementById('import-student-engagement').value = student.engagement || '';
            document.getElementById('import-student-redoublant').value = student.redoublant || '';
            document.getElementById('import-student-majeur').value = student.majeur || '';
            document.getElementById('import-student-modal').style.display = 'flex';
        }

        function importSaveStudent(event) {
            event.preventDefault();
            
            const student = {
                nom: document.getElementById('import-student-nom').value.trim(),
                prenom: document.getElementById('import-student-prenom').value.trim(),
                dob: document.getElementById('import-student-dob').value.trim(),
                sexe: document.getElementById('import-student-sexe').value.trim(),
                classe: document.getElementById('import-student-classe').value.trim(),
                groupes: document.getElementById('import-student-groupes').value.trim(),
                options: document.getElementById('import-student-options').value.trim(),
                projetAccompagnement: document.getElementById('import-student-projet').value.trim(),
                allergiePAI: document.getElementById('import-student-allergie').value.trim(),
                engagement: document.getElementById('import-student-engagement').value.trim(),
                redoublant: document.getElementById('import-student-redoublant').value.trim(),
                majeur: document.getElementById('import-student-majeur').value.trim()
            };

            if (importEditingIndex >= 0) {
                importStudents[importEditingIndex] = student;
                alert('Élève modifié avec succès');
            } else {
                importStudents.push(student);
                alert('Élève ajouté avec succès');
            }

            importSaveData();
            importRenderTable();
            importCloseModal();
        }

        function importDeleteStudent(index) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet élève ?')) {
                importStudents.splice(index, 1);
                importSaveData();
                importRenderTable();
            }
        }

        function importCloseModal() {
            document.getElementById('import-student-modal').style.display = 'none';
        }

        // FONCTION PRINCIPALE: Exporter et charger directement dans LOGECPE
        function importExportAndLoadToLOGECPE() {
            if (importStudents.length === 0) {
                alert('Aucune donnée à charger');
                return;
            }

            console.log('=== CHARGEMENT DIRECT DANS LOGECPE ===');
            console.log('Nombre d\'élèves:', importStudents.length);

            // Fonction pour formater une cellule CSV correctement
            function formatCell(value) {
                if (value === null || value === undefined) {
                    return '';
                }
                const str = String(value).trim();
                if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            }
            
            // En-têtes dans l'ordre exact attendu par LOGECPE
            const headers = ['Nom', 'Prénom', 'Né(e) le', 'Sexe', 'Classe', 'Groupes', 'Toutes les options', 'Projet accompagnement', 'Allergie PAI', 'Engagement', 'Redoublant', 'Majeur'];
            
            // Construire les lignes avec l'ordre exact des colonnes
            const rows = importStudents.map((s, idx) => {
                const row = [
                    formatCell(s.nom),
                    formatCell(s.prenom),
                    formatCell(s.dob),
                    formatCell(s.sexe),
                    formatCell(s.classe),
                    formatCell(s.groupes),
                    formatCell(s.options),
                    formatCell(s.projetAccompagnement),
                    formatCell(s.allergiePAI),
                    formatCell(s.engagement),
                    formatCell(s.redoublant),
                    formatCell(s.majeur)
                ];
                
                if (idx === 0) {
                    console.log('Première ligne de données:');
                    row.forEach((cell, i) => console.log(`  [${i}] ${headers[i]}: "${cell}"`));
                }
                
                return row;
            });

            // Créer le CSV avec virgule comme séparateur
            const csvLines = [headers.map(h => formatCell(h)), ...rows];
            const csv = csvLines.map(row => row.join(',')).join('\n');

            console.log('En-tête CSV:', csvLines[0].join(','));
            console.log('Nombre de lignes totales:', csvLines.length);

            // Parser le CSV et charger dans LOGECPE
            try {
                const parsedStudents = parseBerliozCSV(csv);
                console.log('Élèves parsés:', parsedStudents.length);
                
                if (parsedStudents.length > 0) {
                    syncBerliozToAppData(parsedStudents);
                    alert(`✅ ${parsedStudents.length} élève(s) chargé(s) avec succès dans LOGECPE !\n\nLe module Import va se fermer.`);
                    document.getElementById('import-module').style.display = 'none';
                    
                    // Rafraîchir l'affichage des classes
                    if (typeof generateClassesList === 'function') {
                        generateClassesList();
                    }
                    if (typeof updateClassesPanel === 'function') {
                        updateClassesPanel();
                    }
                    if (typeof renderSideBarClassList === 'function') {
                        renderSideBarClassList();
                    }
                    
                    // Basculer vers l'onglet Classes pour voir les classes importées
                    if (typeof switchSidebarTab === 'function') {
                        switchSidebarTab('classes');
                    }
                    
                    // Mettre à jour les indicateurs de base
                    if (typeof updateBaseIndicators === 'function') {
                        updateBaseIndicators();
                    }
                } else {
                    alert('❌ Aucun élève n\'a pu être importé. Vérifiez les données.');
                }
            } catch (error) {
                console.error('Erreur chargement:', error);
                alert('❌ Erreur lors du chargement : ' + error.message);
            }
        }

        async function importFromClipboardRPP() {
            try {
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    alert('⚠️ L\'accès au presse-papier n\'est pas supporté par votre navigateur.\nUtilisez Chrome, Edge ou Firefox récent.');
                    return;
                }

                const clipboardText = await navigator.clipboard.readText();
                
                if (!clipboardText || clipboardText.trim() === '') {
                    alert('❌ Le presse-papier est vide.\n\nCopiez d\'abord des données depuis Excel ou un fichier CSV.');
                    return;
                }

                console.log('=== IMPORT RPP (Configuration Automatique) ===');
                console.log('Mode: Détection et traitement automatique');
                
                let csvText = clipboardText;
                
                // DÉTECTION AUTOMATIQUE DU FORMAT
                const hasTab = csvText.includes('\t');
                const hasComma = csvText.includes(',');
                const hasSemicolon = csvText.includes(';');
                
                console.log('Détection format:', { hasTab, hasComma, hasSemicolon });
                
                if (hasTab) {
                    console.log('→ Format détecté: Excel/Tableur (TAB)');
                    csvText = csvText.split('\n')
                        .filter(line => line.trim())
                        .map(line => {
                            const cells = line.split('\t');
                            return cells.map(cell => {
                                const value = cell.trim();
                                if (!value) return '';
                                if (value.includes(',') || value.includes('"') || value.includes('\n') || value.includes('\r')) {
                                    return '"' + value.replace(/"/g, '""') + '"';
                                }
                                return value;
                            }).join(',');
                        })
                        .join('\n');
                    console.log('Conversion TAB → CSV terminée');
                } else if (hasSemicolon && !hasComma) {
                    console.log('→ Format détecté: CSV français (;)');
                    csvText = csvText.split('\n')
                        .filter(line => line.trim())
                        .map(line => {
                            const cells = line.split(';');
                            return cells.map(cell => {
                                const value = cell.trim().replace(/^"|"$/g, '');
                                if (!value) return '';
                                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                                    return '"' + value.replace(/"/g, '""') + '"';
                                }
                                return value;
                            }).join(',');
                        })
                        .join('\n');
                    console.log('Conversion CSV(;) → CSV(,) terminée');
                } else {
                    console.log('→ Format détecté: CSV standard (,)');
                    csvText = csvText.split('\n')
                        .filter(line => line.trim())
                        .join('\n');
                }
                
                const lines = csvText.split('\n');
                console.log('Nombre de lignes après traitement:', lines.length);
                
                importProcessCSVData(csvText);
                alert('✅ Données importées depuis RPP !');
                
            } catch (error) {
                console.error('Erreur import presse-papier:', error);
                if (error.name === 'NotAllowedError') {
                    alert('❌ Permission refusée.\n\nVeuillez autoriser l\'accès au presse-papier dans votre navigateur.');
                } else {
                    alert('❌ Erreur lors de l\'importation depuis le presse-papier :\n' + error.message);
                }
            }
        }

        function importFromCSVFile() {
            document.getElementById('import-csv-file-input').click();
        }

        function importParseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function importProcessCSVData(text) {
            try {
                if (text.charCodeAt(0) === 0xFEFF) {
                    text = text.substring(1);
                }
                const lines = text.split(/\r?\n/).filter(line => line.trim());
                
                console.log('=== TRAITEMENT CSV IMPORT MODULE ===');
                console.log('Nombre de lignes:', lines.length);
                
                if (lines.length < 2) {
                    alert('Fichier vide ou invalide');
                    return;
                }

                const imported = [];
                const headerValues = importParseCSVLine(lines[0]);
                const headerLower = headerValues.map(h => h.toLowerCase());
                
                console.log('En-têtes détectés:', headerValues);
                
                const indices = {
                    nom: headerLower.findIndex(h => h.includes('nom') && !h.includes('pr')),
                    prenom: headerLower.findIndex(h => h.includes('pr')),
                    classe: headerLower.findIndex(h => h.includes('classe')),
                    dob: headerLower.findIndex(h => {
                        const normalized = h.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                        return normalized.includes('ne(e) le') || normalized.includes('ne le') || h.includes('date') || h.includes('naissance');
                    }),
                    sexe: headerLower.findIndex(h => h.includes('sexe')),
                    groupes: headerLower.findIndex(h => h.includes('groupe')),
                    projetAccompagnement: headerLower.findIndex(h => (h.includes('projet') || h.includes('accompagnement')) && !h.includes('pai')),
                    allergiePAI: headerLower.findIndex(h => (h.includes('allergie') || h.includes('pai')) && !h.includes('projet')),
                    engagement: headerLower.findIndex(h => h.includes('engagement')),
                    redoublant: headerLower.findIndex(h => h.includes('redoublant') || h.includes('redouble')),
                    majeur: headerLower.findIndex(h => h.includes('majeur'))
                };
                
                const optionIndices = [];
                const optionNames = ['latin', 'grec', 'théâtre', 'theatre', 'arts', 'musique', 'chinois', 'eps', 
                                    'cinema', 'cinéma', 'danse', 'option', 'italien', 'russe', 'japonais'];
                
                headerLower.forEach((header, index) => {
                    const isOptionCol = optionNames.some(opt => header.includes(opt));
                    const isNotMainCol = index !== indices.nom && index !== indices.prenom && 
                                        index !== indices.classe && index !== indices.dob && 
                                        index !== indices.sexe && index !== indices.groupes && 
                                        index !== indices.projetAccompagnement &&
                                        index !== indices.allergiePAI && index !== indices.engagement &&
                                        index !== indices.redoublant && index !== indices.majeur;
                    
                    if (isOptionCol && isNotMainCol) {
                        optionIndices.push({index: index, name: headerValues[index]});
                    }
                });
                
                console.log('Colonnes d\'options détectées:', optionIndices);
                
                for (let i = 1; i < lines.length; i++) {
                    const values = importParseCSVLine(lines[i]);
                    
                    const nom = indices.nom >= 0 ? values[indices.nom] : '';
                    const prenom = indices.prenom >= 0 ? values[indices.prenom] : '';
                    
                    if (nom && prenom) {
                        const allOptions = [];
                        optionIndices.forEach(opt => {
                            const value = values[opt.index];
                            if (value && value.trim() && value.toLowerCase() !== 'non' && value !== '0') {
                                if (value.toLowerCase() === 'oui' || value === '1') {
                                    allOptions.push(opt.name);
                                } else {
                                    allOptions.push(value);
                                }
                            }
                        });
                        
                        const student = {
                            nom: nom || '',
                            prenom: prenom || '',
                            dob: indices.dob >= 0 ? (values[indices.dob] || '') : '',
                            sexe: indices.sexe >= 0 ? (values[indices.sexe] || '') : '',
                            classe: indices.classe >= 0 ? (values[indices.classe] || '') : '',
                            groupes: indices.groupes >= 0 ? (values[indices.groupes] || '') : '',
                            options: allOptions.join(', '),
                            projetAccompagnement: indices.projetAccompagnement >= 0 ? (values[indices.projetAccompagnement] || '') : '',
                            allergiePAI: indices.allergiePAI >= 0 ? (values[indices.allergiePAI] || '') : '',
                            engagement: indices.engagement >= 0 ? (values[indices.engagement] || '') : '',
                            redoublant: indices.redoublant >= 0 ? (values[indices.redoublant] || '') : '',
                            majeur: indices.majeur >= 0 ? (values[indices.majeur] || '') : ''
                        };
                        imported.push(student);
                    }
                }

                if (imported.length > 0) {
                    const replace = confirm(`${imported.length} élève(s) trouvé(s).\n\nRemplacer les données existantes ?`);
                    if (replace) {
                        importStudents = imported;
                    } else {
                        importStudents = [...importStudents, ...imported];
                    }
                    importSaveData();
                    importRenderTable();
                } else {
                    alert('Aucune donnée valide trouvée dans le fichier');
                }
            } catch (error) {
                console.error('Erreur traitement:', error);
                alert('Erreur lors du traitement : ' + error.message);
            }
        }

        function importHandleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                importHandleExcelImport(file);
            } else if (fileName.endsWith('.csv')) {
                importHandleCSVImport(file);
            } else {
                alert('Format de fichier non supporté. Utilisez .csv, .xlsx ou .xls');
            }
            
            event.target.value = '';
        }

        function importHandleExcelImport(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const csv = XLSX.utils.sheet_to_csv(worksheet);
                    importProcessCSVData(csv);
                } catch (error) {
                    console.error('Erreur import Excel:', error);
                    alert('Erreur lors de l\'importation Excel : ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function importHandleCSVImport(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    const bytes = new Uint8Array(arrayBuffer);
                    
                    let text;
                    if (bytes.length >= 2) {
                        if (bytes[0] === 0xFF && bytes[1] === 0xFE) {
                            const decoder = new TextDecoder('utf-16le');
                            text = decoder.decode(arrayBuffer);
                        } else if (bytes[0] === 0xFE && bytes[1] === 0xFF) {
                            const decoder = new TextDecoder('utf-16be');
                            text = decoder.decode(arrayBuffer);
                        } else if (bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF) {
                            const decoder = new TextDecoder('utf-8');
                            text = decoder.decode(arrayBuffer);
                        } else {
                            const decoder = new TextDecoder('utf-8');
                            text = decoder.decode(arrayBuffer);
                        }
                    } else {
                        const decoder = new TextDecoder('utf-8');
                        text = decoder.decode(arrayBuffer);
                    }
                    
                    importProcessCSVData(text);
                } catch (error) {
                    console.error('Erreur import CSV:', error);
                    alert('Erreur lors de l\'importation CSV : ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function importGenerateSample() {
            // Noms diversifiés : majorité européenne + origines africaine, maghrébine, orientale, antillaise, Europe de l'Est
            const noms = [
                // Noms européens (majorité - environ 60%)
                'MARTIN','BERNARD','DUBOIS','THOMAS','ROBERT','PETIT','DURAND','LEROY','MOREAU','SIMON','LAURENT','LEFEBVRE','MICHEL','DAVID','BERTRAND','ROUX','VINCENT','FOURNIER','MOREL','GIRARD','ANDRE','LEFEVRE','MERCIER','LAMBERT','BONNET','FRANCOIS','LEGRAND','GARNIER','FAURE','ROUSSEAU','BLANC','GUERIN','HENRY','ROUSSEL','NICOLAS','PERRIN','MORIN','MATHIEU','CLEMENT','GAUTHIER','DUMONT','FONTAINE','CHEVALIER','ROBIN','MASSON','GERARD','BOYER','DENIS','LEMAIRE','DUVAL','JOLY','GAUTIER','ROGER','ROCHE','ROY','NOEL','MEYER','LUCAS','MEUNIER','JEAN','MARCHAND','DUFOUR','BLANCHARD','MARIE','BARBIER','BRUN','DUMAS','BRUNET','LEROUX','COLIN','PIERRE','RENARD','ARNAUD','ROLLAND','CARON','AUBERT','GIRAUD','LECLERC','VIDAL','BOURGEOIS','RENAUD','LEMOINE','PICARD','GAILLARD','PHILIPPE','LECLERCQ','LACROIX','FABRE','DUPUIS','OLIVIER','HUBERT','LOUIS','CHARLES','GUILLOT','RIVIERE','LE GALL','GUILLAUME','ADAM','REY','LECOMTE','BENOIT','CARPENTIER','JULIEN','BERGER','PARIS','MAILLARD','RICHARD','BRUNEL','SCHNEIDER',
                // Noms hispaniques/ibériques (environ 10%)
                'GARCIA','MARTINEZ','LOPEZ','SANCHEZ','PEREZ','FERNANDEZ','RODRIGUEZ','GONZALEZ','HERNANDEZ','JIMENEZ','RUIZ','ALVAREZ','MORENO','MUNOZ','DA SILVA','SANTOS','OLIVEIRA','COSTA','FERREIRA','ALVES',
                // Noms maghrébins (environ 10%)
                'BEN AHMED','BENALI','BOUZID','EL AMRANI','KHALED','BENCHEIKH','MEZIANE','TOUMI','AMAR','BRAHIMI','BOUAZIZ','CHAOUCH','DJEBBAR','MANSOURI','SAADI','BEN MOHAMED','ZOUBIR','AZIZ','EL KADER','RACHID',
                // Noms africains subsahariens (environ 10%)
                'DIALLO','TRAORE','TOURE','KONE','KEITA','KANTE','CAMARA','CISSE','SYLLA','DIOP','NDIAYE','SALL','BA','SOW','DIOUF','FALL','GUEYE','THIAM','DIENG','MBAYE',
                // Noms orientaux/asiatiques (environ 5%)
                'NGUYEN','TRAN','LE','PHAM','HOANG','VU','DO','DANG','BUI','WANG','LI','ZHANG','CHEN','LIU','YANG','HUANG','WU','ZHOU','XU','SUN',
                // Noms Europe de l'Est (environ 5%)
                'KOWALSKI','NOWAK','WISNIEWSKI','LEWANDOWSKI','KAMINSKI','MULLER','SCHMIDT','SCHNEIDER','WAGNER','SCHULZ','POPESCU','IONESCU','POPA','PETROV','IVANOV','DIMITROV','KOVAC','NOVAK','HORVATH','LUKIC'
            ];
            
            // Prénoms diversifiés : majorité européenne + prénoms internationaux
            const prenoms = [
                // Prénoms européens (majorité - environ 65%)
                'Lucas','Emma','Louis','Léa','Hugo','Chloé','Gabriel','Manon','Arthur','Camille','Raphaël','Sarah','Léo','Jade','Tom','Inès','Nathan','Laura','Jules','Clara','Adam','Lola','Mathis','Alice','Paul','Zoé','Ethan','Juliette','Maxime','Louise','Antoine','Anna','Enzo','Lily','Noah','Rose','Théo','Eva','Alexandre','Léna','Timéo','Nina','Liam','Charlotte','Mathéo','Mila','Victor','Ambre','Clément','Anaïs','Axel','Maëlys','Gabin','Luna','Robin','Louna','Sacha','Victoria','Nolan','Margaux','Matéo','Sofia','Oscar','Nora','Baptiste','Lucie','Malo','Valentine','Thomas','Julia','Eden','Samuel','Valentin','Marine','Marius','Elise','Joseph','Romy','Augustin','Iris','Jules','Amy','Henri','Gabrielle','Léandre','Stella','Isaac','Alba','Simon','Héloïse','Aaron','Capucine','Eliott','Alix','Noé','Elsa','Charlie','Augustine','Gaël','Adèle','Alexis','Mia','Nicolas','Mathilde','Kylian','Pauline','Evan','Noémie','Loïc','Romane','Mathieu','Jeanne','Bastien','Olivia','Antonin','Victoire','Julien','Constance','Pierre','Philippine','Corentin','Thea','Damien','Elina','Vincent','Justine','Adrien','Marguerite','Quentin','Salomé','Romain','Lise','Dylan','Lou','Benjamin','Elena','Jordan','Célia','Mattéo','Faustine','Noam','Suzanne','Léon','Eléonore','Dorian','Clémence','Guillaume','Athéna','Ewen','Roxane','Milan','Maël','Maxence','Gaston','Félix','Léonard',
                // Prénoms maghrébins/arabes (environ 10%)
                'Yasmine','Mehdi','Ibrahim','Aya','Mohamed','Leila','Karim','Fatima','Amine','Samia','Youssef','Nadia','Rayan','Soraya','Ayoub','Amina','Hakim','Lina','Salim','Myriam',
                // Prénoms africains (environ 10%)
                'Amadou','Fatoumata','Mamadou','Awa','Ousmane','Aminata','Ibrahima','Mariam','Moussa','Aissatou','Sekou','Kadiatou','Boubacar','Maimouna','Adama','Bintou','Souleymane','Oumou','Cheikh','Coumba',
                // Prénoms orientaux/asiatiques (environ 8%)
                'Li','Wei','Mei','Lin','Jing','Tuan','Linh','Anh','Minh','Thao','Huy','Kim','Duc','Lan','Hung','Mai','Long','Nga','Binh','Phuong',
                // Prénoms Europe de l'Est (environ 7%)
                'Marta','Piotr','Anna','Jakub','Katarzyna','Marek','Natalia','Adrian','Maria','Dimitri','Elena','Ivan','Olga','Alexandru','Diana','Andrei','Cristina','Nikola','Petra','Luka',
                // Prénoms antillais/créoles (intégrés dans les prénoms français traditionnels)
                'Marie-Claire','Jean-Baptiste','Rose-Marie','Marc-Antoine','Marie-Josée','Jean-Luc','Anne-Sophie','Jean-François','Marie-Ange','Jean-Paul'
            ];
            
            // 50 classes : Seconde (10) + Première G (8) + Première Techno (5) + Terminale G (8) + Terminale Techno (5) + BTS1 (7) + BTS2 (7)
            const classes = [
                '2GT1','2GT2','2GT3','2GT4','2GT5','2GT6','2GT7','2GT8','2GT9','2GT10',
                '1G1','1G2','1G3','1G4','1G5','1G6','1G7','1G8',
                '1STMG1','1STMG2','1STI2D','1ST2S','1STL',
                'TG1','TG2','TG3','TG4','TG5','TG6','TG7','TG8',
                'TSTMG1','TSTMG2','TSTI2D','TST2S','TSTL',
                'BTS1 MCO','BTS1 NDRC','BTS1 CG','BTS1 SIO','BTS1 SAM','BTS1 COM','BTS1 GPME',
                'BTS2 MCO','BTS2 NDRC','BTS2 CG','BTS2 SIO','BTS2 SAM','BTS2 COM','BTS2 GPME'
            ];
            
            // Toutes les spécialités et options possibles
            const specialites = ['Maths','Physique-Chimie','SVT','SES','HGGSP','HLP','LLCER Anglais','LLCER Espagnol','NSI','SI','Arts Plastiques','Musique','Théâtre','Biologie-Ecologie'];
            const optionsFacultatives = ['Latin','Grec','Chinois','Italien','Japonais','Russe','Arabe','Arts','Musique','Théâtre','EPS','Maths expertes','Maths complémentaires','Droit et grands enjeux'];
            const groupesTechno = ['Management','Droit','Économie','Mercatique','GRH','Gestion-Finance','SIG','Physique','Chimie','Mécanique','Électronique','Énergétique','CBSV','Biotechnologie'];
            const projets = ['','PAP','PAI','PPRE','PPS','AESH'];
            const allergies = ['','Arachides','Lactose','Gluten','Fruits à coque','Œufs','Poisson','Soja','Moutarde'];
            const engagements = ['','Délégué','CVL','Eco-délégué','Conseil de vie','Bureau des élèves','Maison des lycéens','CESC','Association sportive'];
            
            const sampleData = [];
            for (let i = 0; i < 1500; i++) {
                const nom = noms[Math.floor(Math.random() * noms.length)];
                const prenom = prenoms[Math.floor(Math.random() * prenoms.length)];
                const classe = classes[Math.floor(Math.random() * classes.length)];
                
                // Déterminer l'année de naissance selon le niveau
                let year = 2009; // Par défaut Seconde
                if (classe.startsWith('2GT')) year = 2009;
                else if (classe.startsWith('1')) year = 2008;
                else if (classe.startsWith('T')) year = 2007;
                else if (classe.startsWith('BTS1')) year = 2006;
                else if (classe.startsWith('BTS2')) year = 2005;
                
                // Variation ±1 an pour redoublants/avance
                if (Math.random() > 0.9) year -= 1;
                else if (Math.random() > 0.95) year += 1;
                
                const month = String(1 + Math.floor(Math.random() * 12)).padStart(2, '0');
                const day = String(1 + Math.floor(Math.random() * 28)).padStart(2, '0');
                const dob = `${day}/${month}/${year}`;
                const sexe = Math.random() > 0.5 ? 'M' : 'F';
                
                // Groupes et options selon le type de classe
                let grp = '';
                let opt = '';
                
                if (classe.startsWith('1G') || classe.startsWith('TG')) {
                    // Lycée général : 3 spécialités en 1ère, 2 en Term
                    const nbSpec = classe.startsWith('1G') ? 3 : 2;
                    const specs = [];
                    for (let j = 0; j < nbSpec; j++) {
                        let spec = specialites[Math.floor(Math.random() * specialites.length)];
                        while (specs.includes(spec)) {
                            spec = specialites[Math.floor(Math.random() * specialites.length)];
                        }
                        specs.push(spec);
                    }
                    grp = specs.join(', ');
                    // Option facultative (30% de chance)
                    if (Math.random() > 0.7) {
                        opt = optionsFacultatives[Math.floor(Math.random() * optionsFacultatives.length)];
                    }
                } else if (classe.includes('STMG') || classe.includes('STI2D') || classe.includes('ST2S') || classe.includes('STL')) {
                    // Lycée technologique
                    grp = groupesTechno[Math.floor(Math.random() * groupesTechno.length)];
                    if (Math.random() > 0.8) {
                        opt = optionsFacultatives[Math.floor(Math.random() * optionsFacultatives.length)];
                    }
                } else if (classe.startsWith('BTS')) {
                    // BTS : pas de spécialités mais des matières professionnelles
                    grp = 'Matières professionnelles';
                    opt = '';
                }
                
                const proj = Math.random() > 0.92 ? projets[Math.floor(Math.random() * projets.length)] : '';
                const allerg = Math.random() > 0.96 ? allergies[Math.floor(Math.random() * allergies.length)] : '';
                const engage = Math.random() > 0.85 ? engagements[Math.floor(Math.random() * engagements.length)] : '';
                const redoub = Math.random() > 0.96 ? 'Oui' : 'Non';
                const maj = year <= 2008 || classe.startsWith('BTS') ? 'Oui' : 'Non';
                
                sampleData.push({
                    nom: nom,
                    prenom: prenom,
                    dob: dob,
                    sexe: sexe,
                    classe: classe,
                    groupes: grp,
                    options: opt,
                    projetAccompagnement: proj,
                    allergiePAI: allerg,
                    engagement: engage,
                    redoublant: redoub,
                    majeur: maj
                });
            }
            
            importStudents = sampleData;
            importSaveData();
            importRenderTable();
            alert('✅ 1500 profils d\'exemple générés avec succès !\n\n50 classes • Tous niveaux (2nde → BTS2) • Toutes spécialités');
        }

        function importClearAllData() {
            if (confirm('⚠️ ATTENTION ⚠️\n\nCette action va supprimer TOUTES les données.\nÊtes-vous sûr ?')) {
                importStudents = [];
                importSaveData();
                importRenderTable();
                alert('Toutes les données ont été effacées');
            }
        }

        function importFilterStudents() {
            const search = document.getElementById('import-search-input').value.toLowerCase();
            const rows = document.querySelectorAll('#import-students-table tr');
            
            rows.forEach(row => {
                if (row.querySelector('h3')) return; // Skip empty state row
                
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // ==========================================
        // FIN MODULE IMPORT INTÉGRÉ
        // ==========================================

        // Synchroniser les données Berlioz vers appData
        function syncBerliozToAppData(newStudents) {
            if (!newStudents) return;

            newStudents.forEach(student => {
                const key = `${student.classe}_${student.nom}_${student.prenom}`;

                // Ajouter l'élève à appData
                if (!appData.students[student.classe]) {
                    appData.students[student.classe] = {};
                }
                // Merge with existing data if present (preserve notes/color)
                const existing = appData.students[student.classe][key] || {};

                appData.students[student.classe][key] = {
                    ...existing,
                    ...student,
                    // Ensure defaults if new
                    color: existing.color || 'color-1',
                    rubriques: existing.rubriques || []
                };

                // Initialiser classe dans appData
                if (!appData.classes[student.classe]) {
                    appData.classes[student.classe] = {
                        students: [],
                        data: {}
                    };
                }

                if (!appData.classes[student.classe].students.includes(key)) {
                    appData.classes[student.classe].students.push(key);
                }
            });

            // Sauvegarder
            saveAppData();
            console.log("✓ Données Berlioz synchronisées");
            // Remove duplicate students that might have been introduced by multiple imports
            removeDuplicateStudents();
        }

        // Remove duplicate students across appData.students per class
        function removeDuplicateStudents() {
            if (!appData.students) return;
            const seen = {};
            Object.keys(appData.students).forEach(className => {
                const classObj = appData.students[className] || {};
                Object.keys(classObj).forEach(key => {
                    const s = classObj[key];
                    const nom = (s.nom || '').trim().toLowerCase();
                    const prenom = (s.prenom || '').trim().toLowerCase();
                    const dob = (s.dob || '').trim();
                    const norm = `${nom}|${prenom}|${dob}`;
                    if (!seen[className]) seen[className] = {};
                    if (seen[className][norm]) {
                        // Duplicate detected: remove this entry
                        delete appData.students[className][key];
                        // Remove from appData.classes list if present
                        if (appData.classes && appData.classes[className] && Array.isArray(appData.classes[className].students)) {
                            const idx = appData.classes[className].students.indexOf(key);
                            if (idx !== -1) appData.classes[className].students.splice(idx, 1);
                        }
                        // Remove any per-student colors
                        if (appData.studentColors && appData.studentColors[key]) delete appData.studentColors[key];
                        // Remove weekly fiche entries referring to this key
                        Object.keys(studentWeeklyData || {}).forEach(k => {
                            if (k.indexOf(key + '_w') === 0) delete studentWeeklyData[k];
                        });
                        // Also remove from weeklyPlans (search keys)
                        Object.keys(weeklyPlans || {}).forEach(cls => {
                            const weeks = weeklyPlans[cls] || {};
                            Object.keys(weeks).forEach(wk => {
                                const snap = weeks[wk];
                                if (!snap) return;
                                // Remove from pool
                                if (snap.pool) snap.pool = snap.pool.filter(p => p.key !== key);
                                // Remove from slots
                                if (snap.slots) {
                                    Object.keys(snap.slots).forEach(slotId => {
                                        if (snap.slots[slotId] && snap.slots[slotId].key === key) delete snap.slots[slotId];
                                    });
                                }
                            });
                        });
                    } else {
                        seen[className][norm] = key;
                    }
                });
            });
            // Rebuild berliozData from cleaned appData.students
            berliozData.students = [];
            berliozData.studentsByClass = {};
            berliozData.classes = {};
            Object.keys(appData.students || {}).forEach(cls => {
                const classObj = appData.students[cls] || {};
                Object.keys(classObj).forEach(k => {
                    const s = classObj[k];
                    berliozData.students.push(s);
                    if (!berliozData.studentsByClass[s.classe]) berliozData.studentsByClass[s.classe] = [];
                    berliozData.studentsByClass[s.classe].push(s);
                    berliozData.classes[s.classe] = true;
                });
            });

            // Persist after cleanup
            saveAppData();
            console.log('✓ Duplicates removed');
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                const nextCh = line[i + 1];

                if (ch === '"') {
                    if (inQuotes && nextCh === '"') {
                        // Guillemet échappé ""
                        current += '"';
                        i++;
                    } else {
                        // Début ou fin de zone entre guillemets
                        inQuotes = !inQuotes;
                    }
                } else if (ch === ',' && !inQuotes) {
                    // Séparateur de champs (uniquement hors guillemets)
                    result.push(current.trim());
                    current = '';
                } else {
                    // Caractère normal
                    current += ch;
                }
            }
            // Ajouter le dernier champ
            result.push(current.trim());
            
            return result;
        }

        function extractClassName(classStr) {
            // Format Berlioz : 6E4, 5E2, 4E3, 3E5 (pas de "EME")
            // Extraire uniquement la classe : 6E4, 5E2, 4E3, 3E5, 3E1, etc.
            if (!classStr) return 'INCONNU';

            // Nettoyer et normaliser la chaîne
            let cleaned = classStr.trim();
            
            // Détecter et corriger la notation scientifique Excel (ex: "3,00E+01" → "3E1")
            // Formats possibles: "3,00E+01", "3.00E+01", "3E+01", "3E+1"
            const scientificMatch = cleaned.match(/^(\d)[.,]?\d*E\+?0?(\d)$/i);
            if (scientificMatch) {
                // Reconvertir en format classe normal (ex: 3E1, 4E2, etc.)
                return scientificMatch[1] + 'E' + scientificMatch[2];
            }

            // Format Berlioz direct : 6E4, 5E4, 4E3, 3E5, etc.
            const match = cleaned.match(/^([3-6]E\d+)/);
            if (match) return match[1];

            // Fallback pour ancien format
            const match2 = cleaned.match(/(\d+)\s*(?:EME|ème)/i);
            if (match2) return match2[1] + 'EME';

            // Dernier recours
            return cleaned || 'INCONNU';
        }

        function generateClassesList() {
            const classNames = Object.keys(berliozData.classes).sort();
            const datalist = document.getElementById('knownClasses');
            datalist.innerHTML = classNames.map(c => `<option value="${c}">`).join('');
            updateClassesPanel();
        }

        function updateClassesPanel() {
            const sidebar = document.querySelector('.student-pool');
            let tabsDiv = sidebar.querySelector('.sidebar-tabs');

            // 1. Bouton Classes (S'assurer qu'il existe et a l'événement)
            let classesBtn = document.getElementById('btn-tab-classes');
            if (!classesBtn) {
                classesBtn = document.createElement('button');
                classesBtn.id = 'btn-tab-classes';
                classesBtn.className = 'tab-btn';
                classesBtn.textContent = 'Classes';
                tabsDiv.insertBefore(classesBtn, tabsDiv.lastChild);
            }
            // IMPORTANT: Toujours attacher l'événement click
            classesBtn.onclick = () => switchSidebarTab('classes');

            // 2. Conteneur Tab Classes
            let classesDiv = document.getElementById('tab-classes');
            if (!classesDiv) {
                classesDiv = document.createElement('div');
                classesDiv.id = 'tab-classes';
                classesDiv.className = 'tab-content';
                classesDiv.style.cssText = 'display:none; flex-direction:column; height:100%;';

                const studentTabs = document.getElementById('tab-students');
                studentTabs.parentNode.insertBefore(classesDiv, studentTabs.nextSibling);
            }

            classesDiv.innerHTML = '<h2 style="font-size:1rem; margin:10px 0; border-bottom:1px solid #333; padding-bottom:5px;">Classes (' + Object.keys(berliozData.classes).length + ')</h2>';

            const classList = document.createElement('div');
            classList.className = 'student-list';

            Object.keys(berliozData.classes).sort().forEach(className => {
                const div = document.createElement('div');
                div.style.cssText = 'padding:8px; background:#1a1a1a; border-radius:4px; cursor:pointer; border-left:3px solid transparent; margin-bottom:5px; display:flex; align-items:center; justify-content:space-between;';

                const infoSpan = document.createElement('span');
                infoSpan.innerHTML = `<strong>${className}</strong> <small>(${(berliozData.studentsByClass[className] || []).length} él.)</small>`;
                div.appendChild(infoSpan);

                // Delete Class Button
                const delBtn = document.createElement('div');
                delBtn.innerHTML = '&times;';
                delBtn.title = "Supprimer la classe";
                delBtn.style.cssText = "width:24px; height:24px; line-height:24px; text-align:center; color:#555; background:#2a2a2a; border-radius:4px; font-weight:bold; font-size:18px; display:none;";

                delBtn.onmouseover = () => { delBtn.style.background = '#d32f2f'; delBtn.style.color = 'white'; };
                delBtn.onmouseout = () => { delBtn.style.background = '#2a2a2a'; delBtn.style.color = '#555'; };

                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteClassGlobal(className);
                };
                div.appendChild(delBtn);

                div.onmouseenter = () => delBtn.style.display = 'block';
                div.onmouseleave = () => delBtn.style.display = 'none';

                div.onclick = () => {
                    // highlight selection
                    document.querySelectorAll('#tab-classes .student-list > div').forEach(d => d.style.borderLeft = '3px solid transparent');
                    div.style.borderLeft = '3px solid ' + getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
                    showClassStudents(className);
                    // Also switch back to students tab for convenience? 
                    // Let user decide, but usually they want to see students.
                    // switchSidebarTab('students'); // Optional, but user asked for it in previous turn for search.
                };
                classList.appendChild(div);
            });

            classesDiv.appendChild(classList);
        }

        function deleteClassGlobal(className) {
            if (!confirm(`ATTENTION: Vous allez supprimer DÉFINITIVEMENT la classe "${className}".\n\nCela effacera:\n- Tous les élèves de cette classe\n- Tous les plans de classe\n- Tout l'historique et les notes\n\nÊtes-vous sûr ?`)) {
                return;
            }
            const confirm2 = prompt(`Pour confirmer, tapez "SUPPRIMER" (en majuscules) :`);
            if (confirm2 !== "SUPPRIMER") {
                alert("Suppression annulée.");
                return;
            }

            // 1. Remove from appData.students (Fiches)
            if (appData.students && appData.students[className]) {
                delete appData.students[className];
            }

            // 2. Remove from berliozData
            if (berliozData.classes[className]) delete berliozData.classes[className];
            if (berliozData.studentsByClass[className]) delete berliozData.studentsByClass[className];
            if (berliozData.students) {
                berliozData.students = berliozData.students.filter(s => s.classe !== className);
            }

            // 3. Remove from appData.classes
            if (appData.classes[className]) delete appData.classes[className];

            // 4. Remove from weeklyPlans
            if (weeklyPlans[className]) delete weeklyPlans[className];
            if (appData.plans && appData.plans[className]) delete appData.plans[className];

            // 5. Remove activeWeeksPerClass
            if (activeWeeksPerClass[className]) delete activeWeeksPerClass[className];

            // 6. Cleanup WeeklyReports & Other prefixes
            const prefix = className + '_';
            if (appData.weeklyReports) {
                Object.keys(appData.weeklyReports).forEach(k => {
                    if (k.startsWith(prefix)) delete appData.weeklyReports[k];
                });
            }
            ['studentColors', 'customRubriques'].forEach(prop => {
                if (appData[prop]) {
                    Object.keys(appData[prop]).forEach(k => {
                        if (k.startsWith(prefix)) delete appData[prop][k];
                    });
                }
            });

            saveAppData();

            // UI Update
            // If deleted class was active, switch/clear
            if (getClassName() === className) {
                const remaining = Object.keys(berliozData.classes).sort();
                if (remaining.length > 0) {
                    document.getElementById('className').value = remaining[0];
                    onClassNameChange();
                } else {
                    document.getElementById('className').value = "";
                    document.getElementById('poolList').innerHTML = "";
                    document.querySelectorAll('.student-slot').forEach(s => s.innerHTML = '');
                }
            }

            updateClassesPanel(); // refresh sidebar list
            alert(`Classe "${className}" supprimée avec succès.`);
        }

        function deleteStudentGlobal(className, nom, prenom) {
            const key = `${className}_${nom}_${prenom}`;

            // 1. Remove from berliozData (Source of truth for sidebar)
            if (berliozData.studentsByClass[className]) {
                berliozData.studentsByClass[className] = berliozData.studentsByClass[className].filter(
                    s => !(s.nom === nom && s.prenom === prenom)
                );
            }

            // 2. Remove from appData.classes (List of student keys in class)
            if (appData.classes[className] && appData.classes[className].students) {
                const studentsRef = appData.classes[className].students;
                if (Array.isArray(studentsRef)) {
                    appData.classes[className].students = studentsRef.filter(k => k !== key);
                } else if (studentsRef[key]) {
                    delete studentsRef[key];
                }
            }

            // 3. Remove "Fiche Élève" (Detailed info: PAI, options, etc) in appData.students
            if (appData.students && appData.students[className] && appData.students[className][key]) {
                delete appData.students[className][key];
            }

            // 4. Remove Weekly Reports (Notes Pédagogiques)
            if (appData.weeklyReports) {
                const prefix = key + '_';
                Object.keys(appData.weeklyReports).forEach(k => {
                    if (k.startsWith(prefix) || k === key) {
                        delete appData.weeklyReports[k];
                    }
                });
            }

            // 5. Remove Colors & Custom Rubriques
            if (appData.studentColors && appData.studentColors[key]) delete appData.studentColors[key];
            if (appData.customRubriques && appData.customRubriques[key]) delete appData.customRubriques[key];

            // 6. Remove from Saved Plans (weeklyPlans)
            if (weeklyPlans[className]) {
                Object.keys(weeklyPlans[className]).forEach(weekId => {
                    const snap = weeklyPlans[className][weekId];
                    if (snap && snap.slots) {
                        Object.keys(snap.slots).forEach(slotId => {
                            if (snap.slots[slotId] === key) {
                                delete snap.slots[slotId];
                            }
                        });
                    }
                    if (snap && snap.pool) {
                        // pool usually stores keys or objects? Check restoreSnapshot. 
                        // It seems it often recalculates pool from missing students.
                        // But if explicitly stored:
                        const idx = snap.pool.indexOf(key);
                        if (idx > -1) snap.pool.splice(idx, 1);
                    }
                });
                // Sync back
                appData.plans = weeklyPlans;
            }

            saveAppData();
            // Update UI
            renderStudentPool(className); // Uses the new render function

            // Remove card from current view if present
            const existingCard = document.getElementById(key);
            if (existingCard) {
                existingCard.remove();
            }

            // Also remove from any slots in CURRENT DOM
            const slots = document.querySelectorAll('.student-slot');
            slots.forEach(slot => {
                const card = slot.querySelector('.student-card');
                if (card && card.dataset.studentKey === key) {
                    card.remove();
                }
            });

            // Also remove from berliozData.students flat list if it exists
            if (berliozData.students) {
                berliozData.students = berliozData.students.filter(s => !(s.classe === className && s.nom === nom && s.prenom === prenom));
            }
        }

        function renderStudentPool(className) {
            const poolList = document.getElementById('poolList');
            if (!poolList) return;

            poolList.innerHTML = '';
            
            // Ne rien afficher si aucune classe n'est sélectionnée
            if (!className || className.trim() === '') {
                return;
            }

            if (berliozData.studentsByClass[className]) {
                console.log(`✓ Affichage de ${berliozData.studentsByClass[className].length} élèves`);
                berliozData.studentsByClass[className].forEach(student => {
                    const div = createStudentCard(student);
                    // set id and hooks
                    div.ondblclick = (e) => {
                        console.log('Double-click detected on student:', student);
                        e.stopPropagation();
                        openStudentSheet(student, div.id);
                    };
                    div.ondragstart = drag;
                    div.dataset.student = JSON.stringify(student);
                    // ensure dataset key for color
                    const key = `${student.classe}_${student.nom}_${student.prenom}`;
                    div.dataset.studentKey = key;
                    // Apply color if present (visual only in sheet)
                    if (appData.studentColors && appData.studentColors[key]) {
                        // keep cards neutral; color shown on fiche only
                    }

                    // DELETE BTN
                    const delBtn = document.createElement('div');
                    delBtn.innerHTML = '&times;';
                    delBtn.title = "Supprimer l'élève";
                    delBtn.style.cssText = "position:absolute; top:-8px; right:-8px; width:20px; height:20px; background:red; color:white; border-radius:50%; text-align:center; line-height:20px; font-weight:bold; cursor:pointer; font-size:16px; display:none; z-index:100; box-shadow:0 0 5px rgba(0,0,0,0.5);";

                    div.onmouseenter = () => { if (div.parentElement && div.parentElement.id === 'poolList') delBtn.style.display = 'block'; };
                    div.onmouseleave = () => { delBtn.style.display = 'none'; };

                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`Supprimer définitivement ${student.nom} ${student.prenom} ?`)) {
                            deleteStudentGlobal(student.classe, student.nom, student.prenom);
                        }
                    };
                    div.appendChild(delBtn);

                    poolList.appendChild(div);
                });
            }
            updateCount();
        }

        function refreshAndShowStudentsTab() {
            const className = document.getElementById('className').value;
            if (className && berliozData.studentsByClass[className]) {
                renderStudentPool(className);
            }
            switchSidebarTab('students');
        }

        function showClassStudents(className) {
            // Ne rien afficher si aucune classe n'est sélectionnée
            if (!className || className.trim() === '') {
                const poolList = document.getElementById('poolList');
                if (poolList) poolList.innerHTML = '';
                return;
            }
            
            // Force "Placer Élèves" mode by default
            if (typeof toggleEditMode === 'function') {
                toggleEditMode(false);
            }

            console.log(`📋 showClassStudents appelé pour: "${className}"`);
            console.log("berliozData.studentsByClass:", berliozData.studentsByClass);
            console.log(`Élèves pour ${className}:`, berliozData.studentsByClass[className]);

            document.getElementById('className').value = className;
            
            // Update RDV display immediately when class is selected
            if (typeof updateClassRDVDisplay === 'function') {
                setTimeout(updateClassRDVDisplay, 100);
            }

            // Restore class room and subject
            const classSettings = (appData.classes && appData.classes[className]) ? appData.classes[className] : {};
            document.getElementById('roomName').value = classSettings.room || '';
            document.getElementById('subjectName').value = classSettings.subject || '';

            renderStudentPool(className);

            switchSidebarTab('students');

            try {
                // ... layout code ...
                console.log('weeklyPlans:', weeklyPlans);
                const classPlans = weeklyPlans[className] || {};
                console.log(`classPlans for ${className}:`, Object.keys(classPlans));
                if (currentWeekId && classPlans[currentWeekId]) {
                    console.log(`✓ Restoring snapshot for week ${currentWeekId}`);
                    restoreSnapshot(classPlans[currentWeekId]);
                } else {
                    console.log(`⚠ No data for week ${currentWeekId}, clearing slots`);
                    // Clear slots if no data for this week
                    document.querySelectorAll('.student-slot').forEach(slot => slot.innerHTML = '');
                }

                // Ensure we are in "Placer Élèves" mode after loading
                if (typeof toggleEditMode === 'function') {
                    toggleEditMode(false);
                }

            } catch (e) { console.warn('Erreur chargement répartition classe:', e); }
        }

        // Couleurs disponibles (5 couleurs) - code demandé: rouge, orange, jaune, vert, vert foncé
        const STUDENT_COLORS = ['color-red', 'color-orange', 'color-yellow', 'color-green', 'color-green-dark'];
        const COLOR_CODES = {
            'color-red': '#D32F2F',
            'color-orange': '#FF9800',
            'color-yellow': '#FFD54F',
            'color-green': '#66BB6A',
            'color-green-dark': '#1A7A1A'
        };

        // Change color from the student sheet (single control there). key = classe_nom_prenom
        function changeStudentColorSheet(key) {
            const colors = STUDENT_COLORS;
            const currentColor = appData.studentColors[key] || colors[0];
            const currentIndex = colors.indexOf(currentColor);
            const nextColor = colors[(currentIndex + 1) % colors.length];
            appData.studentColors[key] = nextColor;
            saveAppData();

            // Update visible color button if in modal
            const btn = document.getElementById('sheet-color-btn');
            if (btn) {
                btn.style.background = COLOR_CODES[nextColor] || '#666';
                btn.dataset.color = nextColor;
            }

            // Note: cards on tables/pool are neutral (white). Color persists in appData and is shown in the sheet.
        }

        function showClassesTab() {
            switchSidebarTab('classes');
            if (document.getElementById('btn-tab-classes')) {
                document.getElementById('btn-tab-classes').click();
            }
        }





        // ===== GESTION FICHES ÉLÈVES PAR SEMAINE =====
        // studentWeeklyData est déclaré globalement en haut du fichier


        function insertFrequentWord(text) {
            if (!text) return;
            const textarea = document.getElementById('sheet-week-notes');
            if (!textarea) return;

            // Vérifier si c'est un contenteditable ou textarea
            if (textarea.isContentEditable) {
                // Pour contenteditable
                textarea.focus();
                const selection = window.getSelection();
                let range;
                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                } else {
                    range = document.createRange();
                    range.selectNodeContents(textarea);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                range.deleteContents();
                const textNode = document.createTextNode(' ' + text);
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                range.setEndAfter(textNode);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                // Pour textarea classique
                if (textarea.value && !textarea.value.endsWith(' ') && !textarea.value.endsWith('\n')) {
                    textarea.value += ' ';
                }
                textarea.value += text;
            }

            // Trigger input event for auto-save logic
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            textarea.focus();
        }

        // Permet d'insérer un mot fréquent dans une textarea de rubrique personnalisée
        function insertFrequentWordRubric(text, textareaId) {
            if (!text) return;
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            
            // Vérifier si c'est un contenteditable ou textarea
            if (textarea.isContentEditable) {
                // Pour contenteditable
                textarea.focus();
                const selection = window.getSelection();
                let range;
                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                } else {
                    range = document.createRange();
                    range.selectNodeContents(textarea);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                range.deleteContents();
                const textNode = document.createTextNode(' ' + text);
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                range.setEndAfter(textNode);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                // Pour textarea classique
                if (textarea.value && !textarea.value.endsWith(' ') && !textarea.value.endsWith('\n')) {
                    textarea.value += ' ';
                }
                textarea.value += text;
            }
            
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            textarea.focus();
        }

        // Fonctions de formatage de texte
        function applyTextFormat(elementId, formatType) {
            const element = document.getElementById(elementId);
            if (!element) return;

            element.focus();
            const selection = window.getSelection();
            
            if (!selection.toString()) {
                alert('Veuillez d\'abord sélectionner du texte à formater.');
                return;
            }

            let command = '';
            switch(formatType) {
                case 'bold':
                    command = 'bold';
                    break;
                case 'italic':
                    command = 'italic';
                    break;
                case 'underline':
                    command = 'underline';
                    break;
                case 'highlight':
                    // Pour le surlignage avec sortie automatique (supporte multiligne)
                    const sel = window.getSelection();
                    const range = sel.getRangeAt(0);
                    const selectedContent = range.extractContents();
                    
                    // Créer un span avec fond rouge
                    const highlightSpan = document.createElement('span');
                    highlightSpan.style.backgroundColor = '#FF0000';
                    highlightSpan.style.color = '#fff';
                    highlightSpan.style.padding = '2px 4px';
                    highlightSpan.style.borderRadius = '2px';
                    highlightSpan.appendChild(selectedContent);
                    
                    // Insérer le span surligné
                    range.insertNode(highlightSpan);
                    
                    // Créer un espace après pour sortir du format
                    const spaceNode = document.createTextNode('\u00A0'); // Non-breaking space
                    range.setStartAfter(highlightSpan);
                    range.insertNode(spaceNode);
                    
                    // Positionner le curseur après l'espace
                    range.setStartAfter(spaceNode);
                    range.setEndAfter(spaceNode);
                    sel.removeAllRanges();
                    sel.addRange(range);
                    
                    element.dispatchEvent(new Event('input', { bubbles: true }));
                    return;
                default:
                    return;
            }

            document.execCommand(command, false, null);
            element.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function changeFontSize(elementId, size) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.style.fontSize = size;
        }

        function toggleFormatOptions(formatBarId) {
            const formatBar = document.getElementById(formatBarId);
            if (!formatBar) return;
            if (formatBar.style.display === 'none' || formatBar.style.display === '') {
                formatBar.style.display = 'flex';
            } else {
                formatBar.style.display = 'none';
            }
        }

        // Fonctions helper pour gérer textarea et contenteditable
        function getElementValue(element) {
            if (!element) return '';
            if (element.isContentEditable) {
                return element.innerHTML;
            }
            return element.value || '';
        }

        function setElementValue(element, value) {
            if (!element) return;
            if (element.isContentEditable) {
                element.innerHTML = value;
            } else {
                element.value = value;
            }
        }

        function createStudentSheetModal() {
            const modal = document.createElement('div');
            modal.id = 'studentSheetModal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000; display:flex; z-index:31000; padding:0;';

            modal.innerHTML = `
                <div style="position:relative; width:100vw; height:100vh; overflow-y:auto; background:#1a1a1a; border-radius:0; padding:0; display:flex; flex-direction:column; border:none;">
                    
                    <!-- En-tête : NOM PRÉNOM grand format (sombre, lisible) -->
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 25px; background:#222; color:#fff; border-bottom:1px solid #444;">
                        <div>
                            <h1 id="sheet-header-name" draggable="true" ondragstart="handleStudentNameDragStart(event)" onclick="copyStudentNameToClipboard()" title="Cliquez pour copier" style="margin:0; font-size:2.4rem; font-weight:800; color:#fff; cursor:copy;">
                                <span id="sheet-display-nom">NOM</span> <span id="sheet-display-prenom">PRÉNOM</span>
                            </h1>
                            <p style="margin:6px 0 0 0; font-size:0.95rem; color:#bbb; font-weight:600;">Fiche Élève</p>
                        </div>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <!-- CLOCK WIDGET -->
                            <div style="text-align:right; margin-right:15px; border-right:1px solid #444; padding-right:15px;">
                                <div class="sheetClockDisplay" style="font-family:'Segoe UI', monospace; font-size:1.4rem; font-weight:bold; color:var(--primary-color); text-shadow:0 0 5px rgba(0,242,255,0.5);">00:00:00</div>
                                <div class="sheetDateDisplay" style="font-family:'Segoe UI', sans-serif; font-size:0.85rem; color:#aaa;">01/01/2024</div>
                            </div>

                            <div style="display:flex; flex-direction:column; gap:5px;">
                                <button onclick="document.getElementById('studentSheetModal').style.display='none'; openSearchHub();" style="background:#2196F3; color:white; border:none; border-radius:6px; padding:8px 15px; font-weight:bold; cursor:pointer; font-size:0.9rem; display:flex; align-items:center; gap:5px; width:100%; justify-content:center;">🔍 Recherche</button>
                                <button onclick="printStudentAnnualSummaryFromSheet()" style="background:#0D47A1; color:white; border:none; border-radius:6px; padding:6px 10px; font-weight:bold; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; gap:5px; width:100%; justify-content:center;">📄 Synthèse Annuelle</button>
                            </div>
                            <button id="sheet-color-btn" onclick="(function(){ const s=JSON.parse(document.getElementById('sheet-student-json').value||'{}'); if(s && s.classe) changeStudentColorSheet(s.classe + '_' + s.nom + '_' + s.prenom); })()" title="Couleur élève" style="width:34px; height:34px; border-radius:6px; border:1px solid #333; background:#1A7A1A; cursor:pointer;"></button>
                            <button onclick="document.getElementById('studentSheetModal').style.display='none'" style="background:none; border:none; font-size:1.6rem; cursor:pointer; color:#fff; font-weight:700; line-height:1;">×</button>
                        </div>
                    </div>
                    
                    <!-- Contenu principal -->
                    <div style="padding:25px; overflow-y:auto; flex:1; background:#1a1a1a;">
                        <input type="hidden" id="sheet-element-id">
                        <input type="hidden" id="sheet-student-json">
                        <input type="hidden" id="sheet-current-week" value="1">
                        <input type="hidden" id="sheet-current-day-index" value="">
                        
                        <!-- Section 1 : Infos de base (toujours visibles) -->
                        <div class="sheet-section sheet-section-base" style="background:#222; padding:20px; border-radius:4px; border-left:5px solid var(--primary-color); margin-bottom:25px;">
                            <h3 style="margin-top:0; color:var(--primary-color); font-size:1.3rem; border-bottom:2px solid var(--primary-color); padding-bottom:10px;">📋 Informations de Base (Permanentes)</h3>
                            
                            <div style="overflow-x:auto; overflow-y:visible;">
                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr 80px; gap:15px; margin-bottom:15px; min-width:800px;">
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">NOM</label>
                                    <input type="text" id="sheet-nom" spellcheck="true" lang="fr" autocorrect="on" style="width:100%; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff; font-weight:bold; font-size:1rem;">
                                </div>
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">PRÉNOM</label>
                                    <input type="text" id="sheet-prenom" spellcheck="true" lang="fr" autocorrect="on" style="width:100%; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff; font-size:1rem;">
                                </div>
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">NÉ(E) LE</label>
                                    <input type="text" id="sheet-dob" style="width:100%; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff;">
                                </div>
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">SEXE</label>
                                    <select id="sheet-sexe" style="width:100%; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff;">
                                        <option value="">-</option>
                                        <option value="M">M</option>
                                        <option value="F">F</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">CLASSE DE RATTACHEMENT</label>
                                    <input type="text" id="sheet-classe" style="width:100%; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff; font-weight:bold; font-size:1.05rem;">
                                </div>
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">GROUPES</label>
                                    <textarea id="sheet-groupes" spellcheck="true" lang="fr" autocorrect="on" style="width:100%; height:60px; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff; resize:vertical; font-size:0.9rem;"></textarea>
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">🏆 OPTIONS</label>
                                    <textarea id="sheet-options" spellcheck="true" lang="fr" autocorrect="on" style="width:100%; height:70px; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff; resize:vertical; font-size:0.9rem;"></textarea>
                                </div>
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">📌 PROJET D'ACCOMPAGNEMENT</label>
                                    <textarea id="sheet-projet" spellcheck="true" lang="fr" autocorrect="on" style="width:100%; height:70px; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff; resize:vertical; font-size:0.9rem;"></textarea>
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
                                <div>
                                    <label style="color:#FF6B00; font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">⚠️ ALLERGIES / PAI</label>
                                    <textarea id="sheet-allergies" spellcheck="true" lang="fr" autocorrect="on" style="width:100%; height:60px; padding:10px; background:#222; border:1px solid #444; border-radius:4px; color:#fff; font-weight:bold; resize:vertical; font-size:0.9rem;"></textarea>
                                </div>
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">🤝 ENGAGEMENT</label>
                                    <textarea id="sheet-engagement" spellcheck="true" lang="fr" autocorrect="on" style="width:100%; height:70px; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff; resize:vertical; font-size:0.9rem;"></textarea>
                                </div>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">🔄 REDOUBLANT</label>
                                    <input type="text" id="sheet-redoublant" style="width:100%; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff;">
                                </div>
                                <div>
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">🎓 MAJEUR</label>
                                    <input type="text" id="sheet-majeur" style="width:100%; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff;">
                                </div>
                            </div>
                            </div>
                            
                            <!-- Container pour les nouvelles rubriques dynamiques -->
                            <div id="sheet-custom-rubriques-container">
                                <!-- Les rubriques seront injectées ici par JS -->
                            </div>
                            <datalist id="rubricList"></datalist>
                        </div>

                        <!-- Section 1.5 : Liste des Rendez-Vous -->
                        <div class="sheet-section sheet-section-rdv" style="background:#222; padding:20px; border-radius:4px; border-left:5px solid #2196F3; margin-bottom:25px;">
                            <h3 style="margin-top:0; color:#2196F3; font-size:1.3rem; border-bottom:2px solid #2196F3; padding-bottom:10px;">📅 Rendez-Vous & Convocations</h3>
                            <div id="sheet-rdv-list" style="max-height:150px; overflow-y:auto; background:#333; padding:10px; border-radius:4px;">
                                <div style="color:#888; text-align:center;">Aucun rendez-vous.</div>
                            </div>
                        </div>
                        
                        <!-- Section 2 : Calendrier des semaines & Données semaine -->
                        <div class="sheet-section sheet-section-weeks" style="background:#222; padding:20px; border-radius:4px; border-left:5px solid #FFA500; margin-bottom:25px;">
                            <h3 style="margin-top:0; color:#FFA500; font-size:1.3rem; border-bottom:2px solid #FFA500; padding-bottom:10px;">📅 SEMAINES & SUIVI PÉDAGOGIQUE</h3>
                            
                            <div style="margin-bottom:20px;">
                                <label style="color:#FFA500; font-weight:bold; display:block; margin-bottom:10px; font-size:0.95rem;">Choisir une semaine :</label>
                                <div id="sheet-weeks-calendar" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(70px, 1fr)); gap:8px;">
                                    <!-- Semaines générées par JS -->
                                </div>
                            </div>
                            
                            <!-- Données de la semaine sélectionnée -->
                            <div id="sheet-week-data" style="display:none; background:#333; padding:15px; border-radius:4px; border-left:3px solid #FFA500;">
                                <h4 style="margin-top:0; margin-bottom:15px; color:#FFA500; font-size:1.1rem;">Semaine <span id="sheet-selected-week">--</span> <span id="sheet-week-dates" style="font-size:0.9rem; color:#aaa; margin-left:10px;"></span></h4>
                                <div id="sheet-days-selector" style="display:flex; gap:5px; margin-bottom:15px; flex-wrap:wrap;"></div>
                                
                                <div style="margin-bottom:15px;">
                                    <label style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:8px; font-size:0.95rem;">👤 STATUT DE LA SEMAINE</label>
                                    <select id="sheet-week-status" style="width:100%; padding:10px; background:#444; border:2px solid #555; border-radius:4px; color:#ddd; font-size:1rem; font-weight:bold;">
                                        <option value="">-- Choisir un statut --</option>
                                        <option value="status-darkgreen">✓ Présent</option>
                                        <option value="status-yellow">⚠ Absent prévu</option>
                                        <option value="status-red">✗ Absent</option>
                                        <option value="status-blue">? Autre</option>
                                    </select>
                                </div>
                                
                                <div style="margin-top:15px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                        <label style="color:var(--primary-color); font-weight:bold; font-size:0.95rem;">📝 INFORMATION HEBDOMADAIRE / COMPORTEMENT (Semaine)</label>
                                        <div style="display:flex; align-items:center; gap:10px;">
                                            <div style="display:flex; flex-direction:column; align-items:flex-start;">
                                                <span id="sheet-week-timestamp-display" style="color:#aaa; font-size:0.8rem; font-style:italic;"></span>
                                                <span id="sheet-week-effect-date-display" style="color:#ff7777; font-size:0.8rem; font-weight:bold;"></span>
                                            </div>
                                            <div style="display:flex; gap:8px; background:#222; padding:5px 10px; border-radius:4px; flex-wrap:wrap; align-items:center;">
                                                <label style="cursor:pointer; color:#ff4444; font-weight:bold; font-size:1rem; display:flex; align-items:center;"><input type="radio" name="weekColor" value="red" class="sheet-week-color" style="transform:scale(1); margin-right:5px;" onmousedown="this.dataset.wasChecked = this.checked" onclick="if(this.dataset.wasChecked === 'true'){this.checked=false;}"> 🔴 Rouge</label>
                                                <label style="cursor:pointer; color:#ffbb33; font-weight:bold; font-size:1rem; display:flex; align-items:center;"><input type="radio" name="weekColor" value="orange" class="sheet-week-color" style="transform:scale(1); margin-right:5px;" onmousedown="this.dataset.wasChecked = this.checked" onclick="if(this.dataset.wasChecked === 'true'){this.checked=false;}"> 🟠 Orange</label>
                                                <label style="cursor:pointer; color:#ffeb3b; font-weight:bold; font-size:1rem; display:flex; align-items:center;"><input type="radio" name="weekColor" value="yellow" class="sheet-week-color" style="transform:scale(1); margin-right:5px;" onmousedown="this.dataset.wasChecked = this.checked" onclick="if(this.dataset.wasChecked === 'true'){this.checked=false;}"> 🟡 Jaune</label>
                                                <label style="cursor:pointer; color:#00C851; font-weight:bold; font-size:1rem; display:flex; align-items:center;"><input type="radio" name="weekColor" value="green" class="sheet-week-color" style="transform:scale(1); margin-right:5px;" onmousedown="this.dataset.wasChecked = this.checked" onclick="if(this.dataset.wasChecked === 'true'){this.checked=false;}"> 🟢 Vert</label>
                                                <button type="button" onclick="if(typeof synchronizeAllData === 'function') { synchronizeAllData(); showToast('Synchronisation Stats effectuée'); } else { alert('Fonction de synchro introuvable'); }" style="margin-left:auto; padding:5px 12px; background:#757575; color:white; border:1px solid #555; border-radius:3px; cursor:pointer; font-size:1rem; font-weight:bold; display:flex; align-items:center; gap:5px;" title="Synchroniser tout ce qui a été fait avec le Tableau de Bord Statistiques">🔄 Synchro</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-bottom:5px; display:flex; align-items:center; gap:18px; flex-wrap:wrap;">
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <label style="color:#aaa; font-size:0.85rem; margin-right:4px;">Mots fréquents :</label>
                                            <select onchange="insertFrequentWord(this.value); this.value='';" style="background:#333; color:#eee; border:1px solid #555; border-radius:4px; padding:2px 5px; font-size:0.85rem;">
                                                <option value="">-- Ajouter --</option>
                                                <option value="Bavardages">Bavardages</option>
                                                <option value="Agitation">Agitation</option>
                                                <option value="Travail non fait">Travail non fait</option>
                                                <option value="Matériel oublié">Matériel oublié</option>
                                                <option value="Retard">Retard</option>
                                                <option value="Usage téléphone">Usage téléphone</option>
                                                <option value="Refus de travail">Refus de travail</option>
                                                <option value="Insolence">Insolence</option>
                                                <option value="Dort">Dort en classe</option>
                                                <option value="Participation">Participation active</option>
                                                <option value="Progrès">Progrès</option>
                                            </select>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <label for="sheet-week-font" style="color:#aaa; font-size:0.85rem;">Style de caractère :</label>
                                            <select id="sheet-week-font" onchange="document.getElementById('sheet-week-notes').style.fontFamily=this.value;" style="background:#333; color:#eee; border:1px solid #555; border-radius:4px; padding:2px 5px; font-size:0.85rem;">
                                                <option value="monospace">Monospace</option>
                                                <option value="Arial, Helvetica, sans-serif">Arial</option>
                                                <option value="Times New Roman, Times, serif">Times New Roman</option>
                                                <option value="Comic Sans MS, Comic Sans, cursive">Comic Sans</option>
                                                <option value="Courier New, Courier, monospace">Courier New</option>
                                                <option value="Georgia, serif">Georgia</option>
                                                <option value="Verdana, Geneva, sans-serif">Verdana</option>
                                            </select>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <button onclick="toggleFormatOptions('week-format-bar')" style="padding:3px 8px; background:#555; color:#fff; border:1px solid #666; border-radius:4px; cursor:pointer; font-size:0.75rem;">⚙️ Format</button>
                                        </div>
                                    </div>
                                    <div id="week-format-bar" style="display:none; margin-bottom:8px; margin-top:5px; align-items:center; gap:4px; flex-wrap:wrap;">
                                        <button onclick="applyTextFormat('sheet-week-notes', 'bold')" title="Gras (sélectionnez du texte d'abord)" style="padding:2px 5px; background:#555; color:#fff; border:1px solid #666; border-radius:3px; cursor:pointer; font-weight:bold; font-size:0.7rem;">𝐁</button>
                                        <button onclick="applyTextFormat('sheet-week-notes', 'italic')" title="Italique (sélectionnez du texte d'abord)" style="padding:2px 5px; background:#555; color:#fff; border:1px solid #666; border-radius:3px; cursor:pointer; font-style:italic; font-size:0.7rem;">𝐼</button>
                                        <button onclick="applyTextFormat('sheet-week-notes', 'underline')" title="Souligné (sélectionnez du texte d'abord)" style="padding:2px 5px; background:#555; color:#fff; border:1px solid #666; border-radius:3px; cursor:pointer; text-decoration:underline; font-size:0.7rem;">U̲</button>
                                        <button onclick="applyTextFormat('sheet-week-notes', 'highlight')" title="Surligner (sélectionnez du texte d'abord)" style="padding:2px 5px; background:#FFD700; color:#000; border:1px solid #666; border-radius:3px; cursor:pointer; font-weight:bold; font-size:0.7rem;">🖍</button>
                                        <span style="color:#555; margin:0 2px;">|</span>
                                        <label style="color:#aaa; font-size:0.7rem;">Taille:</label>
                                        <select onchange="changeFontSize('sheet-week-notes', this.value)" style="background:#333; color:#eee; border:1px solid #555; border-radius:3px; padding:1px 3px; font-size:0.7rem;">
                                            <option value="0.85rem">Petit</option>
                                            <option value="0.95rem" selected>Normal</option>
                                            <option value="1.1rem">Grand</option>
                                            <option value="1.3rem">Très grand</option>
                                        </select>
                                    </div>
                                    <div id="sheet-week-notes" contenteditable="true" spellcheck="true" lang="fr" style="width:100%; min-height:40px; max-height:400px; padding:10px; background:#444; border:2px solid #555; border-radius:4px; color:#ddd; font-family:monospace; font-size:0.95rem; overflow-y:auto; white-space:pre-wrap; word-wrap:break-word;" onfocus="this.style.minHeight='400px';" onblur="this.style.minHeight='40px';"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pied de page -->
                    <div style="display:flex; gap:10px; justify-content:center; align-items:center; padding:15px; background:#222; border-top:3px solid #555; border-radius:0 0 8px 8px; flex-wrap:nowrap; overflow-x:auto;">
                        <button onclick="addNewRubricToSheet()" style="padding:12px 15px; background:orange; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.9rem; white-space:nowrap;">Rubrique(s)</button>
                        <button onclick="printStudentWeekFromModal()" style="padding:12px 15px; background:#4CAF50; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.9rem; white-space:nowrap;">🖨️ Imprimer semaine</button>
                        <button onclick="printStudentReportFromModal()" style="padding:12px 15px; background:#2196F3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.9rem; white-space:nowrap;">🖨️ Imprimer récap</button>
                        <button onclick="deleteStudentFromClass()" style="padding:12px 15px; background:#D32F2F; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.9rem; white-space:nowrap;">🗑️ SUPPRIMER</button>
                        <button onclick="openRdvForStudent()" style="padding:12px 15px; background:#2196F3; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.9rem; white-space:nowrap;">📅 CRÉER RDV</button>
                        <button onclick="readAllStudentInfo()" style="padding:12px 15px; background:#673AB7; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.9rem; white-space:nowrap;">📖 TOUT LIRE</button>
                        <button onclick="closeStudentSheetModal()" style="padding:12px 15px; background:#555; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.9rem; white-space:nowrap;">FERMER</button>
                        <button onclick="saveStudentSheetAndBackup()" style="padding:12px 15px; background:var(--primary-color); color:#000; border:none; border-radius:4px; cursor:not-allowed; font-weight:bold; font-size:0.9rem; white-space:nowrap; opacity:0.5;" disabled>💾 ENREGISTRER</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // AUTO-SAVE: Ecouter les changements sur tous les inputs de la fiche
            modal.addEventListener('change', (e) => {
                if (e.target.classList.contains('sheet-week-color')) {
                    saveWeeklyData(false);
                    return;
                }
                if (e.target.id && e.target.id.startsWith('sheet-') && e.target.id !== 'sheet-student-json' && e.target.id !== 'sheet-element-id' && e.target.id !== 'sheet-current-week') {
                    if (e.target.id === 'sheet-week-status' || e.target.id === 'sheet-week-notes') {
                        saveWeeklyData(false); // Mode silencieux
                    } else {
                        saveStudentSheet(false);
                    }
                }
                if (e.target.classList.contains('rubric-name') || e.target.classList.contains('rubric-content')) {
                    saveStudentSheet(false);
                }
            });

            // AUTO-SAVE: Ecouter aussi l'événement 'input' pour les notes pédagogiques (déclenché à chaque frappe)
            modal.addEventListener('input', (e) => {
                if (e.target.id === 'sheet-week-notes' || e.target.id === 'sheet-week-status') {
                    console.log('📝 Saisie en cours dans notes pédagogiques...');
                    // Débounce pour éviter de sauvegarder à chaque lettre
                    clearTimeout(window.weeklyNotesTimeout);
                    window.weeklyNotesTimeout = setTimeout(() => {
                        console.log('💾 Auto-sauvegarde notes pédagogiques...');
                        saveWeeklyData(false);
                    }, 1000); // Sauvegarde 1 seconde après la dernière frappe
                }
            });

            return modal;
        }

        function getISOWeek(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getCurrentWeekIdFromDate() {
            const now = new Date();
            const currentWeek = getISOWeek(now);
            let simulatedWeek = 36;
            for (let i = 0; i < CALENDAR_DATA.weeks.length; i++) {
                const item = CALENDAR_DATA.weeks[i];
                if (typeof item === 'number') simulatedWeek = item;
                if (simulatedWeek === currentWeek) {
                    if (item === 'F') return 'F_' + i;
                    return String(item);
                }
                simulatedWeek++;
                if (simulatedWeek > 52) simulatedWeek = 1;
            }
            return null;
        }

        function openStudentSheet(student, elementId, forceWeekId = null) {
            const modal = document.getElementById('studentSheetModal') || createStudentSheetModal();

            // Afficher un bandeau si l'application est verrouillée
            const existingBanner = document.getElementById('sheetLockBanner');
            if (existingBanner) existingBanner.remove();
            
            if (isApplicationLocked()) {
                const lockBanner = document.createElement('div');
                lockBanner.id = 'sheetLockBanner';
                lockBanner.style.cssText = 'background:linear-gradient(135deg, #F44336, #D32F2F); color:white; padding:12px; text-align:center; font-weight:bold; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.3);';
                lockBanner.innerHTML = '🔒 MODE CONSULTATION UNIQUEMENT - Aucune modification ne sera sauvegardée';
                const modalContent = modal.querySelector('.modal-content');
                const header = modalContent.querySelector('.sheet-header');
                header.parentNode.insertBefore(lockBanner, header.nextSibling);
                
                // Désactiver tous les boutons de sauvegarde
                const saveButtons = modal.querySelectorAll('button[onclick*="save"]');
                saveButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.4';
                    btn.style.cursor = 'not-allowed';
                    btn.title = '🔒 Application verrouillée - Consultation uniquement';
                });
                
                // Mettre tous les champs en lecture seule
                const inputs = modal.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.setAttribute('readonly', 'readonly');
                    if (input.tagName === 'SELECT') {
                        input.disabled = true;
                    }
                    input.style.backgroundColor = '#1a1a1a';
                    input.style.cursor = 'not-allowed';
                });
                
                // Désactiver les contenteditable
                const editables = modal.querySelectorAll('[contenteditable="true"]');
                editables.forEach(el => {
                    el.contentEditable = 'false';
                    el.style.backgroundColor = '#1a1a1a';
                    el.style.cursor = 'not-allowed';
                });
            }

            // IMPORTANT: Clear all fields first to avoid data from previous student appearing
            document.getElementById('sheet-nom').value = '';
            document.getElementById('sheet-prenom').value = '';
            document.getElementById('sheet-dob').value = '';
            document.getElementById('sheet-sexe').value = '';
            document.getElementById('sheet-classe').value = '';
            document.getElementById('sheet-groupes').value = '';
            document.getElementById('sheet-projet').value = '';
            document.getElementById('sheet-allergies').value = '';
            document.getElementById('sheet-options').value = '';
            document.getElementById('sheet-engagement').value = '';
            document.getElementById('sheet-redoublant').value = '';
            document.getElementById('sheet-majeur').value = '';
            document.getElementById('sheet-week-status').value = '';
            setElementValue(document.getElementById('sheet-week-notes'), '');
            document.getElementById('sheet-selected-week').textContent = '--';
            document.getElementById('sheet-current-week').value = '';
            const weekDataDiv = document.getElementById('sheet-week-data');
            if (weekDataDiv) weekDataDiv.style.display = 'none';

            // Remplir le titre (NOM PRÉNOM en grand)
            document.getElementById('sheet-display-nom').textContent = student.nom.toUpperCase();
            document.getElementById('sheet-display-prenom').textContent = student.prenom.toUpperCase();

            // Remplir les infos de base
            document.getElementById('sheet-nom').value = student.nom;
            document.getElementById('sheet-prenom').value = student.prenom;
            document.getElementById('sheet-dob').value = student.dob;
            document.getElementById('sheet-sexe').value = student.sexe || '';
            document.getElementById('sheet-classe').value = student.classe;
            document.getElementById('sheet-groupes').value = student.groupes;
            document.getElementById('sheet-projet').value = student.projet;
            document.getElementById('sheet-allergies').value = student.allergies;
            document.getElementById('sheet-options').value = student.options;
            document.getElementById('sheet-engagement').value = student.engagement || '';
            document.getElementById('sheet-redoublant').value = student.redoublant || '';
            document.getElementById('sheet-majeur').value = student.majeur || '';
            document.getElementById('sheet-element-id').value = elementId;
            document.getElementById('sheet-student-json').value = JSON.stringify(student);

            // Remplir la liste des RDV
            renderStudentRdvList(student);

            // Update color button in modal to reflect saved color
            const colorBtn = document.getElementById('sheet-color-btn');
            if (colorBtn) {
                const key = `${student.classe}_${student.nom}_${student.prenom}`;
                const c = (appData.studentColors && appData.studentColors[key]) || STUDENT_COLORS[0];
                colorBtn.style.background = COLOR_CODES[c] || '#666';
                colorBtn.dataset.color = c;
                colorBtn.dataset.color = c;
            }

            // Populate rubric list
            const rubricList = document.getElementById('rubricList');
            if (rubricList) {
                rubricList.innerHTML = '';
                // Ensure global list exists - DO NOT PREFILL with defaults
                if (!appData.rubriqueList) appData.rubriqueList = [];
                appData.rubriqueList.sort().forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    rubricList.appendChild(opt);
                });
            }

            // Générer les rubriques personnalisées
            const key = `${student.classe}_${student.nom}_${student.prenom}`;
            renderCustomRubriquesForSheet(key);

            // Générer le calendrier des semaines
            generateWeeksCalendar(student);

            // Auto-select current main week if available, else first mapped week
            let startWeek = '1';
            // Check if global currentWeekId is set
            if (forceWeekId) {
                startWeek = String(forceWeekId);
            } else {
                const dateWeekId = getCurrentWeekIdFromDate();
                if (dateWeekId) {
                    startWeek = dateWeekId;
                } else if (currentWeekId && String(currentWeekId).length > 0) {
                    startWeek = String(currentWeekId);
                }
            }
            selectWeekInSheet(startWeek, student);

            // Sync ABSENCE from layout if applicable
            // If the elementId card is visually absent AND we are on the current week, force status to 'status-red' if empty
            const card = document.getElementById(elementId);
            if (card && card.classList.contains('absent')) {
                const key = `${student.classe}_${student.nom}_${student.prenom}_w${startWeek}`;
                if (!studentWeeklyData[key] || !studentWeeklyData[key].status) {
                    // Pre-fill visual status in the dropdown (will be saved on "Enregistrer Semaine")
                    document.getElementById('sheet-week-status').value = 'status-red';
                }
            }

            modal.style.display = 'flex';
        }

        function renderStudentRdvList(student) {
            const listContainer = document.getElementById('sheet-rdv-list');
            if (!listContainer) return;

            listContainer.innerHTML = '';

            if (!appData.rdv || appData.rdv.length === 0) {
                listContainer.innerHTML = '<div style="color:#888; text-align:center; padding:10px;">Aucun rendez-vous enregistré.</div>';
                return;
            }

            // Pattern: "NOM Prénom" to match inside "NOM Prénom (Classe)"
            // Using case insensitive check
            const nomPrenom = `${student.nom} ${student.prenom}`.toLowerCase();

            const studentRdvs = appData.rdv.filter(r => {
                if (!r.students || !Array.isArray(r.students)) return false;
                return r.students.some(s => s.toLowerCase().includes(nomPrenom));
            });

            if (studentRdvs.length === 0) {
                listContainer.innerHTML = '<div style="color:#888; text-align:center; padding:10px;">Aucun rendez-vous trouvé pour cet élève.</div>';
                return;
            }

            // Sort by date descending (Newest first)
            studentRdvs.sort((a, b) => {
                // Parse dates "YYYY-MM-DD"
                const da = new Date(a.date + 'T' + (a.time || '00:00'));
                const db = new Date(b.date + 'T' + (b.time || '00:00'));
                return db - da;
            });

            studentRdvs.forEach(r => {
                // Parse Date
                const d = new Date(r.date);
                const dateStr = d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
                const timeStr = r.time ? r.time : '';

                const div = document.createElement('div');
                div.style.cssText = "padding:8px 10px; border-bottom:1px solid #444; color:#ddd; font-size:0.9rem; display:flex; justify-content:space-between; align-items:center; transition:background 0.2s;";
                div.onmouseover = () => div.style.background = '#333';
                div.onmouseout = () => div.style.background = 'transparent';

                // Status Color Indicator
                let statusColor = '#FF9800'; // Pending (Orange)
                let statusTitle = 'En Attente';
                if (r.status === 'validated') { statusColor = '#4CAF50'; statusTitle = 'Validé (Présent)'; }
                else if (r.status === 'cancelled') { statusColor = '#F44336'; statusTitle = 'Annulé/Absent'; }

                // Title - Truncate if too long
                let title = r.title || 'Sans titre';
                if (title.length > 30) title = title.substring(0, 30) + '...';

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:10px; height:10px; border-radius:50%; background:${statusColor};" title="${statusTitle}"></div>
                        <span style="font-family:monospace; color:#aaa;">${dateStr}</span>
                        <strong style="color:white;">${timeStr}</strong>
                        <span>${title}</span>
                    </div>
                `;

                // View Button
                const btn = document.createElement('button');
                btn.innerHTML = '👁️';
                btn.title = "Voir / Modifier le RDV";
                btn.style.cssText = "background:none; border:none; color:#2196F3; cursor:pointer; font-size:1.1rem; padding:0 5px;";
                btn.onclick = (e) => {
                    e.stopPropagation();
                    // SAVE CONTEXT
                    lastStudentSheetData = {
                        student: student,
                        elementId: document.getElementById('sheet-element-id').value
                    };
                    document.getElementById('studentSheetModal').style.display = 'none';
                    openAddRdvModal(r.id);
                };
                div.appendChild(btn);

                listContainer.appendChild(div);
            });
        }

        function openRdvForStudent() {
            const json = document.getElementById('sheet-student-json').value;
            if (!json) return;
            const student = JSON.parse(json);

            // SAVE CONTEXT
            lastStudentSheetData = {
                student: student,
                elementId: document.getElementById('sheet-element-id').value
            };

            // Format: "NOM Prénom (Classe)" - Matches format used in searchRdvStudents
            const studentString = `${student.nom} ${student.prenom} (${student.classe})`;

            // Close sheet
            document.getElementById('studentSheetModal').style.display = 'none';

            // Open Add RDV Modal (New)
            // Use local date for default
            const now = new Date();
            const localDateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            openAddRdvModal(null, localDateStr);

            // Set Student
            currentRdvStudents = [studentString];
            renderRdvSelectedStudents();

            // Auto-fill Title (requested feature: copy-paste name to title)
            setTimeout(() => {
                const titleInput = document.getElementById('rdvTitle');
                if (titleInput) {
                    titleInput.value = `${student.nom} ${student.prenom}`;
                    titleInput.focus();
                }
            }, 50);
        }

        function copyStudentNameToClipboard() {
            const nom = document.getElementById('sheet-display-nom').textContent;
            const prenom = document.getElementById('sheet-display-prenom').textContent;
            const fullName = `${nom} ${prenom}`;

            navigator.clipboard.writeText(fullName).then(() => {
                showToast("Nom copié : " + fullName);
            }).catch(err => {
                console.error('Erreur copie presse-papier:', err);
                // Fallback for non-secure contexts if needed, but showToast helps debug
                showToast("Erreur copie (navigateur bloqué?)");
            });
        }

        function attachLinkToTextarea(targetArea) {
            const url = prompt("Entrez l'URL du lien ou du fichier (ex: https://... ou file://...) :");
            if (url && url.trim()) {
                const label = prompt("Texte du lien (facultatif) :", "Voir le document");
                const finalLabel = label || "Lien";
                // Insert HTML anchor
                const anchor = `<a href="${url}" target="_blank" style="color:var(--primary-color); text-decoration:underline;">${finalLabel}</a>`;
                targetArea.value += (targetArea.value ? '\n' : '') + anchor;
            }
        }

        function generateWeeksCalendar(student) {
            const calendar = document.getElementById('sheet-weeks-calendar');
            calendar.innerHTML = '';

            // Use all weeks including holidays to ensure current week is always visible
            const allWeeks = getAllWeekIdsOrdered();
            const mapping = allWeeks.map(id => ({ id }));

            // Calculate current real week ID based on timestamp
            const currentRealWeekId = getCurrentWeekIdFromDate();

            mapping.forEach(item => {
                const btn = document.createElement('button');
                btn.style.cssText = `padding:10px; background:#222; color:#fff; border:1px solid #333; border-radius:4px; cursor:pointer; font-weight:bold; transition:all 0.2s; font-size:0.9rem;`;
                // Show the actual week id (e.g. '36'..'51', '1'..'26') so both calendars match visually
                let displayLabel = item.id;
                if (String(displayLabel).startsWith('F_')) displayLabel = 'F';

                // CHECK FOR DATA (Visual Indicator)
                const key = `${student.classe}_${student.nom}_${student.prenom}_w${item.id}`;
                const hasData = studentWeeklyData[key] && (
                    (studentWeeklyData[key].notes && studentWeeklyData[key].notes.trim() !== '') ||
                    (studentWeeklyData[key].status && studentWeeklyData[key].status !== '')
                );

                // Check if this is the current real week
                const isCurrentWeek = (String(item.id) === String(currentRealWeekId));
                if (isCurrentWeek) {
                    // Add specific style for current week
                    btn.style.border = '2px solid var(--primary-color)';
                    btn.style.boxShadow = '0 0 5px var(--primary-color)';
                    btn.title = "Semaine actuelle (Horodatage)";
                    btn.classList.add('current-real-week-btn');
                    // Add a small indicator text or icon if needed, but border is good
                }

                if (hasData) {
                    btn.textContent = String(displayLabel) + ' ✓';
                    btn.dataset.hasData = "true";
                    if (!isCurrentWeek) { // Only override border if not current week
                        btn.style.borderColor = '#4CAF50';
                    }
                    btn.style.color = '#4CAF50';
                } else {
                    btn.textContent = String(displayLabel);
                    btn.dataset.hasData = "false";
                }

                btn.dataset.weekId = item.id;
                btn.onclick = () => selectWeekInSheet(item.id, student);

                calendar.appendChild(btn);
            });
        }

        function selectWeekInSheet(weekId, student) {
            // ÉTAPE 0: Sauvegarder les notes de la semaine ACTUELLE avant de changer de semaine
            const currentWeekId = document.getElementById('sheet-current-week').value;
            if (currentWeekId && currentWeekId !== weekId) {
                console.log('📝 Changement de semaine détecté - Sauvegarde', currentWeekId);
                if (typeof saveWeeklyData === 'function') saveWeeklyData(false);
            }

            // RESET DAY INDEX after saving
            if (document.getElementById('sheet-current-day-index')) document.getElementById('sheet-current-day-index').value = '';

            // weekId is the internal id like '36' or 'F_10'
            const mapping = getCountedWeekMapping(36);
            const found = mapping.find(m => m.id === weekId);
            // Use the actual week id for the sheet label so it matches the repartition calendar
            let label;
            if (String(weekId).startsWith('F_')) {
                label = 'F';
            } else if (found) {
                label = String(found.id).split('@')[0]; // strip occurrence suffix for display
            } else {
                label = String(weekId).split('@')[0];
            }

            // Update surbrillance: remove from tous, add to clicked
            const calendar = document.getElementById('sheet-weeks-calendar');
            if (calendar) {
                calendar.querySelectorAll('button').forEach(btn => {
                    // RESET to base style
                    btn.style.transform = 'scale(1)';
                    btn.style.background = '#222';
                    btn.style.boxShadow = 'none';
                    btn.style.fontSize = '0.9rem';
                    btn.classList.remove('selected-week-btn');

                    // RESTORE has-data style
                    if (btn.dataset.hasData === "true") {
                        btn.style.color = '#4CAF50';
                        // Only restore border color if NOT current week
                        if (!btn.classList.contains('current-real-week-btn')) {
                            btn.style.borderColor = '#4CAF50';
                            btn.style.borderWidth = '1px';
                        }
                    } else {
                        btn.style.color = '#fff';
                        if (!btn.classList.contains('current-real-week-btn')) {
                            btn.style.borderColor = '#333';
                        }
                    }

                    // RESTORE current-real-week style
                    if (btn.classList.contains('current-real-week-btn')) {
                        btn.style.border = '2px solid var(--primary-color)';
                        btn.style.boxShadow = '0 0 5px var(--primary-color)';
                    }
                });

                const clickedBtn = calendar.querySelector(`button[data-week-id='${weekId}']`);
                if (clickedBtn) {
                    clickedBtn.style.background = 'var(--primary-color)';
                    clickedBtn.style.color = '#fff'; // Selected is always white text
                    // Keep the border if it's current week, otherwise standard dark border
                    if (!clickedBtn.classList.contains('current-real-week-btn')) {
                        clickedBtn.style.borderColor = '#333';
                    }
                    clickedBtn.style.transform = 'scale(1.15)';
                    // Enhance shadow for selected item
                    clickedBtn.style.boxShadow = '0 0 15px var(--primary-color)';
                    clickedBtn.classList.add('selected-week-btn');
                }
            }

            document.getElementById('sheet-selected-week').textContent = label;
            document.getElementById('sheet-current-week').value = weekId;
            document.getElementById('sheet-week-data').style.display = 'block';

            // --- DATE LOGIC ADDITION ---
            const datesSpan = document.getElementById('sheet-week-dates');
            const daysContainer = document.getElementById('sheet-days-selector');
            if (datesSpan) datesSpan.textContent = '';
            if (daysContainer) daysContainer.innerHTML = '';

            // Extract numeric week number, handling "F_" prefix
            const wNum = parseInt(String(weekId).replace('F_', ''));

            if (!isNaN(wNum)) {
                const getMonday = (w, y) => {
                    const d = new Date(y, 0, 4);
                    d.setHours(0, 0, 0, 0);
                    const day = d.getDay() || 7;
                    d.setDate(d.getDate() + (w - 1) * 7 - day + 1);
                    return d;
                };
                // Threshold 30: Weeks >= 30 are usually Sept-Dec of SchoolYear. Weeks < 30 are Jan-July of SchoolYear+1
                const year = (wNum >= 30) ? appData.schoolYear : appData.schoolYear + 1;
                const mond = getMonday(wNum, year);

                const sund = new Date(mond); sund.setDate(mond.getDate() + 6);

                if (datesSpan) {
                    const fmt = (d) => `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                    datesSpan.textContent = `(${fmt(mond)} au ${fmt(sund)})`;
                }

                if (daysContainer) {
                    const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    let todayButtonIndex = -1;
                    
                    days.forEach((dName, i) => {
                        const d = new Date(mond); d.setDate(mond.getDate() + i);
                        const btn = document.createElement('div');
                        btn.className = 'day-selector-btn';

                        // Vérifier si c'est le jour actuel
                        const btnDate = new Date(d);
                        btnDate.setHours(0, 0, 0, 0);
                        const isToday = (btnDate.getTime() === today.getTime());
                        
                        if (isToday) {
                            todayButtonIndex = i;
                        }

                        // Check for data presence
                        const key = `${student.classe}_${student.nom}_${student.prenom}_w${weekId}`;
                        const sData = studentWeeklyData[key];

                        // --- AUTO-MIGRATE: Affecter l'entrée au jour correspondant à sa date de création ---
                        if (sData && (sData.createdTimestamp || sData.timestamp)) {
                            // On utilise createdTimestamp en priorité, sinon timestamp (pour anciennes données)
                            const ts = sData.createdTimestamp || sData.timestamp;
                            // Format attendu: DD/MM/YYYY HH:MM:SS
                            if (ts && ts.includes('/')) {
                                const datePart = ts.split(' ')[0];
                                const parts = datePart.split('/');
                                if (parts.length === 3) {
                                    // Construct Date (Month is 0-indexed)
                                    const entryDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                    const jsDay = entryDate.getDay(); // 0=Sun, 1=Mon...
                                    const targetIndex = (jsDay + 6) % 7; // 0=Lun, 1=Mar... 6=Dim

                                    // Si on est sur le bouton du jour correspondant
                                    if (targetIndex === i) {
                                        if (!sData.days) sData.days = {};
                                        // Si aucune donnée spécifique n'existe pour ce jour, on affecte la donnée globale
                                        if (!sData.days[i]) {
                                            sData.days[i] = {
                                                notes: sData.notes,
                                                status: sData.status,
                                                color: sData.color,
                                                timestamp: ts
                                            };
                                            console.log(`Auto-migration: Données S${weekId} affectées à ${dName} (${datePart})`);
                                        }
                                    }
                                }
                            }
                        }

                        const dayData = (sData && sData.days && sData.days[i]);
                        const hasDayData = dayData && (dayData.notes || dayData.status || dayData.color);

                        const checkMark = hasDayData ? '<span class="day-check" style="color:#4CAF50; font-weight:bold;"> ✓</span>' : '';

                        // Style par défaut
                        let defaultBgColor = '#333';
                        let defaultTextColor = '#ccc';
                        let defaultBorderColor = '#555';
                        
                        // Si c'est le jour actuel, couleur framboise
                        if (isToday) {
                            defaultBgColor = '#E91E63';
                            defaultTextColor = 'white';
                            defaultBorderColor = '#E91E63';
                        }

                        btn.style.cssText = `padding:6px 10px; background:${defaultBgColor}; color:${defaultTextColor}; border:1px solid ${defaultBorderColor}; border-radius:4px; cursor:pointer; font-size:0.85rem; text-align:center; min-width:45px; flex:1; transition:all 0.2s; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative;`;
                        btn.innerHTML = `<div style="font-weight:bold; margin-bottom:2px;">${dName}${checkMark}</div><div style="font-size:0.75em; opacity:0.8;">${d.getDate()}/${d.getMonth() + 1}</div>`;

                        btn.onclick = () => {
                            // 1. SAVE PREVIOUS STATE (Day or Global)
                            if (typeof saveWeeklyData === 'function') saveWeeklyData(false);

                            // 2. VISUAL UPDATE
                            Array.from(daysContainer.children).forEach(c => {
                                c.style.background = '#333';
                                c.style.color = '#ccc';
                                c.style.borderColor = '#555';
                                c.style.transform = 'scale(1)';
                            });
                            btn.style.background = '#FFA500'; // Match Theme Orange
                            btn.style.color = 'black';
                            btn.style.borderColor = '#FFA500';
                            btn.style.transform = 'scale(1.05)';

                            // 3. SET MODE & INDEX
                            const idxInput = document.getElementById('sheet-current-day-index');
                            if (idxInput) idxInput.value = i;

                            // 4. LOAD DATA FOR THIS DAY
                            const currKey = `${student.classe}_${student.nom}_${student.prenom}_w${weekId}`;
                            const currData = studentWeeklyData[currKey] || {};
                            const dData = (currData.days && currData.days[i]) ? currData.days[i] : {};

                            // --- DATE D'EFFET (Date Réelle du jour sélectionné) ---
                            // `d` (from the loop closure) is the Date object for this day button
                            const effectDateStr = d.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                            const effectDateDisplay = document.getElementById('sheet-week-effect-date-display');
                            if (effectDateDisplay) {
                                effectDateDisplay.textContent = `Date d'effet : ${effectDateStr}`;
                            }

                            const noteEl = document.getElementById('sheet-week-notes');
                            if (noteEl) setElementValue(noteEl, dData.notes || '');

                            const statEl = document.getElementById('sheet-week-status');
                            if (statEl) statEl.value = dData.status || '';

                            const col = dData.color || '';
                            const radios = document.querySelectorAll('input[name="weekColor"]');
                            radios.forEach(r => {
                                r.checked = false;
                                if (r.dataset) r.dataset.wasChecked = 'false';
                            });

                            if (col) {
                                const rad = document.querySelector(`input[name="weekColor"][value="${col}"]`);
                                if (rad) {
                                    rad.checked = true;
                                    if (rad.dataset) rad.dataset.wasChecked = 'true';
                                }
                            }

                            // Update timestamp display if needed
                            const tsDisplay = document.getElementById('sheet-week-timestamp-display');
                            const displayTs = dData.createdTimestamp || dData.timestamp;
                            if (tsDisplay) tsDisplay.textContent = displayTs ? `créer le : ${displayTs}` : '';
                        };
                        daysContainer.appendChild(btn);
                    });
                    
                    // Sélectionner automatiquement le jour actuel s'il existe dans cette semaine
                    if (todayButtonIndex >= 0 && todayButtonIndex < daysContainer.children.length) {
                        // Attendre un instant que le DOM soit mis à jour
                        setTimeout(() => {
                            const todayBtn = daysContainer.children[todayButtonIndex];
                            if (todayBtn) {
                                todayBtn.click();
                            }
                        }, 50);
                    }
                }
            }

            // Load weekly data keyed by weekId
            const key = `${student.classe}_${student.nom}_${student.prenom}_w${weekId}`;

            // RESET RADIOS (Visual & Toggle State)
            document.querySelectorAll('input[name="weekColor"]').forEach(r => {
                r.checked = false;
                if (r.dataset) r.dataset.wasChecked = 'false';
            });

            if (studentWeeklyData[key]) {
                document.getElementById('sheet-week-status').value = studentWeeklyData[key].status || '';
                document.getElementById('sheet-week-notes').value = studentWeeklyData[key].notes || '';

                // Load color
                const color = studentWeeklyData[key].color;
                if (color) {
                    const radio = document.querySelector(`input[name="weekColor"][value="${color}"]`);
                    if (radio) {
                        radio.checked = true;
                        if (radio.dataset) radio.dataset.wasChecked = 'true';
                    }
                }

                // Load timestamp
                const tsDisplay = document.getElementById('sheet-week-timestamp-display');
                const displayTs = studentWeeklyData[key].createdTimestamp || studentWeeklyData[key].timestamp;
                if (tsDisplay) tsDisplay.textContent = displayTs ? `créer le : ${displayTs}` : '';
            } else {
                document.getElementById('sheet-week-status').value = '';
                setElementValue(document.getElementById('sheet-week-notes'), '');
                document.querySelectorAll('input[name="weekColor"]').forEach(r => r.checked = false);
                const tsDisplay = document.getElementById('sheet-week-timestamp-display');
                if (tsDisplay) tsDisplay.textContent = '';
            }

            // RESET DATE D'EFFET (Wait for day selection)
            const effectDateDisplay = document.getElementById('sheet-week-effect-date-display');
            if (effectDateDisplay) effectDateDisplay.textContent = '';
        }

        function printSearchResults(containerId, title, term = '') {
            const content = document.getElementById(containerId).innerHTML;
            if (!content || content.includes('Commencez à taper') || content.includes('Aucun')) {
                alert("Rien à imprimer.");
                return;
            }
            const html = `
                <html><head><title>${title}</title>
                <style>
                    body{font-family:Arial;padding:30px;background:#fff;color:#000}
                    h1{border-bottom:2px solid #333;padding-bottom:10px;margin-bottom:5px}
                    .search-term{font-style:italic;color:#666;margin-bottom:20px;font-size:1.1rem}
                    .search-result-item{border:1px solid #ccc;margin-bottom:10px;padding:10px;display:flex;justify-content:space-between;align-items:center}
                    .keyword-match-reason{font-size:0.8rem;color:#666;margin-top:5px}
                    span{font-weight:bold}
                </style>
                </head><body>
                    <h1>${title}</h1>
                    ${term ? `<div class="search-term">Mot recherche : <strong>${term}</strong></div>` : ''}
                    ${content}
                </body></html>
            `;
            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
            w.focus();
            setTimeout(() => w.print(), 500);
        }

        function handleColorRadioClick(radio) {
            if (radio.disabled) return;
            // We rely on 'onclick' which fires after change. 
            // Tricky part: native radio behavior prevents unchecking on click.
            // We need to track state.
            if (radio.dataset.wasChecked === 'true') {
                radio.checked = false;
                radio.dataset.wasChecked = 'false';
            } else {
                const name = radio.name;
                document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.dataset.wasChecked = 'false');
                radio.checked = true;
                radio.dataset.wasChecked = 'true';
            }
        }

        function getDateFromWeekId(weekIdStr, dayIndex = 0) {
            const wNum = parseInt(String(weekIdStr).replace('F_', ''));
            if (isNaN(wNum)) return null;
            // Threshold 30: Weeks >= 30 are usually Sept-Dec of SchoolYear. Weeks < 30 are Jan-July of SchoolYear+1
            const y = (wNum >= 30) ? appData.schoolYear : appData.schoolYear + 1;
            const d = new Date(y, 0, 4);
            d.setHours(0, 0, 0, 0); // Set to midnight
            const day = d.getDay() || 7;
            d.setDate(d.getDate() + (wNum - 1) * 7 - day + 1 + dayIndex);
            return d;
        }

        function saveWeeklyData(showConfirm = true, doc = document) {
            // Vérifier si l'application est verrouillée
            if (isApplicationLocked()) {
                if (showConfirm) {
                    alert('🔒 Application verrouillée\n\nLe logiciel est en mode consultation uniquement.\nVous ne pouvez pas sauvegarder les modifications.\n\nCliquez sur le bouton "Déverrouiller" en haut de l\'écran.');
                }
                return;
            }
            
            const studentJson = doc.getElementById('sheet-student-json').value;
            if (!studentJson) return;
            const student = JSON.parse(studentJson);
            const weekId = doc.getElementById('sheet-current-week').value;
            if (!weekId) { if (showConfirm) alert('Aucune semaine sélectionnée'); return; }
            const key = `${student.classe}_${student.nom}_${student.prenom}_w${weekId}`;

            // MODE JOUR (NOUVEAU)
            const dayIndexVal = doc.getElementById('sheet-current-day-index') ? doc.getElementById('sheet-current-day-index').value : '';
            const isDayMode = (dayIndexVal !== '');
            const dayIndex = isDayMode ? parseInt(dayIndexVal) : null;

            const notesElement = doc.getElementById('sheet-week-notes');
            const notesValue = notesElement ? getElementValue(notesElement) : '';
            const statusElement = doc.getElementById('sheet-week-status');
            const statusValue = statusElement ? statusElement.value : '';
            const colorElement = doc.querySelector('input[name="weekColor"]:checked');
            const colorValue = colorElement ? colorElement.value : '';

            let data = studentWeeklyData[key] || {};
            if (!data.versions) data.versions = [];

            const nowStr = new Date().toLocaleString('fr-FR');
            let hasChanged = false;

            if (isDayMode) {
                // --- LOGIQUE SAUVEGARDE PAR JOUR ---
                if (!data.days) data.days = {};
                const existingDay = data.days[dayIndex] || {};
                if ((existingDay.notes || '') !== notesValue || (existingDay.status || '') !== statusValue || (existingDay.color || '') !== colorValue) {
                    hasChanged = true;
                    data.days[dayIndex] = { notes: notesValue, status: statusValue, color: colorValue, timestamp: nowStr };
                }

                // Générer résumé global pour compatibilité
                let summaryNotes = "";
                const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
                Object.keys(data.days).sort().forEach(dIdx => {
                    const d = data.days[dIdx];
                    if ((d.notes && d.notes.trim()) || d.status) {
                        const name = dayNames[dIdx] || 'Jour ' + (parseInt(dIdx) + 1);
                        summaryNotes += `[${name}]`;
                        if (d.status) summaryNotes += ` (${d.status})`;
                        if (d.notes) summaryNotes += ` ${d.notes}`;
                        summaryNotes += '\n';
                    }
                });
                if (summaryNotes.trim()) {
                    data.notes = summaryNotes.trim();
                }
                // On garde la dernière couleur du jour comme couleur de la semaine si définie
                if (colorValue) data.color = colorValue;
                if (statusValue) data.status = statusValue; // Et le dernier statut
            } else {
                // --- LOGIQUE CLASSIQUE (Semaine Globale) ---
                if ((data.notes || '') !== notesValue || (data.status || '') !== statusValue || (data.color || '') !== colorValue) {
                    hasChanged = true;
                    data.notes = notesValue;
                    data.status = statusValue;
                    data.color = colorValue;
                }
            }

            if (hasChanged) {
                data.timestamp = nowStr;
                if (!data.createdTimestamp) data.createdTimestamp = nowStr;
                data.modificationCount = (data.modificationCount || 0) + 1;
                // On ajoute à l'historique global
                data.versions.push({ timestamp: nowStr, notes: notesValue, status: statusValue, color: colorValue, dayIndex: dayIndex });

                studentWeeklyData[key] = data;
                if (!appData.weeklyReports) appData.weeklyReports = {};
                appData.weeklyReports[key] = data;
                saveAppData();

                // Update Visual Checkmark on Day Button
                if (isDayMode && doc.getElementById('sheet-days-selector')) {
                    const btns = doc.getElementById('sheet-days-selector').children;
                    if (btns[dayIndex]) {
                        const btn = btns[dayIndex];
                        const isEmpty = (!notesValue.trim() && !statusValue && !colorValue);
                        if (!isEmpty) {
                            if (!btn.innerHTML.includes('✓')) {
                                btn.classList.add('has-data');
                                const nameDiv = btn.querySelector('div:first-child');
                                if (nameDiv) {
                                    const check = document.createElement('span');
                                    check.className = 'day-check';
                                    check.textContent = ' ✓';
                                    check.style.color = '#4CAF50';
                                    check.style.fontWeight = 'bold';
                                    nameDiv.appendChild(check);
                                }
                            }
                        } else {
                            btn.classList.remove('has-data');
                            const check = btn.querySelector('.day-check');
                            if (check) check.remove();
                        }
                    }
                }

                if (showConfirm) {
                    showToast("Données enregistrées");
                    updateWeeksCalendarInSheet(student);
                }
                if (typeof refreshCalendarState === 'function') refreshCalendarState();
                if (typeof isAgendaView !== 'undefined' && isAgendaView) renderAgenda();
            } else {
                if (showConfirm) alert('Aucun changement détecté.');
            }
        }

        function verifyNotesInStorage() {
            const student = JSON.parse(document.getElementById('sheet-student-json').value);
            const weekId = document.getElementById('sheet-current-week').value;
            const key = `${student.classe}_${student.nom}_${student.prenom}_w${weekId}`;

            console.log('\n🔍 === DIAGNOSTIC SAUVEGARDE NOTES ===');
            console.log('🔑 Clé:', key);
            const noteEl = document.getElementById('sheet-week-notes');
            console.log('📝 Valeur notes:', noteEl ? getElementValue(noteEl) : 'null');
            console.log('💾 studentWeeklyData[key]:', studentWeeklyData[key]);
            console.log('📦 appData.weeklyReports[key]:', appData.weeklyReports ? appData.weeklyReports[key] : 'weeklyReports non initialisé');

            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                console.log('🗄️ localStorage.weeklyReports[key]:', parsed.weeklyReports ? parsed.weeklyReports[key] : 'weeklyReports absent du localStorage');
                console.log('📊 Total notes dans localStorage:', parsed.weeklyReports ? Object.keys(parsed.weeklyReports).length : 0);
            } else {
                console.log('❌ Aucune donnée dans localStorage!');
            }

            alert('🔍 Diagnostic effectué - Consultez la console (F12) pour les détails');
        }

        function printStudentWeekFromModal() {
            const student = JSON.parse(document.getElementById('sheet-student-json').value || '{}');
            const weekId = document.getElementById('sheet-current-week').value || document.getElementById('sheet-selected-week').textContent;
            if (!student || !weekId) { alert('Sélectionnez une semaine à imprimer.'); return; }
            printStudentWeek(student, weekId);
        }

        // PRINT RANGE SELECTION LOGIC
        let printRangeStart = null;
        let printRangeEnd = null;
        let pRefStudent = null;

        function printStudentReportFromModal() {
            const studentJson = document.getElementById('sheet-student-json').value;
            if (!studentJson) { alert('Ouvrez la fiche d\'un élève d\'abord.'); return; }
            pRefStudent = JSON.parse(studentJson);

            openPrintRangeModal();
        }

        function openPrintRangeModal() {
            let modal = document.getElementById('printRangeModal');
            if (!modal) {
                // Generer la modale si elle n'existe pas
                modal = document.createElement('div');
                modal.id = 'printRangeModal';
                modal.className = 'modal';
                // z-index 40000 (supérieur à Fiche Élève 31000) - FIX: Increased to ensure foreground
                modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:40000; display:none; align-items:center; justify-content:center;';

                modal.innerHTML = `
                    <div class="modal-content" style="width:500px; padding:20px; background:#222; border:2px solid var(--primary-color); border-radius:8px; display:flex; flex-direction:column; gap:15px; box-shadow: 0 0 50px rgba(0,0,0,0.8);">
                        <h3 style="margin:0; text-align:center; color:#fff;">Imprimer Synthèse Période</h3>
                        <p style="color:#aaa; text-align:center; font-size:0.9rem; margin:0;">Sélectionnez la période (Semaine de début - Semaine de fin)</p>
                        
                        <div id="print-range-calendar" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(50px, 1fr)); gap:5px; max-height:300px; overflow-y:auto; padding:10px; background:#111; border:1px solid #444; border-radius:4px;"></div>
                        
                        <div style="display:flex; justify-content:space-between; align-items:center; background:#333; padding:10px; border-radius:4px;">
                            <div style="text-align:center; flex:1;">
                                <div style="font-size:0.8rem; color:#aaa;">Début</div>
                                <div id="print-range-start-display" style="font-weight:bold; color:var(--primary-color);">--</div>
                            </div>
                            <div style="font-size:1.5rem; color:#555;">➔</div>
                            <div style="text-align:center; flex:1;">
                                <div style="font-size:0.8rem; color:#aaa;">Fin</div>
                                <div id="print-range-end-display" style="font-weight:bold; color:var(--primary-color);">--</div>
                            </div>
                        </div>

                        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
                            <button onclick="document.getElementById('printRangeModal').style.display='none'" style="padding:10px 20px; background:#444; color:#fff; border:none; border-radius:4px; cursor:pointer;">Annuler</button>
                            <button onclick="confirmPrintRange()" style="padding:10px 20px; background:var(--primary-color); color:#000; font-weight:bold; border:none; border-radius:4px; cursor:pointer;">IMPRIMER</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Correction z-index si existant mais trop bas
            modal.style.zIndex = '40000';
            modal.style.background = 'rgba(0,0,0,0.95)';

            // Default: Current week if available, or just reset
            const currentWeek = document.getElementById('sheet-current-week').value;
            // Initialize with current week or first available
            printRangeStart = currentWeek || '1';
            printRangeEnd = currentWeek || '1';

            renderPrintRangeCalendar();
            updatePrintRangeDisplay();

            modal.style.display = 'flex';
        }

        function renderPrintRangeCalendar() {
            const container = document.getElementById('print-range-calendar');
            container.innerHTML = '';

            const allWeeks = getAllWeekIdsOrdered(); // Reusing existing helper

            allWeeks.forEach(weekId => {
                const btn = document.createElement('button');
                let label = weekId;
                if (String(weekId).startsWith('F_')) label = 'F'; // Holiday formatting
                // Clean @suffix if present (though usually hidden from UI)
                if (label.includes('@')) label = label.split('@')[0];

                btn.textContent = label;
                btn.style.cssText = `padding:10px; border-radius:4px; font-weight:bold; cursor:pointer; border:1px solid #444; background:#333; color:#aaa; transition:all 0.1s; display:flex; align-items:center; justify-content:center;`;

                // Active Logic
                const isStart = (String(weekId) === String(printRangeStart));
                const isEnd = (String(weekId) === String(printRangeEnd));

                // Check if in range
                if (printRangeStart && printRangeEnd) {
                    const idx = allWeeks.indexOf(String(weekId));
                    const sIdx = allWeeks.indexOf(String(printRangeStart));
                    const eIdx = allWeeks.indexOf(String(printRangeEnd));

                    const min = Math.min(sIdx, eIdx);
                    const max = Math.max(sIdx, eIdx);

                    if (idx >= min && idx <= max) {
                        btn.style.background = 'rgba(0, 242, 255, 0.15)';
                        btn.style.color = '#fff';
                        btn.style.borderColor = 'var(--primary-color)';
                    }
                }

                if (isStart || isEnd) {
                    btn.style.background = 'var(--primary-color)';
                    btn.style.color = '#000';
                    btn.style.boxShadow = '0 0 10px var(--primary-color)';
                    btn.style.zIndex = '2';
                    btn.style.transform = 'scale(1.1)';
                    btn.style.border = 'none';
                }

                btn.onclick = () => handlePrintRangeClick(weekId);
                container.appendChild(btn);
            });
        }

        function handlePrintRangeClick(weekId) {
            // Logic: 
            // 1. If start is null, set start.
            // 2. If start is set but end is null (or same as start), set end.
            // 3. If both set and distinct, reset start to clicked, end to clicked (start new selection).

            if (printRangeStart && printRangeEnd && printRangeStart !== printRangeEnd) {
                // Was a range, start over selection from this click
                printRangeStart = weekId;
                printRangeEnd = weekId;
            } else if (printRangeStart && printRangeStart !== weekId) {
                // Start was set, setting end (allowing start and end to be different)
                printRangeEnd = weekId;
            } else {
                // First click or clicking start again
                printRangeStart = weekId;
                printRangeEnd = weekId;
            }

            // Auto swap if start > end (chronologically) based on array index
            const allWeeks = getAllWeekIdsOrdered();
            const sIdx = allWeeks.indexOf(String(printRangeStart));
            const eIdx = allWeeks.indexOf(String(printRangeEnd));
            if (sIdx > -1 && eIdx > -1) {
                if (sIdx > eIdx) {
                    const temp = printRangeStart;
                    printRangeStart = printRangeEnd;
                    printRangeEnd = temp;
                }
            }

            renderPrintRangeCalendar();
            updatePrintRangeDisplay();
        }

        function updatePrintRangeDisplay() {
            // Helper to get nice label
            const getLabel = (w) => {
                if (!w) return '--';
                if (String(w).startsWith('F_')) return 'Vacances';
                return 'Semaine ' + w.split('@')[0];
            };
            document.getElementById('print-range-start-display').textContent = getLabel(printRangeStart);
            document.getElementById('print-range-end-display').textContent = getLabel(printRangeEnd);
        }

        function confirmPrintRange() {
            if (!printRangeStart || !printRangeEnd) return;
            document.getElementById('printRangeModal').style.display = 'none';
            if (pRefStudent) {
                printStudentReport(pRefStudent, printRangeStart, printRangeEnd);
            }
        }

        function printStudentWeek(student, week) {
            const key = `${student.classe}_${student.nom}_${student.prenom}_w${week}`;
            const studentKey = `${student.classe}_${student.nom}_${student.prenom}`;
            const data = studentWeeklyData[key] || {};
            console.log(`printStudentWeek: key=${key}, hasNotes=${!!data.notes}, hasStatus=${!!data.status}`);

            // Fetch custom rubrics
            const customRubrics = (appData.customRubriques && appData.customRubriques[studentKey]) || [];
            let rubricsHtml = '';
            if (customRubrics.length > 0) {
                rubricsHtml += '<h3>Rubriques Personnalisées</h3>';
                customRubrics.forEach(rub => {
                    rubricsHtml += `<div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;"><strong>${rub.name}:</strong> <div style="white-space:pre-wrap; margin-top:5px;">${rub.content}</div></div>`;
                });
            }

            let dateEffet = '';
            if (data.createdTimestamp) {
                dateEffet = data.createdTimestamp;
            } else if (data.timestamp) {
                dateEffet = data.timestamp;
            }

            const timestampHtml = dateEffet ? `<div style="font-size:0.9em;color:#555;margin-bottom:10px;">Date d'effet : ${dateEffet}</div>` : '';
            const mainInfoTimestamp = ''; // Removed Last Modified as per user request

            const html = `
                <html><head><title>Fiche ${student.nom} ${student.prenom} - Semaine ${week}</title>
                <style>body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#111} h1{font-size:20px} .meta{margin-bottom:10px} .notes{white-space:pre-wrap;border:1px solid #ccc;padding:10px;min-height:100px}</style>
                </head><body>
                <h1>Fiche élève: ${student.nom} ${student.prenom}</h1>
                <div class="meta">Classe: ${student.classe} &nbsp; | &nbsp; Né(e): ${student.dob || ''}</div>
                ${mainInfoTimestamp}
                ${timestampHtml}
                <h2>Semaine ${week}</h2>
                <p><strong>Statut:</strong> ${data.status || '(Aucun statut saisi)'}</p>
                <h3>Information Hebdomadaire</h3>
                <div class="notes">${(data.notes || '(Aucune note saisie)')}</div>
                ${rubricsHtml}
                </body></html>
            `;
            const w = window.open('', '_blank', 'width=800,height=900');
            w.document.write(html);
            w.document.close();
            w.focus();
            setTimeout(() => w.print(), 300);
        }

        function printStudentReport(student, fromWeek, toWeek) {
            const weeks = [];
            const mapping = getCountedWeekMapping(36); // [{id,number}]

            function numToId(n) {
                const found = mapping.find(m => m.number === Number(n));
                return found ? found.id : String(n);
            }

            const nf = Number(fromWeek);
            const nt = Number(toWeek);
            if (!isNaN(nf) && !isNaN(nt)) {
                for (let w = nf; w <= nt; w++) weeks.push(numToId(w));
            } else {
                // If user entered ids directly, use them
                weeks.push(String(fromWeek)); if (toWeek !== fromWeek) weeks.push(String(toWeek));
            }

            let content = `<h1>Récapitulatif: ${student.nom} ${student.prenom}</h1>`;
            content += `<div>Classe: ${student.classe} | Né(e): ${student.dob || ''}</div>`;

            // Check all possible weeks and include those with data
            const allWeekIds = [];
            Object.keys(studentWeeklyData).forEach(k => {
                if (k.startsWith(`${student.classe}_${student.nom}_${student.prenom}_w`)) {
                    const weekId = k.substring(k.lastIndexOf('_w') + 2);
                    if (!allWeekIds.includes(weekId)) allWeekIds.push(weekId);
                }
            });

            allWeekIds.forEach(weekId => {
                const key = `${student.classe}_${student.nom}_${student.prenom}_w${weekId}`;
                const data = studentWeeklyData[key] || {};

                // CHECK DAYS FIRST
                if (data.days && Object.keys(data.days).length > 0) {
                    const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
                    let weekContent = "";
                    Object.keys(data.days).sort().forEach(dIdx => {
                        const d = data.days[dIdx];
                        if (d.notes || d.status) {
                            const effectDate = getDateFromWeekId(weekId, parseInt(dIdx));
                            const dateStr = effectDate ? effectDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) : '';
                            // Show ONLY effective date
                            const displayDate = dateStr || ('Jour ' + dIdx);

                            content += `<div style="background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:4px;">
                                <h3 style="margin-top:0; color:#333; border-bottom:1px solid #eee; padding-bottom:5px; text-transform:capitalize;">${displayDate}</h3>
                                <p><strong>Statut:</strong> ${d.status || ''}</p>
                                <div style="white-space:pre-wrap; color:#555;">${d.notes || ''}</div>
                             </div>`;
                        }
                    });
                }
                // FALLBACK GLOBAL (Legacy)
                else if (data.status || data.notes) {
                    // If no granular days, we assume Monday or just show Week?
                    // Let's show "Semaine X" and content.
                    // If we can calculate Monday date:
                    // If we can calculate Monday date:
                    const mondayDate = getDateFromWeekId(weekId, 0);
                    const dateStr = mondayDate ? mondayDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }) : '';

                    let dateDisplay = `Semaine ${weekId} <span style="font-size:0.8em; font-weight:normal;">(Lundi ${dateStr})</span>`;

                    // User request: n'afficher que la date d'effet if available
                    if (data.createdTimestamp) {
                        dateDisplay = `Semaine ${weekId} <span style="font-size:0.8em; font-weight:normal;">(Date d'effet : ${data.createdTimestamp})</span>`;
                    } else if (data.timestamp) {
                        dateDisplay = `Semaine ${weekId} <span style="font-size:0.8em; font-weight:normal;">(Date d'effet : ${data.timestamp})</span>`;
                    }

                    content += `<h2>${dateDisplay}</h2><p><strong>Statut:</strong> ${data.status || ''}</p><div style="border:1px solid #ccc;padding:8px;white-space:pre-wrap;margin-bottom:20px">${data.notes || ''}</div>`;
                }
            });

            // Add Custom Rubrics
            const studentKey = `${student.classe}_${student.nom}_${student.prenom}`;
            const customRubrics = (appData.customRubriques && appData.customRubriques[studentKey]) || [];
            if (customRubrics.length > 0) {
                content += '<h2>Rubriques Personnalisées</h2>';
                customRubrics.forEach(rub => {
                    content += `<div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;"><strong>${rub.name}:</strong> <div style="white-space:pre-wrap; margin-top:5px;">${rub.content}</div></div>`;
                });
            }

            const html = `<html><head><title>Récap ${student.nom} ${student.prenom}</title><style>body{font-family:Arial;padding:20px}</style></head><body>${content}</body></html>`;
            const w = window.open('', '_blank', 'width=900,height=1000');
            w.document.write(html); w.document.close();
            setTimeout(() => w.print(), 300);
        }

        // --- GESTION DES RUBRIQUES DYNAMIQUES DANS LA FICHE ---

        let pendingRubrics = []; // Stores {id, name, content} for current student sheet

        function renderCustomRubriquesForSheet(studentKey) {
            const container = document.getElementById('sheet-custom-rubriques-container');
            container.innerHTML = '';

            if (!appData.customRubriques) appData.customRubriques = {};
            const studentRubrics = appData.customRubriques[studentKey] || [];

            studentRubrics.forEach((rub, idx) => {
                // Si c'est une note hebdomadaire, on charge son contenu depuis studentWeeklyData
                let content = rub.content;
                if (rub.type === 'weekly-note' && rub.weekId) {
                    const weekKey = `${studentKey}_w${rub.weekId}`;
                    if (studentWeeklyData[weekKey]) {
                        content = studentWeeklyData[weekKey].notes || '';
                    } else {
                        content = '';
                    }
                }
                addRubricDOM(container, idx, rub.name, content, rub.type, rub.weekId);
            });
        }

        function addRubricDOM(container, idx, name, content, type = 'standard', weekId = null) {
            const div = document.createElement('div');
            div.className = 'custom-rubric-item';
            div.dataset.index = idx;
            div.dataset.type = type;
            if (weekId) div.dataset.weekId = weekId;

            // Style différent pour les notes hebdo
            const isWeekly = (type === 'weekly-note');
            const borderColor = isWeekly ? 'var(--primary-color)' : '#444';
            const borderStyle = isWeekly ? 'solid' : 'dashed';
            const bgColor = isWeekly ? '#2a2a2a' : 'transparent';

            div.style.cssText = `margin-top:15px; border-top:1px ${borderStyle} ${borderColor}; padding-top:15px; background:${bgColor}; padding:10px; border-radius:5px;`;

            const nameInputDisabled = isWeekly ? 'disabled' : '';
            const nameColor = isWeekly ? '#fff' : 'var(--primary-color)';

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                     <input type="text" class="rubric-name" value="${name}" ${nameInputDisabled} list="rubricList" spellcheck="true" lang="fr" autocorrect="on" placeholder="Nom de la rubrique..." style="background:transparent; border:none; border-bottom:1px solid ${nameColor}; color:${nameColor}; font-weight:bold; font-size:0.95rem; width:70%;">
                     <div style="display:flex; gap:5px;">
                        <button onclick="this.closest('.custom-rubric-item').remove()" style="background:#D32F2F; color:white; border:none; border-radius:3px; padding:2px 8px; cursor:pointer; font-size:0.8rem;">Supprimer</button>
                     </div>
                </div>
                <div style='margin-bottom:5px; display:flex; align-items:center; gap:18px; flex-wrap:wrap;'>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label for="rubric-font-${idx}" style="color:#aaa; font-size:0.85rem;">Style de caractère :</label>
                        <select id="rubric-font-${idx}" onchange="document.getElementById('rubric-content-${idx}').style.fontFamily=this.value;" style="background:#333; color:#eee; border:1px solid #555; border-radius:4px; padding:2px 5px; font-size:0.85rem;">
                            <option value="monospace">Monospace</option>
                            <option value="Arial, Helvetica, sans-serif">Arial</option>
                            <option value="Times New Roman, Times, serif">Times New Roman</option>
                            <option value="Comic Sans MS, Comic Sans, cursive">Comic Sans</option>
                            <option value="Courier New, Courier, monospace">Courier New</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="Verdana, Geneva, sans-serif">Verdana</option>
                        </select>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label style="color:#aaa; font-size:0.85rem; margin-right:4px;">Mots fréquents :</label>
                        <select onchange="insertFrequentWordRubric(this.value, 'rubric-content-${idx}'); this.value='';" style="background:#333; color:#eee; border:1px solid #555; border-radius:4px; padding:2px 5px; font-size:0.85rem;">
                            <option value="">-- Ajouter --</option>
                            <option value="Bavardages">Bavardages</option>
                            <option value="Agitation">Agitation</option>
                            <option value="Travail non fait">Travail non fait</option>
                            <option value="Matériel oublié">Matériel oublié</option>
                            <option value="Retard">Retard</option>
                            <option value="Usage téléphone">Usage téléphone</option>
                            <option value="Refus de travail">Refus de travail</option>
                            <option value="Insolence">Insolence</option>
                            <option value="Dort">Dort en classe</option>
                            <option value="Participation">Participation active</option>
                            <option value="Progrès">Progrès</option>
                        </select>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button onclick="toggleFormatOptions('rubric-format-bar-${idx}')" style="padding:3px 8px; background:#555; color:#fff; border:1px solid #666; border-radius:4px; cursor:pointer; font-size:0.75rem;">⚙️ Format</button>
                    </div>
                </div>
                <div id="rubric-format-bar-${idx}" style="display:none; margin-bottom:8px; margin-top:5px; align-items:center; gap:4px; flex-wrap:wrap;">
                    <button onclick="applyTextFormat('rubric-content-${idx}', 'bold')" title="Gras (sélectionnez du texte d'abord)" style="padding:2px 5px; background:#555; color:#fff; border:1px solid #666; border-radius:3px; cursor:pointer; font-weight:bold; font-size:0.7rem;">𝐁</button>
                    <button onclick="applyTextFormat('rubric-content-${idx}', 'italic')" title="Italique (sélectionnez du texte d'abord)" style="padding:2px 5px; background:#555; color:#fff; border:1px solid #666; border-radius:3px; cursor:pointer; font-style:italic; font-size:0.7rem;">𝐼</button>
                    <button onclick="applyTextFormat('rubric-content-${idx}', 'underline')" title="Souligné (sélectionnez du texte d'abord)" style="padding:2px 5px; background:#555; color:#fff; border:1px solid #666; border-radius:3px; cursor:pointer; text-decoration:underline; font-size:0.7rem;">U̲</button>
                    <button onclick="applyTextFormat('rubric-content-${idx}', 'highlight')" title="Surligner (sélectionnez du texte d'abord)" style="padding:2px 5px; background:#FFD700; color:#000; border:1px solid #666; border-radius:3px; cursor:pointer; font-weight:bold; font-size:0.7rem;">🖍</button>
                    <span style="color:#555; margin:0 2px;">|</span>
                    <label style="color:#aaa; font-size:0.7rem;">Taille:</label>
                    <select onchange="changeFontSize('rubric-content-${idx}', this.value)" style="background:#333; color:#eee; border:1px solid #555; border-radius:3px; padding:1px 3px; font-size:0.7rem;">
                        <option value="0.8rem">Petit</option>
                        <option value="0.9rem" selected>Normal</option>
                        <option value="1.05rem">Grand</option>
                        <option value="1.2rem">Très grand</option>
                    </select>
                </div>
                <div class="rubric-content" id="rubric-content-${idx}" contenteditable="true" spellcheck="true" lang="fr" style="width:100%; min-height:40px; max-height:400px; padding:10px; background:#222; border:1px solid #333; border-radius:4px; color:#fff; font-size:0.9rem; overflow-y:auto; white-space:pre-wrap; word-wrap:break-word;" onfocus="this.style.minHeight='400px';" onblur="this.style.minHeight='40px';">${content}</div>
            `;
            container.appendChild(div);
        }

        function addNewRubricToSheet() {
            const container = document.getElementById('sheet-custom-rubriques-container');
            const newIdx = Date.now();
            addRubricDOM(container, newIdx, '', '');

            setTimeout(() => {
                const newRubric = container.lastElementChild;
                if (newRubric) {
                    newRubric.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Optionnel : donner le focus au champ de nom
                    const input = newRubric.querySelector('.rubric-name');
                    if (input) input.focus();
                }
            }, 100);
        }

        function saveStudentSheet(close = false) {
            const elementId = document.getElementById('sheet-element-id').value;
            // Gather basic info...
            const student = {
                nom: document.getElementById('sheet-nom').value,
                prenom: document.getElementById('sheet-prenom').value,
                dob: document.getElementById('sheet-dob').value,
                sexe: document.getElementById('sheet-sexe').value,
                classe: document.getElementById('sheet-classe').value,
                groupes: document.getElementById('sheet-groupes').value,
                projet: document.getElementById('sheet-projet').value,
                allergies: document.getElementById('sheet-allergies').value,
                options: document.getElementById('sheet-options').value,
                engagement: document.getElementById('sheet-engagement').value,
                redoublant: document.getElementById('sheet-redoublant').value,
                majeur: document.getElementById('sheet-majeur').value,
                lastModified: new Date().toLocaleString('fr-FR')
            };

            const element = document.getElementById(elementId);
            if (element) {
                element.dataset.student = JSON.stringify(student);
                const lastSpan = element.querySelector('.student-last');
                const firstSpan = element.querySelector('.student-first');
                if (lastSpan) lastSpan.textContent = student.nom;
                if (firstSpan) firstSpan.textContent = student.prenom;
            }

            const oldStudent = JSON.parse(document.getElementById('sheet-student-json').value || '{}');
            const oldKey = `${oldStudent.classe || ''}_${oldStudent.nom || ''}_${oldStudent.prenom || ''}`;
            const newKey = `${student.classe}_${student.nom}_${student.prenom}`;

            // 1. Save Basic Info
            if (!appData.students[student.classe]) appData.students[student.classe] = {};
            const existing = (appData.students[oldStudent.classe] && appData.students[oldStudent.classe][oldKey]) || {};
            appData.students[student.classe][newKey] = {
                ...existing,
                ...student
            };

            // 2. Handle Key Change
            if (oldKey !== newKey) {
                if (appData.students[oldStudent.classe]) delete appData.students[oldStudent.classe][oldKey];
                if (appData.studentColors && appData.studentColors[oldKey]) {
                    appData.studentColors[newKey] = appData.studentColors[oldKey];
                    delete appData.studentColors[oldKey];
                }
                // Move Custom Rubrics
                if (appData.customRubriques && appData.customRubriques[oldKey]) {
                    appData.customRubriques[newKey] = appData.customRubriques[oldKey];
                    delete appData.customRubriques[oldKey];
                }
            }

            // 3. Save Custom Rubrics from DOM
            const container = document.getElementById('sheet-custom-rubriques-container');
            const rubricsToSave = [];

            // Ensure global list exists
            if (!appData.rubriqueList) appData.rubriqueList = [];

            container.querySelectorAll('.custom-rubric-item').forEach(item => {
                const name = item.querySelector('.rubric-name').value.trim();
                const content = item.querySelector('.rubric-content').value;
                const type = item.dataset.type || 'standard';
                const weekId = item.dataset.weekId || null;

                if (name) {
                    rubricsToSave.push({ name, content, type, weekId });

                    // Add to global list if standard and new
                    if (type === 'standard' && !appData.rubriqueList.includes(name)) {
                        appData.rubriqueList.push(name);
                    }

                    // Sync with Weekly Data if it's a weekly note
                    if (type === 'weekly-note' && weekId) {
                        const key = `${student.classe}_${student.nom}_${student.prenom}_w${weekId}`;
                        if (!studentWeeklyData[key]) studentWeeklyData[key] = {};
                        studentWeeklyData[key].notes = content;
                        studentWeeklyData[key].lastModified = new Date().toISOString();
                        // Also ensure we save this to persistence
                        localStorage.setItem('studentWeeklyData', JSON.stringify(studentWeeklyData));
                    }
                }
            });
            if (!appData.customRubriques) appData.customRubriques = {};
            appData.customRubriques[newKey] = rubricsToSave;

            // 4. Save AppData
            saveAppData();
            document.getElementById('sheet-student-json').value = JSON.stringify(student);

            if (close) {
                document.getElementById('studentSheetModal').style.display = 'none';
            }
        }

        // Fonction combinée : Enregistrer la fiche ET créer une sauvegarde complète
        function saveStudentSheetAndBackup() {
            // Vérifier si l'application est verrouillée
            if (isApplicationLocked()) {
                alert('🔒 Application verrouillée\n\nLe logiciel est en mode consultation uniquement.\nVous ne pouvez pas sauvegarder les modifications.\n\nCliquez sur le bouton "Déverrouiller" en haut de l\'écran.');
                return;
            }
            
            console.log("🔄 Démarrage de la sauvegarde combinée...");
            console.log("📋 Vérification présence textarea notes...");

            const notesTextarea = document.getElementById('sheet-week-notes');
            if (notesTextarea) {
                console.log("✓ Element trouvé - Contenu:", getElementValue(notesTextarea).substring(0, 100));
            } else {
                console.warn("⚠️ Element 'sheet-week-notes' introuvable!");
            }

            // 1. PRIORITÉ ABSOLUE: Sauvegarder les notes de la semaine en cours
            saveWeeklyData(false);
            console.log("✓ Notes de la semaine sauvegardées EN PREMIER");

            // 2. Sauvegarder la fiche élève avec toutes les rubriques
            saveStudentSheet(false);
            console.log("✓ Fiche élève sauvegardée");

            // 3. Créer la sauvegarde complète
            saveStandaloneHTML();
        }

        function closeStudentSheetModal() {
            console.log("🚪 Fermeture de la fiche élève...");

            // IMPORTANT: Sauvegarder les notes pédagogiques avant de fermer
            const currentWeekId = document.getElementById('sheet-current-week').value;
            if (currentWeekId) {
                console.log("💾 Auto-sauvegarde des notes avant fermeture...");
                saveWeeklyData(false);
            }

            // Sauvegarder aussi la fiche élève
            saveStudentSheet(false);

            // Fermer la modal
            const modal = document.getElementById('studentSheetModal');
            modal.style.display = 'none';

            // Check if we opened from annual summary
            if (modal.dataset.origin === 'summary') {
                delete modal.dataset.origin; // Reset
                // Reopen/Ensure Summary is visible
                openAnnualSummaryFromSheet();
                // Assurez-vous que la fenêtre parente (principale) a le focus
                window.focus();
            }

            console.log("✓ Fiche fermée et sauvegardée");

            // Restore Search if applicable
            if (window.lastOriginSearch === 'keyword') {
                const keywordModal = document.getElementById('keywordSearchModal');
                if (keywordModal) {
                    keywordModal.style.display = 'flex';
                }
                window.lastOriginSearch = null;
            }

            // Restore Stats Dashboard if applicable
            if (window.returnToStats) {
                const statsModal = document.querySelector('#statisticsModal');
                if (statsModal) {
                    // Ensure it is visible
                    statsModal.style.display = 'flex';

                    // Ensure Motif List Modal is still visible if it was open
                    // Note: Since motifListModal is child of statisticsModal in new HTML structure, it should be fine.
                    // But if we moved it elsewhere, we'd need to check.
                    // Just to be safe, if we are returning to stats, we often want to focus back on the list if that's where we came from.
                    const motifListModal = document.getElementById('motifListModal');
                    // Check if it was open before? We can't easily know unless we track it.
                    // But the user said "quand on ferme sa fiche revenir a la liste" specifically for the Motif List context.
                    // So if motifListModal has a certain state or if we know we came from there...
                    // In openStatsStudent for motif list, we could set a flag window.returnToMotifList = true

                    if (window.returnToMotifList) {
                        if (motifListModal) motifListModal.style.display = 'flex';
                        window.returnToMotifList = false;
                    }

                    // Try to restore fullscreen
                    if (window.wasStatsFullscreen) {
                        const content = statsModal.querySelector('.modal-content');
                        if (content) {
                            // We cannot auto-request fullscreen without user interaction usually, but let's try or reset state
                            // Most browsers block requestFullscreen without user gesture.
                            // So we might just have to maximize CSS.
                            content.classList.add('fullscreen-mode');
                            const btn = document.getElementById('fsCloseBtn');
                            if (btn) btn.style.display = 'block';
                        }
                    }
                }
                window.returnToStats = false;
                window.wasStatsFullscreen = false;
            }
        }

        function readAllStudentInfo() {
            const student = JSON.parse(document.getElementById('sheet-student-json').value || '{}');
            const keyPrefix = `${student.classe}_${student.nom}_${student.prenom}_w`;

            // Collect all weeks with data
            let reportHTML = `<div style="padding:20px; color:#fff; background:#222; font-family:sans-serif;">`;
            reportHTML += `<h2 style="color:var(--primary-color)">Historique Complet: ${student.nom} ${student.prenom}</h2>`;

            let foundData = false;

            // Sort weeks by id if possible, but map iteration is simpler
            // We use the calendar mapping to be ordered
            const mapping = getCountedWeekMapping(50).map(m => m.id);

            mapping.forEach(weekId => {
                const key = keyPrefix + weekId;
                const data = studentWeeklyData[key];
                if (data && (data.status || data.notes)) {
                    foundData = true;
                    // Translate status code to human readable
                    let statusText = 'Non renseigné';
                    if (data.status === 'status-darkgreen') statusText = 'Présent';
                    if (data.status === 'status-yellow') statusText = 'Absent prévu';
                    if (data.status === 'status-red') statusText = 'Absent';
                    if (data.status === 'status-blue') statusText = 'Autre';

                    if (data.days && Object.keys(data.days).length > 0) {
                        foundData = true;
                        // Sort days ? Keys are 0..6
                        Object.keys(data.days).sort().forEach(dIdx => {
                            const d = data.days[dIdx];
                            if (d.notes || d.status) {
                                const effectDate = getDateFromWeekId(weekId, parseInt(dIdx));
                                const dateStr = effectDate ? effectDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) : '';

                                reportHTML += `<div style="background:#333; padding:15px; margin-bottom:15px; border-radius:5px; border-left:4px solid var(--primary-color);">
                                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                                        <h3 style="margin:0; color:#ddd; text-transform:capitalize;">${dateStr}</h3>
                                    </div>
                                    <p style="margin-bottom:10px;"><strong>Statut:</strong> ${d.statusText || d.status || '-'}</p>
                                    <div style="background:#222; padding:10px; border-radius:4px; white-space:pre-wrap; border:1px solid #444;">${d.notes || '<i>Aucune note</i>'}</div>
                                </div>`;
                            }
                        });
                    }
                    else if (data.notes || data.status) {
                        // Fallback Global
                        foundData = true;
                        const mondayDate = getDateFromWeekId(weekId, 0);
                        const dateStr = mondayDate ? mondayDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }) : '';

                        reportHTML += `<div style="background:#333; padding:15px; margin-bottom:15px; border-radius:5px; border-left:4px solid var(--primary-color);">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                                <h3 style="margin:0; color:#ddd;">Semaine ${weekId} <span style="font-size:0.8em; font-weight:normal;">(Lundi ${dateStr})</span></h3>
                            </div>
                            <p style="margin-bottom:10px;"><strong>Statut:</strong> ${statusText}</p>
                            <div style="background:#222; padding:10px; border-radius:4px; white-space:pre-wrap; border:1px solid #444;">${data.notes || '<i>Aucune note</i>'}</div>
                        </div>`;
                    }
                }
            });

            if (!foundData) {
                reportHTML += `<p style="font-style:italic; color:#aaa;">Aucune information enregistrée pour cet élève.</p>`;
            }

            reportHTML += `<button onclick="this.closest('.modal').remove()" style="margin-top:20px; padding:10px 20px; background:var(--primary-color); border:none; font-weight:bold; cursor:pointer;">Fermer</button>`;
            reportHTML += `</div>`;

            // Show in a new simple modal
            const m = document.createElement('div');
            m.className = 'modal';
            m.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:32000; display:flex; align-items:center; justify-content:center;';
            m.innerHTML = `<div class="modal-content" style="max-width:1000px; width:95%; height:90vh; overflow-y:auto; padding:0; background:#222; border:1px solid #444; box-shadow:0 0 20px rgba(0,0,0,0.5);">${reportHTML}</div>`;
            document.body.appendChild(m);
        }


        function deleteStudentFromClass() {
            const student = JSON.parse(document.getElementById('sheet-student-json').value);

            if (!confirm(`Êtes - vous sûr de vouloir supprimer ${student.nom} ${student.prenom} ?`)) {
                return;
            }

            if (!confirm('DEUXIÈME CONFIRMATION: Supprimer cet élève ? Cette action ne peut pas être annulée.')) {
                return;
            }

            const key = `${student.classe}_${student.nom}_${student.prenom} `;

            // Supprimer de berliozData
            if (berliozData.studentsByClass[student.classe]) {
                berliozData.studentsByClass[student.classe] =
                    berliozData.studentsByClass[student.classe].filter(s =>
                        !(s.nom === student.nom && s.prenom === student.prenom)
                    );
            }

            // Supprimer de appData
            if (appData.students[student.classe]) {
                delete appData.students[student.classe][key];
            }

            if (appData.classes[student.classe]) {
                appData.classes[student.classe].students =
                    appData.classes[student.classe].students.filter(k => k !== key);
            }

            // Supprimer données associées
            delete appData.studentColors[key];
            delete appData.customRubriques[key];
            Object.keys(appData.weeklyReports).forEach(k => {
                if (k.startsWith(key)) {
                    delete appData.weeklyReports[k];
                }
            });

            saveAppData();
            alert(`✓ ${student.nom} ${student.prenom} a été supprimé`);

            // Fermer la modal et rafraîchir l'affichage
            document.getElementById('studentSheetModal').style.display = 'none';
            showClassStudents(student.classe);
        }

        function switchSidebarTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            const tabDiv = document.getElementById('tab-' + tabName);
            if (tabDiv) {
                tabDiv.style.display = 'flex';
            }

            const btn = document.getElementById('btn-tab-' + tabName);
            if (btn) {
                btn.classList.add('active');
            }
        }

        // --- SEARCH FUNCTIONALITY ---

        function openSearchHub() {
            let modal = document.getElementById('searchHubModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'searchHubModal';
                modal.className = 'modal';
                modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:24000; display:flex; align-items:center; justify-content:center;';

                modal.innerHTML = `
                    <div class="modal-content" style="width:400px; padding:30px; background:#222; border:2px solid var(--primary-color); text-align:center; border-radius:15px; box-shadow: 0 0 30px rgba(0,0,0,0.8);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; border-bottom:1px solid #444; padding-bottom:10px;">
                            <h2 style="margin:0; color:#fff; font-size:1.5rem;">🔍 CENTRE DE RECHERCHE</h2>
                            <button onclick="document.getElementById('searchHubModal').style.display='none'" style="background:none; border:none; color:#fff; font-size:2rem; cursor:pointer;">&times;</button>
                        </div>
                        
                        <div style="display:flex; flex-direction:column; gap:15px;">
                            <button onclick="document.getElementById('searchHubModal').style.display='none'; openStudentSearch();" style="padding:15px; font-size:1.1rem; background:#333; color:#fff; border:1px solid #555; border-radius:8px; cursor:pointer; transition:all 0.2s; font-weight:bold;">
                                🧑‍🎓 RECHERCHE PAR ÉLÈVE
                            </button>
                            <button onclick="document.getElementById('searchHubModal').style.display='none'; openClassSearch();" style="padding:15px; font-size:1.1rem; background:#333; color:#fff; border:1px solid #555; border-radius:8px; cursor:pointer; transition:all 0.2s; font-weight:bold;">
                                🏫 RECHERCHE PAR CLASSE
                            </button>
                            <button onclick="document.getElementById('searchHubModal').style.display='none'; openKeywordSearch();" style="padding:15px; font-size:1.1rem; background:#333; color:#fff; border:1px solid #555; border-radius:8px; cursor:pointer; transition:all 0.2s; font-weight:bold;">
                                📝 RECHERCHE PAR MOT CLÉ
                            </button>
                            <button onclick="document.getElementById('searchHubModal').style.display='none'; openEntryCountSearch();" style="padding:15px; font-size:1.1rem; background:#333; color:#fff; border:1px solid #555; border-radius:8px; cursor:pointer; transition:all 0.2s; font-weight:bold;">
                                📊 RECHERCHE PAR NOMBRE DE SAISIES
                            </button>
                        </div>

                        <div style="margin-top:25px; font-size:0.9rem; color:#888;">
                            Sélectionnez un mode de recherche ci-dessus.
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Hover effects
                const btns = modal.querySelectorAll('button[onclick^="document"]');
                btns.forEach(b => {
                    b.onmouseover = () => { b.style.background = 'var(--primary-color)'; b.style.color = '#000'; b.style.transform = 'scale(1.02)'; };
                    b.onmouseout = () => { b.style.background = '#333'; b.style.color = '#fff'; b.style.transform = 'scale(1)'; };
                });
            }
            modal.style.display = 'flex';
        }


        function openStudentSearch() {
            // Create modal if not exists
            let modal = document.getElementById('studentSearchModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'studentSearchModal';
                modal.className = 'modal';
                modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:25000; display:flex; align-items:center; justify-content:center;';

                modal.innerHTML = `
                    <div class="modal-content" style="width:80%; min-width:500px; max-height:85vh; display:flex; flex-direction:column; padding:0; background:#222; border:2px solid var(--primary-color);">
                        <div style="padding:15px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
                            <h2 style="margin:0; color:#fff; display:flex; align-items:center;">
                                Recherche par élève 
                                <span id="searchCountDisplay" style="font-size:0.6em; margin-left:15px; color:var(--primary-color); font-weight:normal;"></span>
                            </h2>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button onclick="printSearchResults('studentSearchResults', 'Résultats de recherche Élèves', document.getElementById('studentSearchInput').value)" style="padding:5px 10px; background:#4CAF50; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">🖨️ Imprimer</button>
                                <button onclick="document.getElementById('studentSearchModal').style.display='none'" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
                            </div>
                        </div>
                        <div style="padding:15px;">
                            <input type="text" id="studentSearchInput" placeholder="Nom de l'élève..." style="width:100%; padding:12px; box-sizing:border-box; border-radius:4px; border:1px solid #555; background:#333; color:#fff; font-size:1.1rem;">
                        </div>
                        <div id="studentSearchResults" style="flex:1; overflow-y:auto; padding:0; max-height:400px;">
                            <!-- Results here -->
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Real-time search
                const input = document.getElementById('studentSearchInput');
                input.addEventListener('input', (e) => performStudentSearch(e.target.value));
            }

            // Reset and show
            document.getElementById('studentSearchInput').value = '';
            if (document.getElementById('searchCountDisplay')) document.getElementById('searchCountDisplay').textContent = '';
            document.getElementById('studentSearchResults').innerHTML = '<div style="padding:20px; color:#666; text-align:center;">Commencez à taper un nom...</div>';
            modal.style.display = 'flex';
            setTimeout(() => document.getElementById('studentSearchInput').focus(), 100);
        }

        function performStudentSearch(query) {
            const resultsContainer = document.getElementById('studentSearchResults');

            if (!query || query.trim().length === 0) {
                resultsContainer.innerHTML = '<div style="padding:20px; color:#666; text-align:center;">Commencez à taper un nom...</div>';
                if (document.getElementById('searchCountDisplay')) document.getElementById('searchCountDisplay').textContent = '';
                return;
            }

            // Split by spaces, filter empty, take max 3 terms
            const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 0).slice(0, 3);
            if (terms.length === 0) return;

            const matches = [];

            // Search in appData.students
            // appData.students structure: { "Class 1": { "key": {...student...} }, ... }
            if (appData.students) {
                Object.keys(appData.students).forEach(className => {
                    const classObj = appData.students[className];
                    if (classObj) {
                        Object.keys(classObj).forEach(key => {
                            const student = classObj[key];
                            const fullName = `${student.nom} ${student.prenom} ${student.classe}`.toLowerCase();

                            // Check if ALL terms are present
                            const isMatch = terms.every(term => fullName.includes(term));

                            if (isMatch) {
                                matches.push({
                                    student: student,
                                    key: key,
                                    // Calculate match 'score' (starts with first term > contains)
                                    score: fullName.startsWith(terms[0]) ? 2 : 1
                                });
                            }
                        });
                    }
                });
            }

            // Sort matches
            matches.sort((a, b) => b.score - a.score || a.student.nom.localeCompare(b.student.nom));

            // Update count
            if (document.getElementById('searchCountDisplay')) {
                document.getElementById('searchCountDisplay').textContent = `(${matches.length} résultats)`;
            }

            // Render
            if (matches.length === 0) {
                resultsContainer.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">Aucun élève trouvé.</div>';
                return;
            }

            let html = '';
            matches.forEach(m => {
                const s = m.student;
                html += `
                    <div class="search-result-item" onclick="openStudentFromSearch('${m.key}')">
                        <div>
                            <span style="font-weight:bold; color:var(--primary-color); font-size:1.1rem;">${s.nom.toUpperCase()}</span>
                            <span style="font-weight:bold; color:#fff; font-size:1.1rem;">${s.prenom}</span>
                        </div>
                        <div style="background:#444; padding:4px 8px; border-radius:4px; font-size:0.9rem; color:#ccc;">
                            ${s.classe}
                        </div>
                    </div>
                `;
            });
            resultsContainer.innerHTML = html;
        }

        function printSearchResults(containerId, title, query) {
            const content = document.getElementById(containerId).innerHTML;
            const countText = document.getElementById('searchCountDisplay') ? document.getElementById('searchCountDisplay').textContent : '';

            const w = window.open('', '_blank', 'width=800,height=900');
            w.document.write(`
                <html><head><title>Recherche: ${query}</title>
                <style>
                    body{font-family:Arial,sans-serif;padding:20px;color:#000}
                    .search-result-item{padding:10px;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;}
                    h1{border-bottom:2px solid #000;padding-bottom:10px;}
                </style>
                </head><body>
                <h1>${title} <span style="font-size:0.6em;font-weight:normal;">${countText}</span></h1>
                <p>Recherche: "<strong>${query}</strong>"</p>
                ${content}
                </body></html>
            `);
            w.document.close();
            w.focus();
            setTimeout(() => w.print(), 300);
        }

        function openStudentFromSearch(key) {
            let foundStudent = null;
            if (appData.students) {
                for (const cls in appData.students) {
                    if (appData.students[cls][key]) {
                        foundStudent = appData.students[cls][key];
                        break;
                    }
                }
            }

            if (foundStudent) {
                // Determine source logic to restore search later
                const keywordModal = document.getElementById('keywordSearchModal');
                if (keywordModal && keywordModal.style.display !== 'none') {
                    window.lastOriginSearch = 'keyword';
                    keywordModal.style.display = 'none';
                } else {
                    window.lastOriginSearch = null;
                }

                // Close other modals if needed...
                const studentModal = document.getElementById('studentSearchModal');
                if (studentModal) studentModal.style.display = 'none';
                const searchHub = document.getElementById('searchHubModal');
                if (searchHub) searchHub.style.display = 'none';
                const entryCountModal = document.getElementById('entryCountSearchModal');
                if (entryCountModal) entryCountModal.style.display = 'none';

                // Open sheet
                openStudentSheet(foundStudent, null);
            } else {
                alert("Erreur: Impossible de charger la fiche de cet élève.");
            }
        }

        // --- SEARCH BY CLASSE ---

        function openClassSearch() {
            let modal = document.getElementById('classSearchModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'classSearchModal';
                modal.className = 'modal';
                modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:25000; display:flex; align-items:center; justify-content:center;';

                modal.innerHTML = `
                    <div class="modal-content" style="width:400px; max-height:80vh; display:flex; flex-direction:column; padding:0; background:#222; border:2px solid var(--primary-color);">
                        <div style="padding:15px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
                            <h2 style="margin:0; color:#fff;">Choisir une Classe</h2>
                            <button onclick="document.getElementById('classSearchModal').style.display='none'" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
                        </div>
                        <div id="classSearchResults" style="flex:1; overflow-y:auto; padding:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <!-- Classes here -->
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            const container = document.getElementById('classSearchResults');
            container.innerHTML = '';

            // Get classes from appData
            const classes = Object.keys(appData.classes || {}).sort();
            if (classes.length === 0) {
                container.innerHTML = '<p style="color:#aaa; grid-column:span 2; text-align:center;">Aucune classe disponible.</p>';
            } else {
                classes.forEach(cls => {
                    const btn = document.createElement('button');
                    btn.style.cssText = 'padding:15px; background:#333; color:#fff; border:1px solid #444; border-radius:4px; cursor:pointer; font-weight:bold; transition:all 0.2s;';
                    btn.textContent = cls;
                    btn.onmouseover = () => btn.style.background = 'var(--primary-color)';
                    btn.onmouseout = () => btn.style.background = '#333';
                    btn.onclick = () => {
                        showClassStudents(cls);
                        document.getElementById('classSearchModal').style.display = 'none';
                        // Switch sidebar to students to see the result
                        switchSidebarTab('students');
                    };
                    container.appendChild(btn);
                });
            }

            modal.style.display = 'flex';
        }

        // --- SEARCH BY KEYWORD ---

        function openKeywordSearch() {
            let modal = document.getElementById('keywordSearchModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'keywordSearchModal';
                modal.className = 'modal';
                modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:25000; display:flex; align-items:center; justify-content:center;';

                modal.innerHTML = `
                    <div class="modal-content" style="width:80%; min-width:600px; max-height:85vh; display:flex; flex-direction:column; padding:0; background:#222; border:2px solid var(--primary-color);">
                        <div style="padding:15px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
                            <h2 style="margin:0; color:#fff;">Recherche par Mot Clé</h2>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button onclick="printSearchResults('keywordSearchResults', 'Résultats de recherche par Mots Clés', document.getElementById('keywordSearchInput').value)" style="padding:5px 10px; background:#4CAF50; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">🖨️ Imprimer</button>
                                <button onclick="document.getElementById('keywordSearchModal').style.display='none'" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
                            </div>
                        </div>
                        <div style="padding:15px;">
                            <p style="color:#aaa; font-size:0.85rem; margin-top:0;">Recherche dans : PAI, Projets, Options, Rubriques, Notes péda...</p>
                            <input type="text" id="keywordSearchInput" placeholder="Saisissez un mot clé (ex: dys, allergie, comportement)..." style="width:100%; padding:12px; box-sizing:border-box; border-radius:4px; border:1px solid #555; background:#333; color:#fff; font-size:1.1rem;">
                        </div>
                        <div id="keywordSearchResults" style="flex:1; overflow-y:auto; padding:0; max-height:400px;">
                            <!-- Results here -->
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                const input = document.getElementById('keywordSearchInput');
                input.addEventListener('input', (e) => performKeywordSearch(e.target.value));
            }

            document.getElementById('keywordSearchInput').value = '';
            document.getElementById('keywordSearchResults').innerHTML = '<div style="padding:20px; color:#666; text-align:center;">En attente de saisie...</div>';
            modal.style.display = 'flex';
            setTimeout(() => document.getElementById('keywordSearchInput').focus(), 100);
        }

        function performKeywordSearch(query) {
            const resultsContainer = document.getElementById('keywordSearchResults');

            // Split by spaces, filter empty, take max 3 terms
            const terms = (query || '').toLowerCase().split(/\s+/).filter(t => t.length > 1).slice(0, 3);

            if (terms.length === 0) {
                resultsContainer.innerHTML = '';
                return;
            }

            let candidateKeys = null; // Will hold the intersection of matches
            const matchDetails = {}; // Stores description of match for all encountered keys

            // Helper to record a match
            const recordMatch = (key, reason, termMatchesSet) => {
                termMatchesSet.add(key);
                if (!matchDetails[key]) matchDetails[key] = new Set();
                matchDetails[key].add(reason);
            };

            // Iterate over each term to find matches
            terms.forEach(term => {
                const termMatches = new Set();

                // 1. Search in Student Info (Projet, Allergies, Options, Groupes)
                if (appData.students) {
                    Object.keys(appData.students).forEach(cls => {
                        const classObj = appData.students[cls];
                        Object.keys(classObj).forEach(key => {
                            const s = classObj[key];
                            if ((s.projet && s.projet.toLowerCase().includes(term))) recordMatch(key, `Projet (${term})`, termMatches);
                            if ((s.allergies && s.allergies.toLowerCase().includes(term))) recordMatch(key, `Allergies/PAI (${term})`, termMatches);
                            if ((s.options && s.options.toLowerCase().includes(term))) recordMatch(key, `Options (${term})`, termMatches);
                            if ((s.groupes && s.groupes.toLowerCase().includes(term))) recordMatch(key, `Groupes (${term})`, termMatches);
                            if ((s.engagement && s.engagement.toLowerCase().includes(term))) recordMatch(key, `Engagement (${term})`, termMatches);
                        });
                    });
                }

                // 2. Search in Custom Rubrics (Name and Content)
                if (appData.customRubriques) {
                    Object.keys(appData.customRubriques).forEach(key => {
                        const rubrics = appData.customRubriques[key];
                        if (Array.isArray(rubrics)) {
                            rubrics.forEach(r => {
                                if ((r.name && r.name.toLowerCase().includes(term)) || (r.content && r.content.toLowerCase().includes(term))) {
                                    recordMatch(key, `Rubrique: ${r.name} (${term})`, termMatches);
                                }
                            });
                        }
                    });
                }

                // 3. Search in weekly notes (Runtime)
                if (studentWeeklyData) {
                    Object.keys(studentWeeklyData).forEach(key => {
                        const data = studentWeeklyData[key];
                        if (data && data.notes && data.notes.toLowerCase().includes(term)) {
                            const studentKey = key.substring(0, key.lastIndexOf('_w'));
                            recordMatch(studentKey, `Notes Hebdo (${term})`, termMatches);
                        }
                    });
                }

                // 4. Search in Weekly Reports (Persistence - fallback/redundancy)
                if (appData.weeklyReports) {
                    Object.keys(appData.weeklyReports).forEach(repKey => {
                        const report = appData.weeklyReports[repKey];
                        if (report.notes && report.notes.toLowerCase().includes(term)) {
                            const lastWIndex = repKey.lastIndexOf('_w');
                            if (lastWIndex > 0) {
                                const studentKey = repKey.substring(0, lastWIndex);
                                recordMatch(studentKey, `Notes Hebdo (${term})`, termMatches);
                            }
                        }
                    });
                }

                // Intersection Logic
                if (candidateKeys === null) {
                    candidateKeys = termMatches;
                } else {
                    // Keep only keys present in both candidateKeys and termMatches
                    candidateKeys = new Set([...candidateKeys].filter(x => termMatches.has(x)));
                }
            });

            // Render
            if (!candidateKeys || candidateKeys.size === 0) {
                resultsContainer.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">Aucun résultat trouvé pour ces mots-clés combinés.</div>';
                return;
            }

            let html = '';
            // We need to resolve student object from key to display name
            candidateKeys.forEach(key => {
                let studentObj = null;
                // Find student obj
                findLoop: for (const cls in appData.students) {
                    if (appData.students[cls][key]) {
                        studentObj = appData.students[cls][key];
                        break findLoop;
                    }
                }

                if (studentObj) {
                    const reasons = Array.from(matchDetails[key]).join(', ');
                    html += `
                        <div class="search-result-item" onclick="openStudentFromSearch('${key}')">
                            <div style="flex:1;">
                                <div style="display:flex; justify-content:space-between;">
                                    <span>
                                        <span style="font-weight:bold; color:var(--primary-color); font-size:1.05rem;">${studentObj.nom.toUpperCase()}</span>
                                        <span style="font-weight:bold; color:#fff; font-size:1.05rem;">${studentObj.prenom}</span>
                                    </span>
                                    <span style="font-size:0.8rem; color:#888; background:#222; padding:2px 6px; border-radius:3px;">${studentObj.classe}</span>
                                </div>
                                <div style="font-size:0.85rem; color:#aaa; margin-top:4px;">
                                    Trouvé dans : <span style="color:#FF9800;">${reasons}</span>
                                </div>
                            </div>
                            <div style="margin-left:10px; font-size:1.2rem;">👉</div>
                        </div>
                    `;
                }
            });
            resultsContainer.innerHTML = html;
        }

        function printStudentAnnualSummaryFromSheet() {
            const studentJson = document.getElementById('sheet-student-json').value;
            if (!studentJson) return;
            const student = JSON.parse(studentJson);
            const key = `${student.classe}_${student.nom}_${student.prenom}`;

            printAnnualSummary({
                type: 'student',
                className: student.classe,
                studentKey: key
            });
        }

        // --- SEARCH BY ENTRY COUNT ---

        function getAllStudentEntryCounts() {
            const countsByKey = {};

            // 1. Runtime Data
            if (typeof studentWeeklyData !== 'undefined') {
                Object.keys(studentWeeklyData).forEach(key => {
                    const data = studentWeeklyData[key];
                    if (data && ((data.notes && data.notes.trim().length > 0) || (data.status && data.status.length > 0))) {
                        const lastW = key.lastIndexOf('_w');
                        if (lastW > 0) {
                            const sKey = key.substring(0, lastW);
                            const weekId = key.substring(lastW + 2);
                            if (!countsByKey[sKey]) countsByKey[sKey] = new Set();
                            countsByKey[sKey].add(weekId);
                        }
                    }
                });
            }

            // 2. Persistence Data (if available)
            if (typeof appData !== 'undefined' && appData.weeklyReports) {
                Object.keys(appData.weeklyReports).forEach(key => {
                    const data = appData.weeklyReports[key];
                    if (data && ((data.notes && data.notes.trim().length > 0) || (data.status && data.status.length > 0))) {
                        const lastW = key.lastIndexOf('_w');
                        if (lastW > 0) {
                            const sKey = key.substring(0, lastW);
                            const weekId = key.substring(lastW + 2);
                            if (!countsByKey[sKey]) countsByKey[sKey] = new Set();
                            countsByKey[sKey].add(weekId);
                        }
                    }
                });
            }

            const leaderboard = [];
            Object.keys(countsByKey).forEach(sKey => {
                const count = countsByKey[sKey].size;
                if (count > 0) {
                    let studentObj = null;
                    if (appData.students) {
                        for (const cls in appData.students) {
                            if (appData.students[cls][sKey]) {
                                studentObj = appData.students[cls][sKey];
                                break;
                            }
                        }
                    }

                    if (studentObj) {
                        leaderboard.push({
                            key: sKey,
                            student: studentObj,
                            count: count
                        });
                    }
                }
            });

            // Sort descending
            leaderboard.sort((a, b) => b.count - a.count);
            return leaderboard;
        }

        function openEntryCountSearch() {
            let modal = document.getElementById('entryCountSearchModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'entryCountSearchModal';
                modal.className = 'modal';
                modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:25000; display:flex; align-items:center; justify-content:center;';

                modal.innerHTML = `
                    <div class="modal-content" style="width:80%; min-width:600px; max-height:85vh; display:flex; flex-direction:column; padding:0; background:#222; border:2px solid var(--primary-color);">
                        <div style="padding:15px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
                            <h2 style="margin:0; color:#fff;">Classement par nombre de saisies</h2>
                            <button onclick="document.getElementById('entryCountSearchModal').style.display='none'" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
                        </div>
                        
                        <!-- TABS -->
                        <div style="display:flex; background:#333; border-bottom:1px solid #444;">
                            <button onclick="switchEntryCountTab('tab-student')" class="ec-tab-btn active" id="btn-tab-student" style="flex:1; padding:15px; background:#444; color:#fff; border:none; cursor:pointer; font-weight:bold; border-right:1px solid #555;">Par Élève</button>
                            <button onclick="switchEntryCountTab('tab-class')" class="ec-tab-btn" id="btn-tab-class" style="flex:1; padding:15px; background:#222; color:#aaa; border:none; cursor:pointer; font-weight:bold; border-right:1px solid #555;">Par Classe</button>
                            <button onclick="switchEntryCountTab('tab-all')" class="ec-tab-btn" id="btn-tab-all" style="flex:1; padding:15px; background:#222; color:#aaa; border:none; cursor:pointer; font-weight:bold;">Toutes les classes</button>
                        </div>

                        <!-- CONTENT: PAR ÉLÈVE -->
                        <div id="tab-student" class="ec-tab-content" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                            <div style="padding:15px; display:flex; gap:10px;">
                                <input type="text" id="ecStudentInput" placeholder="Nom de l'élève..." oninput="performEntryCountStudentSearch(this.value)" style="flex:1; padding:10px; border-radius:4px; border:1px solid #555; background:#333; color:#fff;">
                                <button onclick="printSearchResults('ecStudentResults', 'Saisies par Élève', document.getElementById('ecStudentInput').value)" style="padding:5px 15px; background:#4CAF50; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">🖨️ Imprimer</button>
                            </div>
                            <div id="ecStudentResults" style="flex:1; overflow-y:auto; padding:0;"></div>
                        </div>

                        <!-- CONTENT: PAR CLASSE -->
                        <div id="tab-class" class="ec-tab-content" style="display:none; flex-direction:column; flex:1; overflow:hidden;">
                            <div style="padding:15px; display:flex; gap:10px;">
                                <select id="ecClassSelect" onchange="performEntryCountClassSearch(this.value)" style="flex:1; padding:10px; border-radius:4px; border:1px solid #555; background:#333; color:#fff;">
                                    <option value="">Sélectionner une classe...</option>
                                </select>
                                <button onclick="printSearchResults('ecClassResults', 'Saisies par Classe', document.getElementById('ecClassSelect').value)" style="padding:5px 15px; background:#4CAF50; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">🖨️ Imprimer</button>
                            </div>
                            <div id="ecClassResults" style="flex:1; overflow-y:auto; padding:0;"></div>
                        </div>

                        <!-- CONTENT: TOUTES LES CLASSES -->
                        <div id="tab-all" class="ec-tab-content" style="display:none; flex-direction:column; flex:1; overflow:hidden;">
                            <div style="padding:15px; text-align:right;">
                                <button onclick="printSearchResults('ecAllResults', 'Classement Global Saisies', 'Toutes les classes')" style="padding:5px 15px; background:#4CAF50; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">🖨️ Imprimer</button>
                            </div>
                            <div id="ecAllResults" style="flex:1; overflow-y:auto; padding:0;"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            modal.style.display = 'flex';

            // Populate Classes
            const classSelect = document.getElementById('ecClassSelect');
            classSelect.innerHTML = '<option value="">Sélectionner une classe...</option>';
            if (appData.students) {
                Object.keys(appData.students).sort().forEach(cls => {
                    const opt = document.createElement('option');
                    opt.value = cls;
                    opt.textContent = cls;
                    classSelect.appendChild(opt);
                });
            }

            // Default Tab
            switchEntryCountTab('tab-student');
        }

        function switchEntryCountTab(tabId) {
            document.querySelectorAll('.ec-tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.ec-tab-btn').forEach(el => {
                el.style.background = '#222';
                el.style.color = '#aaa';
                el.classList.remove('active');
            });

            document.getElementById(tabId).style.display = 'flex';
            const btnId = 'btn-' + tabId;
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.style.background = '#444';
                btn.style.color = '#fff';
                btn.classList.add('active');
            }

            if (tabId === 'tab-all') {
                performEntryCountAllSearch();
            }
        }

        function renderEntryCountList(containerId, list) {
            const container = document.getElementById(containerId);
            if (list.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">Aucun résultat.</div>';
                return;
            }

            let html = '';
            list.forEach((item, index) => {
                let rankColor = '#444';
                if (index === 0) rankColor = '#FFD700';
                if (index === 1) rankColor = '#C0C0C0';
                if (index === 2) rankColor = '#CD7F32';

                html += `
                    <div class="search-result-item" onclick="openStudentFromSearch('${item.key}')" style="display:flex; align-items:center; padding:10px; border-bottom:1px solid #333; cursor:pointer;">
                        <div style="font-size:1.5rem; font-weight:bold; width:40px; text-align:center; color:${rankColor}; margin-right:10px;">
                            ${index + 1}
                        </div>
                        <div style="flex:1;">
                            <div>
                                <span style="font-weight:bold; color:var(--primary-color); font-size:1.1rem;">${item.student.nom.toUpperCase()}</span>
                                <span style="font-weight:bold; color:#fff; font-size:1.1rem;">${item.student.prenom}</span>
                            </div>
                            <div style="font-size:0.85rem; color:#aaa;">${item.student.classe}</div>
                        </div>
                        <div style="background:var(--primary-color); color:#000; padding:5px 10px; border-radius:15px; font-weight:bold;">
                            ${item.count} saisies
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function performEntryCountAllSearch() {
            const container = document.getElementById('ecAllResults');
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">Calcul en cours...</div>';
            setTimeout(() => {
                const all = getAllStudentEntryCounts();
                renderEntryCountList('ecAllResults', all);
            }, 50);
        }

        function performEntryCountClassSearch(className) {
            if (!className) return;
            const container = document.getElementById('ecClassResults');
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">Calcul en cours...</div>';
            setTimeout(() => {
                const all = getAllStudentEntryCounts();
                const filtered = all.filter(item => item.student.classe === className);
                renderEntryCountList('ecClassResults', filtered);
            }, 50);
        }

        function performEntryCountStudentSearch(query) {
            const container = document.getElementById('ecStudentResults');
            if (!query || query.trim().length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">Commencez à taper un nom...</div>';
                return;
            }

            const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 0);
            if (terms.length === 0) return;

            setTimeout(() => {
                const all = getAllStudentEntryCounts();
                const filtered = all.filter(item => {
                    const fullName = (item.student.nom + ' ' + item.student.prenom).toLowerCase();
                    return terms.every(term => fullName.includes(term));
                });
                renderEntryCountList('ecStudentResults', filtered);
            }, 50);
        }

        // ===== STATISTIQUES =====
        let currentStatsRange = 'all';
        let currentStatsLevel = 'all';
        let currentStatsClassLevel = 'all';
        let currentStatsStudentLevel = 'all';
        let currentStatsStudentLimit = 10;
        let currentStatsColorLimit = 9999;
        let currentStatsColorLevel = 'all';
        let currentStatsRubricLimit = 10;
        let currentStatsMotifLimit = 10;
        let currentMotifSearchQuery = "";

        function toggleStatsFullScreen() {
            const modal = document.querySelector('#statisticsModal .modal-content');
            if (document.fullscreenElement) {
                document.exitFullscreen();
                modal.classList.remove('fullscreen-mode');
                // Hide FS close button
                const btn = document.getElementById('fsCloseBtn');
                if (btn) btn.style.display = 'none';
            } else {
                modal.requestFullscreen().catch(err => {
                    alert(`Erreur plein écran: ${err.message}`);
                });
                modal.classList.add('fullscreen-mode');
                // Show FS close button
                const btn = document.getElementById('fsCloseBtn');
                if (btn) btn.style.display = 'block';
            }
        }

        // Helper to open student from stats
        window.openStatsStudent = function (nameWithClass) {
            let fullName = nameWithClass;
            let className = null;
            // Attempt to parse Name (Class)
            const m = nameWithClass.match(/(.*?)\s*\(([^)]+)\)$/);
            if (m) {
                fullName = m[1].trim();
                className = m[2].trim();
            } else {
                fullName = nameWithClass.trim();
            }

            let foundKey = null;
            let foundClass = null;

            // Search helper
            const searchInClass = (cls) => {
                if (!appData.students || !appData.students[cls]) return null;
                return Object.keys(appData.students[cls]).find(k => {
                    const s = appData.students[cls][k];
                    const sFull = (s.nom + ' ' + s.prenom).toLowerCase();
                    return sFull === fullName.toLowerCase() || k === fullName.replace(/ /g, '_');
                });
            };

            // 1. Search in parsed class if available
            if (className) {
                foundKey = searchInClass(className);
                if (foundKey) foundClass = className;
            }

            // 2. Fallback: Search in all classes
            if (!foundKey && appData.students) {
                for (const cls of Object.keys(appData.students)) {
                    foundKey = searchInClass(cls);
                    if (foundKey) {
                        foundClass = cls;
                        break;
                    }
                }
            }

            if (foundKey && foundClass) {
                // Set flag to return to stats on close and handle fullscreen
                window.returnToStats = true;
                window.wasStatsFullscreen = !!document.fullscreenElement;
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => console.error("Exit FS failed", err));
                }
                openStudentSheet(appData.students[foundClass][foundKey], 'student-' + foundKey);
            } else {
                // Try to be more helpful
                if (className) {
                    alert("Élève introuvable: " + fullName + " dans la classe " + className);
                } else {
                    alert("Élève introuvable: " + fullName);
                }
            }
        }

        window.openStatsStudentFromKey = function (key) {
            const parts = key.split('_');
            const cls = parts[0];
            if (parts.length >= 3) {
                const studentKey = parts.slice(1, parts.length - 1).join('_');
                if (appData.students && appData.students[cls] && appData.students[cls][studentKey]) {
                    // Set flag to return to stats on close and handle fullscreen
                    window.returnToStats = true;
                    window.wasStatsFullscreen = !!document.fullscreenElement;
                    if (document.fullscreenElement) {
                        document.exitFullscreen().catch(err => console.error("Exit FS failed", err));
                    }

                    openStudentSheet(appData.students[cls][studentKey], 'student-' + studentKey);
                    return;
                }
            }
            alert("Impossible d'ouvrir la fiche pour la clé: " + key);
        }

        // Listen for fullscreen change to remove class if exited via ESC
        document.addEventListener('fullscreenchange', () => {
            const modal = document.querySelector('#statisticsModal .modal-content');
            const btn = document.getElementById('fsCloseBtn');
            if (!document.fullscreenElement) {
                modal.classList.remove('fullscreen-mode');
                if (btn) btn.style.display = 'none';
            } else {
                if (btn) btn.style.display = 'block';
            }
        });

        function printStats() {
            const content = document.getElementById('statsContent').innerHTML;
            const title = "Tableau de Bord - Statistiques";

            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; color: black; background: white; }
                        h3 { border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-top: 20px; color: black !important; }
                        .stats-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; background: white !important; box-shadow: none !important; }
                        ul { list-style: none; padding: 0; }
                        li { padding: 5px 0; border-bottom: 1px solid #eee; color: black !important; }
                        div { color: black !important; }
                        /* Chart Bars */
                        .bar-bg { background: #eee !important; border: 1px solid #ccc; }
                        .bar-fill { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    </style>
                </head>
                <body>
                    <h1>${title} - ${new Date().toLocaleDateString()}</h1>
                    ${content}
                    <script>
                        // Clean up styles for print
                        document.querySelectorAll('*').forEach(el => {
                           if(el.style.backgroundColor && el.style.backgroundColor !== 'transparent' && !el.style.width) {
                               // Keep bar colors (width set), clear backgrounds of cards
                               if(!el.innerHTML.includes('width:')) el.style.backgroundColor = 'white';
                           }
                           // If it has text content
                           if(el.childNodes.length === 1 && el.childNodes[0].nodeType === 3) {
                               el.style.color = 'black';
                           }
                           // Background of bars
                           if(el.style.background === 'rgb(51, 51, 51)' || el.style.background === '#333') {
                               el.style.background = '#eee';
                               el.style.border = '1px solid #ccc';
                           }
                        });
                        setTimeout(() => { window.print(); window.close(); }, 500);
                    <\/script>
                </body>
                </html>
            `);
            w.document.close();
        }

        function toggleGraphView() {
            const container = document.getElementById('graph-container');
            if (!container) return;
            if (container.style.display === 'none') {
                container.style.display = 'block';
                setTimeout(drawCharts, 100);
            } else {
                container.style.display = 'none';
            }
        }

        function drawCharts() {
            if (!window.lastStats) return;

            const source = document.getElementById('graphSource').value;
            const type = document.getElementById('graphType').value;
            const canvasId = 'mainChart';

            let data = [];

            // PREPARE DATA
            if (source === 'status') {
                data = [
                    { label: 'Présent', value: window.lastStats.RDV_present, color: '#4CAF50' },
                    { label: 'Absent/Annulé', value: window.lastStats.RDV_absent, color: '#F44336' },
                    { label: 'En Attente', value: (window.lastStats.total_evenements - window.lastStats.RDV_present - window.lastStats.RDV_absent - window.lastStats.total_saisies_specifiques), color: '#FF9800' }
                ];
            } else if (source === 'population') {
                if (window.lastStats.population) {
                    const p = window.lastStats.population;
                    // Nouvelle logique couleur population
                    data = [
                        { label: '0 RDV', value: p.s0.count, color: '#607D8B' },
                        { label: '1 RDV', value: p.s1.count, color: '#2196F3' },
                        { label: '2 RDV', value: p.s2.count, color: '#9C27B0' },
                        { label: '3 RDV', value: p.s3.count, color: '#FF9800' },
                        { label: '4-6 RDV', value: p.s4_6.count, color: '#F44336' },
                        { label: '7+ RDV', value: p.s7_plus.count, color: '#000' },
                    ];
                }
            } else if (source === 'motifs') {
                const motifs = window.lastStats.motifs || {};
                data = Object.entries(motifs)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .map((m, i) => ({
                        label: m[0],
                        value: m[1],
                        color: `hsl(${i * 36 + 180}, 70%, 50%)`
                    }));
            } else if (source === 'rubrics') {
                const rubrics = window.lastStats.rubricCounts || {};
                data = Object.entries(rubrics)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 10)
                    .map((r, i) => ({
                        label: r[0],
                        value: r[1].count,
                        color: `hsl(${i * 36}, 70%, 60%)`
                    }));
            } else if (source === 'colors') {
                const colors = window.lastStats.studentColorAgg || {};
                // Sum by color
                let sums = { rouge: 0, orange: 0, jaune: 0, vert: 0, vert_fonce: 0 };
                Object.values(colors).forEach(c => {
                    sums.rouge += c.rouge;
                    sums.orange += c.orange;
                    sums.jaune += c.jaune;
                    sums.vert += c.vert;
                    sums.vert_fonce += c.vert_fonce;
                });
                data = [
                    { label: 'Rouge', value: sums.rouge, color: '#F44336' },
                    { label: 'Orange', value: sums.orange, color: '#FF9800' },
                    { label: 'Jaune', value: sums.jaune, color: '#FFEB3B' },
                    { label: 'Vert', value: sums.vert, color: '#4CAF50' },
                    { label: 'Vert Foncé', value: sums.vert_fonce, color: '#1B5E20' },
                ];
            } else if (source === 'rdv_week') {
                const weeks = window.lastStats.rdvWeekStats || {};
                const keys = Object.keys(weeks).sort((a, b) => {
                    const an = parseInt(a.replace(/\D/g, '')) || 0;
                    const bn = parseInt(b.replace(/\D/g, '')) || 0;
                    return an - bn;
                });
                data = keys.map((k, i) => ({
                    label: k,
                    value: weeks[k].total,
                    color: '#00bcd4'
                }));
            }

            // DRAW
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            // Resize canvas to container
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear

            if (data.length === 0 || data.every(d => d.value === 0)) {
                ctx.fillStyle = '#888';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText("Aucune donnée disponible", canvas.width / 2, canvas.height / 2);
                return;
            }

            if (type === 'pie' || type === 'doughnut') {
                drawPieChart(canvasId, data, type === 'doughnut');
            } else {
                drawBarChart(canvasId, data);
            }
        }

        function drawBarChart(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 50;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;

            const maxValue = Math.max(...data.map(d => d.value)) || 1;
            const barWidth = chartWidth / data.length;

            // Axis Lines
            ctx.beginPath();
            ctx.strokeStyle = '#555';
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            data.forEach((d, i) => {
                const barHeight = (d.value / maxValue) * chartHeight;
                const x = padding + i * barWidth + (barWidth * 0.1);
                const y = height - padding - barHeight;
                const w = barWidth * 0.8;

                // Bar
                ctx.fillStyle = d.color;
                ctx.fillRect(x, y, w, barHeight);

                // Value
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                if (barWidth > 20) {
                    ctx.fillText(d.value, x + w / 2, y - 5);
                }

                // Label
                ctx.fillStyle = '#aaa';
                ctx.font = '10px Arial';
                if (barWidth > 15) {
                    let label = d.label;
                    if (label.length > 8 && barWidth < 60) label = label.substring(0, 6) + '..';
                    ctx.fillText(label, x + w / 2, height - padding + 15);
                }
            });
        }

        function drawPieChart(canvasId, data, isDoughnut = false) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 - 20;

            let total = data.reduce((acc, val) => acc + val.value, 0);

            if (total === 0) return;

            let startAngle = 0;

            data.forEach(slice => {
                if (slice.value <= 0) return;
                const sliceAngle = (slice.value / total) * 2 * Math.PI;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.fillStyle = slice.color;
                ctx.fill();

                startAngle += sliceAngle;
            });

            // Doughnut hole
            if (isDoughnut) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(0,0,0,0.8)'; // Match modal background approx
                ctx.fill();
            }

            // Labels
            startAngle = 0;
            data.forEach(slice => {
                if (slice.value <= 0) return;
                const sliceAngle = (slice.value / total) * 2 * Math.PI;
                const midAngle = startAngle + sliceAngle / 2;
                // Move label further out or in depending on doughnut
                const labelRadius = isDoughnut ? radius * 0.75 : radius * 0.7;
                const labelX = centerX + labelRadius * Math.cos(midAngle);
                const labelY = centerY + labelRadius * Math.sin(midAngle);

                if (slice.value / total > 0.05) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const pct = Math.round(slice.value / total * 100) + '%';
                    ctx.fillText(pct, labelX, labelY);
                }
                startAngle += sliceAngle;
            });


            // Legend
            let lgdY = height - 20;
            const boxSize = 10;
            let currentX = 10;

            data.forEach(slice => {
                ctx.fillStyle = slice.color;
                ctx.fillRect(currentX, lgdY - boxSize, boxSize, boxSize);
                ctx.fillStyle = '#ccc';
                ctx.textAlign = 'left';
                ctx.fillText(slice.label, currentX + 15, lgdY);
                currentX += ctx.measureText(slice.label).width + 25;
            });
        }

        function createStatBox(value, label, color) {
            return `
                <div style="background:#222; border-left: 4px solid ${color}; padding: 15px; border-radius: 5px;">
                    <div style="font-size: 2rem; font-weight: bold; color: white;">${value}</div>
                    <div style="color: #bbb; font-size: 0.9rem;">${label}</div>
                </div>
            `;
        }

        function createBar(label, value, total, color, customLabel = null, onclick = null) {
            const pct = total > 0 ? Math.round((value / total) * 100) : 0;
            const displayLabel = customLabel || `${value} (${pct}%)`;
            const cursor = onclick ? 'pointer' : 'default';
            const clickAttr = onclick ? `onclick="${onclick}"` : '';
            const hoverStyle = onclick ? 'onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1"' : '';

            return `
                <div style="margin-bottom: 12px; cursor:${cursor};" ${clickAttr} ${hoverStyle}>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem; color:#ccc;">
                        <span>${label}</span>
                        <span>${displayLabel}</span>
                    </div>
                    <div style="background:#333; height:8px; border-radius:4px; overflow:hidden;">
                        <div style="background:${color}; width:${pct}%; height:100%;"></div>
                    </div>
                </div>
            `;
        }

        // --- STATS CALENDAR LOGIC ---
        function renderStatsCalendar() {
            const monthContainer = document.getElementById('statsCalendarMonths');
            const stripContainer = document.getElementById('statsCalendarStrip');
            if (!monthContainer || !stripContainer) return;

            monthContainer.innerHTML = '';
            stripContainer.innerHTML = '';

            // 1. Months
            CALENDAR_DATA.months.forEach(m => {
                const mLabel = document.createElement('div');
                mLabel.className = 'month-label';
                mLabel.textContent = m.name;
                mLabel.style.flex = m.flex;
                monthContainer.appendChild(mLabel);
            });

            // 2. Weeks
            CALENDAR_DATA.weeks.forEach((w, index) => {
                const btn = document.createElement('div');
                btn.className = 'week-btn';
                btn.style.minWidth = '30px';
                btn.style.textAlign = 'center';
                btn.style.cursor = 'pointer';

                let display = w;
                if (w === 'F') {
                    btn.classList.add('holiday');
                    display = 'F';
                }

                btn.textContent = display;
                btn.onclick = () => selectStatsCalendarWeek(index);
                stripContainer.appendChild(btn);
            });
        }

        function selectStatsCalendarWeek(index) {
            if (index < 0 || index >= CALENDAR_DATA.weeks.length) return;

            highlightStatsCalendarWeek(index);

            const schoolStart = new Date(2025, 8, 1);
            const targetDate = new Date(schoolStart);
            targetDate.setDate(schoolStart.getDate() + (index * 7));

            // Normalize to Monday
            const day = targetDate.getDay() || 7;
            if (day !== 1) targetDate.setDate(targetDate.getDate() - (day - 1));

            currentStatsDate = targetDate;
            setStatsRange('week');
        }

        function highlightStatsCalendarWeek(index) {
            const strip = document.getElementById('statsCalendarStrip');
            if (!strip) return;
            const buttons = strip.children;
            for (let i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            if (buttons[index]) {
                buttons[index].classList.add('active');
                buttons[index].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function openStatisticsModal() {
            const modal = document.getElementById('statisticsModal');
            modal.style.display = 'flex';

            // Auto Fullscreen
            if (!document.querySelector('#statisticsModal .modal-content').classList.contains('fullscreen-mode')) {
                toggleStatsFullScreen();
            }

            // Render Calendar
            renderStatsCalendar();

            // Default to current date-based week
            const schoolStart = new Date(2025, 8, 1);
            const now = new Date();
            let diffDays = Math.floor((now - schoolStart) / (1000 * 60 * 60 * 24));
            let weekIndex = Math.floor(diffDays / 7);

            if (weekIndex < 0) weekIndex = 0;
            if (weekIndex >= CALENDAR_DATA.weeks.length) weekIndex = CALENDAR_DATA.weeks.length - 1;

            selectStatsCalendarWeek(weekIndex);

            // Populate Levels dynamically based on appData
            updateStatsLevelOptions();

            currentStatsLevel = 'all';
            currentStatsClassLevel = 'all';
        }

        function updateStatsLevelOptions() {
            // Extract unique levels from imported classes in appData.students
            if (!appData.students) return;

            const classes = Object.keys(appData.students);
            const levels = new Set();
            classes.forEach(c => {
                const upperC = c.toUpperCase();
                if (upperC.startsWith('1ERE') || upperC.startsWith('1ÈRE')) {
                    levels.add('Premiere');
                } else if (upperC.startsWith('2EME') || upperC.startsWith('2NDE') || upperC.startsWith('SECONDE')) {
                    levels.add('Seconde');
                } else if (upperC.startsWith('T')) {
                    levels.add('Terminal');
                } else {
                    const match = c.match(/^(\d+)/); // Match leading number (e.g. 6 from 6A)
                    if (match) {
                        levels.add(match[1]);
                    } else {
                        // Fallback for names like "Terminale", "Seconde"
                        // Take first word if it looks like a level
                        const firstWord = c.split(' ')[0];
                        if (firstWord.length > 0) levels.add(firstWord);
                    }
                }
            });

            // If no levels found, keep defaults or clear
            if (levels.size === 0) return;

            const sortedLevels = Array.from(levels).sort(); // Sort alphanumerically

            // Function to generate options HTML
            const generateOptions = (currentVal) => {
                let html = '<option value="all" ' + (currentVal === 'all' ? 'selected' : '') + '>Tous</option>';
                sortedLevels.forEach(lvl => {
                    let label = lvl;
                    // Only add suffix for single digits like 6, 5, 4, 3
                    if (/^\d+$/.test(lvl) && parseInt(lvl) <= 10) {
                        if (parseInt(lvl) === 1) label = 'Premiere';
                        else if (parseInt(lvl) === 2) label = 'Seconde';
                        else label += 'ème';
                    }
                    html += `<option value="${lvl}" ${currentVal == lvl ? 'selected' : ''}>${label}</option>`;
                });
                return html;
            }

            // Update Global Level Select
            const globalSelect = document.querySelector('#statsContent select[onchange="setStatsLevel(this.value)"]');
            if (globalSelect) {
                globalSelect.innerHTML = generateOptions(currentStatsLevel);
            }
            // Note: Other selects might need updating inside renderStats if they exist there
            // But usually renderStats redraws the content, so we need to inject the options there too.
            // Store levels for renderStats to use
            window.availableStatsLevels = sortedLevels;
        }

        function setStatsLevel(level) {
            currentStatsLevel = level;
            // Global level updates local levels if they are in sync or to provide a master reset
            currentStatsClassLevel = level;
            currentStatsStudentLevel = level;
            currentStatsColorLevel = level; // Sync Color/Priority stats too
            renderStats();
        }

        function setStatsClassLevel(level) {
            currentStatsClassLevel = level;
            renderStats();
        }

        function setStatsStudentLevel(level) {
            currentStatsStudentLevel = level;
            renderStats();
        }

        function setStatsStudentLimit(limit) {
            currentStatsStudentLimit = parseInt(limit);
            renderStats();
        }

        // Function to assign missing classes to students in RDV
        function assignMissingClasses() {
            if (!appData.rdv || !appData.students) {
                alert("❌ Données manquantes pour l'assignation automatique.");
                return;
            }

            // First, find all students without class
            const studentsWithoutClass = new Set();
            appData.rdv.forEach(r => {
                if (r.students && Array.isArray(r.students)) {
                    r.students.forEach(s => {
                        if (!s.match(/\(([^)]+)\)$/)) {
                            studentsWithoutClass.add(s);
                        }
                    });
                }
            });

            if (studentsWithoutClass.size === 0) {
                alert("ℹ️ Aucun élève sans classe trouvé. Tous les élèves ont déjà leur classe.");
                return;
            }

            // Show dialog to choose: auto or manual
            const choice = confirm(
                `📋 ${studentsWithoutClass.size} élève(s) sans classe trouvé(s).\n\n` +
                `• OK = Assignation AUTOMATIQUE (recherche dans les fiches élèves)\n` +
                `• Annuler = Assignation MANUELLE (choisir une classe)`
            );

            if (choice) {
                // Automatic assignment
                performAutomaticAssignment();
            } else {
                // Manual assignment
                showManualAssignmentDialog(Array.from(studentsWithoutClass));
            }
        }

        // Perform automatic assignment
        function performAutomaticAssignment() {
            let updatedCount = 0;
            let notFoundCount = 0;
            const notFoundStudents = [];

            // Helper to find student class from appData.students
            const findStudentClass = (studentName) => {
                const nameParts = studentName.trim().split(/\s+/);
                if (nameParts.length < 2) return null;

                const searchNom = nameParts[0].toUpperCase();
                const searchPrenom = nameParts.slice(1).join(' ').toLowerCase();

                // Search across all classes
                for (const className in appData.students) {
                    const classObj = appData.students[className];
                    for (const key in classObj) {
                        const s = classObj[key];
                        if (s.nom && s.prenom) {
                            const sNom = s.nom.toUpperCase();
                            const sPrenom = s.prenom.toLowerCase();
                            if (sNom === searchNom && sPrenom === searchPrenom) {
                                return s.classe || className;
                            }
                        }
                    }
                }
                return null;
            };

            // Process all RDV
            appData.rdv.forEach((r, idx) => {
                if (r.students && Array.isArray(r.students)) {
                    const updatedStudents = r.students.map(s => {
                        // Check if student already has a class
                        if (s.match(/\(([^)]+)\)$/)) {
                            return s; // Already has class
                        }

                        // Try to find the class
                        const foundClass = findStudentClass(s);
                        if (foundClass) {
                            updatedCount++;
                            return `${s} (${foundClass})`;
                        } else {
                            if (!notFoundStudents.includes(s)) {
                                notFoundStudents.push(s);
                            }
                            notFoundCount++;
                            return s; // Keep original if not found
                        }
                    });

                    // Update RDV with new student format
                    appData.rdv[idx].students = updatedStudents;
                }
            });

            // Save updated data
            if (updatedCount > 0) {
                saveAppData();
                renderStats();
                alert(`✅ Assignation automatique terminée:\n\n` +
                      `• ${updatedCount} élève(s) mis à jour\n` +
                      `• ${notFoundCount} élève(s) non trouvé(s)\n\n` +
                      (notFoundStudents.length > 0 ? 
                       `Élèves non trouvés:\n${notFoundStudents.slice(0, 10).join('\n')}${notFoundStudents.length > 10 ? '\n...' : ''}` : ''));
            } else {
                alert("ℹ️ Aucune classe trouvée automatiquement.");
            }
        }

        // Show manual assignment dialog
        function showManualAssignmentDialog(studentsWithoutClass) {
            // Create dialog overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; align-items:center; justify-content:center;';
            
            const dialog = document.createElement('div');
            dialog.style.cssText = 'background:#1e1e1e; color:#fff; padding:20px; border-radius:10px; max-width:600px; max-height:80vh; overflow:auto; box-shadow:0 4px 20px rgba(0,0,0,0.5);';
            
            let html = '<h2 style="margin:0 0 15px 0; color:#00f2ff;">📋 Assignation manuelle des classes</h2>';
            html += `<p style="color:#aaa; margin-bottom:15px;">${studentsWithoutClass.length} élève(s) à assigner</p>`;
            
            // Get available classes
            const classes = Object.keys(appData.students).sort();
            
            html += '<div style="max-height:400px; overflow-y:auto; margin-bottom:15px;">';
            studentsWithoutClass.forEach((student, idx) => {
                html += `<div style="background:#2a2a2a; padding:10px; margin-bottom:8px; border-radius:5px; display:flex; align-items:center; justify-content:space-between;">`;
                html += `<span style="flex:1; margin-right:10px;">${student}</span>`;
                html += `<select id="class_${idx}" style="background:#333; color:white; border:1px solid #555; padding:5px; border-radius:3px; min-width:120px;">`;
                html += '<option value="">-- Choisir --</option>';
                classes.forEach(cls => {
                    html += `<option value="${cls}">${cls}</option>`;
                });
                html += '</select>';
                html += '</div>';
            });
            html += '</div>';
            
            html += '<div style="display:flex; gap:10px; justify-content:flex-end;">';
            html += '<button id="cancelBtn" style="background:#666; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:14px;">Annuler</button>';
            html += '<button id="applyBtn" style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:14px; font-weight:bold;">✓ Appliquer</button>';
            html += '</div>';
            
            dialog.innerHTML = html;
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Cancel button
            document.getElementById('cancelBtn').onclick = () => {
                document.body.removeChild(overlay);
            };
            
            // Apply button
            document.getElementById('applyBtn').onclick = () => {
                let updatedCount = 0;
                const assignments = {};
                
                // Collect assignments
                studentsWithoutClass.forEach((student, idx) => {
                    const select = document.getElementById(`class_${idx}`);
                    if (select && select.value) {
                        assignments[student] = select.value;
                    }
                });
                
                // Apply assignments to all RDV
                appData.rdv.forEach((r, rdvIdx) => {
                    if (r.students && Array.isArray(r.students)) {
                        const updatedStudents = r.students.map(s => {
                            if (assignments[s]) {
                                updatedCount++;
                                return `${s} (${assignments[s]})`;
                            }
                            return s;
                        });
                        appData.rdv[rdvIdx].students = updatedStudents;
                    }
                });
                
                // Save and refresh
                if (updatedCount > 0) {
                    saveAppData();
                    renderStats();
                    alert(`✅ Assignation manuelle réussie!\n\n${updatedCount} occurrence(s) mise(s) à jour.`);
                } else {
                    alert("ℹ️ Aucune classe sélectionnée.");
                }
                
                document.body.removeChild(overlay);
            };
        }

        // Function to change a student's class
        function changeStudentClass() {
            // Exit fullscreen if active
            if (document.fullscreenElement) {
                document.exitFullscreen().catch(err => {
                    console.log("Could not exit fullscreen:", err);
                });
                const modal = document.querySelector('#statisticsModal .modal-content');
                if (modal) {
                    modal.classList.remove('fullscreen-mode');
                }
                const btn = document.getElementById('fsCloseBtn');
                if (btn) btn.style.display = 'none';
            }
            
            if (!appData.students) {
                alert("❌ Aucune donnée élève disponible.");
                return;
            }

            // Collect all students from appData.students
            const allStudents = [];
            Object.keys(appData.students).forEach(className => {
                const classObj = appData.students[className];
                Object.keys(classObj).forEach(key => {
                    const s = classObj[key];
                    if (s.nom && s.prenom) {
                        allStudents.push({
                            nom: s.nom,
                            prenom: s.prenom,
                            classe: s.classe || className,
                            key: key,
                            fullName: `${s.nom} ${s.prenom}`,
                            displayName: `${s.nom} ${s.prenom} (${s.classe || className})`
                        });
                    }
                });
            });

            if (allStudents.length === 0) {
                alert("❌ Aucun élève trouvé.");
                return;
            }

            // Sort by name
            allStudents.sort((a, b) => a.fullName.localeCompare(b.fullName));

            // Get available classes
            const classes = Object.keys(appData.students).sort();

            // Create dialog overlay
            const overlay = document.createElement('div');
            overlay.id = 'changeClassOverlay';
            overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; width:100vw; height:100vh; background:rgba(0,0,0,0.95); z-index:999999; display:flex; align-items:center; justify-content:center;';
            
            const dialog = document.createElement('div');
            dialog.style.cssText = 'background:#1e1e1e; color:#fff; padding:20px; border-radius:10px; max-width:700px; width:90%; max-height:80vh; overflow:hidden; box-shadow:0 8px 32px rgba(0,0,0,0.8); display:flex; flex-direction:column; position:relative;';
            
            let html = '<h2 style="margin:0 0 15px 0; color:#00f2ff;">🔄 Changer la classe d\'un élève</h2>';
            
            // Search box
            html += '<input type="text" id="studentSearchBox" placeholder="🔍 Rechercher un élève..." style="width:100%; padding:10px; margin-bottom:15px; background:#2a2a2a; color:white; border:1px solid #555; border-radius:5px; font-size:14px; box-sizing:border-box;" />';
            
            // Student list container
            html += '<div id="studentListContainer" style="flex:1; max-height:400px; overflow-y:auto; margin-bottom:15px;"></div>';
            
            html += '<div style="display:flex; gap:10px; justify-content:flex-end; border-top:1px solid #444; padding-top:15px;">';
            html += '<button id="cancelChangeBtn" style="background:#666; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:14px;">Annuler</button>';
            html += '<button id="validateChangesBtn" style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:14px; font-weight:bold;">✓ Valider les changements</button>';
            html += '</div>';
            
            dialog.innerHTML = html;
            overlay.appendChild(dialog);
            
            // Remove any existing overlay first
            const existingOverlay = document.getElementById('changeClassOverlay');
            if (existingOverlay) {
                document.body.removeChild(existingOverlay);
            }
            
            document.body.appendChild(overlay);

            // Force immediate display at top
            overlay.style.display = 'flex';
            dialog.style.zIndex = '1000000';
            
            // Bring to front
            setTimeout(() => {
                overlay.scrollIntoView({ behavior: 'instant', block: 'start' });
                const searchBox = document.getElementById('studentSearchBox');
                if (searchBox) searchBox.focus();
            }, 0);

            // Function to render student list
            const renderStudentList = (filter = '') => {
                const listContainer = document.getElementById('studentListContainer');
                if (!listContainer) return;

                const filterLower = filter.toLowerCase();
                const filteredStudents = filter ? 
                    allStudents.filter(s => s.fullName.toLowerCase().includes(filterLower)) : 
                    allStudents;

                if (filteredStudents.length === 0) {
                    listContainer.innerHTML = '<p style="color:#aaa; text-align:center; padding:20px;">Aucun élève trouvé</p>';
                    return;
                }

                let listHtml = '';
                filteredStudents.slice(0, 50).forEach((student, idx) => {
                    listHtml += `<div style="background:#2a2a2a; padding:10px; margin-bottom:8px; border-radius:5px; display:flex; align-items:center; justify-content:space-between;">`;
                    listHtml += `<span style="flex:1; margin-right:10px;">${student.displayName}</span>`;
                    listHtml += `<select id="newclass_${idx}" data-student-key="${student.key}" data-student-nom="${student.nom}" data-student-prenom="${student.prenom}" data-old-class="${student.classe}" style="background:#333; color:white; border:1px solid #555; padding:5px; border-radius:3px; min-width:120px;">`;
                    listHtml += '<option value="">-- Pas de changement --</option>';
                    classes.forEach(cls => {
                        listHtml += `<option value="${cls}" ${cls === student.classe ? 'selected' : ''}>${cls}</option>`;
                    });
                    listHtml += '</select>';
                    listHtml += '</div>';
                });

                if (filteredStudents.length > 50) {
                    listHtml += '<p style="color:#aaa; text-align:center; font-size:12px;">... et ' + (filteredStudents.length - 50) + ' autres (affinez la recherche)</p>';
                }

                listContainer.innerHTML = listHtml;
            };

            // Initial render
            renderStudentList();

            // Search handler
            const searchBox = document.getElementById('studentSearchBox');
            if (searchBox) {
                searchBox.addEventListener('input', (e) => {
                    renderStudentList(e.target.value);
                });
            }

            // Validate button - Apply all changes at once
            document.getElementById('validateChangesBtn').onclick = () => {
                const changes = [];
                
                // Collect all changes
                const selects = document.querySelectorAll('[id^="newclass_"]');
                selects.forEach(select => {
                    const studentKey = select.dataset.studentKey;
                    const nom = select.dataset.studentNom;
                    const prenom = select.dataset.studentPrenom;
                    const oldClass = select.dataset.oldClass;
                    const newClass = select.value;
                    
                    // Only include if class actually changed
                    if (newClass && oldClass !== newClass) {
                        changes.push({
                            key: studentKey,
                            nom: nom,
                            prenom: prenom,
                            oldClass: oldClass,
                            newClass: newClass
                        });
                    }
                });
                
                if (changes.length === 0) {
                    alert("ℹ️ Aucun changement détecté.");
                    return;
                }
                
                // Confirm changes
                let confirmMsg = `📋 Confirmer ${changes.length} changement(s) de classe ?\n\n`;
                changes.slice(0, 10).forEach(c => {
                    confirmMsg += `• ${c.nom} ${c.prenom}: ${c.oldClass} → ${c.newClass}\n`;
                });
                if (changes.length > 10) {
                    confirmMsg += `... et ${changes.length - 10} autres\n`;
                }
                confirmMsg += `\nCela mettra à jour:\n• Les fiches élèves\n• Tous les RDV associés`;
                
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                let totalRdvUpdated = 0;
                let studentsUpdated = 0;
                let classesCreated = [];
                let classesRemoved = [];
                
                // Process each change
                changes.forEach(change => {
                    console.log(`🔄 Changement: ${change.nom} ${change.prenom} de ${change.oldClass} vers ${change.newClass}`);
                    
                    // 1. Update appData.students - Move student from old class to new class
                    if (appData.students[change.oldClass] && appData.students[change.oldClass][change.key]) {
                        const studentData = { ...appData.students[change.oldClass][change.key] };
                        studentData.classe = change.newClass;

                        // Add to new class
                        if (!appData.students[change.newClass]) {
                            appData.students[change.newClass] = {};
                            classesCreated.push(change.newClass);
                            console.log(`✅ Nouvelle classe créée: ${change.newClass}`);
                        }
                        appData.students[change.newClass][change.key] = studentData;
                        console.log(`✅ Élève ajouté à ${change.newClass}`);

                        // Remove from old class
                        delete appData.students[change.oldClass][change.key];
                        console.log(`✅ Élève retiré de ${change.oldClass}`);

                        // If old class is empty, remove it
                        if (Object.keys(appData.students[change.oldClass]).length === 0) {
                            delete appData.students[change.oldClass];
                            classesRemoved.push(change.oldClass);
                            console.log(`✅ Classe vide supprimée: ${change.oldClass}`);
                        }
                        
                        studentsUpdated++;
                    }

                    // 2. Update all RDV - Change student name format
                    const oldFormat = `${change.nom} ${change.prenom} (${change.oldClass})`;
                    const newFormat = `${change.nom} ${change.prenom} (${change.newClass})`;

                    appData.rdv.forEach((r, rdvIdx) => {
                        if (r.students && Array.isArray(r.students)) {
                            const updatedStudents = r.students.map(s => {
                                if (s === oldFormat || s === `${change.nom} ${change.prenom}`) {
                                    totalRdvUpdated++;
                                    return newFormat;
                                }
                                return s;
                            });
                            appData.rdv[rdvIdx].students = updatedStudents;
                        }
                    });
                    
                    // 3. Update berliozData if exists
                    if (window.berliozData) {
                        // Update in berliozData.students array
                        const studentInBerlioz = berliozData.students.find(s => 
                            s.nom === change.nom && s.prenom === change.prenom && s.classe === change.oldClass
                        );
                        if (studentInBerlioz) {
                            studentInBerlioz.classe = change.newClass;
                            console.log(`✅ berliozData.students mis à jour`);
                        }
                        
                        // Update studentsByClass
                        if (berliozData.studentsByClass[change.oldClass]) {
                            const idx = berliozData.studentsByClass[change.oldClass].findIndex(s =>
                                s.nom === change.nom && s.prenom === change.prenom
                            );
                            if (idx !== -1) {
                                const student = berliozData.studentsByClass[change.oldClass].splice(idx, 1)[0];
                                student.classe = change.newClass;
                                
                                if (!berliozData.studentsByClass[change.newClass]) {
                                    berliozData.studentsByClass[change.newClass] = [];
                                }
                                berliozData.studentsByClass[change.newClass].push(student);
                                console.log(`✅ berliozData.studentsByClass mis à jour`);
                            }
                        }
                        
                        // Update classes list
                        berliozData.classes[change.newClass] = true;
                    }
                });

                // 4. Save changes
                saveAppData();
                
                // 5. Rebuild berliozData from updated appData.students
                rebuildBerliozFromAppData();
                console.log(`✅ berliozData reconstruit depuis appData.students`);
                
                // 6. Rebuild sidebar to reflect changes
                updateClassesPanel();
                console.log(`✅ Sidebar classes mis à jour`);
                
                // 7. Update display
                document.body.removeChild(overlay);
                renderStats();
                
                let resultMsg = `✅ Changements appliqués avec succès !\n\n` +
                      `• ${studentsUpdated} fiche(s) élève mise(s) à jour\n` +
                      `• ${totalRdvUpdated} RDV mis à jour\n`;
                
                if (classesCreated.length > 0) {
                    resultMsg += `• ${classesCreated.length} classe(s) créée(s): ${classesCreated.join(', ')}\n`;
                }
                if (classesRemoved.length > 0) {
                    resultMsg += `• ${classesRemoved.length} classe(s) vide(s) supprimée(s): ${classesRemoved.join(', ')}\n`;
                }
                
                alert(resultMsg);
            };

            // Cancel button
            document.getElementById('cancelChangeBtn').onclick = () => {
                document.body.removeChild(overlay);
            };
        }

        function setStatsColorLimit(limit) {
            currentStatsColorLimit = parseInt(limit);
            renderStats();
        }

        function setStatsColorLevel(level) {
            currentStatsColorLevel = level;
            renderStats();
        }

        function setStatsRubricLimit(limit) {
            currentStatsRubricLimit = parseInt(limit);
            renderStats();
        }

        function setStatsMotifLimit(limit) {
            currentStatsMotifLimit = parseInt(limit);
            renderStats();
        }

        function updateMotifSearch(query) {
            currentMotifSearchQuery = query;

            // OPTIMIZATION: Update only the list if stats are available
            // This prevents full re-render which causes loss of focus and scroll jumps
            const listContainer = document.getElementById('motifsList');
            if (window.lastStats && window.lastStats.motifs && listContainer) {
                const motifs = window.lastStats.motifs;
                let sortedMotifs = Object.entries(motifs);

                // Filter
                if (query && query.trim() !== "") {
                    const q = query.toLowerCase();
                    sortedMotifs = sortedMotifs.filter(([m, c]) => m.toLowerCase().includes(q));
                }

                sortedMotifs = sortedMotifs.sort((a, b) => b[1] - a[1]).slice(0, 50);

                let html = '';
                if (sortedMotifs.length === 0) {
                    html += '<li style="color:#666; width:100%;">Aucun motif trouvé.</li>';
                } else {
                    sortedMotifs.forEach(([m, count]) => {
                        html += `<li style="padding:5px 0; color:#ddd; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                            <span style="cursor:pointer; flex:1;" onclick="openMotifDetails('${m.replace(/'/g, "\\'")}')">
                                <b>${count}</b> - ${m}
                            </span>
                        </li>`;
                    });
                }
                listContainer.innerHTML = html;
            } else {
                // Fallback (should not happen if ID matches)
                renderStats();
            }
        }

        function setStatsRange(range) {
            currentStatsRange = range;
            document.querySelectorAll('.stats-filter-btn').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(
                    range === 'day' ? 'aujourd' : range === 'week' ? 'semaine' : range === 'month' ? 'mois' : range === 'year' ? 'année' : 'tout'
                )) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderStats();
        }

        // Global variable for Stats Navigation
        let currentStatsDate = new Date();

        function changeStatsDate(delta) {
            if (currentStatsRange === 'day') {
                currentStatsDate.setDate(currentStatsDate.getDate() + delta);
            } else if (currentStatsRange === 'week') {
                currentStatsDate.setDate(currentStatsDate.getDate() + (delta * 7));
            } else if (currentStatsRange === 'month') {
                currentStatsDate.setMonth(currentStatsDate.getMonth() + delta);
            } else if (currentStatsRange === 'year') {
                // Moving by "School Year"
                // If we are simply adding 1 year to the date, we might shift out of strict "School Year Start".
                // However, since we re-calculate valid Start/End based on Month in renderStats, 
                // just shifting the year by 1 is safe enough. 
                // e.g. June 2024 (23-24) + 1 year = June 2025 (24-25).
                // e.g. Oct 2023 (23-24) + 1 year = Oct 2024 (24-25).
                currentStatsDate.setFullYear(currentStatsDate.getFullYear() + delta);
            }
            renderStats();
        }

        function renderStats() {
            const content = document.getElementById('statsContent');
            if (!content) return;

            // --- 0. Setup Date Range ---
            // Save scroll position
            let savedScrollTop = 0;
            if (content) savedScrollTop = content.scrollTop;
            const now = new Date(currentStatsDate);
            let startDate, endDate;
            let rangeLabel = "";

            if (currentStatsRange === 'day') {
                startDate = new Date(now); startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now); endDate.setHours(23, 59, 59, 999);
                rangeLabel = startDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            } else if (currentStatsRange === 'week') {
                const d = new Date(now);
                const day = d.getDay() || 7;
                d.setHours(-24 * (day - 1));
                startDate = new Date(d); startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate); endDate.setDate(endDate.getDate() + 7);
                rangeLabel = `Semaine du ${startDate.toLocaleDateString('fr-FR')}`;
            } else if (currentStatsRange === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                rangeLabel = startDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            } else if (currentStatsRange === 'year') {
                // Determine School Year based on current stats date
                const m = now.getMonth();
                const y = now.getFullYear();

                let startYear, endYear;
                if (m < 8) { // Jan-Aug -> belong to school year starting prev year
                    startYear = y - 1;
                    endYear = y;
                } else { // Sept-Dec -> belong to school year starting this year
                    startYear = y;
                    endYear = y + 1;
                }

                // Set Range: Sept 1st to July 31st
                startDate = new Date(startYear, 8, 1); // 1st September
                endDate = new Date(endYear, 6, 31, 23, 59, 59); // 31st July

                rangeLabel = `Année Scolaire ${startYear}-${endYear}`;
            }

            // --- NEW: Function to Delete Rubric Globally ---
            window.deleteRubricGlobal = function (rubricName) {
                if (!appData.customRubriques) return;
                let count = 0;
                Object.keys(appData.customRubriques).forEach(key => {
                    const originalLen = appData.customRubriques[key].length;
                    appData.customRubriques[key] = appData.customRubriques[key].filter(r => r.name !== rubricName);
                    if (appData.customRubriques[key].length < originalLen) count++;
                });

                if (count > 0) {
                    saveAppData(); // Persist changes
                    renderStats(); // Refresh view
                    alert(`Rubrique "${rubricName}" supprimée.`);
                } else {
                    alert("Erreur: Rubrique introuvable.");
                }
            };

            // Helper for robust class matching (handles 06 vs 6, case, etc)
            const matchesLevel = (cls, level) => {
                if (!level || level === 'all') return true;
                
                // Handle "Sans classe" filter
                if (level === 'sans_classe') {
                    return !cls || cls.trim() === '';
                }
                
                const c = String(cls || '').trim().toUpperCase();
                let l = String(level).trim().toUpperCase();
                
                // If no class, don't match specific levels
                if (!c) return false;

                // Specific substitutions based on User Request
                // "le niveau terminal regroupe toute les classe commancant par T"
                if (l === 'TERMINAL' || l === 'TERMINALE') {
                    if (c.startsWith('T')) return true;
                }

                // "le niveau seconde regroupe toutes les classe comment par 2NDE"
                // (Also support '2' as the underlying value for Seconde)
                if (l === 'SECONDE' || l === '2') {
                    if (c.startsWith('2NDE')) return true;
                    if (c.startsWith('2')) return true;
                }

                // "le niveau premiere regroupe toutes les classe commencant par 1"
                if (l === 'PREMIERE' || l === '1') {
                    if (c.startsWith('1')) return true;
                }

                if (c === l) return true;
                if (c.startsWith(l)) return true;
                // Handle 06 vs 6
                const cNorm = c.replace(/^0+/, '');
                const lNorm = l.replace(/^0+/, '');
                if (cNorm !== c || lNorm !== l) {
                    if (cNorm.startsWith(lNorm)) return true;
                }
                return false;
            };

            // ---------------------------------------------

            // Function to check if date is in range
            const isInRange = (dDate) => dDate >= startDate && dDate <= endDate;

            // --- 1. Filter Data ---
            const searchInput = document.getElementById('statsSearchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            // A. Filter RDVs (Events)
            // -----------------------
            const events = (appData.rdv || []).filter(r => {
                // Search Filter
                if (searchTerm) {
                    const title = (r.title || '').toLowerCase();
                    const desc = (r.description || '').toLowerCase();
                    const students = (r.students || []).join(' ').toLowerCase();
                    if (!title.includes(searchTerm) && !desc.includes(searchTerm) && !students.includes(searchTerm)) {
                        return false;
                    }
                }

                // Level Filter (apply to RDV too) - IMPORTANT FIX
                if (currentStatsLevel !== 'all') {
                    if (!matchesLevel(r.classe, currentStatsLevel)) return false;
                }

                // Date Filter
                if (!r.date) return false;
                return isInRange(new Date(r.date));
            });

            // B. Filter Weekly Reports (Notes)
            // --------------------------------
            const reportEntries = [];

            // Helper to parse "15/05/2025 14:30:22"
            const parseFrenchDate = (str) => {
                if (!str) return null;
                const [datePart, timePart] = str.split(' ');
                if (!datePart) return null;
                const [day, month, year] = datePart.split('/');
                if (!day || !month || !year) return null;
                const d = new Date(`${year}-${month}-${day}T${timePart || '00:00:00'}`);
                return isNaN(d.getTime()) ? null : d;
            };

            Object.keys(studentWeeklyData).forEach(key => {
                const entry = studentWeeklyData[key];

                // Helper to add entry if matches filters
                const tryAddEntry = (dataItem, dateObj) => {
                    // Date Range
                    if (!dateObj || !isInRange(dateObj)) return;

                    // Level Filter
                    const parts = key.split('_');
                    const cls = parts[0];
                    if (currentStatsLevel !== 'all' && !matchesLevel(cls, currentStatsLevel)) return;

                    // Search Filter
                    if (searchTerm) {
                        const contentSearch = (dataItem.notes || '') + (dataItem.status || '') + key;
                        if (!contentSearch.toLowerCase().includes(searchTerm)) return;
                    }

                    // Push entry
                    reportEntries.push({ key, ...dataItem, timestamp: dateObj.toLocaleString('fr-FR') });
                };

                // 1. Priority: Daily Data (Granular stats)
                let hasProcessedDays = false;
                if (entry.days && Object.keys(entry.days).length > 0) {
                    const lastW = key.lastIndexOf('_w');
                    if (lastW > 0) {
                        const weekId = key.substring(lastW + 2);
                        Object.keys(entry.days).forEach(dIdx => {
                            const dData = entry.days[dIdx];
                            // Check meaningful data
                            if ((dData.notes && dData.notes.trim()) || dData.status || dData.color) {
                                if (typeof getDateFromWeekId === 'function') {
                                    const realDate = getDateFromWeekId(weekId, parseInt(dIdx));
                                    if (realDate) {
                                        tryAddEntry(dData, realDate);
                                        hasProcessedDays = true;
                                    }
                                }
                            }
                        });
                    }
                }

                // 2. Fallback: Legacy/Global Data (Only if no days were processed)
                if (!hasProcessedDays && entry.timestamp) {
                    const dDate = parseFrenchDate(entry.timestamp);
                    if (dDate) tryAddEntry(entry, dDate);
                }
            });


            // --- 2. Calculate Stats ---
            const stats = {
                total_evenements: events.length,
                total_RDV: events.length,
                RDV_present: 0,
                RDV_absent: 0,

                total_rencontres_famille: 0,
                total_saisies_specifiques: 0, // Reunion
                total_rdv_eleve: 0,           // Standard RDV
                total_notes_dossier: 0,       // From WeeklyData

                colors: { rouge: 0, orange: 0, jaune: 0, vert: 0, vert_fonce: 0, rose: 0 },
                motifs: {},
                classStats: {},
                frequentWords: {}, // NEW
                busyDays: {}       // NEW
            };

            const stopWords = new Set(['le', 'la', 'les', 'un', 'une', 'des', 'du', 'de', 'et', 'pour', 'sur', 'dans', 'au', 'aux', 'avec', 'sans', 'par', 'ce', 'cet', 'cette', 'ces', 'mon', 'ton', 'son', 'ma', 'ta', 'sa', 'mes', 'tes', 'ses', 'se', 'que', 'qui', 'quoi', 'dont', 'ou', 'mais', 'donc', 'or', 'ni', 'car', 'ne', 'pas', 'plus']);

            // Add Students Names to Stop Words
            if (appData.students) {
                Object.values(appData.students).forEach(cls => {
                    Object.values(cls).forEach(s => {
                        if (s.nom) stopWords.add(s.nom.toLowerCase());
                        if (s.prenom) stopWords.add(s.prenom.toLowerCase());
                    });
                });
            }

            // Process Events
            events.forEach(r => {
                const type = r.type || 'standard';
                const status = r.status || 'not_validated';

                // Counters by Type
                if (type === 'famille') {
                    stats.total_rencontres_famille++;
                    stats.colors.jaune++;
                } else if (type === 'reunion') {
                    stats.total_saisies_specifiques++;
                    stats.colors.vert_fonce++;
                } else {
                    stats.total_rdv_eleve++; // Was 'total_notes_pedagogiques'
                    if (status === 'validated') stats.colors.vert++;
                    else if (status === 'cancelled') stats.colors.rouge++;
                    else stats.colors.orange++;
                }

                // General Status
                if (status === 'validated') stats.RDV_present++;
                else if (status === 'cancelled') stats.RDV_absent++;

                // Motifs
                if (r.description) {
                    const motif = r.description.trim();
                    if (motif.length > 2) stats.motifs[motif] = (stats.motifs[motif] || 0) + 1;

                    // Frequent Words Analysis (on Description)
                    const words = motif.toLowerCase()
                        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ")
                        .split(/\s+/);
                    words.forEach(w => {
                        if (w.length > 2 && !stopWords.has(w) && isNaN(w)) {
                            stats.frequentWords[w] = (stats.frequentWords[w] || 0) + 1;
                        }
                    });
                }

                // Frequent Words Analysis (on Title)
                if (r.title) {
                    const words = r.title.toLowerCase()
                        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ")
                        .split(/\s+/);
                    words.forEach(w => {
                        if (w.length > 2 && !stopWords.has(w) && isNaN(w)) {
                            stats.frequentWords[w] = (stats.frequentWords[w] || 0) + 1;
                        }
                    });
                }

                // Busy Days
                if (r.date) {
                    const dayKey = new Date(r.date).toISOString().split('T')[0];
                    stats.busyDays[dayKey] = (stats.busyDays[dayKey] || 0) + 1;
                }

                // Classes (RDV)
                if (r.students && Array.isArray(r.students)) {
                    const involvedClasses = new Set();
                    r.students.forEach(s => {
                        const match = s.match(/\(([^)]+)\)$/);
                        if (match) involvedClasses.add(match[1]);
                    });
                    involvedClasses.forEach(cls => {
                        if (!stats.classStats[cls]) stats.classStats[cls] = { count: 0, rdv: 0 };
                        stats.classStats[cls].rdv++;
                    });
                }
            });

            // Process Notes (Weekly Data)
            // Process Notes (Weekly Data)
            reportEntries.forEach(entry => {
                if ((entry.notes && entry.notes.trim().length > 0) || (entry.status && entry.status.length > 0)) {
                    stats.total_notes_dossier++; // New Metric
                }

                // Count colors from Weekly/Daily Reports
                if (entry.color) {
                    if (entry.color === 'red') stats.colors.rouge++;
                    else if (entry.color === 'orange') stats.colors.orange++;
                    else if (entry.color === 'yellow') stats.colors.jaune++;
                    else if (entry.color === 'green') stats.colors.vert++;
                }
            });


            // --- 3. Top 10 Students (Activité Globale - All Time) ---
            const studentAgg = {}; // { 'Name (Class)': { rdv: 0, entries: 0, rubriques: 0 } }

            // Helper to find student class from appData.students
            const findStudentClass = (studentName) => {
                // Try to extract from existing format "NOM Prénom (Classe)"
                const match = studentName.match(/\(([^)]+)\)$/);
                if (match) return match[1];
                
                // If no class in parentheses, search in appData.students
                if (appData.students) {
                    const nameParts = studentName.trim().split(/\s+/);
                    if (nameParts.length >= 2) {
                        const searchNom = nameParts[0].toUpperCase();
                        const searchPrenom = nameParts.slice(1).join(' ').toLowerCase();
                        
                        // Search across all classes
                        for (const className in appData.students) {
                            const classObj = appData.students[className];
                            for (const key in classObj) {
                                const s = classObj[key];
                                if (s.nom && s.prenom) {
                                    const sNom = s.nom.toUpperCase();
                                    const sPrenom = s.prenom.toLowerCase();
                                    if (sNom === searchNom && sPrenom === searchPrenom) {
                                        return s.classe || className;
                                    }
                                }
                            }
                        }
                    }
                }
                return ''; // No class found
            };

            // From ALL Events (Ignore Date Range, Keep Search)
            (appData.rdv || []).forEach(r => {
                // Apply Search Filter only
                if (searchTerm) {
                    const title = (r.title || '').toLowerCase();
                    const desc = (r.description || '').toLowerCase();
                    const students = (r.students || []).join(' ').toLowerCase();
                    if (!title.includes(searchTerm) && !desc.includes(searchTerm) && !students.includes(searchTerm)) {
                        return;
                    }
                }

                if (r.students && Array.isArray(r.students)) {
                    r.students.forEach(s => {
                        if (!studentAgg[s]) studentAgg[s] = { rdv: 0, entries: 0, rubriques: 0, cls: '', valide: 0, attente: 0, annule: 0 };
                        studentAgg[s].rdv++;

                        const st = r.status || 'not_validated';
                        if (st === 'validated') studentAgg[s].valide++;
                        else if (st === 'cancelled') studentAgg[s].annule++;
                        else studentAgg[s].attente++; // not_validated or other = En attente

                        // Try to find class from student name
                        const foundClass = findStudentClass(s);
                        if (foundClass) studentAgg[s].cls = foundClass;
                    });
                }
            });

            /* 
            // IGNORED as per user request: "ne tenir compte que des rdv dans agenda rdv"
            
            // From ALL Weekly Data (Ignore Date Range, Keep Search)
            Object.keys(studentWeeklyData).forEach(key => {
                // ... logic removed from aggregate ...
            });
 
            // From Custom Rubriques (New Metric) - IGNORED
            if (appData.customRubriques) {
                // ... logic removed from aggregate ...
            }
            */

            // Sort Top 10
            let topStudents = Object.entries(studentAgg)
                .map(([name, data]) => ({ name, ...data, total: data.rdv + data.entries + data.rubriques }))
                .sort((a, b) => b.total - a.total);
            //.slice(0, 10); moved to render time for filtering


            // --- Render UI ---

            // Date Navigation Controls
            let levelOptionsHtml = '<option value="all" ' + (currentStatsLevel === 'all' ? 'selected' : '') + '>Tous</option>';
            if (window.availableStatsLevels) {
                window.availableStatsLevels.forEach(lvl => {
                    let label = lvl;
                    if (/^\d+$/.test(lvl) && parseInt(lvl) <= 10) {
                        if (parseInt(lvl) === 1) label = 'Premiere';
                        else if (parseInt(lvl) === 2) label = 'Seconde';
                        else label += 'ème';
                    }
                    levelOptionsHtml += `<option value="${lvl}" ${currentStatsLevel == lvl ? 'selected' : ''}>${label}</option>`;
                });
            } else {
                // Fallback defaults
                ['6', '5', '4', '3'].forEach(lvl => {
                    levelOptionsHtml += `<option value="${lvl}" ${currentStatsLevel == lvl ? 'selected' : ''}>${lvl}ème</option>`;
                });
            }

            // Add Classes to Global Selector
            if (appData.classes) {
                levelOptionsHtml += '<optgroup label="Classes">';
                Object.keys(appData.classes).sort().forEach(cls => {
                    levelOptionsHtml += `<option value="${cls}" ${currentStatsLevel == cls ? 'selected' : ''}>${cls}</option>`;
                });
                levelOptionsHtml += '</optgroup>';
            }

            const navControls = `
                <div style="display:flex; align-items:center; gap:10px; background:#222; padding:5px 10px; border-radius:5px; margin-right:auto;">
                    <button onclick="changeStatsDate(-1)" style="padding:2px 8px; font-size:12px;">◀</button>
                    <span style="font-weight:bold; color:#00f2ff; min-width:150px; text-align:center;">${rangeLabel}</span>
                    <button onclick="changeStatsDate(1)" style="padding:2px 8px; font-size:12px;">▶</button>
                    <div style="background:#444; width:1px; height:20px; margin:0 5px;"></div>
                    <span style="font-size:0.9em; color:#ccc;">Niveau :</span>
                    <select onchange="setStatsLevel(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px; outline:none;">
                        ${levelOptionsHtml}
                    </select>
                </div>
            `;

            // Close FullScreen Button
            const closeFsBtn = `
                <button id="fsCloseBtn" onclick="toggleStatsFullScreen()" style="display:none; position:fixed; top:20px; right:20px; z-index:9999; background:#F44336; color:white; border:none; padding:10px 15px; border-radius:5px; font-weight:bold; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                    ✖ Fermer Plein Écran
                </button>
            `;

            // Search Results Display (Clickable)
            let searchResultsHTML = '';
            if (searchTerm) {
                searchResultsHTML = `<div style="background:#222; padding:10px; margin-bottom:15px; border-radius:5px; border:1px solid #444;">
                    <h4 style="margin:0 0 5px 0; color:#00f2ff;">🔍 Résultats de la recherche : "${searchTerm}"</h4>
                    <ul style="max-height:150px; overflow-y:auto; padding-left:20px;">
                        ${events.map(e => `<li>📅 ${new Date(e.date).toLocaleDateString()} - ${e.title} ${e.students.map(s =>
                    `<span style="cursor:pointer; color:#00f2ff; text-decoration:underline;" onclick="openStatsStudent('${s.replace(/'/g, "\\'")}')">${s}</span>`
                ).join(', ')}</li>`).join('')}
                        ${reportEntries.map(e => `<li>📝 ${parseFrenchDate(e.timestamp).toLocaleDateString()} - <span style="cursor:pointer; color:#9C27B0; text-decoration:underline;" onclick="openStatsStudentFromKey('${e.key}')">${e.key.split('_').slice(1, -1).join(' ')}</span></li>`).join('')}
                    </ul>
                </div>`;
            }

            // Store for Charts
            window.lastStats = stats;
            window.lastStats.events = events; // EXPOSE FILTERED EVENTS FOR CHARTS
            window.lastStats.total_rdv_eleve = stats.total_rdv_eleve;
            window.lastStats.total_notes_dossier = stats.total_notes_dossier;
            
            // Update RDV display in header
            if (typeof updateClassRDVDisplay === 'function') {
                setTimeout(updateClassRDVDisplay, 100);
            }

            const totalActivity = stats.total_rdv_eleve + stats.total_saisies_specifiques + stats.total_notes_dossier;

            let html = `
                ${closeFsBtn}
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    ${navControls}
                    <!-- Export button could go here -->
                </div>
                ${searchResultsHTML}
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:20px;">
                    ${createStatBox(stats.total_evenements, 'Total Événements', '#2196F3')}
                    ${createStatBox(stats.RDV_present, 'Présents (Validé)', '#4CAF50')}
                    ${createStatBox(stats.RDV_absent, 'Absents/Annulés', '#F44336')}
                    ${createStatBox(stats.total_rencontres_famille, 'Famille', '#FFD700')}
                </div>
            `;

            html += '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">';

            // Categories Fixed
            html += '<div class="stats-card"><h3>📊 Détail par Type de rdv</h3>';
            html += createBar('RDV Élève (Standard)', stats.total_rdv_eleve, totalActivity, '#2196F3');
            html += createBar('Saisies Spécifiques (Réunion)', stats.total_saisies_specifiques, totalActivity, '#006400');
            html += createBar('Notes / Suivis (Dossier)', stats.total_notes_dossier, totalActivity, '#9C27B0');
            html += '</div>';

            // Colors
            html += '<div class="stats-card"><div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0;">🎨 Répartition RDV</h3><span style="font-weight:bold; font-size:0.9em; color:#aaa;">Total RDV discret : ' + stats.total_evenements + '</span></div>';
            html += createBar('Rouge (Abs/Annulé)', stats.colors.rouge, stats.total_evenements, '#F44336');
            html += createBar('Orange (En Attente)', stats.colors.orange, stats.total_evenements, '#FF9800');
            html += createBar('Jaune (Famille)', stats.colors.jaune, stats.total_evenements, '#FFD700');
            html += createBar('Vert (Présent)', stats.colors.vert, stats.total_evenements, '#4CAF50');
            html += createBar('Vert Foncé (Réunion)', stats.colors.vert_fonce, stats.total_evenements, '#006400');
            html += '</div>';

            // Top Classes
            let filteredClassEntries = Object.entries(stats.classStats).filter(([cls, data]) => {
                return matchesLevel(cls, currentStatsClassLevel);
            });
            filteredClassEntries.sort((a, b) => b[1].rdv - a[1].rdv);
            if (currentStatsClassLevel === 'all') filteredClassEntries = filteredClassEntries.slice(0, 10);

            html += '<div class="stats-card">';
            html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">';
            html += '<h3>🏆 Classes (Top RDV)</h3>';

            // Generate Level Options Dynamically for this specific select
            let classLevelOptionsHtml = '<option value="all" ' + (currentStatsClassLevel === 'all' ? 'selected' : '') + '>Tous</option>';
            if (window.availableStatsLevels) {
                window.availableStatsLevels.forEach(lvl => {
                    let label = lvl;
                    if (/^\d+$/.test(lvl) && parseInt(lvl) <= 10) {
                        if (parseInt(lvl) === 1) label = 'Premiere';
                        else if (parseInt(lvl) === 2) label = 'Seconde';
                        else label += 'ème';
                    }
                    classLevelOptionsHtml += `<option value="${lvl}" ${currentStatsClassLevel == lvl ? 'selected' : ''}>${label}</option>`;
                });
            } else {
                ['6', '5', '4', '3'].forEach(lvl => {
                    classLevelOptionsHtml += `<option value="${lvl}" ${currentStatsClassLevel == lvl ? 'selected' : ''}>${lvl}ème</option>`;
                });
            }

            html += `
                <select onchange="setStatsClassLevel(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px;">
                    ${classLevelOptionsHtml}
                </select>
            `;
            html += '</div>';

            html += '<table style="width:100%; border-collapse: collapse; font-size:0.9em; user-select:none;">';
            html += '<thead><tr style="color:#aaa; border-bottom:1px solid #444;"><th style="text-align:left; padding:4px;">Classe</th><th style="text-align:right; padding:4px;">RDV</th></tr></thead><tbody>';
            if (filteredClassEntries.length === 0) html += '<tr><td colspan="2" style="color:#888; padding:10px;">Aucune donnée.</td></tr>';
            filteredClassEntries.forEach(([cls, data]) => {
                html += `
                <tr style="border-bottom:1px solid #333; height:30px;">
                    <td style="padding:4px;">${cls}</td>
                    <td style="padding:4px; text-align:right; font-weight:bold; color:#4CAF50;">${data.rdv}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';

            // Top 10 Students Filtered
            let filteredTopStudents = topStudents.filter(s => {
                return matchesLevel(s.cls, currentStatsStudentLevel);
            });
            
            // Calculate total RDV BEFORE slicing (for all students in the filtered level)
            let totalRDV = filteredTopStudents.reduce((sum, s) => sum + s.rdv, 0);
            
            filteredTopStudents = filteredTopStudents.slice(0, currentStatsStudentLimit);

            // Top 10 Students
            html += '<div class="stats-card">';

            // Generate Level Options Dynamically for Students
            let studentLevelOptionsHtml = '<option value="all" ' + (currentStatsStudentLevel === 'all' ? 'selected' : '') + '>Tous</option>';
            studentLevelOptionsHtml += '<option value="sans_classe" ' + (currentStatsStudentLevel === 'sans_classe' ? 'selected' : '') + '>Sans classe</option>';
            if (window.availableStatsLevels) {
                window.availableStatsLevels.forEach(lvl => {
                    let label = lvl;
                    if (/^\d+$/.test(lvl) && parseInt(lvl) <= 10) {
                        if (parseInt(lvl) === 1) label = 'Premiere';
                        else if (parseInt(lvl) === 2) label = 'Seconde';
                        else label += 'ème';
                    }
                    studentLevelOptionsHtml += `<option value="${lvl}" ${currentStatsStudentLevel == lvl ? 'selected' : ''}>${label}</option>`;
                });
            } else {
                ['6', '5', '4', '3'].forEach(lvl => {
                    studentLevelOptionsHtml += `<option value="${lvl}" ${currentStatsStudentLevel == lvl ? 'selected' : ''}>${lvl}ème</option>`;
                });
            }

            html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">';
            
            html += '<h3 style="margin:0;">🌟 top eleve (rdv) <span style="font-size:0.8em; color:#2196F3; font-weight:normal;">(Total: ' + totalRDV + ')</span></h3>';
            html += '<div style="display:flex; gap:5px; align-items:center;">';

            // Button to fix missing classes
            html += '<button onclick="assignMissingClasses()" style="background:#FF9800; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.75em; cursor:pointer; white-space:nowrap;" title="Assigner automatiquement les classes manquantes">📋 Assigner classes</button>';
            
            // Button to change student class
            html += '<button onclick="changeStudentClass()" style="background:#9C27B0; color:white; border:none; padding:4px 8px; border-radius:3px; font-size:0.75em; cursor:pointer; white-space:nowrap;" title="Changer la classe d\'un élève">🔄 Changer classe</button>';

            // Safe construction
            html += '<select onchange="setStatsStudentLevel(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px; font-size:0.8em;">';
            html += studentLevelOptionsHtml;
            html += '</select>';

            html += '<select onchange="setStatsStudentLimit(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px; font-size:0.8em;">';
            html += '<option value="10" ' + (currentStatsStudentLimit === 10 ? 'selected' : '') + '>10</option>';
            html += '<option value="20" ' + (currentStatsStudentLimit === 20 ? 'selected' : '') + '>20</option>';
            html += '<option value="50" ' + (currentStatsStudentLimit === 50 ? 'selected' : '') + '>50</option>';
            html += '<option value="100" ' + (currentStatsStudentLimit === 100 ? 'selected' : '') + '>100</option>';
            html += '<option value="9999" ' + (currentStatsStudentLimit === 9999 ? 'selected' : '') + '>Tous</option>';
            html += '</select>';
            html += '</div></div>';

            html += '<div style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">🔵 RDV</div>';
            html += '<table style="width:100%; border-collapse: collapse; font-size:0.9em; user-select:none;">';
            html += '<thead><tr style="color:#aaa; border-bottom:1px solid #444;">';
            html += '<th style="text-align:left; padding:4px;">Rang</th>';
            html += '<th style="text-align:left; padding:4px;">Élève</th>';
            html += '<th style="text-align:right; padding:4px;">RDV</th>';
            html += '<th style="text-align:right; padding:4px;">Validé</th>';
            html += '<th style="text-align:right; padding:4px;">En attente</th>';
            html += '<th style="text-align:right; padding:4px;">Annulé/Abs</th>';
            html += '</tr></thead><tbody>';

            if (filteredTopStudents.length === 0) html += '<tr><td colspan="6" style="color:#888; padding:10px;">Aucune activité.</td></tr>';
            filteredTopStudents.forEach((s, idx) => {
                html += `
                <tr style="border-bottom:1px solid #333; cursor:pointer;" onclick="openStatsStudent('${s.name.replace(/'/g, "\\'")}')" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                    <td style="padding:4px;">${idx + 1}</td>
                    <td style="padding:4px;">${s.name}</td>
                    <td style="padding:4px; text-align:right; color:#2196F3;">${s.rdv}</td>
                    <td style="padding:4px; text-align:right; color:#4CAF50;">${s.valide || 0}</td>
                    <td style="padding:4px; text-align:right; color:#FF9800;">${s.attente || 0}</td>
                    <td style="padding:4px; text-align:right; color:#F44336;">${s.annule || 0}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';

            // --- NEW STATS: Top eleves rdv validée ---
            // Prepare Data (Filter & Sort by Validated Count)
            let filteredTopStudentsValidated = topStudents
                .filter(s => matchesLevel(s.cls, currentStatsStudentLevel) && s.valide > 0)
                .sort((a, b) => b.valide - a.valide);
            
            // Calculate total validated RDV BEFORE slicing (for all students in the filtered level)
            let totalValidatedRDV = filteredTopStudentsValidated.reduce((sum, s) => sum + s.valide, 0);
            
            filteredTopStudentsValidated = filteredTopStudentsValidated.slice(0, currentStatsStudentLimit);

            html += '<div class="stats-card" style="margin-top:20px;">';
            html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">';
            html += '<h3 style="margin:0;">🌟 Top eleves rdv validée <span style="font-size:0.8em; color:#4CAF50; font-weight:normal;">(Total: ' + totalValidatedRDV + ')</span></h3>';
            // Reuse same controls functions for simplicity (shared state with main list)
            html += '<div style="display:flex; gap:5px;">';
            html += '<select onchange="setStatsStudentLevel(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px; font-size:0.8em;">';
            html += studentLevelOptionsHtml;
            html += '</select>';
            html += '<select onchange="setStatsStudentLimit(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px; font-size:0.8em;">';
            html += '<option value="10" ' + (currentStatsStudentLimit === 10 ? 'selected' : '') + '>10</option>';
            html += '<option value="20" ' + (currentStatsStudentLimit === 20 ? 'selected' : '') + '>20</option>';
            html += '<option value="50" ' + (currentStatsStudentLimit === 50 ? 'selected' : '') + '>50</option>';
            html += '<option value="100" ' + (currentStatsStudentLimit === 100 ? 'selected' : '') + '>100</option>';
            html += '<option value="9999" ' + (currentStatsStudentLimit === 9999 ? 'selected' : '') + '>Tous</option>';
            html += '</select>';
            html += '</div></div>';

            html += '<div style="font-size:0.8rem; color:#aaa; margin-bottom:10px;">🟢 Classement par RDV Validés</div>';
            html += '<table style="width:100%; border-collapse: collapse; font-size:0.9em; user-select:none;">';
            html += '<thead><tr style="color:#aaa; border-bottom:1px solid #444;">';
            html += '<th style="text-align:left; padding:4px;">Rang</th>';
            html += '<th style="text-align:left; padding:4px;">Élève</th>';
            html += '<th style="text-align:right; padding:4px;">Validé</th>';
            html += '<th style="text-align:right; padding:4px;">Total RDV</th>';
            html += '</tr></thead><tbody>';

            if (filteredTopStudentsValidated.length === 0) html += '<tr><td colspan="4" style="color:#888; padding:10px;">Aucun RDV validé.</td></tr>';
            filteredTopStudentsValidated.forEach((s, idx) => {
                html += `
                <tr style="border-bottom:1px solid #333; cursor:pointer;" onclick="openStatsStudent('${s.name.replace(/'/g, "\\'")}')" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                    <td style="padding:4px;">${idx + 1}</td>
                    <td style="padding:4px;">${s.name}</td>
                    <td style="padding:4px; text-align:right; font-weight:bold; color:#4CAF50;">${s.valide}</td>
                    <td style="padding:4px; text-align:right; color:#aaa;">${s.rdv}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';

            // --- NEW: Color Stats (Priorité des Saisies) ---
            const studentColorAgg = {};
            if (studentWeeklyData) {
                Object.keys(studentWeeklyData).forEach(key => {
                    const entry = studentWeeklyData[key];
                    // key structure: Class_Name_Week
                    const parts = key.split('_');
                    if (parts.length >= 3) { // Enough parts
                        const cls = parts[0];
                        const weekPart = parts[parts.length - 1];
                        const nameParts = parts.slice(1, parts.length - 1);
                        const nameOnly = nameParts.join(' ').replace(/\s*wF$/i, '').trim();
                        const fullName = `${nameOnly} (${cls})`;

                        if (!studentColorAgg[fullName]) {
                            studentColorAgg[fullName] = {
                                name: fullName,
                                cls: cls,
                                rouge: 0, orange: 0, jaune: 0, vert: 0, vert_fonce: 0, total: 0
                            };
                        }

                        const agg = studentColorAgg[fullName];

                        // Helper Tally
                        const processItem = (c, s) => {
                            const color = (c || '').toLowerCase();
                            const status = (s || '').toLowerCase();

                            if (color === 'red') agg.rouge++;
                            else if (color === 'orange') agg.orange++;
                            else if (color === 'yellow') agg.jaune++;
                            else if (color === 'green') agg.vert++;

                            if (status === 'status-darkgreen') agg.vert_fonce++;

                            if (!color && status) {
                                if (status.includes('rouge')) agg.rouge++;
                                if (status.includes('orange')) agg.orange++;
                                if (status.includes('jaune')) agg.jaune++;
                                if (status.includes('vert') && !status.includes('foncé') && !status.includes('status-darkgreen')) agg.vert++;
                            }
                            if (status || color) agg.total++;
                        };

                        // 1. Days (Granular)
                        let hasDays = false;
                        if (entry.days && Object.keys(entry.days).length > 0) {
                            Object.values(entry.days).forEach(d => {
                                if (d.color || d.status) {
                                    processItem(d.color, d.status);
                                    hasDays = true;
                                }
                            });
                        }

                        // 2. Global (Fallback)
                        if (!hasDays) {
                            processItem(entry.color, entry.status);
                        }
                    }
                });
            }

            // EXPORT FOR GRAPHS
            if (window.lastStats) window.lastStats.studentColorAgg = studentColorAgg;

            let topColorStudents = Object.values(studentColorAgg)
                .filter(s => {
                    // Filter by Level
                    if (!matchesLevel(s.cls, currentStatsColorLevel)) return false;
                    return s.total > 0;
                })
                .sort((a, b) => {
                    // Sort Priority: Rouge > Orange > Jaune > Total
                    if (b.rouge !== a.rouge) return b.rouge - a.rouge;
                    if (b.orange !== a.orange) return b.orange - a.orange;
                    if (b.jaune !== a.jaune) return b.jaune - a.jaune;
                    return b.total - a.total;
                })
                .slice(0, currentStatsColorLimit);

            // Generate Level Options Dynamically for Colors
            let colorLevelOptionsHtml = '<option value="all" ' + (currentStatsColorLevel === 'all' ? 'selected' : '') + '>Toutes</option>';
            if (window.availableStatsLevels) {
                window.availableStatsLevels.forEach(lvl => {
                    let label = lvl;
                    if (/^\d+$/.test(lvl) && parseInt(lvl) <= 10) {
                        if (parseInt(lvl) === 1) label = 'Première';
                        else if (parseInt(lvl) === 2) label = 'Seconde';
                        else label += 'ème';
                    }
                    colorLevelOptionsHtml += `<option value="${lvl}" ${currentStatsColorLevel == lvl ? 'selected' : ''}>${label}</option>`;
                });
            } else {
                ['6', '5', '4', '3'].forEach(lvl => {
                    colorLevelOptionsHtml += `<option value="${lvl}" ${currentStatsColorLevel == lvl ? 'selected' : ''}>${lvl}ème</option>`;
                });
            }

            // --- ADDED: Specific Classes ---
            if (appData.classes) {
                colorLevelOptionsHtml += '<optgroup label="Classes">';
                Object.keys(appData.classes).sort().forEach(cls => {
                    colorLevelOptionsHtml += `<option value="${cls}" ${currentStatsColorLevel == cls ? 'selected' : ''}>${cls}</option>`;
                });
                colorLevelOptionsHtml += '</optgroup>';
            }

            html += '<div class="stats-card">';
            html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">';
            html += '<h3 style="margin:0;">⚠️ Statistiques Priorité des Saisies</h3>';
            html += `<div style="display:flex; gap:5px;">
                <select onchange="setStatsColorLevel(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px; font-size:0.8em;">
                    ${colorLevelOptionsHtml}
                </select>
                <select onchange="setStatsColorLimit(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px; font-size:0.8em;">
                    <option value="10" ${currentStatsColorLimit === 10 ? 'selected' : ''}>10</option>
                    <option value="20" ${currentStatsColorLimit === 20 ? 'selected' : ''}>20</option>
                    <option value="50" ${currentStatsColorLimit === 50 ? 'selected' : ''}>50</option>
                    <option value="100" ${currentStatsColorLimit === 100 ? 'selected' : ''}>100</option>
                    <option value="9999" ${currentStatsColorLimit === 9999 ? 'selected' : ''}>Tous</option>
                </select>
            </div>`;
            html += '</div>';

            html += '<table style="width:100%; border-collapse: collapse; font-size:0.9em; user-select:none;">';
            html += '<thead><tr style="color:#aaa; border-bottom:1px solid #444;">';
            html += '<th style="text-align:left; padding:4px;">Élève</th>';
            html += '<th style="text-align:center; padding:4px;">🔴</th>';
            html += '<th style="text-align:center; padding:4px;">🟠</th>';
            html += '<th style="text-align:center; padding:4px;">🟡</th>';
            html += '<th style="text-align:center; padding:4px;">🟢</th>';
            html += '<th style="text-align:center; padding:4px;">🌲</th>';
            html += '<th style="text-align:right; padding:4px; font-weight:bold;">Total</th>';
            html += '</tr></thead><tbody>';

            if (topColorStudents.length === 0) html += '<tr><td colspan="7" style="color:#888; padding:10px;">Aucune donnée.</td></tr>';

            topColorStudents.forEach(s => {
                html += `
                <tr style="border-bottom:1px solid #333; cursor:pointer;" onclick="openStatsStudent('${s.name.replace(/'/g, "\\'")}')" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                    <td style="padding:4px;">${s.name}</td>
                    <td style="padding:4px; text-align:center; color:#F44336; font-weight:${s.rouge > 0 ? 'bold' : 'normal'};">${s.rouge}</td>
                    <td style="padding:4px; text-align:center; color:#FF9800; font-weight:${s.orange > 0 ? 'bold' : 'normal'};">${s.orange}</td>
                    <td style="padding:4px; text-align:center; color:#FFD700; font-weight:${s.jaune > 0 ? 'bold' : 'normal'};">${s.jaune}</td>
                    <td style="padding:4px; text-align:center; color:#4CAF50;">${s.vert}</td>
                    <td style="padding:4px; text-align:center; color:#006400;">${s.vert_fonce}</td>
                    <td style="padding:4px; text-align:right; color:white; font-weight:bold;">${s.total}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';


            // Population Stats (Existing logic maintained)
            // ... (Re-calculate basic pop stats for display) ...
            let totalStudentsPop = 0;
            let totalClassesPop = 0;
            if (appData.students) {
                Object.keys(appData.students).forEach(cls => {
                    if (matchesLevel(cls, currentStatsLevel)) {
                        totalClassesPop++;
                        totalStudentsPop += Object.keys(appData.students[cls]).length;
                    }
                });
            }
            // Calc visits for p1,p2,p3
            const studentVisits = {};
            // We can reuse studentAgg or recalculate purely for population % logic which uses specific filters
            // Let's stick to original 'events' based logic for consistency with previous feature
            events.forEach(r => {
                if (r.students && Array.isArray(r.students)) {
                    r.students.forEach(s => {
                        const m = s.match(/\(([^)]+)\)$/);
                        const clsName = m ? m[1] : '';
                        if (matchesLevel(clsName, currentStatsLevel)) {
                            studentVisits[s] = (studentVisits[s] || 0) + 1;
                        }
                    });
                }
            });


            // Correction : inclure tous les élèves importés dans la population, même ceux avec 0 RDV
            let s0 = 0, s1 = 0, s2 = 0, s3 = 0, s4_6 = 0, s7_plus = 0;
            let list0 = [], list1 = [], list2 = [], list3 = [], list4_6 = [], list7_plus = [];

            // Générer la liste complète des élèves (clé: NOM Prénom (Classe))
            let allStudentKeys = [];
            if (appData.students) {
                Object.keys(appData.students).forEach(cls => {
                    Object.values(appData.students[cls]).forEach(s => {
                        allStudentKeys.push(`${s.nom} ${s.prenom} (${s.classe})`);
                    });
                });
            }

            allStudentKeys.forEach(sKey => {
                const v = studentVisits[sKey] || 0;
                const item = { name: sKey, count: v };
                if (v === 0) { s0++; list0.push(item); }
                else if (v === 1) { s1++; list1.push(item); }
                else if (v === 2) { s2++; list2.push(item); }
                else if (v === 3) { s3++; list3.push(item); }
                else if (v >= 4 && v < 7) { s4_6++; list4_6.push(item); }
                else if (v >= 7) { s7_plus++; list7_plus.push(item); }
            });

            // EXPORT FOR GRAPHS
            if (window.lastStats) {
                window.lastStats.population = {
                    s0: { count: s0, label: '0 RDV' },
                    s1: { count: s1, label: '1 RDV' },
                    s2: { count: s2, label: '2 RDV' },
                    s3: { count: s3, label: '3 RDV' },
                    s4_6: { count: s4_6, label: '4-6 RDV' },
                    s7_plus: { count: s7_plus, label: '7+ RDV' }
                };
            }

            // Expose lists globally for the modal
            window.statsPopulationLists = {
                '0': list0,
                '1': list1,
                '2': list2,
                '3': list3,
                '4-6': list4_6,
                '7+': list7_plus
            };

            let p1 = totalStudentsPop ? Math.round(s1 / totalStudentsPop * 100) : 0;
            let p2 = totalStudentsPop ? Math.round(s2 / totalStudentsPop * 100) : 0;
            let p3 = totalStudentsPop ? Math.round(s3 / totalStudentsPop * 100) : 0;
            let p4_6 = totalStudentsPop ? Math.round(s4_6 / totalStudentsPop * 100) : 0;
            let p7_plus = totalStudentsPop ? Math.round(s7_plus / totalStudentsPop * 100) : 0;

            // Generate Level Options Dynamically for Population
            // REQ: Dans "statistique" "population" ne garder que "tous"
            let popLevelOptionsHtml = '<option value="all" selected>Tous</option>';
            // Previous dynamic generation removed to enforce "Tous" only.


            // ADD CLASSES TO POPULATION SELECTOR - DISABLED AS PER REQUEST (ONLY TOUS)
            if (false && appData.classes) {
                popLevelOptionsHtml += '<optgroup label="Classes">';
                Object.keys(appData.classes).sort().forEach(cls => {
                    popLevelOptionsHtml += `<option value="${cls}" ${currentStatsLevel == cls ? 'selected' : ''}>${cls}</option>`;
                });
                popLevelOptionsHtml += '</optgroup>';
            }

            html += '<div class="stats-card">';
            html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">';
            html += '<h3>👥 Population</h3>';
            html += `
                <select onchange="setStatsLevel(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px;">
                    ${popLevelOptionsHtml}
                </select>
            `;
            html += '</div>';
            html += `<div style="font-size:0.9em; margin-bottom:5px;">Total: <b>${totalStudentsPop}</b> élèves / <b>${totalClassesPop}</b> classes</div>`;
            html += createBar('0 RDV', s0, totalStudentsPop, '#607D8B', `${s0} (${totalStudentsPop ? Math.round(s0 / totalStudentsPop * 100) : 0}%)`, "showPopulationList('0')");
            html += createBar('1 RDV', s1, totalStudentsPop, '#2196F3', `${s1} (${p1}%)`, "showPopulationList('1')");
            html += createBar('2 RDV', s2, totalStudentsPop, '#9C27B0', `${s2} (${p2}%)`, "showPopulationList('2')");
            html += createBar('3 RDV', s3, totalStudentsPop, '#FF9800', `${s3} (${p3}%)`, "showPopulationList('3')");
            html += createBar('4 à 6 RDV', s4_6, totalStudentsPop, '#F44336', `${s4_6} (${p4_6}%)`, "showPopulationList('4-6')");
            html += createBar('7+ RDV', s7_plus, totalStudentsPop, '#000', `${s7_plus} (${p7_plus}%)`, "showPopulationList('7+')");
            html += `<div style="margin-top:10px; text-align:right; font-size:0.9em; color:#aaa;">Total RDV: <b>${stats.total_RDV}</b></div>`;
            html += '</div>';

            // --- NEW: Rubriques Stats ---
            let totalRubrics = 0;
            const rubricCounts = {}; // { name: { count:0, students: Set } }

            // NEW: Simplified Rubric Stats - Filter only manual rubrics
            const addRubricCount = (name, studentKey, type = 'custom') => {
                const rName = (name || 'Sans titre').trim();
                if (!rubricCounts[rName]) rubricCounts[rName] = { count: 0, students: new Set() };
                rubricCounts[rName].count++;
                rubricCounts[rName].students.add(studentKey);
                totalRubrics++;
            };

            // 2. Process Custom Rubriques (Only)
            if (appData.customRubriques) {
                Object.keys(appData.customRubriques).forEach(studentKey => {
                    let displayKey = studentKey;
                    const parts = studentKey.split('_');
                    if (parts.length >= 3) displayKey = `${parts.slice(1).join(' ')} (${parts[0]})`;

                    (appData.customRubriques[studentKey] || []).forEach(rub => {
                        addRubricCount(rub.name, displayKey, 'custom');
                    });
                });
            }

            // EXPORT FOR GRAPHS
            if (window.lastStats) window.lastStats.rubricCounts = rubricCounts;

            const topRubrics = Object.entries(rubricCounts)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, currentStatsRubricLimit);

            // Removed topWords calculation 

            // --- NEW: RDV Stats Calculation ---
            const rdvWeekStats = {};
            const rdvMonthStats = {};

            // Initialize all months of "School Year" if Year view
            if (currentStatsRange === 'year') {
                const year = new Date(currentStatsDate).getFullYear();

                // Determine School Year based on current stats date
                const m = new Date(currentStatsDate).getMonth();
                let startYear = (m < 8) ? year - 1 : year; // If Jan-Aug, school year started prev year. If Sept-Dec, started this year.

                // Generate Sept (8) to Dec (11) of startYear
                for (let mon = 8; mon <= 11; mon++) {
                    const d = new Date(startYear, mon, 1);
                    const mKey = `${startYear}-${(mon + 1).toString().padStart(2, '0')}`;
                    const mLabel = d.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                    rdvMonthStats[mKey] = { label: mLabel, valid: 0, pending: 0, absent: 0, total: 0 };
                }
                // Generate Jan (0) to July (6) of startYear + 1
                for (let mon = 0; mon <= 6; mon++) {
                    const d = new Date(startYear + 1, mon, 1);
                    const mKey = `${startYear + 1}-${(mon + 1).toString().padStart(2, '0')}`;
                    const mLabel = d.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                    rdvMonthStats[mKey] = { label: mLabel, valid: 0, pending: 0, absent: 0, total: 0 };
                }
            }

            // Removed fixed schoolStartCalc to support multi-year / old databases

            (events || []).forEach(r => {
                const d = new Date(r.date);

                // Determine School Year for this specific event date
                // If before Sept 1st, it belongs to the previous calendar calculation cycle usually, 
                // but effectively we want to align it with a Sept-start calendar.
                // If month is Jan-Aug (0-7), school start was Sept of prev year.
                // If month is Sept-Dec (8-11), school start is Sept of current year.
                let sYear = d.getFullYear();
                if (d.getMonth() < 8) sYear--;

                const localSchoolStart = new Date(sYear, 8, 1);

                const diffDays = Math.floor((d - localSchoolStart) / (1000 * 60 * 60 * 24));
                let weekIdx = Math.floor(diffDays / 7);
                if (weekIdx < 0) weekIdx = 0;

                let wLabel = '?';
                if (typeof CALENDAR_DATA !== 'undefined' && CALENDAR_DATA.weeks && CALENDAR_DATA.weeks[weekIdx]) {
                    wLabel = CALENDAR_DATA.weeks[weekIdx];
                } else {
                    wLabel = 'S' + (weekIdx + 1);
                }

                // Week
                if (!rdvWeekStats[wLabel]) rdvWeekStats[wLabel] = { valid: 0, pending: 0, absent: 0, total: 0 };
                rdvWeekStats[wLabel].total++;
                if (r.status === 'validated') rdvWeekStats[wLabel].valid++;
                else if (r.status === 'cancelled') rdvWeekStats[wLabel].absent++;
                else rdvWeekStats[wLabel].pending++;

                // Month
                const mKey = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                const mLabel = d.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

                if (!rdvMonthStats[mKey]) rdvMonthStats[mKey] = { label: mLabel, valid: 0, pending: 0, absent: 0, total: 0 };
                rdvMonthStats[mKey].total++;
                if (r.status === 'validated') rdvMonthStats[mKey].valid++;
                else if (r.status === 'cancelled') rdvMonthStats[mKey].absent++;
                else rdvMonthStats[mKey].pending++;
            });

            // EXPORT FOR GRAPHS
            if (window.lastStats) {
                window.lastStats.rdvWeekStats = rdvWeekStats;
                window.lastStats.rdvMonthStats = rdvMonthStats;
            }

            // Adjusted grid to 5 columns to align (Week, Month, Rubrics, Words, Days)

            // --- NEW: "Motifs fréquents de convocation" ALONE on a line BEFORE the grid ---
            let sortedMotifs = Object.entries(stats.motifs);

            // Filter by search query if exists
            if (currentMotifSearchQuery && currentMotifSearchQuery.trim() !== "") {
                const q = currentMotifSearchQuery.toLowerCase();
                sortedMotifs = sortedMotifs.filter(([m, c]) => m.toLowerCase().includes(q));
            }

            sortedMotifs = sortedMotifs.sort((a, b) => b[1] - a[1]).slice(0, 50);

            html += '<div class="stats-card" style="margin-bottom:20px;">';

            // Header with Search Button/Input
            html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">';
            html += '<h3 style="margin:0;">📌 Motifs fréquents de convocation</h3>';
            html += '<div style="display:flex; gap:5px; align-items:center;">';
            html += `<input id="motifSearchInput" type="text" placeholder="Recherche..." 
                        value="${currentMotifSearchQuery.replace(/"/g, '&quot;')}" 
                        oninput="updateMotifSearch(this.value)" 
                        style="background:#333; color:white; border:1px solid #555; padding:4px 8px; border-radius:3px; font-size:0.85em; width:150px;">`;
            html += '<button style="background:var(--primary-color); border:none; color:white; padding:4px 8px; border-radius:3px; cursor:pointer;" title="Rechercher">🔍</button>';
            html += '</div>';
            html += '</div>';

            html += '<div style="background:#2a2a2a; padding:10px; border-radius:4px; max-height:300px; overflow-y:auto;">';
            // Display as List (Rubriques Model)
            html += '<ul id="motifsList" style="list-style:none; padding:0; margin:0; font-size:0.85em;">';
            if (sortedMotifs.length === 0) {
                html += '<li style="color:#666; width:100%;">Aucun motif trouvé.</li>';
            } else {
                sortedMotifs.forEach(([m, count]) => {
                    html += `<li style="padding:5px 0; color:#ddd; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                        <span style="cursor:pointer; flex:1;" onclick="openMotifDetails('${m.replace(/'/g, "\\'")}')">
                            <b>${count}</b> - ${m}
                        </span>
                    </li>`;
                });
            }
            html += '</ul></div>';
            html += '</div>';

            // --- GRID: Row 1 (3 items) ---

            html += '<div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:20px;">';

            // CARD 1: RDV Stats
            html += '<div class="stats-card">';
            html += '<h3 style="margin:0; margin-bottom:10px;">📅 RDV par Semaine</h3>';
            html += '<div style="max-height:300px; overflow-y:auto;"><table style="width:100%; border-collapse:collapse; font-size:0.85em;">';
            html += '<thead><tr style="border-bottom:1px solid #444; color:#aaa;">';
            html += '<th style="text-align:left; padding:4px;">Sem.</th>';
            html += '<th style="text-align:center; padding:4px;">✅ Val.</th>';
            html += '<th style="text-align:center; padding:4px;">⏳ Att.</th>';
            html += '<th style="text-align:center; padding:4px;">❌ Abs.</th>';
            html += '<th style="text-align:right; padding:4px;">Total</th>';
            html += '</tr></thead><tbody>';

            if (typeof CALENDAR_DATA !== 'undefined' && CALENDAR_DATA.weeks) {
                CALENDAR_DATA.weeks.forEach(w => {
                    if (rdvWeekStats[w]) {
                        const stow = rdvWeekStats[w];
                        html += `<tr style="border-bottom:1px solid #333;">
                            <td style="padding:4px; font-weight:bold;">${w}</td>
                            <td style="padding:4px; text-align:center; color:#4CAF50;">${stow.valid}</td>
                            <td style="padding:4px; text-align:center; color:#FF9800;">${stow.pending}</td>
                            <td style="padding:4px; text-align:center; color:#F44336;">${stow.absent}</td>
                            <td style="padding:4px; text-align:right;">${stow.total}</td>
                         </tr>`;
                    }
                });
            } else {
                Object.keys(rdvWeekStats).forEach(w => {
                    const stow = rdvWeekStats[w];
                    html += `<tr style="border-bottom:1px solid #333;">
                        <td style="padding:4px; font-weight:bold;">${w}</td>
                        <td style="padding:4px; text-align:center; color:#4CAF50;">${stow.valid}</td>
                        <td style="padding:4px; text-align:center; color:#FF9800;">${stow.pending}</td>
                        <td style="padding:4px; text-align:center; color:#F44336;">${stow.absent}</td>
                        <td style="padding:4px; text-align:right;">${stow.total}</td>
                     </tr>`;
                });
            }

            html += '</tbody></table></div>';
            html += '</div>';

            // CARD 2: RDV Stats (Month)
            html += '<div class="stats-card">';
            html += '<h3 style="margin:0; margin-bottom:10px;">📅 RDV par Mois</h3>';
            html += '<div style="max-height:300px; overflow-y:auto;"><table style="width:100%; border-collapse:collapse; font-size:0.85em;">';
            html += '<thead><tr style="border-bottom:1px solid #444; color:#aaa;">';
            html += '<th style="text-align:left; padding:4px;">Mois</th>';
            html += '<th style="text-align:center; padding:4px;">✅ Val.</th>';
            html += '<th style="text-align:center; padding:4px;">⏳ Att.</th>';
            html += '<th style="text-align:center; padding:4px;">❌ Abs.</th>';
            html += '<th style="text-align:right; padding:4px;">Total</th>';
            html += '</tr></thead><tbody>';

            Object.keys(rdvMonthStats).sort().forEach(mKey => {
                const stom = rdvMonthStats[mKey];
                // Filter: Show only if > 0 RDV AND Month is within Sept-July (Exclude August '08')
                if (stom.total === 0) return;
                if (mKey.endsWith('-08')) return; // Explicitly exclude August based on "Sept to July" request

                html += `<tr style="border-bottom:1px solid #333;">
                    <td style="padding:4px; font-weight:bold;">${stom.label}</td>
                    <td style="padding:4px; text-align:center; color:#4CAF50;">${stom.valid}</td>
                    <td style="padding:4px; text-align:center; color:#FF9800;">${stom.pending}</td>
                    <td style="padding:4px; text-align:center; color:#F44336;">${stom.absent}</td>
                    <td style="padding:4px; text-align:right;">${stom.total}</td>
                 </tr>`;
            });

            html += '</tbody></table></div>';
            html += '</div>';

            html += '<div class="stats-card">';

            // Header with Limit Selector
            html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">';
            html += '<h3 style="margin:0;">� Statistique Rubriques</h3>';
            html += `
                <select onchange="setStatsRubricLimit(this.value)" style="background:#333; color:white; border:1px solid #555; padding:2px; border-radius:3px; font-size:0.8em;">
                    <option value="10" ${currentStatsRubricLimit === 10 ? 'selected' : ''}>10</option>
                    <option value="20" ${currentStatsRubricLimit === 20 ? 'selected' : ''}>20</option>
                    <option value="50" ${currentStatsRubricLimit === 50 ? 'selected' : ''}>50</option>
                    <option value="100" ${currentStatsRubricLimit === 100 ? 'selected' : ''}>100</option>
                </select>
            `;
            html += '</div>';

            html += `<div style="font-size:0.9em; margin-bottom:10px;">
                Total créer: <b>${totalRubrics}</b>
            </div>`;

            html += '<div style="display:flex; flex-direction:column; gap:10px;">';

            // Top Rubriques List
            html += '<div style="background:#2a2a2a; padding:10px; border-radius:4px; max-height:300px; overflow-y:auto;">';
            if (topRubrics.length === 0) html += '<span style="color:#666;">Aucune rubrique personnalisée.</span>';
            html += '<ul style="list-style:none; padding:0; margin:0; font-size:0.85em;">';
            topRubrics.forEach(([name, data]) => {
                const studentList = Array.from(data.students);
                html += `<li style="padding:2px 0; color:#ddd; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                        <span style="cursor:pointer; flex:1;" onclick="openRubricDetails('${name.replace(/'/g, "\\'")}')" title="Voir les élèves">
                            <b>${data.count}</b> - ${name}
                        </span>
                        <button onclick="if(confirm('Supprimer définitivement la rubrique \\'${name.replace(/'/g, "\\'")}\\' pour TOUS les élèves ?')) deleteRubricGlobal('${name.replace(/'/g, "\\'")}')" 
                                style="background:none; border:none; color:#F44336; cursor:pointer; font-weight:bold; font-size:1.1em;" title="Supprimer la rubrique">
                            🗑
                        </button>
                    </li>`;
            });
            html += '</ul></div>';

            html += '</div>'; // End flex col
            html += '</div>'; // End Stats Card

            html += '</div>'; // Close Top Grid (3 items)

            // --- GRID: Row 2 (2 items - wider) ---
            html += '<div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:20px;">';

            // CARD 4: Mots les plus utilisés
            const topWords = Object.entries(stats.frequentWords || {}).sort((a, b) => b[1] - a[1]).slice(0, 50);
            html += '<div class="stats-card">';
            html += '<h3 style="margin:0; margin-bottom:10px;">💬 Mots fréquents</h3>';
            html += '<div style="background:#2a2a2a; padding:10px; border-radius:4px; max-height:300px; overflow-y:auto;">';
            html += '<ul style="list-style:none; padding:0; margin:0; font-size:0.85em;">';
            if (topWords.length === 0) {
                html += '<li style="color:#666;">Pas de données.</li>';
            } else {
                topWords.forEach(([word, count]) => {
                    html += `<li style="padding:2px 0; color:#ddd; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                         <span style="cursor:pointer; flex:1;" onclick="openMotifDetails('${word.replace(/'/g, "\\'")}')" title="Voir les élèves concernés par '${word}'">
                             <b>${count}</b> - ${word}
                         </span>
                     </li>`;
                });
            }
            html += '</ul></div>';
            html += '</div>';

            // CARD 5: Jours les plus actifs
            const topDays = Object.entries(stats.busyDays || {}).sort((a, b) => b[1] - a[1]).slice(0, 50);
            html += '<div class="stats-card">';
            html += '<h3 style="margin:0; margin-bottom:10px;">📅 Jours actifs</h3>';
            html += '<div style="background:#2a2a2a; padding:10px; border-radius:4px; max-height:300px; overflow-y:auto;">';
            html += '<ul style="list-style:none; padding:0; margin:0; font-size:0.85em;">';
            if (topDays.length === 0) {
                html += '<li style="color:#666;">Pas de données.</li>';
            } else {
                topDays.forEach(([day, count]) => {
                    // Convert YYYY-MM-DD to friendly date
                    const d = new Date(day);
                    const friendly = d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
                    html += `<li style="padding:2px 0; color:#ddd; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                         <span style="cursor:pointer; flex:1;" onclick="openDayDetails('${day}')" title="Voir les RDV du ${friendly}">
                             <b>${count}</b> - ${friendly}
                         </span>
                     </li>`;
                });
            }
            html += '</ul></div>';
            html += '</div>';

            html += '</div>'; // Close Grid 5 columns



            // Graphique Button (Icon) moved strictly to bottom
            html += `
            <div style="margin-top:30px; margin-bottom: 20px; display: flex; justify-content: center;">
                <button onclick="toggleGraphView()" style="background:var(--bg-secondary); border:2px solid var(--primary-color); color:var(--primary-color); padding:10px 20px; border-radius:30px; font-size:1.2rem; display:flex; align-items:center; gap:10px; cursor:pointer; box-shadow:0 0 15px rgba(0,242,255,0.1); transition:all 0.2s;">
                    <span>📊</span> Afficher / Masquer les Graphiques
                </button>
            </div>
            `;


            // Canvas Containers
            html += `
            <div id="graph-container" style="display:none; margin-top:20px; padding:15px; border:1px solid #444; border-radius:10px; background:rgba(0,0,0,0.3);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                    <h3 style="margin:0; color:var(--primary-color);">📊 Visualisation Graphique</h3>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button onclick="openGraphDataSelector()" style="background:#444; color:white; border:1px solid #666; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.9em;">Choix des données pour le graphique</button>
                        <select id="graphSource" onchange="drawCharts()" style="padding:5px 10px; background:#333; color:white; border:1px solid var(--primary-color); border-radius:4px;">
                            <option value="status">Statut RDV global</option>
                            <option value="population">Population (Fréquence RDV)</option>
                            <option value="rdv_week">Évolution RDV par Semaine</option>
                            <option value="rubrics">Top Rubriques</option>
                            <option value="motifs">Motifs Fréquents</option>
                            <option value="colors">Priorité Saisies (Couleurs)</option>
                        </select>
                        
                        <select id="graphType" onchange="drawCharts()" style="padding:5px 10px; background:#333; color:white; border:1px solid var(--primary-color); border-radius:4px;">
                            <option value="pie">Camembert</option>
                            <option value="bar">Barres</option>
                            <option value="doughnut">Donut</option>
                            <option value="line">Ligne</option>
                            <option value="radar">Radar</option>
                            <option value="polarArea">Polaire</option>
                        </select>
                    </div>
                </div>
                
                <div style="height:400px; position:relative; display:flex; justify-content:center; align-items:center;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            `;

            content.innerHTML = html;

            // Restore scroll position
            requestAnimationFrame(() => {
                if (content) content.scrollTop = savedScrollTop;
            });
        }

        // ===== SYNTHÈSE ANNUELLE (SEMAINES 36→26) =====

        function openAnnualSummaryModal() {
            document.getElementById('annualSummaryModal').style.display = 'flex';
            resetSummaryModal();
        }

        // Fonction pour réouvrir la synthèse si nécessaire après fermeture fiche élève
        window.openAnnualSummaryFromSheet = function () {
            document.getElementById('annualSummaryModal').style.display = 'flex';
        };

        function resetSummaryModal() {
            document.getElementById('summary-options-main').style.display = 'block';
            document.getElementById('summary-options-class').style.display = 'none';
            document.getElementById('summary-options-student').style.display = 'none';
        }

        function showSummaryClassSelection() {
            document.getElementById('summary-options-main').style.display = 'none';
            document.getElementById('summary-options-class').style.display = 'block';
            const select = document.getElementById('summary-class-select');
            select.innerHTML = '';
            Object.keys(appData.classes).sort().forEach(cls => {
                const opt = document.createElement('option');
                opt.value = cls;
                opt.textContent = cls;
                select.appendChild(opt);
            });
        }

        function confirmSummaryClass() {
            const cls = document.getElementById('summary-class-select').value;
            if (cls) {
                printAnnualSummary({ type: 'class', className: cls });
                document.getElementById('annualSummaryModal').style.display = 'none';
            }
        }

        function showSummaryStudentSearch() {
            document.getElementById('summary-options-main').style.display = 'none';
            document.getElementById('summary-options-student').style.display = 'block';
            document.getElementById('summary-student-search').value = '';
            document.getElementById('summary-search-results').innerHTML = '';
            document.getElementById('summary-student-search').focus();
        }

        function performSummarySearch() {
            const rawQuery = document.getElementById('summary-student-search').value.toLowerCase();
            // Split by spaces, filter empty, take max 3 terms
            const terms = rawQuery.split(/\s+/).filter(t => t.length > 0).slice(0, 3);

            const container = document.getElementById('summary-search-results');
            container.innerHTML = '';

            // Require at least one term with 2+ chars to start searching
            if (terms.length === 0 || (terms.length === 1 && terms[0].length < 2)) return;

            Object.keys(appData.classes).forEach(cls => {
                if (appData.classes[cls].students) {
                    appData.classes[cls].students.forEach(key => {
                        const student = appData.students[cls][key];
                        if (student) {
                            // Include class name in search
                            const searchableText = `${student.nom} ${student.prenom} ${cls}`.toLowerCase();

                            // Check if ALL terms are present (AND logic)
                            const match = terms.every(term => searchableText.includes(term));

                            if (match) {
                                const div = document.createElement('div');
                                div.style.cssText = 'padding:8px; border-bottom:1px solid #444; cursor:pointer; color:#ddd;';
                                div.onmouseover = () => div.style.background = '#333';
                                div.onmouseout = () => div.style.background = 'transparent';
                                div.textContent = `${student.nom} ${student.prenom} (${cls})`;
                                div.onclick = () => {
                                    printAnnualSummary({ type: 'student', className: cls, studentKey: key });
                                    document.getElementById('annualSummaryModal').style.display = 'none';
                                };
                                container.appendChild(div);
                            }
                        }
                    });
                }
            });
        }
        // Fonction appelée depuis la fenêtre de synthèse annuelle (popup)
        window.openStudentWeekFromSummary = function (className, nom, prenom, weekId) {
            window.focus(); // Bring main window to front
            console.log(`Ouverture depuis synthèse: ${className} ${nom} ${prenom} S${weekId}`);

            // Reconstruire la clé élève
            const studentKey = `${className}_${nom}_${prenom}`;

            // Trouver l'élève dans appData
            if (appData.students && appData.students[className] && appData.students[className][studentKey]) {
                const student = appData.students[className][studentKey];

                // Ouvrir la fiche élève
                openStudentSheet(student);

                // Flag to indicate we came from summary (for closing behavior)
                document.getElementById('studentSheetModal').dataset.origin = 'summary';

                // Sélectionner la semaine demandée
                // Petit délai pour laisser le temps au DOM de se mettre à jour si nécessaire
                setTimeout(() => {
                    selectWeekInSheet(weekId, student);
                }, 100);
            } else {
                alert("Élève introuvable dans les données actuelles.");
            }
        };

        function printAnnualSummary(filter = { type: 'all' }) {
            const weeks = [36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26];

            let titleSuffix = "";
            if (filter.type === 'class') titleSuffix = ` - Classe ${filter.className}`;
            if (filter.type === 'student') titleSuffix = ` - Élève Unique`;

            // Dynamic font sizes for Single Student view
            const isStudent = (filter.type === 'student');
            const s = {
                body: isStudent ? '14px' : '11px',
                h1: isStudent ? '28px' : '24px',
                p: isStudent ? '14px' : '12px',
                title: isStudent ? '16px' : '13px',
                name: isStudent ? '18px' : '12px',
                cell: isStudent ? '11px' : '8px',
                notes: isStudent ? '12px' : '9px'
            };

            let html = `
            <!DOCTYPE html>
                <html>
                    <head>
                        <meta charset="utf-8">
                            <title>Synthèse Annuelle${titleSuffix}</title>
                            <style>
                                * {margin: 0; padding: 0; }
                                body {font-family: Arial, sans-serif; font-size: ${s.body}; line-height: 1.3; }
                                .page {page-break-after: always; padding: 20px; }
                                .header {text-align: center; margin-bottom: 20px; border-bottom: 3px solid #000; padding-bottom: 10px; }
                                .header h1 {font-size: ${s.h1}; margin-bottom: 5px; }
                                .header p {font-size: ${s.p}; color: #666; }
                                .classe-section {margin-bottom: 25px; }
                                .classe-title {background: #2E5090; color: white; padding: 8px; font-weight: bold; font-size: ${s.title}; margin-bottom: 10px; }
                                .student-section {margin-bottom: 15px; padding: 8px; background: #f5f5f5; border-left: 4px solid #2E5090; }
                                .student-name {font-weight: bold; font-size: ${s.name}; margin-bottom: 5px; }
                                .weeks {display: flex; flex-wrap: wrap; gap: 3px; margin-bottom: 8px; }
                                .week-cell {width: 25px; height: 25px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: ${s.cell}; background: white; }
                                .week-cell.present {background: #90EE90; }
                                .week-cell.absent {background: #FFB6C1; }
                                .week-cell.unknown {background: #FFE4B5; }
                                .notes {font-size: ${s.notes}; padding: 5px; background: white; border: 1px solid #ddd; margin-top: 5px; max-height: 40px; overflow: hidden; }
                                @media print {
                                    .no-print { display: none !important; }
                                }
                                .print-btn {
                                    position: fixed; top: 20px; right: 20px; 
                                    padding: 10px 20px; background: #4CAF50; color: white; 
                                    border: none; border-radius: 5px; font-weight: bold; 
                                    cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                                    z-index: 1000;
                                }
                                .print-btn:hover { background: #45a049; }
                                .close-btn {
                                    position: fixed; top: 20px; right: 260px; 
                                    padding: 10px 20px; background: #f44336; color: white; 
                                    border: none; border-radius: 5px; font-weight: bold; 
                                    cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                                    z-index: 1000;
                                }
                                .close-btn:hover { background: #d32f2f; }
                            </style>
                    </head>
                    <body>
                        <button class="close-btn no-print" onclick="window.close()">❌ FERMER</button>
                        <button class="print-btn no-print" onclick="window.print()">🖨️ IMPRIMER LA SYNTHÈSE</button>
                        <div class="header">
                            <h1>📊 SYNTHÈSE ANNUELLE${titleSuffix}</h1>
                            <p>Année scolaire ${appData.schoolYear}-${appData.schoolYear + 1}</p>
                            <p>Semaines 36 à 26 (43 semaines)</p>
                        </div>
                        `;

            // Determine which classes to process
            let classesToProcess = [];
            if (filter.type === 'class') {
                if (appData.classes[filter.className]) classesToProcess = [filter.className];
            } else if (filter.type === 'student') {
                if (appData.classes[filter.className]) classesToProcess = [filter.className];
            } else {
                classesToProcess = Object.keys(appData.classes).sort();
            }

            // Parcourir les classes
            classesToProcess.forEach(className => {
                // --- CALCULATE CLASS STATISTICS ---
                let classTotal = 0;
                let classRed = 0;
                let classOrange = 0;
                let classYellow = 0;
                let classGreen = 0;

                if (appData.classes[className].students) {
                    appData.classes[className].students.forEach(studentKey => {
                        const studentData = appData.students[className] && appData.students[className][studentKey];
                        if (studentData) {
                            weeks.forEach(w => {
                                const dataKey = `${className}_${studentData.nom}_${studentData.prenom}_w${w}`;
                                const data = studentWeeklyData[dataKey] || appData.weeklyReports[dataKey];
                                if (data) {
                                    const hasNote = (data.notes && data.notes.trim().length > 0);
                                    const hasStatus = (data.status && data.status.length > 0);
                                    if (hasNote || hasStatus) {
                                        classTotal++;
                                        if (data.color === 'red') classRed++;
                                        if (data.color === 'orange') classOrange++;
                                        if (data.color === 'yellow') classYellow++;
                                        if (data.color === 'green') classGreen++;
                                    }
                                }
                            });
                        }
                    });
                }

                const classStatsHtml = `
                    <div style="margin-bottom:15px; padding:10px; background:#e3f2fd; border:1px solid #90caf9; border-radius:5px; display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
                        <div style="font-weight:bold; font-size:1.1rem; color:#1565c0;">BILAN CLASSE: ${classTotal} saisies</div>
                        <div style="display:flex; gap:10px;">
                            <span style="color:#d32f2f; font-weight:bold;">🔴 ${classRed}</span>
                            <span style="color:#f57c00; font-weight:bold;">🟠 ${classOrange}</span>
                            <span style="color:#fbc02d; font-weight:bold;">🟡 ${classYellow}</span>
                            <span style="color:#388e3c; font-weight:bold;">🟢 ${classGreen}</span>
                        </div>
                    </div>
                `;

                html += `<div class="classe-section">
                    <div class="classe-title">${className}</div>
                    ${classStatsHtml}`;

                // Parcourir tous les élèves de la classe
                if (appData.classes[className].students) {
                    appData.classes[className].students.forEach(studentKey => {
                        // Filter for single student if needed
                        if (filter.type === 'student' && studentKey !== filter.studentKey) return;
                        const studentData = appData.students[className] && appData.students[className][studentKey];
                        if (studentData) {
                            // Calculate total entries for this student (for display next to name)
                            let studentTotalEntries = 0;
                            weeks.forEach(w => {
                                const dataKey = `${className}_${studentData.nom}_${studentData.prenom}_w${w}`;
                                const data = studentWeeklyData[dataKey] || appData.weeklyReports[dataKey];
                                if (data && ((data.notes && data.notes.trim().length > 0) || (data.status && data.status.length > 0))) {
                                    studentTotalEntries++;
                                }
                            });

                            // --- STATS CALCULATION FOR SINGLE STUDENT ---
                            let statsHtml = '';
                            if (filter.type === 'student') {
                                let totalChecked = 0;
                                let countRed = 0;
                                let countOrange = 0;
                                let countYellow = 0;
                                let countGreen = 0;
                                const wordCounts = {};
                                const stopWords = new Set(['le', 'la', 'les', 'de', 'du', 'des', 'un', 'une', 'et', 'à', 'il', 'elle', 'ce', 'se', 'que', 'qui', 'dans', 'en', 'pour', 'par', 'sur', 'pas', 'ne', 'au', 'aux', 'est', 'sont', 'a', 'ont', 'mais', 'ou', 'donc', 'or', 'ni', 'car', 'avec', 'sans', 'sous', 'mon', 'ton', 'son', 'ma', 'ta', 'sa', 'mes', 'tes', 'ses', 'notre', 'votre', 'leur', 'nos', 'vos', 'leurs', 'je', 'tu', 'nous', 'vous', 'ils', 'elles', 'cette', 'ces', 'cet']);

                                weeks.forEach(w => {
                                    const dataKey = `${className}_${studentData.nom}_${studentData.prenom}_w${w}`;
                                    const data = studentWeeklyData[dataKey] || appData.weeklyReports[dataKey];
                                    if (data) {
                                        const hasNote = (data.notes && data.notes.trim().length > 0);
                                        const hasStatus = (data.status && data.status.length > 0);

                                        if (hasNote || hasStatus) {
                                            totalChecked++;
                                            if (data.color === 'red') countRed++;
                                            if (data.color === 'orange') countOrange++;
                                            if (data.color === 'yellow') countYellow++;
                                            if (data.color === 'green') countGreen++;

                                            // Collect text from Main Note
                                            let textToAnalyze = "";
                                            if (hasNote) {
                                                textToAnalyze += " " + data.notes;
                                            }

                                            // Collect text from "Nouvelle Rubrique" (Custom Rubric)
                                            if (appData.customRubriques && appData.customRubriques[studentKey]) {
                                                const customRubrics = appData.customRubriques[studentKey];
                                                const targetName = "nouvelle rubrique";
                                                // Find rubric for this week
                                                const matchingRubric = customRubrics.find(r =>
                                                    (r.name && r.name.toLowerCase() === targetName) &&
                                                    (r.weekId == w)
                                                );
                                                if (matchingRubric && matchingRubric.content) {
                                                    textToAnalyze += " " + matchingRubric.content;
                                                }
                                            }

                                            if (textToAnalyze.trim().length > 0) {
                                                // Tokenize and count words
                                                const words = textToAnalyze.toLowerCase()
                                                    .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ")
                                                    .split(/\s+/);

                                                words.forEach(word => {
                                                    if (word.length > 2 && !stopWords.has(word)) {
                                                        wordCounts[word] = (wordCounts[word] || 0) + 1;
                                                    }
                                                });
                                            }
                                        }
                                    }
                                });

                                // Get top 3 words
                                const topWords = Object.entries(wordCounts)
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 3)
                                    .map(entry => `${entry[0]} (${entry[1]})`)
                                    .join(', ');

                                statsHtml = `
                                    <div style="margin-bottom:15px; padding:10px; background:#fff; border:1px solid #ccc; border-radius:5px; display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
                                        <div style="font-weight:bold; font-size:1.1rem;">TOTAL SAISIES: ${totalChecked}</div>
                                        <div style="display:flex; gap:10px;">
                                            <span style="color:#d32f2f; font-weight:bold;">🔴 Rouge: ${countRed}</span>
                                            <span style="color:#f57c00; font-weight:bold;">🟠 Orange: ${countOrange}</span>
                                            <span style="color:#fbc02d; font-weight:bold;">🟡 Jaune: ${countYellow}</span>
                                            <span style="color:#388e3c; font-weight:bold;">🟢 Vert: ${countGreen}</span>
                                        </div>
                                        ${topWords ? `<div style="margin-left:auto; font-style:italic; color:#555;">Mots fréquents: <strong>${topWords}</strong></div>` : ''}
                                    </div>
                                `;
                            }

                            html += `<div class="student-section">
                                <div class="student-name">${studentData.nom} ${studentData.prenom} <span style="font-weight:normal; font-size:0.8em; color:#666;">(${studentTotalEntries} saisies)</span></div>
                                ${statsHtml}
                                <div class="weeks">`;

                            // Afficher les statuts pour chaque semaine
                            weeks.forEach(w => {
                                const dataKey = `${className}_${studentData.nom}_${studentData.prenom}_w${w}`;
                                // Use studentWeeklyData directly as it is the runtime source of truth
                                const data = studentWeeklyData[dataKey] || appData.weeklyReports[dataKey];
                                let statusClass = 'unknown';
                                let content = `S${w}`;
                                let cellStyle = '';

                                if (data) {
                                    const hasNote = (data.notes && data.notes.trim().length > 0);
                                    const hasStatus = (data.status && data.status.length > 0);

                                    if (hasNote || hasStatus) {
                                        statusClass = 'present'; // Green if any data
                                        content += ' ✓';
                                    }

                                    // Specific status override if needed (optional)
                                    if (data.status === 'status-red') statusClass = 'absent';

                                    // Apply color code
                                    if (data.color) {
                                        if (data.color === 'red') cellStyle = 'background:#ff4444; color:white; border-color:#cc0000;';
                                        if (data.color === 'orange') cellStyle = 'background:#ffbb33; color:black; border-color:#ff8800;';
                                        if (data.color === 'yellow') cellStyle = 'background:#ffeb3b; color:black; border-color:#fbc02d;';
                                        if (data.color === 'green') cellStyle = 'background:#00C851; color:white; border-color:#007E33;';
                                    }
                                }

                                // Interaction: Double-click to open student sheet in NEW TAB
                                let dblClickAttr = '';
                                if (statusClass !== 'unknown') {
                                    const safeClass = encodeURIComponent(className);
                                    const safeNom = encodeURIComponent(studentData.nom);
                                    const safePrenom = encodeURIComponent(studentData.prenom);

                                    // Utiliser window.open pour ouvrir un nouvel onglet avec des paramètres
                                    // URL: page actuelle + ?action=openSheet&class=...&nom=...&prenom=...&week=...
                                    const url = window.location.href.split('?')[0] + `?action=openSheet&class=${safeClass}&nom=${safeNom}&prenom=${safePrenom}&week=${w}`;

                                    // Merge cursor pointer into existing style
                                    const finalStyle = cellStyle + ' cursor:pointer;';
                                    dblClickAttr = `ondblclick="window.open('${url}', '_blank');" style="${finalStyle}"`;
                                } else {
                                    dblClickAttr = `style="${cellStyle}"`;
                                }

                                html += `<div class="week-cell ${statusClass}" ${dblClickAttr} title="S${w}">${content}</div>`;
                            });

                            html += `</div>`;

                            if (filter.type === 'student') {
                                // --- FULL HISTORY FOR SINGLE STUDENT ---
                                html += '<div style="margin-top:20px;">';
                                html += '<h3 style="border-bottom:2px solid #ccc; padding-bottom:5px; margin-bottom:15px;">Historique Détaillé</h3>';

                                weeks.forEach(w => {
                                    const dataKey = `${className}_${studentData.nom}_${studentData.prenom}_w${w}`;
                                    const data = studentWeeklyData[dataKey] || appData.weeklyReports[dataKey];

                                    // Check for Custom Rubric "nouvelle rubrique"
                                    let customRubricContent = "";
                                    if (appData.customRubriques && appData.customRubriques[studentKey]) {
                                        const customRubrics = appData.customRubriques[studentKey];
                                        const targetName = "nouvelle rubrique";
                                        const matchingRubric = customRubrics.find(r =>
                                            (r.name && r.name.toLowerCase() === targetName) &&
                                            (r.weekId == w)
                                        );
                                        if (matchingRubric && matchingRubric.content) {
                                            customRubricContent = matchingRubric.content;
                                        }
                                    }

                                    if (data && ((data.notes && data.notes.trim().length > 0) || (data.status && data.status.length > 0) || customRubricContent)) {
                                        let colorStyle = "border-left: 5px solid #ccc;";
                                        let colorName = "Aucune";
                                        if (data.color === 'red') { colorStyle = "border-left: 5px solid #d32f2f; background:#ffebee;"; colorName = "Rouge"; }
                                        if (data.color === 'orange') { colorStyle = "border-left: 5px solid #f57c00; background:#fff3e0;"; colorName = "Orange"; }
                                        if (data.color === 'yellow') { colorStyle = "border-left: 5px solid #fbc02d; background:#fffde7;"; colorName = "Jaune"; }
                                        if (data.color === 'green') { colorStyle = "border-left: 5px solid #388e3c; background:#e8f5e9;"; colorName = "Vert"; }

                                        let statusText = "";
                                        if (data.status === 'status-darkgreen') statusText = "Présent";
                                        if (data.status === 'status-yellow') statusText = "Absent prévu";
                                        if (data.status === 'status-red') statusText = "Absent";
                                        if (data.status === 'status-blue') statusText = "Autre";

                                        let timestampHtml = '';
                                        // Restore Creation/Saisie timestamp AND add Date d'effet
                                        if (data.createdTimestamp) {
                                            timestampHtml += `<div>Créé le : ${data.createdTimestamp}</div>`;
                                        } else if (data.timestamp) {
                                            timestampHtml += `<div>Saisi le : ${data.timestamp}</div>`;
                                        }

                                        // Calculate Effective Dates
                                        let effectiveDatesHtml = '';

                                        // 1. Check for specific days in data.days
                                        if (data.days && Object.keys(data.days).length > 0) {
                                            const daysIndices = Object.keys(data.days).sort((a, b) => parseInt(a) - parseInt(b));

                                            // Collecting unique dates to avoid duplicates if multiple entries somehow exist (though unlikely with this structure)
                                            const datesList = [];
                                            daysIndices.forEach(idx => {
                                                const dObj = data.days[idx];
                                                // Only consider if there is content
                                                if (dObj.notes || dObj.status) {
                                                    const effDate = getDateFromWeekId(w, parseInt(idx));
                                                    if (effDate) {
                                                        const formatted = effDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                                                        datesList.push(formatted);
                                                    }
                                                }
                                            });

                                            if (datesList.length > 0) {
                                                datesList.forEach(dStr => {
                                                    effectiveDatesHtml += `<div>Date d'effet : ${dStr}</div>`;
                                                });
                                            }
                                        }

                                        // 2. Fallback: If no specific days found (or empty), use Monday of the week (Global entry)
                                        if (!effectiveDatesHtml) {
                                            const mondayDate = getDateFromWeekId(w, 0);
                                            if (mondayDate) {
                                                const formattedDate = mondayDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                                                effectiveDatesHtml = `<div>Date d'effet : ${formattedDate}</div>`;
                                            }
                                        }

                                        timestampHtml += effectiveDatesHtml;

                                        html += `
                                            <div style="margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:4px; ${colorStyle}">
                                                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:5px; font-weight:bold;">
                                                    <span>Semaine ${w}</span>
                                                    <div style="font-size:0.8em; color:#555; text-align:right; font-weight:normal; font-style:italic;">${timestampHtml}</div>
                                                </div>
                                                ${statusText ? `<div style="font-size:0.9em; margin-bottom:5px;"><strong>Statut:</strong> ${statusText}</div>` : ''}
                                                ${data.notes ? `<div style="white-space:pre-wrap; margin-top:5px;">${data.notes}</div>` : ''}
                                                ${customRubricContent ? `<div style="margin-top:8px; padding-top:8px; border-top:1px dashed #ccc;"><strong style="color:#555;">Nouvelle Rubrique:</strong> <div style="white-space:pre-wrap;">${customRubricContent}</div></div>` : ''}
                                            </div>
                                        `;
                                    }
                                });
                                html += '</div>';

                            } else {
                                // --- RECENT NOTES FOR CLASS VIEW (Original Logic) ---
                                // Ajouter les notes des dernières semaines
                                // Use studentWeeklyData for notes as well
                                const recentWeeks = [26, 25, 24, 23, 22];
                                let hasNotes = false;
                                let notesHtml = '<div class="notes"><strong>Notes récentes:</strong> ';

                                recentWeeks.forEach(w => {
                                    const dataKey = `${className}_${studentData.nom}_${studentData.prenom}_w${w}`;
                                    const data = studentWeeklyData[dataKey] || appData.weeklyReports[dataKey];
                                    if (data && data.notes) {
                                        notesHtml += `<strong>S${w}:</strong> ${data.notes.substring(0, 50)}... `;
                                        hasNotes = true;
                                    }
                                });

                                if (hasNotes) {
                                    html += notesHtml + '</div>';
                                }
                            }

                            html += `</div>`;
                        }
                    });
                }

                html += `</div>`;
            });

            html += `
                    <div style="text-align: center; margin-top: 30px; font-size: 10px; color: #999;">
                        Généré le ${new Date().toLocaleString('fr-FR')}
                    </div>
                </body>
                </html >
            `;

            const win = window.open('', 'AnnualSummary');
            win.document.write(html);
            win.document.close();
            win.focus();
            // setTimeout(() => win.print(), 500); // REMOVED: Manual print button added
        }

        // --- DAILY VIEW (SKELLO STYLE) ---
        function renderDailyView(date) {
            // Remove existing modal if any
            const existing = document.getElementById('dailyViewModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'dailyViewModal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:#121212; z-index:20000; display:flex; flex-direction:column; color:#fff; font-family: "Segoe UI", sans-serif;';

            const dateStr = date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Calculate Week Number (ISO 8601)
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);

            // Header
            const header = document.createElement('div');
            header.style.cssText = 'padding:20px; background:#1e1e1e; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;';

            // Navigation Buttons
            const prevBtn = `<button id="daily-prev-btn" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer; padding:0 15px;">&#10094;</button>`;
            const nextBtn = `<button id="daily-next-btn" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer; padding:0 15px;">&#10095;</button>`;

            header.innerHTML = `
                <div style="display:flex; align-items:center;">
                    ${prevBtn}
                    <div>
                        <h2 style="margin:0; text-transform:capitalize; color:var(--primary-color); font-size:1.8rem;">${dateStr}</h2>
                        <div style="color:#aaa; font-size:1rem; font-weight:bold;">Semaine ${weekNo}</div>
                    </div>
                    ${nextBtn}
                </div>
                <div style="display:flex; gap:15px;">
                    <button onclick="printDailyView()" style="padding:10px 20px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:1rem;">🖨️ Imprimer</button>
                    <button onclick="document.getElementById('dailyViewModal').remove()" style="padding:10px 20px; background:#444; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:1rem;">Fermer</button>
                </div>
            `;
            modal.appendChild(header);

            // Content (Scrollable)
            const content = document.createElement('div');
            content.id = 'dailyViewContent';
            content.style.cssText = 'flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px; background:#121212;';

            // Prepare events for this day
            const dayEvents = [];
            if (typeof studentWeeklyData !== 'undefined') {
                Object.keys(studentWeeklyData).forEach(key => {
                    const entry = studentWeeklyData[key];
                    // NEW LOGIC: Use EFFECTIVE DATE for Daily View (Ignore Timestamp/Creation Date for *Placement*)
                    const lastUnderscore = key.lastIndexOf('_w');
                    if (lastUnderscore <= 0) return;

                    const weekId = key.substring(lastUnderscore + 2);
                    let namePart = key.substring(0, lastUnderscore);
                    let className = null;
                    let fullStudentKey = namePart;
                    let name = namePart.replace(/_/g, ' ');

                    // Extract Class Name
                    const firstUnderscore = namePart.indexOf('_');
                    if (firstUnderscore > 0) {
                        className = namePart.substring(0, firstUnderscore);
                        name = namePart.substring(firstUnderscore + 1).replace(/_/g, ' ');
                    }

                    // Determine Effective Dates
                    const effectiveDates = [];

                    // Time Fallback (from timestamp or default 8:00)
                    let h = 8, min = 0;
                    if (entry.timestamp) {
                        const parts = entry.timestamp.split(' ');
                        if (parts.length > 1) {
                            const timeParts = parts[1].split(':');
                            if (timeParts.length >= 2) {
                                h = parseInt(timeParts[0]);
                                min = parseInt(timeParts[1]);
                            }
                        }
                    }

                    if (entry.days && Object.keys(entry.days).length > 0) {
                        Object.keys(entry.days).forEach(dIdx => {
                            const dObj = entry.days[dIdx];
                            if (dObj.notes || dObj.status) {
                                const effDate = getDateFromWeekId(weekId, parseInt(dIdx));
                                if (effDate) effectiveDates.push({ date: effDate, notes: dObj.notes, status: dObj.status });
                            }
                        });
                    } else if (entry.notes || entry.status) {
                        let dayIndex = 0; // Default to Monday
                        if (entry.timestamp) {
                            const parts = entry.timestamp.split(' ');
                            if (parts.length > 0) {
                                const dParts = parts[0].split('/');
                                if (dParts.length === 3) {
                                    const tDate = new Date(parseInt(dParts[2]), parseInt(dParts[1]) - 1, parseInt(dParts[0]));
                                    let jsDay = tDate.getDay();
                                    let weekDayIdx = jsDay - 1;
                                    if (weekDayIdx === -1) weekDayIdx = 6;
                                    dayIndex = weekDayIdx;
                                }
                            }
                        }
                        const effDate = getDateFromWeekId(weekId, dayIndex);
                        if (effDate) effectiveDates.push({ date: effDate, notes: entry.notes, status: entry.status });
                    }

                    // Check for match with View Date
                    effectiveDates.forEach(eff => {
                        if (eff.date.getFullYear() === date.getFullYear() &&
                            eff.date.getMonth() === date.getMonth() &&
                            eff.date.getDate() === date.getDate()) {

                            dayEvents.push({
                                name: name,
                                hour: h,
                                minute: min,
                                status: eff.status,
                                color: entry.color,
                                notes: eff.notes,
                                weekId: weekId,
                                studentKey: fullStudentKey,
                                className: className,
                                fullKey: key
                            });
                        }
                    });
                });
            }

            // Generate Timeline 08:00 - 20:00
            for (let h = 8; h <= 20; h++) {
                const row = document.createElement('div');
                row.className = 'daily-row';
                row.style.cssText = 'display:flex; border-bottom:1px solid #333; min-height:80px;';

                // Time Column
                const timeCol = document.createElement('div');
                timeCol.style.cssText = 'width:80px; border-right:2px solid var(--primary-color); padding:10px; font-weight:bold; color:#888; font-size:1.2rem; display:flex; align-items:flex-start; justify-content:center;';
                timeCol.textContent = `${h}h00`;
                row.appendChild(timeCol);

                // Events Column
                const eventsCol = document.createElement('div');
                eventsCol.style.cssText = 'flex:1; padding:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;';

                // Find events for this hour
                const hourEvents = dayEvents.filter(e => e.hour === h);
                hourEvents.forEach(ev => {
                    const card = document.createElement('div');
                    card.style.cssText = 'background:rgba(0, 242, 255, 0.15); border-left:4px solid var(--primary-color); padding:8px 15px; border-radius:4px; color:#fff; min-width:200px; box-shadow:0 2px 5px rgba(0,0,0,0.2); cursor:pointer; transition: transform 0.1s;';
                    card.onmouseover = () => card.style.transform = 'scale(1.02)';
                    card.onmouseout = () => card.style.transform = 'scale(1)';

                    // Color Logic: Priority to 'color' (weekColor), then 'status'
                    let borderColor = 'var(--primary-color)';
                    if (ev.color) {
                        if (ev.color === 'red') borderColor = '#ff4444';
                        else if (ev.color === 'orange') borderColor = '#ffbb33';
                        else if (ev.color === 'yellow') borderColor = '#ffeb3b';
                        else if (ev.color === 'green') borderColor = '#00C851';
                    } else if (ev.status) {
                        if (ev.status === 'status-red') borderColor = 'red';
                        else if (ev.status === 'status-orange') borderColor = 'orange';
                        else if (ev.status === 'status-yellow') borderColor = 'yellow';
                        else if (ev.status === 'status-darkgreen') borderColor = 'green';
                    }
                    card.style.borderLeftColor = borderColor;

                    const timeStr = `${ev.hour}h${ev.minute.toString().padStart(2, '0')}`;
                    const classDisplay = ev.className ? ` <span style="font-size:0.8em; color:#ccc; font-weight:normal;">(${ev.className})</span>` : '';
                    card.innerHTML = `<div style="font-weight:bold; font-size:1.1rem;">${ev.name}${classDisplay}</div><div style="font-size:0.85rem; color:#aaa;">${timeStr}</div>`;

                    // Click Handler (Instant open)
                    card.onclick = (e) => {
                        e.stopPropagation();
                        if (ev.fullStudentKey && ev.className && appData.students[ev.className] && appData.students[ev.className][ev.fullStudentKey]) {
                            const student = appData.students[ev.className][ev.fullStudentKey];
                            openStudentSheet(student, null, ev.weekId);
                        } else {
                            alert("Fiche élève introuvable.");
                        }
                    };

                    eventsCol.appendChild(card);
                });

                row.appendChild(eventsCol);
                content.appendChild(row);
            }

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Attach Navigation Handlers
            document.getElementById('daily-prev-btn').onclick = () => {
                const prevDate = new Date(date);
                prevDate.setDate(date.getDate() - 1);
                renderDailyView(prevDate);
            };
            document.getElementById('daily-next-btn').onclick = () => {
                const nextDate = new Date(date);
                nextDate.setDate(date.getDate() + 1);
                renderDailyView(nextDate);
            };
        }

        function printDailyView() {
            const title = document.querySelector('#dailyViewModal h2').textContent;

            let printHtml = `
                <html>
                <head>
                    <title>Journalier - ${title}</title>
                    <style>
                        body { font-family: 'Segoe UI', sans-serif; padding: 20px; color: #000; }
                        h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; text-transform: capitalize; }
                        .row { display: flex; border-bottom: 1px solid #ddd; min-height: 50px; page-break-inside: avoid; }
                        .time { width: 60px; font-weight: bold; border-right: 2px solid #333; padding: 10px; }
                        .content { flex: 1; padding: 5px 10px; display: flex; flex-wrap: wrap; gap: 10px; }
                        .card { border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; background: #f9f9f9; border-left-width: 4px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
            `;

            // Re-iterate rows from DOM
            const rows = document.querySelectorAll('#dailyViewContent > div');
            rows.forEach(row => {
                const timeText = row.children[0].textContent;
                const events = row.children[1].children;

                printHtml += `<div class="row"><div class="time">${timeText}</div><div class="content">`;

                Array.from(events).forEach(ev => {
                    const name = ev.children[0].textContent;
                    const time = ev.children[1].textContent;
                    // Get border color from inline style
                    const borderColor = ev.style.borderLeftColor || '#000';

                    printHtml += `<div class="card" style="border-left-color:${borderColor}">
                        <strong>${name}</strong><br><span style="font-size:0.8em;color:#666">${time}</span>
                    </div>`;
                });

                printHtml += `</div></div>`;
            });

            printHtml += `</body></html>`;

            const w = window.open('', '_blank');
            w.document.write(printHtml);
            w.document.close();
            setTimeout(() => w.print(), 500);
        }

        // --- POPULATION LIST MODAL LOGIC ---
        let currentPopulationListType = '';

        function showPopulationList(type) {
            const list = window.statsPopulationLists ? window.statsPopulationLists[type] : [];
            if (!list || list.length === 0) {
                alert('Aucun élève dans cette catégorie.');
                return;
            }
            currentPopulationListType = type;

            const titleEl = document.getElementById('popListTitle');
            if (titleEl) titleEl.textContent = `Liste Élèves (${type} RDV) - ${list.length}`;

            const container = document.getElementById('popListContainer');
            if (container) {
                container.innerHTML = '';

                // Group by Class
                const groups = {};
                list.forEach(item => {
                    // Extract class from name (Format: "Name (Class)")
                    const m = (item.name || item).match(/\(([^)]+)\)$/);
                    const cls = m ? m[1] : 'Autre';
                    if (!groups[cls]) groups[cls] = [];
                    groups[cls].push(item);
                });

                const sortedClasses = Object.keys(groups).sort();

                sortedClasses.forEach(cls => {
                    const groupList = groups[cls];

                    // Header for Class with Count
                    const header = document.createElement('div');
                    header.style.cssText = 'padding:10px; background:#1a1a1a; border-bottom:1px solid #444; color:var(--primary-color); font-weight:bold; margin-top:0; position:sticky; top:0;';
                    header.textContent = `Classe ${cls} (${groupList.length} élèves)`;
                    container.appendChild(header);

                    const ul = document.createElement('ul');
                    ul.style.listStyle = 'none';
                    ul.style.padding = '0';
                    ul.style.margin = '0';

                    // Sort items in group
                    groupList.sort((a, b) => {
                        const nameA = a.name || a;
                        const nameB = b.name || b;
                        return nameA.localeCompare(nameB);
                    }).forEach(item => {
                        const studentKey = item.name || item;
                        const count = item.count;

                        const li = document.createElement('li');
                        li.style.padding = '8px 15px';
                        li.style.borderBottom = '1px solid #333';
                        li.style.cursor = 'pointer';
                        li.style.display = 'flex';
                        li.style.justifyContent = 'space-between';
                        li.style.color = '#ddd';
                        li.onmouseover = () => li.style.background = '#333';
                        li.onmouseout = () => li.style.background = 'transparent';

                        li.innerHTML = `<span>${studentKey}</span> <span style="font-weight:bold; color:var(--primary-color);">(${count} RDV) ➔</span>`;
                        li.onclick = () => {
                            if (window.openStatsStudent) window.openStatsStudent(studentKey);
                        };
                        ul.appendChild(li);
                    });
                    container.appendChild(ul);
                });
            }

            const modal = document.getElementById('populationListModal');
            if (modal) modal.style.display = 'flex';
        }

        function closePopulationListModal() {
            const modal = document.getElementById('populationListModal');
            if (modal) modal.style.display = 'none';
        }

        function printPopulationList() {
            const list = window.statsPopulationLists ? window.statsPopulationLists[currentPopulationListType] : [];
            if (!list || list.length === 0) return;

            let html = `<html><head><title>Liste Population ${currentPopulationListType} RDV</title>`;
            html += `<style>
                body { font-family: sans-serif; padding: 20px; }
                h2 { border-bottom: 2px solid #ccc; padding-bottom: 10px; }
                ul { list-style: none; padding: 0; }
                li { padding: 8px 0; border-bottom: 1px solid #eee; }
            </style></head><body>`;

            html += `<h2>Liste Élèves - ${currentPopulationListType} RDV (${list.length})</h2>`;
            html += `<ul>`;

            // Sort to match display
            list.sort((a, b) => {
                if (a.count && b.count && b.count !== a.count) return b.count - a.count;
                const nameA = a.name || a;
                const nameB = b.name || b;
                return nameA.localeCompare(nameB);
            }).forEach(item => {
                const name = item.name || item;
                const count = item.count ? `(${item.count} RDV)` : '';
                html += `<li>${name} <b>${count}</b></li>`;
            });
            html += `</ul></body></html>`;

            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
            setTimeout(() => w.print(), 500);
        }

        // --- SIDEBAR RESIZE LOGIC ---
        const sidebar = document.getElementById('studentSidebar');
        const resizer = document.getElementById('sidebarResizer');
        let isResizingSidebar = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizingSidebar = true;
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizingSidebar) return;
            // Calculate new width relative to container start/sidebar left
            // Simple approach: e.clientX since sidebar is on left
            const newWidth = e.clientX - sidebar.getBoundingClientRect().left;
            if (newWidth > 200 && newWidth < 800) {
                sidebar.style.width = newWidth + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizingSidebar) {
                isResizingSidebar = false;
                document.body.style.cursor = 'default';
            }
        });

        // --- MOTIF DETAILS LOGIC ---
        let currentMotifStudents = []; // Array of { event: rdvObject, studentName: string }
        let currentMotifName = "";
        let currentListType = 'motif'; // 'motif' or 'rubric'

        function openRubricDetails(rubricName) {
            currentMotifName = rubricName;
            currentMotifStudents = [];
            currentListType = 'rubric';

            if (appData.customRubriques) {
                Object.keys(appData.customRubriques).forEach(studentKey => {
                    const rubrics = appData.customRubriques[studentKey] || [];
                    if (rubrics.some(r => (r.name || 'Sans titre').trim() === rubricName)) {
                        let displayKey = studentKey;
                        const parts = studentKey.split('_');
                        if (parts.length >= 3) displayKey = `${parts.slice(1).join(' ')} (${parts[0]})`;

                        currentMotifStudents.push({
                            studentName: displayKey,
                            selected: false,
                            rawKey: studentKey // Store raw key for direct access if needed
                        });
                    }
                });
            }

            // Show Modal (Reuse Motif Modal)
            const modal = document.getElementById('motifListModal');
            if (modal) {
                document.getElementById('motifListTitle').textContent = `📚 Rubrique: ${rubricName} (${currentMotifStudents.length} élèves)`;
                modal.style.display = 'flex';
                renderMotifList();
            }
        }

        function openDayDetails(dayKey) {
            currentMotifName = new Date(dayKey).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            currentMotifStudents = [];
            currentListType = 'day';

            const isInRange = (dDate) => {
                const s = new Date(dayKey); s.setHours(0, 0, 0, 0);
                const e = new Date(dayKey); e.setHours(23, 59, 59, 999);
                return dDate >= s && dDate <= e;
            };

            const searchInput = document.getElementById('statsSearchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            (appData.rdv || []).forEach(r => {
                if (searchTerm) {
                    const title = (r.title || '').toLowerCase();
                    const desc = (r.description || '').toLowerCase();
                    const students = (r.students || []).join(' ').toLowerCase();
                    if (!title.includes(searchTerm) && !desc.includes(searchTerm) && !students.includes(searchTerm)) return;
                }

                if (!r.date) return;
                const dDate = new Date(r.date);
                if (!isInRange(dDate)) return;

                if (r.students && Array.isArray(r.students)) {
                    r.students.forEach(s => {
                        currentMotifStudents.push({ event: r, studentName: s, selected: false });
                    });
                }
            });

            const modal = document.getElementById('motifListModal');
            if (modal) {
                document.getElementById('motifListTitle').textContent = `📅  ${currentMotifName} (${currentMotifStudents.length} élèves)`;
                modal.style.display = 'flex';
                renderMotifList();
            }
        }

        function openMotifDetails(motifName) {
            currentMotifName = motifName;
            currentMotifStudents = [];
            currentListType = 'motif';

            // 1. Re-run date filtering to match renderStats logic
            const now = new Date(currentStatsDate);
            let startDate, endDate;
            if (currentStatsRange === 'day') {
                startDate = new Date(now); startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now); endDate.setHours(23, 59, 59, 999);
            } else if (currentStatsRange === 'week') {
                const d = new Date(now);
                const day = d.getDay() || 7;
                d.setHours(-24 * (day - 1));
                startDate = new Date(d); startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate); endDate.setDate(endDate.getDate() + 7);
            } else if (currentStatsRange === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            } else if (currentStatsRange === 'year') {
                // School Year Logic (Sept-July)
                const m = now.getMonth();
                const y = now.getFullYear();
                let startYear = (m < 8) ? y - 1 : y;
                let endYear = (m < 8) ? y : y + 1;
                startDate = new Date(startYear, 8, 1); // 1st Sept
                endDate = new Date(endYear, 6, 31, 23, 59, 59); // 31st July
            }
            const isInRange = (dDate) => dDate >= startDate && dDate <= endDate;

            const searchInput = document.getElementById('statsSearchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            (appData.rdv || []).forEach(r => {
                // Apply Search Filter from Stats
                if (searchTerm) {
                    const title = (r.title || '').toLowerCase();
                    const desc = (r.description || '').toLowerCase();
                    const students = (r.students || []).join(' ').toLowerCase();
                    if (!title.includes(searchTerm) && !desc.includes(searchTerm) && !students.includes(searchTerm)) return;
                }

                if (!r.date) return;
                const dDate = new Date(r.date);
                if (!isInRange(dDate)) return;

                // Check Motif (Flexible for Words)
                const title = (r.title || '').toLowerCase();
                const desc = (r.description || '').toLowerCase();
                const search = motifName.toLowerCase();

                if (title.includes(search) || desc.includes(search)) {
                    if (r.students && Array.isArray(r.students)) {
                        r.students.forEach(s => {
                            currentMotifStudents.push({ event: r, studentName: s, selected: false });
                        });
                    }
                }
            });

            // Show Modal
            const modal = document.getElementById('motifListModal');
            if (modal) {
                document.getElementById('motifListTitle').textContent = `📌 Motif: ${motifName} (${currentMotifStudents.length} élèves)`;
                modal.style.display = 'flex';
                renderMotifList();
            }
        }

        function renderMotifList() {
            const container = document.getElementById('motifListContainer');
            if (!container) return;
            container.innerHTML = '';

            if (currentMotifStudents.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Aucun élève trouvé pour ce filtre.</div>';
                return;
            }

            const ul = document.createElement('ul');
            ul.style.listStyle = 'none';
            ul.style.padding = '0';
            ul.style.margin = '0';

            currentMotifStudents.forEach((item, index) => {
                const li = document.createElement('li');
                li.style.padding = '8px';
                li.style.borderBottom = '1px solid #333';
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                li.style.gap = '10px';
                li.style.color = '#ddd';
                li.style.background = item.selected ? 'rgba(33, 150, 243, 0.2)' : 'transparent';

                // Checkbox
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = item.selected;
                cb.onclick = (e) => { e.stopPropagation(); item.selected = cb.checked; renderMotifList(); };

                // Student Link
                const span = document.createElement('span');
                span.textContent = item.studentName;
                span.style.cursor = 'pointer';
                span.style.flex = '1';
                span.style.textDecoration = 'underline';
                span.style.color = 'var(--primary-color)';
                span.onclick = (e) => {
                    e.stopPropagation();
                    // Flag we are coming from Motif List
                    window.returnToMotifList = true;

                    // Handle Rubric Key which might be formatted "Name (Class)" or just use rawKey if available
                    let nameToOpen = item.studentName;

                    // If it's a rubric entry and we have a rawKey (e.g. 6B_Nom_Prenom), we should probably use that or ensure openStatsStudent can handle it.
                    // openStatsStudent expects "Nom Prénom (Class)" or "Nom Prénom".
                    // currentMotifStudents for rubrics sets studentName as "Nom Prénom (Class)".

                    if (window.openStatsStudent) window.openStatsStudent(nameToOpen);
                };

                if (currentListType === 'motif' && item.event && item.event.date) {
                    const dateSpan = document.createElement('span');
                    dateSpan.textContent = new Date(item.event.date).toLocaleDateString('fr-FR');
                    dateSpan.style.color = '#888';
                    dateSpan.style.fontSize = '0.85em';
                    li.appendChild(dateSpan);
                }

                li.appendChild(cb);
                li.appendChild(span);
                // Date span appended conditionally above
                ul.appendChild(li);
            });
            container.appendChild(ul);
        }

        function toggleMotifSelection(state) {
            currentMotifStudents.forEach(item => item.selected = state);
            renderMotifList();
        }

        function editMotifForSelected() {
            const selected = currentMotifStudents.filter(i => i.selected);
            if (selected.length === 0) {
                alert('Veuillez sélectionner au moins un élève.');
                return;
            }

            const newMotif = prompt(`Modifier le motif pour ${selected.length} entrées ?\nNouveau motif :`, currentMotifName);
            if (newMotif !== null && newMotif.trim() !== "") {
                const finalMotif = newMotif.trim();
                let count = 0;
                // Update events
                selected.forEach(item => {
                    if (item.event.description !== finalMotif) {
                        item.event.description = finalMotif;
                        count++;
                    }
                });

                if (count > 0) {
                    saveAppData();
                    alert(`${count} entrées mises à jour.`);
                    document.getElementById('motifListModal').style.display = 'none';
                    renderStats(); // Refresh stats
                } else {
                    alert("Aucune modification nécessaire.");
                }
            }
        }

        function printMotifList() {
            if (currentMotifStudents.length === 0) return;

            let html = `<html><head><title>Motif: ${currentMotifName}</title>`;
            html += `<style>
                body { font-family: sans-serif; padding: 20px; }
                h2 { border-bottom: 2px solid #ccc; padding-bottom: 10px; }
                ul { list-style: none; padding: 0; }
                li { padding: 8px 0; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; }
            </style></head><body>`;

            html += `<h2>Motif: "${currentMotifName}" (${currentMotifStudents.length} élèves)</h2>`;
            html += `<ul>`;
            currentMotifStudents.forEach(item => {
                html += `<li><span>${item.studentName}</span> <span>${new Date(item.event.date).toLocaleDateString('fr-FR')}</span></li>`;
            });
            html += `</ul></body></html>`;

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            win.print();
        }

        function printAgenda() {
            const grid = document.getElementById('agendaGrid');
            const monthDisplay = document.getElementById('agendaMonthDisplay');
            if (!grid || !monthDisplay) {
                alert("Erreur: Agenda introuvable.");
                return;
            }

            const title = "Agenda des Saisies - " + monthDisplay.textContent.trim();
            const cells = Array.from(grid.children);

            let gridHtml = '';

            cells.forEach(cell => {
                // Clone existing cell to capture filled data
                const clone = cell.cloneNode(true);

                // Simple heuristics to improve print visibility
                // 1. Force date number to black
                const dateDiv = clone.querySelector('div');
                if (dateDiv) {
                    dateDiv.style.color = '#000';
                    dateDiv.style.fontWeight = 'bold';
                }

                // 2. Entries (assuming they are divs following dateDiv)
                // We keep their background colors but ensure text is readable?
                // Usually they are sized small. We might want to let them expand.

                gridHtml += `<div class="print-cell">${clone.innerHTML}</div>`;
            });

            const html = `
            <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; color: #000; background:#fff; }
                        h1 { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        
                        .header-row { 
                            display: grid; 
                            grid-template-columns: repeat(7, 1fr); 
                            background: #eee; 
                            border: 1px solid #ccc; 
                            font-weight: bold;
                        }
                        .header-row div { padding: 10px; text-align: center; border-right: 1px solid #ddd; }
                        .header-row div:last-child { border-right: none; }

                        .print-grid { 
                            display: grid; 
                            grid-template-columns: repeat(7, 1fr); 
                            border-left: 1px solid #ccc;
                            border-top: 1px solid #ccc;
                        }
                        .print-cell { 
                            background: #fff; 
                            min-height: 100px; 
                            padding: 5px; 
                            font-size: 0.85rem;
                            border-right: 1px solid #ccc;
                            border-bottom: 1px solid #ccc;
                            page-break-inside: avoid;
                            position: relative;
                        }
                        
                        /* Styles specific to content being printed */
                        div[style*="background"] {
                           /* Preserve background colors for entries */
                           print-color-adjust: exact; 
                           -webkit-print-color-adjust: exact;
                           border: 1px solid rgba(0,0,0,0.1);
                           margin-bottom: 2px;
                           padding: 2px 4px;
                           border-radius: 3px;
                        }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="header-row">
                        <div>Lundi</div><div>Mardi</div><div>Mercredi</div><div>Jeudi</div><div>Vendredi</div><div>Samedi</div><div>Dimanche</div>
                    </div>
                    <div class="print-grid">
                        ${gridHtml}
                    </div>
                    <div style="margin-top:20px; text-align:right; font-size:0.8em; color:#666;">
                        Imprimé le ${new Date().toLocaleDateString('fr-FR')}
                    </div>
                </body>
            </html>
            `;

            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
            w.focus();
            setTimeout(() => w.print(), 500);
        }

        // Ensure toggleGraphView follows recenter request
        window.toggleGraphView = function () {
            const container = document.getElementById('graph-container');
            if (!container) return;
            if (container.style.display === 'none') {
                container.style.display = 'block';
                if (window.drawCharts) window.drawCharts();
                // REQ: recentrer sur le graphique afficher
                setTimeout(() => {
                    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            } else {
                container.style.display = 'none';
            }
        };

        function toggleMotifListFullscreen() {
            const mContent = document.getElementById('motifListContent');
            if (mContent.classList.contains('fullscreen-mode')) {
                mContent.classList.remove('fullscreen-mode');
                mContent.style.maxWidth = '800px';
            } else {
                mContent.classList.add('fullscreen-mode');
                mContent.style.maxWidth = 'none';
            }
        }
    </script>

    <!-- Print Options Modal -->
    <div id="printOptionsModal" class="modal" style="display:none; z-index:10000;">
        <div class="modal-content" style="width:300px; text-align:center;">
            <h3>Impression</h3>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button onclick="printRdvCalendar(); closePrintOptionsModal()" class="btn-secondary"
                    style="background:#607D8B; color:white; padding:10px;">Imprimer le Calendrier</button>
                <button id="btnPrintConvocations" onclick="printAllConvocationsForDay(); closePrintOptionsModal()"
                    class="btn-secondary" style="background:#E91E63; color:white; padding:10px;">Imprimer les
                    Convocations</button>
                <button onclick="closePrintOptionsModal()" class="btn-secondary"
                    style="margin-top:10px;">Annuler</button>
            </div>
        </div>
    </div>

    <!-- NEW MODAL: Week Selection -->
    <div id="weekSelectionModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <h3>Choisir les semaines actives</h3>
            <p style="font-style:italic; color:#aaa; margin-bottom:15px;">
                Cochez les semaines où vous souhaitez appliquer la <b>disposition actuelle</b>.<br>
                Les semaines décochées seront ignorées.
            </p>

            <div id="modalWeekGrid"
                style="display:grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap:10px; margin-bottom:20px; max-height:60vh; overflow-y:auto;">
                <!-- Generated by JS -->
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="closeWeekSelectionModal()" class="btn-secondary">Annuler</button>
                <button onclick="confirmWeekSelection()"
                    style="background-color:var(--primary-color); color:black; font-weight:bold;">Valider</button>
            </div>
        </div>
    </div>

    <!-- RDV Type Selection Modal -->
    <div id="rdvTypeModal" class="modal" style="display:none; z-index:32000;">
        <div class="modal-content" style="width:300px; text-align:center;">
            <h3>Type de Rendez-vous</h3>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button onclick="selectRdvType('standard')" class="btn-secondary"
                    style="background:#E91E63; color:white; padding:15px; font-size:1rem;">Nouveau Rendez-vous</button>
                <button onclick="selectRdvType('famille')" class="btn-secondary"
                    style="background:#FFD700; color:black; padding:15px; font-size:1rem;">Nouveau RDV Famille</button>
                <button onclick="selectRdvType('reunion')" class="btn-secondary"
                    style="background:#9C27B0; color:white; padding:15px; font-size:1rem;">RDV Réunion</button>
                <button onclick="document.getElementById('rdvTypeModal').style.display='none'" class="btn-secondary"
                    style="margin-top:10px;">Annuler</button>
            </div>
        </div>
    </div>

    <!-- RDV Modal -->
    <div id="rdvModal" class="modal" style="display:none;">
        <div class="modal-content" style="width:98vw; max-width:none;">
            <h2 style="text-align:center;">Nouveau Rendez-vous</h2>

            <!-- Student Search Section -->
            <div id="rdvStudentSection"
                style="margin-bottom:15px; border:1px solid #444; padding:10px; border-radius:4px; background:#2a2a2a;">
                <label style="color:#aaa; font-size:0.9em;">Ajouter des élèves (Max 4):</label>
                <div style="position:relative; margin-top:5px;">
                    <input type="text" id="rdvStudentSearch" placeholder="Rechercher un élève..."
                        oninput="searchRdvStudents(this.value)"
                        style="width:100%; padding:5px; background:#333; color:white; border:1px solid #555;">
                    <div id="rdvSearchResults"
                        style="position:absolute; top:100%; left:0; right:0; background:#222; border:1px solid #444; max-height:150px; overflow-y:auto; z-index:100; display:none;">
                    </div>
                </div>
                <div id="rdvSelectedStudents" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>
            </div>

            <label>Titre:</label>
            <input type="text" id="rdvTitle" spellcheck="true" lang="fr" autocorrect="on"
                ondrop="handleStudentNameDropInModal(event)" ondragover="event.preventDefault()"
                style="width:100%; margin-bottom:10px; padding:5px; background:#333; color:white; border:1px solid #555;">
            <label>Date:</label>
            <input type="date" id="rdvDate" onchange="updateAvailableSlots()"
                style="width:100%; margin-bottom:10px; padding:5px; background:#333; color:white; border:1px solid #555;">

            <div id="rdvSelectedSlotsContainer" style="margin-bottom:10px; display:none;">
                <label style="color:#E91E63; font-size:0.8rem;">Sélectionnés:</label>
                <div id="rdvSelectedSlotsList" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:2px;"></div>
            </div>

            <div id="rdvAvailableSlotContainer"
                style="margin-bottom:10px; padding:5px; background:#222; border:1px dashed #555; display:none;">
                <label style="color:#aaa; font-size:0.8rem;">Créneaux disponibles:</label>
                <div id="rdvAvailableSlotsList"
                    style="display:flex; flex-wrap:wrap; gap:5px; max-height:100px; overflow-y:auto; margin-top:5px;">
                </div>
            </div>

            <label>Heure:</label>
            <input type="time" id="rdvTime"
                style="width:100%; margin-bottom:10px; padding:5px; background:#333; color:white; border:1px solid #555;">

            <div id="rdvStatusSection" style="text-align:center;">
                <label style="display:block; margin-bottom:5px;">Statut:</label>
                <div style="display:flex; gap:10px; margin-bottom:10px; justify-content:center;">
                    <button type="button" id="btnStatusValid" onclick="setRdvStatus('validated')"
                        style="width:150px; padding:8px; border:1px solid #4CAF50; background:transparent; color:#4CAF50; cursor:pointer; border-radius:4px;">Validé</button>
                    <button type="button" id="btnStatusInvalid" onclick="setRdvStatus('not_validated')"
                        style="width:150px; padding:8px; border:1px solid #FF9800; background:transparent; color:#FF9800; cursor:pointer; border-radius:4px;">En
                        Attente</button>
                    <button type="button" id="btnStatusCancelled" onclick="setRdvStatus('cancelled')"
                        style="width:150px; padding:8px; border:1px solid #F44336; background:transparent; color:#F44336; cursor:pointer; border-radius:4px;">Annulé/Abs</button>
                </div>
                <input type="hidden" id="rdvStatus" value="not_validated">
            </div>

            <div id="rdvCpeSection">
                <label>Nom du CPE (pour convocation):</label>
                <input type="text" id="rdvCpeName" spellcheck="true" lang="fr" autocorrect="on"
                    placeholder="Ex: M. Dupont" list="cpeNamesList"
                    style="width:100%; margin-bottom:10px; padding:5px; background:#333; color:white; border:1px solid #555;">
                <datalist id="cpeNamesList"></datalist>
            </div>

            <label>Description (Motif):</label>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <select id="rdvDescSelect"
                    onchange="if(this.value){ document.getElementById('rdvDesc').value=this.value; }"
                    style="flex:1; background:#333; color:white; border:1px solid #555; padding:5px;">
                    <option value="">-- Choisir un motif existant --</option>
                </select>
            </div>
            <textarea id="rdvDesc" spellcheck="true" lang="fr" autocorrect="on"
                placeholder="Ou saisir une nouvelle description..."
                style="width:100%; height:100px; margin-bottom:10px; padding:5px; background:#333; color:white; border:1px solid #555;"></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
                <button id="btnDeleteRdv" onclick="deleteCurrentRdv()" class="btn-secondary"
                    style="background-color:#d32f2f; color:white; display:none; margin-right:auto;">Supprimer</button>
                <button onclick="printConvocation()" class="btn-secondary"
                    style="background-color:#607D8B; color:white;">Imprimer Convocation</button>
                <button onclick="closeRdvModal()" class="btn-secondary">Annuler</button>
                <button onclick="saveRdv()" class="btn-add" style="background-color:#E91E63;">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Graph Data Selection Modal -->
    <div id="graphDataModal" class="modal"
        style="display:none; z-index:20000; justify-content:center; align-items:center;">
        <div class="modal-content"
            style="width:400px; max-height:80vh; overflow-y:auto; background:#1e1e1e; border:1px solid var(--primary-color);">
            <h3 style="color:var(--primary-color); border-bottom:1px solid #444; padding-bottom:10px; margin-top:0;">
                Choix des Données</h3>
            <p style="color:#aaa; font-size:0.9em;">Cochez les éléments à afficher sur le graphique.</p>
            <div id="graphDataCheckboxes" style="display:flex; flex-direction:column; gap:8px; margin:15px 0;">
                <!-- Generated by JS -->
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #444; padding-top:15px;">
                <button onclick="document.getElementById('graphDataModal').style.display='none'"
                    class="btn-secondary">Fermer</button>
                <button onclick="applyGraphDataSelection()"
                    style="background:var(--primary-color); color:black; font-weight:bold; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Appliquer</button>
            </div>
        </div>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- GRAPHING LOGIC ---

        // Global Filter State
        let currentGraphFilters = {
            'rdv_week': ['Total', 'Validé', 'En Attente', 'Annulé', 'Famille'],
            'status': ['Validé', 'En Attente', 'Annulé', 'Famille']
        };

        function openGraphDataSelector() {
            const modal = document.getElementById('graphDataModal');
            const container = document.getElementById('graphDataCheckboxes');
            const source = document.getElementById('graphSource').value;
            container.innerHTML = '';

            let options = [];
            if (source === 'rdv_week') {
                options = ['Total', 'Validé', 'En Attente', 'Annulé', 'Famille'];
            } else if (source === 'status') {
                options = ['Validé', 'En Attente', 'Annulé', 'Famille'];
            } else if (source === 'colors') {
                options = ['Rouge', 'Orange', 'Jaune', 'Vert', 'Vert Foncé'];
            } else if (source === 'population') {
                options = ['1 RDV', '2 RDV', '3 RDV', '4 RDV', '5-6 RDV', '7+ RDV'];
            } else {
                container.innerHTML = '<p style="color:#888;">Pas d\'options spécifiques pour ce graphique.</p>';
            }

            if (options.length > 0) {
                options.forEach(opt => {
                    const isChecked = !currentGraphFilters[source] || currentGraphFilters[source].includes(opt);

                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.gap = '10px';
                    div.style.padding = '5px';
                    div.style.borderBottom = '1px solid #333';

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.value = opt;
                    cb.checked = isChecked;
                    cb.id = 'gds_' + opt.replace(/[^a-zA-Z0-9]/g, '');

                    const label = document.createElement('label');
                    label.htmlFor = cb.id;
                    label.textContent = opt;
                    label.style.cursor = 'pointer';
                    label.style.color = '#ddd';

                    div.appendChild(cb);
                    div.appendChild(label);
                    container.appendChild(div);
                });
            }

            modal.style.display = 'flex';
        }

        function applyGraphDataSelection() {
            const source = document.getElementById('graphSource').value;
            const container = document.getElementById('graphDataCheckboxes');
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            const selected = [];
            checkboxes.forEach(cb => {
                if (cb.checked) selected.push(cb.value);
            });
            currentGraphFilters[source] = selected;
            document.getElementById('graphDataModal').style.display = 'none';
            drawCharts();
        }

        window.drawCharts = function () {
            const ctxCanvas = document.getElementById('mainChart');
            if (!ctxCanvas) return;
            const ctx = ctxCanvas.getContext('2d');

            if (window.myChart instanceof Chart) {
                window.myChart.destroy();
            }

            const source = document.getElementById('graphSource').value;
            const type = document.getElementById('graphType').value;
            const stats = window.lastStats;
            if (!stats) return;

            // Default Color Palette
            const colors = {
                'Total': '#2196F3',
                'Validé': '#4CAF50',
                'En Attente': '#FF9800',
                'Annulé': '#F44336',
                'Famille': '#FFD700',
                'Rouge': '#F44336',
                'Orange': '#FF9800',
                'Jaune': '#FFD700',
                'Vert': '#4CAF50',
                'Vert Foncé': '#006400',
                'Default': '#00f2ff'
            };

            let labels = [];
            let datasets = [];

            if (source === 'status') {
                const filters = currentGraphFilters['status'] || ['Validé', 'En Attente', 'Annulé', 'Famille'];
                // Prepare Data
                const dataMap = {
                    'Validé': stats.RDV_present,
                    'En Attente': stats.colors.orange,
                    'Annulé': stats.RDV_absent,
                    'Famille': stats.total_rencontres_famille
                };

                const filteredLabels = filters.filter(l => Object.keys(dataMap).includes(l));
                const dataValues = filteredLabels.map(l => dataMap[l]);
                const bgColors = filteredLabels.map(l => colors[l] || '#888');

                labels = filteredLabels;
                datasets.push({
                    label: 'Nombre de RDV',
                    data: dataValues,
                    backgroundColor: bgColors,
                    borderColor: '#111',
                    borderWidth: 1
                });
            } else if (source === 'rdv_week') {
                // Weekly Evolution
                const filters = currentGraphFilters['rdv_week'] || ['Total', 'Validé', 'En Attente', 'Annulé', 'Famille'];
                const weeks = {};

                (stats.events || []).forEach(e => {
                    if (!e.date) return;
                    const d = new Date(e.date);
                    const dCopy = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                    const dayNum = dCopy.getUTCDay() || 7;
                    dCopy.setUTCDate(dCopy.getUTCDate() + 4 - dayNum);
                    const yearStart = new Date(Date.UTC(dCopy.getUTCFullYear(), 0, 1));
                    const weekNo = Math.ceil((((dCopy - yearStart) / 86400000) + 1) / 7);
                    const key = `S${weekNo}`;

                    if (!weeks[key]) weeks[key] = { total: 0, 'Validé': 0, 'En Attente': 0, 'Annulé': 0, 'Famille': 0, sortVal: weekNo };

                    weeks[key].total++;
                    if (e.type === 'famille') weeks[key]['Famille']++;
                    else {
                        if (e.status === 'validated') weeks[key]['Validé']++;
                        else if (e.status === 'cancelled') weeks[key]['Annulé']++;
                        else weeks[key]['En Attente']++;
                    }
                });

                const sortedKeys = Object.keys(weeks).sort((a, b) => weeks[a].sortVal - weeks[b].sortVal);
                labels = sortedKeys;

                if (filters.includes('Total')) {
                    datasets.push({ label: 'Total', data: sortedKeys.map(k => weeks[k].total), borderColor: colors['Total'], backgroundColor: 'rgba(33, 150, 243, 0.1)', tension: 0.3 });
                }
                if (filters.includes('Validé')) {
                    datasets.push({ label: 'Validé', data: sortedKeys.map(k => weeks[k]['Validé']), borderColor: colors['Validé'], backgroundColor: 'rgba(76, 175, 80, 0.1)', tension: 0.3 });
                }
                if (filters.includes('En Attente')) {
                    datasets.push({ label: 'En Attente', data: sortedKeys.map(k => weeks[k]['En Attente']), borderColor: colors['En Attente'], backgroundColor: 'rgba(255, 152, 0, 0.1)', tension: 0.3 });
                }
                if (filters.includes('Annulé')) {
                    datasets.push({ label: 'Annulé', data: sortedKeys.map(k => weeks[k]['Annulé']), borderColor: colors['Annulé'], backgroundColor: 'rgba(244, 67, 54, 0.1)', tension: 0.3 });
                }
                if (filters.includes('Famille')) {
                    datasets.push({ label: 'Famille', data: sortedKeys.map(k => weeks[k]['Famille']), borderColor: colors['Famille'], backgroundColor: 'rgba(255, 215, 0, 0.1)', tension: 0.3 });
                }
            } else if (source === 'population') {
                const studentCounts = {};
                (stats.events || []).forEach(e => {
                    (e.students || []).forEach(s => { studentCounts[s] = (studentCounts[s] || 0) + 1; });
                });
                const popBuckets = { '1 RDV': 0, '2 RDV': 0, '3 RDV': 0, '4 RDV': 0, '5-6 RDV': 0, '7+ RDV': 0 };
                Object.values(studentCounts).forEach(c => {
                    if (c === 1) popBuckets['1 RDV']++;
                    else if (c === 2) popBuckets['2 RDV']++;
                    else if (c === 3) popBuckets['3 RDV']++;
                    else if (c === 4) popBuckets['4 RDV']++;
                    else if (c >= 5 && c <= 6) popBuckets['5-6 RDV']++;
                    else popBuckets['7+ RDV']++;
                });

                const filters = currentGraphFilters['population'] || Object.keys(popBuckets);
                const filteredKeys = Object.keys(popBuckets).filter(k => filters.includes(k));

                // Specific Colors for Population
                const popColors = {
                    '1 RDV': '#4CAF50',
                    '2 RDV': '#8BC34A',
                    '3 RDV': '#CDDC39',
                    '4 RDV': '#FFEB3B',
                    '5-6 RDV': '#FF9800',
                    '7+ RDV': '#F44336'
                };

                labels = filteredKeys;
                datasets.push({
                    label: 'Nombre d\'élèves',
                    data: filteredKeys.map(k => popBuckets[k]),
                    backgroundColor: filteredKeys.map(k => popColors[k] || '#888'),
                    borderColor: '#111',
                    borderWidth: 1
                });
            } else if (source === 'motifs') {
                const motifs = stats.motifs || {};
                labels = Object.keys(motifs).sort((a, b) => motifs[b] - motifs[a]).slice(0, 10);
                datasets.push({
                    label: 'Occurrences',
                    data: labels.map(l => motifs[l]),
                    backgroundColor: '#9C27B088',
                    borderColor: '#9C27B0',
                    borderWidth: 1
                });
            } else if (source === 'colors') {
                // Priorité logic
                const filters = currentGraphFilters['colors'] || ['Rouge', 'Orange', 'Jaune', 'Vert', 'Vert Foncé'];
                const dataMap = {
                    'Rouge': stats.colors.rouge,
                    'Orange': stats.colors.orange,
                    'Jaune': stats.colors.jaune,
                    'Vert': stats.colors.vert,
                    'Vert Foncé': stats.colors.vert_fonce
                };
                const filteredLabels = filters.filter(l => Object.keys(dataMap).includes(l));
                labels = filteredLabels;
                datasets.push({
                    label: 'Nombre',
                    data: filteredLabels.map(l => dataMap[l]),
                    backgroundColor: filteredLabels.map(l => colors[l]),
                    borderColor: '#111',
                    borderWidth: 1
                });
            }

            window.myChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#ccc' } }
                    },
                    scales: {
                        y: { ticks: { color: '#aaa' }, grid: { color: '#333' } },
                        x: { ticks: { color: '#aaa' }, grid: { color: '#333' } }
                    }
                }
            });
        };

        // --- CALENDAR CREATOR LOGIC ---
        function getIsoWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function generateCreatorCalendar() {
            const yearStr = document.getElementById('genStartYear').value;
            const year = parseInt(yearStr);
            if (!year) return;

            const container = document.getElementById('creatorPreview');
            container.innerHTML = '';

            // Start from Sept 1st (Monday of that week)
            let current = new Date(year, 8, 1);
            const day = current.getDay() || 7;
            current.setDate(current.getDate() - (day - 1));

            // End mid-July next year
            const endYear = year + 1;
            const endDate = new Date(endYear, 6, 15);

            let monthsData = new Map();

            while (current < endDate) {
                const weekNum = getIsoWeekNumber(current);
                const monday = new Date(current);
                const sunday = new Date(current);
                sunday.setDate(monday.getDate() + 6);

                // Assign to month of Thursday
                const thursday = new Date(monday);
                thursday.setDate(monday.getDate() + 3);

                const mIndex = thursday.getMonth();
                const yIndex = thursday.getFullYear();
                const mKey = `${yIndex}-${mIndex}`;

                const monthName = thursday.toLocaleDateString('fr-FR', { month: 'long' });
                const capMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);

                if (!monthsData.has(mKey)) {
                    monthsData.set(mKey, { name: capMonth, weeks: [] });
                }

                monthsData.get(mKey).weeks.push({
                    num: weekNum,
                    start: new Date(monday),
                    end: new Date(sunday)
                });

                current.setDate(current.getDate() + 7);
            }

            monthsData.forEach((data, key) => {
                const mDiv = document.createElement('div');
                mDiv.className = 'month-block';
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = data.name;
                mDiv.appendChild(header);

                data.weeks.forEach(wk => {
                    const row = document.createElement('div');
                    row.className = 'week-row';
                    row.innerHTML = `
                        <div style="flex:1; display:flex; gap:15px; align-items:center;">
                            <span style="font-weight:bold; color:#e91e63; min-width:30px;">${wk.num}</span>
                            <span style="color:#666; font-size:0.9em;">${wk.start.toLocaleDateString('fr-FR')} - ${wk.end.toLocaleDateString('fr-FR')}</span>
                        </div>
                        <label style="cursor:pointer; display:flex; gap:5px; align-items:center;">
                            <input type="checkbox" class="vac-check" data-num="${wk.num}"> Vacances (F)
                        </label>
                    `;
                    const chk = row.querySelector('.vac-check');
                    chk.onchange = () => {
                        if (chk.checked) row.classList.add('zone-holiday');
                        else row.classList.remove('zone-holiday');
                    };
                    mDiv.appendChild(row);
                });
                container.appendChild(mDiv);
            });
        }

        function applyCreatedCalendar() {
            const blocks = document.querySelectorAll('#creatorPreview .month-block');
            if (blocks.length === 0) return;

            const result = [];
            blocks.forEach(block => {
                const mName = block.querySelector('.month-header').textContent;
                const rows = block.querySelectorAll('.week-row');
                const weeksArr = [];
                rows.forEach(row => {
                    const numSpan = row.querySelector('span');
                    const num = parseInt(numSpan.textContent);
                    const isF = row.querySelector('.vac-check').checked;
                    weeksArr.push(isF ? "F" : num);
                });
                result.push({ month: mName, weeks: weeksArr });
            });

            // Export JSON String
            const jsonStr = JSON.stringify(result, null, 2);

            // 1. Download
            const blob = new Blob([jsonStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "nouveau_calendrier.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // 2. Update Software (Mock input for handleCalendarImport)
            // Create a file object (modern browsers support this)
            const file = new File([blob], "nouveau_calendrier.json", { type: "application/json" });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);

            const fakeInput = { files: dataTransfer.files, value: '' }; // Mimic input element
            handleCalendarImport(fakeInput);

            document.getElementById('calendarCreatorModal').style.display = 'none';
        }
    </script>
    <script>
        // Gestion des lisérés : Séquence linéaire unique (0s -> 90s -> Fin)
        (function () {
            const dividers = [
                document.getElementById('decorativeDivider'),
                document.getElementById('decorativeDivider2'),
                document.getElementById('decorativeDividerVertical')
            ];

            let timeElapsed = 0;
            let checkInterval = null;

            function isDataLoaded() {
                // Vérifie si la base est chargée
                return (typeof appData !== 'undefined' && appData && appData.students && appData.students.length > 0);
            }

            function triggerDisappearance(durationSeconds) {
                // Arrêt définitif de la surveillance
                if (checkInterval) {
                    clearInterval(checkInterval);
                    checkInterval = null;
                }

                // 1. Préparation synchronisée
                dividers.forEach(d => {
                    if (d) {
                        d.style.animation = 'none';
                        d.style.transition = `opacity ${durationSeconds}s ease-out`;
                        d.style.opacity = '1';
                    }
                });

                // 2. Déclenchement FRAME-PERFECT
                requestAnimationFrame(() => {
                    dividers.forEach(d => {
                        if (d) d.style.opacity = '0';
                    });
                });

                // 3. Nettoyage DOM
                setTimeout(() => {
                    dividers.forEach(d => {
                        if (d) d.style.display = 'none';
                    });
                }, durationSeconds * 1000);
            }

            // Initialisation : Visibles
            dividers.forEach((d, index) => {
                if (d) {
                    d.style.display = 'block';
                    d.style.opacity = '1';
                    d.style.transition = 'none';

                    // Animation "Mal de mer" (slideGlow) seulement pour les horizontaux (0 et 1)
                    if (index < 2) {
                        d.style.animation = 'slideGlow 12s linear infinite';
                    } else {
                        d.style.animation = 'none'; // Le vertical reste fixe
                    }
                }
            });

            checkInterval = setInterval(() => {
                // 1. CAS PRIORITAIRE : Base chargée -> Disparition rapide (2s)
                if (isDataLoaded()) {
                    triggerDisappearance(2);
                    return;
                }

                timeElapsed++;

                // 2. ÉTAPE 15s : Arrêt de l'animation (Phase calme)
                if (timeElapsed === 15) {
                    dividers.forEach(d => { if (d) d.style.animation = 'none'; });
                }

                // 3. ÉTAPE 90s : Disparition lente automatique (30s)
                if (timeElapsed >= 90) {
                    triggerDisappearance(30);
                }

            }, 1000);
        })();
    </script>

    <!-- Assistance Guides Content -->
    <template id="guide-content-Guide_Complet_LOGECPE">
        <!DOCTYPE html>
        <html lang="fr">

        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Guide Complet - LOGECPE NTP14</title>
            <style>
                :root {
                    --primary: #FFA500;
                    --primary-dark: #FF8C00;
                    --secondary: #2196F3;
                    --success: #4CAF50;
                    --warning: #FF9800;
                    --danger: #F44336;
                    --bg-dark: #121212;
                    --bg-card: #1e1e1e;
                    --text-main: #ffffff;
                    --text-muted: #b0b0b0;
                    --border: #333;
                }

                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }

                body {
                    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
                    background-color: var(--bg-dark);
                    color: var(--text-main);
                    line-height: 1.6;
                    padding: 20px;
                }

                .container {
                    max-width: 1000px;
                    margin: 0 auto;
                    background-color: var(--bg-card);
                    border-radius: 12px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    padding: 40px;
                }

                header {
                    text-align: center;
                    margin-bottom: 50px;
                    border-bottom: 2px solid var(--primary);
                    padding-bottom: 20px;
                }

                h1 {
                    color: var(--primary);
                    font-size: 2.5rem;
                    margin-bottom: 10px;
                }

                .subtitle {
                    color: var(--text-muted);
                    font-size: 1.1rem;
                }

                h2 {
                    color: var(--primary);
                    margin-top: 40px;
                    margin-bottom: 20px;
                    border-left: 5px solid var(--primary);
                    padding-left: 15px;
                    font-size: 1.8rem;
                }

                h3 {
                    color: var(--primary-dark);
                    margin-top: 30px;
                    margin-bottom: 15px;
                    font-size: 1.4rem;
                }

                h4 {
                    color: #eee;
                    margin-top: 20px;
                    margin-bottom: 10px;
                    font-size: 1.2rem;
                }

                p {
                    margin-bottom: 15px;
                    color: #ddd;
                }

                ul,
                ol {
                    margin-bottom: 15px;
                    padding-left: 20px;
                }

                li {
                    margin-bottom: 8px;
                }

                .feature-box {
                    background: rgba(255, 165, 0, 0.05);
                    border: 1px solid var(--primary);
                    border-radius: 8px;
                    padding: 20px;
                    margin: 20px 0;
                }

                .warning-box {
                    background: rgba(244, 67, 54, 0.1);
                    border-left: 5px solid var(--danger);
                    padding: 15px;
                    margin: 20px 0;
                    border-radius: 4px;
                }

                .success-box {
                    background: rgba(76, 175, 80, 0.1);
                    border-left: 5px solid var(--success);
                    padding: 15px;
                    margin: 20px 0;
                    border-radius: 4px;
                }

                .tip-box {
                    background: rgba(33, 150, 243, 0.1);
                    border-left: 5px solid var(--secondary);
                    padding: 15px;
                    margin: 20px 0;
                    border-radius: 4px;
                }

                .code-block {
                    background: #0d0d0d;
                    border-radius: 6px;
                    padding: 15px;
                    font-family: 'Consolas', 'Monaco', monospace;
                    font-size: 0.9rem;
                    margin-bottom: 20px;
                    border: 1px solid #333;
                    color: #4CAF50;
                    white-space: pre-wrap;
                    line-height: 1.4;
                }

                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                    background: #1a1a1a;
                }

                th,
                td {
                    padding: 12px;
                    text-align: left;
                    border-bottom: 1px solid #333;
                }

                th {
                    background-color: #252525;
                    color: var(--primary);
                    font-weight: 600;
                }

                tr:hover {
                    background-color: #222;
                }

                .badge {
                    display: inline-block;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 0.8rem;
                    font-weight: bold;
                    text-transform: uppercase;
                    margin-right: 5px;
                }

                .badge-new {
                    background-color: var(--success);
                    color: white;
                }

                .badge-update {
                    background-color: var(--secondary);
                    color: white;
                }

                .nav-links {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin-bottom: 40px;
                }

                .nav-card {
                    background: #252525;
                    padding: 15px;
                    border-radius: 8px;
                    text-decoration: none;
                    color: white;
                    transition: all 0.3s ease;
                    text-align: center;
                    border: 1px solid #333;
                }

                .nav-card:hover {
                    background: var(--primary);
                    color: black;
                    transform: translateY(-5px);
                }

                footer {
                    margin-top: 60px;
                    text-align: center;
                    padding-top: 30px;
                    border-top: 1px solid #333;
                    color: var(--text-muted);
                }

                .highlight {
                    color: var(--primary);
                    font-weight: bold;
                }

                .feature-list {
                    list-style: none;
                }

                .feature-list li::before {
                    content: "✓";
                    color: var(--success);
                    margin-right: 10px;
                    font-weight: bold;
                }

                .steps {
                    counter-reset: step;
                }

                .step-item {
                    margin-bottom: 15px;
                    padding-left: 45px;
                    position: relative;
                }

                .step-item::before {
                    counter-increment: step;
                    content: counter(step);
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 30px;
                    height: 30px;
                    background-color: var(--primary);
                    color: black;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                }
            </style>
        </head>

        <body>
            <div class="container">
                <header>
                    <h1>📚 Guide Complet LOGECPE</h1>
                    <p class="subtitle">Tout ce qu'il faut savoir pour maîtriser votre outil de vie scolaire</p>
                    <p class="subtitle" style="margin-top: 10px; font-size: 0.9rem;">Version 2026.1 - Mis à jour le
                        23/01/2026
                    </p>
                </header>

                <div class="nav-links">
                    <a href="#intro" class="nav-card">🚀 Introduction</a>
                    <a href="#agenda" class="nav-card">📅 Agenda des Saisies</a>
                    <a href="#rdv" class="nav-card">📋 Gestion des RDV</a>
                    <a href="#fiche" class="nav-card">👤 Fiche Élève</a>
                    <a href="#stats" class="nav-card">📊 Statistiques</a>
                    <a href="#calendrier" class="nav-card">📅 Calendrier Scolaire</a>
                    <a href="#import" class="nav-card">📥 Importation</a>
                    <a href="#print" class="nav-card">🖨️ Impression</a>
                    <a href="#save" class="nav-card">💾 Sauvegarde</a>
                </div>

                <!-- SECTION 1: INTRODUCTION -->
                <div class="section" id="intro">
                    <h2>1. 🚀 Introduction à LOGECPE</h2>
                    <p>
                        <strong>LOGECPE</strong> est un logiciel de gestion de vie scolaire conçu <strong>par un CPE
                            pour les
                            CPE</strong>.
                        Il permet de centraliser toutes les informations relatives au suivi des élèves : observations
                        quotidiennes,
                        rendez-vous avec les familles, incidents, statistiques et bien plus encore.
                    </p>

                    <div class="tip-box">
                        <strong>💡 Note importante :</strong> Ce logiciel fonctionne de manière
                        <strong>autonome</strong> dans
                        votre navigateur.
                        Toutes les données sont stockées localement sur votre ordinateur. Aucune donnée n'est envoyée
                        sur un
                        serveur externe,
                        garantissant une confidentialité totale (RGPD).
                    </div>

                    <h3>1.1 Les 3 piliers du logiciel</h3>
                    <ol>
                        <li><strong>Suivi comportemental</strong> : Saisie rapide des observations hebdomadaires.</li>
                        <li><strong>Organisation</strong> : Gestion des rendez-vous et calendrier scolaire.</li>
                        <li><strong>Analyse</strong> : Statistiques détaillées et bilans annuels.</li>
                    </ol>
                </div>

                <!-- SECTION 2: AGENDA DES SAISIES -->
                <div class="section" id="agenda">
                    <h2>2. 📅 Agenda des Saisies</h2>
                    <p>
                        L'<strong>Agenda des Saisies</strong> est le cœur de votre activité quotidienne.
                        C'est ici que vous visualisez l'historique complet de toutes les observations et rendez-vous du
                        mois.
                    </p>

                    <h3>2.1 Accès à l'Agenda</h3>
                    <p>
                        Cliquez sur le bouton <span
                            style="background: #FFA500; color: black; padding: 3px 10px; border-radius: 5px;">
                            📅 Agenda des saisies</span> dans la barre de navigation supérieure.
                    </p>

                    <h3>2.2 Navigation</h3>
                    <ul>
                        <li>Utilisez les boutons <strong>"&lt; Précédent"</strong> et <strong>"Suivant &gt;"</strong>
                            pour changer
                            de mois.</li>
                        <li>Le mois et l'année en cours sont affichés au centre.</li>
                        <li>Le jour actuel est surligné en bleu.</li>
                    </ul>

                    <h3>2.3 Interprétation des couleurs</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Marqueur</th>
                                <th>Signification</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span style="color: #4CAF50;">●</span> Point Vert</td>
                                <td>Observation régulière (Fiche élève - Semaine)</td>
                            </tr>
                            <tr>
                                <td><span style="color: #FF9800;">●</span> Point Orange</td>
                                <td>Rendez-vous planifié</td>
                            </tr>
                            <tr>
                                <td><span style="color: #F44336;">●</span> Point Rouge</td>
                                <td>Incident grave ou Situation à surveiller</td>
                            </tr>
                            <tr>
                                <td>Fond Gris</td>
                                <td>Semaine de vacances ou week-end</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="example-box">
                        <h5>💡 Exemple visuel de l'Agenda</h5>
                        <div class="code-block">
                            [ Lun 15 ] [ Mar 16 ] [ Mer 17 ] [ Jeu 18 ] [ Ven 19 ]
                            [ DUPONT M. ● ] [ MARTIN L. ● ] [ ] [ RDV Famille ● ] [ ]
                            [ ] [ ] [ ] [ ] [ COHEN S. ● ]
                        </div>
                    </div>

                    <h3>2.4 Impression de l'Agenda <span class="badge badge-new">NOUVEAU</span></h3>
                    <p>
                        Vous pouvez désormais imprimer le mois en cours directement depuis l'agenda.
                        Cliquez sur le bouton <strong>"🖨️ Imprimer"</strong> situé à côté des boutons de navigation.
                        L'impression est optimisée pour tenir sur une page A4 en mode portrait.
                    </p>
                </div>

                <!-- SECTION 3: GESTION DES RDV -->
                <div class="section" id="rdv">
                    <h2>3. 📋 Gestion des Rendez-vous</h2>
                    <p>
                        LOGECPE permet de gérer 3 types de rencontres :
                    </p>

                    <h3>3.1 Types de RDV</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Couleur</th>
                                <th>Usage classique</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Standard</strong></td>
                                <td><span
                                        style="background: #E91E63; color: white; padding: 2px 5px; border-radius: 3px;">Rose</span>
                                </td>
                                <td>Élève seul, AED, Petit point rapide</td>
                            </tr>
                            <tr>
                                <td><strong>Famille</strong></td>
                                <td><span
                                        style="background: #FFD700; color: black; padding: 2px 5px; border-radius: 3px;">Or</span>
                                </td>
                                <td>Parents, Tuteurs, Signalement grave</td>
                            </tr>
                            <tr>
                                <td><strong>Réunion</strong></td>
                                <td><span
                                        style="background: #9C27B0; color: white; padding: 2px 5px; border-radius: 3px;">Violet</span>
                                </td>
                                <td>Conseil de classe, Équipe éducative, ESS</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>3.2 Créer un nouveau RDV</h3>
                    <div class="steps">
                        <div class="step-item">
                            <strong>Cliquez sur un jour vide</strong> dans l'agenda des saisies
                        </div>
                        <div class="step-item">
                            <strong>Choisissez le type</strong> de rendez-vous dans la fenêtre qui s'ouvre
                        </div>
                        <div class="step-item">
                            <strong>Remplissez le formulaire</strong> :
                            <ul>
                                <li>Nom de l'élève (recherche automatique)</li>
                                <li>Heure du RDV</li>
                                <li>Lieu (Bureau CPE, Salle...)</li>
                                <li>Motif (Pourquoi ce RDV ?)</li>
                                <li>Notes de suivi (Pendant/Après le RDV)</li>
                            </ul>
                        </div>
                        <div class="step-item">
                            <strong>Sélectionnez le statut</strong> : En attente, Validé ou Annulé
                        </div>
                        <div class="step-item">
                            <strong>Enregistrez</strong>
                        </div>
                    </div>

                    <h3>3.3 Modifier ou Annuler un RDV</h3>
                    <div class="steps">
                        <div class="step-item">
                            <strong>Cliquez sur un RDV</strong> dans l'agenda pour l'ouvrir
                        </div>
                        <div class="step-item">
                            <strong>Modifiez les informations</strong> souhaitées
                        </div>
                        <div class="step-item">
                            <strong>Sauvegardez</strong> ou <strong>Supprimez</strong> (bouton rouge en bas à
                            gauche)
                        </div>
                    </div>

                    <div class="warning-box">
                        <strong>⚠️ Attention :</strong> La suppression d'un RDV est définitive et ne peut pas être
                        annulée.
                    </div>
                </div>

                <!-- SECTION 4: FICHE ÉLÈVE -->
                <div class="section" id="fiche">
                    <h2>3. 👤 Fiche Élève Détaillée</h2>

                    <h3>3.1 Qu'est-ce que la Fiche Élève ?</h3>
                    <p>
                        La <strong>Fiche Élève</strong> est l'outil CENTRAL du logiciel LOGECPE. C'est ici que le
                        CPE
                        consigne TOUTES les observations, incidents, progrès et informations concernant le suivi
                        comportemental et éducatif d'un élève.
                    </p>

                    <div class="warning-box">
                        <strong>⚠️ Important :</strong> LOGECPE est un logiciel de <strong>VIE SCOLAIRE</strong>
                        pour CPE,
                        PAS un logiciel de notes comme Pronote. Il ne gère PAS les notes scolaires ni les devoirs.
                        Son rôle est le suivi du <strong>COMPORTEMENT</strong>, des <strong>INCIDENTS</strong>,
                        des <strong>RDV</strong> et de la <strong>VIE DE L'ÉLÈVE</strong> au collège/lycée.
                    </div>

                    <h3>3.2 Accès à la Fiche Élève</h3>
                    <p>Plusieurs moyens d'ouvrir une fiche élève :</p>
                    <ul class="feature-list">
                        <li>Cliquer sur un élève dans le logiciel</li>
                        <li>Cliquer sur une entrée dans l'agenda</li>
                        <li>Cliquer sur un nom dans les statistiques</li>
                        <li>Rechercher un élève via la barre de recherche</li>
                    </ul>

                    <h3>3.3 Onglet "Information Hebdomadaire" ⭐ PRINCIPAL</h3>
                    <p>
                        C'est l'onglet <strong>LE PLUS IMPORTANT</strong> et le plus utilisé au quotidien par le
                        CPE.
                        Il permet de suivre le comportement et les observations semaine par semaine.
                    </p>

                    <h4>🎯 Rôle de cet onglet</h4>
                    <div class="feature-box">
                        <ul class="feature-list">
                            <li><strong>Suivi hebdomadaire</strong> : Noter le comportement de l'élève chaque
                                semaine</li>
                            <li><strong>Traçabilité</strong> : Garder un historique complet de l'année scolaire</li>
                            <li><strong>Communication</strong> : Base pour les rencontres avec les parents</li>
                            <li><strong>Conseils de classe</strong> : Données pour les bilans trimestriels</li>
                            <li><strong>Justification</strong> : Preuves en cas de procédure disciplinaire</li>
                        </ul>
                    </div>

                    <h4>🗓️ Le Sélecteur de Semaines - Explication Détaillée</h4>
                    <p>
                        En haut de la fiche, vous voyez une <strong>bande horizontale</strong> avec toutes les
                        semaines
                        de l'année scolaire numérotées.
                    </p>

                    <div class="feature-box">
                        <h5>📌 Fonctionnement du sélecteur</h5>
                        <ul class="feature-list">
                            <li><strong>Semaines numérotées</strong> : 36, 37, 38... jusqu'à 51 (septembre à
                                décembre),
                                puis 1, 2, 3... jusqu'à 29 (janvier à juillet)</li>
                            <li><strong>Semaine active</strong> : Fond ORANGE VIF avec bordure brillante = semaine
                                actuellement affichée</li>
                            <li><strong>Coche verte ✓</strong> : Indique qu'il y a des données enregistrées pour
                                cette
                                semaine</li>
                            <li><strong>Semaines vides</strong> : Gris clair, pas de coche = aucune observation
                                enregistrée
                            </li>
                            <li><strong>Clic sur une semaine</strong> : Charge instantanément les données de cette
                                semaine
                            </li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple visuel - Comment lire le sélecteur</h5>
                        <div class="code-block">
                            ┌────┬────┬────┬────┬────┬────┬────┬────┬────┐
                            │ 36 │ 37✓│<span style="background:#FFA500;color:#000;"> 38✓</span>│ 39✓│ 40 │ 41✓│ 42 │
                            43 │
                            44✓│
                            └────┴────┴────┴────┴────┴────┴────┴────┴────┘

                            <strong>Lecture :</strong>
                            • Semaine 38 = SÉLECTIONNÉE (fond orange)
                            • Semaines 37, 38, 39, 41, 44 = Ont des données (✓ verte)
                            • Semaines 36, 40, 42, 43 = Vides (pas de ✓)

                            <strong>Action :</strong>
                            Si je clique sur "41", les données de la semaine 41 s'affichent
                        </div>
                    </div>

                    <h4>📅 Calendrier Hebdomadaire - Choisir le Jour de Saisie</h4>
                    <p>
                        En dessous du sélecteur de semaines, un <strong>calendrier visuel de la semaine</strong>
                        permet de sélectionner précisément le jour pour lequel vous voulez saisir une observation.
                    </p>

                    <div class="feature-box">
                        <h5>🎯 Fonctionnement du Calendrier Hebdomadaire</h5>
                        <ul class="feature-list">
                            <li><strong>7 boutons</strong> : Un pour chaque jour de la semaine (Lundi à Dimanche)
                            </li>
                            <li><strong>Jour sélectionné</strong> : Surligné en orange avec bordure brillante</li>
                            <li><strong>Jours avec données</strong> : Marqués d'un point vert "●"</li>
                            <li><strong>Jours vides</strong> : Pas de marqueur</li>
                            <li><strong>Clic sur un jour</strong> : Affiche/masque la zone de saisie pour ce jour
                            </li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple visuel - Calendrier de la semaine 38</h5>
                        <div class="code-block">
                            <strong>SEMAINE 38 : du 16/09/2025 au 22/09/2025</strong>

                            ┌─────────────────────────────────────────────────────────────────┐
                            │ CALENDRIER DE LA SEMAINE │
                            ├─────┬─────┬─────┬─────┬─────┬─────┬─────────────────────────────┤
                            │ LUN │ MAR │ MER │ JEU │ VEN │ SAM │ DIM │
                            │ 16 │ 17 │ 18 │ 19 │ 20 │ 21 │ 22 │
                            │ ● │ ● │ │ ● │ ● │ │ │
                            └─────┴─────┴─────┴─────┴─────┴─────┴─────────────────────────────┘
                            ↑ ↑ ↑ ↑
                            Ont des données (point vert ●)

                            <strong>ÉTAT ACTUEL :</strong>
                            • Lundi 16 : ● Données saisies (retard justifié)
                            • Mardi 17 : ● Données saisies (participation active)
                            • Mercredi 18 : Pas de données
                            • Jeudi 19 : ● Données saisies (incident cantine)
                            • Vendredi 20 : ● Données saisies (RDV parents)
                            • Samedi 21 : Pas de données
                            • Dimanche 22 : Pas de données

                            <strong>ACTION :</strong>
                            Si je clique sur "MER 18", une zone de saisie s'ouvre pour
                            le mercredi 18 septembre.
                        </div>
                    </div>

                    <h4>✍️ Saisie par Jour - Mode d'Emploi</h4>

                    <div class="steps">
                        <div class="step-item">
                            <strong>Sélectionner la semaine</strong> : Cliquez sur la semaine dans le sélecteur (ex:
                            38)
                        </div>
                        <div class="step-item">
                            <strong>Choisir le jour</strong> : Cliquez sur le jour dans le calendrier hebdomadaire
                            (ex: MER 18)
                        </div>
                        <div class="step-item">
                            <strong>Zone de saisie s'ouvre</strong> : Un champ texte apparaît pour ce jour
                            spécifique
                        </div>
                        <div class="step-item">
                            <strong>Écrire l'observation</strong> : Notez ce qui s'est passé ce jour-là
                        </div>
                        <div class="step-item">
                            <strong>Sauvegarder</strong> : Cliquez sur "Enregistrer" → Un point vert ● apparaît sur
                            le jour
                        </div>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple visuel - Saisie pour le Mercredi 18</h5>
                        <div class="code-block">
                            <strong>FICHE ÉLÈVE : DUPONT Marie - 6A</strong>
                            <strong>SEMAINE 38 : du 16/09/2025 au 22/09/2025</strong>

                            ┌─────────────────────────────────────────────────────────────────┐
                            │ CALENDRIER DE LA SEMAINE │
                            ├─────┬─────┬─────┬─────┬─────┬─────┬─────────────────────────────┤
                            │ LUN │ MAR │<span style="background:#FFA500;color:#000;"> MER </span>│ JEU │ VEN │ SAM
                            │ DIM │
                            │ 16 │ 17 │<span style="background:#FFA500;color:#000;"> 18 </span>│ 19 │ 20 │ 21 │ 22 │
                            │ ● │ ● │ │ ● │ ● │ │ │
                            └─────┴─────┴─────┴─────┴─────┴─────┴─────────────────────────────┘
                            ↑
                            Jour sélectionné (fond orange)

                            <strong>📝 SAISIE POUR LE MERCREDI 18 SEPTEMBRE 2025</strong>
                            ┌─────────────────────────────────────────────────────────────────┐
                            │ Que s'est-il passé ce jour ? │
                            │ │
                            │ [Mercredi 18/09 : ]│
                            │ [- Sortie scolaire au musée d'histoire ]│
                            │ [- Comportement exemplaire toute la journée ]│
                            │ [- A pris des notes détaillées pour le compte-rendu ]│
                            │ [- Félicitée par Mme Dubois (prof d'histoire) ]│
                            │ [- Retour à 16h30, aucun incident ]│
                            │ [ ]│
                            │ [ ]│
                            └─────────────────────────────────────────────────────────────────┘

                            [Annuler] [Enregistrer]

                            <strong>APRÈS ENREGISTREMENT :</strong>
                            ┌─────┬─────┬─────┬─────┬─────┬─────┬─────────────────────────────┤
                            │ LUN │ MAR │ MER │ JEU │ VEN │ SAM │ DIM │
                            │ 16 │ 17 │ 18 │ 19 │ 20 │ 21 │ 22 │
                            │ ● │ ● │ <span style="color:#4CAF50;">●</span> │ ● │ ● │ │ │
                            └─────┴─────┴─────┴─────┴─────┴─────┴─────────────────────────────┘
                            ↑
                            Point vert ajouté = données enregistrées
                        </div>
                    </div>

                    <div class="warning-box">
                        <strong>💡 Astuce :</strong> Vous pouvez saisir jour par jour pour plus de précision,
                        ou faire une saisie globale pour toute la semaine. Le calendrier hebdomadaire permet
                        les deux approches selon vos besoins.
                    </div>

                    <h4>📝 Zone de Saisie Hebdomadaire - Que noter ?</h4>
                    <p>
                        Grande zone de texte libre où le CPE note <strong>TOUT ce qui concerne le comportement
                            et la vie scolaire</strong> de l'élève pendant la semaine.
                    </p>

                    <div class="feature-box">
                        <h5>✍️ Quoi écrire dans cette zone ?</h5>
                        <ul class="feature-list">
                            <li><strong>Comportement général</strong> : Attitude en classe, dans les couloirs, à la
                                cantine
                            </li>
                            <li><strong>Incidents</strong> : Bagarres, insolences, bavardages excessifs</li>
                            <li><strong>Événements positifs</strong> : Aide à un camarade, participation à un projet
                            </li>
                            <li><strong>Absences/Retards</strong> : Si significatifs ou répétés</li>
                            <li><strong>Contacts avec les parents</strong> : Appels, mails, RDV</li>
                            <li><strong>Actions entreprises</strong> : Punitions, heures de colle, félicitations
                            </li>
                            <li><strong>Progrès ou régressions</strong> : Évolution par rapport aux semaines
                                précédentes
                            </li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple CONCRET - Semaine 38 (du 16/09 au 22/09/2025)</h5>
                        <div class="code-block">
                            <strong>DUPONT Marie - 6A - Semaine 38</strong>

                            <strong>Lundi 16/09 :</strong>
                            - Arrivée en retard de 15 min (justifié - RDV médical, certificat fourni)
                            - Comportement correct en cours
                            - A aidé spontanément Lucas P. en difficulté en maths

                            <strong>Mardi 17/09 :</strong>
                            - Journée sans problème
                            - Participation active en cours de français (félicitée par Mme Martin)
                            - Attitude exemplaire à la cantine

                            <strong>Mercredi 18/09 :</strong>
                            - INCIDENT à 12h45 : Dispute avec Emma L. à la cantine
                            Motif : Conflit pour une place assise
                            Action : Médiation immédiate par AED Durand
                            Résultat : Excuses mutuelles, situation réglée
                            - Après-midi : comportement correct

                            <strong>Jeudi 19/09 :</strong>
                            - Aucun problème signalé
                            - Concentrée et calme toute la journée

                            <strong>Vendredi 20/09 :</strong>
                            - Participation au club théâtre (15h-17h)
                            - Très investie, félicitée par l'animatrice
                            - Comportement irréprochable

                            <strong>BILAN DE LA SEMAINE :</strong>
                            Semaine globalement POSITIVE malgré l'incident du mercredi.
                            Marie montre de réels progrès dans la gestion de ses émotions.
                            L'incident a été bien géré, excuses sincères.
                            À ENCOURAGER et FÉLICITER pour son investissement au club théâtre.

                            <strong>CONTACT PARENTS :</strong>
                            Appel téléphonique à la mère le 18/09 à 17h pour l'informer
                            de l'incident. Mère compréhensive, s'engage à en discuter avec Marie.
                        </div>
                    </div>

                    <div class="example-box">
                        <h5>💡 Autre exemple - Semaine difficile (Semaine 36)</h5>
                        <div class="code-block">
                            <strong>MARTIN Lucas - 5B - Semaine 36</strong>

                            <strong>Lundi 02/09 :</strong>
                            - Retard non justifié de 25 min
                            - Insolence envers M. Dubois (prof de maths) : "Vos cours sont nuls"
                            - Mot dans le carnet + 1h de retenue mercredi

                            <strong>Mardi 03/09 :</strong>
                            - Nouveau retard de 15 min (non justifié)
                            - Oubli du matériel en SVT (3ème fois ce mois)
                            - Bavardages incessants en cours d'anglais
                            - Convocation au bureau CPE à 16h : Lucas reconnaît ses torts mais
                            attitude désinvolte

                            <strong>Mercredi 04/09 :</strong>
                            - Absent à l'heure de retenue (fuite)
                            - Retrouvé dans la cour en train de jouer au foot
                            - Sanction aggravée : 2h de retenue samedi matin

                            <strong>Jeudi 05/09 :</strong>
                            - INCIDENT GRAVE : Bagarre avec Thomas D. à la récréation
                            Motif : Moqueries sur l'apparence physique
                            Témoins : 3 élèves + 1 surveillant
                            Blessures : Lèvre fendue (Thomas), ecchymose (Lucas)
                            Action : Convocation IMMÉDIATE des 2 familles

                            <strong>Vendredi 06/09 :</strong>
                            - Exclusion temporaire de cours (décision du chef d'établissement)
                            - RDV parents + Lucas + CPE + Principal à 14h
                            Présents : Mère de Lucas, M. le Principal, CPE
                            Décision : Avertissement officiel + travail d'intérêt général
                            (aide à la bibliothèque 2h/semaine pendant 1 mois)

                            <strong>BILAN DE LA SEMAINE :</strong>
                            Semaine TRÈS PROBLÉMATIQUE. Accumulation d'incidents.
                            Lucas montre un manque total de respect des règles.
                            Attitude provocatrice et désinvolte.

                            <strong>MESURES PRISES :</strong>
                            ✓ Avertissement officiel notifié
                            ✓ TIG : 2h/semaine à la bibliothèque (4 semaines)
                            ✓ Suivi hebdomadaire renforcé par CPE
                            ✓ Contrat de comportement signé par Lucas et ses parents
                            ✓ Prochain incident = conseil de discipline

                            <strong>À SURVEILLER DE PRÈS LA SEMAINE PROCHAINE</strong>
                        </div>
                    </div>

                    <h4>🎨 Les 4 Statuts Colorés - Qualification Rapide</h4>
                    <p>
                        En plus du texte libre, vous devez attribuer un <strong>statut coloré</strong> à chaque
                        semaine.
                        C'est une qualification rapide qui permet de voir d'un coup d'œil comment s'est passée la
                        semaine.
                    </p>

                    <table>
                        <thead>
                            <tr>
                                <th>Bouton</th>
                                <th>Couleur</th>
                                <th>Quand l'utiliser</th>
                                <th>Exemple de situation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>À surveiller</strong></td>
                                <td><span style="color: #F44336;">●●● ROUGE</span></td>
                                <td>Comportement problématique grave ou récurrent</td>
                                <td>3+ incidents, violence, insolence grave, exclusion de cours</td>
                            </tr>
                            <tr>
                                <td><strong>Mitigé</strong></td>
                                <td><span style="color: #FF9800;">●●● ORANGE</span></td>
                                <td>Comportement variable, instable</td>
                                <td>Quelques bons jours alternés avec incidents mineurs</td>
                            </tr>
                            <tr>
                                <td><strong>En progrès</strong></td>
                                <td><span style="color: #FFEB3B;">●●● JAUNE</span></td>
                                <td>Amélioration visible par rapport aux semaines précédentes</td>
                                <td>Élève qui était "À surveiller" et qui fait des efforts</td>
                            </tr>
                            <tr>
                                <td><strong>Bon</strong></td>
                                <td><span style="color: #4CAF50;">●●● VERT</span></td>
                                <td>Comportement exemplaire, aucun problème</td>
                                <td>Semaine parfaite, élève modèle, aucun incident</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="example-box">
                        <h5>💡 Exemple d'évolution sur 6 semaines</h5>
                        <div class="code-block">
                            <strong>MARTIN Lucas - Évolution Septembre-Octobre</strong>

                            <strong>Semaine 36</strong> : <span style="color:#F44336;">●●● À surveiller</span>
                            "Nombreux incidents : retards, insolence, bagarre.
                            Avertissement officiel. Contrat de comportement signé."

                            <strong>Semaine 37</strong> : <span style="color:#F44336;">●●● À surveiller</span>
                            "Encore des difficultés : 2 retards, bavardages.
                            Mais pas de violence. Léger mieux."

                            <strong>Semaine 38</strong> : <span style="color:#FF9800;">●●● Mitigé</span>
                            "Amélioration légère. Jours corrects alternés avec bavardages.
                            Pas d'incident grave. Encouragements donnés."

                            <strong>Semaine 39</strong> : <span style="color:#FFEB3B;">●●● En progrès</span>
                            "Nette amélioration ! Un seul rappel à l'ordre.
                            Comportement globalement correct. Félicitations transmises."

                            <strong>Semaine 40</strong> : <span style="color:#FFEB3B;">●●● En progrès</span>
                            "Confirmation des progrès. Attitude respectueuse.
                            Ponctualité correcte. À continuer !"

                            <strong>Semaine 41</strong> : <span style="color:#4CAF50;">●●● Bon</span>
                            "Semaine parfaite ! Aucun incident. Comportement exemplaire.
                            Félicitations officielles. Parents informés du progrès."
                        </div>
                    </div>

                    <h4>🕐 Horodatage "créer le :" <span class="badge badge-new">NOUVEAU</span></h4>
                    <div class="success-box">
                        <p><strong>Affichage automatique de la date et heure de création</strong></p>
                        <p>
                            Chaque fois que vous enregistrez une observation pour une semaine, le logiciel
                            affiche automatiquement <strong>QUAND</strong> cette observation a été créée.
                        </p>
                        <p>
                            Format : <code style="color:#FFA500;">créer le : JJ/MM/AAAA HH:MM:SS</code>
                        </p>
                        <p>
                            <strong>Utilité :</strong> Traçabilité complète, preuve en cas de litige,
                            historique précis des saisies.
                        </p>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple d'horodatage</h5>
                        <div class="code-block">
                            Semaine 38 - Statut : <span style="color:#4CAF50;">●●● Bon</span>

                            <span style="color:#FFA500;">créer le : 20/09/2025 16:45:23</span>

                            "Excellente semaine pour Marie. Comportement irréprochable.
                            Participation active au club théâtre..."

                            <em>→ Cette observation a été saisie le vendredi 20 septembre 2025
                                à 16h45 (donc à la fin de la semaine 38)</em>
                        </div>
                    </div>

                    <h3>3.4 Modes de Saisie : Jour par Jour vs Saisie Globale Hebdomadaire ⭐</h3>
                    <p>
                        LOGECPE offre <strong>deux approches de saisie</strong> pour s'adapter à votre façon de travailler.
                        Vous pouvez passer de l'une à l'autre à tout moment selon vos besoins.
                    </p>

                    <h4>📅 Mode 1 : Saisie Jour par Jour (Détaillée)</h4>
                    <div class="feature-box">
                        <h5>🎯 Quand utiliser ce mode ?</h5>
                        <ul class="feature-list">
                            <li><strong>Suivi quotidien précis</strong> : Vous notez les événements au jour le jour</li>
                            <li><strong>Incidents à tracer</strong> : Chaque incident a sa propre entrée datée</li>
                            <li><strong>Élèves à surveiller</strong> : Besoin d'un historique détaillé jour par jour</li>
                            <li><strong>Justifications</strong> : Documentation précise pour procédures disciplinaires</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple - Saisie Jour par Jour</h5>
                        <div class="code-block">
                            <strong>SEMAINE 38</strong> - Calendrier :
                            [ LUN 16 ● ] [ MAR 17 ● ] [ MER 18 ] [ JEU 19 ● ] [ VEN 20 ● ]

                            <strong>Lundi 16</strong> : Retard de 15 min (justifié - RDV médical)
                            <strong>Mardi 17</strong> : Participation active en cours de français
                            <strong>Mercredi 18</strong> : (vide - rien à signaler)
                            <strong>Jeudi 19</strong> : Incident à la cantine - dispute avec un camarade
                            <strong>Vendredi 20</strong> : Comportement exemplaire, félicitations

                            → Chaque jour a sa propre observation isolée
                        </div>
                    </div>

                    <h4>📝 Mode 2 : Saisie Globale Hebdomadaire (Synthèse)</h4>
                    <div class="feature-box">
                        <h5>🎯 Quand utiliser ce mode ?</h5>
                        <ul class="feature-list">
                            <li><strong>Bilan de fin de semaine</strong> : Vous faites un récapitulatif global le vendredi</li>
                            <li><strong>Élèves sans problème</strong> : Pas besoin de détailler jour par jour</li>
                            <li><strong>Vision d'ensemble</strong> : Vous préférez une synthèse narrative</li>
                            <li><strong>Gain de temps</strong> : Saisie unique pour toute la semaine</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple - Saisie Globale Hebdomadaire</h5>
                        <div class="code-block">
                            <strong>SEMAINE 38 - Bilan global :</strong>

                            Bonne semaine dans l'ensemble pour Marie. Comportement correct.

                            Points positifs :
                            - Participation active en cours de français (mardi)
                            - Investissement au club théâtre (vendredi)

                            Points d'attention :
                            - Un incident à la cantine jeudi (dispute mineure, réglée rapidement)

                            Conclusion : Semaine satisfaisante. Marie poursuit ses progrès.

                            → Une seule observation narrative pour toute la semaine
                        </div>
                    </div>

                    <div class="tip-box">
                        <strong>💡 Astuce Pratique :</strong> Vous pouvez <strong>MIXER</strong> les deux approches !
                        <ul>
                            <li>Saisie jour par jour pour les élèves à surveiller (incidents fréquents)</li>
                            <li>Saisie globale hebdomadaire pour les élèves sans problème particulier</li>
                            <li>Vous adaptez selon le profil de chaque élève</li>
                        </ul>
                    </div>

                    <h3>3.5 Rétroactivité et Date d'Effet <span class="badge badge-new">NOUVEAU</span></h3>
                    <p>
                        Une fonctionnalité <strong>ESSENTIELLE</strong> pour gérer les observations passées
                        et maintenir un historique précis même en cas de saisie différée.
                    </p>

                    <h4>🕰️ Qu'est-ce que la Rétroactivité ?</h4>
                    <div class="feature-box">
                        <p>
                            La rétroactivité vous permet de <strong>créer des observations pour des semaines passées</strong>
                            tout en conservant la date réelle où l'événement s'est produit.
                        </p>
                        <p>
                            <strong>Cas d'usage typiques :</strong>
                        </p>
                        <ul class="feature-list">
                            <li>Vous étiez absent(e) et devez saisir les événements survenus pendant votre absence</li>
                            <li>Un collègue vous transmet des informations sur un incident de la semaine dernière</li>
                            <li>Vous devez compléter l'historique d'un élève avant un conseil de discipline</li>
                            <li>Vous rattrapez vos saisies en retard après une période chargée</li>
                        </ul>
                    </div>

                    <h4>📅 Date d'Effet : Quelle est la différence ?</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Horodatage</th>
                                <th>Date d'Effet</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>"créer le :"</strong></td>
                                <td><strong>"Date d'effet :"</strong></td>
                            </tr>
                            <tr>
                                <td>QUAND vous avez saisi l'observation dans le logiciel</td>
                                <td>QUAND l'événement s'est réellement produit</td>
                            </tr>
                            <tr>
                                <td>Date de création technique (traçabilité informatique)</td>
                                <td>Date réelle du jour concerné (vérité des faits)</td>
                            </tr>
                            <tr>
                                <td>Automatique, non modifiable</td>
                                <td>Choisie par vous lors de la saisie rétroactive</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="example-box">
                        <h5>💡 Exemple Concret - Saisie Rétroactive</h5>
                        <div class="code-block">
                            <strong>SITUATION :</strong>
                            Nous sommes le vendredi 27 septembre 2025.
                            Vous devez saisir un incident qui s'est produit le lundi 16 septembre
                            (semaine 38) mais vous ne l'avez pas saisi à ce moment-là.

                            <strong>ACTION :</strong>
                            1. Vous sélectionnez la semaine 38 dans le sélecteur
                            2. Vous cliquez sur "LUN 16" dans le calendrier hebdomadaire
                            3. Vous saisissez l'observation
                            4. Vous enregistrez

                            <strong>RÉSULTAT AFFICHÉ :</strong>

                            <span style="color:#FFA500;">Date d'effet : 16/09/2025</span> (Lundi - jour de l'incident)
                            <span style="color:#888;">créer le : 27/09/2025 14:30:15</span> (Vendredi - jour de la saisie)

                            "Incident à la cantine : dispute verbale avec Lucas P.
                            Médiation effectuée par AED Durand. Excuses présentées."

                            <strong>INTERPRÉTATION :</strong>
                            → L'incident a EU LIEU le lundi 16 septembre (Date d'effet)
                            → Mais la saisie informatique a été faite le 27 septembre (créer le)
                            → La traçabilité est complète et transparente
                        </div>
                    </div>

                    <div class="warning-box">
                        <strong>⚠️ Important - Transparence et Traçabilité :</strong>
                        <p>
                            Les DEUX dates sont affichées pour garantir la transparence :
                        </p>
                        <ul>
                            <li><strong>Date d'effet</strong> : Prouve QUAND l'événement s'est produit</li>
                            <li><strong>créer le</strong> : Prouve QUAND vous l'avez enregistré</li>
                        </ul>
                        <p>
                            En cas de procédure disciplinaire ou de litige avec une famille,
                            cette double traçabilité protège le CPE en montrant la bonne foi
                            de la démarche (pas de création rétroactive abusive).
                        </p>
                    </div>

                    <h4>✍️ Comment faire une saisie rétroactive ?</h4>
                    <div class="steps">
                        <div class="step-item">
                            <strong>Ouvrir la fiche élève</strong> concerné(e)
                        </div>
                        <div class="step-item">
                            <strong>Sélectionner la semaine passée</strong> dans le sélecteur de semaines (ex: Semaine 36)
                        </div>
                        <div class="step-item">
                            <strong>Choisir le jour précis</strong> dans le calendrier hebdomadaire (ex: MER 11)
                        </div>
                        <div class="step-item">
                            <strong>Saisir l'observation</strong> comme d'habitude
                        </div>
                        <div class="step-item">
                            <strong>Enregistrer</strong> : La date d'effet sera automatiquement celle du jour sélectionné
                        </div>
                    </div>

                    <div class="success-box">
                        <strong>✅ Résultat :</strong> L'observation apparaîtra dans l'historique à la bonne date
                        (date d'effet), tout en conservant la trace de sa date de création réelle (créer le).
                    </div>

                    <h3>3.6 Mise en Forme du Texte - Styles de Caractère <span class="badge badge-new">NOUVEAU</span></h3>
                    <p>
                        Le logiciel permet de mettre en forme vos observations pour améliorer la lisibilité
                        et mettre en évidence les informations importantes.
                    </p>

                    <div class="feature-box">
                        <h5>✍️ Options de Formatage Disponibles</h5>
                        <ul class="feature-list">
                            <li><strong>Gras</strong> : Pour mettre en évidence des éléments importants (noms, dates clés, décisions)</li>
                            <li><strong>Italique</strong> : Pour les citations, remarques secondaires, ou contexte</li>
                            <li><strong>Souligné</strong> : Pour attirer l'attention sur un point critique</li>
                            <li><strong>Retours à la ligne</strong> : Pour structurer le texte et le rendre plus lisible</li>
                            <li><strong>Listes à puces</strong> : Pour énumérer des faits ou actions de manière claire</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple avec Mise en Forme</h5>
                        <div class="code-block">
                            <strong>Semaine 40 - Statut : ●●● À surveiller</strong>

                            <strong>INCIDENT GRAVE - Jeudi 10/10/2025</strong>

                            <strong>Faits :</strong>
                            • Violence verbale envers Mme MARTIN (prof de maths)
                            • Insulte : <em>"Vos cours sont nuls, vous ne servez à rien"</em>
                            • Devant toute la classe (30 élèves témoins)

                            <strong>Mesures immédiates :</strong>
                            • Exclusion de cours immédiate (10h30)
                            • Convocation au bureau CPE
                            • Appel téléphonique aux parents (11h00)

                            <strong>Décision :</strong>
                            <u>Exclusion temporaire de l'établissement - 3 jours</u>
                            Du vendredi 11/10 au mardi 15/10 inclus

                            <strong>Suite :</strong>
                            RDV obligatoire parents + élève + CPE + Principal
                            Fixé au mercredi 16/10 à 14h00

                            <em>Note : Historique chargé pour cet élève (4 incidents ce trimestre).
                            Risque de conseil de discipline si récidive.</em>
                        </div>
                    </div>

                    <div class="tip-box">
                        <strong>💡 Bonnes Pratiques de Mise en Forme :</strong>
                        <ul>
                            <li><strong>Gras</strong> : Dates importantes, noms de personnes, décisions officielles</li>
                            <li><strong>Italique</strong> : Citations exactes, remarques contextuelles</li>
                            <li><strong>Souligné</strong> : Sanctions graves, alertes importantes</li>
                            <li><strong>Structure</strong> : Utilisez des paragraphes courts et des puces pour la clarté</li>
                            <li><strong>Modération</strong> : N'abusez pas de la mise en forme (rester professionnel)</li>
                        </ul>
                    </div>

                    <h3>3.7 Rubriques Personnalisées (Mots Fréquents)</h3>
                    <p>
                        Le logiciel permet d'ajouter des <strong>rubriques personnalisées</strong> pour catégoriser
                        rapidement les observations.
                    </p>

                    <div class="feature-box">
                        <h5>📋 Exemples de rubriques personnalisées</h5>
                        <ul class="feature-list">
                            <li><strong>Mots fréquents</strong> : Insolence, Bavardage, Retard, Violence, Aide,
                                Progrès</li>
                            <li><strong>Lieux</strong> : Cantine, Cour, Couloir, Classe, Permanence</li>
                            <li><strong>Types d'incidents</strong> : Verbal, Physique, Matériel</li>
                            <li><strong>Actions</strong> : Médiation, Punition, Félicitation, Convocation</li>
                        </ul>
                    </div>

                    <h3>3.8 Fonctions Supplémentaires de la Fiche</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Bouton</th>
                                <th>Fonction</th>
                                <th>Utilité</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Sauvegarder</strong></td>
                                <td>Enregistrer les modifications</td>
                                <td>Forcer la sauvegarde immédiate (sinon auto)</td>
                            </tr>
                            <tr>
                                <td><strong>Imprimer</strong></td>
                                <td>Imprimer la fiche élève</td>
                                <td>Pour les rencontres parents, conseils de classe</td>
                            </tr>
                            <tr>
                                <td><strong>Copier nom</strong></td>
                                <td>Copier le nom dans le presse-papier</td>
                                <td>Pour coller dans un autre document</td>
                            </tr>
                            <tr>
                                <td><strong>Ajouter RDV</strong></td>
                                <td>Créer un RDV for cet élève</td>
                                <td>Accès rapide sans quitter la fiche</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>3.6 Cas d'Usage Pratiques</h3>

                    <div class="tip-box">
                        <h4>💡 Conseil #1 : Remplir la fiche en fin de semaine</h4>
                        <p>
                            Prenez 10-15 minutes chaque <strong>vendredi après-midi</strong> pour remplir les fiches
                            des élèves qui ont eu des incidents ou des événements marquants cette semaine.
                        </p>
                        <p>
                            <strong>Astuce :</strong> Gardez un petit carnet pour noter les incidents au fil de la
                            semaine,
                            puis reportez-les dans LOGECPE le vendredi.
                        </p>
                    </div>

                    <div class="tip-box">
                        <h4>💡 Conseil #2 : Utiliser les statuts pour le suivi rapide</h4>
                        <p>
                            Les statuts colorés permettent de voir d'un coup d'œil l'évolution d'un élève sur
                            l'année.
                            En conseil de classe, vous pouvez dire : "Lucas a eu 8 semaines rouges au 1er trimestre,
                            mais 12 semaines vertes au 2ème trimestre."
                        </p>
                    </div>

                    <div class="tip-box">
                        <h4>💡 Conseil #3 : Préparer les RDV parents</h4>
                        <p>
                            Avant un RDV avec les parents, ouvrez la fiche élève et relisez les 4-5 dernières
                            semaines.
                            Vous aurez un historique précis et daté de tous les incidents et progrès.
                        </p>
                    </div>
                </div>

                <!-- SECTION 4: STATISTIQUES -->
                <div class="section" id="stats">
                    <h2>4. 📊 Statistiques et Analyses</h2>

                    <h3>4.1 Accès aux Statistiques</h3>
                    <p>
                        Cliquez sur le bouton <span
                            style="background: #2196F3; color: white; padding: 3px 10px; border-radius: 5px;">
                            📈 Statistique</span> dans la barre de navigation supérieure pour accéder au tableau de
                        bord analytique.
                    </p>

                    <div class="feature-box">
                        <h4>🎯 Rôle du module Statistiques</h4>
                        <p>
                            Le module Statistiques permet d'<strong>analyser et visualiser</strong> toutes les
                            données
                            collectées sur les élèves : RDV, observations, motifs récurrents, évolution dans le
                            temps.
                        </p>
                        <p>
                            <strong>Utilité :</strong> Prendre du recul, identifier les tendances, préparer les
                            bilans
                            trimestriels, détecter les élèves à risque.
                        </p>
                    </div>

                    <h3>4.2 Filtres de Période</h3>
                    <p>En haut de l'écran, 4 boutons permettent de filtrer les données par période :</p>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 20%;">Bouton</th>
                                <th style="width: 40%;">Période couverte</th>
                                <th style="width: 40%;">Exemple d'utilisation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Jour</strong></td>
                                <td>Journée en cours (00h00 à 23h59)</td>
                                <td>Voir les RDV et observations du jour même</td>
                            </tr>
                            <tr>
                                <td><strong>Semaine</strong></td>
                                <td>Semaine en cours (Lundi à Dimanche)</td>
                                <td>Bilan hebdomadaire pour la réunion d'équipe</td>
                            </tr>
                            <tr>
                                <td><strong>Mois</strong></td>
                                <td>Mois calendaire complet</td>
                                <td>Rapport mensuel pour la direction</td>
                            </tr>
                            <tr>
                                <td><strong>Année</strong></td>
                                <td>Année scolaire (Septembre à Juillet)</td>
                                <td>Bilan annuel, conseils de classe de fin d'année</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>4.3 Cartes Métriques - Indicateurs Clés</h3>
                    <p>
                        En haut du tableau de bord, <strong>4 cartes colorées</strong> affichent les chiffres clés
                        de la période sélectionnée :
                    </p>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 25%;">Carte</th>
                                <th style="width: 15%;">Couleur</th>
                                <th style="width: 30%;">Valeur affichée</th>
                                <th style="width: 30%;">Exemple</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>📊 Total RDV</strong></td>
                                <td style="background: #2196F3; color: white; padding: 5px; border-radius: 3px;">
                                    Bleu</td>
                                <td>Nombre total de RDV créés</td>
                                <td><strong style="font-size: 2rem; color: #2196F3;">42</strong> RDV ce mois</td>
                            </tr>
                            <tr>
                                <td><strong>✅ Validés</strong></td>
                                <td style="background: #4CAF50; color: white; padding: 5px; border-radius: 3px;">
                                    Vert</td>
                                <td>RDV confirmés et effectués</td>
                                <td><strong style="font-size: 2rem; color: #4CAF50;">35</strong> validés (83%)</td>
                            </tr>
                            <tr>
                                <td><strong>⏳ En Attente</strong></td>
                                <td style="background: #FF9800; color: white; padding: 5px; border-radius: 3px;">
                                    Orange</td>
                                <td>RDV planifiés non confirmés</td>
                                <td><strong style="font-size: 2rem; color: #FF9800;">5</strong> en attente (12%)
                                </td>
                            </tr>
                            <tr>
                                <td><strong>❌ Annulés</strong></td>
                                <td style="background: #F44336; color: white; padding: 5px; border-radius: 3px;">
                                    Rouge</td>
                                <td>RDV annulés ou absents</td>
                                <td><strong style="font-size: 2rem; color: #F44336;">2</strong> annulés (5%)</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="example-box">
                        <h5>💡 Exemple visuel - Cartes métriques</h5>
                        <div class="code-block">
                            ┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐
                            │ 📊 TOTAL RDV │ ✅ VALIDÉS │ ⏳ EN ATTENTE │ ❌ ANNULÉS │
                            │ │ │ │ │
                            │ <strong style="color:#2196F3;">42</strong> │ <strong style="color:#4CAF50;">35</strong> │
                            <strong style="color:#FF9800;">5</strong> │
                            <strong style="color:#F44336;">2</strong> │
                            │ │ (83%) │ (12%) │ (5%) │
                            └─────────────────┴─────────────────┴─────────────────┴─────────────────┘
                        </div>
                    </div>

                    <h3>4.4 Graphiques Disponibles</h3>

                    <h4>📈 Graphique 1 : Tendances Hebdomadaires RDV</h4>
                    <div class="feature-box">
                        <p><strong>Type :</strong> Graphique en barres empilées</p>
                        <p><strong>Affichage :</strong></p>
                        <ul class="feature-list">
                            <li><strong>Axe X</strong> : Semaines (S36, S37, S38, S39...)</li>
                            <li><strong>Axe Y</strong> : Nombre de RDV</li>
                            <li><strong>Barres empilées</strong> : Chaque barre divisée par statut
                                (Vert/Orange/Rouge)</li>
                        </ul>
                        <p><strong>Utilité :</strong> Identifier les périodes chargées, anticiper les pics
                            d'activité</p>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple visuel - Tendances hebdomadaires</h5>
                        <div class="code-block">
                            <strong>TENDANCES HEBDOMADAIRES - RDV PAR SEMAINE</strong>

                            Nombre
                            de RDV
                            15 │ ┌──┐
                            │ │ │
                            12 │ ┌──┐ │ │
                            │ │ │ │ │
                            9 │ ┌──┐ │ │ ┌──┐ │ │
                            │ │ │ │ │ │ │ │ │
                            6 │ ┌──┐ │ │ ┌──┐ │ │ │ │ │ │
                            │ │ │ │ │ │ │ │ │ │ │ │ │
                            3 │ │<span style="color:#4CAF50;">██</span>│ │<span style="color:#4CAF50;">██</span>│
                            │<span style="color:#4CAF50;">██</span>│ │<span style="color:#4CAF50;">██</span>│ │<span
                                style="color:#4CAF50;">██</span>│ │<span style="color:#4CAF50;">██</span>│
                            │ │<span style="color:#4CAF50;">██</span>│ │<span style="color:#4CAF50;">██</span>│
                            │<span style="color:#4CAF50;">██</span>│ │<span style="color:#4CAF50;">██</span>│ │<span
                                style="color:#4CAF50;">██</span>│ │<span style="color:#4CAF50;">██</span>│
                            0 └──┴──┴──┴──┴──┴──┴──┴──┴────┴──┴────┴──┴───
                            S36 S37 S38 S39 S40 S41 S42 S43

                            Légende : <span style="color:#4CAF50;">██</span> Validés <span
                                style="color:#FF9800;">██</span> En attente <span style="color:#F44336;">██</span>
                            Annulés
                        </div>
                    </div>

                    <h4>🍩 Graphique 2 : Répartition par Statut</h4>
                    <div class="feature-box">
                        <p><strong>Type :</strong> Graphique circulaire (donut chart)</p>
                        <p><strong>Affichage :</strong></p>
                        <ul class="feature-list">
                            <li><strong>Segments colorés</strong> : Vert (Validés), Orange (En attente), Rouge
                                (Annulés)</li>
                            <li><strong>Pourcentages</strong> : Calculés automatiquement</li>
                            <li><strong>Nombre</strong> : Affiché au centre ou sur chaque segment</li>
                        </ul>
                        <p><strong>Utilité :</strong> Vue d'ensemble rapide de la situation, taux de réussite des
                            RDV</p>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple visuel - Répartition par statut</h5>
                        <div class="code-block">
                            <strong>RÉPARTITION DES RDV PAR STATUT</strong>

                            ╭─────────────╮
                            ╭───┤ ├───╮
                            ╭─┤ │ │ ├─╮
                            ╱ │ │ <strong>42</strong> │ │ ╲
                            │<span style="color:#F44336;">██</span>│ │ │ │<span style="color:#4CAF50;">██</span>│
                            │<span style="color:#F44336;">██</span>│ │ RDV │ │<span style="color:#4CAF50;">██</span>│
                            │ │ │ TOTAL │ │<span style="color:#4CAF50;">██</span>│
                            ╲ │ │ │ │<span style="color:#4CAF50;">██</span>╱
                            ╰─┤ │ │ ├<span style="color:#4CAF50;">█</span>╯
                            ╰───┤ ├<span style="color:#FF9800;">█</span>─╯
                            ╰─────────────╯

                            <span style="color:#4CAF50;">██████████████</span> Validés : 35 (83%)
                            <span style="color:#FF9800;">███</span> En attente : 5 (12%)
                            <span style="color:#F44336;">█</span> Annulés : 2 (5%)
                        </div>
                    </div>

                    <h4>📊 Graphique 3 : Top 10 des Motifs Principaux</h4>
                    <div class="feature-box">
                        <p><strong>Type :</strong> Barres horizontales</p>
                        <p><strong>Affichage :</strong></p>
                        <ul class="feature-list">
                            <li><strong>Liste</strong> : Top 10 des motifs les plus fréquents</li>
                            <li><strong>Barres proportionnelles</strong> : Longueur = nombre d'occurrences</li>
                            <li><strong>Nombre affiché</strong> : À droite de chaque barre</li>
                            <li><strong>Cliquable</strong> : Clic sur un motif → liste des élèves concernés</li>
                        </ul>
                        <p><strong>Utilité :</strong> Identifier les problématiques récurrentes, adapter les actions
                        </p>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple visuel - Top 10 des motifs</h5>
                        <div class="code-block">
                            <strong>TOP 10 DES MOTIFS DE RDV</strong>

                            Problème de comportement <span style="color:#2196F3;">████████████████████</span> 18
                            Absence répétée <span style="color:#2196F3;">███████████████</span> 12
                            Résultats scolaires <span style="color:#2196F3;">████████████</span> 10
                            Orientation scolaire <span style="color:#2196F3;">█████████</span> 8
                            Conflit entre élèves <span style="color:#2196F3;">███████</span> 6
                            Harcèlement <span style="color:#2196F3;">█████</span> 4
                            Support psychologique <span style="color:#2196F3;">████</span> 3
                            Tutorat Mathématiques <span style="color:#2196F3;">███</span> 2
                            Problème familial <span style="color:#2196F3;">██</span> 2
                            Insolence répétée <span style="color:#2196F3;">█</span> 1

                            <em>→ Cliquez sur un motif pour voir la liste des élèves concernés</em>
                        </div>
                    </div>

                    <h3>4.5 Recherche et Filtres Avancés</h3>
                    <p>Une barre de recherche permet de filtrer les statistiques par :</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Critère</th>
                                <th>Exemple</th>
                                <th>Résultat</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- GUIDE_COMPLET_PART_3 -->
                </div>
            </div>
            </div>
        </body>

        </html>
    </template>
    <template id="guide-content-Guide_Detaille_Fiche_Eleve">
        <!DOCTYPE html>
        <html lang="fr">

        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Guide Détaillé - Fiche Élève & Synthèse - LOGECPE</title>
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }

                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
                    color: #fff;
                    padding: 40px 20px;
                    line-height: 1.7;
                }

                .container {
                    max-width: 1400px;
                    margin: 0 auto;
                }

                header {
                    text-align: center;
                    margin-bottom: 50px;
                    padding: 40px;
                    background: rgba(255, 165, 0, 0.1);
                    border-radius: 15px;
                    border: 2px solid #FFA500;
                }

                h1 {
                    font-size: 3rem;
                    color: #FFA500;
                    margin-bottom: 15px;
                }

                .subtitle {
                    font-size: 1.2rem;
                    color: #ccc;
                }

                .section {
                    background: rgba(255, 255, 255, 0.05);
                    border: 2px solid #444;
                    border-radius: 15px;
                    padding: 40px;
                    margin-bottom: 50px;
                }

                h2 {
                    font-size: 2.5rem;
                    color: #FFA500;
                    margin-bottom: 30px;
                    padding-bottom: 15px;
                    border-bottom: 3px solid #FFA500;
                }

                h3 {
                    font-size: 1.8rem;
                    color: #FFB84D;
                    margin: 30px 0 20px 0;
                }

                h4 {
                    font-size: 1.4rem;
                    color: #FFC266;
                    margin: 20px 0 15px 0;
                }

                .example-box {
                    background: rgba(76, 175, 80, 0.1);
                    border-left: 4px solid #4CAF50;
                    padding: 20px;
                    margin: 20px 0;
                    border-radius: 5px;
                }

                .example-box h5 {
                    color: #4CAF50;
                    margin-bottom: 10px;
                    font-size: 1.1rem;
                }

                .feature-box {
                    background: rgba(33, 150, 243, 0.1);
                    border-left: 4px solid #2196F3;
                    padding: 20px;
                    margin: 20px 0;
                    border-radius: 5px;
                }

                .warning-box {
                    background: rgba(255, 152, 0, 0.1);
                    border-left: 4px solid #FF9800;
                    padding: 20px;
                    margin: 20px 0;
                    border-radius: 5px;
                }

                .tip-box {
                    background: rgba(156, 39, 176, 0.1);
                    border-left: 4px solid #9C27B0;
                    padding: 20px;
                    margin: 20px 0;
                    border-radius: 5px;
                }

                ul.feature-list {
                    list-style: none;
                    padding-left: 0;
                }

                ul.feature-list li {
                    padding: 10px 0 10px 30px;
                    position: relative;
                }

                ul.feature-list li:before {
                    content: "▸";
                    color: #FFA500;
                    font-weight: bold;
                    position: absolute;
                    left: 0;
                    font-size: 1.3rem;
                }

                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }

                th,
                td {
                    padding: 12px;
                    text-align: left;
                    border-bottom: 1px solid #444;
                }

                th {
                    background: rgba(255, 165, 0, 0.2);
                    color: #FFA500;
                    font-weight: bold;
                }

                tr:hover {
                    background: rgba(255, 255, 255, 0.05);
                }

                .highlight {
                    color: #FFA500;
                    font-weight: bold;
                }

                .code-block {
                    background: #1a1a1a;
                    border: 1px solid #444;
                    border-radius: 5px;
                    padding: 15px;
                    margin: 15px 0;
                    font-family: 'Courier New', monospace;
                    overflow-x: auto;
                }

                .screenshot-box {
                    background: rgba(0, 0, 0, 0.3);
                    border: 2px dashed #666;
                    border-radius: 10px;
                    padding: 30px;
                    text-align: center;
                    margin: 20px 0;
                    color: #888;
                    font-style: italic;
                }

                .steps {
                    counter-reset: step-counter;
                }

                .step-item {
                    counter-increment: step-counter;
                    margin: 25px 0;
                    padding-left: 60px;
                    position: relative;
                }

                .step-item:before {
                    content: counter(step-counter);
                    position: absolute;
                    left: 0;
                    top: 0;
                    background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
                    color: #000;
                    font-weight: bold;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.2rem;
                }
            </style>
        </head>

        <body>
            <div class="container">
                <header>
                    <h1>📋 GUIDE DÉTAILLÉ</h1>
                    <p class="subtitle">Fiche Élève & Synthèse Annuelle - LOGECPE NTP34</p>
                    <p class="subtitle" style="margin-top: 15px; font-size: 1rem;">
                        Exemples concrets et cas d'usage
                    </p>
                    <p class="subtitle" style="margin-top: 10px; font-size: 0.9rem; color: #4CAF50;">
                        ✨ Version 2026.1 - Mis à jour le 24/01/2026 - Nouvelles fonctionnalités documentées
                    </p>
                </header>

                <!-- SECTION 1: FICHE ÉLÈVE COMPLÈTE -->
                <div class="section">
                    <h2>👤 LA FICHE ÉLÈVE - Guide Complet</h2>

                    <div class="success-box" style="background: rgba(76, 175, 80, 0.15); border-left: 4px solid #4CAF50; padding: 20px; margin-bottom: 30px;">
                        <h4 style="color: #4CAF50; margin-bottom: 15px;">✨ Nouvelles Fonctionnalités Documentées (Version 2026.1)</h4>
                        <ul class="feature-list">
                            <li><strong>Calendrier Hebdomadaire</strong> : Saisie précise jour par jour avec calendrier visuel interactif</li>
                            <li><strong>Modes de Saisie</strong> : Choisissez entre saisie quotidienne détaillée ou bilan hebdomadaire global</li>
                            <li><strong>Rétroactivité</strong> : Créez des observations pour des semaines passées avec traçabilité complète</li>
                            <li><strong>Date d'Effet</strong> : Double horodatage (date réelle de l'événement + date de création informatique)</li>
                            <li><strong>Mise en Forme</strong> : Styles de caractère (gras, italique, souligné) pour améliorer la lisibilité</li>
                            <li><strong>Horodatage Automatique</strong> : Chaque observation est datée et horodatée automatiquement</li>
                        </ul>
                        <p style="margin-top: 15px; font-style: italic; color: #FFA500;">
                            💡 Ces fonctionnalités renforcent la traçabilité et la flexibilité de votre travail quotidien.
                        </p>
                    </div>

                    <h3>1.1 Vue d'ensemble de la Fiche</h3>
                    <p>
                        La fiche élève est l'outil central du logiciel. Elle regroupe TOUTES les informations
                        concernant un élève sur une seule interface organisée en onglets.
                    </p>

                    <h3>1.2 Onglet "Vue d'ensemble"</h3>
                    <div class="feature-box">
                        <h4>📌 Informations affichées</h4>
                        <ul class="feature-list">
                            <li><strong>Identité</strong> : Nom, Prénom, Date de naissance</li>
                            <li><strong>Scolarité</strong> : Classe actuelle, Année scolaire</li>
                            <li><strong>Photo</strong> : Photo de l'élève (optionnelle)</li>
                            <li><strong>Coordonnées</strong> : Adresse, Téléphone</li>
                            <li><strong>Résumé rapide</strong> : Dernières observations, statut général</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple concret - Vue d'ensemble</h5>
                        <div class="code-block">
                            <strong>DUPONT Marie</strong>
                            Classe : 6A
                            Date de naissance : 15/03/2012 (13 ans)
                            Adresse : 12 rue des Lilas, 75015 Paris
                            Téléphone : 01 23 45 67 89

                            <strong>Résumé rapide :</strong>
                            • Dernière observation : Semaine 38 - Statut "Bon"
                            • RDV à venir : 28/01/2026 à 14:30
                            • Absences : 2 jours ce trimestre
                        </div>
                    </div>

                    <h3>1.3 Onglet "Information Hebdomadaire" ⭐ PRINCIPAL</h3>
                    <p>
                        C'est l'onglet le PLUS UTILISÉ au quotidien. Il permet de suivre le comportement
                        et les observations semaine par semaine.
                    </p>

                    <h4>🗓️ Le Sélecteur de Semaines</h4>
                    <div class="feature-box">
                        <p><strong>Affichage :</strong> Bande horizontale avec toutes les semaines de l'année scolaire
                        </p>
                        <ul class="feature-list">
                            <li>Semaines numérotées : 36, 37, 38, 39... jusqu'à 51, puis 1 à 29</li>
                            <li><strong>Semaine active</strong> : Fond orange vif avec bordure brillante</li>
                            <li><strong>Semaines avec données</strong> : Coche verte ✓ en haut à droite</li>
                            <li><strong>Semaines vides</strong> : Gris clair sans coche</li>
                            <li><strong>Clic</strong> : Charge instantanément les données de la semaine</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple visuel - Sélecteur de semaines</h5>
                        <div class="code-block">
                            ┌────┬────┬────┬────┬────┬────┬────┬────┐
                            │ 36 │ 37 │<span style="background:#FFA500;color:#000;"> 38✓</span>│ 39✓│ 40 │ 41✓│ 42 │ 43
                            │
                            └────┴────┴────┴────┴────┴────┴────┴────┘

                            Semaine 38 = Sélectionnée (orange)
                            ✓ = Données enregistrées pour cette semaine
                        </div>
                    </div>

                    <h4>� Calendrier Hebdomadaire - Saisie Jour par Jour <span
                            style="background:#4CAF50;color:#000;padding:3px 8px;border-radius:5px;font-size:0.8rem;">NOUVEAU</span>
                    </h4>
                    <div class="feature-box">
                        <p><strong>Après avoir sélectionné une semaine, choisissez le jour précis :</strong></p>
                        <ul class="feature-list">
                            <li><strong>7 boutons</strong> : Un pour chaque jour (Lundi à Dimanche)</li>
                            <li><strong>Jour sélectionné</strong> : Surligné en orange</li>
                            <li><strong>Jours avec données</strong> : Marqués d'un point vert "●"</li>
                            <li><strong>Jours vides</strong> : Pas de marqueur visible</li>
                            <li><strong>Clic sur un jour</strong> : Ouvre la zone de saisie pour ce jour spécifique</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple d'utilisation du Calendrier Hebdomadaire</h5>
                        <div class="code-block">
                            <strong>SEMAINE 38 : du 16/09/2025 au 22/09/2025</strong>

                            ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┐
                            │ LUN │ MAR │ MER │ JEU │ VEN │ SAM │ DIM │
                            │ 16 │ 17 │ 18 │ 19 │ 20 │ 21 │ 22 │
                            │ ● │ ● │ │ ● │ ● │ │ │
                            └─────┴─────┴─────┴─────┴─────┴─────┴─────┘

                            <strong>Lecture :</strong>
                            • Lundi 16, Mardi 17, Jeudi 19, Vendredi 20 = Ont des données (●)
                            • Mercredi 18, Samedi 21, Dimanche 22 = Vides (pas de ●)

                            <strong>Action :</strong>
                            Si je clique sur "MER 18", une zone de saisie s'ouvre spécifiquement
                            pour le mercredi 18 septembre. Je peux alors noter ce qui s'est passé
                            ce jour-là uniquement.

                            <strong>Avantage :</strong>
                            Traçabilité précise jour par jour, idéale pour les élèves à surveiller
                            ou pour documenter des incidents ponctuels.
                        </div>
                    </div>

                    <div class="tip-box">
                        <strong>💡 Quand utiliser le calendrier jour par jour ?</strong>
                        <ul class="feature-list">
                            <li>Élève à comportement difficile nécessitant un suivi quotidien</li>
                            <li>Incident grave à documenter avec date précise</li>
                            <li>Préparation d'un conseil de discipline (chronologie exacte)</li>
                            <li>Réponse à une contestation de famille (preuves datées)</li>
                        </ul>
                    </div>

                    <h4>�📝 Zone de Saisie Hebdomadaire</h4>
                    <p>Grande zone de texte libre pour noter tout ce qui concerne la semaine :</p>

                    <div class="example-box">
                        <h5>💡 Exemple de saisie - Semaine 38 (du 16/09 au 22/09)</h5>
                        <div class="code-block">
                            <strong>Lundi 16/09 :</strong>
                            - Arrivée en retard de 15 minutes (justifié - RDV médical)
                            - Participation active en cours de français
                            - A aidé un camarade en difficulté en mathématiques

                            <strong>Mardi 17/09 :</strong>
                            - Comportement exemplaire toute la journée
                            - A rendu son devoir de SVT en avance
                            - Félicitée par Mme Martin pour son investissement

                            <strong>Mercredi 18/09 :</strong>
                            - Incident à la cantine : dispute avec Lucas P.
                            - Médiation effectuée à 13h30
                            - Excuses présentées, situation réglée

                            <strong>Jeudi 19/09 :</strong>
                            - Très concentrée en cours
                            - Aucun problème signalé

                            <strong>Vendredi 20/09 :</strong>
                            - Participation au club théâtre
                            - Comportement irréprochable

                            <strong>Bilan de la semaine :</strong>
                            Semaine globalement positive malgré l'incident du mercredi.
                            Marie montre de réels progrès dans son comportement.
                            À encourager et féliciter.
                        </div>
                    </div>

                    <h4>🎨 Les 4 Statuts Colorés</h4>
                    <p>Qualification rapide de la semaine en un clic :</p>

                    <table>
                        <thead>
                            <tr>
                                <th>Bouton</th>
                                <th>Couleur</th>
                                <th>Quand l'utiliser</th>
                                <th>Exemple de situation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>À surveiller</strong></td>
                                <td><span style="color: #F44336;">●●● Rouge</span></td>
                                <td>Comportement problématique récurrent</td>
                                <td>3 incidents ou plus, insolence, violence</td>
                            </tr>
                            <tr>
                                <td><strong>Mitigé</strong></td>
                                <td><span style="color: #FF9800;">●●● Orange</span></td>
                                <td>Comportement variable, instable</td>
                                <td>Bons jours alternés avec incidents mineurs</td>
                            </tr>
                            <tr>
                                <td><strong>En progrès</strong></td>
                                <td><span style="color: #FFEB3B;">●●● Jaune</span></td>
                                <td>Amélioration visible par rapport aux semaines précédentes</td>
                                <td>Élève qui était "À surveiller" et qui s'améliore</td>
                            </tr>
                            <tr>
                                <td><strong>Bon</strong></td>
                                <td><span style="color: #4CAF50;">●●● Vert</span></td>
                                <td>Comportement exemplaire, aucun problème</td>
                                <td>Semaine parfaite, élève modèle</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="example-box">
                        <h5>💡 Exemple d'évolution sur 4 semaines</h5>
                        <div class="code-block">
                            <strong>Semaine 36</strong> : <span style="color:#F44336;">●●● À surveiller</span>
                            "Nombreux incidents : bavardages, insolence envers Mme Durand,
                            oubli de matériel répété. Convocation des parents prévue."

                            <strong>Semaine 37</strong> : <span style="color:#FF9800;">●●● Mitigé</span>
                            "Amélioration légère suite au RDV parents. Encore quelques
                            bavardages mais moins d'insolence. À continuer de surveiller."

                            <strong>Semaine 38</strong> : <span style="color:#FFEB3B;">●●● En progrès</span>
                            "Nette amélioration ! Comportement correct toute la semaine.
                            Un seul rappel à l'ordre. Félicitations transmises."

                            <strong>Semaine 39</strong> : <span style="color:#4CAF50;">●●● Bon</span>
                            "Semaine parfaite. Comportement exemplaire. Participation active.
                            Félicitations officielles en conseil de classe."
                        </div>
                    </div>

                    <h4>🕐 Horodatage "créer le :" <span
                            style="background:#4CAF50;color:#000;padding:3px 8px;border-radius:5px;font-size:0.8rem;">NOUVEAU</span>
                    </h4>
                    <div class="feature-box">
                        <p><strong>Affichage automatique :</strong></p>
                        <ul class="feature-list">
                            <li>Date ET heure précise de création de l'entrée</li>
                            <li>Format : <code>créer le : JJ/MM/AAAA HH:MM:SS</code></li>
                            <li>Permet de tracer l'historique exact des saisies</li>
                            <li>Utile pour les audits et justifications</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple d'horodatage</h5>
                        <div class="code-block">
                            Semaine 38 - Statut : <span style="color:#4CAF50;">●●● Bon</span>

                            <span style="color:#FFA500;">créer le : 20/09/2025 16:45:23</span>

                            "Excellente semaine pour Marie. Comportement irréprochable..."

                            <em>→ Cette entrée a été créée le 20 septembre 2025 à 16h45
                                (donc le vendredi de la semaine 38)</em>
                        </div>
                    </div>

                    <h4>📅 Modes de Saisie : Jour par Jour vs Saisie Globale <span
                            style="background:#4CAF50;color:#000;padding:3px 8px;border-radius:5px;font-size:0.8rem;">NOUVEAU</span>
                    </h4>
                    <div class="feature-box">
                        <p><strong>Deux approches pour s'adapter à votre méthode de travail :</strong></p>
                        
                        <h5>🔹 Mode 1 : Saisie Jour par Jour (Détaillée)</h5>
                        <p><strong>Idéal pour :</strong> Suivi quotidien précis, élèves à surveiller, incidents à documenter</p>
                        <p>Utilisez le calendrier hebdomadaire pour cliquer sur chaque jour (LUN, MAR, MER, etc.) 
                           et saisir une observation spécifique pour ce jour.</p>
                        
                        <h5>🔹 Mode 2 : Saisie Globale Hebdomadaire (Synthèse)</h5>
                        <p><strong>Idéal pour :</strong> Bilan de fin de semaine, élèves sans incident, vision d'ensemble</p>
                        <p>Saisissez directement dans la zone de texte principale une observation narrative 
                           couvrant toute la semaine en une seule fois.</p>
                    </div>

                    <div class="tip-box">
                        <strong>💡 Astuce :</strong> Vous pouvez <strong>MIXER</strong> les deux modes selon les élèves !
                        <ul class="feature-list">
                            <li>Jour par jour pour les élèves à problèmes (traçabilité détaillée)</li>
                            <li>Saisie globale pour les élèves sans incident (gain de temps)</li>
                        </ul>
                    </div>

                    <h4>🕰️ Rétroactivité et Date d'Effet <span
                            style="background:#4CAF50;color:#000;padding:3px 8px;border-radius:5px;font-size:0.8rem;">NOUVEAU</span>
                    </h4>
                    <div class="feature-box">
                        <p><strong>Créez des observations pour des semaines passées tout en gardant la traçabilité complète.</strong></p>
                        <p>Le système affiche <strong>DEUX dates</strong> :</p>
                        <ul class="feature-list">
                            <li><strong>Date d'effet</strong> : Quand l'événement s'est réellement produit</li>
                            <li><strong>créer le</strong> : Quand vous avez saisi l'observation dans le logiciel</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple de Saisie Rétroactive</h5>
                        <div class="code-block">
                            <strong>Situation :</strong> Nous sommes le vendredi 27/09/2025.
                            Vous devez saisir un incident du lundi 16/09 (semaine 38).

                            <strong>Vous faites :</strong>
                            1. Sélectionner semaine 38 → cliquer LUN 16 → saisir → enregistrer

                            <strong>Le système affiche :</strong>
                            <span style="color:#FFA500;">Date d'effet : 16/09/2025</span> ← Jour de l'incident
                            <span style="color:#888;">créer le : 27/09/2025 14:30:15</span> ← Jour de la saisie

                            "Incident à la cantine : dispute avec Lucas P. Médiation effectuée."

                            <strong>Interprétation :</strong>
                            → L'incident a eu lieu le 16 (date d'effet)
                            → Mais la saisie a été faite le 27 (créer le)
                            → Transparence totale = protection CPE en cas de litige
                        </div>
                    </div>

                    <div class="warning-box">
                        <strong>⚠️ Pourquoi cette double date ?</strong>
                        <p>En cas de procédure disciplinaire ou de contestation d'une famille, 
                           la double traçabilité prouve votre bonne foi et évite toute accusation 
                           de création rétroactive abusive d'observations.</p>
                    </div>

                    <h4>✍️ Mise en Forme du Texte - Styles de Caractère <span
                            style="background:#4CAF50;color:#000;padding:3px 8px;border-radius:5px;font-size:0.8rem;">NOUVEAU</span>
                    </h4>
                    <div class="feature-box">
                        <p><strong>Améliorez la lisibilité de vos observations avec le formatage de texte :</strong></p>
                        <ul class="feature-list">
                            <li><strong>Gras</strong> : Noms, dates importantes, décisions officielles</li>
                            <li><strong>Italique</strong> : Citations exactes, remarques contextuelles</li>
                            <li><strong>Souligné</strong> : Sanctions graves, alertes critiques</li>
                            <li><strong>Listes à puces</strong> : Énumération claire de faits ou actions</li>
                            <li><strong>Paragraphes structurés</strong> : Organisation logique des informations</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Exemple avec Mise en Forme</h5>
                        <div class="code-block">
                            <strong>INCIDENT GRAVE - Jeudi 10/10/2025</strong>

                            <strong>Faits :</strong>
                            • Violence verbale envers Mme MARTIN (prof de maths)
                            • Insulte : <em>"Vos cours sont nuls, vous ne servez à rien"</em>
                            • Devant toute la classe (30 témoins)

                            <strong>Mesures :</strong>
                            • Exclusion de cours immédiate (10h30)
                            • Convocation parents
                            • <u>Exclusion temporaire 3 jours</u>

                            <em>Note : 4ème incident ce trimestre. Risque conseil de discipline.</em>
                        </div>
                    </div>

                    <div class="tip-box">
                        <strong>💡 Bonnes pratiques :</strong>
                        <ul class="feature-list">
                            <li>Utilisez le gras pour structurer (titres, sous-sections)</li>
                            <li>L'italique pour les citations littérales (preuves)</li>
                            <li>Le soulignement avec parcimonie (seulement l'essentiel)</li>
                            <li>Restez professionnel : n'abusez pas du formatage</li>
                        </ul>
                    </div>

                    <h3>1.4 Onglet "Notes"</h3>
                    <p>Zone pour des observations générales qui ne sont pas liées à une semaine spécifique.</p>

                    <div class="example-box">
                        <h5>💡 Exemples d'utilisation de l'onglet Notes</h5>
                        <div class="code-block">
                            <strong>Notes générales sur Marie DUPONT :</strong>

                            • <strong>Contexte familial :</strong>
                            Parents divorcés, garde alternée (1 semaine/1 semaine)
                            Mère : 06 12 34 56 78 - Père : 06 98 76 54 32

                            • <strong>Particularités :</strong>
                            - Dyslexique (PAP en place depuis la 6ème)
                            - Besoin de temps supplémentaire pour les évaluations
                            - Très sensible aux remarques, préférer l'encouragement

                            • <strong>Points forts :</strong>
                            - Excellente en arts plastiques
                            - Très sociable, appréciée de ses camarades
                            - Sportive (handball en club)

                            • <strong>Points de vigilance :</strong>
                            - Tendance à se disperser en classe
                            - Besoin de cadre strict mais bienveillant
                            - Réagit mal au stress (examens)

                            • <strong>Historique important :</strong>
                            - Harcèlement subi en CM2 (école primaire)
                            - Suivi psychologique en cours
                            - Très bon contact avec l'infirmière scolaire
                        </div>
                    </div>

                    <h3>1.7 Création de Rubriques de Suivi <span
                            style="background:#FFA500;color:#000;padding:3px 8px;border-radius:5px;font-size:0.8rem;">NOUVEAU</span>
                    </h3>
                    <p>
                        Le bouton <span class="highlight">"RUBRIQUE"</span> permet de personnaliser la fiche élève en
                        ajoutant
                        des zones de suivi spécifiques, adaptées aux besoins de l'élève.
                        Cette fonctionnalité offre une flexibilité totale pour gérer des suivis particuliers (PPRE, PAP,
                        Discipline, Santé).
                    </p>

                    <div class="feature-box">
                        <h4>️ Fonctionnalités des Rubriques</h4>
                        <ul class="feature-list">
                            <li><strong>Création Illimitée</strong> : Ajoutez autant de rubriques que nécessaire via le
                                bouton
                                "Rubrique".</li>
                            <li><strong>Titre Personnalisable</strong> : Nommez chaque rubrique selon le contexte (ex:
                                "Suivi
                                Prof. Principal", "Infirmerie").</li>
                            <li><strong>Zone de Texte Dédiée</strong> : Chaque rubrique dispose de son propre espace de
                                notes,
                                indépendant des observations hebdomadaires.</li>
                            <li><strong>Persistance</strong> : Les rubriques sont sauvegardées avec la fiche élève et
                                restent
                                accessibles toute l'année.</li>
                        </ul>
                    </div>

                    <div class="example-box">
                        <h5>💡 Cas d'usage : Suivi PPRE et Cantine</h5>
                        <div class="code-block">
                            <strong>[ RUBRIQUE : SUIVI PPRE ]</strong>
                            Objectifs fixés :
                            1. Noter les devoirs dans l'agenda.
                            2. Lever la main avant de parler.

                            Bilan du mois : Objectif 1 acquis, Objectif 2 en cours d'acquisition.

                            <strong>[ RUBRIQUE : COMPORTEMENT CANTINE ]</strong>
                            Incident signalé le 12/10 : Jet de nourriture.
                            Punition effectuée.
                            Depuis : R.A.S, comportement correct.
                        </div>
                    </div>

                    <h3>1.8 Actions Rapides et Outils</h3>
                    <p>
                        La fiche élève centralise plusieurs outils pour optimiser votre productivité lors des entretiens
                        ou du
                        suivi administratif.
                    </p>

                    <div class="feature-box">
                        <h4> Bouton "Sauvegarder"</h4>
                        <p><strong>Emplacement :</strong> Bas de la fiche (Couleur Orange).</p>
                        <p>Enregistre immédiatement toutes les saisies en cours (Semaine active, Notes, Rubriques).
                            Utilisé pour
                            sécuriser les données avant de fermer la fiche.</p>
                    </div>

                    <div class="feature-box">
                        <h4>🖨️ Bouton "Imprimer"</h4>
                        <p><strong>Emplacement :</strong> Bas de la fiche (Couleur Gris Foncé).</p>
                        <p>Lance l'assistant d'impression pour générer une version papier de la fiche élève. Idéal pour
                            les
                            dossiers papiers ou les réunions.</p>
                    </div>

                    <div class="feature-box">
                        <h4>📋 Bouton "Copier nom"</h4>
                        <p><strong>Emplacement :</strong> En-tête à côté du nom (Couleur Bleu).</p>
                        <p>Copie instantanément le "Nom Prénom" de l'élève dans le presse-papier de votre ordinateur.
                            Pratique
                            pour coller l'identité dans un email (Pronote, Messagerie) sans risque d'erreur.</p>
                    </div>

                    <div class="feature-box">
                        <h4>📅 Bouton "Ajouter RDV"</h4>
                        <p><strong>Emplacement :</strong> En-tête (Couleur Rose).</p>
                        <p>Raccourci intelligent : Ouvre directement la fenêtre de prise de rendez-vous avec cet élève
                            déjà
                            sélectionné. Gain de temps assuré pour programmer une convocation.</p>
                    </div>

                </div>

                <!-- SECTION 2: SYNTHÈSE ANNUELLE -->
                <div class="section">
                    <h2>📊 SYNTHÈSE ANNUELLE - Guide Complet</h2>

                    <h3>2.1 Accès à la Synthèse Annuelle</h3>
                    <div class="feature-box">
                        <p><strong>Bouton :</strong> <span
                                style="background:#4CAF50;color:#fff;padding:5px 15px;border-radius:5px;">📊 Synthèse
                                Annuelle</span></p>
                        <p><strong>Emplacement :</strong> Barre de boutons principale en haut de l'écran</p>
                        <p><strong>Fonction :</strong> Génère un rapport complet sur l'année scolaire pour un ou
                            plusieurs
                            élèves</p>
                    </div>

                    <h3>2.2 Contenu de la Synthèse</h3>
                    <p>La synthèse annuelle compile TOUTES les données de l'année en un seul document imprimable.</p>

                    <h4>📋 Sections de la Synthèse</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Section</th>
                                <th>Contenu</th>
                                <th>Utilité</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>En-tête</strong></td>
                                <td>Nom, Prénom, Classe, Photo, Année scolaire</td>
                                <td>Identification rapide</td>
                            </tr>
                            <tr>
                                <td><strong>Vue d'ensemble</strong></td>
                                <td>Statistiques globales (présence, RDV, statuts)</td>
                                <td>Vision macro de l'année</td>
                            </tr>
                            <tr>
                                <td><strong>Graphique d'évolution</strong></td>
                                <td>Courbe des statuts semaine par semaine</td>
                                <td>Visualiser la progression</td>
                            </tr>
                            <tr>
                                <td><strong>Détail par trimestre</strong></td>
                                <td>Résumé de chaque trimestre</td>
                                <td>Analyse périodique</td>
                            </tr>
                            <tr>
                                <td><strong>Historique RDV</strong></td>
                                <td>Liste de tous les RDV de l'année</td>
                                <td>Traçabilité des rencontres</td>
                            </tr>
                            <tr>
                                <td><strong>Absences</strong></td>
                                <td>Bilan complet des absences/retards</td>
                                <td>Assiduité</td>
                            </tr>
                            <tr>
                                <td><strong>Observations marquantes</strong></td>
                                <td>Extraits des semaines clés</td>
                                <td>Points saillants</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="example-box">
                        <h5>💡 Exemple de Synthèse Annuelle Complète</h5>
                        <div class="code-block">
                            ═══════════════════════════════════════════════════════════════
                            SYNTHÈSE ANNUELLE - ANNÉE SCOLAIRE 2025-2026
                            ═══════════════════════════════════════════════════════════════

                            <strong>ÉLÈVE : DUPONT Marie</strong>
                            Classe : 6A
                            Date de naissance : 15/03/2012
                            Professeur principal : Mme MARTIN

                            ═══════════════════════════════════════════════════════════════
                            VUE D'ENSEMBLE
                            ═══════════════════════════════════════════════════════════════

                            <strong>📊 STATISTIQUES GLOBALES</strong>

                            Nombre de semaines suivies : 36 semaines
                            Taux de présence : 96,8%
                            Nombre de RDV : 4 (3 validés, 1 annulé)
                            Nombre d'incidents : 3 (tous résolus)

                            <strong>Répartition des statuts hebdomadaires :</strong>
                            • <span style="color:#4CAF50;">●</span> Bon (Vert) : 28 semaines (78%)
                            • <span style="color:#FFEB3B;">●</span> En progrès (Jaune) : 5 semaines (14%)
                            • <span style="color:#FF9800;">●</span> Mitigé (Orange) : 2 semaines (5%)
                            • <span style="color:#F44336;">●</span> À surveiller (Rouge) : 1 semaine (3%)

                            <strong>📈 ÉVOLUTION SUR L'ANNÉE</strong>

                            Semaines 36-40 : Démarrage difficile (1 rouge, 2 orange)
                            Semaines 41-50 : Amélioration progressive (5 jaune)
                            Semaines 1-15 : Stabilisation positive (majoritairement vert)
                            Semaines 16-29 : Excellent comportement (100% vert)

                            <strong>Tendance générale : ⬆️ PROGRESSION EXCELLENTE</strong>

                            ═══════════════════════════════════════════════════════════════
                            BILAN PAR TRIMESTRE
                            ═══════════════════════════════════════════════════════════════

                            <strong>🍂 TRIMESTRE 1 (Septembre - Décembre)</strong>

                            Statut dominant : <span style="color:#FF9800;">●</span> Mitigé
                            Présence : 95,2% (4 jours d'absence justifiée)

                            <strong>Points positifs :</strong>
                            ✓ Bonne intégration dans la classe
                            ✓ Participation active en cours
                            ✓ Relation correcte avec les enseignants

                            <strong>Points de vigilance :</strong>
                            ⚠ Bavardages fréquents en classe
                            ⚠ 2 incidents à la cantine (disputes)
                            ⚠ Oublis de matériel répétés

                            <strong>Actions menées :</strong>
                            • RDV parents le 15/09/2025
                            • Mise en place d'un contrat de comportement
                            • Suivi hebdomadaire renforcé

                            <strong>Appréciation :</strong>
                            "Trimestre d'adaptation. Marie doit apprendre à canaliser son
                            énergie et respecter les règles de vie collective. Des progrès
                            sont attendus pour le trimestre suivant."

                            ---

                            <strong>❄️ TRIMESTRE 2 (Janvier - Mars)</strong>

                            Statut dominant : <span style="color:#FFEB3B;">●</span> En progrès
                            Présence : 97,5% (2 jours d'absence justifiée)

                            <strong>Points positifs :</strong>
                            ✓ Nette amélioration du comportement
                            ✓ Moins de bavardages
                            ✓ Aucun incident majeur
                            ✓ Investissement dans le club théâtre

                            <strong>Points de vigilance :</strong>
                            ⚠ Encore quelques oublis de matériel
                            ⚠ Tendance à se disperser en fin de journée

                            <strong>Actions menées :</strong>
                            • Félicitations transmises aux parents
                            • Encouragements réguliers
                            • Responsabilisation (déléguée de classe)

                            <strong>Appréciation :</strong>
                            "Trimestre très positif. Marie a su tirer les leçons du 1er
                            trimestre. Elle fait preuve de maturité et d'investissement.
                            À poursuivre dans cette voie."

                            ---

                            <strong>🌸 TRIMESTRE 3 (Avril - Juin)</strong>

                            Statut dominant : <span style="color:#4CAF50;">●</span> Bon
                            Présence : 98,1% (1 jour d'absence justifiée)

                            <strong>Points positifs :</strong>
                            ✓ Comportement exemplaire
                            ✓ Élève modèle pour la classe
                            ✓ Aide ses camarades en difficulté
                            ✓ Excellente participation au spectacle de fin d'année

                            <strong>Points de vigilance :</strong>
                            Aucun point négatif à signaler

                            <strong>Actions menées :</strong>
                            • Félicitations officielles en conseil de classe
                            • Proposition pour le tableau d'honneur
                            • Encouragement à poursuivre en 5ème

                            <strong>Appréciation :</strong>
                            "Trimestre remarquable. Marie a su se dépasser et devenir
                            une élève exemplaire. Elle est un exemple pour ses camarades.
                            Félicitations pour cette belle progression !"

                            ═══════════════════════════════════════════════════════════════
                            HISTORIQUE DES RENDEZ-VOUS
                            ═══════════════════════════════════════════════════════════════

                            <strong>RDV #1 - 15/09/2025 à 14:30</strong>
                            Type : RDV Famille
                            Participants : Mère, CPE, Prof. principal
                            Motif : Bilan de rentrée et incidents
                            Statut : ✅ Validé
                            Résumé : Parents informés des difficultés. Mise en place d'un
                            suivi hebdomadaire. Mère très coopérative.

                            <strong>RDV #2 - 10/11/2025 à 16:00</strong>
                            Type : Rendez-vous standard
                            Participants : Marie, CPE
                            Motif : Point d'étape comportement
                            Statut : ✅ Validé
                            Résumé : Félicitations pour les progrès. Marie consciente de
                            ses efforts. Encouragement à continuer.

                            <strong>RDV #3 - 15/01/2026 à 15:00</strong>
                            Type : RDV Famille
                            Participants : Père, CPE
                            Motif : Bilan semestriel
                            Statut : ❌ Annulé (Père malade)
                            Résumé : Reporté au 22/01/2026

                            <strong>RDV #4 - 22/01/2026 à 15:00</strong>
                            Type : RDV Famille
                            Participants : Père, CPE, Prof. principal
                            Motif : Bilan semestriel (report)
                            Statut : ✅ Validé
                            Résumé : Bilan très positif. Père satisfait de l'évolution.
                            Félicitations transmises.

                            ═══════════════════════════════════════════════════════════════
                            BILAN DES ABSENCES
                            ═══════════════════════════════════════════════════════════════

                            <strong>Total absences : 7 jours (96,8% de présence)</strong>

                            Détail :
                            • Maladie : 5 jours (justifiés)
                            • RDV médicaux : 2 demi-journées (justifiés)
                            • Absences non justifiées : 0

                            <strong>Total retards : 3 (dont 1 non justifié)</strong>

                            <strong>Appréciation :</strong>
                            Assiduité excellente. Toutes les absences sont justifiées.
                            Aucun problème d'absentéisme.

                            ═══════════════════════════════════════════════════════════════
                            OBSERVATIONS MARQUANTES
                            ═══════════════════════════════════════════════════════════════

                            <strong>Semaine 36 (Septembre) - <span style="color:#F44336;">●</span> À surveiller</strong>
                            "Première semaine difficile. Nombreux bavardages, 2 incidents
                            à la cantine. Convocation des parents nécessaire."

                            <strong>Semaine 41 (Octobre) - <span style="color:#FFEB3B;">●</span> En progrès</strong>
                            "Amélioration notable suite au RDV parents. Marie fait des
                            efforts visibles. À encourager."

                            <strong>Semaine 15 (Janvier) - <span style="color:#4CAF50;">●</span> Bon</strong>
                            "Semaine parfaite. Marie est devenue déléguée de classe.
                            Elle prend son rôle très au sérieux. Félicitations !"

                            <strong>Semaine 25 (Mai) - <span style="color:#4CAF50;">●</span> Bon</strong>
                            "Participation remarquable au spectacle de fin d'année.
                            Marie a brillé sur scène. Élève exemplaire."

                            ═══════════════════════════════════════════════════════════════
                            CONCLUSION ANNUELLE
                            ═══════════════════════════════════════════════════════════════

                            <strong>Évolution globale : ⭐⭐⭐⭐⭐ EXCELLENTE</strong>

                            Marie DUPONT a connu une année scolaire remarquable marquée
                            par une progression constante et significative.

                            Après un démarrage difficile en septembre, elle a su écouter
                            les conseils, s'investir et devenir une élève modèle.

                            Sa capacité à se remettre en question et à progresser est
                            exemplaire. Elle est aujourd'hui une référence pour ses
                            camarades.

                            <strong>Recommandations pour l'année prochaine :</strong>
                            ✓ Continuer sur cette lancée
                            ✓ Maintenir l'investissement dans les activités extra-scolaires
                            ✓ Envisager des responsabilités (déléguée, tutorat)

                            <strong>Passage en 5ème : ✅ RECOMMANDÉ</strong>

                            ═══════════════════════════════════════════════════════════════
                            Document généré le 28/06/2026 à 15:30
                            CPE : M. DURAND
                            Signature : _______________
                            ═══════════════════════════════════════════════════════════════
                        </div>
                    </div>

                    <h3>2.3 Utilisation de la Synthèse</h3>
                    <div class="feature-box">
                        <h4>📌 Cas d'usage de la Synthèse Annuelle</h4>
                        <ul class="feature-list">
                            <li><strong>Conseils de classe</strong> : Document de référence pour les bilans</li>
                            <li><strong>Rencontres parents</strong> : Support visuel pour les entretiens</li>
                            <li><strong>Passage en classe supérieure</strong> : Aide à la décision</li>
                            <li><strong>Dossiers disciplinaires</strong> : Historique complet et traçable</li>
                            <li><strong>Orientation</strong> : Vue d'ensemble pour les choix d'orientation</li>
                            <li><strong>Archivage</strong> : Conservation des données annuelles</li>
                        </ul>
                    </div>

                    <div class="tip-box">
                        <h4>💡 Conseils d'utilisation</h4>
                        <ul class="feature-list">
                            <li>Générez la synthèse en <strong>fin de trimestre</strong> pour les conseils de classe
                            </li>
                            <li>Imprimez-la en <strong>fin d'année</strong> pour l'archivage</li>
                            <li>Partagez-la avec les <strong>parents</strong> lors des bilans annuels</li>
                            <li>Utilisez-la comme <strong>base de discussion</strong> pour l'orientation</li>
                            <li>Conservez-la dans le <strong>dossier élève</strong> pour référence future</li>
                        </ul>
                    </div>
                </div>

                <!-- SECTION 3: GUIDE DE RÉFÉRENCE RAPIDE -->
                <div class="section" style="background: rgba(76, 175, 80, 0.1); border: 2px solid #4CAF50; padding: 30px; margin-top: 50px;">
                    <h2 style="color: #4CAF50;">⚡ Guide de Référence Rapide - Nouvelles Fonctionnalités</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 25px;">
                        
                        <div style="background: rgba(255, 165, 0, 0.1); border-left: 4px solid #FFA500; padding: 15px;">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">📅 Calendrier Hebdomadaire</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">
                                <strong>Comment l'utiliser :</strong><br>
                                1. Sélectionnez une semaine<br>
                                2. Cliquez sur un jour (LUN, MAR, MER...)<br>
                                3. Saisissez l'observation pour ce jour précis<br>
                                <em style="color: #4CAF50;">→ Traçabilité jour par jour</em>
                            </p>
                        </div>

                        <div style="background: rgba(255, 165, 0, 0.1); border-left: 4px solid #FFA500; padding: 15px;">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">🔄 Deux Modes de Saisie</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">
                                <strong>Mode Jour :</strong> Cliquez sur chaque jour<br>
                                <strong>Mode Semaine :</strong> Saisie globale dans la zone principale<br>
                                <em style="color: #4CAF50;">→ Adaptez selon l'élève</em>
                            </p>
                        </div>

                        <div style="background: rgba(255, 165, 0, 0.1); border-left: 4px solid #FFA500; padding: 15px;">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">⏰ Rétroactivité</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">
                                <strong>Comment faire :</strong><br>
                                1. Sélectionnez une semaine passée<br>
                                2. Cliquez sur le jour concerné<br>
                                3. Saisissez l'observation<br>
                                <em style="color: #4CAF50;">→ Date d'effet = jour réel de l'événement</em>
                            </p>
                        </div>

                        <div style="background: rgba(255, 165, 0, 0.1); border-left: 4px solid #FFA500; padding: 15px;">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">📆 Double Horodatage</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">
                                <strong>Date d'effet :</strong> Quand c'est arrivé<br>
                                <strong>créer le :</strong> Quand vous l'avez saisi<br>
                                <em style="color: #4CAF50;">→ Transparence totale = protection CPE</em>
                            </p>
                        </div>

                        <div style="background: rgba(255, 165, 0, 0.1); border-left: 4px solid #FFA500; padding: 15px;">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">✍️ Mise en Forme</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">
                                <strong>Gras :</strong> Noms, dates clés<br>
                                <strong>Italique :</strong> Citations, contexte<br>
                                <strong>Souligné :</strong> Sanctions graves<br>
                                <em style="color: #4CAF50;">→ Lisibilité optimale</em>
                            </p>
                        </div>

                        <div style="background: rgba(255, 165, 0, 0.1); border-left: 4px solid #FFA500; padding: 15px;">
                            <h4 style="color: #FFA500; margin-bottom: 10px;">🎯 Conseil Pratique</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">
                                <strong>Élèves difficiles :</strong> Mode jour + formatage<br>
                                <strong>Élèves sans souci :</strong> Mode semaine globale<br>
                                <em style="color: #4CAF50;">→ Flexibilité selon le profil</em>
                            </p>
                        </div>

                    </div>

                    <div style="margin-top: 25px; padding: 20px; background: rgba(76, 175, 80, 0.2); border-radius: 10px;">
                        <h4 style="color: #4CAF50; margin-bottom: 15px;">💡 Points Clés à Retenir</h4>
                        <ul class="feature-list" style="column-count: 2; column-gap: 30px;">
                            <li>Le calendrier hebdomadaire permet une saisie jour par jour précise</li>
                            <li>Vous pouvez mixer les modes de saisie selon vos besoins</li>
                            <li>La rétroactivité conserve l'historique exact (date d'effet)</li>
                            <li>Le double horodatage protège le CPE juridiquement</li>
                            <li>La mise en forme améliore la lisibilité des observations</li>
                            <li>Toutes les fonctionnalités sont sauvegardées automatiquement</li>
                        </ul>
                    </div>
                </div>

                <!-- SECTION 4: IMPORT ET GESTION DES ÉLÈVES -->
                <div class="section" id="import" style="background: rgba(33, 150, 243, 0.1); border: 2px solid #2196F3; padding: 30px; margin-top: 50px;">
                    <h2 style="color: #2196F3;">📥 Import et Gestion des Élèves</h2>
                    
                    <div style="background: rgba(33, 150, 243, 0.15); border-left: 4px solid #2196F3; padding: 20px; margin: 25px 0;">
                        <h3 style="color: #2196F3; margin-bottom: 15px;">🎯 Vue d'ensemble du Module</h3>
                        <p style="font-size: 1.05rem; line-height: 1.8;">
                            Le <strong>Module Import Établissement</strong> est une interface intégrée complète qui permet de <strong>créer, modifier, importer et gérer</strong> la liste des élèves avant de les charger directement dans LOGECPE. Plus besoin de télécharger puis réimporter un fichier CSV !
                        </p>
                        <p style="margin-top: 15px; font-size: 0.95rem; color: #81D4FA;">
                            <strong>Avantage majeur :</strong> Workflow simplifié en un seul clic - préparez vos données dans le module, puis cliquez sur "Charger dans LOGECPE" pour une intégration immédiate.
                        </p>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">🚀 Ouvrir le Module Import</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #4CAF50; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            <strong>Étape 1 :</strong> Dans la barre d'outils principale de LOGECPE, cliquez sur le bouton <strong style="color: #2196F3;">📥 Import Établissement</strong><br>
                            <strong>Résultat :</strong> Un overlay en plein écran s'affiche avec l'interface du module Import
                        </p>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">🖥️ Interface du Module</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 25px 0;">
                        
                        <div style="background: rgba(76, 175, 80, 0.15); border: 2px solid #4CAF50; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #4CAF50; margin-bottom: 12px;">📊 Zone Statistiques</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">
                                • <strong>Nombre d'élèves</strong> : Total actuel<br>
                                • <strong>Classes uniques</strong> : Nombre de classes différentes<br>
                                • <strong>Dernière sauvegarde</strong> : Date et heure
                            </p>
                        </div>

                        <div style="background: rgba(255, 152, 0, 0.15); border: 2px solid #FF9800; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #FF9800; margin-bottom: 12px;">🛠️ Barre d'Outils (6 boutons)</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">
                                • <strong>Ajouter un élève</strong> (formulaire manuel)<br>
                                • <strong>Importer CSV</strong> (fichier)<br>
                                • <strong>Importer Excel</strong> (.xlsx, .xls)<br>
                                • <strong>RPP</strong> (presse-papier auto-détection)<br>
                                • <strong>Générer exemple</strong> (données test)<br>
                                • <strong>Charger dans LOGECPE</strong> ✨
                            </p>
                        </div>

                        <div style="background: rgba(156, 39, 176, 0.15); border: 2px solid #9C27B0; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #9C27B0; margin-bottom: 12px;">📋 Tableau de Données</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">
                                • Affichage de tous les élèves<br>
                                • 12 colonnes : Nom, Prénom, Classe, Sexe, Tél Parents, Tél Perso, Mail, Adresse, Code Postal, Ville, Date de naissance, Responsable<br>
                                • Actions : ✏️ Modifier, 🗑️ Supprimer<br>
                                • Recherche en temps réel
                            </p>
                        </div>

                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">✍️ Ajouter un Élève Manuellement</h3>
                    <div class="step-box" style="background: rgba(76, 175, 80, 0.1); border: 2px solid #4CAF50; padding: 25px; margin-bottom: 25px; border-radius: 10px;">
                        <ol style="font-size: 1rem; line-height: 2; padding-left: 25px;">
                            <li>Cliquez sur <strong style="color: #4CAF50;">➕ Ajouter un élève</strong></li>
                            <li>Une fenêtre modale s'ouvre avec le <strong>formulaire de saisie</strong></li>
                            <li>Remplissez les champs requis :
                                <ul style="margin: 10px 0 10px 30px; line-height: 1.8;">
                                    <li><strong>Nom</strong> (obligatoire)</li>
                                    <li><strong>Prénom</strong> (obligatoire)</li>
                                    <li><strong>Classe</strong> (obligatoire)</li>
                                    <li><strong>Sexe</strong> : M/F (optionnel)</li>
                                    <li>Coordonnées : téléphones, mail, adresse...</li>
                                </ul>
                            </li>
                            <li>Cliquez sur <strong style="color: #4CAF50;">💾 Enregistrer</strong></li>
                            <li>L'élève apparaît immédiatement dans le tableau</li>
                        </ol>
                        <div class="tip-box" style="background: rgba(33, 150, 243, 0.15); border-left: 4px solid #2196F3; padding: 15px; margin-top: 20px;">
                            <strong style="color: #2196F3;">💡 Astuce :</strong> Pour modifier un élève existant, cliquez sur l'icône ✏️ dans la colonne Actions. Le formulaire se pré-remplit automatiquement.
                        </div>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-border: 2px solid #2196F3; padding-bottom: 10px;">📂 Importer un Fichier CSV</h3>
                    <div class="step-box" style="background: rgba(255, 152, 0, 0.1); border: 2px solid #FF9800; padding: 25px; margin-bottom: 25px; border-radius: 10px;">
                        <ol style="font-size: 1rem; line-height: 2; padding-left: 25px;">
                            <li>Cliquez sur <strong style="color: #FF9800;">📂 Importer CSV</strong></li>
                            <li>Sélectionnez votre fichier CSV (export Pronote, EDT...)</li>
                            <li>Le module détecte automatiquement :
                                <ul style="margin: 10px 0 10px 30px; line-height: 1.8;">
                                    <li><strong>Encodage</strong> : UTF-16LE, UTF-16BE, UTF-8 avec BOM, UTF-8</li>
                                    <li><strong>Séparateur</strong> : tabulation, point-virgule, virgule</li>
                                    <li><strong>En-têtes</strong> : détection et mapping automatique des colonnes</li>
                                </ul>
                            </li>
                            <li>Les données sont analysées et ajoutées au tableau</li>
                            <li>Vérifiez visuellement les données importées</li>
                        </ol>
                        <div class="tip-box" style="background: rgba(76, 175, 80, 0.15); border-left: 4px solid #4CAF50; padding: 15px; margin-top: 20px;">
                            <strong style="color: #4CAF50;">✅ Format CSV Pronote compatible :</strong><br>
                            Le module reconnaît automatiquement les exports Pronote (séparateur point-virgule, UTF-8). Pas besoin de conversion manuelle !
                        </div>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">📊 Importer un Fichier Excel</h3>
                    <div class="step-box" style="background: rgba(0, 150, 136, 0.1); border: 2px solid #009688; padding: 25px; margin-bottom: 25px; border-radius: 10px;">
                        <ol style="font-size: 1rem; line-height: 2; padding-left: 25px;">
                            <li>Cliquez sur <strong style="color: #009688;">📊 Importer Excel</strong></li>
                            <li>Sélectionnez votre fichier <strong>.xlsx</strong> ou <strong>.xls</strong></li>
                            <li>Le module utilise la bibliothèque <strong>SheetJS</strong> pour :
                                <ul style="margin: 10px 0 10px 30px; line-height: 1.8;">
                                    <li>Lire automatiquement la <strong>première feuille</strong></li>
                                    <li>Extraire les <strong>en-têtes</strong> (première ligne)</li>
                                    <li>Convertir toutes les lignes en objets JSON</li>
                                </ul>
                            </li>
                            <li>Les données sont ajoutées au tableau immédiatement</li>
                        </ol>
                        <div class="tip-box" style="background: rgba(255, 193, 7, 0.15); border-left: 4px solid #FFC107; padding: 15px; margin-top: 20px;">
                            <strong style="color: #FFC107;">⚠️ Important :</strong> La première ligne du fichier Excel doit contenir les <strong>noms des colonnes</strong> (Nom, Prénom, Classe, etc.). Les lignes suivantes sont les élèves.
                        </div>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">📋 RPP - Récupérer Presse-Papier (Auto-détection)</h3>
                    <div class="step-box" style="background: rgba(156, 39, 176, 0.1); border: 2px solid #9C27B0; padding: 25px; margin-bottom: 25px; border-radius: 10px;">
                        <h4 style="color: #9C27B0; margin-bottom: 15px;">🎯 Fonctionnalité Ultra-Rapide</h4>
                        <p style="font-size: 1.05rem; line-height: 1.7; margin-bottom: 20px;">
                            Le <strong>RPP (Récupérer Presse-Papier)</strong> permet de coller directement des données depuis Excel, Pronote, ou tout autre logiciel, <strong>sans passer par un fichier</strong>.
                        </p>
                        <ol style="font-size: 1rem; line-height: 2; padding-left: 25px;">
                            <li>Dans votre logiciel source (Excel, Pronote...), sélectionnez les lignes d'élèves avec les en-têtes</li>
                            <li>Copiez (Ctrl+C)</li>
                            <li>Revenez dans LOGECPE, ouvrez le module Import</li>
                            <li>Cliquez sur <strong style="color: #9C27B0;">📋 RPP</strong></li>
                            <li>Collez dans la zone de texte (Ctrl+V)</li>
                            <li>Le module <strong>détecte automatiquement</strong> :
                                <ul style="margin: 10px 0 10px 30px; line-height: 1.8;">
                                    <li>Format <strong>TAB</strong> (tabulation) - le plus courant</li>
                                    <li>Format <strong>point-virgule</strong> (;)</li>
                                    <li>Format <strong>virgule</strong> (,)</li>
                                </ul>
                            </li>
                            <li>Cliquez sur <strong>Importer</strong></li>
                            <li>Les élèves sont ajoutés instantanément !</li>
                        </ol>
                        <div class="tip-box" style="background: rgba(76, 175, 80, 0.15); border-left: 4px solid #4CAF50; padding: 15px; margin-top: 20px;">
                            <strong style="color: #4CAF50;">🚀 Cas d'usage ultra-rapide :</strong><br>
                            1. Ouvrez Excel avec votre liste d'élèves<br>
                            2. Sélectionnez tout (Ctrl+A) et copiez (Ctrl+C)<br>
                            3. LOGECPE → Import Établissement → RPP → Collez → Importer<br>
                            4. ✅ Terminé en 5 secondes !
                        </div>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">🔍 Rechercher et Filtrer</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #2196F3; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            • <strong>Champ de recherche</strong> en haut du tableau<br>
                            • Tapez n'importe quel texte (nom, prénom, classe...)<br>
                            • <strong>Filtrage en temps réel</strong> : seules les lignes correspondantes s'affichent<br>
                            • Recherche <strong>insensible à la casse</strong> (majuscules/minuscules)<br>
                            • Recherche dans <strong>toutes les colonnes</strong> simultanément
                        </p>
                        <div class="tip-box" style="background: rgba(33, 150, 243, 0.15); border-left: 4px solid #2196F3; padding: 15px; margin-top: 20px;">
                            <strong style="color: #2196F3;">💡 Exemple :</strong> Tapez "2nde" pour voir uniquement les élèves de Seconde, ou "Dupont" pour trouver tous les Dupont.
                        </div>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">🎲 Générer des Données d'Exemple</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #FFC107; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            • Cliquez sur <strong style="color: #FFC107;">🎲 Générer exemple</strong><br>
                            • Le module crée automatiquement <strong>1500 élèves fictifs</strong><br>
                            • Répartis dans <strong>50 classes</strong> (Seconde, Première G/Techno, Terminale G/Techno, BTS1, BTS2)<br>
                            • Avec <strong>toutes les spécialités</strong> du lycée général (Maths, Physique-Chimie, SVT, SES, HGGSP, HLP, NSI, SI...)<br>
                            • Et <strong>toutes les séries technologiques</strong> (STMG, STI2D, ST2S, STL) + <strong>BTS</strong> (MCO, NDRC, CG, SIO...)<br>
                            • <strong>Utile pour</strong> : tests de performance, démonstrations, formations, simulations d'établissement complet
                        </p>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">✨ Charger dans LOGECPE - Workflow Principal</h3>
                    <div class="highlight-box" style="background: rgba(76, 175, 80, 0.2); border: 3px solid #4CAF50; padding: 30px; margin: 25px 0; border-radius: 15px;">
                        <h4 style="color: #4CAF50; font-size: 1.3rem; margin-bottom: 20px;">🎯 Fonctionnalité Clé - Intégration Directe</h4>
                        <p style="font-size: 1.1rem; line-height: 1.8; margin-bottom: 25px;">
                            Une fois vos élèves préparés dans le module (ajout manuel, import CSV/Excel/RPP), vous pouvez les <strong>charger directement dans LOGECPE en un seul clic</strong> - sans passer par un fichier intermédiaire !
                        </p>
                        
                        <h4 style="color: #4CAF50; margin: 25px 0 15px 0;">📋 Étapes du Workflow</h4>
                        <ol style="font-size: 1.05rem; line-height: 2.2; padding-left: 25px;">
                            <li><strong>Préparez vos données</strong> dans le module Import (ajout, import, modification...)</li>
                            <li>Vérifiez visuellement la liste dans le tableau</li>
                            <li>Cliquez sur <strong style="color: #4CAF50;">✅ Charger dans LOGECPE</strong></li>
                            <li>Le module :
                                <ul style="margin: 10px 0 10px 30px; line-height: 1.8;">
                                    <li>✅ Formate les données en CSV interne</li>
                                    <li>✅ Analyse et parse automatiquement</li>
                                    <li>✅ Synchronise avec la base de données LOGECPE</li>
                                    <li>✅ Met à jour la liste des classes dans la barre latérale</li>
                                    <li>✅ Ferme automatiquement le module Import</li>
                                </ul>
                            </li>
                            <li><strong style="color: #4CAF50;">✨ Résultat :</strong> Vos élèves sont immédiatement disponibles dans LOGECPE !</li>
                        </ol>

                        <div class="tip-box" style="background: rgba(33, 150, 243, 0.2); border-left: 4px solid #2196F3; padding: 20px; margin-top: 25px;">
                            <strong style="color: #2196F3; font-size: 1.1rem;">💡 Avantage Principal</strong><br>
                            <p style="margin-top: 10px; font-size: 1rem; line-height: 1.7;">
                                <strong>Avant :</strong> Import Établissement → Fichier CSV téléchargé → Réimporter le CSV dans LOGECPE<br>
                                <strong>Maintenant :</strong> Import Établissement → Charger dans LOGECPE ✅<br>
                                <em style="color: #4CAF50;">→ Gain de temps considérable, workflow simplifié !</em>
                            </p>
                        </div>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">🛡️ Sauvegarde et Persistance</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #FF9800; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            • Toutes les données du module sont <strong>sauvegardées automatiquement</strong> dans le navigateur (localStorage)<br>
                            • Clé de stockage : <code style="background: rgba(0,0,0,0.3); padding: 3px 8px; border-radius: 4px;">import-students</code><br>
                            • <strong>Persistance :</strong> Vos élèves restent dans le module même après fermeture du navigateur<br>
                            • <strong>Indépendant</strong> de la base de données principale LOGECPE jusqu'au chargement<br>
                            • Date de dernière sauvegarde affichée dans les statistiques
                        </p>
                        <div class="tip-box" style="background: rgba(255, 193, 7, 0.15); border-left: 4px solid #FFC107; padding: 15px; margin-top: 20px;">
                            <strong style="color: #FFC107;">⚠️ Important :</strong> Les données du module Import et de LOGECPE sont <strong>séparées</strong> jusqu'à ce que vous cliquiez sur "Charger dans LOGECPE". Pensez à charger régulièrement pour synchroniser.
                        </div>
                    </div>

                    <h3 style="color: #2196F3; margin: 30px 0 20px 0; border-bottom: 2px solid #2196F3; padding-bottom: 10px;">❌ Fermer le Module</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #f44336; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            • Cliquez sur le bouton <strong>✖ Fermer</strong> en haut à droite<br>
                            • Ou le module se ferme automatiquement après un chargement réussi<br>
                            • <strong>Vos données sont conservées</strong> - elles restent dans le module pour une prochaine utilisation
                        </p>
                    </div>

                    <div style="margin-top: 40px; padding: 25px; background: rgba(76, 175, 80, 0.2); border-radius: 10px; border: 2px solid #4CAF50;">
                        <h4 style="color: #4CAF50; margin-bottom: 15px; font-size: 1.2rem;">✅ Récapitulatif - Module Import Établissement</h4>
                        <ul class="feature-list" style="column-count: 2; column-gap: 30px; font-size: 0.95rem; line-height: 1.9;">
                            <li>Interface intégrée complète (overlay plein écran)</li>
                            <li>Ajout/modification manuelle d'élèves</li>
                            <li>Import CSV avec auto-détection encodage/séparateur</li>
                            <li>Import Excel (.xlsx, .xls) via SheetJS</li>
                            <li>RPP avec auto-détection format (TAB/;/,)</li>
                            <li>Recherche et filtrage en temps réel</li>
                            <li>Génération de données d'exemple (1500 élèves)</li>
                            <li>Statistiques en direct (élèves, classes, date)</li>
                            <li><strong>Chargement direct dans LOGECPE</strong> (workflow simplifié)</li>
                            <li>Sauvegarde automatique (localStorage)</li>
                            <li>Modification/suppression individuelle</li>
                            <li>Compatibilité Pronote, EDT, Excel</li>
                        </ul>
                    </div>

                    <div style="margin-top: 25px; padding: 20px; background: rgba(33, 150, 243, 0.15); border-left: 4px solid #2196F3; border-radius: 5px;">
                        <h4 style="color: #2196F3; margin-bottom: 12px;">🎓 Cas d'Usage Typique</h4>
                        <p style="font-size: 1rem; line-height: 1.8;">
                            <strong>Rentrée scolaire :</strong><br>
                            1️⃣ Exportez la liste depuis Pronote (CSV)<br>
                            2️⃣ LOGECPE → Import Établissement → Importer CSV<br>
                            3️⃣ Vérifiez/modifiez si nécessaire<br>
                            4️⃣ Charger dans LOGECPE<br>
                            5️⃣ ✅ Tous vos élèves sont prêts - commencez à travailler !
                        </p>
                        <p style="margin-top: 15px; font-size: 1rem; line-height: 1.8;">
                            <strong>Élève arrivant en cours d'année :</strong><br>
                            1️⃣ Import Établissement → Ajouter un élève<br>
                            2️⃣ Remplissez le formulaire<br>
                            3️⃣ Charger dans LOGECPE<br>
                            4️⃣ ✅ L'élève est intégré immédiatement
                        </p>
                    </div>

                </div>

                <!-- SECTION 5: IMPRESSION -->
                <div class="section" id="print" style="background: rgba(233, 30, 99, 0.1); border: 2px solid #E91E63; padding: 30px; margin-top: 50px;">
                    <h2 style="color: #E91E63;">🖨️ Impression et Export</h2>
                    
                    <div style="background: rgba(233, 30, 99, 0.15); border-left: 4px solid #E91E63; padding: 20px; margin: 25px 0;">
                        <h3 style="color: #E91E63; margin-bottom: 15px;">🎯 Fonctionnalités d'Impression</h3>
                        <p style="font-size: 1.05rem; line-height: 1.8;">
                            LOGECPE offre plusieurs options d'impression et d'export pour vos documents et rapports. Chaque fonction est conçue pour produire des documents professionnels et personnalisables.
                        </p>
                    </div>

                    <h3 style="color: #E91E63; margin: 30px 0 20px 0; border-bottom: 2px solid #E91E63; padding-bottom: 10px;">📄 Impression Fiche Élève</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #4CAF50; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            <strong>Étapes :</strong><br>
                            1. Ouvrez la fiche d'un élève<br>
                            2. Cliquez sur le bouton <strong style="color: #E91E63;">🖨️ Imprimer</strong><br>
                            3. Une fenêtre d'aperçu avant impression s'ouvre<br>
                            4. Configurez les options (format, orientation, marges)<br>
                            5. Lancez l'impression ou enregistrez en PDF
                        </p>
                        <div class="tip-box" style="background: rgba(33, 150, 243, 0.15); border-left: 4px solid #2196F3; padding: 15px; margin-top: 20px;">
                            <strong style="color: #2196F3;">💡 Astuce :</strong> Pour sauvegarder en PDF, choisissez "Enregistrer au format PDF" dans les options d'impression de votre navigateur.
                        </div>
                    </div>

                    <h3 style="color: #E91E63; margin: 30px 0 20px 0; border-bottom: 2px solid #E91E63; padding-bottom: 10px;">📊 Export Statistiques</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #FF9800; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            <strong>Options d'export :</strong><br>
                            • <strong>Export CSV</strong> : Pour Excel, LibreOffice, Google Sheets<br>
                            • <strong>Export PDF</strong> : Document formaté prêt à imprimer<br>
                            • <strong>Export graphiques</strong> : Sauvegarde des statistiques visuelles<br>
                            • <strong>Export synthèse annuelle</strong> : Rapport complet de l'année
                        </p>
                    </div>

                    <h3 style="color: #E91E63; margin: 30px 0 20px 0; border-bottom: 2px solid #E91E63; padding-bottom: 10px;">📋 Impression Liste de Classes</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #9C27B0; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            Dans la barre latérale des classes, utilisez les options d'impression pour générer :<br>
                            • Liste complète des élèves d'une classe<br>
                            • Trombinoscope (si photos disponibles)<br>
                            • Liste avec coordonnées des responsables<br>
                            • Liste simplifiée (nom, prénom, classe uniquement)
                        </p>
                    </div>

                    <h3 style="color: #E91E63; margin: 30px 0 20px 0; border-bottom: 2px solid #E91E63; padding-bottom: 10px;">🎨 Personnalisation des Impressions</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #00BCD4; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            <strong>Options disponibles :</strong><br>
                            • Choix du logo de l'établissement<br>
                            • En-tête personnalisable (nom CPE, établissement)<br>
                            • Sélection des sections à imprimer<br>
                            • Format papier (A4, Letter)<br>
                            • Orientation (Portrait/Paysage)<br>
                            • Marges personnalisées
                        </p>
                        <div class="tip-box" style="background: rgba(76, 175, 80, 0.15); border-left: 4px solid #4CAF50; padding: 15px; margin-top: 20px;">
                            <strong style="color: #4CAF50;">✅ Recommandation :</strong> Testez d'abord l'aperçu avant impression pour vérifier que la mise en page correspond à vos attentes.
                        </div>
                    </div>

                    <div style="margin-top: 40px; padding: 25px; background: rgba(233, 30, 99, 0.2); border-radius: 10px; border: 2px solid #E91E63;">
                        <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 1.2rem;">✅ Récapitulatif - Impression</h4>
                        <ul class="feature-list" style="column-count: 2; column-gap: 30px; font-size: 0.95rem; line-height: 1.9;">
                            <li>Impression fiche élève complète</li>
                            <li>Export statistiques (CSV, PDF, graphiques)</li>
                            <li>Impression liste de classes</li>
                            <li>Trombinoscope</li>
                            <li>Export synthèse annuelle</li>
                            <li>Personnalisation en-têtes et logo</li>
                            <li>Aperçu avant impression</li>
                            <li>Sauvegarde PDF intégrée</li>
                            <li>Format A4/Letter</li>
                            <li>Orientation personnalisable</li>
                        </ul>
                    </div>
                </div>

                <!-- SECTION 6: SAUVEGARDE -->
                <div class="section" id="save" style="background: rgba(156, 39, 176, 0.1); border: 2px solid #9C27B0; padding: 30px; margin-top: 50px;">
                    <h2 style="color: #9C27B0;">💾 Sauvegarde et Sécurité des Données</h2>
                    
                    <div style="background: rgba(156, 39, 176, 0.15); border-left: 4px solid #9C27B0; padding: 20px; margin: 25px 0;">
                        <h3 style="color: #9C27B0; margin-bottom: 15px;">🎯 Système de Sauvegarde</h3>
                        <p style="font-size: 1.05rem; line-height: 1.8;">
                            LOGECPE utilise un <strong>système de sauvegarde multi-niveaux</strong> pour garantir la sécurité et la pérennité de vos données. Toutes les informations sont stockées localement dans votre navigateur et peuvent être exportées à tout moment.
                        </p>
                    </div>

                    <h3 style="color: #9C27B0; margin: 30px 0 20px 0; border-bottom: 2px solid #9C27B0; padding-bottom: 10px;">💾 Sauvegarde Automatique (localStorage)</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #4CAF50; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            <strong>Fonctionnement :</strong><br>
                            • <strong>Sauvegarde automatique</strong> : Chaque action est enregistrée instantanément<br>
                            • <strong>localStorage du navigateur</strong> : Données persistantes même après fermeture<br>
                            • <strong>Pas de serveur externe</strong> : Confidentialité totale garantie<br>
                            • <strong>Données locales</strong> : Restent sur votre ordinateur uniquement
                        </p>
                        <div class="tip-box" style="background: rgba(76, 175, 80, 0.15); border-left: 4px solid #4CAF50; padding: 15px; margin-top: 20px;">
                            <strong style="color: #4CAF50;">✅ Avantage :</strong> Aucune connexion Internet requise après le premier chargement. Vos données restent privées et inaccessibles depuis l'extérieur.
                        </div>
                    </div>

                    <h3 style="color: #9C27B0; margin: 30px 0 20px 0; border-bottom: 2px solid #9C27B0; padding-bottom: 10px;">🔐 Sauvegarde Clé USB (Export/Import)</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #FF9800; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            <strong>Bouton "💾 Sauvegarde Clé USB" :</strong><br>
                            1. Cliquez sur <strong style="color: #9C27B0;">💾 Sauvegarde Clé USB</strong> dans la barre d'outils<br>
                            2. Un fichier HTML autonome est téléchargé<br>
                            3. Ce fichier contient <strong>TOUTES vos données</strong> (élèves, observations, RDV, stats...)<br>
                            4. Conservez-le sur une clé USB, disque dur externe, ou cloud personnel<br>
                            5. Pour restaurer : ouvrez le fichier HTML dans votre navigateur
                        </p>
                        <div class="tip-box" style="background: rgba(255, 193, 7, 0.15); border-left: 4px solid #FFC107; padding: 15px; margin-top: 20px;">
                            <strong style="color: #FFC107;">⚠️ Important :</strong> Effectuez régulièrement des sauvegardes sur clé USB (chaque semaine ou après modifications importantes). En cas de crash système ou changement d'ordinateur, vous pourrez restaurer toutes vos données.
                        </div>
                    </div>

                    <h3 style="color: #9C27B0; margin: 30px 0 20px 0; border-bottom: 2px solid #9C27B0; padding-bottom: 10px;">📤 Export Base de Données (JSON)</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #2196F3; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            <strong>Pour les utilisateurs avancés :</strong><br>
                            • Accédez aux <strong>Paramètres</strong> → <strong>Export/Import</strong><br>
                            • Cliquez sur <strong>"Exporter base de données (JSON)"</strong><br>
                            • Fichier JSON brut téléchargé avec toutes les données<br>
                            • Utilisable pour migration, analyse, ou scripts personnalisés<br>
                            • Import possible depuis le même menu
                        </p>
                    </div>

                    <h3 style="color: #9C27B0; margin: 30px 0 20px 0; border-bottom: 2px solid #9C27B0; padding-bottom: 10px;">🛡️ Sécurité et Confidentialité</h3>
                    <div class="highlight-box" style="background: rgba(76, 175, 80, 0.2); border: 3px solid #4CAF50; padding: 30px; margin: 25px 0; border-radius: 15px;">
                        <h4 style="color: #4CAF50; font-size: 1.3rem; margin-bottom: 20px;">🔒 Garanties de Sécurité</h4>
                        <ul style="font-size: 1.05rem; line-height: 2; padding-left: 25px;">
                            <li><strong>100% Local</strong> : Aucune donnée envoyée sur Internet</li>
                            <li><strong>Pas de serveur</strong> : Pas de risque de piratage distant</li>
                            <li><strong>RGPD Compliant</strong> : Vous êtes responsable de vos données</li>
                            <li><strong>Chiffrement navigateur</strong> : localStorage sécurisé par le navigateur</li>
                            <li><strong>Pas de tracking</strong> : Aucun cookie, aucune analyse externe</li>
                            <li><strong>Open Source</strong> : Code transparent et vérifiable</li>
                        </ul>
                        <div class="tip-box" style="background: rgba(33, 150, 243, 0.15); border-left: 4px solid #2196F3; padding: 15px; margin-top: 20px;">
                            <strong style="color: #2196F3;">💡 Recommandation :</strong> Vos données sensibles (informations élèves, observations disciplinaires) ne quittent jamais votre ordinateur. C'est la garantie ultime de confidentialité.
                        </div>
                    </div>

                    <h3 style="color: #9C27B0; margin: 30px 0 20px 0; border-bottom: 2px solid #9C27B0; padding-bottom: 10px;">🔄 Restauration des Données</h3>
                    <div class="feature-box" style="background: rgba(255, 255, 255, 0.05); border-left: 4px solid #00BCD4; padding: 20px; margin-bottom: 25px;">
                        <p style="font-size: 1rem; line-height: 1.7;">
                            <strong>En cas de problème :</strong><br>
                            1. <strong>Changement d'ordinateur</strong> : Ouvrez votre fichier de sauvegarde HTML<br>
                            2. <strong>Crash système</strong> : Récupérez votre dernière sauvegarde clé USB<br>
                            3. <strong>Changement de navigateur</strong> : Exportez JSON depuis l'ancien, importez dans le nouveau<br>
                            4. <strong>localStorage effacé</strong> : Réimportez votre dernière sauvegarde
                        </p>
                        <div class="tip-box" style="background: rgba(255, 193, 7, 0.15); border-left: 4px solid #FFC107; padding: 15px; margin-top: 20px;">
                            <strong style="color: #FFC107;">⚠️ Bonnes pratiques :</strong><br>
                            • Sauvegarde hebdomadaire sur clé USB<br>
                            • Conservez plusieurs versions (dernière semaine, dernier mois)<br>
                            • Testez régulièrement l'ouverture de vos sauvegardes<br>
                            • Stockez une copie dans un emplacement différent (cloud personnel)
                        </div>
                    </div>

                    <div style="margin-top: 40px; padding: 25px; background: rgba(156, 39, 176, 0.2); border-radius: 10px; border: 2px solid #9C27B0;">
                        <h4 style="color: #9C27B0; margin-bottom: 15px; font-size: 1.2rem;">✅ Récapitulatif - Sauvegarde</h4>
                        <ul class="feature-list" style="column-count: 2; column-gap: 30px; font-size: 0.95rem; line-height: 1.9;">
                            <li>Sauvegarde automatique (localStorage)</li>
                            <li>Sauvegarde clé USB (HTML autonome)</li>
                            <li>Export base de données (JSON)</li>
                            <li>Import/restauration facile</li>
                            <li>100% local, aucun serveur</li>
                            <li>RGPD compliant</li>
                            <li>Confidentialité totale</li>
                            <li>Pas de connexion Internet requise</li>
                            <li>Multi-versions possibles</li>
                            <li>Restauration rapide</li>
                        </ul>
                    </div>

                    <div style="margin-top: 25px; padding: 20px; background: rgba(76, 175, 80, 0.15); border-left: 4px solid #4CAF50; border-radius: 5px;">
                        <h4 style="color: #4CAF50; margin-bottom: 12px;">📝 Calendrier de Sauvegarde Recommandé</h4>
                        <p style="font-size: 1rem; line-height: 1.8;">
                            • <strong>Quotidien</strong> : Sauvegarde automatique (localStorage) → rien à faire !<br>
                            • <strong>Hebdomadaire</strong> : Sauvegarde clé USB (vendredi soir conseillé)<br>
                            • <strong>Mensuel</strong> : Archivage version longue durée (cloud personnel)<br>
                            • <strong>Fin de période</strong> : Export JSON avant vacances scolaires
                        </p>
                    </div>
                </div>

                <!-- Bouton Retour au Sommaire Fixe -->
                <a href="#intro" style="position: fixed; bottom: 30px; right: 30px; background: rgba(33, 150, 243, 0.9); color: white; padding: 12px 20px; border-radius: 50px; text-decoration: none; font-size: 0.9rem; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease; z-index: 9999; backdrop-filter: blur(10px);" 
                   onmouseover="this.style.background='rgba(33, 150, 243, 1)'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.4)';" 
                   onmouseout="this.style.background='rgba(33, 150, 243, 0.9)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)';">
                    ⬆️ Sommaire
                </a>

                <footer
                    style="text-align: center; margin-top: 60px; padding-top: 30px; border-top: 2px solid #444; color: #888;">
                    <p><strong>LOGECPE NTP34</strong> - Guide Détaillé Fiche Élève & Synthèse</p>
                    <p style="margin-top: 10px;">Version 2026.1 - Mis à jour le 30/01/2026</p>
                    <p style="margin-top: 5px; font-size: 0.9rem; color: #4CAF50;">
                        ✨ Nouvelles fonctionnalités : Calendrier hebdomadaire, Rétroactivité, Double horodatage, Mise en forme, Module Import Intégré
                    </p>
                </footer>
            </div>
        </body>

        </html>
    </template>
    <template id="guide-content-Guide_Visuel_LOGECPE">
        <!DOCTYPE html>
        <html lang="fr">

        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Guide Visuel - LOGECPE NTP14</title>
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }

                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
                    color: #fff;
                    padding: 40px 20px;
                }

                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                }

                header {
                    text-align: center;
                    margin-bottom: 60px;
                    padding-bottom: 30px;
                    border-bottom: 3px solid #FFA500;
                }

                h1 {
                    font-size: 3rem;
                    color: #FFA500;
                    margin-bottom: 10px;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                }

                .subtitle {
                    font-size: 1.2rem;
                    color: #ccc;
                    margin-top: 10px;
                }

                .step {
                    background: rgba(255, 255, 255, 0.05);
                    border: 2px solid #444;
                    border-radius: 15px;
                    padding: 30px;
                    margin-bottom: 40px;
                    transition: all 0.3s ease;
                }

                .step:hover {
                    border-color: #FFA500;
                    box-shadow: 0 0 20px rgba(255, 165, 0, 0.3);
                    transform: translateY(-5px);
                }

                .step-header {
                    display: flex;
                    align-items: center;
                    margin-bottom: 20px;
                }

                .step-number {
                    background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
                    color: #000;
                    font-size: 1.5rem;
                    font-weight: bold;
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 20px;
                    box-shadow: 0 4px 10px rgba(255, 165, 0, 0.4);
                }

                .step-title {
                    font-size: 1.8rem;
                    color: #FFA500;
                    flex: 1;
                }

                .step-description {
                    font-size: 1.1rem;
                    line-height: 1.6;
                    color: #ddd;
                    margin-bottom: 20px;
                    padding-left: 70px;
                }

                .step-image {
                    width: 100%;
                    max-width: 800px;
                    height: auto;
                    border-radius: 10px;
                    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
                    margin: 20px auto;
                    display: block;
                    border: 2px solid #444;
                }

                .features {
                    background: rgba(255, 165, 0, 0.1);
                    border-left: 4px solid #FFA500;
                    padding: 15px 20px;
                    margin: 20px 0;
                    border-radius: 5px;
                }

                .features ul {
                    list-style: none;
                    padding-left: 20px;
                }

                .features li {
                    padding: 8px 0;
                    position: relative;
                }

                .features li:before {
                    content: "▸";
                    color: #FFA500;
                    font-weight: bold;
                    position: absolute;
                    left: -20px;
                }

                footer {
                    text-align: center;
                    margin-top: 60px;
                    padding-top: 30px;
                    border-top: 2px solid #444;
                    color: #888;
                }

                .highlight {
                    color: #FFA500;
                    font-weight: bold;
                }

                .note {
                    background: rgba(33, 150, 243, 0.1);
                    border-left: 4px solid #2196F3;
                    padding: 15px;
                    margin: 20px 0;
                    border-radius: 5px;
                    font-style: italic;
                }
            </style>
        </head>

        <body>
            <div class="container">
                <header>
                    <h1>📚 Guide Visuel - LOGECPE_NTP</h1>
                    <p class="subtitle">Système de Gestion de Vie Scolaire pour CPE</p>
                    <p class="subtitle" style="margin-top: 20px; font-size: 1rem;">Version 2026 - Parcours utilisateur
                        complet
                    </p>
                </header>

                <!-- Étape 1 -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h2 class="step-title">Connexion</h2>
                    </div>
                    <p class="step-description">
                        Pour démarrer, connectez-vous au site <span class="highlight">logecpe.nervcloud.fr</span>.
                    </p>
                    <p class="step-description">
                        Entrez votre <strong>identifiant</strong> et votre <strong>mot de passe</strong> pour accéder à
                        votre
                        interface sécurisée.
                    </p>
                </div>

                <!-- Étape 2 (Anciennement 3, remplace 2) -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h2 class="step-title">Importation annuelle de la base élève</h2>
                    </div>
                    <p class="step-description">
                        La première étape de configuration consiste à importer l'ensemble de vos élèves.
                        Cliquez sur le bouton vert <span class="highlight">"Import Etablissement"</span> situé dans la
                        barre
                        supérieure.
                    </p>
                    <div class="features">
                        <ul>
                            <li>Sélectionnez votre fichier d'export (CSV ou XML) issu de Pronote ou Siecle.</li>
                            <li>L'importation initialise toutes les fiches élèves pour l'année en cours.</li>
                        </ul>
                    </div>
                </div>

                <!-- Étape 3 (Remplace 4 et 5) -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <h2 class="step-title">Création automatique du Calendrier</h2>
                    </div>
                    <p class="step-description">
                        Pour initialiser les semaines de l'année :
                    </p>
                    <div class="features">
                        <ul>
                            <li>Ouvrez le menu <span class="highlight">"🛠️ Utilitaires"</span>.</li>
                            <li>Sélectionnez <span class="highlight">"Nouveau Calendrier"</span>.</li>
                            <li>Utilisez le <strong>mode automatique</strong> pour générer instantanément la structure
                                de
                                l'année (périodes, vacances, jours fériés).</li>
                            <li>Validez pour appliquer ce calendrier à votre logiciel.</li>
                        </ul>
                    </div>
                </div>

                <!-- Étape 4 (Anciennement 6) -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <h2 class="step-title">Transition vers l'Agenda</h2>
                    </div>
                    <p class="step-description">
                        Pour accéder au calendrier des observations et rendez-vous, cliquez sur l'onglet <span
                            class="highlight">"AGENDA"</span> dans la barre de navigation supérieure.
                    </p>
                    <div class="note">
                        💡 <strong>Navigation :</strong> Les trois onglets principaux sont logiciel, Agenda et
                        Statistiques.
                    </div>
                </div>

                <!-- Étape 5 (Anciennement 7) -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">5</div>
                        <h2 class="step-title">Vue Agenda des Saisies</h2>
                    </div>
                    <p class="step-description">
                        L'agenda affiche un calendrier mensuel avec toutes les entrées :
                    </p>
                    <div class="features">
                        <ul>
                            <li><span style="color: #4CAF50;">●</span> <strong>Vert</strong> : Observations régulières
                            </li>
                            <li><span style="color: #FF9800;">●</span> <strong>Orange</strong> : Rendez-vous planifiés
                            </li>
                            <li><span style="color: #F44336;">●</span> <strong>Rouge</strong> : Urgences ou situations à
                                surveiller</li>
                        </ul>
                    </div>
                    <p class="step-description">
                        Utilisez les boutons <span class="highlight">"< Précédent"</span> et <span
                                    class="highlight">"Suivant
                                    >"</span> pour naviguer entre les mois.
                    </p>
                    <div class="note">
                        ✨ <strong>Nouveau :</strong> Le bouton <span class="highlight">"🖨️ Imprimer"</span> permet
                        d'imprimer
                        le mois en cours !
                    </div>
                </div>

                <!-- Étape 6 (Anciennement 8) -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">6</div>
                        <h2 class="step-title">Sélection d'une entrée</h2>
                    </div>
                    <p class="step-description">
                        Cliquez sur n'importe quelle entrée dans le calendrier pour ouvrir la fiche détaillée de l'élève
                        concerné.
                        Un effet visuel (surbrillance orange) indique l'entrée sélectionnée.
                    </p>
                </div>

                <!-- Étape 7 (Anciennement 9) -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">7</div>
                        <h2 class="step-title">Fiche Élève - Information Hebdomadaire</h2>
                    </div>
                    <p class="step-description">
                        La fiche élève s'ouvre avec plusieurs onglets. L'onglet <span class="highlight">"Information
                            Hebdomadaire"</span> permet de :
                    </p>
                    <div class="features">
                        <ul>
                            <li>Sélectionner une semaine spécifique (36 à 51)</li>
                            <li>Saisir des notes et observations dans la zone de texte</li>
                            <li>Attribuer un statut coloré (À surveiller, Mitigé, En progrès, Bon)</li>
                            <li>Voir la date de création : <span class="highlight">"créer le : JJ/MM/AAAA
                                    HH:MM:SS"</span></li>
                        </ul>
                    </div>
                    <p class="step-description">
                        Cliquez sur <span class="highlight">"Sauvegarder"</span> pour enregistrer vos modifications.
                    </p>
                </div>

                <!-- Étape 8 (Anciennement 10) -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">8</div>
                        <h2 class="step-title">Navigation entre semaines</h2>
                    </div>
                    <p class="step-description">
                        Le sélecteur de semaines en haut de la fiche permet de naviguer rapidement :
                    </p>
                    <div class="features">
                        <ul>
                            <li>Les semaines avec données sont marquées d'une <span class="highlight">✓</span> verte
                            </li>
                            <li>La semaine sélectionnée est surlignée en orange</li>
                            <li>Cliquez sur une semaine pour charger ses données</li>
                            <li>Les modifications sont sauvegardées automatiquement lors du changement de semaine</li>
                        </ul>
                    </div>
                </div>

                <!-- Étape 9 (Anciennement 11) -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">9</div>
                        <h2 class="step-title">Vue Statistiques et Analyses</h2>
                    </div>
                    <p class="step-description">
                        L'onglet <span class="highlight">"STATISTIQUES"</span> offre une vue d'ensemble analytique :
                    </p>
                    <div class="features">
                        <ul>
                            <li><strong>Cartes métriques</strong> : Total RDV, Validés, En Attente, Annulés</li>
                            <li><strong>Tendances hebdomadaires</strong> : Graphique en barres des RDV par semaine</li>
                            <li><strong>Répartition par statut</strong> : Graphique circulaire (donut chart)</li>
                            <li><strong>Motifs principaux</strong> : Liste des raisons les plus fréquentes</li>
                        </ul>
                    </div>
                    <div class="note">
                        📊 <strong>Filtres :</strong> Utilisez le sélecteur de période (Jour, Semaine, Mois, Année) pour
                        affiner
                        les statistiques.
                    </div>
                </div>

                <!-- Étape 10 (Anciennement 12) -->
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">10</div>
                        <h2 class="step-title">Aperçu avant impression</h2>
                    </div>
                    <p class="step-description">
                        Lorsque vous cliquez sur <span class="highlight">"🖨️ Imprimer"</span> dans l'agenda, une
                        fenêtre
                        d'aperçu s'ouvre :
                    </p>
                    <div class="features">
                        <ul>
                            <li>Prévisualisation du calendrier formaté pour l'impression</li>
                            <li>Mise en page optimisée (noir et blanc)</li>
                            <li>En-tête avec le titre et le mois</li>
                            <li>Pied de page avec la date d'impression</li>
                            <li>Options d'impression standard du navigateur</li>
                        </ul>
                    </div>
                    <p class="step-description">
                        Cliquez sur <span class="highlight">"Imprimer"</span> pour lancer l'impression ou "Annuler" pour
                        revenir
                        à l'agenda.
                    </p>
                </div>

                <footer>
                    <p><strong>LOGECPE_NTP</strong> - Système de Gestion de Vie Scolaire</p>
                    <p style="margin-top: 10px;">© 2026 - Guide mis à jour le 25/01/2026</p>
                    <p style="margin-top: 20px; font-size: 0.9rem;">
                        Pour toute question ou assistance, consultez la documentation complète du logiciel.
                    </p>
                </footer>
            </div>
        </body>

        </html>
    </template>
    <template id="guide-content-Reference_Boutons_LOGECPE">
        <!DOCTYPE html>
        <html lang="fr">

        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Référence Boutons - LOGECPE NTP14</title>
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }

                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
                    color: #fff;
                    padding: 40px 20px;
                    line-height: 1.6;
                }

                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                }

                header {
                    text-align: center;
                    margin-bottom: 50px;
                    padding: 30px;
                    background: rgba(255, 165, 0, 0.1);
                    border-radius: 15px;
                    border: 2px solid #FFA500;
                }

                h1 {
                    font-size: 3rem;
                    color: #FFA500;
                    margin-bottom: 10px;
                }

                .subtitle {
                    font-size: 1.2rem;
                    color: #ccc;
                }

                .section {
                    background: rgba(255, 255, 255, 0.05);
                    border: 2px solid #444;
                    border-radius: 15px;
                    padding: 30px;
                    margin-bottom: 40px;
                }

                h2 {
                    color: #FFA500;
                    font-size: 2rem;
                    margin-bottom: 25px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #FFA500;
                }

                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }

                th,
                td {
                    padding: 15px;
                    text-align: left;
                    border-bottom: 1px solid #444;
                }

                th {
                    background: rgba(255, 165, 0, 0.2);
                    color: #FFA500;
                    font-weight: bold;
                    font-size: 1.1rem;
                }

                tr:hover {
                    background: rgba(255, 255, 255, 0.05);
                }

                .btn-demo {
                    display: inline-block;
                    padding: 8px 16px;
                    border-radius: 5px;
                    font-weight: bold;
                    margin: 5px;
                    border: none;
                    cursor: pointer;
                    font-size: 0.95rem;
                }

                .icon {
                    font-size: 1.5rem;
                    margin-right: 8px;
                }

                .color-green {
                    background: #00cc00;
                    color: black;
                }

                .color-orange {
                    background: #FF9800;
                    color: black;
                }

                .color-pink {
                    background: #E91E63;
                    color: white;
                }

                .color-purple {
                    background: #9C27B0;
                    color: white;
                }

                .color-purple-dark {
                    background: #8E24AA;
                    color: white;
                }

                .color-blue {
                    background: #2196F3;
                    color: white;
                }

                .color-green-light {
                    background: #4CAF50;
                    color: white;
                }

                .color-grey {
                    background: #607D8B;
                    color: white;
                }


                .color-brown {
                    background: #795548;
                    color: white;
                }

                .color-black {
                    background: #000;
                    color: white;
                }

                .color-yellow {
                    background: #ff9900;
                    color: black;
                }

                .location {
                    font-style: italic;
                    color: #888;
                    font-size: 0.9rem;
                }
            </style>
        </head>

        <body>
            <div class="container">
                <header>
                    <h1>🎯 RÉFÉRENCE DES BOUTONS</h1>
                    <p class="subtitle">Guide visuel complet - LOGECPE NTP</p>
                </header>

                <!-- BOUTONS PRINCIPAUX -->
                <div class="section">
                    <h2>📌 Boutons Principaux (Barre Supérieure)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%;">Bouton</th>
                                <th style="width: 50%;">Fonction</th>
                                <th style="width: 20%;">Emplacement</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="btn-demo color-green"><span class="icon"></span>Import
                                        Etablissement</span>
                                </td>
                                <td>Ouvrir le module intégré de gestion et d'import des élèves. Permet d'ajouter, modifier, importer (CSV/Excel/RPP) et charger directement les données dans LOGECPE</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-orange"><span class="icon">📅</span>Agenda des
                                        saisies</span>
                                </td>
                                <td>Ouvrir l'agenda mensuel avec toutes les observations et RDV</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-pink"><span class="icon">📅</span>Agenda RDV</span></td>
                                <td>Ouvrir le calendrier des rendez-vous uniquement</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-purple-dark"><span class="icon">💾</span>Sauvegarder le
                                        LOGICIEL
                                        (HTML)</span></td>
                                <td>Créer une copie autonome du logiciel avec toutes vos données</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-purple"><span class="icon">💾</span>Sauvegarde Clé
                                        USB/Cloud
                                        (JSON)</span></td>
                                <td>Exporter vos données en fichier JSON pour backup</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #555; color: white;">Charger</span></td>
                                <td>Restaurer une sauvegarde JSON précédente</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-yellow"><span class="icon">🖨</span>Imprimer...</span>
                                </td>
                                <td>Options d'impression (Calendrier, Convocations)</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-green-light"><span class="icon">📊</span>Synthèse
                                        Annuelle</span></td>
                                <td>Afficher le récapitulatif annuel des données</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-blue"><span class="icon">📈</span>Statistique</span>
                                </td>
                                <td>Ouvrir le tableau de bord des statistiques et analyses</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-grey"><span class="icon">⚙️</span>Paramètres</span></td>
                                <td>Configuration du logiciel (année scolaire, sauvegarde auto, etc.)</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-brown"><span class="icon">🛠️</span>Utilitaires</span>
                                </td>
                                <td>Outils supplémentaires (Créateur de calendrier, etc.)</td>
                                <td class="location">Barre principale</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo"
                                        style="background: #d32f2f; color: white;">Réinitialiser</span></td>
                                <td>Réinitialiser le logiciel et supprimer toutes les données du navigateur</td>
                                <td class="location">Barre principale</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- BOUTONS AGENDA -->
                <div class="section">
                    <h2>📅 Boutons de l'Agenda des Saisies</h2>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%;">Bouton</th>
                                <th style="width: 50%;">Fonction</th>
                                <th style="width: 20%;">Emplacement</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="btn-demo" style="background: #555; color: white;">&lt; Précédent</span>
                                </td>
                                <td>Afficher le mois précédent</td>
                                <td class="location">En-tête agenda</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #555; color: white;">Suivant &gt;</span>
                                </td>
                                <td>Afficher le mois suivant</td>
                                <td class="location">En-tête agenda</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #607D8B; color: white;"><span
                                            class="icon">🖨️</span>Imprimer</span></td>
                                <td><strong>NOUVEAU</strong> - Imprimer le mois en cours de l'agenda</td>
                                <td class="location">En-tête agenda</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- BOUTONS RDV -->
                <div class="section">
                    <h2>📋 Boutons de Gestion des RDV</h2>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%;">Bouton</th>
                                <th style="width: 50%;">Fonction</th>
                                <th style="width: 20%;">Emplacement</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="btn-demo color-pink">Nouveau Rendez-vous</span></td>
                                <td>Créer un RDV standard avec un ou plusieurs élèves</td>
                                <td class="location">Modal type RDV</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #FFD700; color: black;">Nouveau RDV
                                        Famille</span>
                                </td>
                                <td>Créer un RDV avec les parents/tuteurs</td>
                                <td class="location">Modal type RDV</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #9C27B0; color: white;">RDV Réunion</span>
                                </td>
                                <td>Créer une réunion collective (conseil, équipe)</td>
                                <td class="location">Modal type RDV</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #607D8B; color: white;">Imprimer
                                        Convocation</span></td>
                                <td>Imprimer la convocation pour le RDV en cours</td>
                                <td class="location">Formulaire RDV</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-pink">Enregistrer</span></td>
                                <td>Sauvegarder le RDV (nouveau ou modifié)</td>
                                <td class="location">Formulaire RDV</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #d32f2f; color: white;">Supprimer</span>
                                </td>
                                <td>Supprimer définitivement le RDV</td>
                                <td class="location">Formulaire RDV</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- BOUTONS FICHE ÉLÈVE -->
                <div class="section">
                    <h2>👤 Boutons de la Fiche Élève</h2>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%;">Bouton</th>
                                <th style="width: 50%;">Fonction</th>
                                <th style="width: 20%;">Emplacement</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="btn-demo" style="background: #FFA500; color: black;">Sauvegarder</span>
                                </td>
                                <td>Enregistrer les modifications de la fiche élève</td>
                                <td class="location">Bas de la fiche</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #555; color: white;">Imprimer</span></td>
                                <td>Imprimer la fiche élève complète ou une semaine</td>
                                <td class="location">Bas de la fiche</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #2196F3; color: white;">Copier nom</span>
                                </td>
                                <td>Copier le nom complet de l'élève dans le presse-papier</td>
                                <td class="location">En-tête fiche</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo color-pink">Ajouter RDV</span></td>
                                <td>Créer rapidement un RDV pour cet élève</td>
                                <td class="location">En-tête fiche</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #F44336; color: white;">À
                                        surveiller</span></td>
                                <td>Marquer la semaine comme problématique (statut rouge)</td>
                                <td class="location">Zone statut</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #FF9800; color: white;">Mitigé</span></td>
                                <td>Marquer la semaine comme variable (statut orange)</td>
                                <td class="location">Zone statut</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #FFEB3B; color: black;">En progrès</span>
                                </td>
                                <td>Marquer la semaine comme en amélioration (statut jaune)</td>
                                <td class="location">Zone statut</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #4CAF50; color: white;">Bon</span></td>
                                <td>Marquer la semaine comme exemplaire (statut vert)</td>
                                <td class="location">Zone statut</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- BOUTONS STATISTIQUES -->
                <div class="section">
                    <h2>📊 Boutons des Statistiques</h2>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%;">Bouton</th>
                                <th style="width: 50%;">Fonction</th>
                                <th style="width: 20%;">Emplacement</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="btn-demo" style="background: #555; color: white;">Jour</span></td>
                                <td>Filtrer les statistiques sur la journée en cours</td>
                                <td class="location">Sélecteur période</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #555; color: white;">Semaine</span></td>
                                <td>Filtrer les statistiques sur la semaine en cours</td>
                                <td class="location">Sélecteur période</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #555; color: white;">Mois</span></td>
                                <td>Filtrer les statistiques sur le mois en cours</td>
                                <td class="location">Sélecteur période</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #555; color: white;">Année</span></td>
                                <td>Filtrer les statistiques sur l'année scolaire</td>
                                <td class="location">Sélecteur période</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #607D8B; color: white;">Imprimer</span>
                                </td>
                                <td>Imprimer le rapport statistique</td>
                                <td class="location">Bas du tableau</td>
                            </tr>
                            <tr>
                                <td><span class="btn-demo" style="background: #FFA500; color: black;">Modifier
                                        motif</span></td>
                                <td>Modifier le motif pour plusieurs entrées sélectionnées</td>
                                <td class="location">Liste motifs</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- RACCOURCIS CLAVIER -->
                <div class="section">
                    <h2>⌨️ Raccourcis Clavier (si disponibles)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%;">Raccourci</th>
                                <th style="width: 70%;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Ctrl + S</strong></td>
                                <td>Sauvegarder rapidement (si dans une fiche)</td>
                            </tr>
                            <tr>
                                <td><strong>Échap (ESC)</strong></td>
                                <td>Fermer la fenêtre modale active</td>
                            </tr>
                            <tr>
                                <td><strong>Double-clic semaine</strong></td>
                                <td>Marquer/démarquer une semaine comme vacances</td>
                            </tr>
                            <tr>
                                <td><strong>Clic sur élève</strong></td>
                                <td>Ouvrir la fiche élève (en mode Placer Élèves)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- CODES COULEURS -->
                <div class="section">
                    <h2>🎨 Codes Couleurs du Logiciel</h2>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 20%;">Couleur</th>
                                <th style="width: 30%;">Utilisation</th>
                                <th style="width: 50%;">Signification</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span style="color: #FFA500; font-size: 2rem;">●●●</span></td>
                                <td>Couleur principale</td>
                                <td>Éléments actifs, sélection, boutons principaux</td>
                            </tr>
                            <tr>
                                <td><span style="color: #4CAF50; font-size: 2rem;">●●●</span></td>
                                <td>Vert / Positif</td>
                                <td>Observations, statut "Bon", RDV validés</td>
                            </tr>
                            <tr>
                                <td><span style="color: #FF9800; font-size: 2rem;">●●●</span></td>
                                <td>Orange / Attention</td>
                                <td>RDV en attente, statut "Mitigé", avertissements</td>
                            </tr>
                            <tr>
                                <td><span style="color: #F44336; font-size: 2rem;">●●●</span></td>
                                <td>Rouge / Urgent</td>
                                <td>Situations urgentes, statut "À surveiller", RDV annulés</td>
                            </tr>
                            <tr>
                                <td><span style="color: #FFEB3B; font-size: 2rem;">●●●</span></td>
                                <td>Jaune / Progrès</td>
                                <td>Statut "En progrès", amélioration visible</td>
                            </tr>
                            <tr>
                                <td><span style="color: #FFD700; font-size: 2rem;">●●●</span></td>
                                <td>Or / Famille</td>
                                <td>RDV avec les familles</td>
                            </tr>
                            <tr>
                                <td><span style="color: #9C27B0; font-size: 2rem;">●●●</span></td>
                                <td>Violet / Réunion</td>
                                <td>Réunions collectives, conseils</td>
                            </tr>
                            <tr>
                                <td><span style="color: #2196F3; font-size: 2rem;">●●●</span></td>
                                <td>Bleu / Information</td>
                                <td>Statistiques, informations générales</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <footer
                    style="text-align: center; margin-top: 60px; padding-top: 30px; border-top: 2px solid #444; color: #888;">
                    <p><strong>LOGECPE NTP14</strong> - Référence des boutons et raccourcis</p>
                    <p style="margin-top: 10px;">Version 2026 - Créé le 24/01/2026</p>
                </footer>
            </div>

</body>
</html>
